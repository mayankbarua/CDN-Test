!function(netBrain){angular.module("nb.qmap",["nb.framework","nb.common","nb.miniTask","nb.networkos","nb.systemmodel","nb.datamodel","nb.ng","nb.activity","nb.application","nb.embedMap","nb.dataview","nb.dataviewtemplate","nb.dashboard","ui.grid.autoResize","nb.wordDoc"]).run(["$rootScope","$q","osFs","nb.collaboration.collaborationMgr","nb.common.nbAlertSrvc","$timeout","nb.uiframework.urlStateMgr","nb.ng.utilitySrvc","nb.runbook.actionTaskSrvc",function($rootScope,$q,osFsProvider,collaborationMgr,nbAlertSrvc,$timeout,urlStateMgr,utilitySrvc,actionTaskSrvc){!function(){osFsProvider.registerFileTypeDefinition(function(){var fileType=new NetBrain.NetworkOS.Model.FileTypeDefinition;fileType.name="Map";fileType.type=netBrain.Map.Const.FileTypes.Map;fileType.icon="icon_nb_map";fileType.previewTemplate='<nb-desktop-map-preview-directive file="file" close="close()" options="options"></nb-desktop-map-preview-directive>';fileType.dblClickAction=new NetBrain.NetworkOS.Model.FileAction;fileType.dblClickAction.callback=openTab;fileType.dblClickAction.checkFileExists=!0;fileType.actions=[createOpenAction(netBrain.Map.Const.FileTypes.Map),createExportMapAction()];utilitySrvc.getLocalStorage("allowShare")&&fileType.actions.splice(1,0,function(){var action=new NetBrain.NetworkOS.Model.FileAction("Share",20,!0,(function(files){var defer=$q.defer();var myInitList=[];if(files instanceof Array)for(var i=0;i<files.length;i++)myInitList.push({id:files[i].originalId,name:files[i].name,type:files[i].type});else myInitList.push({id:files.originalId,name:files.name,type:files.type});collaborationMgr.shareURLPopup(myInitList).result.then((function(){defer.resolve(!0)}));return defer.promise}));action.supportShortcut=!1;action.tryCloseFilesPanel=!1;return action}());return fileType}());osFsProvider.registerFileTypeDefinition(function(){var fileType=new NetBrain.NetworkOS.Model.FileTypeDefinition;fileType.name="Site Map";fileType.type=netBrain.Map.Const.FileTypes.SiteMap;fileType.icon="icon_nb_map";fileType.isBuildIn=!0;fileType.dblClickAction=openTab;fileType.actions=[createOpenAction(netBrain.Map.Const.FileTypes.SiteMap)];return fileType}());osFsProvider.registerFileTypeDefinition(function(){var fileType=new NetBrain.NetworkOS.Model.FileTypeDefinition;fileType.name="Overview Map";fileType.type=netBrain.Map.Const.FileTypes.OverviewMap;fileType.icon="icon_nb_overviewmap";fileType.isBuildIn=!0;fileType.dblClickAction=openTab;fileType.actions=[createOpenAction(netBrain.Map.Const.FileTypes.OverviewMap)];return fileType}())}();function openTab(file,target){var mapType=null;file.target&&(file.target.type===netBrain.Map.Const.FileTypes.SiteMap?mapType=netBrain.Map.Const.MapType.siteMap:file.target.type===netBrain.Map.Const.FileTypes.OverviewMap&&(mapType=netBrain.Map.Const.MapType.overViewMap));var op={id:file.originalId,target:target?target.id||null:file.originalId};mapType&&(op.mapType=mapType);return urlStateMgr.openMap(op)}function createOpenAction(fileType){var action=new NetBrain.NetworkOS.Model.FileAction("Open",-1,!0,(function(files){return files&&files.constructor===Array&&files.length>0?function openTabs(files,index){if(index<files.length){var file=files[index];var target={id:file.originalId};$timeout((function(){openTab(file,target)}),500).then((function(){index++;openTabs(files,index)}))}}(files,0):files&&files.originalId?openTab(files,{id:files.originalId}):null}));action.tryCloseFilesPanel=!0;action.checkDomain=!0;fileType===netBrain.Map.Const.FileTypes.Map&&(action.checkFileExists=!0);return action}function createExportMapAction(){var action=new NetBrain.NetworkOS.Model.FileAction("Export Map",21,!1,(function(files){var defer=$q.defer();var myInitList=[];if(files instanceof Array)for(var i=0;i<files.length;i++)myInitList.push({id:files[i].originalId,name:files[i].name});else myInitList.push({id:files.originalId,name:files.name});actionTaskSrvc.getGlobalDAPStatus().then((function(){collaborationMgr.exportMap(myInitList).result.then((function(){defer.resolve(!0)}))}));return defer.promise}));action.supportShortcut=!1;action.tryCloseFilesPanel=!1;return action}}])}(NetBrain);!function(NetBrain){var consts=NetBrain.ns("Map.Const");consts.NS_NAME="nb.qmap";consts.TopoLinkType={IPv4L3Topology:"L3_Topo_Type",IPv6L3Topology:"Ipv6_L3_Topo_Type",L2Topology:"L2_Topo_Type",VPNTopology:"VPN_Topo_Type"};consts.MediaType={Lan:"Lan",Wan:"Wan",Dmvpn:"Dmvpn",Serial:"Serial",MuteLan:"MuteLan",vPC:"vPC",Bus:"Bus"};consts.TopoLinkTypeShow={IPv4L3Topology:"IPv4 L3 Topology",IPv6L3Topology:"IPv6 L3 Topology",L2Topology:"L2 Topology"};consts.Color={Unknown:16777215,Error:16332599,Warning:16565862,Normal:9687377};consts.TemplateAlarmColor={Error:{font:"#FFFFFF",background:"#F93737"}};consts.SuportDRDeviceType=[2,2001,2013,2015,2024,2999,2004,2002,2009,102,2012,2018,2150,10352,10380,10418];consts.SuportChartValueType=["uFloat","uInt","uBool","uCompoundVar","uPercent"];consts.DefautDeviceGroupSize="360 249";consts.MapViewOptionZoomRange=[{value:.1,displayValue:"10%"},{value:.2,displayValue:"20%"},{value:.3,displayValue:"30%"},{value:.4,displayValue:"40%"},{value:.5,displayValue:"50%"},{value:.6,displayValue:"60%"},{value:.7,displayValue:"70%"},{value:.8,displayValue:"80%"},{value:.9,displayValue:"90%"},{value:1,displayValue:"100%"},{value:1.2,displayValue:"120%"},{value:1.4,displayValue:"140%"},{value:1.5,displayValue:"150%"},{value:1.6,displayValue:"160%"},{value:1.8,displayValue:"180%"},{value:2,displayValue:"200%"},{value:2.5,displayValue:"250%"},{value:2.8,displayValue:"280%"},{value:3,displayValue:"300%"},{value:3.5,displayValue:"350%"},{value:4,displayValue:"400%"},{value:4.5,displayValue:"450%"},{value:5,displayValue:"500%"}];consts.MapViewOptionSetting={options:[{posName:"devHostName",displayName:"Device Hostname",scaleThreshold:.6,display:!0},{posName:"devPos1",displayName:"Device Position 1",scaleThreshold:1,display:!0},{posName:"devPos2",displayName:"Device Position 2",scaleThreshold:1,display:!0},{posName:"devPos3",displayName:"Device Position 3",scaleThreshold:1,display:!0},{posName:"devPos4",displayName:"Device Position 4",scaleThreshold:1,display:!0},{posName:"intfPos0",displayName:"Interface Name",scaleThreshold:.6,display:!0},{posName:"intfPos1",displayName:"Link Position 1",scaleThreshold:1.2,display:!0},{posName:"intfPos2",displayName:"Link Position 2",scaleThreshold:1.2,display:!0},{posName:"intfPos3",displayName:"Link Position 3",scaleThreshold:1.4,display:!0},{posName:"intfPos4",displayName:"Link Position 4",scaleThreshold:1.4,display:!0},{posName:"intfPos5",displayName:"Link Position 5",scaleThreshold:1.6,display:!0},{posName:"intfPos6",displayName:"Link Position 6",scaleThreshold:1.6,display:!0},{posName:"intfPos7",displayName:"Link Position 7",scaleThreshold:1.8,display:!0},{posName:"intfPos8",displayName:"Link Position 8",scaleThreshold:1.8,display:!0},{posName:"devNote",displayName:"Device Note",scaleThreshold:.8,display:!0},{posName:"overflowPos",displayName:"Overflow Position",scaleThreshold:.6,display:!0},{posName:DataViewPosName.otherDrawShapes,displayName:"Other Draw Shapes",scaleThreshold:.6,display:!0}],step:.2,isNeatUp:!1};consts.MapViewOptionZoomStepOption=[{displayValue:"10%",value:.1},{displayValue:"20%",value:.2},{displayValue:"30%",value:.3},{displayValue:"40%",value:.4},{displayValue:"50%",value:.5}];consts.CompDeviceState={statusGeneral:1,statusActive:2,statusSrc:4,statusRootSite:4,statusDest:8,statusContainerSite:8,statusConstraint:16,statusCheckOk:32,statusCheckFail:64,statusNeighbor:128,statusUp:256,statusDown:512,statusUnstable:1024,statusQnote:2048,statusAlarm:4096,statusChanged:8192,statusExpanded:16384,statusCollapsed:32768,statusAlertError:65536,statusAlertWarn:131072};consts.StatePostfixName={statusGeneral:"",statusActive:"_Active",statusSrc:"_Src",statusRootSite:"_Src",statusDest:"_Dst",statusContainerSite:"_Dst",statusConstraint:"_Constraint",statusCheckOk:"_CheckOk",statusCheckFail:"_CheckFail",statusNeighbor:"_Neighbor",statusUp:"_Up",statusDown:"_Down",statusUnstable:"_Unstable",statusQnote:"_Qnote",statusAlarm:"_Alarm"};consts.NetmapDisplayMode={switchMode:"switchMode",pinMode:"pinMode"};consts.FileTypes={Map:11,SiteMap:12,OverviewMap:13};consts.MapType={general:1,overViewMap:2,siteMap:3,deviceGroupMap:4,visualSpaceOverViewMap:8,forDashboardMap:12,mapLayoutSampleMap:22};consts.NetmapType={l3Map:1,l2Map:2,xMap:3};consts.nbMonitorColor="#F0FFF0";consts.nbDefaultPageColor="#FFFFFF";consts.NetmapTopoLogy={general:1,overViewHierarchicalSite:2,overViewTopologySite:3,deviceGroupTopoMap:4,linkGroupTopoMap:5,siteTopoMap:6,siteNbrTopoMap:7,siteL2TopoMap:8};consts.LayoutStyle={Symmetric:0,Circular:1,Hierarchical:2,Orthogonal:3,Tree:4};consts.NoteType={RecordHistory:0,Overwrite:1,Append:2};consts.NoteFromType={Normal:1,DataView:2,Path:3};consts.Align={Left:0,Center:1,Right:2};consts.ColorLibrary=["-1","#333399","#339933","#66CCCC","#CC6600","#CCFF33","#6666CC","#FF9933","#339999","#663366","#CCCC33","#CC9966","#CC99CC","#6666FF","#666666","#FF6666","#CC9999","#666600","#663399","#33CC33","#993300","#6600FF","#CC3399","#33FFCC","#FF3399","#3333FF","#FFCC99","#336699","#3366FF","#669999","#660033","#330099","#FF99CC","#CCCC99","#6699CC","#660066","#FFCC33","#3333CC","#66FFFF","#FFCCCC","#3300CC","#330033","#FF6633","#333300","#FF99FF","#66FF99","#FF9966","#333366","#FF33CC","#33CC99","#666699","#CC33CC","#66CC99","#FF9999","#330000","#669966","#CC33FF","#6633CC","#330066","#336633","#6633FF","#FF0066","#66FF33","#66CCFF","#FF66CC","#336666","#CC3366","#6699FF","#FF0033","#669900","#33CCFF","#FF0099","#663333","#3399CC","#6600CC","#CCFF99","#CC99FF","#003366","#33FF99","#33CCCC","#FF6699","#66FFCC","#CC00FF","#33FFFF","#66CC66","#CC0033","#33FF33","#CCCCFF","#660099","#FF00CC","#3399FF","#CC3333","#FF66FF","#CC0099","#FF3366","#339966","#FF33FF","#CCCCCC","#3366CC","#333333","#88CC99"];consts.LineTypeDic=[{key:0,value:null},{key:1,value:[6,3]},{key:2,value:[2,3]},{key:3,value:[6,3,2,3]},{key:4,value:[6,3,2,3,2,3]}];consts.LineType={LineType0:"Solid",LineType1:"Dash",LineType2:"Dot",LineType3:"DashDot",LineType4:"DashDotDot"};consts.LinkType={Solid:0,Dash:1,Dot:2,DashDot:3,DashDotDot:4};consts.HightLegendType={deviceLegend:0,interfaceLegend:1,linkLegend:2};consts.AutolinkType={LinkAll:0,LinkLimit:1};consts.MapLayoutType={undefined:0,multiTier:1,pairing:2,pie:3,circle:4,sampleMap:5};consts.MapLayoutDirection={undefined:0,top:1,right:2,left:3,bottom:4};consts.SampleMapCreateStrategy={byHostName:1,byAssignTag:2};consts.DeviceIconSize={larger:1,normal:2,small:3};consts.iconOnMapScale=.22;consts.noteDefaultFontColor="#000000";consts.noteDefaultBackColor="#FDF39B";consts.noteDefaultBorderColor="#c8c8c8";consts.noteDefaultSeparatorColor="#F1C40F";consts.dataViewNoteDefaultBackColor="#ECFCDD";consts.dataViewNoteDefaultSeparatorColor="#B9D587";consts.dataViewNoteAlarmErrorBackColor="#FFC0CB";consts.dataViewNoteAlarmErrorSeparatorColor="#E58F93";consts.noteLinkDefaultBackColor="#057DE1";consts.EditRightResult={failed:0,success:1,noEditRight:2,successButEmailFailed:3};consts.NeedShowDeviceBorders=[{id:1e3,name:"Router"},{id:1030,name:"Load Balancer"},{id:1036,name:"Unknown IP"},{id:1004,name:"End System"},{id:1005,name:"Unknown End System"},{id:1002,name:"Firewall"},{id:1049,name:"WAN Optimizer"},{id:1028,name:"Call Manager"},{id:1021,name:"Unclassified Device"},{id:1027,name:"IP Phone"},{id:1024,name:"MPLS Cloud"},{id:1001,name:"L3 Switch"},{id:1009,name:"LAN Switch"},{id:1047,name:"WAP"},{id:1048,name:"WLC"}];consts.getL3StyleInExpandedStyle=function(){var idList=["1000","1030","1036","1004","1005","1002","1049","1028","1021","1027","1024"];try{var stringList=_.map(_.pluck(consts.NeedShowDeviceBorders,"id"),(function(id){return id.toString()}));idList=stringList.filter((function(id){return idList.indexOf(id)>-1}))}catch(e){console.log(e)}return idList};consts.InterfaceHighlightModeEnum={All:0,OnlyLink:1,OnlyPort:2};consts.InterfaceHighlightModeList=[{id:0,name:"Highlight Link & Port"},{id:1,name:"Only Highlight Link"},{id:2,name:"Only Highlight Port"}];consts.DefaultInterfaceHighlightMode=consts.InterfaceHighlightModeEnum.All;consts.nodeType=function(){var nodeType={mpls:{name:"mpls",priority:10},device:{name:"device",priority:20},site:{name:"site",priority:30},dedia:{name:"media",priority:50},unpredictable:{name:"unpredictable",priority:1e3}};nodeType.mapFromNg={NetworkDevice:nodeType.device,Site:nodeType.site,Media:nodeType.dedia};return nodeType}();consts.stencilImgSimulateDevCategory=function(){var result={};_.each({router:{devCategory:1e3,imgs:["00000000-0000-0000-0000-000000000042.png","00000000-0000-0000-0000-000000000078.png","00000000-0000-0000-0000-0000000000a9.png"]},switch:{devCategory:1001,imgs:["00000000-0000-0000-0000-00000000002e.png","00000000-0000-0000-0000-000000000067.png","00000000-0000-0000-0000-000000000073.png","00000000-0000-0000-0000-000000000038.png","00000000-0000-0000-0000-000000000001.png","00000000-0000-0000-0000-00000000000b.png","00000000-0000-0000-0000-000000000051.png","00000000-0000-0000-0000-000000000006.png","00000000-0000-0000-0000-000000000029.png","00000000-0000-0000-0000-00000000005d.png","00000000-0000-0000-0000-0000000000ae.png","00000000-0000-0000-0000-000000000100.png","00000000-0000-0000-0000-000000000150.png","00000000-0000-0000-0000-000000000145.png","00000000-0000-0000-0000-000000000215.png","00000000-0000-0000-0000-000000000180.png"]},firewall:{devCategory:1002,imgs:["00000000-0000-0000-0000-00000000003d.png","00000000-0000-0000-0000-000000000024.png","00000000-0000-0000-0000-00000000001f.png","00000000-0000-0000-0000-000000000090.png","00000000-0000-0000-0000-00000000007d.png","00000000-0000-0000-0000-00000000009f.png"]},loadBanlance:{devCategory:1030,imgs:["00000000-0000-0000-0000-000000000062.png","00000000-0000-0000-0000-0000000000a4.png"]},callManager:{devCategory:1028,imgs:["00000000-0000-0000-0000-000000000058.png","00000000-0000-0000-0000-00000000006e.png","00000000-0000-0000-0000-0000000000b3.png","00000000-0000-0000-0000-00000000001a.png","00000000-0000-0000-0000-000000000133.png"]},unknownIp:{devCategory:1036,imgs:["00000000-0000-0000-0000-0000000000b3.png"]}},(function(obj){var devCategory=obj.devCategory;_.each(obj.imgs,(function(img){result[img]=devCategory}))}));return result}();consts.CurrentVersion="8.0.1";consts.contextMenuLineWeightList=[1,2,5,8,15,25];consts.contextMenuLineStyleList=[{name:"Solid",className:"icon_nb_2px",type:[0]},{name:"Dot",className:"icon_nb_Dot",type:[3,7]},{name:"Dash",className:"icon_nb_Dash",type:[10,5]},{name:"Dot - Dash",className:"icon_nb_DotDash",type:[6,5,2,5]},{name:"Dot - Long Dash",className:"icon_nb_DotLongDash",type:[12,5,2,5]}];consts.contextMenuColorPickerOptions={preferredFormat:"hex",color:"black",showPaletteOnly:!0,togglePaletteOnly:!0,cancelText:"Cancel",chooseText:"Choose",togglePaletteMoreText:"More",togglePaletteLessText:"Less",hideAfterPaletteSelect:!0,showInput:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]]};consts.EditDataViewMode={DisableStyle:{opacity:.4},EnableStyle:{opacity:1},LinkSeg:{ALL:0,FROM:1,TO:2}};consts.MapVersionList=["7.0","7.0a","7.0a1","7.0b","7.0b1","7.1","IE 7.1a","7.1a","7.1a1","8.0","8.0.1"];consts.CollaborationFilterType={Map:1,Dashboard:2,Note:3,RunBook:4,ChangeManagement:5};consts.CollaborationType={Share:1,Request:2,Transfer:3,Deny:4,ForceGet:5,Delete:6};consts.RenderMapType={byLinks:"ByLinks",byNodes:"ByNodes"};consts.PreviewMapEvent={renderMap:"renderMap",openPreviewMap:"openPreviewMap",openFullMap:"openFullMap"};consts.ForceCreateNewMapFlag="new"}(NetBrain);!function(netBrain){var eventMgr=NetBrain.ns("Map.Event");eventMgr.NS_NAME="nb.qmap";eventMgr.CloseAllFloatDialog="CloseAllFloatDialog";eventMgr.ActivePageChanged="ActivePageChanged";eventMgr.QAppStatusChanged="QAppStatusChanged";eventMgr.CloseMap="CloseMap";eventMgr.DataViewChanged="DataViewChanged";eventMgr.CloseAllTip="CloseAllTip";eventMgr.CloseMapOndesktop="CloseMapOndesktop";eventMgr.StartUpdateMap="StartUpdateMap";eventMgr.AddNewMapPage="AddNewMapPage";eventMgr.ConfirmAddNewMapPage="ConfirmAddNewMapPage";eventMgr.HideDataViewTitle="HideDataViewTitle";eventMgr.ShowDataViewTitle="ShowDataViewTitle";eventMgr.ActiveStencilItem="ActiveStencilItem";eventMgr.DeactiveStencilItem="DeactiveStencilItem";eventMgr.OpenStencilPanelFromMapBar="OpenStencilPanelFromMapBar";eventMgr.EditDataViewFromDataViewTitleBar="EditDataViewFromDataViewTitleBar";eventMgr.DataViewTitleClicked="DataViewTitleClicked";eventMgr.MapDataViewListChanged="MapDataViewListChanged";eventMgr.UpdateMapDataViewTitle="UpdateMapDataViewTitle";eventMgr.ShowEditingRightsTip="ShowEditingRightsTip";eventMgr.HideEditingRightsTip="HideEditingRightsTip";eventMgr.ModelDataArrayChanged="ModelDataArrayChanged"}();!function(netBrain){var messageMgr=NetBrain.ns("Map.Message");messageMgr.NS_NAME="nb.qmap";messageMgr.NoFoudMapMsg="The requested map file was not found.";messageMgr.IsModifiedForUpdateMapMsg="Map will be saved automatically before updated. Do you want to continue?";messageMgr.IsExistedForUpdateMapMsg="Failed to update the map: the map file has already been deleted. Do you want to save it as a new map and update it?";messageMgr.IsExistedForRefreshMapMsg="Failed to refresh the map: the map file has already been deleted. Do you want to save it as a new map and refresh it?";messageMgr.HaveNoEditRight="You don't have the editing rights of the current map.";messageMgr.SiteMapIsTimeExpire="The site was rebuilt, and the site map data might be changed. You can {updatemap} to get the latest information.";messageMgr.DeviceGroupMapIsTimeExpire="The Device Group was rebuilt, and the Device Group map data might be changed. You can {updatemap} to get the latest information.";messageMgr.SaveMapSuccess="Successfully saved the map.";messageMgr.SaveMapFailed="Save Failed.";messageMgr.FinishUpdateMapSuccess="Update Successfully.";messageMgr.FinishUpdateMapFail="Update Failed.";messageMgr.LeaveMapUnSaved='Do you want to save the changes made to this map "{mapname}"? <br/><br/>If you don\'t save, your changes will be lost.';messageMgr.DesinReaderNoMatched="No Matched Configuration";messageMgr.IsCopyMapTipMsg="The current map doesn't include some data in the original map, including Actions, Map Data Views, Runbooks, etc. You can go to the {originalmap} to check the data if needed.";messageMgr.IsOnlyViewMapTipMsg="You do not have Editing Rights and cannot save changes on this map. You can <b>Save As</b> a new map.";messageMgr.HostnameInvalidTipMsg="Device with the same name already exists in current domain, please enter another name.";messageMgr.ShowBigOverviewTip="Due to space and performance limitations, only <%= max %> sites (out of <%= actual %> sites in current domain) are displayed here.";messageMgr.ShowBigOverviewTipCompileTopologyView="Due to space and performance limitations, only <%= max %> leaf sites (out of <%= actual %> leaf sites in current domain) are displayed here.";messageMgr.ShowAutoLinkTip="{defaultAutoLinkTopotype} is used to auto-link devices by default. Go to {mapsettings} to adjust.";messageMgr.IsModifiedForExportMapMsg="Unsaved Map cannot be exported. <br/><br/> Do you want to save the map and then export?";messageMgr.ImportMapFinishMsg="If you want to rebuild topology with the imported map data, please go to the {domainmanager} page to manually run a Benchmark task with building topology enabled.";messageMgr.ImportMapUpLimited="At most 50 maps can be imported at one time.";messageMgr.NoLinkForSelectMessage="There is no {linkname} link on current map.";messageMgr.NoLinkForUnLinkMessage="There is no {linkname} link on current map.";messageMgr.NoLinkForAutoLinkMessage="Only the links between two devices or between two sites can be auto linked.";messageMgr.ShareTipForNewMap="Please save the map first before sharing.";messageMgr.ShareTipForHasEditRight='Do you want to save the changes made to the map "{mapname}" before sharing?';messageMgr.ShareTipForNoEditRight="You don't have editing rights to save the changes. Share the original map instead? <br/><br/> (Or you can save the map as another map before sharing.)";messageMgr.ShareTipForOverViewMap="The overview map cannot be saved. Share the original map instead?<br/><br/> (Or you can save the map as another map before sharing.)";messageMgr.ShareMapNotePlaceHolder="Type your message here.";messageMgr.ShareMapSuccess="You have successfully shared the maps with {user}.";messageMgr.ShareMapCopyUrlSuccess="You have successfully copied the map link to clipboard.";messageMgr.DeleteDVTaskRuningCant="The Data View can not be deleted when the related Qapp is still running. Please stop the Qapp first.";messageMgr.DeleteDVAllDVgroup="Are you sure you want to delete this Global Data View?";messageMgr.SetAsDefaultSettingsSuccess="Successfully set the settings as default.";messageMgr.MergeOneNoteWarning="Only map notes can be merged.";messageMgr.NoRightForCreateNoteAlert="The action cannot be performed because you are not privileged to view the network data of the selected device.";messageMgr.ExtendNbrMoreThen="At most 50 neighbors can be extended at one time."}();!function(netBrain){var nsMap=netBrain.ns("Map");var nodeType=nsMap.Const.nodeType;var symmetricLayoutHelper=netBrain.ns("Map.symmetricLayoutHelper");var publicApi=netBrain.LayoutTools.PublicApi;var Position=publicApi.Models.Position;var convert=publicApi.Utils.convert;var split=publicApi.Utils.split;var layouts=publicApi.Layouts;var TreeLayout=layouts.TreeLayout;layouts.SymmetricLayout;var IslandGroupLayout=layouts.IslandGroupLayout;var consts=netBrain.LayoutTools.Const;function LayoutToolsHelper(netmapOperator,httpMapLayoutSrvc){this.netmapOperator=netmapOperator;this.httpMapLayoutSrvc=httpMapLayoutSrvc;this.cachedTags={}}LayoutToolsHelper.prototype.symmetricLayout=function(options,withoutRefresh){options=_.extend(publicApi.Layouts.SymmetricLayout.getDefaultConfig(),options);var netmap=this.netmapOperator.getNetMap();var isL2Style=netmap.isL2MapStyle();options.expectDistance=function(node1,node2){return isL2Style?function(netmap,node1,node2){var dis;var isNode1L2Style=netmap.isL2DeviceStyle(node1);var isNode2L2Style=netmap.isL2DeviceStyle(node2);dis=isNode1L2Style||isNode2L2Style?300:symmetricLayoutHelper.getExpectDis(node1,node2);return dis}(netmap,node1,node2):symmetricLayoutHelper.getExpectDis(node1,node2)};options.maxEjectDistance=function(node1,node2){return isL2Style?600:symmetricLayoutHelper.getMaxEjectDistance(node1,node2)};var transName=NgUtil.getUniqueStr("symmetric layout");this.startTransaction(transName);var layouter=new publicApi.Layouts.SymmetricLayoutForIsland;this.doGeometryLayout(layouter,options);!0!==withoutRefresh&&this.refreshPortsAndLabels();this.commitTransaction(transName)};LayoutToolsHelper.prototype.extendNeighborLayout=function(options){this.symmetricLayout(options,!0)};LayoutToolsHelper.prototype.getNodesWithTags=function(){var devices=this.netmapOperator.getSimpleNodeDataArray();var toolsHelper=this;return _.map(devices,(function(device){device.tags=toolsHelper.cachedTags[device.key]||[];return device}))};LayoutToolsHelper.prototype.refreshCachedTags=function(){var newDevices=this.netmapOperator.getSimpleNodeDataArray();var nodeGroup=_.partition(newDevices,(function(node){return!!node.devNodeData&&node.devNodeData.isRealDev}));var ids=_.pluck(nodeGroup[0],"key");var sdnNodes=_.map(nodeGroup[1],(function(node){if(node.devNodeData)return node.devNodeData.nodeIdentify}));var service=this.httpMapLayoutSrvc||getDeviceService();var toolsHelper=this;return service.GetNodesTags(ids,sdnNodes).then((function(devices){var cachedTags=toolsHelper.cachedTags;_.each(devices,(function(device){cachedTags[device.ID]=device.assignTags}))}))};LayoutToolsHelper.prototype.treeLayout=function(customizeOption){var transName=NgUtil.getUniqueStr("tree layout");this.startTransaction(transName);var nodes=this.treeLayoutIgnoreNotes(customizeOption);this.symmetricNotesForTreeLayout(nodes);this.refreshPortsAndLabels();this.commitTransaction(transName)};LayoutToolsHelper.prototype.doGeometryLayout=function(layouter,options){var originalData=buildOriginalData(options,this.netmapOperator);var nodeLocations=this.layoutOriginalData(originalData,layouter,options);this.applyLayoutInfo(nodeLocations)};LayoutToolsHelper.prototype.treeLayoutIgnoreNotes=function(customizeOption){var treeOptions=(customerOptions=customizeOption,netmapOperator=this.netmapOperator,_.extend({},{getTreeRootPriority:function(originalNode){return this.getType(originalNode).priority},getType:function(originalNode){return 1024===originalNode.devType?nodeType.mpls:nodeType.mapFromNg[originalNode.category]||nodeType.unpredictable}},function(netmapOperator){var viewport=netmapOperator.getViewportBounds();return{viewportWidth:viewport.width,viewportStart:new Position(viewport.x||0,viewport.y||0)}}(netmapOperator),customerOptions));var customerOptions,netmapOperator;var originalData=buildOriginalData(treeOptions,this.netmapOperator);var nodePartions=_.partition(originalData.nodeDataArray,isNote);originalData.nodeDataArray=nodePartions[1];var layouter=new TreeLayout;var nodeLocations=this.layoutOriginalData(originalData,layouter,treeOptions);this.applyLayoutInfo(nodeLocations);return originalData.nodeDataArray};LayoutToolsHelper.prototype.symmetricNotesForTreeLayout=function(nodes){var lockedNodes=_.pluck(nodes,"key");this.symmetricLayout({lockedNodes:lockedNodes},!1)};LayoutToolsHelper.prototype.refreshPortsAndLabels=function(){var netmap=this.netmapOperator.getNetMap();netmap.layoutL2Ports();netmap.refreshMapViewOptionVisible()};LayoutToolsHelper.prototype.layoutOriginalData=function(originalData,layouter,options){var finallyOption=_.extend({getAverageWidth:getAverageWidth},publicApi.options.defaultOptions,options);finallyOption.isL2Style=this.netmapOperator.getNetMap().isL2MapStyle();var topoData=convert(originalData,layouter.getNodeType(),finallyOption);var islandGroup=split(topoData);return(new IslandGroupLayout).layout(islandGroup,layouter)};LayoutToolsHelper.prototype.applyLayoutInfo=function(nodeLocations){this.netmapOperator.updateNodesLoc(nodeLocations)};LayoutToolsHelper.prototype.getTemplateStylesMatchInfo=function(templateStyles){var layered=this.layered;var nodes=this.getNodesWithTags();return _.map(templateStyles,(function(templateStyle){var matchInfo=layered(templateStyle,nodes);var similarityCoefficient=function(matchInfo,templateStyle,nodes){var fullMatchInfo={device:{matched:matchInfo.matchedCount,total:filterDevices(nodes).length},tag:{map:getTagsOnMap(nodes),style:(layers=templateStyle.layers,getDistinctTags(layers,(function(layer){return layer.associateTags})))},layers:getLayerMatchInfo(matchInfo)};var layers;return publicApi.Similarity.calculateSimilarityCoefficientAdvanced(fullMatchInfo)}(matchInfo,templateStyle,nodes);matchInfo.similarityCoefficient=similarityCoefficient;matchInfo.similarityCoefficientPercentage=toPercentage(similarityCoefficient);return function(matchInfo){var originalStyle=matchInfo.originalStyle;matchInfo.name=originalStyle.name;matchInfo.id=originalStyle.id;matchInfo.orientation=originalStyle.orientation;layers=matchInfo.layers,_.each(layers,(function(layer){var originalLayer=layer.originalLayer;layer.maxNodeCount=originalLayer.maximumDeviceCount;layer.scale=originalLayer.scale}));var layers;return matchInfo}(matchInfo)}))};LayoutToolsHelper.prototype.getSampleMapMatchInfo=function(sampleMaps){var sampleMapMatchMethods=this.getSampleMapMatchMethods();var self=this;_.each(sampleMaps,(function(sampleMap){var specialMethods=sampleMapMatchMethods[sampleMap.createStrategy];if(!specialMethods){var message=consts.Wording.InnerError.UnknownCreateStrategy;throw new Error(message)}self.calculateSampleMapSimilarityCoefficient(sampleMap,specialMethods)}));return sampleMaps};LayoutToolsHelper.prototype.getSampleMapMatchMethods=function(){if(!this.sampleMapSpecialMethods){var sampleMapCreateStrategy=netBrain.MapLayout.Const.SampleMapCreateStrategy;var sampleMapSpecialMethods=Object.create(null);sampleMapSpecialMethods[sampleMapCreateStrategy.byHostName]={match:this.getSampleMapByDeviceMatchResults.bind(this),getCurrentMapData:this.getSampleMapByDeviceData.bind(this),getDevicesCount:function(sampleMapContent){return filterDevices(sampleMapContent.nodeDataArray).length}};sampleMapSpecialMethods[sampleMapCreateStrategy.byAssignTag]={match:this.getSampleMapByTagMatchResults.bind(this),getCurrentMapData:this.getSampleMapByTagData.bind(this),getDevicesCount:function(sampleMapContent){var devicesCount=0;_.each(sampleMapContent.tags,(function(tag){devicesCount+=tag.devices.length}));return devicesCount}};this.sampleMapSpecialMethods=sampleMapSpecialMethods}return this.sampleMapSpecialMethods};LayoutToolsHelper.prototype.calculateSampleMapSimilarityCoefficient=function(sampleMap,specialMethods){var sampleMapContent=sampleMap.content;var currentMapData=specialMethods.getCurrentMapData();var intersect=specialMethods.match(currentMapData,sampleMapContent).matchedCount;var currentMapDevicesCount=filterDevices(currentMapData.nodeDataArray).length;var sampleMapDevicesCount=specialMethods.getDevicesCount(sampleMapContent);var union=currentMapDevicesCount+sampleMapDevicesCount-intersect;var similarityCoefficient=publicApi.Similarity.calculateSimilarityCoefficient(intersect,union);sampleMap.similarityCoefficient=similarityCoefficient;sampleMap.similarityCoefficientPercentage=toPercentage(similarityCoefficient);sampleMap.matchedCount=intersect};LayoutToolsHelper.prototype.petalLayout=function(layoutGroupInfo,customizeOption){var layouter=new publicApi.Layouts.PetalLayout;this.doTemplateStyleLayout(layoutGroupInfo,layouter,customizeOption);return getMatchedKeys(layouter.layerGroup.assignNodes)};LayoutToolsHelper.prototype.ringLayout=function(layoutGroupInfo,customizeOption){var layouter=new publicApi.Layouts.RingLayout;this.doTemplateStyleLayout(layoutGroupInfo,layouter,customizeOption);return getMatchedKeys(layouter.layerGroup.assignNodes)};LayoutToolsHelper.prototype.doTemplateStyleLayout=function(layoutGroupInfo,layouter,customizeOption){this.startTransaction("doTemplateStyleLayout");applyLayerScale(this.netmapOperator,layoutGroupInfo);var linkInfos=this.netmapOperator.getSimpleLinkDataArray();var nodeLocations=layouter.layout(layoutGroupInfo,linkInfos,customizeOption);this.netmapOperator.updateNodesLoc(nodeLocations);this.layoutUnassignNodes(layouter.layerGroup.unassignNodes);this.commitTransaction("doTemplateStyleLayout")};LayoutToolsHelper.prototype.layoutForSDN=function(sdnStyle){var self=this;return this.refreshCachedTags().then((function(){var layeredInfo=self.layered(sdnStyle);_.each(layeredInfo.layers,(function(layer,index){layer.maxNodeCount=sdnStyle.layers[index].maximumDeviceCount}));return self.parallelStyleLayout(layeredInfo)}))};LayoutToolsHelper.prototype.getLayoutStyleById=function(styleId){return(this.httpMapLayoutSrvc||getDeviceService()).getLayoutStyleById(styleId)};LayoutToolsHelper.prototype.layered=function(templateStyle,nodes){nodes=nodes||this.getNodesWithTags();return publicApi.Tools.layeredTool.layered(nodes,templateStyle)};LayoutToolsHelper.prototype.parallelStyleLayout=function(layoutGroupInfo,customizeOption){var transName=NgUtil.getUniqueStr("parallet style layout");this.startTransaction(transName);applyLayerScale(this.netmapOperator,layoutGroupInfo);updateLayoutGroupInfo(layoutGroupInfo,this.netmapOperator);var space=calcNodeSpace(layoutGroupInfo,this.netmapOperator.getNetMap().isL2MapStyle());var parallelLayout=new publicApi.Layouts.ParallelStyleLayout;var linkInfos=this.netmapOperator.getSimpleLinkDataArray();linkInfos=buildTempLinksWithoutMedia(this.netmapOperator.getSimpleNodeDataArray(),linkInfos);var nodeLocations=parallelLayout.layout(layoutGroupInfo,linkInfos,{layerMaxLine:1e3,nodeHSpace:space.x,nodeVSpace:space.y,layerSpace:space.y+100,align:"center"});this.netmapOperator.updateNodesLoc(nodeLocations);this.layoutUnassignNodes(parallelLayout.layerGroup.unassignNodes);this.commitTransaction(transName);return getMatchedKeys(parallelLayout.layerGroup.assignNodes)};LayoutToolsHelper.prototype.layoutUnassignNodes=function(unassignNodes){var newNodes=[];unassignNodes.forEach((function(node){newNodes.push(node.id)}));this.symmetricLayout({newNodes:newNodes},!0);var netmap=this.netmapOperator.getNetMap();netmap.layoutL2Ports();netmap.refreshMapViewOptionVisible()};LayoutToolsHelper.prototype.rotateMap=function(oldOrientate,newOrientate){if(oldOrientate!==newOrientate){var locations=this.netmapOperator.getSimpleNodeDataArray();var originalPoint=getNodesCenter(locations);var oldAngle=getAngle(oldOrientate);var angle=getAngle(newOrientate)-oldAngle;var transName=NgUtil.getUniqueStr("rotate map");this.startTransaction(transName);var nodeLocations=publicApi.Tools.rotateTool.rotate(locations,originalPoint,angle);this.netmapOperator.updateNodesLoc(nodeLocations);var netmap=this.netmapOperator.getNetMap();netmap.layoutL2Ports();netmap.refreshMapViewOptionVisible();this.commitTransaction(transName)}};LayoutToolsHelper.prototype.flipMap=function(isHorizontal){var locations=this.netmapOperator.getSimpleNodeDataArray();var originalPoint=getNodesCenter(locations);var oldAngle=getAngle(oldOrientate);getAngle(newOrientate);var transName=NgUtil.getUniqueStr("flip map");this.startTransaction(transName);var nodeLocations=publicApi.Tools.flipTool.flip(locations,originalPoint,isHorizontal||!1);this.netmapOperator.updateNodesLoc(nodeLocations);var netmap=this.netmapOperator.getNetMap();netmap.layoutL2Ports();netmap.refreshMapViewOptionVisible();this.commitTransaction(transName)};LayoutToolsHelper.prototype.symmetricalParallelStyleLayout=function(layoutGroupInfo,customizeOption){var transName=NgUtil.getUniqueStr("symmetrical parallel style layout");this.startTransaction(transName);applyLayerScale(this.netmapOperator,layoutGroupInfo);updateLayoutGroupInfo(layoutGroupInfo,this.netmapOperator);var space=calcNodeSpace(layoutGroupInfo,this.netmapOperator.getNetMap().isL2MapStyle());var symmetryLayout=new publicApi.Layouts.SymmetryStyleLayout;var linkInfos=this.netmapOperator.getSimpleLinkDataArray();linkInfos=buildTempLinksWithoutMedia(this.netmapOperator.getSimpleNodeDataArray(),linkInfos);var nodeLocations=symmetryLayout.layout(layoutGroupInfo,linkInfos,{layerMaxLine:1e3,nodeHSpace:space.x,nodeVSpace:space.y,layerSpace:space.y+100,align:"center"});this.netmapOperator.updateNodesLoc(nodeLocations);this.layoutUnassignNodes(symmetryLayout.layerGroup.unassignNodes);this.commitTransaction(transName);return getMatchedKeys(symmetryLayout.layerGroup.assignNodes)};LayoutToolsHelper.prototype.sampleMapByDeviceLayout=function(originMapData){var transName=NgUtil.getUniqueStr("sample map by device style layout");this.startTransaction(transName);var sampleMapByDeviceLayout=new publicApi.Layouts.SampleMapByDeviceLayout;var netmapOperator=this.netmapOperator;var currMapData=this.getSampleMapByDeviceData();var nodeLocations=sampleMapByDeviceLayout.layout(currMapData,originMapData);netmapOperator.updateNodesLoc(nodeLocations);this.layoutUnassignNodes(sampleMapByDeviceLayout.unmatchedNodes);this.commitTransaction(transName);return getMatchedKeys(sampleMapByDeviceLayout.matchedNodes)};LayoutToolsHelper.prototype.getSampleMapByDeviceData=function(){var netmapOperator=this.netmapOperator;var nodeDataArray=netmapOperator.getSimpleNodeDataArray();var linkDataArray=netmapOperator.getSimpleLinkDataArray();return{nodeDataArray:nodeDataArray=_.map(nodeDataArray,(function(node){return{key:node.key,bounds:node.bounds,location:node.location,hostName:node.hostName,category:node.category}})),linkDataArray:linkDataArray}};LayoutToolsHelper.prototype.getSampleMapByDeviceMatchResults=function(currMapData,originMapData){var info=publicApi.Tools.sampleMapByDeviceMatchResultsTool(currMapData,originMapData);var matchedNodes=filterDevice(this.netmapOperator,info.matchedNodes);var unmatchedNodes=filterDevice(this.netmapOperator,info.unmatchedNodes);return{matchedCount:matchedNodes.length,unmatchedCount:unmatchedNodes.length}};LayoutToolsHelper.prototype.sampleMapByTagLayout=function(originMapData){var transName=NgUtil.getUniqueStr("sample map by tag style layout");this.startTransaction(transName);var sampleMapByTagLayout=new publicApi.Layouts.SampleMapByTagLayout;var netmapOperator=this.netmapOperator;var currMapData=this.getSampleMapByTagData();var nodeLocations=sampleMapByTagLayout.layout(currMapData,originMapData.tags);netmapOperator.updateNodesLoc(nodeLocations);this.layoutUnassignNodes(sampleMapByTagLayout.unmatchedNodes);this.commitTransaction(transName);return getMatchedKeys(sampleMapByTagLayout.matchedNodes)};LayoutToolsHelper.prototype.getSampleMapByTagMatchResults=function(currMapData,originMapData){var info=publicApi.Tools.sampleMapByTagMatchResultsTool(currMapData,originMapData.tags);var matchedCount=info.realMatchedCount;var unmatchedCount=filterDevice(this.netmapOperator,info.unmatchedNodes).length;info.matchedNodes.length>matchedCount&&(unmatchedCount+=info.matchedNodes.length-matchedCount);return{matchedCount:matchedCount,unmatchedCount:unmatchedCount}};LayoutToolsHelper.prototype.getSampleMapByTagData=function(){var netmapOperator=this.netmapOperator;var nodeDataArray=this.getNodesWithTags();var linkDataArray=netmapOperator.getSimpleLinkDataArray();return{nodeDataArray:nodeDataArray=_.map(nodeDataArray,(function(node){return{key:node.key,bounds:node.bounds,location:node.location,hostName:node.hostName,category:node.category,tags:node.tags}})),linkDataArray:linkDataArray}};LayoutToolsHelper.prototype.startTransaction=function(transactionName){this.netmapOperator.startTransaction(transactionName)};LayoutToolsHelper.prototype.commitTransaction=function(transactionName){this.netmapOperator.commitTransaction(transactionName)};nsMap.LayoutToolsHelper=LayoutToolsHelper;function getDeviceService(){getDeviceService.service||(getDeviceService.service=angular.element(document).injector().get("nb.qmap.httpMapLayoutSrvc"));return getDeviceService.service}function isNote(node){var CategoryMgr=netBrain.Map.CategoryMgr;var category=node.category;return CategoryMgr.isNote(category)||CategoryMgr.isDeviceNote(category)}function toPercentage(rate){return Math.round(100*rate)+"%"}function getLayerMatchInfo(matchInfo){return _.chain(matchInfo.layers).map((function(layer){return{size:layer.originalLayer.maximumDeviceCount,devices:(tags=layer.tags,_.chain(tags).map((function(tag){return tag.devices.length})).reduce((function(memo,num){return memo+num}),0).value())};var tags})).value()}function getTagsOnMap(nodes){return getDistinctTags(nodes,(function(node){return node.tags}))}function getDistinctTags(items,picker){return _.chain(items).map(picker).flatten().unique().value()}function filterDevices(nodeDataArray){var isDevice=netBrain.Map.CategoryMgr.isNetworkDevice;return _.filter(nodeDataArray,(function(node){return isDevice(node.category)}))}function getAverageWidth(nodes,defaultWidth){var sumWidth=0;var counter=0;_.each(nodes,(function(node){if(!isMedia(node.originalNode.category)){counter++;sumWidth+=node.width}}));return counter?sumWidth/counter*1.2:defaultWidth}function isMedia(category){return netBrain.Map.CategoryMgr.isMedia(category)}function buildOriginalData(options,netmapOperator){var originalData={nodeKeyProperty:"key",nodeDataArray:netmapOperator.getSimpleNodeDataArray(),linkDataArray:netmapOperator.getSimpleLinkDataArray().filter((function(link){return link&&function(link){return Boolean(link.from&&link.to)}(link)&&!function(link){return link.category===netBrain.Map.CategoryMgr.PathNew||link.category===netBrain.Map.CategoryMgr.TracePath}(link)})),lockedNodes:options.lockedNodes||[]};!function(originalData,newNodes){if(!_.isArray(newNodes))return;var key=originalData.nodeKeyProperty;var lockedNodes=originalData.lockedNodes;var newNodesDic=Object.create(null);_.each(newNodes,(function(id){newNodesDic[id]=!0}));_.each(originalData.nodeDataArray,(function(node){var id=node[key];newNodesDic[id]||lockedNodes.push(id)}));originalData.lockedNodes=_.uniq(lockedNodes)}(originalData,options.newNodes);return originalData}function getAngle(orientation){var angleMap={t:0,r:90,b:180,l:270};var angle=0;angleMap[orientation]&&(angle=angleMap[orientation]);return angle}function getNodesCenter(locations){var minX,minY,maxX,maxY;locations.forEach((function(node){var pt=node.location.split(" ");if(minX){minX=Math.min(minX,1*pt[0]);minY=1*Math.min(minY,pt[1]);maxX=Math.max(maxX,1*pt[0]);maxY=1*Math.max(maxY,pt[1])}else{minX=1*pt[0];minY=1*pt[1];maxX=1*pt[0];maxY=1*pt[1]}}));return{x:(minX+maxX)/2,y:(minY+maxY)/2}}function calcNodeSpace(layoutGroupInfo,isL2Style){var diffX=100;var diffY=50;_.each(layoutGroupInfo.layers,(function(layer){_.each(layer.tags,(function(tagInfo){_.each(tagInfo.devices,(function(device){var bounds=device.bounds;var location=device.location.split(" ");if(!(bounds.right-location[0]>220)){diffX=Math.max(diffX,bounds.right-location[0]);diffY=Math.max(diffY,bounds.bottom-location[1])}}))}))}));diffX+=100;diffY+=50;if(isL2Style){diffX+=50;diffY+=50;diffX=Math.min(diffX,400);diffY=Math.min(diffY,250)}else{diffX=Math.min(diffX,200);diffY=Math.min(diffY,150)}return{x:diffX,y:diffY}}function updateLayoutGroupInfo(layoutGroupInfo,netmapOperator){var simpeleNodes=netmapOperator.getSimpleNodeDataArray();var nodeObj={};_.each(simpeleNodes,(function(node){nodeObj[node.key]=node}));var existNodeObj={};_.each(layoutGroupInfo.layers,(function(layer){_.each(layer.tags,(function(tagInfo){tagInfo.devices=updateAndRemoveNodes(tagInfo.devices,nodeObj);_.each(tagInfo.devices,(function(node){existNodeObj[node.key]=node}))}))}));layoutGroupInfo.unAssignedDevices=updateAndRemoveNodes(layoutGroupInfo.unAssignedDevices,nodeObj);_.each(layoutGroupInfo.unAssignedDevices,(function(node){existNodeObj[node.key]=node}));_.each(simpeleNodes,(function(node){existNodeObj[node.key]||layoutGroupInfo.unAssignedDevices.push(node)}))}function updateAndRemoveNodes(devices,nodeObj){var newNodes=_.map(devices,(function(device){var tmpObj=nodeObj[device.key];var value=void 0;tmpObj&&(value=_.extend(device,tmpObj));return value}));return newNodes=_.without(newNodes,void 0)}function filterDevice(netmapOperator,sampleNodes){var nodeMap=function(netmapOperator){var nodes=netmapOperator.getSimpleNodeDataArray();var nodeMap={};_.each(nodes,(function(node){nodeMap[node.key]=node}));return nodeMap}(netmapOperator);var isDevice=netBrain.Map.CategoryMgr.isNetworkDevice;return _.filter(sampleNodes,(function(node){var fullNode=nodeMap[node.key];return!!fullNode&&isDevice(fullNode.category)}))}function applyLayerScale(netmapOperator,layerGroup){_.each(layerGroup.layers,(function(layer){var deviceIds=[];_.each(layer.tags,(function(tagInfo){var tmpDeviceIds=_.pluck(tagInfo.devices,"key");deviceIds=deviceIds.concat(tmpDeviceIds)}));netmapOperator.updateDevicesIconRatio(deviceIds,layer.scale)}))}function buildTempLinksWithoutMedia(allNodes,allLinks){var nodeObj={};_.each(allNodes,(function(node){nodeObj[node.key]=node}));var mediaLinkObj={};_.each(allLinks,(function(link){var from=link.from;var to=link.to;var fromNode=nodeObj[from];var toNode=nodeObj[to];if(fromNode&&toNode)if(isMedia(fromNode.category)){mediaLinkObj[from]||(mediaLinkObj[from]=[]);mediaLinkObj[from].push(link)}else if(isMedia(toNode.category)){mediaLinkObj[to]||(mediaLinkObj[to]=[]);mediaLinkObj[to].push(link)}}));var links=[];var existedLinkObj={};_.each(mediaLinkObj,(function(mediaLinks,nodeId){var nbrs=[];_.each(mediaLinks,(function(link){var from=link.from;var to=link.to;var key=from+"_"+to;existedLinkObj[key]=!0;existedLinkObj[key=to+"_"+from]=!0;var nbrKey=from===nodeId?to:from;nbrs.push(nbrKey)}));var nbrLength=(nbrs=_.uniq(nbrs)).length;for(var i=0;i<nbrLength;i++){var n1=nbrs[i];for(var j=i+1;j<nbrLength;j++){var n2=nbrs[j];var key=n1+"_"+n2;existedLinkObj[key]||links.push({from:n1,to:n2});existedLinkObj[key]=!0;existedLinkObj[key=n2+"_"+n1]=!0}}}));_.each(allLinks,(function(linkData){var key1=linkData.from+"_"+linkData.to;var key2=linkData.to+"_"+linkData.from;existedLinkObj[key1]||existedLinkObj[key2]||links.push(linkData)}));console.log(links);return links}function isMedia(category){return netBrain.Map.CategoryMgr.isMedia(category)}function getMatchedKeys(matchedNodes){var matchedNodeKeys=[];matchedNodes.forEach((function(node){matchedNodeKeys.push(node.id)}));return matchedNodeKeys}}(NetBrain);NetBrain.ns("L2Improvements");!function(netBrain){NetBrain.ns("L2Improvements.Utils").utils={createDic:function(){return Object.create(null)},sumReducer:function(memo,num){return memo+num},dataURLtoBlob:function(dataurl){var arr=dataurl.split(","),mime=arr[0].match(/:(.*?);/)[1],bstr=atob(arr[1]),n=bstr.length,u8arr=new Uint8Array(n);for(;n--;)u8arr[n]=bstr.charCodeAt(n);return new Blob([u8arr],{type:mime})},blobToDataURL:function(blob,callback){var a=new FileReader;a.onload=function(e){callback(e.target.result)};a.readAsDataURL(blob)}}}();!function(netBrain){NetBrain.ns("L2Improvements.Utils").ringHelper={makeRing:function(items){_.each(items,(function(item,index){item.index=index;item.previous=items[index-1];item.next=items[index+1]}));var first=_.first(items);var last=_.last(items);if(first&&last){first.previous=last;last.next=first}}}}();!function(netBrain){var pi=Math.PI;var pi2=2*pi;netBrain.ns("L2Improvements.Utils").radianHelper={getDiff:function(from,to){return toRange(getRealDiff(from,to),0,pi2,pi2)},getMinDiff:function(from,to){return toRange(getRealDiff(from,to),-pi,pi,pi2)},getDiffDirection:function(diff){return diff>0?1:diff<0?-1:0},toRange:toRange,forTest:{getRealDiff:getRealDiff}};return;function getRealDiff(from,to){return to-from}function toRange(value,from,to,step){var result=value%step;result>to?result-=step:result<from&&(result+=step);return result}}(NetBrain);!function(netBrain){NetBrain.ns("L2Improvements.Models").Bounds=function(top,right,bottom,left){this.top=top;this.right=right;this.bottom=bottom;this.left=left}}();!function(netBrain){NetBrain.ns("L2Improvements.Models").Ring=function(){this.next=null;this.previous=null}}();!function(netBrain){NetBrain.ns("L2Improvements.Models").Node=function(originalNode,positions,linkedPorts,unlinkedPorts,links,overrides){this.originalNode=originalNode;this.positions=positions;this.linkedPorts=linkedPorts;this.unlinkedPorts=unlinkedPorts;this.links=links;this.center=null;this.innerCenter=null;this.startRadian=0;this.bounds={top:null,right:null,bottom:null,left:null};this.linkedMatches=null;this.unlinkedMatches=null;this.tailHeadStep=null;this.radianStep=null;this.portPositionMatches=[];this.fans=[];return _.extend(this,overrides)}}();!function(netBrain){NetBrain.ns("L2Improvements.Models").SimpleNode=function(originalNode,position){this.originalNode=originalNode;this.position=position;this.xNeighbors=[];this.yNeighbors=[]}}();!function(netBrain){NetBrain.ns("L2Improvements.Models").Link=function(originalLink,points,overrides){this.originalLink=originalLink;this.points=points;this.fromPort=null;this.toPort=null;return _.extend(this,overrides)}}();!function(netBrain){var models=NetBrain.ns("L2Improvements.Models");Port.prototype.setPosition=function(position){this.position=position};Port.prototype.getPosition=function(){return this.position};models.Port=Port;return;function Port(originalPort,overrides){this.originalPort=originalPort;this.radian=null;this.position=null;return _.extend(this,overrides)}}();!function(netBrain){var models=NetBrain.ns("L2Improvements.Models");LinkPort.prototype.setPosition=function(position){this.port.setPosition(position)};LinkPort.prototype.getPosition=function(){return this.port.getPosition()};LinkPort.prototype.getAnotherPortPosition=function(){return this.anotherLinkPort&&this.anotherLinkPort.getPosition()||this.anotherPoint};models.LinkPort=LinkPort;return;function LinkPort(link,port,connect,anotherPoint,overrides){this.link=link;this.port=port;this.connect=connect;this.anotherPoint=anotherPoint;this.radian=null;this.layouted=!1;this.anotherLinkPort=null;return _.extend(this,overrides)}}();!function(netBrain){var models=NetBrain.ns("L2Improvements.Models");Position.prototype.getRow=function(){return this.row};models.Position=Position;return;function Position(originalPosition,x,y,relativeX,relativeY,row,overrides){this.originalPosition=originalPosition;this.x=x;this.y=y;this.relativeX=relativeX;this.relativeY=relativeY;this.row=row;this.radian=null;this.index=null;this.currentPort=null;return _.extend(this,overrides)}}();!function(netBrain){NetBrain.ns("L2Improvements.Models").Match=function(port,position,diff,direction){this.port=port;this.position=position;this.diff=diff;this.direction=direction;position.currentPort=port;port.setPosition(position)}}();!function(netBrain){NetBrain.ns("L2Improvements.Models").Fan=function(matches,start,end){this.matches=matches;this.start=start;this.end=end;this.diff=null;this.direction=null}}();!function(netBrain){var pi=Math.PI;var pi2=2*pi;var l2Improvements=netBrain.ns("L2Improvements");var utils=l2Improvements.Utils;var margin=22.5;var rows={top:0,right:2,bottom:1,left:3};var areas=[[4,9,2],[3,5,7],[8,1,6]];var recommandRows=[];recommandRows[rows.top]=[null,rows.bottom,rows.top,rows.top,rows.top,rows.top,rows.right,rows.right,rows.left,null];recommandRows[rows.right]=[null,rows.bottom,rows.right,rows.left,rows.top,rows.right,rows.right,null,rows.bottom,rows.top];recommandRows[rows.bottom]=[null,null,rows.right,rows.left,rows.left,rows.bottom,rows.bottom,rows.right,rows.bottom,rows.top];recommandRows[rows.left]=[null,rows.bottom,rows.top,null,rows.left,rows.left,rows.bottom,rows.right,rows.left,rows.top];var correctRadians=[];correctRadians[rows.top]=-pi/2;correctRadians[rows.right]=0;correctRadians[rows.bottom]=pi/2;correctRadians[rows.left]=pi;l2Improvements.correctLinkPortRadian={correctRadian:function(linkedPort,defaultRadian,node){if(!enableCorrect)return defaultRadian;if(!linkedPort.anotherLinkPort||!linkedPort.anotherLinkPort.layouted)return defaultRadian;var anotherPosition=linkedPort.getAnotherPortPosition();var anotherRow=(position=anotherPosition,position&&position.getRow?position.getRow():null);var position;if(null===anotherRow)return defaultRadian;var recommandRow=getRecommandRow(node,anotherPosition,anotherRow);if(null===recommandRow)return defaultRadian;var radian=getCorrectRadian(recommandRow);radian=utils.radianHelper.toRange(radian-node.startRadian,-pi,pi,pi2);recommandRow===rows.left&&defaultRadian<0&&(radian*=-1);return(defaultRadian+radian)/2},forTest:{getAreaX:getAreaX,getAreaY:getAreaY,getArea:getArea,getRecommandRow:getRecommandRow,getCorrectRadian:getCorrectRadian,areas:areas}};var enableCorrect=!0;function getRecommandRow(node,anotherPosition,anotherRow){var area=getArea(node,anotherPosition);return recommandRows[anotherRow][area]}function getArea(node,anotherPosition){var bounds=node.bounds;var x=getAreaX(bounds,anotherPosition);var y=getAreaY(bounds,anotherPosition);return areas[y][x]}function getAreaX(bounds,point){return point.x<bounds.left-margin?0:point.x>bounds.right+margin?2:1}function getAreaY(bounds,point){return point.y<bounds.top-margin?0:point.y>bounds.bottom+margin?2:1}function getCorrectRadian(recommandRow){return correctRadians[recommandRow]}}(NetBrain);!function(netBrain){var pi2=2*Math.PI;var radianStepMoveRate=.6;var fanOptimizeTries=1;var getRadian=netBrain.LayoutTools.PublicApi.Tools.angle.getRadian;var l2Improvements=netBrain.ns("L2Improvements");var utils=l2Improvements.Utils;var Match=l2Improvements.Models.Match;var Fan=l2Improvements.Models.Fan;var correctRadian=l2Improvements.correctLinkPortRadian.correctRadian;var sumReducer=utils.utils.sumReducer;l2Improvements.layoutPorts={layoutNodesPorts:function(nodes){nodes=_.chain(nodes).filter((function(node){return node.linkedPorts.length})).sortBy((function(node){return-node.linkedPorts.length})).value();_.each(nodes,layoutPorts)},forTest:{layoutPorts:layoutPorts}};return;function layoutPorts(node){if(!(node.linkedPorts.length<1)){!function(node){!function(node){var positions=node.positions;node.tailHeadStep=1-positions.length;node.radianStep=pi2/positions.length}(node);!function(node){var nodeCenter=node.center;_.each(node.positions,(function(position){position.radian=getRadian(nodeCenter,position)}))}(node);!function(node){var nodeCenter=node.center;_.each(node.linkedPorts,(function(linkedPort){var defaultRadian=getRadian(nodeCenter,linkedPort.anotherPoint);linkedPort.radian=correctRadian(linkedPort,defaultRadian,node)}))}(node)}(node);!function(node){var average=function(node){return _.chain(node.linkedPorts).pluck("radian").reduce(sumReducer,0).value()}(node)/node.linkedPorts.length;node.startRadian=average}(node);!function(node){node.positions=ring(node.positions,node.startRadian);node.linkedPorts=ring(node.linkedPorts,node.startRadian)}(node);node.linkedMatches=function(node){var linkedPorts=node.linkedPorts;var positions=node.positions;var linkedMatches=[];_.each(linkedPorts,(function(linkedPort,index){var position=positions[index];position.currentPort=linkedPort;var diff=utils.radianHelper.getMinDiff(position.radian,linkedPort.radian);var direction=utils.radianHelper.getDiffDirection(diff);var linkedMatch=new Match(linkedPort,position,diff,direction);linkedMatches.push(linkedMatch)}));return linkedMatches}(node);!function(node){var linkedMatches=node.linkedMatches;for(var i=linkedMatches.length-1;i>=0;i--){var match=linkedMatches[i];var position=match.position;var next=position.next;for(;!next.currentPort&&next.radian<match.port.radian;)next=(position=next).next;position.currentPort||movePortToPosition(match,position)}}(node);!function(node){for(var i=0;i<fanOptimizeTries;i++){var fans=splitFans(node);utils.ringHelper.makeRing(fans);node.fans=fans;mergeFans(node);optimizeFans(node)}}(node);!function(node){_.each(node.linkedPorts,(function(linkPort){linkPort.layouted=!0}))}(node);node.unlinkedMatches=function(node){var unlinkedPorts=node.unlinkedPorts;var positions=node.positions;var firstPosition=_.first(positions);var position=firstPosition;var unlinkedMatches=[];_.each(unlinkedPorts,(function(port){for(;position.currentPort&&(position=position.next)!==firstPosition;);if(!position.currentPort){var unlinkedMatch=new Match(port,position);unlinkedMatches.push(unlinkedMatch)}}));return unlinkedMatches}(node);node.portPositionMatches=function(node){return _.map(node.linkedMatches,convertLinkedMatchToMatch).concat(node.unlinkedMatches)}(node)}}function convertLinkedMatchToMatch(linkedMatch){return new Match(linkedMatch.port.port,linkedMatch.position)}function ring(items,startRadian){_.each(items,(function(item){item.radian=function(radian,startRadian){return utils.radianHelper.getMinDiff(startRadian,radian)}(item.radian,startRadian)}));items=_.sortBy(items,"radian");utils.ringHelper.makeRing(items);return items}function movePortToPosition(match,position){if(position.currentPort)throw new Error("there is a port already");position.currentPort=match.port;match.position.currentPort=null;match.position=position;match.port.setPosition(position);match.diff=utils.radianHelper.getMinDiff(match.position.radian,match.port.radian)}function mergeFans(node){node.fans.length}function optimizeFans(node){var fans=node.fans;!function(fans){_.each(fans,sumFanDiff)}(fans);!function(sortedFans,node){_.each(sortedFans,(function(fan){!function(fan,node){if(!(Math.abs(fan.diff)>node.radianStep*radianStepMoveRate))return;var expectSteps=function(fan,node){var steps=fan.diff/node.radianStep;steps-=fan.direction*(radianStepMoveRate-.5);steps=Math.round(steps);return Math.abs(steps)}(fan,node);if(expectSteps<1)return;var moveSpace=function(fan,node){return fan.direction>0?function(fan,node){var lastUsedPosition=_.last(fan.matches).position;var nextUsedPosition=_.first(fan.next.matches).position;var startIndex=lastUsedPosition.index;var toIndex=nextUsedPosition.index;toIndex<startIndex&&(toIndex+=node.positions.length);return toIndex-startIndex-1}(fan,node):function(fan,node){var firstUsedPosition=_.first(fan.matches).position;var previousUsedPosition=_.last(fan.previous.matches).position;var startIndex=firstUsedPosition.index;var toIndex=previousUsedPosition.index;startIndex<toIndex&&(startIndex+=node.positions.length);return startIndex-toIndex-1}(fan,node)}(fan,node);if(moveSpace<1)return;var actualStep=Math.min(expectSteps,moveSpace);fan.direction>0?function(fan,step){fan.matches.reverse();_.each(fan.matches,(function(match){movePortToPosition(match,function(position,step){return getStepTarget(position,step,"next")}(match.position,step))}));fan.matches.reverse()}(fan,actualStep):function(fan,step){_.each(fan.matches,(function(match){movePortToPosition(match,function(position,step){return getStepTarget(position,step,"previous")}(match.position,step))}))}(fan,actualStep)}(fan,node)}))}(_.sortBy(fans,reverseDiff),node)}function reverseDiff(fan){return-Math.abs(fan.diff)}function getStepTarget(position,step,propertyName){for(;step-- >0;)position=position[propertyName];return position}function sumFanDiff(fan){var diff=_.chain(fan.matches).pluck("diff").reduce(sumReducer,0).value()/fan.matches.length;fan.diff=diff;fan.direction=utils.radianHelper.getDiffDirection(diff)}function splitFans(node){var matches=node.linkedMatches;var splits=function(ring,node){var splits=[];var last=_.first(ring);var index=1;for(;index<ring.length;){var current=ring[index];isSplit(last,current,node.tailHeadStep)&&splits.push(index-1);last=current;index++}return splits}(function(items){var ring=[].concat(items);ring.unshift(_.last(items));return ring}(matches),node);if(0===splits.length)return[matches];var doubleMatches=[].concat(arr=matches).concat(arr);var arr;var start=_.first(splits);var noduplicate=doubleMatches.slice(start,start+matches.length);splits=_.map(splits,(function(split){return split-start}));var fans=[];_.each(splits,(function(split,index){var end=splits[index+1];var matches=noduplicate.slice(split,end);var fan=new Fan(matches,split,end);fans.push(fan)}));return fans}function isSplit(last,current,tailHeadStep){return!function(last,current,tailHeadStep){var step=current-last;return 1===step||step===tailHeadStep}(last.position.index,current.position.index,tailHeadStep)||last.direction<=0&&current.direction>=0}}(NetBrain);!function(netBrain){var minXRange=100;var minYRange=40;var maxXRange=240;var maxYRange=96;var dimensions={x:"xNeighbors",y:"yNeighbors"};var l2Improvements=netBrain.ns("L2Improvements");var sumReducer=l2Improvements.Utils.utils.sumReducer;l2Improvements.alignNodes={alignNodes:function(nodes){initNeighbors(nodes);align(nodes,"x");initNeighbors(nodes);align(nodes,"y")},forTest:{isXNeighbor:isXNeighbor,isYNeighbor:isYNeighbor,neighborProcess:neighborProcess,sumProperty:sumProperty,averageProperty:averageProperty,initNeighbors:initNeighbors,getAllNeighbors:getAllNeighbors,getAllNeighborsEachOther:function(node,dimension){var propertyName=dimensions[dimension];var allNeighbors=[node];var neighbors=node[propertyName];for(;neighbors.length>0;){var mostNeighborsNode=getMostNeighborsNode(neighbors,dimension);allNeighbors.push(mostNeighborsNode);neighbors=_.intersection(neighbors,mostNeighborsNode[propertyName]);neighbors=_.difference(neighbors,allNeighbors)}return allNeighbors}}};function align(nodes,dimension){var mostNeighborsNode=getMostNeighborsNode(nodes,dimension);if(mostNeighborsNode){!function(node,dimension){var allNeighbors=getAllNeighbors(node,dimension);var value=averageProperty(_.pluck(allNeighbors,"position"),dimension);!function(neighbors,value,dimension){_.each(neighbors,(function(neighbor){neighbor.position[dimension]=value}))}(allNeighbors,value,dimension);_.each(allNeighbors,(function(neighbor){!function removeNeighbors(node,dimension,depth){var propertyName=dimensions[dimension];_.each(node[propertyName],(function(neighbor){0===depth?removeNeighbors(neighbor,dimension,1):neighbor[propertyName]=_.filter(neighbor[propertyName],(function(another){return another!==node}))}));node[propertyName]=[]}(neighbor,dimension,1)}))}(mostNeighborsNode,dimension);align(nodes,dimension)}}function getMostNeighborsNode(nodes,dimension){return _.chain(nodes).each((function(node){var propertyName=dimensions[dimension];node.neighbors=node[propertyName].length})).filter((function(node){return node.neighbors>0})).sortBy("neighbors").last().value()}function getAllNeighbors(node,dimension){var neighbors=node[dimensions[dimension]];return[].concat([node]).concat(neighbors)}function averageProperty(items,dimension){return sumProperty(items,dimension)/items.length}function sumProperty(items,dimension){return _.chain(items).pluck(dimension).reduce(sumReducer,0).value()}function initNeighbors(nodes){!function(nodes){_.each(nodes,(function(node){node.xNeighbors=[];node.yNeighbors=[]}))}(nodes);for(var i=0;i<nodes.length;i++){var current=nodes[i];for(var j=i+1;j<nodes.length;j++){neighborProcess(current,nodes[j])}}}function neighborProcess(current,another){var currentPosition=current.position;var anotherPosition=another.position;var xDistance=Math.abs(currentPosition.x-anotherPosition.x);var yDistance=Math.abs(currentPosition.y-anotherPosition.y);if(isXNeighbor(xDistance,yDistance)){current.xNeighbors.push(another);another.xNeighbors.push(current)}else if(isYNeighbor(xDistance,yDistance)){current.yNeighbors.push(another);another.yNeighbors.push(current)}}function isXNeighbor(xDistance,yDistance){return xDistance<minXRange&&yDistance>maxYRange}function isYNeighbor(xDistance,yDistance){return yDistance<minYRange&&xDistance>maxXRange}}(NetBrain);!function(netBrain){var l2Improvements=NetBrain.ns("L2Improvements");var minPointTurn=3;l2Improvements.turns={getLinkTurns:function(link){return getPointsTurns(link.points)},getPointsTurns:getPointsTurns,forTest:{}};function getPointsTurns(originalPoints){var points=function(originalPoints){var lastPoint={};return _.filter(originalPoints,(function(currentPoint){return!(point1=lastPoint,point2=currentPoint,point1.x===point2.x&&point1.y===point2.y)&&(lastPoint=currentPoint);var point1,point2}))}(originalPoints);var turns=0;if(points.length<minPointTurn)return turns;var endIndex=minPointTurn;for(;endIndex<=points.length;){var startIndex=endIndex-minPointTurn;isPointsSameLine(points.slice(startIndex,endIndex))||turns++;endIndex++}return turns}function isPointsSameLine(points){return hasSameProperty(points,"x")||hasSameProperty(points,"y")}function hasSameProperty(items,propertyName){if(items.length<2)return!0;var specialValue=items[0][propertyName];return!_.find(items,(function(item){return item[propertyName]!==specialValue}))}}();!function(netBrain){var ROWS={top:0,right:2,bottom:1,left:3};var PI=Math.PI;var l2Improvements=netBrain.ns("L2Improvements");var utils=l2Improvements.Utils.utils;var models=l2Improvements.Models;var Bounds=models.Bounds;var Node=models.Node;var SimpleNode=models.SimpleNode;var Port=models.Port;var Link=models.Link;var LinkPort=models.LinkPort;var Position=models.Position;var OriginalPosition=netBrain.LayoutTools.PublicApi.Models.Position;var layoutNodesPorts=l2Improvements.layoutPorts.layoutNodesPorts;var getLinkTurns=l2Improvements.turns.getLinkTurns;var doAlignNodes=l2Improvements.alignNodes.alignNodes;l2Improvements.l2ImprovementsHelper={layoutPorts:function(originalNodes){var nodes=function(originalNodes){return _.map(originalNodes,convertNode)}(originalNodes);!function(nodes){var allLinkPorts=function(nodes){return _.chain(nodes).pluck("linkedPorts").flatten().value()}(nodes);var dicByOriginalLink=utils.createDic();_.each(allLinkPorts,(function(linkPort){var originalLink=linkPort.link.originalLink;var anotherLinkPort=dicByOriginalLink[originalLink];if(anotherLinkPort){linkPort.anotherLinkPort=anotherLinkPort;anotherLinkPort.anotherLinkPort=linkPort}else dicByOriginalLink[originalLink]=linkPort}))}(nodes);layoutNodesPorts(nodes);_.each(nodes,(function(node){matches=node.portPositionMatches,_.each(matches,applyMatch);var matches}))},alignNodes:function(diagramNodes){var originalNodes=function(diagramNodes){var originalNodes=[];diagramNodes.each((function(node){originalNodes.push(node)}));return originalNodes}(diagramNodes);var nodes=function(originalNodes){return _.map(originalNodes,convertSimpleNode)}(originalNodes=_.filter(originalNodes,isNetworkDevice));doAlignNodes(nodes);!function(nodes){_.each(nodes,applyNewLocation)}(nodes)},getLayoutablePortsByLinks:getLayoutablePortsByLinks,getLayoutablePortsByNodes:function(nodes){try{return getLayoutablePortsByLinks(function(nodes){var links=[];_.each(nodes,(function(node){node.linksConnected&&node.linksConnected.each((function(link){links.push(link)}))}));return links}(nodes))}catch(ex){console.warn("getLayoutablePortsByNodes warn:",ex);return[]}},debug:{summary:function(diagram){!function(diagram){var statistics=function(originalLinks){var links=function(originalLinks){var links=[];originalLinks.map((function(originalLink){var link=convertLink(originalLink);links.push(link)}));return links}(originalLinks);var statistics=function(links){return netBrain.Map.CompL2TopoLink.getIntersectCount(links)}(originalLinks);statistics.turns=function(links){return _.chain(links).map(getLinkTurns).reduce(utils.sumReducer,0).value()}(links);statistics.links=links.length;return statistics}(diagram.links);statistics.nodes=diagram.nodes.count;console.table([statistics])}(diagram);!function(diagram){var base64=function(diagram){var bounds=diagram.documentBounds;var size=new go.Size(bounds.width,bounds.height);return diagram.makeImageData({size:size,maxSize:size,scale:1,type:"image/png"})}(diagram);var blob=utils.dataURLtoBlob(base64);saveAs(blob,"map_image.png")}(diagram)}},forTest:{createSimpleNodeByBounds:createSimpleNodeByBounds,getOutRadian:getOutRadian,getExpectRow:getExpectRow}};return;function getLayoutablePortsByLinks(links){var nodesPorts=function(links){var nodes=[];var ports=[];_.each(links,(function(link){var fromNode=link.fromNode;var toNode=link.toNode;nodes.push(fromNode);nodes.push(toNode);if(link.fromPortId&&isRealPort(link.fromPort)){var simpleFromPort=function(fromPort,fromNode,toNode){return{id:fromPort.portId,row:fromPort.getPortPos().row,hostNodeId:fromNode.data.key,otherNodeId:toNode.data.key,originalPort:fromPort}}(link.fromPort,fromNode,toNode);ports.push(simpleFromPort)}if(link.toPortId&&isRealPort(link.toPort)){var simpleToPort=function(toPort,fromNode,toNode){return{id:toPort.portId,row:toPort.getPortPos().row,originalPort:toPort,hostNodeId:toNode.data.key,otherNodeId:fromNode.data.key}}(link.toPort,fromNode,toNode);ports.push(simpleToPort)}}));return{nodes:nodes,ports:ports}}(_.filter(links,(function(link){return link.data.category===netBrain.Map.CategoryMgr.TopoLink})));var nodesDic=function(originalNodes){var nodesDic=utils.createDic();_.each(originalNodes,(function(originalNode){var nodeId=originalNode.data.key;nodesDic[nodeId]||(nodesDic[nodeId]=function(originalNode){var bounds=originalNode.actualBounds;var simpleNode=createSimpleNodeByBounds(originalNode.data.key,bounds);simpleNode.originalNode=originalNode;return simpleNode}(originalNode))}));return nodesDic}(nodesPorts.nodes);var radianCache=utils.createDic();return _.chain(nodesPorts.ports).each((function(port){var hostNode=nodesDic[port.hostNodeId];var outRadian=getOutRadian(hostNode,nodesDic[port.otherNodeId],radianCache);port.expectRow=getExpectRow(hostNode,outRadian)})).filter(isPortLayoutable).map(onlyId).groupBy("nodeId").pairs().map(toNodePorts).value()}function toNodePorts(kvArray){return{nodeId:kvArray[0],portIds:_.pluck(kvArray[1],"id")}}function onlyId(port){return{id:port.id,nodeId:port.hostNodeId}}function getExpectRow(hostNode,outRadian){return outRadian<=hostNode.dividing2&&outRadian>=hostNode.dividing1?ROWS.bottom:outRadian<=hostNode.dividing1&&outRadian>=hostNode.dividing4?ROWS.right:outRadian<=hostNode.dividing4&&outRadian>=hostNode.dividing3?ROWS.top:ROWS.left}function getOutRadian(hostNode,otherNode,radianCache){var key=[hostNode.id,otherNode.id].join("_");var outRadian;if(Object.hasOwnProperty.call(radianCache,key))outRadian=radianCache[key];else{outRadian=function(hostNode,otherNode){var hostCenter=hostNode.center;var otherCenter=otherNode.center;var x=otherCenter.x-hostCenter.x;var y=otherCenter.y-hostCenter.y;return Math.atan2(y,x)}(hostNode,otherNode);radianCache[key]=outRadian;!function(otherNode,hostNode,outRadian,radianCache){var otherKey=[otherNode.id,hostNode.id].join("_");radianCache[otherKey]=outRadian>0?outRadian-PI:outRadian+PI}(otherNode,hostNode,outRadian,radianCache)}return outRadian}function isPortLayoutable(port){return port.row!==port.expectRow}function isRealPort(port){return port.portId&&_.isFunction(port.getPortPos)}function createSimpleNodeByBounds(id,bounds){var width=bounds.width;var height=bounds.height;var dividing=Math.atan2(height,width);return{id:id,center:bounds.center,dividing1:dividing,dividing2:PI-dividing,dividing3:dividing-PI,dividing4:-dividing}}function applyMatch(match){var originalPosition=match.position.originalPosition;match.port.originalPort.setPortPos(originalPosition.row,originalPosition.col)}function convertNode(originalNode){var positions=function(originalNode){var positions=[];addRowPositions(positions,originalNode,0);addRowPositions(positions,originalNode,1);addRowPositions(positions,originalNode,2);addRowPositions(positions,originalNode,3);return positions}(originalNode);var ports=function(originalNode){var originalPorts=originalNode.getPorts();return _.map(originalPorts,convertPort)}(originalNode);var links=function(originalNode){var links=[];var it=originalNode.linksConnected;for(;it.next();){var link=convertLink(it.value);links.push(link)}return links}(originalNode);var portsDic=function(ports){var dic=utils.createDic();_.each(ports,(function(port){dic[port.originalPort.portId]=port}));return dic}(ports);var linkedPorts=function(links,portsDic){var linkedPorts=[];_.each(links,(function(link){var fromInfo=function(link,portsDic){var fromPortId=link.originalLink.fromPortId;if(fromPortId){var port=portsDic[fromPortId];portsDic[fromPortId]=null;if(port){var anotherPoint=_.last(link.points);return new LinkPort(link,port,"from",anotherPoint)}}return null}(link,portsDic);fromInfo&&linkedPorts.push(fromInfo);var toInfo=function(link,portsDic){var toPortId=link.originalLink.toPortId;if(toPortId){var port=portsDic[toPortId];portsDic[toPortId]=null;if(port){var anotherPoint=_.first(link.points);return new LinkPort(link,port,"to",anotherPoint)}}return null}(link,portsDic);toInfo&&linkedPorts.push(toInfo)}));return linkedPorts}(links,portsDic);var unlinkedPorts=function(portsDic){return _.chain(portsDic).values().filter((function(item){return item})).value()}(portsDic);return new Node(originalNode,positions,linkedPorts,unlinkedPorts,links,{center:getNodeCenter(originalNode),innerCenter:getNodeInnerCenter(originalNode),bounds:getNodeBounds(originalNode)})}function getNodeBounds(originalNode){var actualBounds=originalNode.actualBounds;var top=actualBounds.y;var right=actualBounds.x+actualBounds.width;var bottom=actualBounds.y+actualBounds.height;var left=actualBounds.x;return new Bounds(top,right,bottom,left)}function getNodeCenter(originalNode){return originalNode.actualBounds.center}function getNodeInnerCenter(originalNode){var bounds=originalNode.actualBounds;return new OriginalPosition(bounds.width/2,bounds.height/2)}function addRowPositions(positions,originalNode,row){var actualBounds=originalNode.actualBounds;var rowSize=originalNode.getColCount(row);_.each(_.range(rowSize),(function(col){var originalPosition=originalNode.getPortPos(row,col);var position=new Position(originalPosition,originalPosition.x+actualBounds.x,originalPosition.y+actualBounds.y,originalPosition.x,originalPosition.y,row);positions.push(position)}))}function convertPort(originalPort){return new Port(originalPort)}function convertLink(originalLink){var points=originalLink.points.toArray();return new Link(originalLink,points)}function isNetworkDevice(node){return netBrain.Map.CategoryMgr.isNetworkDevice(node.category)}function applyNewLocation(node){node.originalNode.location=(position=node.position,new go.Point(position.x,position.y));var position}function convertSimpleNode(originalNode){var position=(point=originalNode.location,new OriginalPosition(point.x,point.y));var point;return new SimpleNode(originalNode,position)}}(NetBrain);!function(netBrain){netBrain.ns("MapImprovements.PortChannel");netBrain.ns("MapImprovements.PortChannel");netBrain.ns("MapImprovements.PortChannel")}(NetBrain);NetBrain.MapImprovements.PortChannel.consts={wordings:{noPortChannelOfSelectedPhysicalLink:"Failed to show the port-channel link. The topology data of the port-channel interface does not exist.",noPhysicalLinkOfSelectedPortChannel:"Failed to show the physical interface links. The topology data of the physical interfaces within the port channel does not exist.",noPortChannelsOnTheMap:"There is no port channels on the map",noPhysicalLinkOfAllThePortChannels:"There is no physical links found of all the port channel on the map",noPhysicalLinksOnTheMap:"No port channel links displayed on the map.",noPortChannelsOfAllThePhysicalLinks:"There is no port channel found of all the physical links on the map",allFailed:"Failed to switch because the topology link(s) cannot be found.",someFailed:"Some topology links failed to switched because the topology link(s) cannot be found.",somePortChannelToPhysicalFailed:"Failed to show all physical interface links. The topology data of some physical interfaces does not exist.",somePhysicalToPortChannelFailed:"Failed to show all port-channel links. The topology data of some port-channel interfaces does not exist."}};!function(netBrain){var regHasChannel=/.+\(.+\)/;var servicesCacheDic=createDic();var portChannel=netBrain.MapImprovements.PortChannel;var wordings=portChannel.consts.wordings;var mapConsts=netBrain.Map.Const;portChannel.common={createDic:createDic,alertMessage:alertMessage,tipMessage:tipMessage,logError:logError,iteratorToArray:iteratorToArray,isL2Topo:isL2Topo,isPortChannel:function(link){return link&&link.data&&((linkData=link.data,!linkData.intfSrc&&isPortChannelInterface(linkData.intfDest))||function(linkData){return!linkData.intfDest&&isPortChannelInterface(linkData.intfSrc)}(link.data)||function(linkData){return isPortChannelInterface(linkData.intfSrc)&&isPortChannelInterface(linkData.intfDest)}(link.data));var linkData},isPhysicalOfPortChannel:function(link){return link&&link.data&&isPhysicalInterfaceOfPortChannel(link.data.intfSrc)&&isPhysicalInterfaceOfPortChannel(link.data.intfDest)},getLinkBaseByLinks:getLinkBaseByLinks,getLinkBaseByLinkInfo:function(linkInfo){return{from:{devId:linkInfo.devId,intfId:linkInfo.intf.intfKeyObj.value},to:{devId:linkInfo.nbrId,intfId:linkInfo.nbrIntf.intfKeyObj.value}}},getLinkBaseByLinkData:getLinkBaseByLinkData,getSrcInterfaceName:getSrcInterfaceName,getDestInterfaceName:getDestInterfaceName,getSrcChannelList:function(link){return getChannelList(link.data.intfSrc)},getDestChannelList:function(link){return getChannelList(link.data.intfDest)},generateLinkKeyByLink:generateLinkKeyByLink,generateLinkKeyByLinkData:generateLinkKeyByLinkData,removeLinks:removeLinks,removeLinksPorts:removeLinksPorts,removeLinksByLinkBases:function(linkBases,netMap){var linkDatas=function(linkBases,netMap){var linkKeysDic=generateLinkKeysDic(linkBases);return netMap._getAllLinksByFilter((function(linkData){var key=generateLinkKeyByLinkData(linkData);return linkKeysDic[key]}))}(linkBases,netMap);_.each(linkDatas,(function(linkData){netMap._removeLink(linkData)}))},removeLinksPortsByLinkBases:function(linkBases,link){var nodeDic=createDic();addNodeToDic(nodeDic,link.fromNode);addNodeToDic(nodeDic,link.toNode);!function(nodeDic,linkBases){_.each(linkBases,(function(linkBase){setRemovePortToDic(nodeDic,linkBase.from);setRemovePortToDic(nodeDic,linkBase.to)}))}(nodeDic,linkBases);var nodesPorts=_.values(nodeDic);_.each(nodesPorts,(function(nodePorts){_.each(nodePorts.ports,(function(port){nodePorts.node.removePort({portId:port})}))}))},addLinks:addLinks,applyDataView:applyDataView,generateLinkKeysDic:generateLinkKeysDic,getPortChannelsByPhysicalLinks:getPortChannelsByPhysicalLinks,getPortChannels:getPortChannels,getPhysicalLinks:getPhysicalLinks,getLinksByLinkBases:function(linkBases,diagram){var linkKeysDic=generateLinkKeysDic(linkBases);var links=[];var allLinks=iteratorToArray(diagram.links);var l2Links=_.filter(allLinks,isL2Topo);_.each(l2Links,(function(link){try{var key=generateLinkKeyByLink(link);linkKeysDic[key]&&links.push(link)}catch(error){console.warn("getLinksByLinkBases catch error:",error,link)}}));return links},validatePhysicalLinks:validatePhysicalLinks,validateLogicalLinks:validateLogicalLinks,replaceLogicalToPhysical:function(option){var portChannelLinks=option.portChannelLinks;return getPhysicalLinks(getLinkBaseByLinks(portChannelLinks)).then((function(originalData){validatePhysicalLinks(originalData,portChannelLinks);var failedDatas=_.filter(originalData,(function(item){return!item.isSuccess}));function doReplace(){!function(option,originalData){var data=function(originalData){var successLinks=_.filter(originalData,(function(group){return group.isSuccess}));return{physicLinkInfos:pluckFlatten(successLinks,"physicLinkInfos"),removeLogicalLinks:pluckFlatten(successLinks,"matchedLogicalLinks"),removeMediaIds:pluckUniqMediaId(successLinks)}}(originalData);var transKey=option.transKey;var mapOperator=option.mapOperator;var netMap=mapOperator.getNetMap();var diagram=netMap.getGoJsDiagram();var removeLogicalLinks=data.removeLogicalLinks;diagram.startTransaction(transKey);removeLinks(removeLogicalLinks,diagram);removeLinksPorts(removeLogicalLinks);!function(mediaIds,diagram){_.each(mediaIds,(function(mediaId){var mediaNode=diagram.findNodeForKey(mediaId);mediaNode&&0===[].length&&diagram.remove(mediaNode)}))}(data.removeMediaIds,diagram);addLinks(data.physicLinkInfos,mapOperator).then((function(){return applyDataView(removeLogicalLinks)})).finally((function(){diagram.commitTransaction(transKey);netMap.setNetMapLegend()}))}(option,originalData)}if(failedDatas.length>0)return failedDatas.length===originalData.length?alertMessage(wordings.allFailed):alertMessage(wordings.somePortChannelToPhysicalFailed).then(doReplace);doReplace()})).catch(logError)},replacePhysicalToLogical:function(option){var transKey=option.transKey;var mapOperator=option.mapOperator;var netMap=mapOperator.getNetMap();var diagram=netMap.getGoJsDiagram();var physicalLinks=option.physicalLinks;return getPortChannelsByPhysicalLinks(physicalLinks).then((function(originalData){var data=validateLogicalLinks(originalData);if(data.logicLinkInfos.length<1)return tipMessage(option.hasNoPhysicalLinkMessage);diagram.startTransaction(transKey);removeLinks(physicalLinks,diagram);removeLinksPorts(physicalLinks);return addLinks(data.logicLinkInfos,mapOperator).then((function(links){return applyDataView(links)})).finally((function(){diagram.commitTransaction(transKey);netMap.setNetMapLegend()}))})).catch(logError)},forTest:{isPortChannelInterfaceName:isPortChannelInterfaceName,getLinkBaseByLink:getLinkBaseByLink,generateLinkKey:generateLinkKey}};function createDic(){return Object.create(null)}function alertMessage(message){return getService("nb.common.nbAlertSrvc").alert(message)}function getTopoLinkSrvc(){return getService("nb.topo.httpTopoLinkSrvc")}function tipMessage(message){var options={tipInfo:message,autoClose:!0,hasCloseBtn:!1,customClass:"port-channel-tip"};return getService("nb.common.nbTipSrvc").open(options)}function getService(serviceKey){return servicesCacheDic[serviceKey]||(servicesCacheDic[serviceKey]=angular.element(document).injector().get(serviceKey))}function logError(reason){console.error(reason)}function iteratorToArray(iterator){var items=[];iterator.each((function(item){items.push(item)}));return items}function isL2Topo(link){return link.data.topoType===mapConsts.TopoLinkType.L2Topology}function isPortChannelInterface(interfaceInf){return getintfExtendData(interfaceInf,"intfs.isChannel")}function isPhysicalInterfaceOfPortChannel(interfaceInf){return getintfExtendData(interfaceInf,"intfs.channelList")}function getintfExtendData(interfaceInf,key){return interfaceInf&&interfaceInf.intfInfo&&interfaceInf.intfInfo.intf&&interfaceInf.intfInfo.intf.intfExtendData&&interfaceInf.intfInfo.intf.intfExtendData[key]}function isPortChannelInterfaceName(interfaceName){return regHasChannel.test(interfaceName)}function getSrcInterfaceName(link){return getInterfaceName(link,NetBrain.Map.CompTopolink.srcLinkIntfInfoLabel)}function getDestInterfaceName(link){return getInterfaceName(link,NetBrain.Map.CompTopolink.destLinkIntfInfoLabel)}function getInterfaceName(link,interfaceName){var interfaceNameObj=link.findObject(interfaceName);return interfaceNameObj?interfaceNameObj.text:""}function getChannelList(intfData){return function(channelListString){var channelList=(channelListString=channelListString||"").split(",");return _.filter(channelList,(function(channelName){return!_.isEmpty(channelName)}))}(function(intfData){return intfData&&intfData.intfInfo&&intfData.intfInfo.intf&&intfData.intfInfo.intf.intfExtendData&&intfData.intfInfo.intf.intfExtendData["intfs.channelList"]}(intfData))}function getLinkBaseByLinks(physicalLinks){var linkBases=_.map(physicalLinks,getLinkBaseByLinkSafe);return _.filter(linkBases,(function(linkBase){return linkBase}))}function getLinkBaseByLinkSafe(link){try{return getLinkBaseByLink(link)}catch(ex){console.warn("getLinkBaseByLink",ex);return null}}function getLinkBaseByLink(link){var fromNodeData=link.fromNode.data.devNodeData;var fromPortData=function(link){return doTry((function(){return link.data.intfSrc.intfInfo.intf.intfNodeData}))||doTry((function(){return link.fromPort.data.intf.intfNodeData}))||doTry((function(){return link.fromNode.data.getIntfInfo(link.data.fromPort).intf.intfNodeData}))}(link);var toNodeData=link.toNode.data.devNodeData;var toPortData=function(link){return doTry((function(){return link.data.intfDest.intfInfo.intf.intfNodeData}))||doTry((function(){return link.toPort.data.intf.intfNodeData}))||doTry((function(){return link.toNode.data.getIntfInfo(link.data.toPort).intf.intfNodeData}))}(link);return{from:buildFromInfo(fromNodeData,fromPortData)||null,to:buildToInfo(toNodeData,toPortData)||null,mediaInfo:getMediaInfo(link)||null}}function buildFromInfo(fromNodeData,fromPortData){return buildDeviceAndInterfaceBaseInfo(fromNodeData,fromPortData)}function buildToInfo(toNodeData,toPortData){return buildDeviceAndInterfaceBaseInfo(toNodeData,toPortData)}function buildDeviceAndInterfaceBaseInfo(nodeData,portData){return nodeData&&portData&&{devId:nodeData.id,intfId:portData.id,devIdentify:{id:nodeData.id,nodeIdentify:nodeData.nodeIdentify,visualSpaceInfo:nodeData.visualSpaceInfo},intIdentify:{id:portData.id,nodeIdentify:portData.nodeIdentify,visualSpaceInfo:portData.visualSpaceInfo}}}function getMediaInfo(link){return link&&link.data&&link.data.mediaInfo}function doTry(fn){try{return fn()}catch(ex){return}}function getLinkBaseByLinkData(linkData){return{from:{devId:linkData.from,intfId:linkData.fromPort},to:{devId:linkData.to,intfId:linkData.toPort}}}function generateLinkKeyByLinkData(linkData){return generateLinkKey(getLinkBaseByLinkData(linkData))}function generateLinkKeyByLink(link){return generateLinkKey(getLinkBaseByLink(link))}function generateLinkKey(linkBase){return[linkBase.from.devId,linkBase.from.intfId,linkBase.to.devId,linkBase.to.intfId].join("&")}function removeLinks(links,diagram){_.each(links,(function(link){diagram.remove(link)}))}function removeLinksPorts(links){_.each(links,(function(link){removePortOrIntfData(link.fromNode,link.data.intfSrc);removePortOrIntfData(link.toNode,link.data.intfDest)}))}function removePortOrIntfData(node,intfData){var intfId=function(intfData){return intfData&&intfData.intfInfo&&intfData.intfInfo.intf&&intfData.intfInfo.intf.intfKeyObj&&intfData.intfInfo.intf.intfKeyObj.value}(intfData);if(intfId)if(node.removePort)node.removePort({portId:intfId});else{var dataView=node.data.dataViewData;dataView.intfInfoList=_.reject(dataView.intfInfoList,(function(intf){return intf.intf.intfKeyObj.value===intfId}))}}function applyDataView(links){var deviceIds=function(links){return _.chain(links).pluck("data").map((function(data){return[data.from,data.to]})).flatten().uniq().value()}(links);getService("nb.dataview.applyDataViewSrvc").applyDataviewsOnDevices(deviceIds)}function addLinks(linkInfos,mapOperator){var result=function(linkInfos){var links=[];var medias=[];_.each(linkInfos,(function(linkInfo){links.push(function(linkInfo){var tempLink=new CNeighborInfo(linkInfo.id,linkInfo.nbrId,linkInfo.intf,linkInfo.nbrIntf,linkInfo.topoTypeId,linkInfo.isP2P,linkInfo.mediaId,linkInfo.mediaInfo,null,null,null,null,linkInfo.isPortChannel);tempLink.setCategory(linkInfo.category);tempLink.setSrcDevId(linkInfo.devId);tempLink.setDestDevId(linkInfo.nbrDevId);return tempLink}(linkInfo));if(linkInfo.mediaInfo){medias.push(linkInfo.mediaInfo);links.push(function(linkInfo){var tempLink=new CNeighborInfo(linkInfo.nbrId,linkInfo.id,linkInfo.nbrIntf,linkInfo.intf,linkInfo.topoTypeId,linkInfo.isP2P,linkInfo.mediaId,linkInfo.mediaInfo,null,null,null,null,linkInfo.isPortChannel);tempLink.setCategory(linkInfo.category);tempLink.setSrcDevId(linkInfo.nbrDevId);tempLink.setDestDevId(linkInfo.devId);return tempLink}(linkInfo))}}));return{links:links,medias:medias}}(linkInfos);var tempLinks=result.links;var newAddMediaIds=function(mediaInfos,mapOperator){var diagram=mapOperator.getNetMap().getGoJsDiagram();var newAddMediaIds=[];_.each(mediaInfos,(function(mediaInfo){if(!!!diagram.findNodeForKey(mediaInfo.mediaId)){var compMedia=mapOperator._buildCompMediaByInfo([mediaInfo.mediaName],mediaInfo.mediaId,mediaInfo.mediaType,mediaInfo.topoType);var netmap=mapOperator.getNetMap();compMedia.location="0 0";netmap._addNode(compMedia);newAddMediaIds.push(mediaInfo.mediaId)}}));return newAddMediaIds}(_.chain(result.medias).groupBy("mediaId").values().map(_.first).value(),mapOperator);return function(tempLinks){var dataViewsSegmentParams=function(tempLinks){var dataViewSegmentParams=new DataViewsSegment;_.each(tempLinks,(function(tempLink){var topoType=tempLink.getTopoType();var srcIntf=tempLink.getSrcIntf();dataViewSegmentParams.addDev(tempLink.getFromKey());dataViewSegmentParams.addIntf(tempLink.getFromKey(),srcIntf.intfKeyObj,topoType,srcIntf.intfNodeData);var destIntf=tempLink.getDestIntf();dataViewSegmentParams.addDev(tempLink.getToKey());dataViewSegmentParams.addIntf(tempLink.getToKey(),destIntf.intfKeyObj,topoType,destIntf.intfNodeData)}));return dataViewSegmentParams}(tempLinks);return getService("nb.netbrain.dataViewCacheSrvc").getDataViewsSegment(null,dataViewsSegmentParams).then((function(dataViewsSegment){!function(dataViewsSegment,tempLinks){Object.setPrototypeOf(dataViewsSegment,new DataViewsSegment);var getIntfDataView=netBrain.Map.ExtendNbrOp.prototype._getIntfDataView;_.each(tempLinks,(function(tempLink){var fromIntfDataView=getIntfDataView(tempLink.getFromKey(),tempLink.getSrcIntf(),tempLink.getTopoType(),dataViewsSegment);var toIntfDataView=getIntfDataView(tempLink.getToKey(),tempLink.getDestIntf(),tempLink.getTopoType(),dataViewsSegment);tempLink.setSrcIntfDataView(fromIntfDataView);tempLink.setDestIntfDataView(toIntfDataView)}))}(dataViewsSegment,tempLinks);return tempLinks}))}(tempLinks).then((function(tempLinks){return function(tempLinks,mapOperator){return _.map(tempLinks,(function(tempLink){var link=function(tempLink,mapOperator){var srcCompDev=mapOperator.getCompDeviceByKey(tempLink.getFromKey());var destCompDev=mapOperator.getCompDeviceByKey(tempLink.getToKey());var links=[];mapOperator._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempLink,links);return links[0]}(tempLink,mapOperator);mapOperator.addLinkLine(link);return link}))}(tempLinks,mapOperator)})).then((function(linkLines){!function(newAddMediaIds,mapOperator){if(newAddMediaIds.length<1)return;new netBrain.Map.LayoutToolsHelper(mapOperator).symmetricLayout({newNodes:newAddMediaIds})}(newAddMediaIds,mapOperator);!function(links,mapOperator){var netmap=mapOperator.getNetMap();var portInfos=netBrain.Map.L2PortsLayoutTool.getPortsInfoByLinkInfos(links,netmap.getGoJsDiagram());netmap.layoutL2Ports(portInfos);netmap.refreshMapViewOptionVisible();netmap.setNetMapLegend()}(linkLines,mapOperator)}))}function setRemovePortToDic(nodeDic,nodePort){var node=nodeDic[nodePort.devId];node&&node.ports.push(nodePort.intfId)}function addNodeToDic(nodeDic,node){nodeDic[node.data.key]={node:node,ports:[]}}function generateLinkKeysDic(linkBases){var linkKeysDic=createDic();_.each(linkBases,(function(linkBase){var key=generateLinkKey(linkBase);linkKeysDic[key]=!0;var anotherKey=generateLinkKey({from:linkBase.to,to:linkBase.from});linkKeysDic[anotherKey]=!0}));return linkKeysDic}function getPortChannelsByPhysicalLinks(physicalLinks){return getPortChannels(getLinkBaseByLinks(physicalLinks))}function getPortChannels(linkBaseInfos){return getTopoLinkSrvc().getL2LogicLinkInfos(linkBaseInfos)}function getPhysicalLinks(linkBaseInfos){return getTopoLinkSrvc().getL2PhysicalLinkInfos(linkBaseInfos)}function validatePhysicalLinks(originalData,portChannelLinks){!function(originalData,portChannelLinks){var groupDic=function(portChannelLinks){var portChannelLinksKV=_.map(portChannelLinks,(function(pcl){var linkBase=getLinkBaseByLinkSafe(pcl);linkBase.originalLink=pcl;return linkBase}));var groupDic=_.groupBy(portChannelLinksKV,(function(pclkv){return pclkv.mediaInfo&&pclkv.mediaInfo.mediaId}));_.each(_.keys(groupDic),(function(mediaId){var links=groupDic[mediaId];var linksDic={};_.each(links,(function(link){var fromIntfId=link.from&&link.from.intfId;fromIntfId&&(linksDic[fromIntfId]=link.originalLink);var toIntfId=link.to&&link.to.intfId;toIntfId&&(linksDic[toIntfId]=link.originalLink)}));groupDic[mediaId]=linksDic}));return groupDic}(portChannelLinks);_.each(originalData,(function(group){group.matchedLogicalLinks=[];group.unMatchedLogicalLinks=[];var dic=groupDic[group.mediaId];if(dic){var intfIds=_.keys(group.intfRelation);_.each(intfIds,(function(intfId){group.matchedLogicalLinks.push(dic[intfId]);dic[intfId]=null}));group.matchedLogicalLinks=_.chain(group.matchedLogicalLinks).filter(hasValue).uniq().value();null!==group.mediaId&&(group.unMatchedLogicalLinks=_.chain(dic).values().filter(hasValue).uniq().value())}}))}(originalData,portChannelLinks);!function(originalData){_.each(originalData,(function(group){var hasEmptyPhysicalInterface=_.chain(group.intfRelation).values().any(_.isEmpty).value();if(group.mediaId){var hasNoUnmatchedLogicalLinks=_.isEmpty(group.unMatchedLogicalLinks);group.isSuccess=hasNoUnmatchedLogicalLinks&&!hasEmptyPhysicalInterface}else{var hasMatchedLogicalLinks=!_.isEmpty(group.matchedLogicalLinks);group.isSuccess=hasMatchedLogicalLinks&&!hasEmptyPhysicalInterface}}))}(originalData)}function pluckFlatten(successLinks,propertyName){return _.chain(successLinks).pluck(propertyName).flatten().value()}function pluckUniqMediaId(originalData){return _.chain(originalData).pluck("mediaId").filter(returnSelf).uniq().value()}function returnSelf(item){return item}function hasValue(item){return!!item}function validateLogicalLinks(originalData){var result={physicLinkInfos:[],logicLinkInfos:[]};_.each(originalData,(function(group){result.physicLinkInfos=result.physicLinkInfos.concat(group.physicLinkInfos);result.logicLinkInfos=result.logicLinkInfos.concat(group.logicLinkInfos)}));return result}}(NetBrain);!function(netBrain){var portChannel=netBrain.MapImprovements.PortChannel;portChannel.showPortChannel=function(actionObj){var physicalLinks=(link=actionObj.currentLink,links=(fromNode=link.fromNode,toNode=link.toNode,fromNodeLinks=common.iteratorToArray(fromNode.linksConnected),toNodeLinks=common.iteratorToArray(toNode.linksConnected),_.intersection(fromNodeLinks,toNodeLinks)),filter=(originalLink=link,fromFeature=getFromFeature(originalLink),toFeature=getToFeature(originalLink),judgeOne=createJudge(fromFeature),judgeAnother=createJudge(toFeature),function(currentLink){var currentFromFeature=getFromFeature(currentLink);var currentToFeature=getToFeature(currentLink);return judgeOne(currentFromFeature)&&judgeAnother(currentToFeature)||judgeOne(currentToFeature)&&judgeAnother(currentFromFeature)}),_.filter(links,filter));var link,links,fromNode,toNode,fromNodeLinks,toNodeLinks,filter,originalLink,fromFeature,toFeature,judgeOne,judgeAnother;return common.replacePhysicalToLogical({transKey:"showPortChannel",mapOperator:actionObj.mapOperator,physicalLinks:physicalLinks,hasNoPhysicalLinkMessage:wordings.noPortChannelOfSelectedPhysicalLink})};var wordings=portChannel.consts.wordings;var common=portChannel.common;function getFromFeature(link){return{nodeId:link.fromNode.data.key,interfaceName:common.getSrcInterfaceName(link),channelList:common.getSrcChannelList(link)}}function getToFeature(link){return{nodeId:link.toNode.data.key,interfaceName:common.getDestInterfaceName(link),channelList:common.getDestChannelList(link)}}function createJudge(originalFeature){var channelList=originalFeature.channelList;return function(currentFeature){var fromSameNode=currentFeature.nodeId===originalFeature.nodeId;var hasSameChannelName=_.intersection(channelList,currentFeature.channelList).length>0;return fromSameNode&&hasSameChannelName}}}(NetBrain);!function(netBrain){var portChannel=NetBrain.MapImprovements.PortChannel;portChannel.showAllPortChannels=function(actionObj){var physicalLinks=function(diagram){var allLinks=common.iteratorToArray(diagram.links);return _.filter(allLinks,common.isPhysicalOfPortChannel)}(actionObj.mapOperator.getNetMap().getGoJsDiagram());if(physicalLinks.length<1)return common.tipMessage(wordings.noPhysicalLinksOnTheMap);return common.replacePhysicalToLogical({transKey:"showAllPortChannels",mapOperator:actionObj.mapOperator,physicalLinks:physicalLinks,hasNoPhysicalLinkMessage:wordings.noPortChannelsOfAllThePhysicalLinks,somePhysicalToPortChannelFailed:wordings.somePhysicalToPortChannelFailed})};var wordings=portChannel.consts.wordings;var common=portChannel.common}();!function(netBrain){var portChannel=NetBrain.MapImprovements.PortChannel;portChannel.showPhysicalPorts=function(actionObj){var currentLink=actionObj.currentLink;var diagram=actionObj.mapOperator.getNetMap().getGoJsDiagram();var portChannelLinks=(link=currentLink,link&&link.data&&link.data.mediaId&&link.data.mediaInfo?function(diagram,mediaId){var links=[];diagram.links.iterator.each((function(link){var isPortChannelLink=common.isPortChannel(link);var isLinkToCurrentMedia=link.data.mediaId===mediaId;isPortChannelLink&&isLinkToCurrentMedia&&links.push(link)}));return links}(diagram,currentLink.data.mediaId):[currentLink]);var link;return common.replaceLogicalToPhysical({transKey:"showPhysicalPorts",mapOperator:actionObj.mapOperator,portChannelLinks:portChannelLinks,hasNoPhysicalLinkMessage:wordings.noPhysicalLinkOfSelectedPortChannel})};var wordings=portChannel.consts.wordings;var common=portChannel.common}();!function(netBrain){var portChannel=NetBrain.MapImprovements.PortChannel;portChannel.showAllPhysicalPorts=function(actionObj){var diagram=actionObj.mapOperator.getNetMap().getGoJsDiagram(diagram);var portChannelLinks=function(diagram){var allLinks=common.iteratorToArray(diagram.links);return _.filter(allLinks,common.isPortChannel)}(diagram);if(portChannelLinks.length<1)return;return common.replaceLogicalToPhysical({transKey:"showAllPhysicalPorts",mapOperator:actionObj.mapOperator,portChannelLinks:portChannelLinks,hasNoPhysicalLinkMessage:wordings.noPhysicalLinkOfAllThePortChannels,somePortChannelToPhysicalFailed:wordings.somePortChannelToPhysicalFailed})};var wordings=portChannel.consts.wordings;var common=portChannel.common}();!function(netBrain){var mapImprovements=NetBrain.MapImprovements;var portChannel=mapImprovements.PortChannel;var common=portChannel.common;mapImprovements.PortChannelHelper={partIsOnlySelectedLink:function(part,selectedLinks){return part&&part instanceof go.Link&&1===selectedLinks.length},isPortChannel:common.isPortChannel,isPhysicalOfPortChannel:common.isPhysicalOfPortChannel,getCurrentPart:function(options){return options&&options.event&&options.event.subject&&options.event.subject.part},showPortChannel:portChannel.showPortChannel,showAllPortChannels:portChannel.showAllPortChannels,showPhysicalPorts:portChannel.showPhysicalPorts,showAllPhysicalPorts:portChannel.showAllPhysicalPorts}}();NetBrain.ns("MapImprovements.l2TopoLinkMode");NetBrain.MapImprovements.l2TopoLinkMode.consts={l2Topology_mapLegend:{portChannelInfo:{lineType:0,legendName:"P-Channel Link",color:"#0000FF",width:2,unchangeable:!0},trunkInfo:{lineType:0,legendName:"Trunk Link",color:"#FF0000",width:2,unchangeable:!0},vpcPeerInfo:{lineType:0,legendName:"VPC Peer-Link",color:"#808000",width:2,unchangeable:!0},vpcInfo:{lineType:0,legendName:"VPC Link",color:"#FFB86F",width:2,unchangeable:!0},fabricpathInfo:{lineType:0,legendName:"Fabricpath Link",color:"#18B052",width:2,unchangeable:!0}},L2TopoLinkMode:{Trunk:"trunk",Fabricpath:"fabricpath",VPC:"vPC",VPCPeer:"vPCPeer",PortChannel:"portChannel"}};!function(netBrain){var constSwitchMode=netBrain.MapImprovements.l2TopoLinkMode.consts.L2TopoLinkMode;function createL2TopoLinkByIntVpc(linkLine){var switchMode;if(!linkLine)return switchMode;var srcIntfVpc=linkLine.getSrcIntfVpc();var destIntfVpc=linkLine.getDestIntfVpc();if("peer-link"===srcIntfVpc||"peer-link"===destIntfVpc)return switchMode;var mediaInfo=linkLine.getMediaInfo();mediaInfo&&"vPC"==mediaInfo.mediaType&&(switchMode=constSwitchMode.VPC);return switchMode}netBrain.MapImprovements=netBrain.MapImprovements||{};netBrain.MapImprovements.l2TopoLinkMode.createL2TopoLinkMode=function(linkLine){var switchMode;if(!linkLine)return switchMode;if(linkLine.getTopoType()!==netBrain.Map.Const.TopoLinkType.L2Topology)return switchMode;if(linkLine.getIsPortChannel()){switchMode=constSwitchMode.PortChannel;switchMode=createL2TopoLinkByIntVpc(linkLine)||switchMode;switchMode=function(linkLine){var switchMode;if(!linkLine)return switchMode;var srcIntfVpc=linkLine.getSrcIntfVpc();var destIntfVpc=linkLine.getDestIntfVpc();"peer-link"!==srcIntfVpc&&"peer-link"!==destIntfVpc||(switchMode=constSwitchMode.VPCPeer);return switchMode}(linkLine)||switchMode}else{switchMode=function(linkLine){var switchMode;if(!linkLine)return switchMode;var modeList=["trunk","fabricpath"];var srvIntfSwitchMode=linkLine.getSrcIntfSMode();var destIntfSwitchMode=linkLine.getDestIntfMode();var indexSrvIntfSwitchMode=_.indexOf(modeList,srvIntfSwitchMode);var indexDestIntfSwitchMode=_.indexOf(modeList,destIntfSwitchMode);switchMode=indexSrvIntfSwitchMode>indexDestIntfSwitchMode?srvIntfSwitchMode:destIntfSwitchMode;return switchMode}(linkLine);switchMode=createL2TopoLinkByIntVpc(linkLine)||switchMode}linkLine.setL2TopoLinkMode(switchMode);return switchMode}}(NetBrain);!function(netBrain){var CallOutCustomizeLink=function(){go.Link.call(this)};go.Diagram.inherit(CallOutCustomizeLink,go.Link);CallOutCustomizeLink.prototype.makeGeometry=function(){var numpts=this.pointsCount;var p0=this.getPoint(0);var p1=this.getPoint(numpts-1);var angle=p1.directionPoint(p0);var pStart1=new go.Point(10,0);var pStart2=new go.Point(10,0);pStart1.rotate(angle+90);pStart2.rotate(angle+270);pStart1.add(p0);pStart2.add(p0);var fig=new go.PathFigure(pStart1.x,pStart1.y,!0);var seg1=new go.PathSegment(go.PathSegment.Line,p1.x,p1.y);fig.segments.add(seg1);fig.segments.add(new go.PathSegment(go.PathSegment.Line,pStart2.x,pStart2.y));var seg2=new go.PathSegment(go.PathSegment.Line,pStart1.x,pStart1.y).close();fig.segments.add(seg2);var geo=new go.Geometry;geo.figures.add(fig);return geo};CallOutCustomizeLink.prototype.getVisioInfo=function(){var visioTools=netBrain.Map.visioTools;var lineInfo=visioTools.getShapeVisioInfo(this,netBrain.Map.DrawShapeCommonAttr.ObjName);visioTools.push(lineInfo);return visioTools.buildLinkVisioInfo([],this.data,this)};netBrain.Map=netBrain.Map||{};netBrain.Map.CallOutCustomizeLink=CallOutCustomizeLink}(NetBrain);!function(netBrain){var GeometryReshapingTool=function(){go.Tool.call(this);this.name="GeometryReshaping";var h=new go.Shape;h.figure="Diamond";h.desiredSize=new go.Size(10,10);h.fill="lightblue";h.stroke="dodgerblue";h.cursor="move";this._handleArchetype=h;this._reshapeObjectName="SHAPE";this._handle=null;this._adornedShape=null;this._originalGeometry=null};go.Diagram.inherit(GeometryReshapingTool,go.Tool);Object.defineProperty(GeometryReshapingTool.prototype,"handleArchetype",{get:function(){return this._handleArchetype},set:function(val){this._handleArchetype=val}});Object.defineProperty(GeometryReshapingTool.prototype,"reshapeObjectName",{get:function(){return this._reshapeObjectName},set:function(val){this._reshapeObjectName=val}});Object.defineProperty(GeometryReshapingTool.prototype,"handle",{get:function(){return this._handle}});Object.defineProperty(GeometryReshapingTool.prototype,"adornedShape",{get:function(){return this._adornedShape}});Object.defineProperty(GeometryReshapingTool.prototype,"originalGeometry",{get:function(){return this._originalGeometry}});GeometryReshapingTool.prototype.updateAdornments=function(part){if(!(null===part||part instanceof go.Link)){if(part.isSelected&&!this.diagram.isReadOnly){var selelt=part.findObject(this.reshapeObjectName);if(selelt instanceof go.Shape&&selelt.actualBounds.isReal()&&selelt.isVisibleObject()&&part.canReshape()&&part.actualBounds.isReal()&&part.isVisible()&&selelt.geometry.type===go.Geometry.Path){var adornment=part.findAdornment(this.name);null===adornment&&(adornment=this.makeAdornment(selelt));if(null!==adornment){var geo=selelt.geometry;var b=geo.bounds;adornment.findObject("BODY").desiredSize=b.size;adornment.elements.each((function(h){if(void 0!==h._typ){var fig=geo.figures.elt(h._fig);var seg=fig.segments.elt(h._seg);var x=0;var y=0;switch(h._typ){case 0:x=fig.startX;y=fig.startY;break;case 1:x=seg.endX;y=seg.endY;break;case 2:x=seg.point1X;y=seg.point1Y;break;case 3:x=seg.point2X;y=seg.point2Y}h.alignment=new go.Spot(Math.max(0,Math.min((x-b.x)/b.width,1)),Math.max(0,Math.min((y-b.y)/b.height,1)))}}));part.addAdornment(this.name,adornment);adornment.location=selelt.getDocumentPoint(go.Spot.Center);adornment.angle=selelt.getDocumentAngle();return}}}part.removeAdornment(this.name)}};GeometryReshapingTool.prototype.makeAdornment=function(selelt){var adornment=new go.Adornment;adornment.type=go.Panel.Spot;adornment.locationObjectName="BODY";adornment.locationSpot=go.Spot.Center;var h1=new go.Shape;h1.name="BODY";h1.fill=null;h1.stroke=null;h1.strokeWidth=0;adornment.add(h1);var geo=selelt.geometry;for(var f=0;f<geo.figures.count;f++){var fig=geo.figures.elt(f);for(var g=0;g<fig.segments.count;g++){var seg=fig.segments.elt(g);var h;if(0===g&&null!==(h=this.makeHandle(selelt,fig,seg))){h._typ=0;h._fig=f;h._seg=g;adornment.add(h)}if(null!==(h=this.makeHandle(selelt,fig,seg))){h._typ=1;h._fig=f;h._seg=g;adornment.add(h)}if(seg.type===go.PathSegment.QuadraticBezier||seg.type===go.PathSegment.Bezier){if(null!==(h=this.makeHandle(selelt,fig,seg))){h._typ=2;h._fig=f;h._seg=g;adornment.add(h)}if(seg.type===go.PathSegment.Bezier&&null!==(h=this.makeHandle(selelt,fig,seg))){h._typ=3;h._fig=f;h._seg=g;adornment.add(h)}}}}adornment.category=this.name;adornment.adornedObject=selelt;return adornment};GeometryReshapingTool.prototype.makeHandle=function(){var h=this.handleArchetype;return null===h?null:h.copy()};GeometryReshapingTool.prototype.canStart=function(){if(!this.isEnabled)return!1;var diagram=this.diagram;return null!==diagram&&!diagram.isReadOnly&&(!!diagram.allowReshape&&(!!diagram.lastInput.left&&null!==this.findToolHandleAt(diagram.firstInput.documentPoint,this.name)))};GeometryReshapingTool.prototype.doActivate=function(){var diagram=this.diagram;if(null!==diagram){this._handle=this.findToolHandleAt(diagram.firstInput.documentPoint,this.name);if(null!==this._handle){var shape=this._handle.part.adornedObject;if(shape){this._adornedShape=shape;diagram.isMouseCaptured=!0;this.startTransaction(this.name);this._originalGeometry=shape.geometry;this.isActive=!0}}}};GeometryReshapingTool.prototype.doDeactivate=function(){this.stopTransaction();this._handle=null;this._adornedShape=null;var diagram=this.diagram;null!==diagram&&(diagram.isMouseCaptured=!1);this.isActive=!1};GeometryReshapingTool.prototype.doCancel=function(){var shape=this._adornedShape;null!==shape&&(shape.geometry=this._originalGeometry);this.stopTool()};GeometryReshapingTool.prototype.doMouseMove=function(){var diagram=this.diagram;if(this.isActive&&null!==diagram){var newpt=this.computeReshape(diagram.lastInput.documentPoint);this.reshape(newpt)}};GeometryReshapingTool.prototype.doMouseUp=function(){var diagram=this.diagram;if(this.isActive&&null!==diagram){var newpt=this.computeReshape(diagram.lastInput.documentPoint);this.reshape(newpt);this.transactionResult=this.name}this.stopTool()};GeometryReshapingTool.prototype.reshape=function(newPoint){var shape=this.adornedShape;var locpt=shape.getLocalPoint(newPoint);var geo=shape.geometry.copy();var type=this.handle._typ;if(void 0!==type){var alignmentPointOld=null;var elt;if(0===type){elt=geo.figures.elt(0).segments.elt(0);alignmentPointOld=new go.Point(elt.endX,elt.endY)}else{elt=geo.figures.elt(0);alignmentPointOld=new go.Point(elt.startX,elt.startY)}alignmentPointOld=shape.getDocumentPoint(new go.Spot(0,0,alignmentPointOld.x,alignmentPointOld.y));var fig=geo.figures.elt(this.handle._fig);var seg=fig.segments.elt(this.handle._seg);switch(type){case 0:fig.startX=locpt.x;fig.startY=locpt.y;break;case 1:seg.endX=locpt.x;seg.endY=locpt.y;break;case 2:seg.point1X=locpt.x;seg.point1Y=locpt.y;break;case 3:seg.point2X=locpt.x;seg.point2Y=locpt.y}geo.normalize();shape.geometry=geo;shape.part.ensureBounds();var alignmentPointNew=null;if(0===type){elt=geo.figures.elt(0).segments.elt(0);alignmentPointNew=new go.Point(elt.endX,elt.endY)}else{elt=geo.figures.elt(0);alignmentPointNew=new go.Point(elt.startX,elt.startY)}alignmentPointNew=shape.getDocumentPoint(new go.Spot(0,0,alignmentPointNew.x,alignmentPointNew.y));var tmpPosition=shape.part.position.copy();tmpPosition.x-=alignmentPointNew.x-alignmentPointOld.x;tmpPosition.y-=alignmentPointNew.y-alignmentPointOld.y;shape.part.position=tmpPosition;this.updateAdornments(shape.part)}};GeometryReshapingTool.prototype.computeReshape=function(p){return p};netBrain.Map=netBrain.Map||{};netBrain.Map.GeometryReshapingTool=GeometryReshapingTool}(NetBrain);!function(netBrain){var TopoCustomizeLink=function(){go.Link.call(this)};go.Diagram.inherit(TopoCustomizeLink,go.Link);TopoCustomizeLink.prototype.isApprox=function(x,y){var d=x-y;return d<.5&&d>-.5};TopoCustomizeLink.prototype.computeSpacing=function(){if(!this.isVisible())return 0;var baseSpace=go.Link.prototype.computeSpacing.call(this);if(1===this.diagram.scale&&NetBrain.Map.currentActiveMapPage){var space=NetBrain.Map.currentActiveMapPage.getNetMapJsWrapper().pageData.modelData.space||1;if(space>1)return baseSpace*space}return baseSpace};TopoCustomizeLink.prototype.rescalePoints=function(startIndex,newFromPoint,endIndex,newToPoint){var oldFromPt=this.getPoint(startIndex);var oldToPt=this.getPoint(endIndex);if(oldFromPt.equals(newFromPoint)&&oldToPt.equals(newToPoint))return!0;var Ax=oldFromPt.x;var Ay=oldFromPt.y;var Dx=oldToPt.x-Ax;var Dy=oldToPt.y-Ay;var oldDist=Math.sqrt(Dx*Dx+Dy*Dy);if(this.isApprox(oldDist,0))return!0;var oldAngle;if(this.isApprox(Dx,0))oldAngle=Dy<0?-Math.PI/2:Math.PI/2;else{oldAngle=Math.atan(Dy/Math.abs(Dx));Dx<0&&(oldAngle=Math.PI-oldAngle)}var A2x=newFromPoint.x;var A2y=newFromPoint.y;var D2x=newToPoint.x-A2x;var D2y=newToPoint.y-A2y;var newDist=Math.sqrt(D2x*D2x+D2y*D2y);var newAngle;if(this.isApprox(D2x,0))newAngle=D2y<0?-Math.PI/2:Math.PI/2;else{newAngle=Math.atan(D2y/Math.abs(D2x));D2x<0&&(newAngle=Math.PI-newAngle)}var DistRatio=newDist/oldDist;var AngleDiff=newAngle-oldAngle;this.setPoint(startIndex,newFromPoint);for(var i=startIndex+1;i<endIndex;i++){var p=this.getPoint(i);Dx=p.x-Ax;Dy=p.y-Ay;var pDist=Math.sqrt(Dx*Dx+Dy*Dy);if(!this.isApprox(pDist,0)){var pAngle;if(this.isApprox(Dx,0))pAngle=Dy<0?-Math.PI/2:Math.PI/2;else{pAngle=Math.atan(Dy/Math.abs(Dx));Dx<0&&(pAngle=Math.PI-pAngle)}var p2Angle=pAngle+AngleDiff;var p2Dist=pDist*DistRatio;var P2x=A2x+p2Dist*Math.cos(p2Angle);var P2y=A2y+p2Dist*Math.sin(p2Angle);this.setPointAt(i,P2x,P2y)}}this.setPoint(endIndex,newToPoint);return!0};TopoCustomizeLink.prototype.computePoints=function(){if(null!=this.data&&netBrain.Map.CategoryMgr.isNormalLink(this.data.getCategory()))return this.computeNormalPoints();if(null!=this.curve&&"Bezier"!==this.curve.name)return go.Link.prototype.computePoints.call(this);if(null===this.diagram)return!1;if(!(this.fromNode&&this.fromPort&&this.toNode&&this.toPort))return go.Link.prototype.computePoints.call(this);var fromPoint,toPoint,midPoint,adjustFrom,adjustTo;if(this.points.size>0){if(this.fromPort.fromSpot.isSpot())fromPoint=this.fromPort.getDocumentPoint(this.fromPort.fromSpot);else{fromPoint=this.fromPort.getDocumentPoint(go.Spot.Center);adjustFrom=!0}if(this.toPort.toSpot.isSpot())toPoint=this.toPort.getDocumentPoint(this.toPort.toSpot);else{toPoint=this.toPort.getDocumentPoint(go.Spot.Center);adjustTo=!0}this.rescalePoints(0,fromPoint,this.points.size-1,toPoint);midPoint=this.getPoint(1);adjustFrom&&(fromPoint=this.getLinkPointFromPoint(this.fromNode,this.fromPort,fromPoint,midPoint,!0));adjustTo&&(toPoint=this.getLinkPointFromPoint(this.toNode,this.toPort,toPoint,midPoint,!1));this.rescalePoints(0,fromPoint,this.points.size-1,toPoint)}else{this.clearPoints();if(this.fromPort.fromSpot.isSpot())fromPoint=this.fromPort.getDocumentPoint(this.fromPort.fromSpot);else{fromPoint=this.fromPort.getDocumentPoint(go.Spot.Center);adjustFrom=!0}if(this.toPort.toSpot.isSpot())toPoint=this.toPort.getDocumentPoint(this.toPort.toSpot);else{toPoint=this.toPort.getDocumentPoint(go.Spot.Center);adjustTo=!0}var nMiddleDistance=100;var linkedCount=function(a,b){var aLinks=a.linksConnected;var bLinks=b.linksConnected;var aCount=aLinks.count;var bCount=bLinks.count;var result=0;(aCount>bCount?bLinks:aLinks).each((function(link){(link.fromNode===a&&link.toNode===b||link.fromNode===b&&link.toNode===a)&&result++}));return result}(this.fromNode,this.toNode);var offsetDistance=15*Math.floor(linkedCount/2);var factor=linkedCount%2==1?-1:1;var nPtDistance=MathFunc.getDistance(fromPoint,toPoint);nPtDistance<nMiddleDistance&&(nMiddleDistance=nPtDistance);nMiddleDistance=factor*(nMiddleDistance+offsetDistance);midPoint=MathFunc.getMiddleVerticalPoint(fromPoint,toPoint,nMiddleDistance);adjustFrom&&(fromPoint=this.getLinkPointFromPoint(this.fromNode,this.fromPort,fromPoint,midPoint,!0));adjustTo&&(toPoint=this.getLinkPointFromPoint(this.toNode,this.toPort,toPoint,midPoint,!1));this.addPoint(fromPoint);this.addPoint(midPoint);this.addPoint(toPoint)}return!0};TopoCustomizeLink.prototype.computeNormalPoints=function(){if(null===this.diagram)return!1;var fromnode=this.fromNode;if(null===fromnode||null==fromnode.diagram)return!1;var fromport=fromnode.findPort(this.fromPortId);if(null===fromport)return!1;if(!fromnode.location.isReal())return!1;var tonode=this.toNode;if(null===tonode||null==tonode.diagram)return!1;var toport=tonode.findPort(this.toPortId);if(null===toport)return!1;if(!tonode.location.isReal())return!1;this.clearPoints();var frompt=this.getLinkPoint(fromnode,fromport,go.Spot.None,!0,!1,tonode,toport);var topt=this.getLinkPoint(tonode,toport,go.Spot.None,!1,!1,fromnode,fromport);this.addPoint(frompt);this.addPoint(topt);return!0};TopoCustomizeLink.prototype.hasCurviness=function(){var flag=go.Link.prototype.hasCurviness.apply(this);if(flag){var fromNode=this.fromNode;var toNode=this.toNode;if(fromNode&&toNode){var topolinkCount=0;fromNode.linksConnected.each((function(l){(l.fromNode===fromNode&&l.toNode===toNode||l.fromNode===toNode&&l.toNode===fromNode)&&netBrain.Map.CategoryMgr.isTopolink(l.data.category)&&topolinkCount++}));flag=topolinkCount>1}}return flag};TopoCustomizeLink.prototype.getPosListVisioInfos=function(){var infos=[];var link=this;var indexArr=_.range(9);var CCompLabel=netBrain.Map.CCompLabel;var visioTools=netBrain.Map.visioTools;_.each(["intfSrc","intfDest"],(function(prefix,i){var isFrom=i%2==0;_.each(indexArr,(function(index){var name=prefix+"_"+index;var obj=link.findObject(name);obj&&obj.visible&&obj.elements.each((function(item){var linkPosTextPanel=item.findObject(CCompLabel.linkPosTextPanel);if(linkPosTextPanel&&linkPosTextPanel.opacity>0){var labelInfos=CCompLabel.getLinkLabelVisioInfos(item);visioTools.addDirection(labelInfos,isFrom);infos=infos.concat(labelInfos)}}))}))}));return infos};TopoCustomizeLink.prototype.getHighlightVisioInfos=function(){var infos=[];var link=this;var visioTools=netBrain.Map.visioTools;var shapeName=netBrain.Map.CompTopolink.highlightShapeName;_.each(["HIGHLIGHT_SRC","HIGHLIGHT_DEST"],(function(hgName,i){var isFrom=i%2==0;link.findObject(hgName).elements.each((function(item){var shapeObj=item.findObject(shapeName);var shapeInfo=visioTools.getShapeInfo(shapeObj);visioTools.addDirection(shapeInfo,isFrom);visioTools.addLayerName(shapeInfo,2);infos.push(shapeInfo)}))}));return infos};TopoCustomizeLink.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var CompTopolink=netBrain.Map.CompTopolink;var labelAngleSrc=this.findObject(CompTopolink.srcLinkIntfInfoLabel).getDocumentAngle();if(this.findObject(CompTopolink.srcInftNameLabelPanel).opacity>0){var intfNameSrcInfo=visioTools.getTextVisioInfo(this,CompTopolink.srcLinkIntfInfoLabel);if(intfNameSrcInfo){intfNameSrcInfo.angle=labelAngleSrc;intfNameSrcInfo.connectId=this.data.from+this.data.fromPort;visioTools.addDirection(intfNameSrcInfo,!0);visioInfos.push(intfNameSrcInfo)}}var labelAngleDest=this.findObject(CompTopolink.destLinkIntfInfoLabel).getDocumentAngle();if(this.findObject(CompTopolink.destInftNameLabelPanel).opacity>0){var intfNameDestInfo=visioTools.getTextVisioInfo(this,CompTopolink.destLinkIntfInfoLabel);if(intfNameDestInfo){intfNameDestInfo.angle=labelAngleDest;intfNameDestInfo.connectId=this.data.to+this.data.toPort;visioTools.addDirection(intfNameDestInfo,!1);visioInfos.push(intfNameDestInfo)}}var posListInfos=this.getPosListVisioInfos();_.each(posListInfos,(function(posInfo){posInfo.angle=posInfo.isFrom?labelAngleSrc:labelAngleDest}));visioInfos=visioInfos.concat(posListInfos);var baseLineShapeInfoSrc=visioTools.getShapeVisioInfo(this,CompTopolink.BaseLineShapeForShowSrc);visioTools.addDirection(baseLineShapeInfoSrc,!0);visioTools.addLayerName(baseLineShapeInfoSrc,1);visioInfos.push(baseLineShapeInfoSrc);var baseLineShapeInfoDest=visioTools.getShapeVisioInfo(this,CompTopolink.BaseLineShapeForShowDest);visioTools.addDirection(baseLineShapeInfoDest,!1);visioTools.addLayerName(baseLineShapeInfoDest,1);visioInfos.push(baseLineShapeInfoDest);var highlightInfos=this.getHighlightVisioInfos();visioInfos=visioInfos.concat(highlightInfos);var mSrcInfos=visioTools.getShapeVisioInfo(this,CompTopolink.srcLinkGraphicShape);visioTools.addDirection(mSrcInfos,!0);visioTools.addLayerName(mSrcInfos,3);mSrcInfos&&visioInfos.push(mSrcInfos);var mDestInfos=visioTools.getShapeVisioInfo(this,CompTopolink.destLinkGraphicShape);visioTools.addDirection(mDestInfos,!1);visioTools.addLayerName(mDestInfos,3);mDestInfos&&visioInfos.push(mDestInfos);var alarmPanels=[];for(var i=0;i<=8;++i){alarmPanels.push(this.findObject("intfSrc_"+i));alarmPanels.push(this.findObject("intfDest_"+i))}alarmPanels.forEach((function(alarmPanel){alarmPanel&&alarmPanel.visible&&alarmPanel.elements.each((function(tmp){var itemObj=tmp.findObject(CompTopolink.alarmLabel);var itemInfo=netBrain.Map.visioTools.getShapeInfo(itemObj);"undefined"!==itemInfo.type&&visioInfos.push(itemInfo)}))}));return visioTools.buildLinkVisioInfo(visioInfos,this.data,this)};netBrain.Map=netBrain.Map||{};netBrain.Map.TopoCustomizeLink=TopoCustomizeLink}(NetBrain);!function(netBrain){var L2CustomizeLink=function(){go.Link.call(this)};go.Diagram.inherit(L2CustomizeLink,go.Link);L2CustomizeLink.prototype.findSidePortIndexAndCount=function(node,port){var nodedata=node.data;var portdata=port.data;var arr=nodedata[port._side+"Array"];var len=arr.length;for(var i=0;i<len;i++)if(arr[i]===portdata)return[i,len];return[-1,len]};L2CustomizeLink.prototype.computeEndSegmentLength=function(node,port,spot,from){var esl;if(node.category===netBrain.Map.CategoryMgr.NetworkDevice)return esl=go.Link.prototype.computeEndSegmentLength.call(this,node,port,spot,from);if(node.category===netBrain.Map.CategoryMgr.L2Device){esl=go.Link.prototype.computeEndSegmentLength.call(this,node,port,spot,from);var thispt=port.getDocumentPoint(this.computeSpot(from));var otherpt=this.getOtherPort(port).getDocumentPoint(this.computeSpot(!from));if(Math.abs(thispt.x-otherpt.x)>20||Math.abs(thispt.y-otherpt.y)>20){var info=this.findSidePortIndexAndCount(node,port);var idx=info[0];var count=info[1];return"top"===port._side||"bottom"===port._side?otherpt.x<thispt.x?esl+4+8*idx:esl+8*(count-idx-1):otherpt.y<thispt.y?esl+4+8*idx:esl+8*(count-idx-1)}return esl}return null};L2CustomizeLink.prototype.hasCurviness=function(){return!!isNaN(this.curviness)||go.Link.prototype.hasCurviness.call(this)};L2CustomizeLink.prototype.computeCurviness=function(){if(isNaN(this.curviness)){var fromnode=this.fromNode;var fromport=this.fromPort;var fromspot=this.computeSpot(!0);var frompt=fromport.getDocumentPoint(fromspot);var tonode=this.toNode;var toport=this.toPort;var tospot=this.computeSpot(!1);var topt=toport.getDocumentPoint(tospot);if((Math.abs(frompt.x-topt.x)>20||Math.abs(frompt.y-topt.y)>20)&&((fromspot.equals(go.Spot.Left)||fromspot.equals(go.Spot.Right))&&(tospot.equals(go.Spot.Left)||tospot.equals(go.Spot.Right))||(fromspot.equals(go.Spot.Top)||fromspot.equals(go.Spot.Bottom))&&(tospot.equals(go.Spot.Top)||tospot.equals(go.Spot.Bottom)))){var fromseglen=this.computeEndSegmentLength(fromnode,fromport,fromspot,!0);var toseglen=this.computeEndSegmentLength(tonode,toport,tospot,!1);var c=(fromseglen-toseglen)/2;if(frompt.x+fromseglen>=topt.x-toseglen){if(frompt.y<topt.y)return c;if(frompt.y>topt.y)return-c}}}return go.Link.prototype.computeCurviness.call(this)};netBrain.Map=netBrain.Map||{};netBrain.Map.L2CustomizeLink=L2CustomizeLink}(NetBrain);!function(netBrain){var ForceDirectedLayoutEx=function(){go.ForceDirectedLayout.call(this);this._maxIter=100;this._epsilon=1;this._infinity=1e3;this._arrangementSpacing=new go.Size(100,100);this._charge=150;this._mass=0;this._stiffness=.05;this._length=50};go.Diagram.inherit(ForceDirectedLayoutEx,go.ForceDirectedLayout);ForceDirectedLayoutEx.prototype.makeNetwork=function(coll){return go.ForceDirectedLayout.prototype.makeNetwork.call(this,coll)};ForceDirectedLayoutEx.prototype.startLayout=function(goDiagram){if(null!=goDiagram){goDiagram.startTransaction("changed Layout");var customLayout=goDiagram.layout;customLayout.isOngoing=!0;customLayout.maxIterations=this._maxIter;customLayout.epsilonDistance=this._epsilon;customLayout.infinityDistance=this._infinity;customLayout.arrangementSpacing=this._arrangementSpacing;customLayout.defaultElectricalCharge=this._charge;customLayout.defaultGravitationalMass=this._mass;customLayout.defaultSpringStiffness=this._stiffness;null!=goDiagram.commandHandler&&null!=goDiagram.commandHandler.space?customLayout.defaultSpringLength=this._length*goDiagram.commandHandler.space:customLayout.defaultSpringLength=this._length;goDiagram.commitTransaction("changed Layout")}};var ForceDirectedLayoutExUnLocate=function(zoom){ForceDirectedLayoutEx.call(this,zoom)};go.Diagram.inherit(ForceDirectedLayoutExUnLocate,ForceDirectedLayoutEx);ForceDirectedLayoutExUnLocate.prototype.makeNetwork=function(coll){var net=go.ForceDirectedLayout.prototype.makeNetwork.call(this,coll);net.vertexes.each((function(vertex){var node=vertex.node;null!==node&&(vertex.isFixed=node.location&&node.location.isReal())}));return net};netBrain.Map=netBrain.Map||{};netBrain.Map.ForceDirectedLayoutEx=ForceDirectedLayoutEx;netBrain.Map.ForceDirectedLayoutExUnLocate=ForceDirectedLayoutExUnLocate}(NetBrain);!function(netBrain){var CustomizedCommandHandler=function(){go.CommandHandler.call(this);this._space=1;this._spaceCenter=new go.Point(0,0);this.oldSpaceCenter=new go.Point(0,0);this.centerOffset=new go.Size(0,0);this._isUpdating=!1;this.cusZoomFactor=.1;this.bZoomByBar=!1;this._fixOldX=0;this._fixOldY=0;this._fixX=0;this._fixY=0;this._defaultOffsetX=20;this._defaultOffsetY=20;this._altOffsetX=1;this._altOffsetY=1};go.Diagram.inherit(CustomizedCommandHandler,go.CommandHandler);CustomizedCommandHandler.prototype.zoomCallBack=function(dZoomValue){};CustomizedCommandHandler.prototype.updateAllLocations=function(){if(null!==this.diagram){this._isUpdating=!0;this.diagram.startTransaction("respace nodes");this.diagram.nodes.each((function(n){n.updateTargetBindings("location")}));this.diagram.links.each((function(n){n.category===netBrain.Map.CompLine.getVarCategory()&&n.updateTargetBindings("points")}));this.diagram.computeBounds();this.diagram.commitTransaction("respace nodes");this._isUpdating=!1}};Object.defineProperty(CustomizedCommandHandler.prototype,"space",{get:function(){return this._space},set:function(val){val>5&&(val=5);val<.1&&(val=.1);if((val=Math.round(100*val)/100)!==this._space){this._space;this._space=val;var diagram=this.diagram;null!==diagram&&diagram.model.setDataProperty(diagram.model.modelData,"space",val);this.updateAllLocations()}}});Object.defineProperty(CustomizedCommandHandler.prototype,"fixX",{get:function(){return this._fixX}});Object.defineProperty(CustomizedCommandHandler.prototype,"fixY",{get:function(){return this._fixY}});Object.defineProperty(CustomizedCommandHandler.prototype,"spaceCenter",{get:function(){return this._spaceCenter},set:function(val){this._spaceCenter=val;this.centerOffset.x=this.oldSpaceCenter.x-val.x;this.centerOffset.y=this.oldSpaceCenter.y-val.y;this.oldSpaceCenter=val}});CustomizedCommandHandler.prototype.isZoomGraphicObj=function(nodeData){return null!=nodeData&&null!=nodeData.category&&(nodeData.category===netBrain.Map.CategoryMgr.Rect||nodeData.category===netBrain.Map.CategoryMgr.Ellipse||nodeData.category===netBrain.Map.CategoryMgr.CloseArea||nodeData.category===netBrain.Map.CategoryMgr.Polygon||nodeData.category===netBrain.Map.CategoryMgr.CloseCloud||nodeData.category===netBrain.Map.CategoryMgr.Text)};CustomizedCommandHandler.prototype.changeZoomGraphicObj=function(newZoomVale,oldZoomVale){if(null!=newZoomVale){var deltaZoomValue=newZoomVale-oldZoomVale;if(!(Math.abs(deltaZoomValue)<=.1)){var context=this;this.diagram.nodes.each((function(node){if(null!=node&&context.isZoomGraphicObj(node.data)){var shapeObj=node.findObject(netBrain.Map.DrawShapeCommonAttr.ObjName);var bounds=shapeObj.geometry.bounds;if(null!=shapeObj){shapeObj.width=bounds.width+bounds.width*deltaZoomValue;shapeObj.height=bounds.height+bounds.height*deltaZoomValue}}}))}}};CustomizedCommandHandler.prototype.setZoomByBar=function(bZoomByBar){this.bZoomByBar=bZoomByBar};CustomizedCommandHandler.prototype.isZoomByBar=function(){return this.bZoomByBar};CustomizedCommandHandler.prototype.setSpaceCenter=function(){if(this.isZoomByBar()){if(null==this.diagram||null==this.diagram.div)return;this.spaceCenter=this.diagram.viewportBounds.center.copy()}else{var lastPoint=this.diagram.lastInput.documentPoint.copy();this.spaceCenter=lastPoint}};CustomizedCommandHandler.prototype.isMouseInZoomBar=function(){var wx=window.event.clientX;var wy=window.event.clientY;var zoomBarEle=document.getElementById("zoomBarRangeId");if(null==zoomBarEle)return!1;var rectZoomBar=zoomBarEle.getBoundingClientRect();return!(wx<rectZoomBar.left||wy<rectZoomBar.top||wx>rectZoomBar.left+rectZoomBar.width||wy>rectZoomBar.top+rectZoomBar.height)};CustomizedCommandHandler.prototype.setSpace=function(s){this.space=Math.max(.1,Math.min(5,s))};CustomizedCommandHandler.prototype.checkSpace=function(s){return.01<=s&&s<=20};CustomizedCommandHandler.prototype.canDecreaseZoom=function(factor){void 0===factor&&(factor=1/this.zoomFactor);return this.checkSpace(this.space*factor)};CustomizedCommandHandler.prototype.setCusZoomSetp=function(zoomStep){this.cusZoomFactor=zoomStep};CustomizedCommandHandler.prototype.getCusZoomSetp=function(){return this.cusZoomFactor};CustomizedCommandHandler.prototype.increaseZoom=function(factor){this.diagram.startTransaction("increaseZoom setSpace");netBrain.Map.zoomLinkHandler(this,(function(){this.setZoomByBar(!1);if(null!==this.diagram&&this.diagram.autoScale===go.Diagram.None){var newscale=this.space+this.cusZoomFactor;if(!(newscale<this.diagram.minScale||newscale>this.diagram.maxScale)){null!=this.diagram.lastInput.documentPoint?this._zoomFocus=this.diagram.lastInput.documentPoint.copy():this._zoomFocus=new go.Point(0,0);if(newscale>=1)this.diagram.model.setDataProperty(this.diagram,"scale",1);else{newscale<1e-5&&(newscale=.1);this.diagram.model.setDataProperty(this.diagram,"scale",newscale)}_.isFunction(this.beforeZoomApply)&&this.beforeZoomApply(newscale);this.space=newscale;this.zoomCallBack(newscale)}}}));this.diagram.commitTransaction("increaseZoom setSpace")};CustomizedCommandHandler.prototype.decreaseZoom=function(factor){this.diagram.startTransaction("decreaseZoom setSpace");netBrain.Map.zoomLinkHandler(this,(function(){this.setZoomByBar(!1);if(null!==this.diagram&&this.diagram.autoScale===go.Diagram.None){var newscale=this.space-this.cusZoomFactor;null!=this.diagram.lastInput.documentPoint?this._zoomFocus=this.diagram.lastInput.documentPoint.copy():this._zoomFocus=new go.Point(0,0);if(newscale>=1)this.diagram.model.setDataProperty(this.diagram,"scale",1);else{newscale<1e-4&&(newscale=.1);this.diagram.model.setDataProperty(this.diagram,"scale",newscale)}_.isFunction(this.beforeZoomApply)&&this.beforeZoomApply(newscale);this.space=newscale;this.zoomCallBack(newscale)}}));this.diagram.commitTransaction("decreaseZoom setSpace")};CustomizedCommandHandler.prototype.zoomToFitScreen=function(){var diagram=this.diagram;if(diagram){diagram.startTransaction("zoomToFitScreen setSpace");netBrain.Map.zoomLinkHandler(this,(function(){diagram.zoomToFit();this.zoomCallBack(diagram.scale);this.setSpace(diagram.scale)}));diagram.commitTransaction("zoomToFitScreen setSpace")}};CustomizedCommandHandler.prototype.canIncreaseZoom=function(factor){void 0===factor&&(factor=1/this.zoomFactor);return this.checkSpace(this.space/factor)};CustomizedCommandHandler.prototype.initZoom=function(newspace){void 0!==newspace&&0!==newspace||(newspace=1);newspace>5&&(newspace=5);newspace<.1&&(newspace=.1);this.diagram.scale=newspace>=1?1:newspace;this._space=newspace;this.diagram.model.modelData.space=newspace};CustomizedCommandHandler.prototype.resetZoom=function(newspace){this.setZoomByBar(!0);void 0!==newspace&&0!==newspace||(newspace=1);this.diagram.startTransaction("resetZoom setSpace");netBrain.Map.zoomLinkHandler(this,(function(){null!=this.diagram.lastInput.documentPoint?this._zoomFocus=this.diagram.lastInput.documentPoint.copy():this._zoomFocus=new go.Point(0,0);if(newspace>=1)this.diagram.model.setDataProperty(this.diagram,"scale",1);else{newspace<1e-4&&(newspace=.1);this.diagram.model.setDataProperty(this.diagram,"scale",newspace)}this.zoomCallBack(newspace);this.setSpace(newspace)}));this.diagram.commitTransaction("resetZoom setSpace")};CustomizedCommandHandler.prototype.canResetZoom=function(newspace){return this.checkSpace(newspace)};CustomizedCommandHandler.prototype.alignLeft=function(){var firstSelectionNode=getFirstSelectionNode(this.diagram);if(firstSelectionNode){this.diagram.startTransaction("aligning left");var left=this.getAlignNodeBounds(firstSelectionNode).left;this.diagram.model;var _this=this;var alginNodes=[];this.diagram.selection.each((function(current){if(!(current instanceof go.Link)&&current!==firstSelectionNode){var currNodeBounds=_this.getAlignNodeBounds(current);updateNodeLocation(current,left+(current.location.x-currNodeBounds.left),current.location.y);alginNodes.push(current)}}));this.diagram.commitTransaction("aligning left");return alginNodes}};CustomizedCommandHandler.prototype.alignRight=function(){var firstSelectionNode=getFirstSelectionNode(this.diagram);if(firstSelectionNode){this.diagram.startTransaction("aligning right");var right=this.getAlignNodeBounds(firstSelectionNode).right;this.diagram.model;var _this=this;var alginNodes=[];this.diagram.selection.each((function(current){if(!(current instanceof go.Link)&&current!==firstSelectionNode){var currNodeBounds=_this.getAlignNodeBounds(current);updateNodeLocation(current,right-(currNodeBounds.right-current.location.x),current.location.y);alginNodes.push(current)}}));this.diagram.commitTransaction("aligning right");return alginNodes}};CustomizedCommandHandler.prototype.alignTop=function(){var firstSelectionNode=getFirstSelectionNode(this.diagram);if(firstSelectionNode){this.diagram.startTransaction("aligning top");var top=this.getAlignNodeBounds(firstSelectionNode).top;this.diagram.model;var _this=this;var alginNodes=[];this.diagram.selection.each((function(current){if(!(current instanceof go.Link)&&current!==firstSelectionNode){var currNodeBounds=_this.getAlignNodeBounds(current);var y=top+(current.location.y-currNodeBounds.top);updateNodeLocation(current,current.location.x,y);alginNodes.push(current)}}));this.diagram.commitTransaction("aligning top");return alginNodes}};CustomizedCommandHandler.prototype.alignBottom=function(){var firstSelectionNode=getFirstSelectionNode(this.diagram);if(firstSelectionNode){this.diagram.startTransaction("aligning bottom");var bottom=this.getAlignNodeBounds(firstSelectionNode).bottom;this.diagram.model;var _this=this;var alginNodes=[];this.diagram.selection.each((function(current){if(!(current instanceof go.Link)&&current!==firstSelectionNode){var currNodeBounds=_this.getAlignNodeBounds(current);var y=bottom-(currNodeBounds.bottom-current.location.y);updateNodeLocation(current,current.location.x,y);alginNodes.push(current)}}));this.diagram.commitTransaction("aligning bottom");return alginNodes}};CustomizedCommandHandler.prototype.alignCenterX=function(){var firstSelectionNode=getFirstSelectionNode(this.diagram);if(firstSelectionNode){this.diagram.startTransaction("aligning center x");var centerX=this.getAlignNodeBounds(firstSelectionNode).center.x;this.diagram.model;var _this=this;var alginNodes=[];this.diagram.selection.each((function(current){if(!(current instanceof go.Link)&&current!==firstSelectionNode){var currNodeBounds=_this.getAlignNodeBounds(current);updateNodeLocation(current,centerX+(current.location.x-currNodeBounds.center.x),current.location.y);alginNodes.push(current)}}));this.diagram.commitTransaction("aligning center x");return alginNodes}};CustomizedCommandHandler.prototype.alignCenterY=function(){var firstSelectionNode=getFirstSelectionNode(this.diagram);if(firstSelectionNode){this.diagram.startTransaction("aligning center y");var centerY=this.getAlignNodeBounds(firstSelectionNode).center.y;this.diagram.model;var _this=this;var alginNodes=[];this.diagram.selection.each((function(current){if(!(current instanceof go.Link)&&current!==firstSelectionNode){var currNodeBounds=_this.getAlignNodeBounds(current);var y=centerY+(current.location.y-currNodeBounds.center.y);updateNodeLocation(current,current.location.x,y);alginNodes.push(current)}}));this.diagram.commitTransaction("aligning center y");return alginNodes}};CustomizedCommandHandler.prototype.getAlignNodeBounds=function(node){return node.actualBounds};CustomizedCommandHandler.prototype.centerZoomPoint=function(){if(null!==this.diagram){var x=this.diagram.div.clientWidth/2;var y=this.diagram.div.clientHeight/2;var point=this.diagram.transformViewToDoc(new go.Point(x,y));this.diagram.lastInput.documentPoint=point.copy()}};CustomizedCommandHandler.prototype.doKeyDown=function(){var diagram=this.diagram;var e=diagram.lastInput;var key=e.key;var alt=e.alt;var shift=e.shift;var selectionCount=diagram.selection.count;selectionCount>0&&_.contains(["Up","Down","Left","Right"],key)?this.moveSelectionNodes(key,alt):selectionCount>0&&!shift&&(!alt&&"Backspace"===key||"Del"===key)||go.CommandHandler.prototype.doKeyDown.apply(this,arguments)};CustomizedCommandHandler.prototype.moveSelectionNodes=function(dir,alt){var defaultOffsetX=alt?this._altOffsetX:this._defaultOffsetX;var defaultOffsetY=alt?this._altOffsetY:this._defaultOffsetY;var offsetX=0;var offsetY=0;var diagram=this.diagram;switch(dir){case"Up":offsetY=-1*defaultOffsetY;break;case"Down":offsetY=defaultOffsetY;break;case"Left":offsetX=-1*defaultOffsetX;break;case"Right":offsetX=defaultOffsetX}diagram.startTransaction("moveSelectionNodes");var moveNodes=[];var moveNodesBounds;diagram.selection.each((function(node){var isLine=node.category===netBrain.Map.CategoryMgr.Line;if(node instanceof go.Node||isLine){var loc=node.location;var x=loc.x+offsetX;var y=loc.y+offsetY;if(isLine)!function(link,x,y){link.move(new go.Point(x,y))}(node,x,y);else{updateNodeLocation(node,x,y);moveNodes.push(node)}moveNodesBounds?moveNodesBounds.unionRect(node.actualBounds):moveNodesBounds=node.actualBounds}}));if(!(moveNodes.length<1)&&moveNodesBounds){var viewportBounds=diagram.viewportBounds;moveNodesBounds=moveNodesBounds.copy().addMargin(diagram.padding);var newBx=viewportBounds.centerX;var newBy=viewportBounds.centerY;switch(dir){case"Up":newBy=moveNodesBounds.top;break;case"Down":newBy=moveNodesBounds.bottom;break;case"Left":newBx=moveNodesBounds.left;break;case"Right":newBx=moveNodesBounds.right}viewportBounds.containsPoint(new go.Point(newBx,newBy))||this.scrollDiagram(offsetX,offsetY);diagram.commitTransaction("moveSelectionNodes");_.isFunction(this.moveSelectionNodesCallback)&&this.moveSelectionNodesCallback(moveNodes)}};CustomizedCommandHandler.prototype.moveSelectionNodesCallback=function(){};CustomizedCommandHandler.prototype.scrollDiagram=function(x,y){var diagram=this.diagram;if(null!==diagram){var dirX=x>0?"right":"left";var dirY=y>0?"down":"up";diagram.scroll("pixel",dirX,Math.abs(x));diagram.scroll("pixel",dirY,Math.abs(y))}};CustomizedCommandHandler.prototype.deleteSelection=function(){var diagram=this.diagram;if(null!==diagram&&!diagram.raiseDiagramEvent("SelectionDeleting",diagram.selection))try{diagram.currentCursor="wait";diagram.startTransaction("Delete");diagram.raiseDiagramEvent("ChangingSelection");var allobjs=new go.Set(go.Part);var it=diagram.selection.iterator;for(;it.next();){var part=it.value;var removePortsCount=0;part instanceof netBrain.Map.CompL2Device&&(removePortsCount=part.removeSelectedPorts());0===removePortsCount&&gatherCollection(allobjs,part,!0,this.deletesTree?1/0:0,this.deletesConnectedLinks,(function(p){return p.canDelete()}))}diagram.removeParts(allobjs,!0);diagram.raiseDiagramEvent("SelectionDeleted",allobjs)}finally{diagram.raiseDiagramEvent("ChangedSelection");diagram.commitTransaction("Delete");diagram.currentCursor=""}};function getFirstSelectionNode(diagram){var firstNode=null;diagram.selection.each((function(obj){firstNode||obj instanceof go.Node&&(firstNode=obj)}));return firstNode}function updateNodeLocation(node,x,y){node.location=new go.Point(x,y)}function gatherCollection(coll,p,groupmembers,treechildren,connectedlinks,pred){void 0===pred&&(pred=null);if(!coll.contains(p)&&(null===pred||pred(p))&&!(p instanceof go.Adornment)){coll.add(p);if(p instanceof go.Node){var n=p;if(groupmembers&&n instanceof go.Group){var mit=n.memberParts;for(;mit.next();){gatherCollection(coll,mit.value,groupmembers,treechildren,connectedlinks,pred)}}if(connectedlinks){var lit=n.linksConnected;for(;lit.next();){var l=lit.value;if(!coll.contains(l)){var from=l.fromNode;var to=l.toNode;null!==from&&coll.contains(from)&&null!==to&&coll.contains(to)?gatherCollection(coll,l,groupmembers,treechildren,connectedlinks,pred):null!==from&&null!==to||gatherCollection(coll,l,groupmembers,treechildren,connectedlinks,pred)}}}if(treechildren>1){var it=n.findTreeChildrenNodes();for(;it.next();){gatherCollection(coll,it.value,groupmembers,treechildren-1,connectedlinks,pred)}}}else if(p instanceof go.Link){lit=(l=p).labelNodes;for(;lit.next();){gatherCollection(coll,lit.value,groupmembers,treechildren,connectedlinks,pred)}}}}netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizedCommandHandler=CustomizedCommandHandler}(NetBrain);!function(netBrain){function CustomizeClickSelectingTool(){go.ClickSelectingTool.apply(this)}go.Diagram.inherit(CustomizeClickSelectingTool,go.ClickSelectingTool);CustomizeClickSelectingTool.prototype.standardMouseSelect=function(){var diagram=this.diagram;if(null!==diagram&&diagram.allowSelect){var e=diagram.lastInput;var curobj=diagram.findPartAt(e.documentPoint,!1);if(null!==curobj){var part=curobj;if(e.control||e.meta){diagram.raiseDiagramEvent("ChangingSelection");for(;null!==part&&!part.canSelect();)part=part.containingGroup;null!==part&&(netBrain.Map.CategoryMgr.isPathLink(part.category)?this.onSelectPathHop(part,!0):part.isSelected=!part.isSelected);diagram.raiseDiagramEvent("ChangedSelection")}else if(e.shift){if(netBrain.Map.CategoryMgr.isPathLink(part.category)){diagram.raiseDiagramEvent("ChangingSelection");this.onSelectPathHop(part);this.selectOtherSameTypeNodes(part);diagram.raiseDiagramEvent("ChangedSelection")}else if(!curobj.isSelected){diagram.raiseDiagramEvent("ChangingSelection");for(;null!==part&&!part.canSelect();)part=part.containingGroup;if(null!==part){part.isSelected=!0;this.selectOtherSameTypeNodes(part)}diagram.raiseDiagramEvent("ChangedSelection")}}else if(netBrain.Map.CategoryMgr.isPathLink(part.category)){var selectedHop=this.getSelectedHop();if(selectedHop&&!part.isHopSelected(selectedHop)){diagram.select(part);this.onSelectPathHop(part)}}else if(!curobj.isSelected){for(;null!==part&&!part.canSelect();)part=part.containingGroup;null!==part&&diagram.select(part)}}else!e.left||e.control||e.meta||e.shift||diagram.clearSelection()}};CustomizeClickSelectingTool.prototype.onSelectPathHop=function(part,isCtrl){if(netBrain.Map.CategoryMgr.isPathLink(part.category)){var pathCon=this.getSelectedHop();if(pathCon)if(!0===isCtrl)if(part.isHopSelected(pathCon)){part.isSelected=1!==part.selectedHops.length;part.unselectHop(pathCon)}else{part.isSelected=!0;part.selectHop(pathCon)}else{part.isSelected=!0;part.clearAllSelectedHops();part.selectHop(pathCon)}}};CustomizeClickSelectingTool.prototype.getSelectedHop=function(){var diagram=this.diagram;var CompPathNewBase=netBrain.Map.CompPathNewBase;var obj=diagram.findObjectAt(diagram.lastInput.documentPoint);if(obj){var pathCon;obj.name===CompPathNewBase.PathShapeContainer?pathCon=obj:obj.panel&&obj.panel.name===CompPathNewBase.PathShapeContainer&&(pathCon=obj.panel);return pathCon}};CustomizeClickSelectingTool.prototype.selectOtherSameTypeNodes=function(part){};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizeClickSelectingTool=CustomizeClickSelectingTool}(NetBrain);!function(netBrain){function CustomizeDragSelectingTool(){go.DragSelectingTool.call(this);var box=this.box;if(box){var shape=box.findObject("SHAPE");shape.fill="#E8E8E8";shape.opacity=.5}}go.Diagram.inherit(CustomizeDragSelectingTool,go.DragSelectingTool);CustomizeDragSelectingTool.prototype.doActivate=function(){go.DragSelectingTool.prototype.doActivate.call(this);var diagram=this.diagram;null!==diagram&&(diagram.currentCursor="default")};CustomizeDragSelectingTool.prototype.selectInRect=function(r){var diagram=this.diagram;if(null!==diagram){var e=diagram.lastInput;diagram.raiseDiagramEvent("ChangingSelection");var parts=diagram.findObjectsIn(r,null,(function(p){return p instanceof go.Part&&p.canSelect()}),this.isPartialInclusion);parts=this.sortParts(parts,r);if(e.meta||e.control)if(e.shift){var it=parts.iterator;for(;it.next();){var p=it.value;if(p.isSelected){p.isSelected=!1;netBrain.Map.CategoryMgr.isPathLink(p.category)&&p.clearAllSelectedHops()}}}else{it=parts.iterator;for(;it.next();){var tp=it.value;tp.isSelected=!tp.isSelected;netBrain.Map.CategoryMgr.isPathLink(tp.category)&&(tp.isSelected?tp.selectAllHops():tp.clearAllSelectedHops())}}else if(e.shift){it=parts.iterator;for(;it.next();){var ep=it.value;if(!ep.isSelected){ep.isSelected=!0;netBrain.Map.CategoryMgr.isPathLink(ep.category)&&ep.selectAllHops()}}}else{var tounselect=new go.List(go.Part);var sit=diagram.selection.iterator;for(;sit.next();){var sp=sit.value;parts.contains(sp)||tounselect.add(sp)}var uit=tounselect.iterator;for(;uit.next();){var up=uit.value;up.isSelected=!1;netBrain.Map.CategoryMgr.isPathLink(up.category)&&up.clearAllSelectedHops()}it=parts.iterator;for(;it.next();){var ps=it.value;if(!ps.isSelected){ps.isSelected=!0;netBrain.Map.CategoryMgr.isPathLink(ps.category)&&ps.selectAllHops()}}}diagram.raiseDiagramEvent("ChangedSelection")}};CustomizeDragSelectingTool.prototype.sortParts=function(parts,r){var newParts=new go.List;newParts.addAll(parts);var ox=r.left;var oy=r.top;newParts.sort((function(a,b){var aLoc=a.actualBounds;var bLoc=b.actualBounds;return Math.pow(aLoc.x-ox,2)+Math.pow(aLoc.y-oy,2)-(Math.pow(bLoc.x-ox,2)+Math.pow(bLoc.y-oy,2))}));return newParts};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizeDragSelectingTool=CustomizeDragSelectingTool}(NetBrain);!function(netBrain){var CustomizedDraggingTool=function(argCurrentScopeRef){go.DraggingTool.call(this);this.labelLayoutTool=new netBrain.Map.LinkLableLayoutTool;this.l2PortsLayoutTool=null;this.dragsLink=!1;this.currentScopeRef=argCurrentScopeRef};(CustomizedDraggingTool.prototype=new go.DraggingTool).doActivate=function(){var diagram=this.diagram;if(null!==diagram){diagram.startTransaction("do dragging");this.l2PortsLayoutTool||(this.l2PortsLayoutTool=new netBrain.Map.L2PortsLayoutTool(this.currentScopeRef.diagram,this.currentScopeRef.netmap));this.standardMouseSelect();var curSelectPart=this.currentPart;null!=curSelectPart&&curSelectPart.category===netBrain.Map.CategoryMgr.Line?this.dragsLink=!0:this.dragsLink=!1;if(curSelectPart&&!netBrain.Map.CategoryMgr.isPathLink(curSelectPart.category)){this.oldLayerName=curSelectPart.layerName;curSelectPart.layerName=GlobalContext.DragLayerName}if(this.currentScopeRef.netmap.isL2MapStyle()){var CategoryMgr=netBrain.Map.CategoryMgr;diagram.selection.each((function(part){part instanceof go.Link||part.linksConnected.each((function(link){if(CategoryMgr.isTopolink(link.data.category)&&!_.isUndefined(link.data.fromSpotFrom6X)){diagram.model.setDataProperty(link.data,"fromSpotFrom6X",-1);diagram.model.setDataProperty(link.data,"toSpotFrom6X",-1)}}))}))}return go.DraggingTool.prototype.doActivate.call(this)}};CustomizedDraggingTool.prototype.findDraggablePart=function(){return go.DraggingTool.prototype.findDraggablePart.call(this)};CustomizedDraggingTool.prototype.doMouseMove=function(){go.DraggingTool.prototype.doMouseMove.call(this);if(this.l2PortsLayoutTool&&this.currentScopeRef.netmap.isL2MapStyle()){var draggingNodes=getDraggingNodes(this.draggedParts);var portInfos=netBrain.Map.L2PortsLayoutTool.getPortsInfoByDragNodes(draggingNodes);portInfos.length>0&&this.l2PortsLayoutTool.layout(portInfos)}this.checkDraggingNodesAndLinks();null!=this.labelLayoutTool&&this.labelLayoutTool.LayOut(this.diagram);this.currentScopeRef.netmapOperator&&this.currentScopeRef.netmapOperator.refreshHighlightBgFromCache()};function getDraggingNodes(draggedParts){var kvs=draggedParts.toArray();return _.pluck(kvs,"key")}CustomizedDraggingTool.prototype.computeEffectiveCollection=function(parts){var map=go.DraggingTool.prototype.computeEffectiveCollection.call(this,parts);if(null!==this.draggedLink&&this.dragsLink)return map;var paths=new go.List;var it=map.iterator;for(;it.next();){var p=it.key;p instanceof netBrain.Map.BasePathLink&&paths.add(p)}paths.each((function(path){map.remove(path)}));return map};CustomizedDraggingTool.prototype.doDeactivate=function(){var curSelectPart=this.currentPart;curSelectPart&&!netBrain.Map.CategoryMgr.isPathLink(curSelectPart.category)&&(curSelectPart.layerName=this.oldLayerName);go.DraggingTool.prototype.doDeactivate.call(this);var diagram=this.diagram;if(null!==diagram){this.currentScopeRef.netmap&&this.currentScopeRef.netmap.refreshMapViewOptionVisible(void 0,!0);diagram.commitTransaction("do dragging")}};CustomizedDraggingTool.prototype.checkDraggingNodesAndLinks=function(){var netmap=this.currentScopeRef.netmap;if(netmap){var nodes=new go.Set;var links=new go.Set;_.each(getDraggingNodes(this.draggedParts),(function(part){if(part instanceof go.Node){nodes.add(part);part.linksConnected.each((function(link){links.add(link)}))}}));var curSpace=this.diagram.commandHandler.space;nodes.each((function(node){netmap.checkDeviceLabelsVisible(node,curSpace)}));links.each((function(link){netmap.checkLinkLabelsVisible(link,curSpace)}))}};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizedDraggingTool=CustomizedDraggingTool}(NetBrain);!function(netBrain){var CustomizeRelinkingTool=function(){go.RelinkingTool.call(this);this.temporaryLink.fromEndSegmentLength=0;this.temporaryLink.toEndSegmentLength=0};go.Diagram.inherit(CustomizeRelinkingTool,go.RelinkingTool);CustomizeRelinkingTool.prototype.doActivate=function(){var diagram=this.diagram;if(null!=diagram){if(null===this.originalLink){var h=this.findToolHandleAt(diagram.firstInput.documentPoint,"RelinkFrom");null===h&&(h=this.findToolHandleAt(diagram.firstInput.documentPoint,"RelinkTo"));if(null===h)return;var ad=h.part;if(!(ad instanceof go.Adornment))return;if(!(ad.adornedPart instanceof go.Link))return;this.originalLink=ad.adornedPart}this.isForwards=!0;if(null!=this.originalLink&&this.originalLink.category===netBrain.Map.CategoryMgr.Line){this.isUnconnectedLinkValid=!0;var findObj=diagram.findObjectAt(diagram.firstInput.documentPoint,null,null);null!=findObj&&null!=findObj.part&&"RelinkFrom"===findObj.part.category&&(this.isForwards=!1);if(null!=this.temporaryLink&&this.temporaryLink.elements.count>=2){var toArrowShape=this.temporaryLink.elt(1);null!=toArrowShape&&(toArrowShape.toArrow="")}}else this.isUnconnectedLinkValid=!1;return go.RelinkingTool.prototype.doActivate.call(this)}};CustomizeRelinkingTool.prototype.copyLinkProperties=function(reallink,templink){if(null!==reallink&&null!==templink){templink.adjusting=reallink.adjusting;templink.corner=reallink.corner;var curve=reallink.curve;curve!==go.Link.JumpOver&&curve!==go.Link.JumpGap||(curve=go.Link.None);templink.curve=curve;templink.curviness=reallink.curviness;templink.routing=reallink.routing;templink.smoothness=reallink.smoothness;if(reallink instanceof CallOutCustomizeLink)templink.fromEndSegmentLength=0;else{templink.fromSpot=reallink.fromSpot;templink.fromEndSegmentLength=reallink.fromEndSegmentLength}templink.fromEndSegmentDirection=reallink.fromEndSegmentDirection;templink.fromShortLength=reallink.fromShortLength;if(reallink instanceof CallOutCustomizeLink)templink.toEndSegmentLength=0;else{templink.toSpot=reallink.toSpot;templink.toEndSegmentLength=reallink.toEndSegmentLength}templink.toEndSegmentDirection=reallink.toEndSegmentDirection;templink.toShortLength=reallink.toShortLength}};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizeRelinkingTool=CustomizeRelinkingTool}(NetBrain);!function(netBrain){var CustomizedLinkingTool=function(){go.LinkingTool.call(this);this.isUnconnectedLinkValid=!0;this.temporaryLink.fromEndSegmentLength=0;this.temporaryLink.toEndSegmentLength=0;this.l2TopolinkTemplateData=null};go.Diagram.inherit(CustomizedLinkingTool,go.LinkingTool);CustomizedLinkingTool.prototype.setL2TopoLinkTmplateData=function(L2LinkTmplateData){this.l2TopolinkTemplateData=null===L2LinkTmplateData?{category:netBrain.Map.CategoryMgr.L2Device}:L2LinkTmplateData};CustomizedLinkingTool.prototype.canStart=function(){if(!this.isEnabled)return!1;var diagram=this.diagram;if(null===diagram||diagram.isReadOnly||diagram.isModelReadOnly)return!1;if(!diagram.allowLink)return!1;var model=diagram.model;if(null===model)return!1;if(!(model instanceof go.GraphLinksModel||model instanceof go.TreeModel))return!1;if(!diagram.lastInput.left)return!1;if(diagram.currentTool!==this&&!this.isBeyondDragSize())return!1;if(null==this.findLinkablePort())return!1;if(!1===this.isForwards){var obj=this.startObject;null===obj&&(obj=diagram.findObjectAt(diagram.firstInput.documentPoint,null,null));if(null===obj)return!1;var node=obj.part;if(null==node)return!1;if(node.category===netBrain.Map.CategoryMgr.NetworkDevice)return!1}return!0};CustomizedLinkingTool.prototype.doActivate=function(){var diagram=this.diagram;if(null!==diagram){var startObj=diagram.findObjectAt(diagram.firstInput.documentPoint,null,null);if(null!=startObj&&null!=startObj.part&&startObj.part.category===netBrain.Map.CategoryMgr.CallOut){this.archetypeLinkData={category:netBrain.Map.CategoryMgr.CompCallOutLink};netBrain.Map.CompPrototypeFactory.buildCompPrototype(this.archetypeLinkData)}else this.archetypeLinkData={};return go.LinkingTool.prototype.doActivate.call(this)}};CustomizedLinkingTool.prototype.insertLink=function(fromnode,fromport,tonode,toport){var diagram=this.diagram;if(null===diagram)return null;var model=diagram.model;if(null===model)return null;if(null===fromnode||null===tonode)return null;if(fromnode.category===CompL2Device.getVarCategory()||tonode.category===CompL2Device.getVarCategory()){var fromportid="";if(fromnode){null===fromport&&(fromport=fromnode);null===(fromportid=fromport.portId)&&(fromportid="")}var toportid="";if(tonode){null===toport&&(toport=tonode);null===(toportid=toport.portId)&&(toportid="")}if(null!==this.l2TopolinkTemplateData){var data=model.copyLinkData(this.l2TopolinkTemplateData);if(null!=data){fromnode&&(data.from=fromnode.data.key);data.fromPort=fromportid;tonode&&(data.to=tonode.data.key);data.toPort=toportid;model.addLinkData(data);return diagram.findLinkForData(data)}}}return go.LinkingTool.prototype.insertLink.call(this,fromnode,fromport,tonode,toport)};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizedLinkingTool=CustomizedLinkingTool}(NetBrain);!function(netBrain){var CustomizedSelectTool=function(netmap){go.ClickSelectingTool.call(this);this.netmap=netmap};go.Diagram.inherit(CustomizedSelectTool,go.ClickSelectingTool);CustomizedSelectTool.prototype.setNetMap=function(netmap){this.netmap=netmap};CustomizedSelectTool.prototype.getNetMap=function(){return this.netmap};CustomizedSelectTool.prototype.selectAllTargetLink=function(bSel,diagram,tmpArray){for(var it=diagram.links;it.next();){var link=it.value;tmpArray.indexOf(link.key)<0||(link.isSelected=bSel)}};CustomizedSelectTool.prototype.standardMouseSelect=function(){var diagram=this.diagram;if(null!==diagram&&diagram.allowSelect){var e=diagram.lastInput;var curobj=diagram.findPartAt(e.documentPoint,!1);if(null!=this.netmap&&null!==curobj&&null!==curobj.category&&curobj.category===netBrain.Map.CategoryMgr.Path){var tmpArray=[];var multiPathJson=this.netmap.getOneMultiPathByKey(curobj.data.parentMultiPathKey);if(null!=multiPathJson){var multiPath=new CompMultiPath;multiPath.fromJson(multiPathJson);var mainPathKey=multiPath.getMainPathKey();tmpArray.push(mainPathKey);var subPath=multiPath.getAllSubPathKey();if(null!=subPath)for(var index=0;index<subPath.length;index++)tmpArray.push(subPath[index]);if(!curobj.isSelected){diagram.raiseDiagramEvent("ChangingSelection");this.selectAllTargetLink(!0,diagram,tmpArray);diagram.raiseDiagramEvent("ChangedSelection");return}diagram.raiseDiagramEvent("ChangingSelection");this.selectAllTargetLink(!1,diagram,tmpArray);diagram.raiseDiagramEvent("ChangedSelection");return}}go.Tool.prototype.standardMouseSelect.call(this)}};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizedSelectTool=CustomizedSelectTool}(NetBrain);!function(netBrain){var CustomizeTextEditingTool=function(scope){go.TextEditingTool.call(this);this.scope=scope};go.Diagram.inherit(CustomizeTextEditingTool,go.TextEditingTool);CustomizeTextEditingTool.prototype.canStart=function(){if(!this.isEnabled)return!1;var diagram=this.diagram;if(null===diagram||diagram.isReadOnly)return!1;if(!diagram.lastInput.left)return!1;if(this.isBeyondDragSize())return!1;var p=diagram.lastInput.documentPoint;var tb=diagram.findObjectAt(p,null,(function(x){return x instanceof go.TextBlock&&x.name!==netBrain.Map.CompDevice.devPosInfoLabel&&x.name!==netBrain.Map.CompTopolink.linkPosInfoLabel&&x.name!==netBrain.Map.CompDevice.hostNameLable}));if(null===tb){var icon=diagram.findObjectAt(p,null,(function(x){return"editLabelIcon"===x.name}));if(null===icon)return!1;tb=icon.panel.findObject(netBrain.Map.CompDevice.devPosInfoLabel)||icon.panel.findObject(netBrain.Map.CompTopolink.linkPosInfoLabel)||icon.panel.findObject(netBrain.Map.CompDevice.hostNameLable)}if(null===tb)return!1;if(!(tb.name===netBrain.Map.CompDeviceNote.noteContentTextBlockName||tb.editable&&tb.part.canEdit()))return!1;var part=tb.part;if(null===part)return!1;if(tb.name!==netBrain.Map.CompDeviceNote.noteContentTextBlockName&&netBrain.Map.CategoryMgr.isSelectedEditable(part.data.getCategory())&&!part.isSelected)return!1;this.textBlock=tb;return!0};CustomizeTextEditingTool.prototype.doActivate=function(){var diagram=this.diagram;go.TextEditingTool.prototype.doActivate.call(this);("undefined"!=typeof event||window.event)&&(this.event=event||window.event);var textblock=this.textBlock;var part=textblock.part;if(null!==part){var input=this.defaultTextEditor;var inputElem=input.mainElement;this.input=input;var scope=this.scope;inputElem.fontChanged=function(){updateInputStyle(textblock,inputElem,diagram,scope)};if(null!==textblock.textEditor){input=textblock.textEditor;inputElem=input.mainElement}updateInputStyle(textblock,inputElem,diagram,scope);inputElem.rows=textblock.lineCount;inputElem.focus();$(inputElem).off("input").on("input",(function(){this.style.width=this.textwidth+"px";if(textblock.isMultiline){this.style.height=this.style.maxHeight=this.textheight+"px";this.style.overflow="auto"}else{this.style.height="auto";this.style.maxHeight=this.textheight+"px"}}));!textblock.textEditor&&(textblock.textEditor=input);scope=this.scope;$(inputElem).off("contextmenu").on("contextmenu",(function(event){if(3===event.which){event.stopPropagation();event.preventDefault()}this.selectionEnd===this.selectionStart||inputElem.readOnly||scope.showEditorToolbar(part,textblock)}));$(inputElem).on("keydown mousedown",(function(){scope.hideEditorToolbar()}))}};function updateInputStyle(textblock,inputElem,diagram,scope){var loc=textblock.getDocumentPoint(go.Spot.Center);var pos=diagram.position;var sc=diagram.scale;var textscale=textblock.getDocumentScale()*sc;var textwidth=(textblock.naturalBounds.width+textblock.margin.left+textblock.margin.right)*textscale;var textheight=(textblock.naturalBounds.height+textblock.margin.top+textblock.margin.bottom)*textscale;var input=inputElem;input.readOnly=!1;input.textwidth=textwidth;input.textheight=textheight;input.style["word-break"]="break-all";var left=(loc.x-pos.x)*sc;var top=(loc.y-pos.y-(textblock.margin.top-textblock.margin.bottom)/2)*sc;if(textblock.isMultiline){input.style.height=input.style.maxHeight=textheight+"px";input.style.overflow="auto"}else{input.style.height="auto";input.style.maxHeight=textheight+5+"px";textwidth+=4;textwidth=Math.ceil(textwidth)}input.style.width=textwidth+"px";input.style.left=(left-textwidth/2|0)+"px";input.style.top=(top-textheight/2|0)+"px";input.style.color=textblock.stroke;var textDecoration="";textblock.isUnderline&&(textDecoration+="underline");if(textblock.isStrikethrough){textDecoration.length>0&&(textDecoration+=" ");textDecoration+="line-through"}0===textDecoration.length&&(textDecoration="none");input.style.textDecoration=textDecoration;input.style.background="#FFFFFF";if(netBrain.Map.CategoryMgr.isDeviceNoteOrNote(textblock.part.category)){var CompDeviceNote=netBrain.Map.CompDeviceNote;if(textblock.name===CompDeviceNote.noteContentTextBlockName||"noteTopTitle"===textblock.name){input.style.padding="0px";input.style.font=textblock.font;"bold"===input.style.fontWeight?input.style.lineHeight=1.25:input.style.lineHeight=1.7}input.readOnly=function(scope,textblock){var flag=!1;var CompDeviceNote=netBrain.Map.CompDeviceNote;if(textblock.name===CompDeviceNote.noteContentTextBlockName){var partData=textblock.part.data;if(partData instanceof CompDeviceNote)if(partData.noteFromType===netBrain.Map.Const.NoteFromType.Path)flag=!0;else if(scope&&_.isFunction(scope.isEditMode)){var isEditMode=!!scope.isEditMode();(isEditMode&&partData.noteFromType!==netBrain.Map.Const.NoteFromType.DataView||!isEditMode&&partData.noteFromType===netBrain.Map.Const.NoteFromType.DataView)&&(flag=!0)}}return flag}(scope,textblock);if(input.readOnly){var textblockObj=textblock.part.findObject(NetBrain.Map.CompDeviceNote.bgShapeName);textblockObj&&textblockObj.fill&&(input.style.background=textblockObj.fill)}}else input.style.border="1px solid #aaa"}CustomizeTextEditingTool.prototype.isValidText=function(textBlock,oldValue,newValue){if("hostName"===textBlock.name){oldValue=oldValue.trim();newValue=newValue.trim();this.newValue=newValue;this.oldValue=oldValue;var scope=this.scope;var event=this.event;var editor=this.currentTextEditor.mainElement;if(0===newValue.length)return!1;var isValid=!1;var stencilKey=textBlock.part.data.key;var hasPel=scope.netmapOperator.getPelByName(newValue);var prowcessShowHostnameInvalidTip=function(){textBlock.text=oldValue;editor.value=oldValue;event?scope.showHostnameInvalidTip(event):scope.showHostnameInvalidTip(editor)};if(hasPel.length>1){prowcessShowHostnameInvalidTip();return!1}if(1===hasPel.length&&stencilKey!==hasPel[0].key){prowcessShowHostnameInvalidTip();return!1}scope.httpDeviceSrvc.isExistsSimpleByHostName(null,newValue,(function(result){if(0===result.code){if(result.data.data)prowcessShowHostnameInvalidTip();else{isValid=!0;textBlock.part.data.setHostName(newValue)}}}));return isValid}return go.TextEditingTool.prototype.isValidText.apply(this,arguments)};CustomizeTextEditingTool.prototype.doDeactivate=function(){var textBlock=this.textBlock;textBlock&&$(textBlock.textEditor).off();go.TextEditingTool.prototype.doDeactivate.call(this);this.scope.hideEditorToolbar();textBlock&&textBlock.part instanceof netBrain.Map.CompL2Device&&"hostName"===textBlock.name&&textBlock.part.calcBounds()};CustomizeTextEditingTool.prototype.acceptText=function(reason){var textBlock=this.textBlock;if(textBlock){var oldstring=this.textBlock.text;var v=this.currentTextEditor.mainElement.value;var newstring="";newstring="function"==typeof v?v():v;var part=this.textBlock.part}go.TextEditingTool.prototype.acceptText.apply(this,arguments);var CompDeviceNote=netBrain.Map.CompDeviceNote;if(textBlock&&part.data instanceof CompDeviceNote&&oldstring!==newstring&&(textBlock.name===CompDeviceNote.noteContentTextBlockName||textBlock.name===CompDeviceNote.noteTitleTextBlockName)){var oldTitle;oldTitle=textBlock.name===CompDeviceNote.noteTitleTextBlockName?oldstring:part.data.noteTitle;oldTitle=BindHelper.toTarget_deviceNote_noLeadingSpacePrefix(oldTitle);this.scope.$emit(CompDeviceNote.EVENT_NAMES.NOTE_TITLE_OR_CONTENT_CHANGE,textBlock,part.data,oldTitle)}};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizeTextEditingTool=CustomizeTextEditingTool}(NetBrain);!function(netBrain){var TopRotatingTool=function(){go.RotatingTool.call(this)};go.Diagram.inherit(TopRotatingTool,go.RotatingTool);TopRotatingTool.prototype.updateAdornments=function(part){go.RotatingTool.prototype.updateAdornments.call(this,part);var adornment=part.findAdornment("Rotating");null!==adornment&&(adornment.location=part.rotateObject.getDocumentPoint(new go.Spot(.5,0,0,-30)))};TopRotatingTool.prototype.rotate=function(newangle){go.RotatingTool.prototype.rotate.call(this,newangle+90)};netBrain.Map=netBrain.Map||{};netBrain.Map.TopRotatingTool=TopRotatingTool}(NetBrain);!function(netBrain){function CustomizeLineResizeTool(){go.ResizingTool.call(this);this.selectPoint=null;this.isLineResize=!1;this.strHandle1Name="onePoint";this.strHandle2Name="anotherPoint";this.selectHandleObj=null;this.selectLinePart=null}go.Diagram.inherit(CustomizeLineResizeTool,go.ResizingTool);CustomizeLineResizeTool.prototype.updateAdornments=function(part){go.ResizingTool.prototype.updateAdornments.call(this,part);if(null!=part.data&&part.data.category===netBrain.Map.CompLine.getVarCategory()){this.isLineResize=!0;this.selectLinePart=part;this.updateLineAdorment(part)}else this.isLineResize=!1};CustomizeLineResizeTool.prototype.updateLineAdorment=function(part){if(null!=part.data&&part.data.category===netBrain.Map.CompLine.getVarCategory()){if(part.isSelected&&!this.diagram.isReadOnly){var resizeObj=part.resizeObject;if(null!==resizeObj&&part.canResize()&&part.actualBounds.isReal()&&part.isVisible()&&resizeObj.actualBounds.isReal()&&resizeObj.isVisibleObject()){var adornment=part.resizeAdornmentTemplate;if(null!==adornment){var lineShape=part.findObject("shapeObj");if(null==lineShape)return;var ptStart=new go.Point(lineShape.geometry.startX,lineShape.geometry.startY);var ptEnd=new go.Point(lineShape.geometry.endX,lineShape.geometry.endY);var onePoint=adornment.findObject(this.strHandle1Name);null!=onePoint&&(onePoint.position=ptStart);var anotherPoint=adornment.findObject(this.strHandle2Name);null!=anotherPoint&&(anotherPoint.position=ptEnd);adornment.location=part.position;adornment.type=go.Panel.Position;adornment.locationSpot=go.Spot.Center;adornment.category=this.name;adornment.adornedObject=lineShape;part.addAdornment(this.name,adornment);return}}}part.removeAdornment(this.name)}};CustomizeLineResizeTool.prototype.setLineStartPoint=function(pt){if(null!=this.selectLinePart){var lineShape=this.selectLinePart.findObject("shapeObj");if(null!=lineShape){var tmpGeometry=lineShape.geometry.copy();var pathFigure=tmpGeometry.figures.elt(0);if(null!=pathFigure){var viewpt=this.diagram.viewportBounds.position;pathFigure.startX=pt.x-viewpt.x;pathFigure.startY=pt.y-viewpt.y;lineShape.geometry=tmpGeometry}}}};CustomizeLineResizeTool.prototype.setLineEndPoint=function(pt){if(null!=this.selectLinePart){var lineShape=this.selectLinePart.findObject("shapeObj");if(null!=lineShape){var tmpGeometry=lineShape.geometry.copy();var pathFigure=tmpGeometry.figures.elt(0);if(null!=pathFigure){var pathSegment=pathFigure.segments.elt(0);if(null!=pathSegment){var viewpt=this.diagram.viewportBounds.position;pathSegment.endX=pt.x-viewpt.x;pathSegment.endY=pt.y-viewpt.y;lineShape.geometry=tmpGeometry}}}}};CustomizeLineResizeTool.prototype.canStart=function(){if(this.isLineResize){this.selectHandleObj=this.findToolHandleAt(this.diagram.firstInput.documentPoint,this.name);return null!==this.selectHandleObj}return go.ResizingTool.prototype.canStart.call(this)};CustomizeLineResizeTool.prototype.doActivate=function(){this.selectHandleObj=this.findToolHandleAt(this.diagram.firstInput.documentPoint,this.name);go.ResizingTool.prototype.doActivate.call(this);if(this.isLineResize){var diagram=this.diagram;if(null==diagram)return;this.startTransaction(this.name);diagram.isMouseCaptured=!0;diagram.currentCursor=cursorHelper.pointer}};CustomizeLineResizeTool.prototype.doDeactivate=function(){if(this.isLineResize){this.diagram.currentCursor=cursorHelper.pointer;this.diagram.isMouseCaptured=!1;this.stopTransaction()}go.ResizingTool.prototype.doDeactivate.call(this)};CustomizeLineResizeTool.prototype.doMouseDown=function(){this.isLineResize&&(this.isActive||this.doActivate())};CustomizeLineResizeTool.prototype.doMouseMove=function(){if(this.isLineResize){if(this.isActive&&null!=this.selectHandleObj){var diagram=this.diagram;if(null===diagram)return;var docpt=diagram.lastInput.documentPoint;this.selectHandleObj.name===this.strHandle1Name?this.setLineStartPoint(docpt):this.setLineEndPoint(docpt)}}else go.ResizingTool.prototype.doMouseMove.call(this)};CustomizeLineResizeTool.prototype.doMouseUp=function(){this.isLineResize&&this.doDeactivate();go.ResizingTool.prototype.doMouseUp.call(this)};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizeLineResizeTool=CustomizeLineResizeTool}(NetBrain);!function(netBrain){var CustomizePanningTool=function(scope){go.PanningTool.call(this);this.scope=scope;this.labelLayoutTool=new netBrain.Map.LinkLableLayoutTool;this.l2PortsLayoutTool=null};go.Diagram.inherit(CustomizePanningTool,go.PanningTool);CustomizePanningTool.prototype.doActivate=function(){go.PanningTool.prototype.doActivate.call(this);var diagram=this.diagram;if(null!==diagram){diagram.isMouseCaptured&&(diagram.currentCursor=cursorHelper.grabbing);this.l2PortsLayoutTool||(this.l2PortsLayoutTool=new netBrain.Map.L2PortsLayoutTool(this.scope.diagram,this.scope.netmap))}};CustomizePanningTool.prototype.doMouseMove=function(){go.PanningTool.prototype.doMouseMove.call(this);this.l2PortsLayoutTool;null!=this.labelLayoutTool&&this.labelLayoutTool.LayOut(this.diagram)};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizePanningTool=CustomizePanningTool}(NetBrain);!function(netBrain){var PortShiftingTool=function(){go.Tool.call(this);this.name="PortShiftingTool";this.port=null;this.pos=null;this.labelLayoutTool=new netBrain.Map.LinkLableLayoutTool};go.Diagram.inherit(PortShiftingTool,go.Tool);PortShiftingTool.prototype.canStart=function(){if(!go.Tool.prototype.canStart.call(this))return!1;var diagram=this.diagram;return null!==diagram&&(!!diagram.lastInput.left&&(!!this.isBeyondDragSize()&&null!==this.findPort()))};PortShiftingTool.prototype.findPort=function(){var diagram=this.diagram;var e=diagram.firstInput;var elt=diagram.findObjectAt(e.documentPoint,null,null);if(elt){if(elt.name===netBrain.Map.CategoryMgr.L2Port)return elt;if(elt.panel&&elt.panel.name===netBrain.Map.CategoryMgr.L2Port)return elt.panel}return null};PortShiftingTool.prototype.doActivate=function(){this.startTransaction("Shifted Port");this.port=this.findPort();if(null!==this.port){this.standardMouseSelect();this.pos=this.port.getPortPos();var sibling=this.port.getDevice().getPorts(netBrain.Map.CompL2Device.SelectedPort);for(var i=0;i<sibling.length;++i)sibling[i].selectPort(!1);this.port.selectPort(!0)}go.Tool.prototype.doActivate.call(this)};PortShiftingTool.prototype.doDeactivate=function(){go.Tool.prototype.doDeactivate.call(this);this.stopTransaction()};PortShiftingTool.prototype.doStop=function(){this.port.setAutoLock(!0);this.port=null;this.pos=null;go.Tool.prototype.doStop.call(this)};PortShiftingTool.prototype.doCancel=function(){null!==this.port&&this.port.setPortPos(this.pos.row,this.pos.col);go.Tool.prototype.doCancel.call(this)};PortShiftingTool.prototype.doMouseMove=function(){if(this.isActive){this.updatePosition();null!=this.labelLayoutTool&&this.labelLayoutTool.LayOut(this.diagram)}};PortShiftingTool.prototype.doMouseUp=function(){if(this.isActive){this.updatePosition(!0);this.transactionResult="Shifted Port";this.stopTool()}};PortShiftingTool.prototype.updatePosition=function(all){if(null!==this.port){var device=this.port.getDevice();var pos=device.getMostFitPortPos(this.port,this.diagram.lastInput.documentPoint);if(all){var port=device.getPort(pos.row,pos.col).first();port&&port.setPortPos(this.pos.row,this.pos.col);this.port.setPortPos(pos.row,pos.col)}else{this.port.setPortPos(pos.row,pos.col,!0)}}};netBrain.Map=netBrain.Map||{};netBrain.Map.PortShiftingTool=PortShiftingTool}(NetBrain);!function(netBrain){var CustomizeLinkReshapingTool=function(){go.LinkReshapingTool.call(this);this.labelLayoutTool=new netBrain.Map.LinkLableLayoutTool};go.Diagram.inherit(CustomizeLinkReshapingTool,go.LinkReshapingTool);CustomizeLinkReshapingTool.prototype.doMouseMove=function(){go.LinkReshapingTool.prototype.doMouseMove.call(this);null!=this.labelLayoutTool&&this.labelLayoutTool.LayOut(this.diagram)};CustomizeLinkReshapingTool.prototype.updateAdornments=function(part){if(null!=part&&null!=part.data&&part.data.category===netBrain.Map.CompLine.getVarCategory()){if(part.isSelected&&!this.diagram.isReadOnly){var selelt=part.path;if(null!==selelt&&part.canReshape()&&part.actualBounds.isReal()&&part.isVisible()&&selelt.actualBounds.isReal()&&selelt.isVisibleObject()){var adornment=part.findAdornment(this.name);if(null===adornment){(adornment=new go.Adornment).type=go.Panel.Link;adornment.category=this.name;var h0=this.handleArchetype.copy();if(null!=h0){h0.segmentIndex=0;h0.cursor="move";adornment.add(h0)}var h1=this.handleArchetype.copy();if(null!=h1){h1.segmentIndex=1;h1.cursor="move";adornment.add(h1)}adornment.category=this.name;adornment.adornedObject=selelt;part.addAdornment(this.name,adornment)}if(null!=adornment){adornment.location=part.position;return}}}part.removeAdornment(this.name)}else go.LinkReshapingTool.prototype.updateAdornments.call(this,part)};CustomizeLinkReshapingTool.prototype.computeReshape=function(p){return p};CustomizeLinkReshapingTool.prototype.reshape=function(newPoint){var link=this.adornedLink;if(link&&netBrain.Map.CategoryMgr.isPathLink(link.category))this.reshapeTracePath(newPoint);else if(null!==link&&null!=link.data&&link.data.category===netBrain.Map.CompLine.getVarCategory()){var index=this.handle.segmentIndex;link.startRoute();link.setPointAt(index,newPoint.x,newPoint.y);link.commitRoute()}else go.LinkReshapingTool.prototype.reshape.call(this,newPoint)};CustomizeLinkReshapingTool.prototype.makeAdornment=function(pathshape){var adornment=go.LinkReshapingTool.prototype.makeAdornment.call(this,pathshape);var part=pathshape.part;if(part&&netBrain.Map.CategoryMgr.isPathLink(part.category)){var hoplist=NgUtil.getValueFromObjAndPath(part,"data.hoplist");var isAllHopsVisible=!_.find(hoplist,(function(item){return!0===item.isHide}));var removeIndexes=new go.Set;var count=adornment.elements.count;if(hoplist.length>0&&!isAllHopsVisible){var hop0=part.data.getSubHops(0);if(hop0._tmpDrawPoints)for(var removeIndex=hop0._tmpDrawPoints.length-2;removeIndex<count;removeIndex++)removeIndexes.add(removeIndex)}for(removeIndex=0;removeIndex<count;removeIndex++)removeIndex%3==2&&removeIndexes.add(removeIndex);var tmpPtLen=0;for(var i=0,len=isAllHopsVisible?hoplist.length:1;i<len;i++){var tmpPoints=hoplist[i]._tmpDrawPoints;if(tmpPoints&&!(tmpPoints.length<4)){tmpPtLen+=tmpPoints.length+(0===i?0:2);if(i!==len-1){var nextPoints=hoplist[i+1]._tmpDrawPoints;if(!nextPoints||nextPoints.length<4)continue;removeIndexes.add(tmpPtLen-1-1+1);removeIndexes.add(tmpPtLen-1-1+2)}}}(removeIndexes=removeIndexes.toArray()).sort((function(a,b){return a-b}));for(var i2=removeIndexes.length-1;i2>=0;i2--)adornment.removeAt(removeIndexes[i2])}return adornment};CustomizeLinkReshapingTool.prototype.reshapeTracePath=function(newPoint){var link=this.adornedLink;link.startRoute();var index=this.handle.segmentIndex;link.setPointAt(index,newPoint.x,newPoint.y);if(link.data){var linkObj=link.data.getCustomPoints(0);linkObj[index]=new go.Point(newPoint.x,newPoint.y);link.data.setCustomPoints(0,linkObj);link.makeSubPaths(link)}link.commitRoute()};netBrain.Map=netBrain.Map||{};netBrain.Map.CustomizeLinkReshapingTool=CustomizeLinkReshapingTool}(NetBrain);!function(netBrain){var CategoryMgr=function(){};CategoryMgr.NetworkDevice="NetworkDevice";CategoryMgr.Stencil="stencil";CategoryMgr.StencilExt="stencilExt";CategoryMgr.L2Device="L2Device";CategoryMgr.L2Port="L2Port";CategoryMgr.Media="Media";CategoryMgr.Terminal="Terminal";CategoryMgr.UnknownIp="UnknownIp";CategoryMgr.MuteLan="MuteLan";CategoryMgr.Note="Note";CategoryMgr.Site="Site";CategoryMgr.Cluter="Cluster";CategoryMgr.DeviceNote="DeviceNote";CategoryMgr.VirtualNode="VirtualNode";CategoryMgr.VirtualGroupNode="VirtualGroupNode";CategoryMgr.Rect="Rect";CategoryMgr.Ellipse="Ellipse";CategoryMgr.Circle="Circle";CategoryMgr.Polygon="Polygon";CategoryMgr.Line="Line";CategoryMgr.Arrow="Arrow";CategoryMgr.CloseArea="CloseArea";CategoryMgr.CloseCloud="CloseCloud";CategoryMgr.Curve="Curve";CategoryMgr.Table="Table";CategoryMgr.Text="RichText";CategoryMgr.Textbox="Textbox";CategoryMgr.CallOut="CallOutText";CategoryMgr.TopoLink="TopoLink";CategoryMgr.L2TopoLink="L2TopoLink";CategoryMgr.CompCallOutLink="CallOutLink";CategoryMgr.Path="Path";CategoryMgr.PathNew="PathNew";CategoryMgr.TracePath="TracePath";CategoryMgr.HighlightNeighborLink="HighlightNeighborLink";CategoryMgr.HopLink="HopLink";CategoryMgr.NormalLink="NormalLink";CategoryMgr.VirtualTopoLink="VirtualTopoLink";CategoryMgr.HyperLink="HyperLink";CategoryMgr.DeviceNoteLink="DeviceNoteLink";CategoryMgr.SimpleLink="SimpleLink";CategoryMgr.isTopolink=function(category){return category===CategoryMgr.TopoLink||category===CategoryMgr.L2TopoLink||category===CategoryMgr.VirtualTopoLink};CategoryMgr.isNormalLink=function(category){return category===CategoryMgr.NormalLink};CategoryMgr.isDeviceCategory=function(category){return!(!CategoryMgr.isNetworkDevice(category)&&category!=CategoryMgr.UnknownIp)};CategoryMgr.isDeviceTemplate=function(category){return category===CategoryMgr.NetworkDevice||category===CategoryMgr.Media||category===CategoryMgr.UnknownIp||category===CategoryMgr.Stencil||category===CategoryMgr.L2Device};CategoryMgr.isNetworkDevice=function(category){return category==CategoryMgr.NetworkDevice||category==CategoryMgr.L2Device||category==CategoryMgr.VirtualNode};CategoryMgr.isMedia=function(category){return category===CategoryMgr.Media};CategoryMgr.isSite=function(category){return category===CategoryMgr.Site};CategoryMgr.isCluter=function(category){return category===CategoryMgr.Cluter};CategoryMgr.isPath=function(category){return category===CategoryMgr.PathNew};CategoryMgr.isPathLink=function(category){return category===CategoryMgr.PathNew||category===CategoryMgr.TracePath};CategoryMgr.isNote=function(category){return category===CategoryMgr.Note};CategoryMgr.isDeviceNote=function(category){return category===CategoryMgr.DeviceNote};CategoryMgr.isDeviceNoteOrNote=function(category){return CategoryMgr.isDeviceNote(category)||CategoryMgr.isNote(category)};CategoryMgr.isRichText=function(category){return category===CategoryMgr.Text};CategoryMgr.isOtherShapesCategory=function(category){var categoryArr=[CategoryMgr.Rect,CategoryMgr.Ellipse,CategoryMgr.Circle,CategoryMgr.Polygon,CategoryMgr.Line,CategoryMgr.Arrow,CategoryMgr.CloseArea,CategoryMgr.CloseCloud,CategoryMgr.Curve,CategoryMgr.Table,CategoryMgr.Text,CategoryMgr.CallOut];return-1!==_.indexOf(categoryArr,category)};CategoryMgr.isLineCustomizedShape=function(graphObj){return null!=graphObj&&graphObj.category===CategoryMgr.Line};CategoryMgr.isCommonCustomizedShape=function(graphObj){return null!=graphObj&&[CategoryMgr.Rect,CategoryMgr.Ellipse,CategoryMgr.Circle,CategoryMgr.Polygon,CategoryMgr.CloseArea,CategoryMgr.CloseCloud,CategoryMgr.Curve,CategoryMgr.Text].indexOf(graphObj.category)>=0};CategoryMgr.isClosedCustomizedShape=function(graphObj){return null!=graphObj&&[CategoryMgr.Rect,CategoryMgr.Ellipse,CategoryMgr.Circle,CategoryMgr.Polygon,CategoryMgr.CloseArea,CategoryMgr.CloseCloud,CategoryMgr.Text].indexOf(graphObj.category)>=0};CategoryMgr.isCustomizedShape=function(graphObj){return null!=graphObj&&[CategoryMgr.Rect,CategoryMgr.Ellipse,CategoryMgr.Circle,CategoryMgr.Line,CategoryMgr.Polygon,CategoryMgr.CloseArea,CategoryMgr.CloseCloud,CategoryMgr.Curve,CategoryMgr.Text].indexOf(graphObj.category)>=0};CategoryMgr.isHighlightLink=function(category){return category===CategoryMgr.HighlightNeighborLink||category===CategoryMgr.HopLink};CategoryMgr.isHighlightNeighborLink=function(category){return category===CategoryMgr.HighlightNeighborLink};CategoryMgr.isNormalLink=function(category){return category===CategoryMgr.NormalLink};CategoryMgr.isLineShape=function(category){return category===CategoryMgr.Line};CategoryMgr.isSelectedEditable=function(category){return CategoryMgr.isRealNote(category)||CategoryMgr.isOtherShapesCategory(category)};CategoryMgr.isStencilDevice=function(category){return category===CategoryMgr.Stencil||category===CategoryMgr.StencilExt};CategoryMgr.isRealNote=function(category){return CategoryMgr.isNote(category)||CategoryMgr.isDeviceNote(category)||CategoryMgr.isRichText(category)};CategoryMgr.isLink=function(category){var isLink=CategoryMgr.isTopolink(category)||CategoryMgr.isPathLink(category)||CategoryMgr.isHighlightLink(category)||CategoryMgr.isHighlightNeighborLink(category)||CategoryMgr.isNormalLink(category);var isLineShape=CategoryMgr.isLineShape(category);return isLink||isLineShape};CategoryMgr.isCloseArea=function(category){return category===CategoryMgr.CloseArea};CategoryMgr.isCustomizableLink=function(category){return CategoryMgr.isTopolink(category)||CategoryMgr.isPathLink(category)};netBrain.Map=netBrain.Map||{};netBrain.Map.CategoryMgr=CategoryMgr}(NetBrain);!function(netBrain){var graphicTypeMgr={};graphicTypeMgr.getFilterNodesFunction=function(partData){if(!partData)throw new Error("parameter error.");var CategoryMgr=netBrain.Map.CategoryMgr;var partCategory=partData.category;return CategoryMgr.isSite(partCategory)?buildFun(partData,["category"]):CategoryMgr.isCluter(partCategory)?buildFun(partData,["category"]):CategoryMgr.isNetworkDevice(partCategory)?buildFun(partData,["category","devType"]):CategoryMgr.isMedia(partCategory)?buildFun(partData,["category","devType"]):CategoryMgr.isStencilDevice(partCategory)?function(tmpNode){var flag=CategoryMgr.isStencilDevice(tmpNode.category);if(flag){flag=BindHelper.toTarget_device_source(tmpNode.dataViewData)===BindHelper.toTarget_device_source(partData.dataViewData)}return flag}:CategoryMgr.isOtherShapesCategory(partCategory)&&!CategoryMgr.isRichText(partCategory)?CategoryMgr.isCloseArea(partCategory)?buildFun(partData,["category","closeAreaType"]):buildFun(partData,["category"]):CategoryMgr.isRealNote(partCategory)?function(tmpNode){return CategoryMgr.isRealNote(tmpNode.category)}:buildFun(partData,["category"])};graphicTypeMgr.getFilterLinksFunction=function(partData){if(!partData)throw new Error("parameter error.");var CategoryMgr=netBrain.Map.CategoryMgr;return CategoryMgr.isPathLink(partData.category)?function(tmpLink){return CategoryMgr.isPathLink(tmpLink.category)}:buildFun(partData,["category"])};function buildFun(partData,props){return function(tmpNode){return _.every(props,(function(prop){return tmpNode[prop]===partData[prop]}))}}netBrain.Map=netBrain.Map||{};netBrain.Map.graphicTypeMgr=graphicTypeMgr}(NetBrain);!function(netBrain){function ComputePathManager(netmap,netmapOperator){this.netmap=netmap;this.netmapOperator=netmapOperator;this.diagram=null;null!=this.netmap&&(this.diagram=this.netmap._diagram);this.pathLayout=new PathLayoutTool({cx:0,cy:0});this.tmpGuid={};this.md5Service=null}ComputePathManager.prototype.setNetMap=function(netMap){if(null!=netMap){this.netmap=netMap;this.diagram=this.netmap._diagram}};ComputePathManager.prototype.setMD5Service=function(md5Service){this.md5Service=md5Service};ComputePathManager.prototype.isUnknownIp=function(oneHopDev){return null!=oneHopDev&&(!!NgUtil.isValidID(oneHopDev._id)&&1036===oneHopDev.devType)};ComputePathManager.prototype.getUnknowDevLinkInfo=function(jsDataViews,fromDevHop,toDevHop,fromEdgeHop,toEdgeHop,mediaHop){if(null==fromDevHop||null==toDevHop||null==fromEdgeHop||null==toEdgeHop)return null;var retLinkInfo=null;var fromDevId=fromDevHop.devId;var fromEdgeId=fromEdgeHop._id;var toDevId=toDevHop.devId;var toEdgeId=toEdgeHop._id;var mediaId=mediaHop.id;var srcDevType=fromDevHop.devType;var destDevType=toDevHop.devType;var srcHostName=fromDevHop.devName;var destHostName=toDevHop.devName;var bSrcNetworkDev=gDeviceMainTypeMgr.isNetworkDeviceByDevType(srcDevType);var bDestNetworkDev=gDeviceMainTypeMgr.isNetworkDeviceByDevType(destDevType);if(bSrcNetworkDev&&bDestNetworkDev)return retLinkInfo;var srcDataView=DataViewHelper.getDevDataViewByKey(jsDataViews,fromDevId);var destDataView=DataViewHelper.getDevDataViewByKey(jsDataViews,toDevId);if(bSrcNetworkDev&&null==srcDataView)return null;if(bDestNetworkDev&&null==destDataView)return null;var mediaInfo;if(bSrcNetworkDev){if(null==srcDataView)return retLinkInfo;var srcEdge=DataViewHelper.getEdgeByEdgeId(srcDataView,fromDevId,fromEdgeId);if(null==srcEdge||null==srcEdge.EdgeInfo)return retLinkInfo;retLinkInfo={neighborInfo:null,dataViewInfo:null};mediaInfo=mediaHop.mediaInfo;null!=mediaId&&null==mediaInfo&&(mediaInfo={mediaName:"0.0.0.0/32",mediaType:"Lan"});retLinkInfo.neighborInfo=new CNeighborInfo(fromDevId,toDevId,srcEdge.EdgeInfo,null,null,null==mediaId,mediaId,mediaInfo,srcDevType,destDevType,srcHostName,destHostName);retLinkInfo.dataViewInfo=srcEdge.dataViewInfo}else if(bDestNetworkDev){if(null==bDestNetworkDev)return retLinkInfo;var destEdge=DataViewHelper.getEdgeByEdgeId(destDataView,toDevId,toEdgeId);if(null==destEdge||null==destEdge.EdgeInfo)return retLinkInfo;mediaInfo=mediaHop.mediaInfo;null!=mediaId&&null==mediaInfo&&(mediaInfo={mediaName:"0.0.0.0/32",mediaType:"Lan"});(retLinkInfo={neighborInfo:null,dataViewInfo:null}).neighborInfo=new CNeighborInfo(fromDevId,toDevId,null,destEdge.EdgeInfo,null,null==mediaId,mediaId,mediaInfo,srcDevType,destDevType,srcHostName,destHostName);retLinkInfo.dataViewInfo=destEdge.dataViewInfo}return retLinkInfo};ComputePathManager.prototype.getLinkInfo=function(nodeDataView,fromDevId,toDevId,fromEdgeInfo,toEdgeInfo,mediaId){var retLinkInfo=null;if(null==nodeDataView||null==fromDevId||null==toDevId||null==fromEdgeInfo||null==toEdgeInfo)return null;var context=this;nodeDataView.viewList.forEach((function(oneDevDataView){if(null!=oneDevDataView){var dataViewInfo=oneDevDataView.viewInfo;oneDevDataView.edgeList.forEach((function(oneEdgeInfo){if(null!=oneEdgeInfo){var srcEdgeValue=JSON.parse(oneEdgeInfo.srcEdge.edgeValue);srcEdgeValue._id===fromDevId&&context.isEdgeInfoEqual(srcEdgeValue,fromEdgeInfo)&&oneEdgeInfo.nbrList.forEach((function(nbr){if(null!=nbr&&nbr.destDev===toDevId&&(null==mediaId||""===mediaId||nbr.mediaId===mediaId)){var destEdgeValue=JSON.parse(nbr.destEdge.edgeValue);if(context.isEdgeInfoEqual(destEdgeValue,toEdgeInfo)){(retLinkInfo={neighborInfo:null,dataViewInfo:null}).neighborInfo=new CNeighborInfo(fromDevId,toDevId,oneEdgeInfo.srcEdge,nbr.destEdge,nbr.topoType,nbr.isP2P,nbr.mediaId,nbr.mediaInfo);retLinkInfo.dataViewInfo=dataViewInfo}}}))}}))}}));return retLinkInfo};ComputePathManager.prototype.isNodeInArray=function(nodeArray,node){if(!(null==nodeArray||nodeArray.length<=0)){for(var index=0;index<nodeArray.length;index++){if(nodeArray[index].StrName===node.StrName)return!0}return!1}};ComputePathManager.prototype.computePathLayout=function(existedNodeArray,pathNodeArray,willInsertNodeKeyArray,path){this.pathLayout.setWillInsertNodeKeys(willInsertNodeKeyArray);if(null!=this.diagram){var rectViewBounds=this.diagram.viewportBounds;var mapSize={cx:rectViewBounds.width,cy:rectViewBounds.height};this.pathLayout.setMapSize(mapSize);this.pathLayout.LayoutPath(existedNodeArray,pathNodeArray,path)}};ComputePathManager.prototype.ResetNodePositionAfterLayout=function(existedNodeArray,pathNodeArray,willInsertNodeKeyArray,path){var transactionName=NgUtil.getUniqueStr("ResetNodePositionAfterLayout");this.netmap._diagram.startTransaction(transactionName);for(var nIndex=0;nIndex<willInsertNodeKeyArray.length;nIndex++){var key=willInsertNodeKeyArray[nIndex];if(null!=key)for(var pathNodeIndex=0;pathNodeIndex<pathNodeArray.length;pathNodeIndex++){var pathNode=pathNodeArray[pathNodeIndex];if(null!=pathNode&&pathNode.StrName===key){var nodeObj=this.diagram.findNodeForKey(key);if(null!=nodeObj){var location=pathNode.PtPosition;null!=location&&(nodeObj.location=location)}}}}this.netmap._diagram.commitTransaction(transactionName)};ComputePathManager.prototype.isEdgeInfoEqual=function(edgeInfo1,edgeInfo2){if(null==edgeInfo1||null==edgeInfo2)return!1;if(null!=edgeInfo1.intfs&&null!=edgeInfo2.intfs)for(var outIndex=0;outIndex<edgeInfo1.intfs.length;outIndex++){var outInf=edgeInfo1.intfs[outIndex];if(null!=outInf)for(var inIndex=0;inIndex<edgeInfo2.intfs.length;inIndex++){var inInf=edgeInfo2.intfs[inIndex];if(null!=inInf&&outInf._id===inInf._id)return!0}}return!1};ComputePathManager.prototype.addUnLinkDevAndMedia=function(strTopoType,allDataView,fromHop,media,toHop,exceptNodeKeyArray){if(null==strTopoType||null==allDataView||null==fromHop)return null;var fromDevKey=fromHop.devId;var srcDevType=fromHop.devType;var srcHostName=fromHop.devName;var dataViewId="";TopoTypeManager.isL3Topo(strTopoType)?dataViewId=DataViewUtil.getL3DataViewId():TopoTypeManager.isL2Topo(strTopoType)&&(dataViewId=DataViewUtil.getL2DataViewId());if(null!=dataViewId){var tmpFromKey=null;var bDrawMedia=!1;if(gDeviceMainTypeMgr.isUnknownIp(srcDevType)){var fromGuid=this.getUnknownDevGuid(srcHostName);if(null==this.diagram.findNodeForKey(fromGuid)){this.netmapOperator.addUnknownIp(srcHostName,fromDevKey);exceptNodeKeyArray.push(fromDevKey);tmpFromKey=fromDevKey;bDrawMedia=!0}}else if(gDeviceMainTypeMgr.isMedia(srcDevType))bDrawMedia=!0;else{var oneDevDataView=this.getDevDataViewByKey(allDataView,fromDevKey);if(null!=oneDevDataView&&oneDevDataView.key===fromDevKey){if(null==this.diagram.findNodeForKey(fromDevKey)){var compDev=_getCompDeviceByKey(allDataView,dataViewId,fromDevKey);if(null!=compDev){this.netmap.addDevice(compDev,oneDevDataView);exceptNodeKeyArray.push(fromDevKey);bDrawMedia=!0}}}}var toDevKey=toHop.devId;var toDevType=toHop.devType;var toHostName=toHop.devName;var tmpToKey=null;if(gDeviceMainTypeMgr.isUnknownIp(toDevType)){var toGuid=this.getUnknownDevGuid(toHostName);if(null==this.diagram.findNodeForKey(toGuid)){this.netmapOperator.addUnknownIp(toHostName,toDevKey);exceptNodeKeyArray.push(toDevKey);tmpToKey=toDevKey;bDrawMedia=!0}}else if(gDeviceMainTypeMgr.isMedia(toDevType))bDrawMedia=!0;else{var oneToDevDataView=this.getDevDataViewByKey(allDataView,toDevKey);if(oneToDevDataView.key===toDevKey&&null==this.diagram.findNodeForKey(toDevKey)){var toCompDev=_getCompDeviceByKey(allDataView,dataViewId,toDevKey);if(null!=toCompDev){this.netmap.addDevice(toCompDev,oneToDevDataView);exceptNodeKeyArray.push(toDevKey);bDrawMedia=!0}}}var tmpMediaKey=null;if(null!=media||1==bDrawMedia){var mediaKey=media.id;if(null==this.diagram.findNodeForKey(mediaKey)&&null!=media.mediaInfo){var mediaType=media.mediaInfo.mediaType;var topoType=media.mediaInfo.topoType;var hostName=media.mediaInfo.mediaName;var mediaDevComp=this.netmapOperator._buildCompMediaByInfo(hostName,mediaKey,mediaType,topoType);if(null!=mediaDevComp){this.netmap._addNode(mediaDevComp);exceptNodeKeyArray.push(mediaKey);tmpMediaKey=mediaKey}}}null!=tmpFromKey&&null!=tmpMediaKey&&this.netmapOperator.addNormallink(tmpFromKey,tmpMediaKey);null!=tmpMediaKey&&null!=tmpToKey&&this.netmapOperator.addNormallink(tmpMediaKey,tmpToKey)}};ComputePathManager.addPathHistoryInfo=function(nodeDev){null!=nodeDev&&nodeDev.category===netBrain.Map.CategoryMgr.NetworkDevice&&ComputePathManager.addWarnPicForNode(nodeDev)};ComputePathManager.addWarnPicForNode=function(nodeDev){if(null!=nodeDev){var $=go.GraphObject.make;var picPanel=nodeDev.findObject("picturePanel");if(null!=picPanel){var pathHistoryPicObj=$(go.Picture,{name:"pathHistory",source:"img/pathHistoryInfo.png",desiredSize:new go.Size(18,18),alignment:new go.Spot(0,.5,0,0),alignmentFocus:go.Spot.Center,mouseEnter:function(event,target){}});picPanel.add(pathHistoryPicObj)}}};ComputePathManager.prototype.getAllNeighborInfos=function(data){var neighborInfos=[];var info;if(null!=data.hoplist){_.each(data.hoplist,(function(subPath){_.each(subPath.hops,(function(link){var info={intf:link.fromIntf,id:link.fromDev.devId,name:link.fromDev.devName,devId:link.fromDev.devId,devType:link.fromDev.devType,nbrIntf:link.toIntf,nbrId:link.toDev.devId,nbrDevType:link.toDev.devType,nbrName:link.toDev.devName,nbrDevId:link.toDev.devId,mediaId:link.mediaId,mediaInfo:link.mediaInfo,topoTypeId:link.topoType,isP2P:link.isP2P};info.mediaInfo=info.mediaInfo||{};info.mediaInfo.mediaId=link.mediaId;info.nbrId&&neighborInfos.push(info)}))}));if(!data.isRunning&&data.hoplist.length>0){var subPath0=data.hoplist[0];if(null!=subPath0.hops&&subPath0.hops.length>0){var link=subPath0.hops[subPath0.hops.length-1];var toDevId;var toDevName;var toDevType;toDevId=data.toDev.ID;toDevName=data.toDev.devName;toDevType=data.toDev.devType;if(null==link.toDev.devId||""===link.toDev.devId){if(link.fromDev.devId!==toDevId){info={intf:null,id:link.fromDev.devId,name:link.fromDev.devName,devId:link.fromDev.devId,devType:link.fromDev.devType,nbrIntf:null,nbrId:toDevId,nbrName:toDevName,nbrDevId:toDevId,nbrDevType:toDevType,mediaId:null,mediaInfo:null,topoTypeId:link.topoType,isP2P:!1};data.isComplete||neighborInfos.push(info)}}else link.toDev.devId!==toDevId&&(info={intf:null,id:link.toDev.devId,name:link.toDev.devName,devId:link.toDev.devId,devType:link.toDev.devType,nbrIntf:null,nbrId:toDevId,nbrName:toDevName,nbrDevId:toDevId,nbrDevType:toDevType,mediaId:null,mediaInfo:null,topoTypeId:link.topoType,isP2P:!1}).nbrId&&!data.isComplete&&neighborInfos.push(info)}}}return neighborInfos};ComputePathManager.prototype.drawHopListByCategory=function(dataViewCacheSrvc,data,category,randomColorSrvc,applyDataViewSrvc,autoLinkOptionSrvc,httpExternNbrSrvc){var netmapOperator=this.netmapOperator;var transactionName=NgUtil.getUniqueStr("drawHopListByCategory");netmapOperator.startTransaction(transactionName);this.AddHopsForPathLayout(data);var context=this;var neighborInfos=this.getAllNeighborInfos(data);var promise=null;if(0==neighborInfos.length){if(!data.fromDev||!data.toDev){netmapOperator.commitTransaction(transactionName);return}data.fromDev.id=data.fromDev.ID;data.toDev.id=data.toDev.ID;var deivceList=[data.fromDev,data.toDev];promise=this.netmapOperator.dropDeviceByDragDeviceData(deivceList,null,null,httpExternNbrSrvc,autoLinkOptionSrvc,dataViewCacheSrvc,null,applyDataViewSrvc)}else promise=this.netmapOperator.extendNeighbors(neighborInfos);null!=promise?promise.then((function(){context.computePathLayout(context.existedNodeArray,context.pathNodeArray,context.willInsertNodeKeyArray,data);context.ResetNodePositionAfterLayout(context.existedNodeArray,context.pathNodeArray,context.willInsertNodeKeyArray,data);var netmap=context.netmap;null!=netmap&&netmap.refreshMapViewOptionVisible();var compPath=NgUtil.cloneJson(data);compPath.category=category;netBrain.Map.CompPrototypeFactory.buildCompPrototype(compPath);var path;var i;var list=context.netmapOperator.getAllPaths();var useredColor=[];if(null!=list)for(i=0;i<list.length;i++)(path=list[i]).getColor()&&useredColor.push(path.getColor());var oldColor=-1;if(null!=(list=context.netmapOperator.getPathsByTaskId(compPath.getTaskId())))for(i=0;i<list.length;i++)if((path=list[i]).getKey()===compPath.getKey()){oldColor=path.getColor();break}var newColor=randomColorSrvc.parseColor(oldColor,"pathColor",void 0,void 0,useredColor);compPath.setColor(newColor);1===compPath.routingScheme&&compPath.setType(compPath.isLivePath()?netBrain.Map.Const.LinkType.DashDot:netBrain.Map.Const.LinkType.Dot);0===compPath.routingScheme&&compPath.setType(compPath.isLivePath()?netBrain.Map.Const.LinkType.Dash:netBrain.Map.Const.LinkType.Solid);netmapOperator.updatePath(compPath);netmapOperator.commitTransaction(transactionName);context.cachePathInfo(data,context.willInsertNodeKeyArray);compPath.to;if(data.drawMapDataList&&data.drawMapDataList.length>0){var newData={drawMapFunctions:data.drawMapDataList};netmapOperator.getRootScope().$broadcast("updateMapViewFunc",newData)}setTimeout((function(){netmapOperator.showPathABByPathId(compPath.pathId)}),80)})):netmapOperator.commitTransaction(transactionName);return promise};ComputePathManager.prototype.AddHopsForPathLayout=function(data){var exceptNodeKeyArray=[];this.existedNodeArray=[];this.pathNodeArray=[];this.willInsertNodeKeyArray=[];var _this=this;null!=data.hoplist&&_.each(data.hoplist,(function(subPath){_.each(subPath.hops,(function(link){_this.AddOneHopForPathLayout(link.fromDev.devId,link.toDev.devId,link.mediaId,_this.existedNodeArray,_this.pathNodeArray,_this.willInsertNodeKeyArray,exceptNodeKeyArray)}))}));if(!data.isRunning){var toDevId="";data.toDev&&(toDevId=data.toDev.ID);toDevId&&this.AddOneHopForPathLayout(null,toDevId,null,this.existedNodeArray,this.pathNodeArray,this.willInsertNodeKeyArray,exceptNodeKeyArray)}};ComputePathManager.prototype.AddOneHopForPathLayout=function(fromDevKey,toDevKey,mediaKey,existedNodeArray,pathNodeArray,willInsertNodeKeyArray,removeExistNodeKeyArray){if(null!=this.diagram){var fromDevObj=null;var toDevObj=null;var mediaObj=null;var onePathNode;var existedNod;null!=fromDevKey&&(fromDevObj=this.diagram.findNodeForKey(fromDevKey));null!=toDevKey&&(toDevObj=this.diagram.findNodeForKey(toDevKey));null!=mediaKey&&(mediaObj=this.diagram.findNodeForKey(mediaKey));if(null!=fromDevObj){existedNod=new ExistNode(fromDevKey,fromDevObj.location);this.isNodeInArray(existedNodeArray,existedNod)||existedNodeArray.push(existedNod);(onePathNode=new PathNode(fromDevKey,fromDevObj.location,0)).isDevice=!0;this.isNodeInArray(pathNodeArray,onePathNode)||pathNodeArray.push(onePathNode)}else{(onePathNode=new PathNode(fromDevKey,null,0)).isDevice=!0;this.isNodeInArray(pathNodeArray,onePathNode)||pathNodeArray.push(onePathNode);-1===willInsertNodeKeyArray.indexOf(fromDevKey)&&willInsertNodeKeyArray.push(fromDevKey)}if(null!=mediaObj){existedNod=new ExistNode(mediaKey,mediaObj.location);this.isNodeInArray(existedNodeArray,existedNod)||existedNodeArray.push(existedNod);(onePathNode=new PathNode(mediaKey,mediaObj.location,0)).isDevice=!1;this.isNodeInArray(pathNodeArray,onePathNode)||pathNodeArray.push(onePathNode)}else if(null!=mediaKey){(onePathNode=new PathNode(mediaKey,null,0)).isDevice=!1;this.isNodeInArray(pathNodeArray,onePathNode)||pathNodeArray.push(onePathNode);-1===willInsertNodeKeyArray.indexOf(mediaKey)&&willInsertNodeKeyArray.push(mediaKey)}if(null!=toDevObj){existedNod=new ExistNode(toDevKey,toDevObj.location);this.isNodeInArray(existedNodeArray,existedNod)||existedNodeArray.push(existedNod);(onePathNode=new PathNode(toDevKey,toDevObj.location,0)).isDevice=!0;this.isNodeInArray(pathNodeArray,onePathNode)||pathNodeArray.push(onePathNode)}else{(onePathNode=new PathNode(toDevKey,null,0)).isDevice=!0;this.isNodeInArray(pathNodeArray,onePathNode)||pathNodeArray.push(onePathNode);-1===willInsertNodeKeyArray.indexOf(toDevKey)&&willInsertNodeKeyArray.push(toDevKey)}for(var i=existedNodeArray.length-1;i>=0;i--)for(var j=0;j<removeExistNodeKeyArray.length;j++){var oneNodeObj=existedNodeArray[i];var removeNodeKey=removeExistNodeKeyArray[j];null!=oneNodeObj&&null!=removeNodeKey&&(removeNodeKey===oneNodeObj.StrName&&existedNodeArray.splice(i,1))}}};ComputePathManager.prototype.receiveHopListNew=function(dataViewCacheSrvc,data,randomColorSrvc,applyDataViewSrvc,autoLinkOptionSrvc,httpExternNbrSrvc){console.log(data);return this.drawHopListByCategory(dataViewCacheSrvc,data,netBrain.Map.CategoryMgr.PathNew,randomColorSrvc,applyDataViewSrvc,autoLinkOptionSrvc,httpExternNbrSrvc)};ComputePathManager.prototype.receiveTraceHopListNew=function(dataViewCacheSrvc,data,randomColorSrvc,applyDataViewSrvc,autoLinkOptionSrvc,httpExternNbrSrvc){console.log(data);this.beginMapPathTransaction();this.drawHopListByCategory(dataViewCacheSrvc,data,netBrain.Map.CategoryMgr.TracePath,randomColorSrvc,applyDataViewSrvc,autoLinkOptionSrvc,httpExternNbrSrvc)};ComputePathManager.prototype.beginMapPathTransaction=function(option){this.resetMapPathTransactionCache(option)};ComputePathManager.prototype.endMapPathTransaction=function(option){var netmap=this.netmap;var lastPathId=option.pathId;if(lastPathId){var diagram=netmap.getGoJsDiagram();var linkDataArray=diagram.model.linkDataArray;var pathData=_.find(linkDataArray,(function(item){return item.pathId===lastPathId}));var path=diagram.findLinkForData(pathData);this.netmapOperator.getDiagramPathManager().showPathAB(diagram,path)}};ComputePathManager.prototype.resetMapPathTransactionCache=function(option){var mapPathCache=Object.create(null);this.mapPathCache=mapPathCache};ComputePathManager.prototype.layoutPathsByCache=function(){var mapPathCache=this.mapPathCache;var netmap=this.netmap;if(netmap){var isL2Style=netmap.isL2MapStyle();var newNodes=function(mapPathCache){var newNodes=[];_.each(_.values(mapPathCache),(function(cachePathInfo){newNodes=newNodes.concat(cachePathInfo.addNewNodes)}));newNodes=_.filter(newNodes,_.identity);return newNodes=_.uniq(newNodes)}(mapPathCache);var options={newNodes:newNodes,paths:mapPathCache,isTwoWay:isTwoWay(mapPathCache),isL2Style:isL2Style};var diagram=this.diagram;diagram.startTransaction("pathLayout");NetBrain.TopoTools.layoutHelper.pathLayout(diagram,options);diagram.updateAllTargetBindings();if(isL2Style){var portInfos=netBrain.Map.L2PortsLayoutTool.getPortsInfoByDeviceKeys(newNodes,diagram);this.netmap.layoutL2Ports(portInfos)}(new netBrain.Map.LinkLableLayoutTool).LayOut(diagram);diagram.commitTransaction("pathLayout")}};ComputePathManager.prototype.cachePathInfo=function(path,addNodes){var mapPathCache=this.mapPathCache||{};var pathId=path.pathId;var pathCacheInfo=mapPathCache[pathId];var cacheArr=_.values(mapPathCache);if(pathCacheInfo){pathCacheInfo.path=path;pathCacheInfo.addNewNodes=pathCacheInfo.addNewNodes.concat(addNodes)}else if(0===cacheArr.length){(pathCacheInfo=mapPathCache[pathId]={addNewNodes:[]}).path=path;pathCacheInfo.addNewNodes=pathCacheInfo.addNewNodes.concat(addNodes)}else{var cachePath=cacheArr[0];cachePath.addNewNodes=cachePath.addNewNodes.concat(addNodes);cachePath.isTwoWay=!0}this.layoutPathsByCache()};function isTwoWay(mapPathCache){var flag=!1;var arr=_.values(mapPathCache);arr.length>1?flag=!0:1===arr.length&&(flag=arr[0].isTwoWay||!1);return flag}netBrain.Map=netBrain.Map||{};netBrain.Map.ComputePathManager=ComputePathManager}(NetBrain);function InDirector(){}InDirector.enumInDirect_NULL=-1;InDirector.enumInDirect_TopLeft=0;InDirector.enumInDirect_BottomLeft=1;InDirector.enumInDirect_TopRight=2;InDirector.enumInDirect_BottomRight=3;function OutDirector(){}OutDirector.enumOutDirect_NULL=-1;OutDirector.enumOutDirect_TopLeft=0;OutDirector.enumOutDirect_BottonLeft=1;OutDirector.enumOutDirect_TopRight=2;OutDirector.enumOutDirect_BottomRight=3;function ConstValue(){}ConstValue.RAND_MAX=32767;function ExistNode(strName,ptLocation){this.StrName=strName;this.PtPosition=ptLocation;this.next=null}function PathNode(strName,ptLocation,nType){this.PtPosition=ptLocation;this.NeedInsert=!0;this.StrName=strName;this.type=nType;this.next=null;this.strInDev="";this.strInInterface="";this.strOutDev="";this.strOutInterface="";this.isDevice=!1}function PathLayoutTool(size){this.m_MapSize=size;this.dAngle=ConstValue.Pi/8;this.dDistance=230;this.bLeftPos=!0;this.bTwoDirectPath=!1;this.willInsertNodeKeys=[]}PathLayoutTool.prototype.setMapSize=function(size){this.m_MapSize=size};PathLayoutTool.prototype.setWillInsertNodeKeys=function(willInsertNodeKeys){this.willInsertNodeKeys=willInsertNodeKeys};PathLayoutTool.prototype.getWillInsertNodeKeys=function(){return this.willInsertNodeKeys};PathLayoutTool.MAP_COMPONENT_SIZE=110;PathLayoutTool.MAP_COMPONENT_SIZE_2=1210;function CheckNodeDistance(point,bCheckNeedInsert){this.m_Point=point;this.m_bCheckNeedInsert=null==bCheckNeedInsert||bCheckNeedInsert}CheckNodeDistance.prototype.isPtInExistNodes=function(existNodesArray){if(null==existNodesArray)return!1;for(var index=0;index<existNodesArray.length;index++){var existNode=existNodesArray[index];if(null!=existNode&&Math.pow(this.m_Point.x-existNode.PtPosition.x,2)+Math.pow(this.m_Point.y-existNode.PtPosition.y,2)<PathLayoutTool.MAP_COMPONENT_SIZE_2)return!0}return!1};CheckNodeDistance.prototype.isPtInPathNodes=function(pathNodesArray){if(null==pathNodesArray)return!1;for(var index=0;index<pathNodesArray.length;index++){var pathNode=pathNodesArray[index];if(null!=pathNode&&((!this.m_bCheckNeedInsert||!pathNode.NeedInsert)&&Math.pow(this.m_Point.x-pathNode.PtPosition.x,2)+Math.pow(this.m_Point.y-pathNode.PtPosition.y,2)<PathLayout.MAP_COMPONENT_SIZE_2))return!0}return!1};PathLayoutTool.prototype.ArithmeticBeginNode=function(vecExistNode,vecPathNodes){if(vecPathNodes[0].NeedInsert){var bJudgePoint=!1;var nCount=0;var pTempPoint=new go.Point(100,100);var theta;for(;!bJudgePoint;){nCount++;bJudgePoint=!0;if(vecPathNodes[vecPathNodes.length-1].NeedInsert)if(this.bTwoDirectPath){pTempPoint.x=this.m_MapSize.cx/2+this.dDistance/2;pTempPoint.y=this.m_MapSize.cy/2;theta=2*ConstValue.Pi*Math.random();pTempPoint.x+=this.dDistance*Math.cos(theta);pTempPoint.y+=this.dDistance*Math.sin(theta)}else{pTempPoint.x=this.dDistance/2;pTempPoint.y=this.m_MapSize.cy/2;theta=2*ConstValue.Pi*Math.random();pTempPoint.x+=this.dDistance*Math.cos(theta);pTempPoint.y+=this.dDistance*Math.sin(theta)}else{pTempPoint.x=vecPathNodes[vecPathNodes.length-1].PtPosition.x;pTempPoint.y=vecPathNodes[vecPathNodes.length-1].PtPosition.y;theta=2*ConstValue.Pi*Math.random();pTempPoint.x+=(vecPathNodes.length-1)/2*this.dDistance*Math.cos(theta);pTempPoint.y+=(vecPathNodes.length-1)/2*this.dDistance*Math.sin(theta)}new CheckNodeDistance(pTempPoint).isPtInExistNodes(vecExistNode)&&(bJudgePoint=!1);if(bJudgePoint)for(var j=0;j<vecPathNodes.length-1;j++)if(!vecPathNodes[j].NeedInsert&&!vecPathNodes[j+1].NeedInsert&&!vecPathNodes[1].NeedInsert&&j>1&&this.Intersect(vecPathNodes[1].PtPosition,pTempPoint,vecPathNodes[j].PtPosition,vecPathNodes[j+1].PtPosition)){bJudgePoint=!1;break}if(nCount>200){pTempPoint.x<20&&(pTempPoint.x=20);pTempPoint.x>this.m_MapSize.cx-20&&(pTempPoint.x=this.m_MapSize.cx-20);pTempPoint.y<20&&(pTempPoint.y=20);pTempPoint.y>this.m_MapSize.cy-20&&(pTempPoint.y=this.m_MapSize.cy-20);bJudgePoint=!0}}vecPathNodes[0].PtPosition=pTempPoint;vecPathNodes[0].NeedInsert=!1}};PathLayoutTool.prototype.GetInDirect=function(pPointIn,pPointOut){var tmp1Pt=new go.Point(pPointIn.x,pPointIn.y);var tmp2Pt=new go.Point(pPointOut.x,pPointOut.y);var nTmpAngle=tmp1Pt.directionPoint(tmp2Pt);nTmpAngle>360&&(nTmpAngle%=360);var dAngle=this.ConvertAngle(nTmpAngle);return dAngle<ConstValue.Pi/2?InDirector.enumInDirect_TopLeft:dAngle<ConstValue.Pi?InDirector.enumInDirect_TopRight:dAngle<3*ConstValue.Pi/2?InDirector.enumInDirect_BottomRight:InDirector.enumInDirect_BottomLeft};PathLayoutTool.prototype.GetFirstNodeOutDirect=function(pPoint,mapSize){var pCenter=new go.Point(mapSize.cx/2,mapSize.cy/2);var nXDistance=pCenter.x-pPoint.x;var nYDistance=pCenter.y-pPoint.y;return nXDistance>0&&nYDistance>=0?OutDirector.enumOutDirect_BottonLeft:nXDistance>0&&nYDistance<0?OutDirector.enumOutDirect_TopLeft:nXDistance<=0&&nYDistance<0?OutDirector.enumOutDirect_BottomRight:OutDirector.enumOutDirect_TopRight};PathLayoutTool.prototype.ArithmetricNexNode=function(vecExistNode,vecPathNodes){var pPreHeadPoint=new go.Point(vecPathNodes[0].PtPosition.x,vecPathNodes[0].PtPosition.y);var pHeadPoint=new go.Point(vecPathNodes[0].PtPosition.x,vecPathNodes[0].PtPosition.y);var nModify=0;var j;for(j=1;j<vecPathNodes.length;j++){nModify=j;pPreHeadPoint=new go.Point(pHeadPoint.x,pHeadPoint.y);pHeadPoint=new go.Point(vecPathNodes[j-1].PtPosition.x,vecPathNodes[j-1].PtPosition.y);if(vecPathNodes[j].NeedInsert)break}var nInDirect;nInDirect=pPreHeadPoint.x===pHeadPoint.x&&pPreHeadPoint.y===pHeadPoint.y?this.GetFirstNodeOutDirect(pHeadPoint,this.m_MapSize):this.GetInDirect(pPreHeadPoint,pHeadPoint);var bJudgePoint=!1;var nCount=0;var pTempPoint=new go.Point(100,100);for(;!bJudgePoint;){bJudgePoint=!0;this.GetNextNodePosition(this.dDistance,nInDirect,nCount++,pHeadPoint,pTempPoint);new CheckNodeDistance(pTempPoint).isPtInExistNodes(vecExistNode)&&(bJudgePoint=!1);if(bJudgePoint)for(j=0;j<vecPathNodes.length-1;j++)if(!vecPathNodes[j].NeedInsert&&!vecPathNodes[j+1].NeedInsert){if(nModify-1>0&&j!=nModify-1&&j+1!=nModify-1&&j!=nModify&&j+1!=nModify&&this.Intersect(vecPathNodes[nModify-1].PtPosition,pTempPoint,vecPathNodes[j].PtPosition,vecPathNodes[j+1].PtPosition)){bJudgePoint=!1;break}if(nModify+1<vecPathNodes.length&&!vecPathNodes[nModify+1].NeedInsert&&j!=nModify+1&&j+1!=nModify+1&&j!=nModify&&j+1!=nModify+1&&this.Intersect(vecPathNodes[nModify+1].PtPosition,pTempPoint,vecPathNodes[j].PtPosition,vecPathNodes[j+1].PtPosition)){bJudgePoint=!1;break}}if(nCount>3e3){pTempPoint.x<20&&(pTempPoint.x=20);pTempPoint.x>this.m_MapSize.cx-20&&(pTempPoint.x=this.m_MapSize.cx-20);pTempPoint.y<20&&(pTempPoint.y=20);pTempPoint.y>this.m_MapSize.cy-20&&(pTempPoint.y=this.m_MapSize.cy-20);bJudgePoint=!0}}vecPathNodes[nModify].PtPosition=pTempPoint;vecPathNodes[nModify].NeedInsert=!1};PathLayoutTool.prototype.GetNextNodePosition=function(nlength,nInDirect,nCount,PreNodePoint,pPoint){var dYDistance=nlength*Math.sin(this.dAngle);dYDistance+=.1*dYDistance;var nYAise;nYAise=nCount%2==0?dYDistance*(nCount+1):-1*dYDistance*nCount;var nXAise=nlength*Math.cos(this.dAngle);switch(nInDirect){case InDirector.enumInDirect_TopLeft:pPoint.x=PreNodePoint.x+nXAise;pPoint.y=PreNodePoint.y-nYAise;break;case InDirector.enumInDirect_BottomLeft:pPoint.x=PreNodePoint.x+nXAise;pPoint.y=PreNodePoint.y+nYAise;break;case InDirector.enumInDirect_TopRight:pPoint.x=PreNodePoint.x-nXAise;pPoint.y=PreNodePoint.y-nYAise;break;case InDirector.enumInDirect_BottomRight:pPoint.x=PreNodePoint.x-nXAise;pPoint.y=PreNodePoint.y+nYAise}};function isBalancePath(path){return path.hoplist&&path.hoplist.length>1}PathLayoutTool.prototype.LayoutPath=function(vecExistNode,vecPathNodes,path){if(!(isBalancePath(path)||vecPathNodes.length<2)){var ppathbool=[];var i;var j;for(i=0;i<vecPathNodes.length;i++)ppathbool[i]=!1;for(i=0;i<vecPathNodes.length;i++){vecPathNodes[i].NeedInsert=!0;vecPathNodes[i].PtPosition=new go.Point(0,0);ppathbool[i]=!0;for(j=0;j<vecExistNode.length;j++)if(vecExistNode[j].StrName===vecPathNodes[i].StrName){vecPathNodes[i].NeedInsert=!1;ppathbool[i]=!1;vecPathNodes[i].PtPosition=vecExistNode[j].PtPosition;break}}this.ArithmeticBeginNode(vecExistNode,vecPathNodes);var vecTempNodes=[];for(i=0;i<vecPathNodes.length;i++){vecPathNodes[i].isDevice&&vecTempNodes.push(vecPathNodes[i])}for(i=0;i<vecTempNodes.length;i++)vecTempNodes[i].NeedInsert&&this.ArithmetricNexNode(vecExistNode,vecTempNodes);for(i=0;i<vecPathNodes.length;i++)for(j=0;j<vecTempNodes.length;j++)if(vecTempNodes[j].StrName===vecPathNodes[i].StrName){vecPathNodes[i].PtPosition=vecTempNodes[j].PtPosition;vecPathNodes[i].NeedInsert=vecTempNodes[j].NeedInsert;break}for(i=0;i<vecPathNodes.length-2;i++)if(vecPathNodes[i+1].NeedInsert){j=i+1;for(;j<vecPathNodes.length&&vecPathNodes[j].NeedInsert;j++);var bJudgePoint=!1;var nCount=0;var ptTempPoint=new go.Point(100,100);for(;!bJudgePoint;){nCount++;bJudgePoint=!0;var tmpPt1=new go.Point(vecPathNodes[j].PtPosition.x,vecPathNodes[j].PtPosition.y);var tmpPt2=new go.Point(vecPathNodes[i].PtPosition.x,vecPathNodes[i].PtPosition.y);var lineAngle=tmpPt1.directionPoint(tmpPt2);lineAngle%=360;lineAngle=this.ConvertAngle(lineAngle);var dAngle=Math.atan(Math.abs((vecPathNodes[j].PtPosition.x-vecPathNodes[i].PtPosition.x)/(vecPathNodes[j].PtPosition.y-vecPathNodes[i].PtPosition.y)));var xFactor=.05*Math.random()+.02;var yFactor=.1*Math.random()+.02;var dXAiseOffSet=this.dDistance*xFactor*Math.sin(dAngle);var dYAiseOffSet=this.dDistance*yFactor*Math.cos(dAngle);var nflag=1;1*Math.random()<.5&&(nflag=-1);var ptCenterPoint=new go.Point((vecPathNodes[j].PtPosition.x+vecPathNodes[i].PtPosition.x)/2,(vecPathNodes[j].PtPosition.y+vecPathNodes[i].PtPosition.y)/2);if(lineAngle<ConstValue.Pi&&lineAngle>ConstValue.Pi/2||lineAngle>3*ConstValue.Pi/2&&lineAngle<2*ConstValue.Pi){ptTempPoint.x=ptCenterPoint.x+nflag*dXAiseOffSet;ptTempPoint.y=ptCenterPoint.y+nflag*dYAiseOffSet}else{ptTempPoint.x=ptCenterPoint.x+nflag*dXAiseOffSet;ptTempPoint.y=ptCenterPoint.y-nflag*dYAiseOffSet}new CheckNodeDistance(ptTempPoint).isPtInExistNodes(vecExistNode)&&(bJudgePoint=!1);if(bJudgePoint)for(j=0;j<vecPathNodes.length-1;j++)if(!vecPathNodes[j].NeedInsert&&!vecPathNodes[j+1].NeedInsert){if(j!==i&&j+1!==i&&j!==i+1&&j+1!==i+1&&this.Intersect(vecPathNodes[i].PtPosition,ptTempPoint,vecPathNodes[j].PtPosition,vecPathNodes[j+1].PtPosition)){bJudgePoint=!1;break}if(i+2<vecPathNodes.length&&!vecPathNodes[i+2].NeedInsert&&j!==i+2&&j+1!==i+2&&j!==i+1&&j+1!==i+1&&this.Intersect(vecPathNodes[i+2].PtPosition,ptTempPoint,vecPathNodes[j].PtPosition,vecPathNodes[j+1].PtPosition)){bJudgePoint=!1;break}}nCount>3e3&&(bJudgePoint=!0)}vecPathNodes[i+1].PtPosition=ptTempPoint;vecPathNodes[i+1].NeedInsert=!1}for(i=0;i<vecPathNodes.length;i++)vecPathNodes[i].NeedInsert=ppathbool[i]}};PathLayoutTool.prototype.Intersect=function(p1,p2,p3,p4){var d1=this.MultiplyForMap(p3,p4,p1);var d2=this.MultiplyForMap(p3,p4,p2);var d3=this.MultiplyForMap(p1,p2,p3);var d4=this.MultiplyForMap(p1,p2,p4);return d1*d2<0&&d3*d4<0||(!(0!==d1||!this.InRect(p3,p4,p1))||(!(0!==d2||!this.InRect(p3,p4,p2))||(!(0!==d3||!this.InRect(p1,p2,p3))||!(0!==d4||!this.InRect(p1,p2,p4)))))};PathLayoutTool.prototype.InRect=function(p1,p2,p3){var result=!1;Math.min(p1.x,p2.x)<=p3.x&&p3.x<=Math.max(p1.x,p2.x)&&Math.min(p1.y,p2.y)<=p3.y&&p3.y<=Math.max(p1.y,p2.y)&&(result=!0);return result};PathLayoutTool.prototype.ConvertAngle=function(nAngle){return MathFunc.ConvertAngleToRadian(nAngle)};PathLayoutTool.prototype.MultiplyForMap=function(p1,p2,p3){return(p3.x-p1.x)*(p2.y-p1.y)-(p2.x-p1.x)*(p3.y-p1.y)};PathLayoutTool.prototype.beautifyPath=function(path,diagram,willInsertNodes){symmetricLayoutPath.paths[path.pathId]||(symmetricLayoutPath.paths[path.pathId]={newNodes:createEmptyDic()});var newNodes=symmetricLayoutPath.paths[path.pathId].newNodes;_.each(willInsertNodes,(function(id){id&&(newNodes[id]=!0)}));if(!path.isRunning&&isBalancePath(path)){horizontalPath(path,diagram,newNodes);rectifyBadNodes(path,diagram,newNodes);symmetricLayoutPath(path,diagram,newNodes)}};function createEmptyDic(){return Object.create(null)}function symmetricLayoutPath(path,diagram,newNodes){diagram.startTransaction("symmetricPath");var symmetricLayout=NetBrain.TopoTools.layoutHelper.symmetricLayout;var ids=getNewNodes(path);layoutBByA(path,diagram);symmetricLayout(diagram,{newNodes:ids});diagram.commitTransaction("symmetricPath");symmetricLayoutPath.paths[path.pathId].newNodes=createEmptyDic()}symmetricLayoutPath.paths=createEmptyDic();function layoutBByA(path,diagram){if(path.toDev&&symmetricLayoutPath.paths[path.pathId].newNodes[path.toDev.ID]){var a=getA(path,diagram);var b=getB(path,diagram);if(a&&b){var abDistance=280*path.maxLengthOfSubPath;var x=a.location.x+.86*abDistance;var y=a.location.y+abDistance/2;b.location=new go.Point(x,y);b.data.location=[x,y].join(" ")}}}function getA(path,diagram){if(path.fromDev)return diagram.findNodeForKey(path.fromDev.ID)}function getB(path,diagram){if(path.toDev)return diagram.findNodeForKey(path.toDev.ID)}function getNewNodes(path){var nodesDic=createEmptyDic();var nodes=[];addABForIgnore(path,nodesDic);path.maxLengthOfSubPath=1;_.each(path.hoplist,(function(hopList){hopList.hops.length>path.maxLengthOfSubPath&&(path.maxLengthOfSubPath=hopList.hops.length);_.each(hopList.hops,(function(hop){addHopNodes(hop,nodes,nodesDic,path)}))}));return nodes}function addABForIgnore(path,nodesDic){path.fromDev&&(nodesDic[path.fromDev.ID]=!0);path.toDev&&(nodesDic[path.toDev.ID]=!0)}function addHopNodes(hop,nodes,nodesDic,path){hop.fromDev&&addNode(hop.fromDev.devId,nodes,nodesDic,path);hop.mediaInfo&&addNode(hop.mediaInfo.mediaId,nodes,nodesDic,path);hop.toDev&&addNode(hop.toDev.devId,nodes,nodesDic,path)}function addNode(nodeId,nodes,nodesDic,path){if(!nodesDic[nodeId]){nodesDic[nodeId]=!0;symmetricLayoutPath.paths[path.pathId].newNodes[nodeId]&&nodes.push(nodeId)}}function rectifyBadNodes(path,diagram,newNodes){var maxRate=.8;var maxTries=15;var tries=1;var groups=function(path,newNodes){var groups=[];_.each(path.hoplist,(function(subpath){var subGroups=function(nodes,newNodes){var subGroups=[];for(var i=0;i<nodes.length-2;i++)subGroups.push({previous:nodes[i],current:nodes[i+1],next:nodes[i+2]});return subGroups}(function(subpath){var nodes=[];var nodesDic={};_.each(subpath.hops,(function(hop){addDevice(hop.fromDev);!function(media){if(media){var mediaId=media.mediaId;mediaId&&!0!==nodesDic[mediaId]&&nodes.push(media.mediaId)}}(hop.mediaInfo);addDevice(hop.toDev)}));return nodes;function addDevice(device){if(device){var devId=device.devId;devId&&!0!==nodesDic[devId]&&nodes.push(devId)}}}(subpath));groups=groups.concat(subGroups)}));return groups}(path);var groupsDic=function(groups){var dic={};_.each(groups,(function(group){!function(group){var id=group.previous;prepareSubDicIfNeed(id);dic[id].previous.push(group)}(group);!function(group){var id=group.current;prepareSubDicIfNeed(id);dic[id].currents.push(group)}(group);!function(group){var id=group.next;prepareSubDicIfNeed(id);dic[id].nexts.push(group)}(group)}));return dic;function prepareSubDicIfNeed(id){dic[id]||(dic[id]={previous:[],currents:[],nexts:[]})}}(groups);checkGroups();!function rectify(){var group=function(groups){return _.max(groups,(function(group){return group.deviateRate}))}(groups);if(group.deviateRate<maxRate&&tries>=maxTries)return;tries++;var to=function(group){return new go.Point(group.middle.x-30,group.middle.y+30)}(group);getNode(group.current).move(to);checkGroups(group);rectify()}();return;function checkGroups(group){var groupsToCheck=function(){if(group){var id=group.current;return function(subDic){return[].concat(subDic.previous).concat(subDic.currents).concat(subDic.nexts)}(groupsDic[id])}return groups}();_.each(groupsToCheck,(function(group){var from=getPosition(group.previous);var current=getPosition(group.current);var to=getPosition(group.next);if(from&&current&&to){group.middle=function(from,to){var x=(from.x+to.x)/2;var y=(from.y+to.y)/2;return new go.Point(x,y)}(from,to);group.distance=distance(from,to);group.deviate=distance(current,group.middle);group.deviateRate=group.deviate/group.distance}}));return}function getPosition(id){var node=getNode(id);return node&&node.location}function getNode(id){return diagram.findNodeForKey(id)}function distance(from,to){var xDistance=to.x-from.x;var yDistance=to.y-from.y;return Math.sqrt(xDistance*xDistance+yDistance*yDistance)}}function horizontalPath(path,diagram,newNodes){var goodAngle=30*Math.PI/360;var from=getNode(path.fromDev.ID);var to=getNode(path.toDev.ID);var angle=(dot=from,function(target,dot){var x=target.x,y=target.y,sx=dot.x,sy=dot.y;var angle=Math.atan2(y-sy,x-sx);y<sy&&(angle=2*Math.PI+angle);return angle}(to.location,dot.location));var dot;if(function(angle){return angle<goodAngle||angle>2*Math.PI-goodAngle}(angle));else{angle=-(angle-goodAngle);var rotated={};rotated[path.fromDev.ID]=!0;_.each(path.hoplist,(function(subpath){_.each(subpath.hops,rotateHop)}))}function rotateHop(hop){rotateDev(hop.fromDev);!function(media){if(!media)return;var mediaId=media.mediaId;if(rotated[mediaId]||!0!==newNodes[mediaId])return;var node=getNode(mediaId);rotateNodeAngle(angle,node,from);rotated[mediaId]=!0}(hop.mediaInfo);!function(dev){rotateDev(dev)}(hop.toDev)}function rotateDev(dev){if(dev){var devId=dev.devId;if(!rotated[devId]&&!0===newNodes[devId]){var node=getNode(devId);rotateNodeAngle(angle,node,from);rotated[devId]=!0}}}function rotateNodeAngle(angle,target,dot){if(target){var nPoint=function(angle,target,dot){var x=target.x,y=target.y,sx=dot.x,sy=dot.y,rad=angle,cos=Math.cos(rad),sin=Math.sin(rad);var nx=(x-sx)*cos-(y-sy)*sin+sx,ny=(x-sx)*sin+(y-sy)*cos+sy;return new go.Point(nx,ny)}(angle,target.location,dot.location);target.move(nPoint)}}function getNode(key){return diagram.findPartForKey(key)}}function BindHelper(){}BindHelper.defaultFont="normal normal 400 11px 'open sans'";BindHelper.defaultPosLableFont="normal normal 400 11px 'open sans'";BindHelper.defaultHostNameFont="normal normal 600 13px 'open sans'";BindHelper.defaultMediaHostNameFont="normal normal 400 11px 'open sans'";BindHelper.defaultInftNameFont="normal normal 600 11px 'open sans'";BindHelper.defaultLargeFont="normal normal 400 18px 'open sans'";BindHelper.defaultNoteTitleFont="normal normal bold 12px 'open sans'";BindHelper.defaultNoteContentFont="normal normal 400 12px 'open sans'";BindHelper.defaultInitImage="img/picture/no-image.png";BindHelper.toTarget_device_highlightVisible=function(dataViewData){return null!=dataViewData&&(null!=dataViewData.devHighlightList&&dataViewData.devHighlightList.length>0)};BindHelper.toTarget_device_highlightItemArray=function(dataViewData){return null==dataViewData?[]:null==dataViewData.devHighlightList?[]:dataViewData.devHighlightList};BindHelper.toTarget_device_desiredSize=function(dataViewData){var size=new go.Size(240,150);if(null==dataViewData)return size;if(null==dataViewData.devGraphicInfo||null==dataViewData.devGraphicInfo.imageList)return size;var imageList=dataViewData.devGraphicInfo.imageList;if(imageList.length<=0)return size;if(null==dataViewData.devColorSchema||null==dataViewData.devColorSchema.status)return size=go.Size.parse(imageList[0].size);for(var i=0;i<imageList.length;i++){var image=imageList[i];if(image.status===dataViewData.devColorSchema.status)return size=go.Size.parse(image.size)}return size};BindHelper.toTarget_device_desiredSizeWithScale=function(dataViewData,currObj){return BindHelper.toTarget_media_desiredSize(dataViewData,currObj)};BindHelper.toTarget_media_desiredSize=function(dataViewData,currObj){var size=BindHelper.toTarget_device_desiredSize(dataViewData,currObj);var scale=BindHelper.toTarget_device_scale(dataViewData,currObj);return new go.Size(size.width*scale,size.height*scale)};BindHelper.toTarget_device_scale=function(dataViewData,currObj){var scale;var imageList=NgUtil.getValueFromObjAndPath(dataViewData,"devGraphicInfo.imageList");if(_.isArray(imageList)&&imageList.length>0){var devColorStatus=NgUtil.getValueFromObjAndPath(dataViewData,"devColorSchema.status");if(devColorStatus){var imageObj=_.find(imageList,(function(image){return image.status===devColorStatus}));imageObj&&(scale=imageObj.scale)}else scale=imageList[0].scale}scale=(scale=scale||NetBrain.Map.Const.iconOnMapScale)||NetBrain.Map.Const.iconOnMapScale;var iconRatio=NgUtil.getValueFromObjAndPath(currObj,"part.data.iconRatio");_.isNumber(iconRatio)&&(scale*=iconRatio);return scale};BindHelper.toTarget_media_source=function(dataViewData){var image=NetBrain.NG.Const.iconImagePath+"Lan.png";if(null==dataViewData)return image;if(null==dataViewData.devGraphicInfo||null==dataViewData.devGraphicInfo.imageList)return image;var imageList=dataViewData.devGraphicInfo.imageList;if(imageList.length<=0)return image;var fileName=imageList[0].name;var withoutExtFileName=fileName.replace(".png","");if(!Utility.isGUID(withoutExtFileName)){if("vPC"==withoutExtFileName)return NetBrain.NG.Const.iconImagePath+imageList[0].name;var mediaList=NetBrain.Map.gMediaTypeMgr.getMediaList();var findMedia=_.find(mediaList,(function(m){return m.typeName.toLowerCase()==withoutExtFileName.toLowerCase()}));findMedia&&(fileName=findMedia.icon+".png")}"Mute LAN.png"==fileName&&(fileName="00000000-0000-0000-0000-00000000008e.png");return NetBrain.deviceIcon.getIconStreamURIById(fileName)};BindHelper.toTarget_device_source=function(dataViewData,node){var getHttp=NetBrain.deviceIcon.getIconStreamURIById;node&&node.part.data.category==NetBrain.Map.CategoryMgr.Stencil&&(getHttp=NetBrain.deviceIcon.getStencilIconStreamURIById);var image=NetBrain.NG.Const.iconImagePath+"Unclassified Device.png";if(null==dataViewData)return image;if(null==dataViewData.devGraphicInfo||null==dataViewData.devGraphicInfo.imageList)return image;var imageList=dataViewData.devGraphicInfo.imageList;if(imageList.length<=0)return image;if(null==dataViewData.devColorSchema||null==dataViewData.devColorSchema.status){var withoutExtFileName=imageList[0].name.replace(".png","");return Utility.isGUID(withoutExtFileName)?getHttp(imageList[0].name):NetBrain.NG.Const.iconImagePath+imageList[0].name}for(var i=0;i<imageList.length;i++){var imageObj=imageList[i];if(imageObj.status===dataViewData.devColorSchema.status)return getHttp(imageObj.name)}return image};BindHelper.toTarget_device_hostnameText=function(name,node){var dev=null;null!=node.part&&null!=node.part.data&&(dev=node.part.data);return null==dev?name:dev.hostName};BindHelper.toTarget_media_hostnameText=function(name,node){return function(name){return Array.isArray(name)?name.join("\n"):name}(BindHelper.toTarget_device_hostnameText(name,node))};BindHelper.toTarget_media_hostnameLines=function(name,node){var hostName=BindHelper.toTarget_device_hostnameText(name,node);var lines;if(_.isArray(hostName)){lines=0;_.each(hostName,(function(item){item&&(lines+=item.split("\n").length)}))}else lines=1;return lines};BindHelper.toTarget_device_hostnameMargin=function(visible){return visible?new go.Margin(3,0,0,15):new go.Margin(-3,0,0,15)};BindHelper.toTarget_device_posText=function(posInfo,node){if(null!=node.panel.data&&node.panel.data.posName===DataViewPosName.overflowPos)return"";if(null!=node.panel.panel.panel.data&&node.panel.panel.panel.data.posName===DataViewPosName.overflowPos)return"";if(null==posInfo||null==posInfo.dataUnitList)return"";if(1===posInfo.dataUnitList.length&&posInfo.dataUnitList[0].valueType===DataUnitType.uCompoundVar)return"";null==posInfo.displayInfo&&(posInfo.displayInfo="");return posInfo.displayInfo.trim()};BindHelper.toTarget_device_visible=function(posInfo,node){var visible=node.visible||!1;!1===NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0.valueEx.isVisiable")&&(visible=!1);return visible};BindHelper.toTarget_device_extraData_visible=function(extraData,node){var visible=!1;var overflowList=extraData.overflowList;if(overflowList)for(var i=0,len=overflowList.length;i<len;i++){var posInfo=overflowList[i].posInfo;if(posInfo&&posInfo.displayInfo&&posInfo.displayInfo.trim()&&!1!==NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0.valueEx.isVisiable")){visible=!0;break}}node.overflowVisible=visible;return visible};BindHelper.toTarget_label_overflow_bgColor=function(extraData,node){return _.some(extraData.overflowList,(function(item){return NgUtil.getValueFromObjAndPath(item,"posInfo.dataUnitList.0.alarm")===DataUnitAlarm.error}))?NetBrain.Map.Const.TemplateAlarmColor.Error.background:node.background};BindHelper.toTarget_label_overflow_fillColor=function(extraData,node){return _.some(extraData.overflowList,(function(item){return NgUtil.getValueFromObjAndPath(item,"posInfo.dataUnitList.0.alarm")===DataUnitAlarm.error}))?NetBrain.Map.Const.TemplateAlarmColor.Error.font:node.fill};BindHelper.toTarget_label_dataunit_icon_fillColor=function(posInfo,node){return NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0.valueType")===DataUnitType.uParagraph?"#DCA141":node.fill};BindHelper.toTarget_label_drillDown_icon_visible=function(posInfo){var flag=!1;!0===NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0.definedDrillDownAction")&&(flag=!0);return flag};BindHelper.toTarget_device_label_cursor=function(posInfo){var cursor="";var dataUnit=NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0");dataUnit&&haveDataUnitClickEvent(dataUnit)&&(cursor="pointer");return cursor};BindHelper.toTarget_link_label_cursor=function(posInfo,obj){return isBelongDefaultDataView(posInfo,obj)?"pointer":BindHelper.toTarget_device_label_cursor(posInfo,obj)};function haveDataUnitClickEvent(dataUnit){if(!dataUnit)return!1;var flag=!1;var valueType=dataUnit.valueType;var type=dataUnit.type;valueType===DataUnitType.uTable?(type!==DataUnitSourceType.uSrcQapp||dataUnit.valueExpr)&&(flag=!0):valueType===DataUnitType.uParserTable?type!==DataUnitSourceType.uSrcAPI&&(flag=!0):valueType===DataUnitType.uFloat||valueType===DataUnitType.uBool||valueType===DataUnitType.uInt||valueType===DataUnitType.uPercent||valueType===DataUnitType.uString?type!==DataUnitSourceType.uSrcGDR&&(flag=!0):valueType!==DataUnitType.uParagraph&&valueType!==DataUnitType.uObject&&valueType!==DataUnitType.uList_primitive_subtype&&valueType!==DataUnitType.uList_object_subtype&&valueType!==DataUnitType.uConfigFile&&valueType!==DataUnitType.uHyperLink&&valueType!==DataUnitType.uDoc&&valueType!==DataUnitType.uList||(flag=!0);return flag}function isBelongDefaultDataView(posInfo,obj){var flag=!0;var part=obj.part;var data=part.data;if(_.isFunction(data.isDefaultDataView))if(part instanceof go.Node)flag=data.isDefaultDataView();else if(part instanceof go.Link){var isDest=BindHelper.isLinkLabelBelongDest(posInfo,data);flag=data.isDefaultDataView(isDest)}return flag}BindHelper.isLinkLabelBelongDest=function(posInfo,data){var intfDestPostList=data.getIntfPosListDest();return-1!==_.findIndex(intfDestPostList,(function(pos){return pos.posInfo===posInfo}))};BindHelper.toTarget_device_label_backcolor=function(posInfo,node){var color=node.background;if(null==posInfo||null==posInfo.dataUnitList||null==posInfo.dataUnitList[0])return color;posInfo.dataUnitList[0].alarm===DataUnitAlarm.warning?color=NetBrain.Map.Const.Color.Warning:posInfo.dataUnitList[0].alarm===DataUnitAlarm.error?color=NetBrain.Map.Const.Color.Error:(posInfo.dataUnitList[0].alarm,DataUnitAlarm.unknown);return color&&NetBrain.Map.randomColorSrvc.parseColor(color)};BindHelper.toTarget_device_label_dataUnitInfo_backcolor=function(dataUnitInfo,node){return dataUnitInfo&&dataUnitInfo.bgColor?dataUnitInfo.bgColor:node.background};BindHelper.toTarget_device_posStrokeDataUnitType=function(posInfo,node){var dataUnits=[DataUnitType.uConfigFile,DataUnitType.uHyperLink,DataUnitType.uDoc,DataUnitType.uTable,DataUnitType.uList_object_subtype,DataUnitType.uList_primitive_subtype,DataUnitType.uObject,DataUnitType.uParagraph,DataUnitType.uParserTable];var stroke=node.stroke;NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0")&&(dataUnits.indexOf(posInfo.dataUnitList[0].valueType)>-1?stroke="#7AABDE":NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0.alarm")===DataUnitAlarm.error&&(stroke=NetBrain.Map.Const.TemplateAlarmColor.Error.font));return stroke};BindHelper.toTarget_device_posStrokeGraphicInfo=function(labelGraphicInfo,node){return null==labelGraphicInfo?node.stroke:labelGraphicInfo.color||node.stroke};BindHelper.toTarget_device_posBackground=function(labelGraphicInfo){return null==labelGraphicInfo?"white":labelGraphicInfo.bgColor||"white"};BindHelper.toTarget_device_posFont=function(labelGraphicInfo,node){var fontParser=new FontParser;fontParser.fromString(BindHelper.defaultPosLableFont);var font=NgUtil.getValueFromObjAndPath(labelGraphicInfo,"font");if(font){font.faceName;font.fontSize}return fontParser.toString()};BindHelper.toTarget_device_itemArray=function(dataViewData,node){if(null==dataViewData||null==dataViewData.devPosList)return[];if(dataViewData.devPosList.length<=0)return[];if(node.part.data.isDefaultDataView())dataViewData.devPosList=_.filter(dataViewData.devPosList,(function(v,k){return v.posName===DataViewPosName.overflowPos||!(!v.posInfo.displayInfo||""===v.posInfo.displayInfo.trim())}));else{var lastLeng=0;_.each(dataViewData.devPosList,(function(item){if(item.posName.indexOf("devPos")>-1){var curPosIndex=parseInt(item.posName.replace("devPos",""));curPosIndex>lastLeng&&(lastLeng=curPosIndex)}}));var hasPos=_.map(dataViewData.devPosList,(function(item){return item.posName}));for(var i=1;i<=lastLeng;i++)-1===hasPos.indexOf("devPos"+i)&&dataViewData.devPosList.push({posName:"devPos"+i,posInfo:{displayInfo:""}});var overflowPos=_.find(dataViewData.devPosList,(function(a){return a.posName===DataViewPosName.overflowPos}));dataViewData.devPosList=_.without(dataViewData.devPosList,overflowPos);dataViewData.devPosList.sort((function(a,b){return parseInt(a.posName.replace("devPos",""))-parseInt(b.posName.replace("devPos",""))}));overflowPos&&dataViewData.devPosList.push(overflowPos)}return dataViewData.devPosList};BindHelper.colorToStringForDevice=function(highlightItem){if(-1===highlightItem.color&&NetBrain.Map.currentActiveMapPage&&NetBrain.Map.currentActiveMapPage.getMapLegend()&&NetBrain.Map.currentActiveMapPage.getMapLegend().devHighlightLegend){var devHighlightLegendList=NetBrain.Map.currentActiveMapPage.getMapLegend().devHighlightLegend.list;var findHighlight=_.find(devHighlightLegendList,{legendName:highlightItem.legendName});if(findHighlight)return findHighlight.color}return NetBrain.Map.randomColorSrvc.parseColor(highlightItem.color,"HighlightDevice",NetBrain.Map.Const.HightLegendType.deviceLegend,highlightItem.legendName)};BindHelper.colorToStringForInterface=function(highlightItem){if(-1===highlightItem.color&&NetBrain.Map.currentActiveMapPage&&NetBrain.Map.currentActiveMapPage.getMapLegend()&&NetBrain.Map.currentActiveMapPage.getMapLegend().interfaceHighlightLegend){var interfaceHighlightLegendList=NetBrain.Map.currentActiveMapPage.getMapLegend().interfaceHighlightLegend.list;var findHighlight=_.find(interfaceHighlightLegendList,{legendName:highlightItem.legendName});if(findHighlight)return findHighlight.color}return NetBrain.Map.randomColorSrvc.parseColor(highlightItem.color,"HighlightInterface",NetBrain.Map.Const.HightLegendType.interfaceLegend,highlightItem.legendName)};BindHelper.colorToStringForhigHightNeighbor=function(highlightItem){return NetBrain.Map.randomColorSrvc.parseColor(highlightItem.color,"HighlightNeighbor",NetBrain.Map.Const.HightLegendType.linkLegend,highlightItem.legend)};BindHelper.colorToStringForDrawHop=function(color){return NetBrain.Map.randomColorSrvc.parseColor(color,"DrawHop")};BindHelper.colorToStringForNoteFore=function(fontColor){return-2===fontColor?NetBrain.Map.Const.noteDefaultFontColor:NetBrain.Map.randomColorSrvc.parseColor(fontColor,"noteforecolor")};BindHelper.colorToStringForNoteBackground=function(backColor,obj){var newForeColor;if(_.some(NgUtil.getValueFromObjAndPath(obj,"part.data.refVariables"),(function(item){return item.alarm===DataUnitAlarm.error})))newForeColor=NetBrain.Map.Const.dataViewNoteAlarmErrorBackColor;else if(-2===backColor){newForeColor=NgUtil.getValueFromObjAndPath(obj,"part.data.noteFromType")===NetBrain.Map.Const.NoteFromType.DataView?NetBrain.Map.Const.dataViewNoteDefaultBackColor:NetBrain.Map.Const.noteDefaultBackColor}else newForeColor=NetBrain.Map.randomColorSrvc.parseColor(backColor,"notebgcolor");return newForeColor};BindHelper.colorToStringForNoteBorder=function(backColor){return-2===backColor?NetBrain.Map.Const.noteDefaultBorderColor:NetBrain.Map.randomColorSrvc.parseColor(backColor,"notebordercolor")};BindHelper.colorToStringForNoteSeparatorColor=function(borderColor,obj){var color;if(_.some(NgUtil.getValueFromObjAndPath(obj,"part.data.refVariables"),(function(item){return item.alarm===DataUnitAlarm.error})))color=NetBrain.Map.Const.dataViewNoteAlarmErrorSeparatorColor;else if(-2===borderColor){color=NgUtil.getValueFromObjAndPath(obj,"part.data.noteFromType")===NetBrain.Map.Const.NoteFromType.DataView?NetBrain.Map.Const.dataViewNoteDefaultSeparatorColor:NetBrain.Map.Const.noteDefaultSeparatorColor}else color=NetBrain.Map.randomColorSrvc.parseColor(borderColor,"notebgcolor");return color};BindHelper.colorToInt=function(highlightItem){return _.isNumber(highlightItem)?highlightItem:parseInt(highlightItem.substring(1),16)};BindHelper.lineTypeToArray=function(lineTypeInt){return _.find(NetBrain.Map.Const.LineTypeDic,(function(item){return item.key===lineTypeInt})).value};BindHelper.isLegendVisibleFilter=function(legend){return!!legend&&!0!==legend.isHide};BindHelper.lineTypeToInt=function(lineTypeArray){return _.find(NetBrain.Map.Const.LineTypeDic,(function(item){return item.value===lineTypeArray})).key};BindHelper.noteAlineToInt=function(noteAlineString){var notealign=0;switch(noteAlineString){case"left":notealign=0;break;case"center":notealign=1;break;case"right":notealign=2;break;default:notealign=0}return notealign};BindHelper.noteAlineToString=function(noteAlineInt){var notealign;switch(parseInt(noteAlineInt)){case NetBrain.Map.Const.Align.Left:notealign="left";break;case NetBrain.Map.Const.Align.Center:notealign="center";break;case NetBrain.Map.Const.Align.Right:notealign="right";break;default:notealign="left"}return notealign};function setgraphicInfo(node){var graphicInfo={color:"black",width:1};var constSwitchMode=NetBrain.MapImprovements.l2TopoLinkMode.consts.L2TopoLinkMode;var constl2TopologyMapLegend=NetBrain.MapImprovements.l2TopoLinkMode.consts.l2Topology_mapLegend;switch(node.part.data.getL2TopoLinkMode()){case constSwitchMode.Trunk:graphicInfo.color=constl2TopologyMapLegend.trunkInfo.color;graphicInfo.width=constl2TopologyMapLegend.trunkInfo.width;break;case constSwitchMode.Fabricpath:graphicInfo.color=constl2TopologyMapLegend.fabricpathInfo.color;graphicInfo.width=constl2TopologyMapLegend.fabricpathInfo.width;break;case constSwitchMode.VPC:graphicInfo.color=constl2TopologyMapLegend.vpcInfo.color;graphicInfo.width=constl2TopologyMapLegend.vpcInfo.width;break;case constSwitchMode.VPCPeer:graphicInfo.color=constl2TopologyMapLegend.vpcPeerInfo.color;graphicInfo.width=constl2TopologyMapLegend.vpcPeerInfo.width;break;case constSwitchMode.PortChannel:graphicInfo.color=constl2TopologyMapLegend.portChannelInfo.color;graphicInfo.width=constl2TopologyMapLegend.portChannelInfo.width}return graphicInfo}BindHelper.getTrunkLinkColor=function(v,node){return setgraphicInfo(node).color};BindHelper.getTrunkLinkWidth=function(v,node){return setgraphicInfo(node).width};BindHelper.getCustomLineStrokeSrc=function(v,node){var color=NgUtil.getValueFromObjAndPath(v,"src.line.stroke");return color=color||node.stroke};BindHelper.getCustomLineStrokeWidthSrc=function(v,node){var width=NgUtil.getValueFromObjAndPath(v,"src.line.strokeWidth");return width=width||node.strokeWidth};BindHelper.getCustomLineStrokeDashArraySrc=function(v,node){var type=NgUtil.getValueFromObjAndPath(v,"src.line.strokeDashArray");return type=type||node.strokeDashArray};BindHelper.getCustomLineStrokeDest=function(v,node){var color=NgUtil.getValueFromObjAndPath(v,"dest.line.stroke");return color=color||node.stroke};BindHelper.getCustomLineStrokeWidthDest=function(v,node){var width=NgUtil.getValueFromObjAndPath(v,"dest.line.strokeWidth");return width=width||node.strokeWidth};BindHelper.getCustomLineStrokeDashArrayDest=function(v,node){var type=NgUtil.getValueFromObjAndPath(v,"dest.line.strokeDashArray");return type=type||node.strokeDashArray};BindHelper.getLinkSelectedWidth=function(data){var arr=[1];var customMapStyle=data.customMapStyle;if(customMapStyle){arr.push(NgUtil.getValueFromObjAndPath(customMapStyle,"src.line.strokeWidth"));arr.push(NgUtil.getValueFromObjAndPath(customMapStyle,"dest.line.strokeWidth"))}return _.max(arr)+8};BindHelper.getPathCustomLineStroke=function(v,node){var hopIndex=node.panel.itemIndex;var color=NgUtil.getValueFromObjAndPath(node,"part.data.customMapStyle."+hopIndex+".line.stroke");return color=color||node.stroke};BindHelper.getPathCustomLineStrokeWidth=function(v,node){var hopIndex=node.panel.itemIndex;var width=NgUtil.getValueFromObjAndPath(node,"part.data.customMapStyle."+hopIndex+".line.strokeWidth");return width=width||node.strokeWidth};BindHelper.getPathCustomLineStrokeDashArray=function(v,node){var hopIndex=node.panel.itemIndex;var type=NgUtil.getValueFromObjAndPath(node,"part.data.customMapStyle."+hopIndex+".line.strokeDashArray");return type=type||node.strokeDashArray};BindHelper.getPathCustomLineFill=function(v,node){var hopIndex=node.panel.itemIndex;var color=NgUtil.getValueFromObjAndPath(node,"part.data.customMapStyle."+hopIndex+".line.stroke");return color=color||node.fill};BindHelper.getPathCustomArrowScale=function(strokeWidth,node){var scale=3;strokeWidth>10&&strokeWidth<=20?scale=4:strokeWidth>20&&(scale=6);return scale};BindHelper.getLinkStatusColor=function(v,node){var graphicInfo_color="black";if(null==v||null==v.intfInfo||null==v.intfInfo.intfGraphicInfo||null==v.intfInfo.intfGraphicInfo.colorList)return graphicInfo_color;if(null==v.intfInfo.intfColorSchema||null==v.intfInfo.intfColorSchema.status)return graphicInfo_color;for(var colorIndex=0;colorIndex<v.intfInfo.intfGraphicInfo.colorList.length;colorIndex++){var tmpColor=v.intfInfo.intfGraphicInfo.colorList[colorIndex];if(null!=tmpColor&&null!=tmpColor.status&&(null!=tmpColor.color&&v.intfInfo.intfColorSchema.status===tmpColor.status))return NetBrain.Map.randomColorSrvc.parseColor(tmpColor.color)}return graphicInfo_color};BindHelper.getLinkStatusWidth=function(v,node){var width=setgraphicInfo(node).width;if(null==v||null==v.intfInfo||null==v.intfInfo.intfGraphicInfo||null==v.intfInfo.intfGraphicInfo.colorList)return width;if(null==v.intfInfo.intfColorSchema||null==v.intfInfo.intfColorSchema.status)return width;for(var colorIndex=0;colorIndex<v.intfInfo.intfGraphicInfo.colorList.length;colorIndex++){var tmpColor=v.intfInfo.intfGraphicInfo.colorList[colorIndex];if(null!=tmpColor&&null!=tmpColor.status&&(null!=tmpColor.color&&v.intfInfo.intfColorSchema.status===tmpColor.status)){width=2;break}}return width};BindHelper.getLinkStatusVisible=function(v,node){var visible=!1;if(null==v||null==v.intfInfo||null==v.intfInfo.intfGraphicInfo||null==v.intfInfo.intfGraphicInfo.colorList)return visible;if(null==v.intfInfo.intfColorSchema||null==v.intfInfo.intfColorSchema.status)return visible;for(var colorIndex=0;colorIndex<v.intfInfo.intfGraphicInfo.colorList.length;colorIndex++){var tmpColor=v.intfInfo.intfGraphicInfo.colorList[colorIndex];if(null!=tmpColor&&null!=tmpColor.status&&(null!=tmpColor.color&&v.intfInfo.intfColorSchema.status===tmpColor.status)){visible=!0;break}}return visible};BindHelper.toTarget_device_highlightSize=function(dataViewData){var size=new go.Size(70,50);var defaultImgSize=new go.Size(240,150);function calcSize(imgData){var newSize;if(imgData){var imgSize=go.Size.parse(imgData.size);var width=Math.floor(1*imgSize.width/defaultImgSize.width*size.width);var height=Math.floor(1*imgSize.height/defaultImgSize.height*size.height);newSize=new go.Size(width,height)}return newSize||size}if(null==dataViewData)return size;if(null==dataViewData.devGraphicInfo||null==dataViewData.devGraphicInfo.imageList)return size;var imageList=dataViewData.devGraphicInfo.imageList;if(imageList.length<=0)return size;if(null==dataViewData.devColorSchema||null==dataViewData.devColorSchema.status)return size=calcSize(imageList[0]);for(var i=0;i<imageList.length;i++){var image=imageList[i];if(image.status===dataViewData.devColorSchema.status)return size=calcSize(image)}return size};BindHelper.getAlarmLabelColor=function(posInfo){if(null==posInfo||null==posInfo.dataUnitList||null==posInfo.dataUnitList[0])return null;var color=null;posInfo.dataUnitList[0].alarm===DataUnitAlarm.warning?color=NetBrain.Map.Const.Color.Warning:posInfo.dataUnitList[0].alarm===DataUnitAlarm.error?color=NetBrain.Map.Const.Color.Error:posInfo.dataUnitList[0].alarm===DataUnitAlarm.normal?color=NetBrain.Map.Const.Color.Normal:posInfo.dataUnitList[0].alarm===DataUnitAlarm.unknown&&(color=NetBrain.Map.Const.Color.Unknown);return color&&NetBrain.Map.randomColorSrvc.parseColor(color)};BindHelper.getLineType=function(key){if(_.isArray(key))return key;var consts=NetBrain.Map.Const;var currLineType=_.find(consts.LineTypeDic,(function(lineType){return lineType.key===key}));return currLineType?currLineType.value:null};BindHelper.getLabelVisibleFromPosInfoDefaultFalse=function(v,node){var flag=!1;NgUtil.getValueFromObjAndPath(v,"dataUnitList.0.valueType")===DataUnitType.uCompoundVar&&(flag=!0);return flag};BindHelper.getLabelVisibleFromPosInfoDefaultTrue=function(v,node){var flag=!0;NgUtil.getValueFromObjAndPath(v,"dataUnitList.0.valueType")===DataUnitType.uCompoundVar&&(flag=!1);return flag};BindHelper.toTarget_port_highlightColor=function(highlightList,node){var portColor="transparent";if(!BindHelper.toTarget_port_highlightVisible())return portColor;var hlsShow=_.filter(highlightList,(function(hl){return!hl.isHide}));if(hlsShow.length>0){var hlsObj=hlsShow[0];var color=hlsObj.color;var legendName=hlsObj.legendName;if(-1===color&&NetBrain.Map.currentActiveMapPage&&NetBrain.Map.currentActiveMapPage.getMapLegend()&&NetBrain.Map.currentActiveMapPage.getMapLegend().interfaceHighlightLegend){var interfaceHighlightLegendList=NetBrain.Map.currentActiveMapPage.getMapLegend().interfaceHighlightLegend.list;var findHighlight=_.find(interfaceHighlightLegendList,{legendName:legendName});if(findHighlight)return findHighlight.color}portColor=NetBrain.Map.randomColorSrvc.parseColor(color,"HighlightInterface",NetBrain.Map.Const.HightLegendType.interfaceLegend,legendName)}return portColor};BindHelper.toTarget_port_highlightVisible=function(){var mode=BindHelper.toTarget_intf_highlightMode();return mode===NetBrain.Map.Const.InterfaceHighlightModeEnum.All||mode===NetBrain.Map.Const.InterfaceHighlightModeEnum.OnlyPort};BindHelper.toTarget_topolink_highlightVisible=function(){var mode=BindHelper.toTarget_intf_highlightMode();return mode===NetBrain.Map.Const.InterfaceHighlightModeEnum.All||mode===NetBrain.Map.Const.InterfaceHighlightModeEnum.OnlyLink};BindHelper.toTarget_intf_highlightMode=function(){var netmap=NgUtil.getValueFromObjAndPath(NetBrain,"Map.currentActiveMapPage");var mode=NetBrain.Map.Const.DefaultInterfaceHighlightMode;netmap&&_.isFunction(netmap.getInterfaceHighlightMode)&&(mode=netmap.getInterfaceHighlightMode());return mode};BindHelper.toTarget_label_icon_height=function(posInfo,obj){var height=obj.height;NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0.valueType")===DataUnitType.uParagraph&&(height=11);return height};BindHelper.toTarget_label_icon_width=function(posInfo,obj){var width=obj.width;NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0.valueType")===DataUnitType.uParagraph&&(width=9.5);return width};BindHelper.toTarget_label_underline=function(posInfo){return!!NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0.link")};BindHelper.toTarget_deviceNote_viewDetailVisible=function(noteFromType){var flag=!1;if(noteFromType===NetBrain.Map.Const.NoteFromType.DataView){var netmap=NgUtil.getValueFromObjAndPath(NetBrain,"Map.currentActiveMapPage");if(netmap){flag=!!netmap.getExtendDataViewTemplateData().dataViewTemplateId}}return flag};BindHelper.toTarget_deviceNote_leadingSpacePrefix=function(v){return v=""+v.replace(/\n/g,"\n")};BindHelper.toTarget_deviceNote_noLeadingSpacePrefix=function(v){return v=v.replace(/\u00AD+/,"").replace(/\n\u00AD/g,"\n")};function initForInframe(){var isIframe=self!==top;window.isInIframe=isIframe;!0===window.isInIframe&&(BindHelper.toTarget_label_drillDown_icon_visible=function(){return!1})}initForInframe();function NormalSelectAdormenTemplate(){}NormalSelectAdormenTemplate.SelectedColor="#1b7cb4";NormalSelectAdormenTemplate.FirstSelectedColor="#00A000";NormalSelectAdormenTemplate.getNodeTemplate=function(){var $=go.GraphObject.make;return $(go.Adornment,"Auto",$(go.Shape,{name:"selectedShape",figure:"Rectangle",fill:null,stroke:NormalSelectAdormenTemplate.SelectedColor,strokeWidth:1,strokeDashArray:[3,2]},new go.Binding("stroke","isSelected",(function(isSelected,obj){return getSelectedColor(obj.part.adornedPart)||NormalSelectAdormenTemplate.SelectedColor})).ofObject()),$(go.Placeholder))};NormalSelectAdormenTemplate.getLinkTemplate=function(visible){visible=!1!==visible;var $=go.GraphObject.make;return $(go.Adornment,"Link",$(go.Shape,{isPanelMain:!0,fill:null,stroke:"#1b7cb4",strokeWidth:2,strokeDashArray:[6,3],visible:visible}))};NormalSelectAdormenTemplate.borderSelectNodeTemplate=function(){var $=go.GraphObject.make;return $(go.Adornment,"Spot",$(go.Placeholder),$(go.Shape,"LogicNot",{alignment:new go.Spot(0,0,15,15),height:15,width:15,strokeWidth:3,fill:"#00FF00",stroke:"#00FF00",alignmentFocus:go.Spot.BottomRight,angle:-90}),$(go.Shape,"LogicNot",{alignment:new go.Spot(0,1,15,-15),height:15,width:15,strokeWidth:3,fill:"#00FF00",stroke:"#00FF00",alignmentFocus:go.Spot.TopRight,angle:180}),$(go.Shape,"LogicNot",{alignment:new go.Spot(1,0,-15,15),height:15,width:15,strokeWidth:3,fill:"#00FF00",alignmentFocus:go.Spot.BottomLeft,stroke:"#00FF00"}),$(go.Shape,"LogicNot",{alignment:new go.Spot(1,1,-15,-15),height:15,width:15,strokeWidth:3,fill:"#00FF00",stroke:"#00FF00",alignmentFocus:go.Spot.TopLeft,angle:90}))};NormalSelectAdormenTemplate.getLinkArrowTemplate=function(){var $=go.GraphObject.make;return $(go.Adornment,"Link",$(go.Shape,{isPanelMain:!0,fill:null,stroke:"#1b7cb4",strokeWidth:2,strokeDashArray:[6,3]},new go.Binding("strokeWidth","strokeWidth",(function(v,obj){return v||2}))),$(go.Shape,{toArrow:"Standard",stroke:"#1b7cb4"},new go.Binding("strokeWidth"),new go.Binding("segmentOffset","",(function(v){return new go.Point(v.strokeWidth||1,0)})),new go.Binding("toArrow")),$(go.Shape,{fromArrow:"Standard",stroke:"#1b7cb4"},new go.Binding("strokeWidth"),new go.Binding("segmentOffset","",(function(v){return new go.Point(-(v.strokeWidth||1),0)})),new go.Binding("fromArrow")))};NormalSelectAdormenTemplate.getLinkBgPanelTemplate=function(){var $=go.GraphObject.make;var CompTopolink=NetBrain.Map.CompTopolink;return $(go.Panel,{name:CompTopolink.SelectedBgPanel,visible:!1},$(go.Panel,$(go.Shape,{strokeWidth:10,stroke:NormalSelectAdormenTemplate.SelectedColor,opacity:.3},new go.Binding("strokeWidth","",BindHelper.getLinkSelectedWidth))),new go.Binding("visible","isSelected").ofObject())};NormalSelectAdormenTemplate.getPathBgShapeTemplate=function(){var bgShape=new go.Shape;bgShape.alignmentFocus=go.Spot.TopLeft;bgShape.alignment=go.Spot.TopLeft;bgShape.stroke=NormalSelectAdormenTemplate.SelectedColor;bgShape.strokeWidth=13;bgShape.opacity=.3;bgShape.visible=!1;bgShape.bind(new go.Binding("strokeWidth","",(function(v,obj){var lineObj=obj.panel.findObject("PATH-subPathShape");var width=13;if(lineObj){width=BindHelper.getPathCustomLineStrokeWidth(v,lineObj);width+=4}return width})));bgShape.bind(new go.Binding("visible","isSelected",(function(v,obj){return obj.part.isSelected&&!!v})));return bgShape};function getSelectedColor(node){var diagram=node.diagram;if(!diagram)return NormalSelectAdormenTemplate.SelectedColor;var selection=diagram.selection;if(selection.size<2)return NormalSelectAdormenTemplate.SelectedColor;var nodeList=[];selection.each((function(part){part instanceof go.Node&&nodeList.push(part)}));return nodeList.length<2?NormalSelectAdormenTemplate.SelectedColor:nodeList[0]===node?NormalSelectAdormenTemplate.FirstSelectedColor:NormalSelectAdormenTemplate.SelectedColor}!function(netBrain){var DrawObject=function(){this.category=null;this.eventHandle=null;this.key=NgUtil.getGUID()};DrawObject.prototype={constructor:DrawObject,init:function(){},setFont:function(node,strFontName){},setFontSize:function(node,nSize){},setFontColor:function(node,strColor){},setFontStyle:function(node,strStyle){},setLineColor:function(node,strColor){},setLineWidth:function(node,nSize){},setLineArrow:function(node,fromTo){},setLineStyle:function(node,nStyle){},setBackColor:function(node,strColor){},setTextAlignment:function(node,strAlignment){},getCategory:function(){return this.category},setCategory:function(obj){this.category=obj},getEventHanle:function(){return this.eventHandle},setEventHanle:function(obj){this.eventHandle=obj},getVisible:function(){return this.visible},setVisible:function(obj){this.visible=obj},getOpacity:function(){return this.opacity},setOpacity:function(obj){this.opacity=obj},click:function(e,node){null!=eventHandle&&eventHandle.click(e,node);console.log("subclass should implement click!")},doubleClick:function(e,node){null!=eventHandle&&eventHandle.doubleClick(e,node);console.log("subclass should implement doubleClick!")},contextClick:function(e,node){null!=eventHandle&&eventHandle.contextClick(e,node);console.log("subclass should implement contextClick!")},mouseEnter:function(e,node){null!=eventHandle&&eventHandle.mouseEnter(e,node);console.log("subclass should implement mouseEnter!")},mouseLeave:function(e,node){null!=eventHandle&&eventHandle.mouseLeave(e,node);console.log("subclass should implement mouseLeave!")},mouseOver:function(e,node){null!=eventHandle&&eventHandle.mouseOver(e,node);console.log("subclass should implement mouseOver!")}};var EventHandle=function(drawObject){this.drawObject=drawObject};EventHandle.prototype={constructor:EventHandle,click:function(e,node){},doubleClick:function(e,node){},contextClick:function(e,node){},mouseEnter:function(e,node){},mouseLeave:function(e,node){},mouseOver:function(e,node){}};netBrain.Map=netBrain.Map||{};netBrain.Map.DrawObject=DrawObject;netBrain.Map.EventHandle=EventHandle}(NetBrain);var VisualSpaceConstant={legacySchemaKeyword:"Legacy",legacySchema:"Legacy",legacyMediaSchema:"Legacy.media",legacyIntfsSchema:"Legacy.ipIntfs",legacyIpIntfsSchema:"Legacy.ipIntfs",legacyIp6IntfsSchema:"Legacy.ip6Intfs",legacyVSpaceIntsanceId:"00000000-0000-0000-0000-000000000000",showStyleLink:"link",showStyleGroup:"group",defaultLegacyL3Template:"00000000-0000-0000-0000-000000000013",defaultLegacyL2Template:"00000000-0000-0000-0000-000000000012",defaultVisualSpaceInstanceId:"00000000-0000-0000-0000-000000000000",defaultVisualSpaceName:"Default Visual Space"};!function(netBrain){var CompBase=function(){netBrain.Map.DrawObject.call(this);this.compModels={isEditableModel:!0}};(CompBase.prototype=new netBrain.Map.DrawObject).setEditableMode=function(nodeObj,bEditable){};CompBase.prototype.isEditableMode=function(nodeObj){};CompBase.prototype.getNodeIdentify=function(){return this.devNodeData?this.devNodeData.nodeIdentify:null};CompBase.prototype.getVisualSpaceInfo=function(){return this.devNodeData?this.devNodeData.visualSpaceInfo:null};CompBase.prototype.getVSNodeIdentify=function(){return this.devNodeData?{id:this.devNodeData.id,nodeIdentify:this.devNodeData.nodeIdentify,visualSpaceInfo:this.devNodeData.visualSpaceInfo}:null};CompBase.prototype.getDevNodeData=function(){return this.devNodeData};CompBase.buildCompMedia=function(){var compMedia=netBrain.Map.CompMedia.getDefaultJson();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compMedia);compMedia.init();return compMedia};CompBase.buildCompUnknownIp=function(imageList){var compUnknownIp=netBrain.Map.CompUnknownIp.getDefaultJson(imageList);netBrain.Map.CompPrototypeFactory.buildCompPrototype(compUnknownIp);compUnknownIp.init();return compUnknownIp};CompBase.buildCompStencil=function(){var compStencil=netBrain.Map.CompStencil.getDefaultJsonData();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compStencil);compStencil.init();return compStencil};CompBase.buildCompStencilExt=function(){var compStencil=netBrain.Map.ComStencilExt.getDefaultJsonData();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compStencil);compStencil.init();return compStencil};CompBase.buildCompTopolink=function(category){if(category){(compTopolink=netBrain.Map.CompVirtualLink.getDefaultJsDataForLinkLine()).category=category}else var compTopolink=netBrain.Map.CompTopolink.getDefaultJsDataForLinkLine();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compTopolink);compTopolink.init();return compTopolink};CompBase.buildCompHighlightNeighborLink=function(){var compLink=netBrain.Map.CompHighlightNeighborLink.getDefaultJsData();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compLink);compLink.init();return compLink};CompBase.buildCompHopLink=function(){var compLink=netBrain.Map.CompHopLink.getDefaultJsData();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compLink);compLink.init();return compLink};CompBase.buildCompNormalLink=function(){var compLink=netBrain.Map.CompNormalLink.getDefaultJsData();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compLink);compLink.init();return compLink};netBrain.Map=netBrain.Map||{};netBrain.Map.CompBase=CompBase}(NetBrain);!function(netBrain){var DrawShapeToolBase=function(){go.Tool.call(this);this.name="DrawShapeTool";this.startPoint=null;this.endPoint=null;this.backColor=null;this.attachData="";this.ShapeType=null;this.ShapeGeoType=null;this._archetypePartData={};this.archetypePartData={category:"",color:this.backColor,stroke:"black",strokeWidth:1,lineStyle:null};this._isLine=!1;this.isAutoUnRegister=!0;this.unRegisterFuncCallBack=function(){};this.startMouseDownTime=null;this.doublClickTimeInterval=300;this.graphicStyle=null;this.mixWidth=100;this.mixHeight=100};go.Diagram.inherit(DrawShapeToolBase,go.Tool);DrawShapeToolBase.prototype.Init=function(){null==this.ShapeType?this._temporaryShape=go.GraphObject.make(go.Shape,{name:netBrain.Map.DrawShapeCommonAttr.ObjName,fill:this.backColor}):this._temporaryShape=go.GraphObject.make(go.Shape,this.ShapeType,{name:netBrain.Map.DrawShapeCommonAttr.ObjName,fill:this.backColor});go.GraphObject.make(go.Part,{layerName:"ShapeTool"},this._temporaryShape)};DrawShapeToolBase.prototype.isLinkableObj=function(category){var categoryArr=[netBrain.Map.CategoryMgr.NetworkDevice,netBrain.Map.CategoryMgr.Stencil,netBrain.Map.CategoryMgr.StencilExt,netBrain.Map.CategoryMgr.L2Device,netBrain.Map.CategoryMgr.Media,netBrain.Map.CategoryMgr.Rect,netBrain.Map.CategoryMgr.Ellipse,netBrain.Map.CategoryMgr.Circle,netBrain.Map.CategoryMgr.Polygon,netBrain.Map.CategoryMgr.CloseArea,netBrain.Map.CategoryMgr.CloseCloud,netBrain.Map.CategoryMgr.Table,netBrain.Map.CategoryMgr.Text,netBrain.Map.CategoryMgr.CallOut];return-1!==_.indexOf(categoryArr,category)};DrawShapeToolBase.prototype.setUnRegisterCallBack=function(callBack){null!=callBack&&(this.unRegisterFuncCallBack=callBack)};DrawShapeToolBase.prototype.setGraphicStyle=function(graphicStyle){this.graphicStyle=graphicStyle;this.isLine||(this.archetypePartData.color=this.graphicStyle.fillColor);this.archetypePartData.lineStyle=this.graphicStyle.lineStyle;this.archetypePartData.stroke=this.graphicStyle.lineColor;this.archetypePartData.strokeWidth=this.graphicStyle.lineWidth};DrawShapeToolBase.prototype.getGraphicStyle=function(){return this.graphicStyle};DrawShapeToolBase.prototype.setFillColor=function(strColor){this.archetypePartData.color=strColor;this.backColor=strColor};DrawShapeToolBase.prototype.Register=function(diagram){diagram.toolManager.mouseDownTools.insertAt(0,this)};DrawShapeToolBase.prototype.UnRegister=function(diagram,bNeedCallback){null!=this&&null!=this.diagram&&null!=this.diagram.toolManager?this.diagram.toolManager.mouseDownTools.remove(this):null!=diagram&&null!=diagram.toolManager&&diagram.toolManager.mouseDownTools.remove(this);!1!==bNeedCallback&&this.unRegisterFuncCallBack()};DrawShapeToolBase.prototype.canStart=function(){if(!this.isEnabled)return!1;var diagram=this.diagram;return null!==diagram&&!diagram.isReadOnly&&!diagram.isModelReadOnly&&(null!==diagram.model&&(!!diagram.firstInput.left&&null===diagram.findObjectAt(diagram.firstInput.documentPoint,null,null)))};DrawShapeToolBase.prototype.doActivate=function(){go.Tool.prototype.doActivate.call(this);this.startTransaction(this.name);this.diagram.isMouseCaptured=!0;this.diagram.currentCursor="crosshair";this.addPoint(this.diagram.lastInput.documentPoint);this.temporaryShape.fill=this.isLine?null:this.backColor};DrawShapeToolBase.prototype.doDeactivate=function(){go.Tool.prototype.doDeactivate.call(this);null!==this.temporaryShape&&this.diagram.remove(this.temporaryShape.part);this.diagram.currentCursor="";this.diagram.isMouseCaptured=!1;this.stopTransaction()};DrawShapeToolBase.prototype.addPoint=function(p){var geo;var shape=this.temporaryShape;if(null!==shape){var viewpt=this.diagram.viewportBounds.position;var pos=new go.Point(viewpt.x+this.diagram.padding.left,viewpt.y+this.diagram.padding.top);var q=new go.Point(p.x-viewpt.x-this.diagram.padding.left,p.y-viewpt.y-this.diagram.padding.top);var part=shape.part;if(null===part.diagram){(geo=new go.Geometry(this.ShapeGeoType)).startX=q.x;geo.startY=q.y;geo.endX=q.x;geo.endY=q.y;this.temporaryShape.geometry=geo;part.position=pos;this.diagram.add(part)}else{(geo=shape.geometry.copy()).endX=q.x;geo.endY=q.y;if(geo.endX===geo.startX&&geo.endY===geo.startY){geo.endX+=this.mixWidth;geo.endY+=this.mixHeight}}shape.geometry=geo}};DrawShapeToolBase.prototype.moveLastPoint=function(p){var shape=this.temporaryShape;var geo=shape.geometry.copy();var viewpt=this.diagram.viewportBounds.position;var width=Math.max(p.x-viewpt.x-this.diagram.padding.left,0);var height=Math.max(p.y-viewpt.y-this.diagram.padding.top,0);geo.endX=width;geo.endY=height;shape.geometry=geo};DrawShapeToolBase.prototype.removeLastPoint=function(){};DrawShapeToolBase.prototype.finishShape=function(){var diagram=this.diagram;var shape=this.temporaryShape;if(null!==shape&&null!==this.archetypePartData){this.removeLastPoint();var tempgeo=shape.geometry;var viewpt=diagram.viewportBounds.position;var geo=tempgeo.copy();var pos=geo.normalize();pos.x=viewpt.x-pos.x+this.diagram.padding.left;pos.y=viewpt.y-pos.y+this.diagram.padding.top;var nodeData=diagram.model.copyNodeData(this.archetypePartData);var tmpPt=netBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(new go.Point(pos.x+geo.bounds.width/2,pos.y+geo.bounds.height/2),diagram);nodeData.location=tmpPt.x+" "+tmpPt.y;geo.normalize();var scale=Math.max(diagram.commandHandler.space,1);geo.scale(1/scale,1/scale);nodeData.geo=go.Geometry.stringify(geo);netBrain.Map.CompPrototypeFactory.buildCompPrototype(nodeData);diagram.model.addNodeData(nodeData);nodeData.category===netBrain.Map.CategoryMgr.Textbox&&(diagram.findNodeForKey(nodeData.key).isSelected=!0);if(geo.type===go.Geometry.Line){var node=diagram.findNodeForData(nodeData);if(null!=node){var lineShape=node.findObject("shapeObj");if(null!=lineShape&&null!=lineShape.geometry){var pathFigures=lineShape.geometry.figures;for(var i=0;i<pathFigures.size;i++){var onePathFigure=pathFigures.get(i);if(null!=onePathFigure){onePathFigure.copy().isFilled=!1}}}}}this.transactionResult=this.name}this.stopTool();this.isAutoUnRegister&&this.UnRegister()};DrawShapeToolBase.prototype.isDoubleClick=function(){var timeObj=new Date;if(null==this.startMouseDownTime)this.startMouseDownTime=timeObj.getTime();else{var tmpTime=timeObj.getTime();if(tmpTime-this.startMouseDownTime<this.doublClickTimeInterval){this.startMouseDownTime=null;return!0}this.startMouseDownTime=tmpTime}return!1};DrawShapeToolBase.prototype.doMouseDown=function(){this.isActive||this.doActivate()};DrawShapeToolBase.prototype.doMouseMove=function(){this.isActive&&this.moveLastPoint(this.diagram.lastInput.documentPoint)};DrawShapeToolBase.prototype.doMouseUp=function(){this.addPoint(this.diagram.lastInput.documentPoint);this.diagram.lastInput.left&&this.finishShape()};DrawShapeToolBase.prototype.doKeyDown=function(){if(this.isActive){var e=this.diagram.lastInput;"\r"===e.key?this.finishShape():"Z"===e.key?this.undo():go.Tool.prototype.doKeyDown.call(this)}};DrawShapeToolBase.prototype.undo=function(){this.removeLastPoint();var lastInput=this.diagram.lastInput;lastInput.event instanceof window.MouseEvent&&this.moveLastPoint(lastInput.documentPoint)};Object.defineProperty(DrawShapeToolBase.prototype,"isLine",{get:function(){return this._isLine},set:function(val){this._isLine=val}});Object.defineProperty(DrawShapeToolBase.prototype,"temporaryShape",{get:function(){return this._temporaryShape},set:function(val){if(this._temporaryShape!==val&&null!==val){val.name="SHAPE";var panel=this._temporaryShape.panel;panel.remove(this._temporaryShape);this._temporaryShape=val;panel.add(this._temporaryShape)}}});Object.defineProperty(DrawShapeToolBase.prototype,"archetypePartData",{get:function(){return this._archetypePartData},set:function(val){this._archetypePartData=val}});netBrain.Map=netBrain.Map||{};netBrain.Map.DrawShapeToolBase=DrawShapeToolBase}(NetBrain);!function(netBrain){var CompDrawShapeBase=function(){this.shapeData={category:"",attachData:"",loc:"0,0",color:null,stroke:"white",strokeWidth:0,geo:null,scale:0,angle:0,bound:null,lineStyle:null,textAlign:"center",fromArrow:"",toArrow:""}};(CompDrawShapeBase.prototype=new netBrain.Map.DrawObject).construct=CompDrawShapeBase;CompDrawShapeBase.prototype.setFont=function(node,strFontName){if(null!=node){var textBlock=node.findObject(DrawShapeCommonAttr.textName);if(null!=textBlock){var fontParser=new FontParser;fontParser.fromString(textBlock.font);fontParser.setFontFamily(strFontName);textBlock.font=fontParser.toString()}}};CompDrawShapeBase.prototype.setFontSize=function(node,nSize){if(null!=node){var textBlock=node.findObject(DrawShapeCommonAttr.textName);if(null!=textBlock){var fontParser=new FontParser;fontParser.fromString(textBlock.font);fontParser.setFontSize(nSize+"px");textBlock.font=fontParser.toString()}}};CompDrawShapeBase.prototype.setFontColor=function(node,strColor){if(null!=node){var textBlock=node.findObject(DrawShapeCommonAttr.textName);null!=textBlock&&(textBlock.stroke=strColor)}};CompDrawShapeBase.prototype.setPragraphAlign=function(align,diagram){diagram.model.setDataProperty(this,"textAlign",align)};CompDrawShapeBase.prototype.setFontStyle=function(node,strStyle){if(null!=node){var textBlock=node.findObject(DrawShapeCommonAttr.textName);if(null!=textBlock){var fontString=textBlock.font;var fontParse=new FontParser;fontParse.fromString(fontString);switch(strStyle){case"bold":var fontWeight=fontParse.getFontWeight();"bold"===(fontWeight=(fontWeight=fontWeight.trim()).toLowerCase())?fontParse.setFontWeight("normal"):fontParse.setFontWeight("bold");textBlock.font=fontParse.toString();break;case"italic":var fontStyle=fontParse.getFontStyle();"italic"===(fontStyle=(fontStyle=fontStyle.trim()).toLowerCase())?fontParse.setFontStyle("normal"):fontParse.setFontStyle("italic");textBlock.font=fontParse.toString();break;case"underscore":textBlock.isUnderline=!textBlock.isUnderline;break;case"strikethrough":textBlock.isStrikethrough=!textBlock.isStrikethrough}}}};CompDrawShapeBase.prototype.setLineColor=function(node,strColor){if(null!=node){var transactionName=NgUtil.getUniqueStr("setLineColor");node.diagram.startTransaction(transactionName);var shapeObj=node.findObject(DrawShapeCommonAttr.ObjName);if(null!=shapeObj){shapeObj.stroke=strColor;node.diagram.commitTransaction(transactionName)}}};CompDrawShapeBase.prototype.setLineWidth=function(node,nSize){if(null!=node){var transactionName=NgUtil.getUniqueStr("setLineWidth");node.diagram.model.setDataProperty(node.data,"shapeLineWidth",nSize);node.diagram.commitTransaction(transactionName)}};CompDrawShapeBase.prototype.setLineArrow=function(node,fromTo){if(null!=node&&node instanceof go.Link){var transactionName=NgUtil.getUniqueStr("setLineArrow");node.diagram.startTransaction(transactionName);switch(fromTo){case"from":this.fromArrow="BackwardBoomerang";this.toArrow="";break;case"to":this.fromArrow="";this.toArrow="Boomerang";break;case"both":this.fromArrow="BackwardBoomerang";this.toArrow="Boomerang";break;case"none":this.fromArrow="";this.toArrow=""}node.updateTargetBindings();node.diagram.commitTransaction(transactionName)}},CompDrawShapeBase.prototype.setLineStyle=function(node,dashArray){if(null!=node){var transactionName=NgUtil.getUniqueStr("setLineStyle");node.diagram.startTransaction(transactionName);var shapeObj=node.findObject(DrawShapeCommonAttr.ObjName);if(null!=shapeObj){shapeObj.strokeDashArray=dashArray;node.diagram.commitTransaction(transactionName)}}},CompDrawShapeBase.prototype.setBackColor=function(node,strColor){if(null!=node){var transactionName=NgUtil.getUniqueStr("setBackColor");node.diagram.startTransaction(transactionName);var shapeObj=node.findObject(DrawShapeCommonAttr.ObjName);if(null!=shapeObj){shapeObj.fill=strColor;node.diagram.commitTransaction(transactionName)}}},CompDrawShapeBase.prototype.setTextBlockBackColor=function(node,strColor){if(null!=node){var shapeObj=node.findObject(DrawShapeCommonAttr.textName);null!=shapeObj&&(shapeObj.background=strColor)}},CompDrawShapeBase.prototype.setTextAlignment=function(node,strAlignment){if(null!=node){var textBlock=node.findObject(DrawShapeCommonAttr.textName);null!=textBlock&&(textBlock.textAlign=strAlignment)}},CompDrawShapeBase.prototype.getCateGory=function(){return this.shapeData.category};CompDrawShapeBase.prototype.getBackColor=function(){return this.shapeData.color};CompDrawShapeBase.prototype.setBackCssColor=function(strCssColor){this.shapeData.color=strCssColor};CompDrawShapeBase.prototype.getLocation=function(){return this.shapeData.location};CompDrawShapeBase.prototype.setLocation=function(strLocation){this.shapeData.location=strLocation};CompDrawShapeBase.prototype.getBorderColor=function(){return this.shapeData.stroke};CompDrawShapeBase.prototype.setBorderColor=function(strCssColor){this.shapeData.stroke=strCssColor};CompDrawShapeBase.prototype.getBorderLineWidth=function(){return this.shapeData.strokeWidth};CompDrawShapeBase.prototype.setBorderLineWidth=function(nBorderLineWidth){this.shapeData.strokeWidth=nBorderLineWidth};CompDrawShapeBase.prototype.getGeoString=function(){return this.shapeData.geo};CompDrawShapeBase.prototype.setGeoString=function(strGeo){this.shapeData.geo=strGeo};CompDrawShapeBase.prototype.getScale=function(){return this.shapeData.scale};CompDrawShapeBase.prototype.setScale=function(dScale){this.shapeData.scale=dScale};CompDrawShapeBase.prototype.getAngle=function(){return this.shapeData.angle};CompDrawShapeBase.prototype.setAngle=function(nAngle){this.shapeData.angle=nAngle};CompDrawShapeBase.prototype.getBoundRectStr=function(){return this.shapeData.bound};CompDrawShapeBase.prototype.setBoundRectStr=function(strBoundRect){this.shapeData.bound=strBoundRect};CompDrawShapeBase.prototype.getLineStyleStr=function(){return this.shapeData.lineStyle};CompDrawShapeBase.prototype.setLineStyleStr=function(strLineStyle){this.shapeData.lineStyle=strLineStyle};var DrawShapeCommonAttr=function(){};DrawShapeCommonAttr.prototype={construct:DrawShapeCommonAttr};DrawShapeCommonAttr.getCommonPanelType=function(){return"Auto"};DrawShapeCommonAttr.ObjName="shapeObj";DrawShapeCommonAttr.EVENT_NAMES={COMMON_NODE_ATTR_DOUBLE_CLICK:"DRAW_SHAPE_COMMON_ATTR_COMMON_NODE_ATTR_DOUBLE_CLICK",COMMON_NODE_ATTR_CONTEXT_CLICK:"DRAW_SHAPE_COMMON_ATTR_COMMON_NODE_ATTR_CONTEXT_CLICK"};DrawShapeCommonAttr.getCommonNodeAttr=function(templateOption,map,scope){var $=go.GraphObject.make;var nodeResizeAdornmentTemplate=$(go.Adornment,"Spot",{locationSpot:go.Spot.Center},$(go.Placeholder),$(go.Shape,{alignment:go.Spot.TopLeft,cursor:"nw-resize",desiredSize:new go.Size(6,6),fill:"lightblue",stroke:"deepskyblue"}),$(go.Shape,{alignment:go.Spot.Top,cursor:"n-resize",desiredSize:new go.Size(6,6),fill:"lightblue",stroke:"deepskyblue"}),$(go.Shape,{alignment:go.Spot.TopRight,cursor:"ne-resize",desiredSize:new go.Size(6,6),fill:"lightblue",stroke:"deepskyblue"}),$(go.Shape,{alignment:go.Spot.Left,cursor:"w-resize",desiredSize:new go.Size(6,6),fill:"lightblue",stroke:"deepskyblue"}),$(go.Shape,{alignment:go.Spot.Right,cursor:"e-resize",desiredSize:new go.Size(6,6),fill:"lightblue",stroke:"deepskyblue"}),$(go.Shape,{alignment:go.Spot.BottomLeft,cursor:"se-resize",desiredSize:new go.Size(6,6),fill:"lightblue",stroke:"deepskyblue"}),$(go.Shape,{alignment:go.Spot.Bottom,cursor:"s-resize",desiredSize:new go.Size(6,6),fill:"lightblue",stroke:"deepskyblue"}),$(go.Shape,{alignment:go.Spot.BottomRight,cursor:"sw-resize",desiredSize:new go.Size(6,6),fill:"lightblue",stroke:"deepskyblue"}));var nodeRotateAdornmentTemplate=$(go.Adornment,{locationSpot:go.Spot.Center,locationObjectName:"CIRCLE"},$(go.Shape,"Circle",{name:"CIRCLE",cursor:cursorHelper.pointer,desiredSize:new go.Size(7,7),fill:"lightblue",stroke:"deepskyblue"}),$(go.Shape,{geometryString:"M3.5 7 L3.5 30",isGeometryPositioned:!0,stroke:"deepskyblue",strokeWidth:1.5,strokeDashArray:[4,2]}));return[{selectionAdorned:!0,selectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate(),layoutConditions:go.Part.LayoutShown,layerName:GlobalContext.NormalShapObjName,text:"attach data",resizable:!0,resizeObjectName:DrawShapeCommonAttr.ObjName,resizeAdornmentTemplate:nodeResizeAdornmentTemplate,rotatable:!0,rotateObjectName:DrawShapeCommonAttr.ObjName,rotateAdornmentTemplate:nodeRotateAdornmentTemplate,locationSpot:go.Spot.Center,doubleClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(DrawShapeCommonAttr.EVENT_NAMES.COMMON_NODE_ATTR_DOUBLE_CLICK,event,target)},contextClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(DrawShapeCommonAttr.EVENT_NAMES.COMMON_NODE_ATTR_CONTEXT_CLICK,event,target)}},new go.Binding("layerName").makeTwoWay(),new go.Binding("text","attachData").makeTwoWay(),new go.Binding("location","location",templateOption.locationParse).makeTwoWay(templateOption.ptStringif),DrawShapeCommonAttr.getCommonNodeScaleBinding()]};DrawShapeCommonAttr.getCommonShapeAttr=function(){return[{name:DrawShapeCommonAttr.ObjName,fill:"rgba(0,0,0,0)"},new go.Binding("fill","color").makeTwoWay(),new go.Binding("angle").makeTwoWay(),new go.Binding("stroke","shapeLineColor").makeTwoWay(),new go.Binding("strokeWidth","shapeLineWidth",(function(lineWidth,node){var scale=Math.max(node.diagram.commandHandler.space,1);return(lineWidth=_.isNumber(lineWidth)?lineWidth:1)/scale})),new go.Binding("geometry","geo",go.Geometry.parse).makeTwoWay(go.Geometry.stringify),new go.Binding("scale").makeTwoWay(),new go.Binding("angle").makeTwoWay(),new go.Binding("textAlign").makeTwoWay(),new go.Binding("desiredSize","bound",go.Size.parse).makeTwoWay(go.Size.stringify),new go.Binding("strokeDashArray","lineStyle").makeTwoWay()]};DrawShapeCommonAttr.getCommonNodeScaleBinding=function(){return new go.Binding("scale","",(function(v,node){var part=node.part;var scale=Math.max(node.diagram.commandHandler.space,1);var shape=part.findObject(netBrain.Map.DrawShapeCommonAttr.ObjName);if(shape){var lineWidth=part.data.shapeLineWidth;lineWidth=_.isNumber(lineWidth)?lineWidth:1;shape.strokeWidth=lineWidth/scale}return scale}))};DrawShapeCommonAttr.getCommonPictureAttr=function(){return[{imageStretch:go.GraphObject.Default},new go.Binding("source")]};DrawShapeCommonAttr.textName="textName";DrawShapeCommonAttr.getCommonTextBlockAttr=function(){return[{name:DrawShapeCommonAttr.textName,editable:!0,font:BindHelper.defaultLargeFont,alignment:go.Spot.Center,alignmentFocus:go.Spot.Center,text:"",margin:1,background:null,textAlign:"center"},new go.Binding("text","textContent",BindHelper.toTarget_deviceNote_leadingSpacePrefix).makeTwoWay(BindHelper.toTarget_deviceNote_noLeadingSpacePrefix),new go.Binding("alignment","alignment").makeTwoWay(),new go.Binding("textAlign").makeTwoWay(),new go.Binding("font").makeTwoWay(),new go.Binding("stroke").makeTwoWay(),new go.Binding("fill").makeTwoWay(),new go.Binding("isStrikethrough","isStrikethrough").makeTwoWay(),new go.Binding("isUnderline","isUnderline").makeTwoWay(),new go.Binding("angle","angle").makeTwoWay(),new go.Binding("desiredSize","geo",(function(geo,node){var retSize=new go.Size(0,0);var geoObj=go.Geometry.parse(geo);retSize.width=geoObj.bounds.width;retSize.height=geoObj.bounds.height;return retSize})),new go.Binding("desiredSize","bound",(function(bound,node){var retSize=new go.Size(0,0);""!==bound&&(retSize=go.Size.parse(bound));return retSize})).makeTwoWay((function(v,data){data.bound=go.Size.stringify(v);return data.bound}))]};DrawShapeCommonAttr.getCommonTextBlockScaleBinding=function(){return new go.Binding("scale","",(function(v,node){var commandHandler=node.diagram.commandHandler;var scale=Math.max(commandHandler.space,1);return scale=1/scale}))};DrawShapeCommonAttr.getCommonShapeAttrWithoutGeo=function(){var shapeOptions=DrawShapeCommonAttr.getCommonShapeAttr();return shapeOptions=_.filter(shapeOptions,(function(op){var flag=!0;op instanceof go.Binding&&"geo"===op.sourceProperty&&(flag=!1);return flag}))};DrawShapeCommonAttr.getCommonTextBlockAttrWithoutGeo=function(){var textOptions=DrawShapeCommonAttr.getCommonTextBlockAttr();(textOptions=_.filter(textOptions,(function(op){var flag=!0;op instanceof go.Binding&&_.some(["bound"],(function(sp){return sp===op.sourceProperty}))&&(flag=!1);return flag}))).push(new go.Binding("desiredSize","bound",(function(bound,node){var retSize=new go.Size(0,0);""!==bound&&(retSize=go.Size.parse(bound));return retSize})));return textOptions};function CompDrawShapeBaseNode(){go.Node.apply(this,arguments)}go.Diagram.inherit(CompDrawShapeBaseNode,go.Node);CompDrawShapeBaseNode.prototype.getShapeInfo=function(){var shapeInfo;var shapeObj=this.findObject(DrawShapeCommonAttr.ObjName);shapeObj&&(shapeInfo=netBrain.Map.visioTools.getShapeInfo(shapeObj));return shapeInfo};CompDrawShapeBaseNode.prototype.getTextInfo=function(){var textInfo;var textObj=this.findObject(DrawShapeCommonAttr.textName);textObj&&(textInfo=netBrain.Map.visioTools.getTextInfo(textObj,!0));return textInfo};CompDrawShapeBaseNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var shapeInfo=this.getShapeInfo();shapeInfo&&visioInfos.push(shapeInfo);var textInfo=this.getTextInfo();textInfo&&visioInfos.push(textInfo);return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};netBrain.Map=netBrain.Map||{};netBrain.Map.CompDrawShapeBase=CompDrawShapeBase;netBrain.Map.CompDrawShapeBaseNode=CompDrawShapeBaseNode;netBrain.Map.ShapTemplateCommonOption=function(){this.templateOption={scope:null,pathClick:null,locationParse:null,ptStringif:null,tableDBClick:null}};netBrain.Map.DrawShapeCommonAttr=DrawShapeCommonAttr}(NetBrain);!function(netBrain){var CompCallOutLink=function(){};(CompCallOutLink.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompCallOutLink;CompCallOutLink.prototype.setFromTo=function(fromKey,toKey){this.from=fromKey;this.to=toKey};CompCallOutLink.getVarCategory=function(){return netBrain.Map.CategoryMgr.CompCallOutLink};CompCallOutLink.getMapTemplate=function(){var $=go.GraphObject.make;return $(netBrain.Map.CallOutCustomizeLink,go.Link.None,{name:"callOutLinkline",layerName:GlobalContext.NormalShapBelowObjName,fromEndSegmentLength:50,toEndSegmentLength:50,relinkableFrom:!0,relinkableTo:!0,selectionAdorned:!1},new go.Binding("layerName").makeTwoWay(),new go.Binding("from","from").makeTwoWay(),new go.Binding("to","to").makeTwoWay(),$(go.Shape,{name:netBrain.Map.DrawShapeCommonAttr.ObjName,isPanelMain:!0,strokeWidth:1,stroke:"black",fill:"yellow"},new go.Binding("strokeWidth","lineWidth").makeTwoWay(),new go.Binding("stroke","color").makeTwoWay(),new go.Binding("fill","backColor")))};CompCallOutLink.getDefaultJsonData=function(){return{category:CompCallOutLink.getVarCategory(),color:"black",backColor:"yellow",from:"",to:"",lineWidth:1}};netBrain.Map=netBrain.Map||{};netBrain.Map.CompCallOutLink=CompCallOutLink}(NetBrain);!function(netBrain){var CompRectangle=function(){};(CompRectangle.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompRectangle;CompRectangle.getMapTemplate=function(templateOption,map,scope){var $=go.GraphObject.make;return $(CompRectangleNode,"Spot",netBrain.Map.DrawShapeCommonAttr.getCommonNodeAttr(templateOption,map,scope),$(go.Shape,netBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr()),$(go.TextBlock,netBrain.Map.DrawShapeCommonAttr.getCommonTextBlockAttrWithoutGeo()))};CompRectangle.getVarCategory=function(){return netBrain.Map.CategoryMgr.Rect};var DrawRectangleTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="RectangleDrawing";this.backColor="rgba(0,0,0,0)";this.ShapeType="Rectangle";this.ShapeGeoType=go.Geometry.Rectangle;this.archetypePartData={category:CompRectangle.getVarCategory(),color:"rgba(0,0,0,0)",source:"",shapeLineColor:"black",shapeLineWidth:1,lineStyle:null,font:"normal 20px Arial"};this.Init()};DrawRectangleTool.prototype=new netBrain.Map.DrawShapeToolBase;function CompRectangleNode(){netBrain.Map.CompDrawShapeBaseNode.apply(this,arguments)}go.Diagram.inherit(CompRectangleNode,netBrain.Map.CompDrawShapeBaseNode);netBrain.Map=netBrain.Map||{};netBrain.Map.CompRectangle=CompRectangle;netBrain.Map.DrawRectangleTool=DrawRectangleTool}(NetBrain);!function(netBrain){var CompPolygon=function(){};(CompPolygon.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompPolygon;CompPolygon.getMapTemplate=function(templateOption,map,scope){var $=go.GraphObject.make;var nodeAttr=netBrain.Map.DrawShapeCommonAttr.getCommonNodeAttr(templateOption,map,scope);nodeAttr[0].reshapable=!0;nodeAttr[0].rotatable=!1;nodeAttr[0].resizable=!1;return $(CompPolygonNode,nodeAttr,$(go.Shape,netBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr()))};CompPolygon.getVarCategory=function(){return netBrain.Map.CategoryMgr.Polygon};var DrawPolygonTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="PolygonDrawing";this.backColor="gray";this.ShapeGeoType=void 0;this.isLine=!1;this.archetypePartData={category:CompPolygon.getVarCategory(),color:"rgba(0,0,0,0)",shapeLineColor:"black",shapeLineWidth:1,lineStyle:null,font:"normal 20px Arial"};this.Init()};(DrawPolygonTool.prototype=new netBrain.Map.DrawShapeToolBase).addPoint=function(p){var fig,geo;var shape=this.temporaryShape;if(null!==shape){var viewpt=this.diagram.viewportBounds.position;var pos=new go.Point(viewpt.x+this.diagram.padding.left,viewpt.y+this.diagram.padding.top);var q=new go.Point(p.x-viewpt.x-this.diagram.padding.left,p.y-viewpt.y-this.diagram.padding.top);var part=shape.part;if(null===part.diagram){fig=new go.PathFigure(q.x,q.y,!0);(geo=new go.Geometry).figures.add(fig);this.temporaryShape.geometry=geo;part.position=pos;this.diagram.add(part)}else(fig=(geo=shape.geometry.copy()).figures.first()).segments.add(new go.PathSegment(go.PathSegment.Line,q.x,q.y));shape.geometry=geo}};DrawPolygonTool.prototype.moveLastPoint=function(p){var shape=this.temporaryShape;var geo=shape.geometry.copy();var segs=geo.figures.first().segments;if(segs.count>0){var viewpt=this.diagram.viewportBounds.position;var seg=segs.elt(segs.count-1);var width=Math.max(p.x-viewpt.x-this.diagram.padding.left,0);var height=Math.max(p.y-viewpt.y-this.diagram.padding.top,0);seg.endX=width;seg.endY=height;shape.geometry=geo}};DrawPolygonTool.prototype.removeLastPoint=function(){var shape=this.temporaryShape;var geo=shape.geometry.copy();var segs=geo.figures.first().segments;if(segs.count>0){segs.removeAt(segs.count-1);shape.geometry=geo}};DrawPolygonTool.prototype.doMouseDown=function(){if(this.isDoubleClick())this.finishShape();else{this.isActive||this.doActivate();this.addPoint(this.diagram.lastInput.documentPoint);this.diagram.lastInput.left||this.finishShape()}};DrawPolygonTool.prototype.doMouseUp=function(){};DrawPolygonTool.prototype.finishShape=function(){var diagram=this.diagram;var shape=this.temporaryShape;if(null!==shape&&null!==this.archetypePartData){this.removeLastPoint();var tempgeo=shape.geometry;if(tempgeo.figures.first().segments.count>=(this.isLine?1:2)){var viewpt=diagram.viewportBounds.position;var geo=tempgeo.copy();if(!this.isLine){var segs=geo.figures.first().segments;segs.elt(segs.count-1).isClosed=!0}var pos=geo.normalize();pos.x=viewpt.x-pos.x+this.diagram.padding.left;pos.y=viewpt.y-pos.y+this.diagram.padding.top;var nodeData=diagram.model.copyNodeData(this.archetypePartData);var tmpPt=netBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(new go.Point(pos.x+geo.bounds.width/2,pos.y+geo.bounds.height/2),diagram);nodeData.location=tmpPt.x+" "+tmpPt.y;var space=diagram.model.modelData.space;space&&space>=1&&geo.scale(1/space,1/space);nodeData.geo=go.Geometry.stringify(geo);netBrain.Map.CompPrototypeFactory.buildCompPrototype(nodeData);diagram.model.addNodeData(nodeData);this.transactionResult=this.name}}this.stopTool();this.isAutoUnRegister&&this.UnRegister()};function CompPolygonNode(){netBrain.Map.CompDrawShapeBaseNode.apply(this,arguments)}go.Diagram.inherit(CompPolygonNode,netBrain.Map.CompDrawShapeBaseNode);netBrain.Map=netBrain.Map||{};netBrain.Map.CompPolygon=CompPolygon;netBrain.Map.DrawPolygonTool=DrawPolygonTool}(NetBrain);!function(netBrain){var DrawPolygonLineTool=function(){netBrain.Map.DrawPolygonTool.call(this);this.isLine=!0};DrawPolygonLineTool.prototype=new netBrain.Map.DrawPolygonTool;netBrain.Map=netBrain.Map||{};netBrain.Map.DrawPolygonLineTool=DrawPolygonLineTool}(NetBrain);!function(netBrain){var CompCloseArea=function(){};CompCloseArea.prototype={construct:CompCloseArea};(CompCloseArea.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompCloseArea;CompCloseArea.getMapTemplate=function(templateOption,map,scope){var $=go.GraphObject.make;var nodeAttr=netBrain.Map.DrawShapeCommonAttr.getCommonNodeAttr(templateOption,map,scope);nodeAttr[0].reshapable=!0;nodeAttr[0].rotatable=!1;nodeAttr[0].resizable=!1;return $(CompCloseAreaNode,nodeAttr,$(go.Shape,netBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr()))};CompCloseArea.getVarCategory=function(){return netBrain.Map.CategoryMgr.CloseArea};CompCloseArea.CloseArea=0;CompCloseArea.CloseAreaLine=1;var DrawCloseAreaTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="CloseAreaDrawing";this.backColor="gray";this.ShapeGeoType=void 0;this.isLine=!1;this.archetypePartData={category:CompCloseArea.getVarCategory(),color:"rgba(0,0,0,0)",shapeLineColor:"black",shapeLineWidth:1,lineStyle:null,font:"normal 20px Arial",closeAreaType:this.isLine?CompCloseArea.CloseAreaLine:CompCloseArea.CloseArea};this.tempGeometry=new go.Geometry;this.Init()};(DrawCloseAreaTool.prototype=new netBrain.Map.DrawShapeToolBase).addPoint=function(p){var geo;var fig;var shape=this.temporaryShape;if(null!==shape){var viewpt=this.diagram.viewportBounds.position;var pos=new go.Point(viewpt.x+this.diagram.padding.left,viewpt.y+this.diagram.padding.top);var q=new go.Point(p.x-viewpt.x-this.diagram.padding.left,p.y-viewpt.y-this.diagram.padding.top);var part=shape.part;if(null===part.diagram){fig=new go.PathFigure(q.x,q.y,!1);(geo=this.tempGeometry.copy()).figures.add(fig);this.tempGeometry=geo;this.temporaryShape.geometry=this.getCurveFromPolyGeo(geo);part.position=pos;this.diagram.add(part)}else{var segs=(fig=(geo=this.tempGeometry.copy()).figures.first()).segments;var newPt=new go.PathSegment(go.PathSegment.Bezier,q.x,q.y,q.x,q.y,q.x,q.y);var nCount=fig.segments.count;var x,y,tmpFirstSeg;if(1===nCount){x=fig.startX;y=fig.startY;tmpFirstSeg=new go.PathSegment(go.PathSegment.Bezier,x,y,x,y,x,y);this.recalCenterSegCtrlPt(tmpFirstSeg,segs.elt(nCount-1),null)}if(2===nCount){x=fig.startX;y=fig.startY;tmpFirstSeg=new go.PathSegment(go.PathSegment.Bezier,x,y,x,y,x,y);this.recalCenterSegCtrlPt(tmpFirstSeg,segs.elt(nCount-2),segs.elt(nCount-1))}nCount>=3&&this.recalCenterSegCtrlPt(segs.elt(nCount-3),segs.elt(nCount-2),segs.elt(nCount-1));fig.segments.add(newPt);this.tempGeometry=geo;shape.geometry=this.getCurveFromPolyGeo(this.tempGeometry)}}};DrawCloseAreaTool.prototype.recalCenterSegCtrlPt=function(seg1,seg2,seg3){var pt1,pt2,pt3,ret;if(null!=seg1&&null!=seg2&&null==seg3){pt1=new go.Point(seg1.endX,seg1.endY);pt2=new go.Point(seg2.endX,seg2.endY);if(null==(ret=this.getTwoCtrlPoint(pt1,pt2,null)))return;seg2.point1X=pt1.x;seg2.point1Y=pt1.y;seg2.point2X=ret.ctrlPt1.x;seg2.point2Y=ret.ctrlPt1.y}else if(null!=seg1&&null!=seg2&&null!=seg3){pt1=new go.Point(seg1.endX,seg1.endY);pt2=new go.Point(seg2.endX,seg2.endY);pt3=new go.Point(seg3.endX,seg3.endY);if(null==(ret=this.getTwoCtrlPoint(pt1,pt2,pt3)))return;seg2.point2X=ret.ctrlPt1.x;seg2.point2Y=ret.ctrlPt1.y;seg3.point1X=ret.ctrlPt2.x;seg3.point1Y=ret.ctrlPt2.y;seg3.point2X=pt3.x;seg3.point2Y=pt3.y}};DrawCloseAreaTool.prototype.getCurveFromPolyGeo=function(geo){if(null!=geo)return geo.copy()};DrawCloseAreaTool.prototype.moveLastPoint=function(p){var shape=this.temporaryShape;var geo=this.tempGeometry.copy();var pathFigure=geo.figures.first();var segs=pathFigure.segments;var nCount=segs.count;if(nCount>0){var viewpt=this.diagram.viewportBounds.position;var width=Math.max(p.x-viewpt.x-this.diagram.padding.left,0);var height=Math.max(p.y-viewpt.y-this.diagram.padding.top,0);var seg=segs.elt(nCount-1);var x,y,tmpFirstSeg;seg.endX=width;seg.endY=height;seg.point1X=width;seg.point1Y=height;seg.point2X=width;seg.point2Y=height;if(1===nCount){x=pathFigure.startX;y=pathFigure.startY;tmpFirstSeg=new go.PathSegment(go.PathSegment.Bezier,x,y,x,y,x,y);this.recalCenterSegCtrlPt(tmpFirstSeg,seg,null)}if(2===nCount){x=pathFigure.startX;y=pathFigure.startY;tmpFirstSeg=new go.PathSegment(go.PathSegment.Bezier,x,y,x,y,x,y);this.recalCenterSegCtrlPt(tmpFirstSeg,segs.elt(nCount-2),seg)}nCount>=3&&this.recalCenterSegCtrlPt(segs.elt(nCount-3),segs.elt(nCount-2),seg);this.tempGeometry=geo;shape.geometry=this.getCurveFromPolyGeo(geo)}};DrawCloseAreaTool.prototype.removeLastPoint=function(){var shape=this.temporaryShape;var geo=this.tempGeometry;var segs=geo.figures.first().segments;if(segs.count>0){segs.removeAt(segs.count-1);this.tempGeometry=geo;shape.geometry=this.getCurveFromPolyGeo(geo)}};DrawCloseAreaTool.prototype.doMouseDown=function(){if(this.isDoubleClick())this.finishShape();else{this.isActive||this.doActivate();this.addPoint(this.diagram.lastInput.documentPoint);this.diagram.lastInput.left||this.finishShape()}};DrawCloseAreaTool.prototype.doMouseUp=function(){};DrawCloseAreaTool.prototype.finishShape=function(){var diagram=this.diagram;if(null!==this.temporaryShape&&null!==this.archetypePartData){this.removeLastPoint();var tempgeo=this.tempGeometry.copy();var nCount=tempgeo.figures.first().segments.count;if(nCount>=(this.isLine?1:2)){var viewpt=diagram.viewportBounds.position;var geo=tempgeo.copy();var segs=geo.figures.first().segments;if(!this.isLine){var lastSeg=segs.elt(nCount-1);null!=lastSeg&&lastSeg.close()}var pos=geo.normalize();pos.x=viewpt.x-pos.x+this.diagram.padding.left;pos.y=viewpt.y-pos.y+this.diagram.padding.top;var nodeData=diagram.model.copyNodeData(this.archetypePartData);var tmpPt=netBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(new go.Point(pos.x+geo.bounds.width/2,pos.y+geo.bounds.height/2),diagram);nodeData.location=tmpPt.x+" "+tmpPt.y;var space=diagram.model.modelData.space;var figureGeo=this.getCurveFromPolyGeo(geo,!0);space&&space>=1&&figureGeo.scale(1/space,1/space);nodeData.geo=go.Geometry.stringify(figureGeo);netBrain.Map.CompPrototypeFactory.buildCompPrototype(nodeData);nodeData.closeAreaType=this.isLine?CompCloseArea.CloseAreaLine:CompCloseArea.CloseArea;diagram.model.addNodeData(nodeData);this.transactionResult=this.name}}this.stopTool();this.isAutoUnRegister&&this.UnRegister()};DrawCloseAreaTool.prototype.getTwoCtrlPoint=function(pt1,pt2,pt3){var retValue={ctrlPt1:null,ctrlPt2:null};var preCtrlPt=null;var nextCtrlPt=null;var prevloc=pt1;var thisloc=pt2;var nextloc=pt3;if(null!==prevloc&&null!==nextloc){var prevang=thisloc.directionPoint(prevloc);var nextang=thisloc.directionPoint(nextloc);var avg=(prevang+nextang)/2;var clockwise=prevang>nextang;if(Math.abs(prevang-nextang)>180){avg+=180;clockwise=!clockwise}avg>=360&&(avg-=360);(preCtrlPt=new go.Point(2*Math.sqrt(thisloc.distanceSquaredPoint(prevloc))/5,0)).rotate(avg+(clockwise?90:-90));preCtrlPt.add(thisloc);(nextCtrlPt=new go.Point(2*Math.sqrt(thisloc.distanceSquaredPoint(nextloc))/5,0)).rotate(avg-(clockwise?90:-90));nextCtrlPt.add(thisloc)}else if(null!==nextloc){preCtrlPt=null;nextCtrlPt=thisloc}else if(null!==prevloc){preCtrlPt=thisloc;nextCtrlPt=null}retValue.ctrlPt1=null==preCtrlPt?null:preCtrlPt.copy();retValue.ctrlPt2=null==nextCtrlPt?null:nextCtrlPt.copy();return retValue};DrawCloseAreaTool.prototype.UnRegister=function(diagram,bNeedCallback){null!=this&&null!=this.diagram&&null!=this.diagram.toolManager?this.diagram.toolManager.mouseDownTools.remove(this):null!=diagram&&null!=diagram.toolManager&&diagram.toolManager.mouseDownTools.remove(this);this.tempGeometry=new go.Geometry;!1!==bNeedCallback&&this.unRegisterFuncCallBack()};function CompCloseAreaNode(){netBrain.Map.CompDrawShapeBaseNode.apply(this,arguments)}go.Diagram.inherit(CompCloseAreaNode,netBrain.Map.CompDrawShapeBaseNode);netBrain.Map=netBrain.Map||{};netBrain.Map.CompCloseArea=CompCloseArea;netBrain.Map.DrawCloseAreaTool=DrawCloseAreaTool}(NetBrain);!function(netBrain){var CompCurve=function(){};(CompCurve.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompCurve;CompCurve.getMapTemplate=function(templateOption,map,scope){var $=go.GraphObject.make;return $(CompCurveNode,netBrain.Map.DrawShapeCommonAttr.getCommonNodeAttr(templateOption,map,scope),$(go.Shape,netBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr()))};CompCurve.getVarCategory=function(){return netBrain.Map.CategoryMgr.Curve};var DrawCurveTool=function(){netBrain.Map.DrawCloseAreaTool.call(this);this.isLine=!0};(DrawCurveTool.prototype=new netBrain.Map.DrawCloseAreaTool).setGraphicStyle=function(graphicStyle){netBrain.Map.DrawCloseAreaTool.prototype.setGraphicStyle.apply(this,arguments);this.archetypePartData.color=this.graphicStyle.fillColor};function CompCurveNode(){netBrain.Map.CompDrawShapeBaseNode.apply(this,arguments)}go.Diagram.inherit(CompCurveNode,netBrain.Map.CompDrawShapeBaseNode);netBrain.Map=netBrain.Map||{};netBrain.Map.CompCurve=CompCurve;netBrain.Map.DrawCurveTool=DrawCurveTool}(NetBrain);!function(netBrain){var CompText=function(){};(CompText.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompText;CompText.EVENT_NAMES={TEXT_CONTENT_CLICK:"COMP_TEXT_TEXT_CONTEXT_CLICK"};CompText.getMapTemplate=function(templateOption,map,scope){var $=go.GraphObject.make;var nodeAttr=netBrain.Map.DrawShapeCommonAttr.getCommonNodeAttr(templateOption,map,scope);nodeAttr[0].defaultStretch=go.GraphObject.Horizontal;var textAttr=netBrain.Map.DrawShapeCommonAttr.getCommonTextBlockAttrWithoutGeo();return $(CompTextNode,"Spot",{contextClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompText.EVENT_NAMES.TEXT_CONTENT_CLICK,event,target)}},nodeAttr,$(go.Shape,netBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr()),$(go.TextBlock,textAttr))};CompText.getVarCategory=function(){return netBrain.Map.CategoryMgr.Text};var DrawTextTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="RectangleDrawing";this.backColor=NetBrain.Map.Const.noteDefaultBackColor;this.ShapeType="Rectangle";this.ShapeGeoType=go.Geometry.Rectangle;this.archetypePartData={category:CompText.getVarCategory(),color:"yellow",source:"",textContent:"New Text",alignment:go.Spot.topLeft,shapeLineColor:"black",shapeLineWidth:1,lineStyle:null,font:"normal 20px Arial"};this.Init()};(DrawTextTool.prototype=new netBrain.Map.DrawShapeToolBase).setGraphicStyle=function(graphicStyle){this.graphicStyle=graphicStyle;this.isLine||(this.archetypePartData.color=this.graphicStyle.fillColor);this.archetypePartData.lineStyle=this.graphicStyle.lineStyle;this.archetypePartData.stroke=this.graphicStyle.lineColor;this.archetypePartData.strokeWidth=this.graphicStyle.lineWidth;this.archetypePartData.font=this.getFontByGraphicStyle(graphicStyle)};DrawTextTool.prototype.getFontByGraphicStyle=function(graphicStyle){if(null==graphicStyle)return"";var retStr="";graphicStyle.fontBold&&(retStr+=" bold ");graphicStyle.fontItalic&&(retStr+=" italic ");graphicStyle.fontBold||graphicStyle.fontItalic||(retStr+=" normal ");graphicStyle.fontBold&&(retStr+=" bold ");graphicStyle.fontItalic&&(retStr+=" italic ");retStr+=graphicStyle.fontSize+"px";return retStr=(retStr+=" "+graphicStyle.fontFamily).trim()};DrawTextTool.prototype.finishShape=function(){var diagram=this.diagram;var shape=this.temporaryShape;if(null!==shape&&null!==this.archetypePartData){this.removeLastPoint();var tempgeo=shape.geometry;var viewpt=diagram.viewportBounds.position;var geo=tempgeo.copy();var pos=geo.normalize();pos.x=viewpt.x-pos.x+this.diagram.padding.left;pos.y=viewpt.y-pos.y+this.diagram.padding.top;var nodeData=netBrain.Map.CompDeviceNote.getDefaultJsonData(!0);var tmpPt=netBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(new go.Point(pos.x+geo.bounds.width/2,pos.y+geo.bounds.height/2),diagram);nodeData.location=tmpPt.x+" "+tmpPt.y;geo.normalize();nodeData.size={width:geo.bounds.width||350,height:geo.bounds.height||180};nodeData.noteTitle="Title";nodeData.noteContent="Content";nodeData.lastModifyUser=window.gUserName;nodeData.modifyTime=TimeUtil.formatDateTime(new Date);netBrain.Map.CompPrototypeFactory.buildCompPrototype(nodeData);diagram.model.addNodeData(nodeData);this.transactionResult=this.name}this.stopTool();this.isAutoUnRegister&&this.UnRegister()};function CompTextNode(){netBrain.Map.CompDrawShapeBaseNode.apply(this,arguments)}go.Diagram.inherit(CompTextNode,netBrain.Map.CompDrawShapeBaseNode);CompTextNode.prototype.getVisioInfo=function(){var result=netBrain.Map.CompDrawShapeBaseNode.prototype.getVisioInfo.apply(this,arguments);if(this.diagram){var visioTools=netBrain.Map.visioTools;result.layerIndex=visioTools.getLayerIndexByLayerName(this.diagram,GlobalContext.DeviceNoteLayerName)}else result.layerIndex=7;return result};netBrain.Map=netBrain.Map||{};netBrain.Map.CompText=CompText;netBrain.Map.DrawTextTool=DrawTextTool}(NetBrain);!function(netBrain){var CompEllipse=function(){};(CompEllipse.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompEllipse;CompEllipse.getMapTemplate=function(templateOption,map,scope){var $=go.GraphObject.make;return $(CompEllipseNode,netBrain.Map.DrawShapeCommonAttr.getCommonNodeAttr(templateOption,map,scope),$(go.Shape,netBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr()),$(go.TextBlock,netBrain.Map.DrawShapeCommonAttr.getCommonTextBlockAttrWithoutGeo()))};CompEllipse.getVarCategory=function(){return netBrain.Map.CategoryMgr.Ellipse};var DrawEllipseTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="EllipseDrawing";this.backColor="rgba(0,0,0,0)";this.ShapeType="Ellipse";this.ShapeGeoType=go.Geometry.Ellipse;this.archetypePartData={category:CompEllipse.getVarCategory(),color:"rgba(0,0,0,0)",shapeLineColor:"black",shapeLineWidth:1,lineStyle:null,font:"normal 20px Arial"};this.Init()};(DrawEllipseTool.prototype=new netBrain.Map.DrawShapeToolBase).isDoubleClick=function(){var timeObj=new Date;if(null==this.startMouseDownTime)this.startMouseDownTime=timeObj.getTime();else{var tmpTime=timeObj.getTime();if(tmpTime-this.startMouseDownTime<this.doublClickTimeInterval){this.startMouseDownTime=null;return!0}this.startMouseDownTime=tmpTime}return!1};DrawEllipseTool.prototype.doMouseDown=function(){this.isActive||this.doActivate()};function CompEllipseNode(){netBrain.Map.CompDrawShapeBaseNode.apply(this,arguments)}go.Diagram.inherit(CompEllipseNode,netBrain.Map.CompDrawShapeBaseNode);netBrain.Map=netBrain.Map||{};netBrain.Map.CompEllipse=CompEllipse;netBrain.Map.DrawEllipseTool=DrawEllipseTool}(NetBrain);!function(netBrain){var CompLine=function(){};(CompLine.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompLine;CompLine.fromArrowName="linkFromArrow";CompLine.toArrowName="linkToArrow";CompLine.LineShapeName="baseLink";CompLine.prototype.setLineWidth=function(link,nSize){if(link instanceof go.Link){link.findObject(CompLine.LineShapeName).strokeWidth=nSize;link.findObject(CompLine.fromArrowName).strokeWidth=nSize;link.findObject(CompLine.toArrowName).strokeWidth=nSize}},CompLine.prototype.setLineStyle=function(link,dashArray){if(null!=link){var shapeObj=link.findObject(CompLine.LineShapeName);null!=shapeObj&&(shapeObj.strokeDashArray=dashArray)}},CompLine.prototype.setLineColor=function(link,strColor){if(null!=link){link.findObject(CompLine.LineShapeName).stroke=strColor;link.findObject(CompLine.fromArrowName).stroke=strColor;link.findObject(CompLine.toArrowName).stroke=strColor;link.findObject(CompLine.fromArrowName).fill=strColor;link.findObject(CompLine.toArrowName).fill=strColor}};CompLine.prototype.getKey=function(){return null};CompLine.EVENT_NAMES={CONTEXT_CLICK:"COMP_LINE_CONTEXT_CLICK"};CompLine.getMapTemplate=function(templateOption,diagram,scope){var $=go.GraphObject.make;return $(CompGraphLine,{selectable:!0,selectionChanged:function(link){if(null!=link){var lineShape=link.findObject(CompLine.LineShapeName);null!==lineShape&&(link.isSelected?lineShape.opacity=0:lineShape.opacity=1)}},selectionAdornmentTemplate:NormalSelectAdormenTemplate.getLinkArrowTemplate(),layerName:GlobalContext.NormalShapObjName,reshapable:!0,contextClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompLine.EVENT_NAMES.CONTEXT_CLICK,event,target)}},new go.Binding("points","points",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayParse(diagram,data,node)})).makeTwoWay((function(pts,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayStringify(diagram,pts,data)})),new go.Binding("location","location",templateOption.locationParse).makeTwoWay(templateOption.ptStringif),$(go.Shape,{name:CompLine.LineShapeName,isPanelMain:!0,strokeWidth:1},new go.Binding("stroke").makeTwoWay(),new go.Binding("strokeWidth").makeTwoWay(),new go.Binding("strokeDashArray","lineStyle").makeTwoWay(),new go.Binding("toArrow").makeTwoWay(),new go.Binding("fromArrow").makeTwoWay()),$(go.Shape,{name:"forSelecting",isPanelMain:!0,stroke:"transparent",strokeWidth:10}),$(go.Shape,{name:CompLine.toArrowName,toArrow:"Standard"},new go.Binding("stroke").makeTwoWay(),new go.Binding("fill").makeTwoWay(),new go.Binding("strokeWidth").makeTwoWay(),new go.Binding("segmentOffset","",(function(v){return new go.Point(v.strokeWidth||1,0)})).makeTwoWay(),new go.Binding("toArrow").makeTwoWay()),$(go.Shape,{name:CompLine.fromArrowName,fromArrow:"Standard"},new go.Binding("stroke").makeTwoWay(),new go.Binding("fill").makeTwoWay(),new go.Binding("strokeWidth").makeTwoWay(),new go.Binding("segmentOffset","",(function(v){return new go.Point(-(v.strokeWidth||1),0)})).makeTwoWay(),new go.Binding("fromArrow").makeTwoWay()))};CompLine.getVarCategory=function(){return netBrain.Map.CategoryMgr.Line};function CompGraphLine(){go.Link.apply(this,arguments)}go.Diagram.inherit(CompGraphLine,go.Link);CompGraphLine.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var lineInfo=visioTools.getShapeVisioInfo(this,CompLine.LineShapeName);visioInfos.push(lineInfo);var toArrow=visioTools.getShapeVisioInfo(this,CompLine.toArrowName);if(toArrow.geometryString){visioTools.addDirection(toArrow,!1);visioInfos.push(toArrow)}var fromArrow=visioTools.getShapeVisioInfo(this,CompLine.fromArrowName);if(fromArrow.geometryString){visioTools.addDirection(fromArrow,!0);visioInfos.push(fromArrow)}return visioTools.buildLinkVisioInfo(visioInfos,this.data,this)};var DrawLineTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="MapLineDrawing";this.isLine=!0;this.backColor="rgba(0,0,0,0)";this.ShapeType="Line1";this.ShapeGeoType=go.Geometry.Line;this.clicked=!1;this.Init();this.linePoints=new go.List;this.devJsonArrary=[];this.addLinkCallBack=function(from,to){}};(DrawLineTool.prototype=new netBrain.Map.DrawShapeToolBase).canStart=function(){if(!this.isEnabled)return!1;var diagram=this.diagram;if(null===diagram||diagram.isReadOnly||diagram.isModelReadOnly)return!1;if(null===diagram.model)return!1;if(!diagram.firstInput.left)return!1;var obj=diagram.findObjectAt(diagram.firstInput.documentPoint,null,null);return!(null==obj||!this.isLinkableObj(obj.part.category))||null===obj};DrawLineTool.prototype.finishShape=function(){var diagram=this.diagram;if(null!==this.temporaryShape){this.removeLastPoint();this.linePoints.add(new go.Point(this.diagram.lastInput.documentPoint.x,this.diagram.lastInput.documentPoint.y));var lineObjData={category:CompLine.getVarCategory()};if(this.devJsonArrary.length>=2){var from=this.devJsonArrary[0].key;var to=this.devJsonArrary[this.devJsonArrary.length-1].key;this.addLinkCallBack(from,to)}else{var newPoints=[];var pointsArray=this.linePoints.toArray();if(null!=pointsArray)for(var n=0;n<pointsArray.length;n++){var retPt=NetBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(pointsArray[n],diagram);newPoints.push(go.Point.stringify(retPt))}lineObjData.points=newPoints;netBrain.Map.CompPrototypeFactory.buildCompPrototype(lineObjData);lineObjData.fromArrow="";lineObjData.toArrow="";diagram.model.addLinkData(lineObjData)}this.transactionResult=this.name}this.stopTool();this.isAutoUnRegister&&this.UnRegister()};DrawLineTool.prototype.doMouseMove=function(){netBrain.Map.DrawShapeToolBase.prototype.doMouseMove.call(this);var part=this.diagram.findPartAt(this.diagram.lastInput.documentPoint);if(null!=part&&this.isLinkableObj(part.category)){if(0!==this.devJsonArrary.length)return;this.devJsonArrary.push(part.data)}};DrawLineTool.prototype.doMouseDown=function(){this.linePoints.clear();netBrain.Map.DrawShapeToolBase.prototype.doMouseDown.call(this);this.linePoints.add(new go.Point(this.diagram.lastInput.documentPoint.x,this.diagram.lastInput.documentPoint.y))};DrawLineTool.prototype.doMouseUp=function(){var part=this.diagram.findPartAt(this.diagram.lastInput.documentPoint);if(null!=part&&this.isLinkableObj(part.category)){var key=part.data.key;if(0!==this.devJsonArrary.length&&this.devJsonArrary[this.devJsonArrary.length-1].key===key)return;this.devJsonArrary.push(part.data)}this.diagram.lastInput.left&&this.finishShape();delete this.devJsonArrary;this.devJsonArrary=[]};netBrain.Map=netBrain.Map||{};netBrain.Map.CompLine=CompLine;netBrain.Map.DrawLineTool=DrawLineTool}(NetBrain);!function(netBrain){var CompCircle=function(){};(CompCircle.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompCircle;CompCircle.getVarMapCircleTemplate=function(templateOption){var $=go.GraphObject.make;return $(go.Node,netBrain.Map.DrawShapeCommonAttr.getCommonPanelType(),netBrain.Map.DrawShapeCommonAttr.getCommonNodeAttr(templateOption),$(go.Shape,netBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr()),$(go.TextBlock,netBrain.Map.DrawShapeCommonAttr.getCommonTextBlockAttr()))};CompCircle.getVarCategory=function(){return netBrain.Map.CategoryMgr.Circle};var DrawCircleTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="CircleDrawing";this.backColor="rgba(0,0,0,0)";this.ShapeType="Circle";this.ShapeGeoType=go.Geometry.Ellipse;this.archetypePartData={category:CompCircle.getVarCategory(),color:"rgba(0,0,0,0)",geo:new go.Geometry(go.Geometry.Elllipse),source:"",loc:new go.Point(0,0),shapeLineColor:"black",shapeLineWidth:1,lineStyle:null};this.Init()};(DrawCircleTool.prototype=new netBrain.Map.DrawShapeToolBase).computeTheCircleLastPoint=function(ptInput){var p=new go.Point(ptInput.x,ptInput.y);var width=p.x-this.startPoint.x;var height=p.y-this.startPoint.y;var widthABS=Math.abs(width);var deltaValue=Math.abs(height)-widthABS;deltaValue<0?width<0?p.x-=deltaValue:p.x+=deltaValue:height<0?p.y+=deltaValue:p.y-=deltaValue;return p};netBrain.Map=netBrain.Map||{};netBrain.Map.CompCircle=CompCircle;netBrain.Map.DrawCircleTool=DrawCircleTool}(NetBrain);!function(netBrain){var CompCloud=function(){};(CompCloud.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompCloud;CompCloud.getCloudGeometry=function(){var geo=go.Geometry.parse("M 28.3374 26.2136 c 0.332159 -8.51486 11.3115 -6.99518 10.801 -1.57767 c 2.52344 -5.38343 8.4192 -2.29644 8.00967 0.728157 c 3.474 -0.00938416 4.23527 4.39242 1.2136 5.58252 c 0.61911 2.52506 -0.28775 4.97257 -3.76213 4.49029 c -2.0181 3.76529 -7.37565 1.96113 -7.64563 0.485439 c -3.18263 4.47094 -8.17863 1.63818 -7.52425 -2.06313 c -3.10776 0.910374 -4.87612 -0.0108757 -5.33981 -3.03395 c 0.143091 -2.65899 1.6096 -3.86379 4.24757 -4.61165 Z",!0);geo.normalize();return geo};CompCloud.getMapTemplate=function(templateOption,map,scope){var $=go.GraphObject.make;var shapAttrs=netBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr();shapAttrs[0].geometry=CompCloud.getCloudGeometry();return $(CompCloudNode,netBrain.Map.DrawShapeCommonAttr.getCommonNodeAttr(templateOption,map,scope),$(go.Shape,shapAttrs),$(go.TextBlock,netBrain.Map.DrawShapeCommonAttr.getCommonTextBlockAttr()))};CompCloud.getVarCategory=function(){return netBrain.Map.CategoryMgr.CloseCloud};var DrawCloseCloudTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="CloseCloud";this.backColor="white";this.ShapeGeoType=void 0;this.isLine=!1;this.archetypePartData={category:CompCloud.getVarCategory(),color:"rgba(0,0,0,0)",shapeLineColor:"black",shapeLineWidth:1,lineStyle:null,font:"normal 20px Arial"};this.startPoint=null;this.endPoint=null;this.Init()};(DrawCloseCloudTool.prototype=new netBrain.Map.DrawShapeToolBase).Init=function(){this._temporaryShape=go.GraphObject.make(go.Shape,{name:netBrain.Map.DrawShapeCommonAttr.ObjName,fill:this.backColor});this._temporaryShape.geometry=CompCloud.getCloudGeometry();go.GraphObject.make(go.Part,{layerName:"ShapeTool"},this._temporaryShape)};DrawCloseCloudTool.prototype.doMouseDown=function(){this.startPoint=new go.Point(this.diagram.lastInput.documentPoint.x,this.diagram.lastInput.documentPoint.y);var ptNow=this.diagram.lastInput.documentPoint;var part=this.temporaryShape.part;if(null!=part){part.position=ptNow;this.temporaryShape.desiredSize=new go.Size(1,1);this.diagram.add(part)}};DrawCloseCloudTool.prototype.doMouseMove=function(){if(this.isActive){this.endPoint=new go.Point(this.diagram.lastInput.documentPoint.x,this.diagram.lastInput.documentPoint.y);if(null==this.startPoint||null==this.endPoint)return;var width=this.endPoint.x-this.startPoint.x;var height=this.endPoint.y-this.startPoint.y;if(width<=0||height<=0)return;this.temporaryShape.desiredSize=new go.Size(width,height)}};DrawCloseCloudTool.prototype.addPoint=function(p){};DrawCloseCloudTool.prototype.finishShape=function(){var diagram=this.diagram;var shape=this.temporaryShape;if(null!==shape&&null!==this.archetypePartData){this.removeLastPoint();var nodeData=diagram.model.copyNodeData(this.archetypePartData);var pos=shape.part.position;shape.geometry.copy();var tmpPt=netBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(new go.Point(pos.x+shape.actualBounds.width/2,pos.y+shape.actualBounds.height/2),diagram);nodeData.location=tmpPt.x+" "+tmpPt.y;var size=shape.desiredSize.copy();if(size.width<this.mixWidth&&size.height<this.mixHeight){size.width=this.mixWidth;size.height=this.mixHeight}var scale=Math.max(diagram.commandHandler.space,1);size.setTo(1*size.width/scale,1*size.height/scale);nodeData.bound=go.Size.stringify(size);netBrain.Map.CompPrototypeFactory.buildCompPrototype(nodeData);diagram.model.addNodeData(nodeData);this.transactionResult=this.name}this.stopTool();this.isAutoUnRegister&&this.UnRegister()};function CompCloudNode(){netBrain.Map.CompDrawShapeBaseNode.apply(this,arguments)}go.Diagram.inherit(CompCloudNode,netBrain.Map.CompDrawShapeBaseNode);netBrain.Map=netBrain.Map||{};netBrain.Map.CompCloud=CompCloud;netBrain.Map.DrawCloseCloudTool=DrawCloseCloudTool}(NetBrain);!function(netBrain){var GlobalMacro=function(globalMacro){null==globalMacro&&(globalMacro={});globalMacro.DefaultEmptyText="...";return globalMacro}(GlobalMacro);function TableTemplateInterface(){}TableTemplateInterface.prototype={constuct:TableTemplateInterface,fromJsonData:function(jsonObject){},getJsonData:function(){}};var CTableCell=function(){this.key=null;this.stroke="black";this.text=GlobalMacro.DefaultEmptyText;this.fontString=BindHelper.defaultLargeFont};(CTableCell.prototype=new TableTemplateInterface).setKey=function(nRow,nCol){this.key=CTableCell.getCellName(nRow,nCol)};CTableCell.prototype.fromJsonData=function(jsonObject){};CTableCell.prototype.getJsonData=function(){};CTableCell.getNodeTemplate=function(){var $=go.GraphObject.make;return $(go.Panel,"Auto",{stretch:go.GraphObject.Fill},new go.Binding("key","cellName").makeTwoWay(),new go.Binding("row").makeTwoWay(),new go.Binding("column").makeTwoWay(),new go.Binding("fill","cellBackColor").makeTwoWay(),$(go.TextBlock,new go.Binding("text").makeTwoWay(),new go.Binding("font").makeTwoWay(),new go.Binding("isStrikethrough").makeTwoWay(),new go.Binding("isUnderline").makeTwoWay(),new go.Binding("textAlign").makeTwoWay(),new go.Binding("stroke").makeTwoWay(),{stretch:go.GraphObject.Fill,editable:!0,isMultiline:!0,margin:new go.Margin(6,6,6,0)}))};CTableCell.parse=function(cellDataJson){var newTableCell=new CTableCell;if(null!=cellDataJson){newTableCell.key=CTableCell.getCellName(cellDataJson.row,cellDataJson.col);newTableCell.stroke=cellDataJson.stroke;newTableCell.text=cellDataJson.text;newTableCell.fontString=cellDataJson.font}return newTableCell};CTableCell.getCellName=function(nRow,nCol){return"tableCell"+nRow+"/"+nCol};var CompTable=function CompTable(){this.BOLD=function(){return"bold"};this.ITALIC=function(){return"italic"};this.FONTSIZEREG=function(){return"\\d+px"};this.location="300 300";this.tableBorderColor="black";this.tableBorderWidth=3;this.tableBackColor="lightgray";this.headerBackColor="lightblue";this.headerLineColor="black";this.headerLineWidth=2;this.category=CompTable.getVarCategory();this.size="400 150";this.cellArrary=[];this._defaultTableData={location:this.location,tableBorderColor:this.tableBorderColor,tableBorderWidth:this.tableBorderWidth,tableBackColor:this.tableBackColor,headerBackColor:this.headerBackColor,headerLineColor:this.headerLineColor,headerLineWidth:this.headerLineWidth,category:this.category,size:this.size,cellArrary:this.cellArrary};this.headTextColor="black";this.headTextFontBold=!0;this.headTextFontItaly=!1;this.headTextFontUnderLine=!1;this.headTextFontName="Arial";this.headTextFontSize="18px";this.contentTextColor="black";this.contentTextFontBold=!1;this.contentTextFontItaly=!1;this.contentTextFontUnderLine=!1;this.contentTextFontName="Arial";this.contentTextFontSize="14px";this.tabelCellArrary=[];this.defaultCellWidth=60;this.defaultCellHeight=30;this.tableSize=new go.Size(this.defaultCellWidth,this.defaultCellHeight);this.tableData=this._defaultTableData};(CompTable.prototype=new netBrain.Map.CompBase).constructor=CompTable;CompTable.prototype.init=function(){this._defaultTableData={location:this.location,tableBorderColor:this.tableBorderColor,tableBorderWidth:this.tableBorderWidth,tableBackColor:this.tableBackColor,headerBackColor:this.headerBackColor,headerLineColor:this.headerLineColor,headerLineWidth:this.headerLineWidth,category:this.category,size:this.size,cellArrary:this.cellArrary};this.tableData=this._defaultTableData;this.key=NgUtil.getGUID()};CompTable.prototype.setPosition=function(ptPosition){this.tableData.location=ptPosition.x+" "+ptPosition.y};CompTable.prototype.getTableOriginData=function(){var retArray=[];null!=this.tabelCellArrary&&(retArray=this.tabelCellArrary);return retArray};CompTable.prototype.setTableOriginData=function(varArray){this.tabelCellArrary=varArray};CompTable.prototype.getNodeDataJsonObj=function(){return this.tableData};CompTable.prototype.CreateTable=function(nRowCount,nColCount){delete this.tabelCellArrary;this.tabelCellArrary=[];for(var i=0;i<nRowCount;i++){this.tabelCellArrary.push([]);for(var j=0;j<nColCount;j++)this.tabelCellArrary[i].push(new CTableCell)}this.tableSize.width=this.defaultCellWidth*nColCount;this.tableSize.height=this.defaultCellHeight*nRowCount};CompTable.prototype.getDefaultTableSize=function(){return this.tableSize};CompTable.prototype.setHeaderAttribute=function(strHeadTextColor,bHeadTextFontBold,bHeadTextFontItaly,bHeadTextFontUnderLine,strHeadTextFontName,nHeadTextFontSize){null!=strHeadTextColor&&(this.headTextColor=strHeadTextColor);null!=bHeadTextFontBold&&(this.headTextFontBold=bHeadTextFontBold);null!=bHeadTextFontItaly&&(this.headTextFontItaly=bHeadTextFontItaly);null!=bHeadTextFontUnderLine&&(this.headTextFontUnderLine=bHeadTextFontUnderLine);null!=strHeadTextFontName&&(this.headTextFontName=strHeadTextFontName);null!=nHeadTextFontSize&&(this.headTextFontSize=nHeadTextFontSize)};CompTable.prototype.setContentAttribute=function(strContentTextColor,bContentTextFontBold,bContentTextFontItaly,bContentTextFontUnderLine,strContentTextFontName,nContentTextFontSize){null!=strContentTextColor&&(this.contentTextColor=strContentTextColor);null!=bContentTextFontBold&&(this.contentTextFontBold=bContentTextFontBold);null!=bContentTextFontItaly&&(this.contentTextFontItaly=bContentTextFontItaly);null!=bContentTextFontUnderLine&&(this.contentTextFontUnderLine=bContentTextFontUnderLine);null!=strContentTextFontName&&(this.contentTextFontName=strContentTextFontName);null!=nContentTextFontSize&&(this.contentTextFontSize=nContentTextFontSize)};CompTable.prototype.setCellText=function(nRowIndex,nColumnIndex,strCellText){if(null==nRowIndex||nRowIndex<0)return!1;if(null==nColumnIndex||nColumnIndex<0)return!1;if(this.tabelCellArrary.length<nRowIndex)return!1;if(this.tabelCellArrary[nRowIndex].length<nColumnIndex)return!1;this.tabelCellArrary[nRowIndex][nColumnIndex].text=strCellText};CompTable.prototype.UpdateDataToJson=function(){this.tableData.cellArrary=[];for(var i=0;i<this.tabelCellArrary.length;i++)this.ProcessRowJson(i);this.tableData.size=go.Size.stringify(this.tableSize)};CompTable.prototype.CreateFromJson=function(tableJson){if(null!=tableJson){this._defaultTableData=tableJson;this.tableData=this._defaultTableData;var bSetHeaderAttr=!1,bSetContentAttr=!1;this.createNullTableFromJson(tableJson.cellArrary);for(var i=0;i<tableJson.cellArrary.length;i++){var cellData=tableJson.cellArrary[i];var tableCell=CTableCell.parse(cellData);this.tabelCellArrary[cellData.row][cellData.column]=tableCell;if(0===cellData.row&&!bSetHeaderAttr){this.ParseHeadFontString(cellData.font);this.headTextFontUnderLine=cellData.isUnderline;bSetHeaderAttr=!0}if(0!==cellData.row&&!bSetContentAttr){this.ParseContentFontString(cellData.font);this.contentTextFontUnderLine=cellData.isUnderline;bSetContentAttr=!0}}}};CompTable.prototype.createNullTableFromJson=function(cellArray){var rowCount=-1,colCount=-1;for(var i=0;i<cellArray.length;i++){var cellData=cellArray[i];cellData.row>rowCount&&(rowCount=cellData.row);cellData.column>colCount&&(colCount=cellData.column)}rowCount++;colCount++;delete this.tabelCellArrary;rowCount<=0||colCount<=0||this.CreateTable(rowCount,colCount)};CompTable.prototype.ProcessRowJson=function(nRowIndex){if(null==nRowIndex||nRowIndex<0||this.tabelCellArrary.length<nRowIndex)return!1;var colArrary=this.tabelCellArrary[nRowIndex];for(var col=0;col<colArrary.length;col++){var cellJson=this.ProcessColumnJson(nRowIndex,col);this.tableData.cellArrary.push(cellJson)}return!0};CompTable.prototype.ProcessColumnJson=function(nRowIndex,nColIndex){if(null==nRowIndex||nRowIndex<0||nRowIndex>this.tabelCellArrary.length)return null;if(null==nColIndex||nColIndex<0||nColIndex>this.tabelCellArrary[0].length)return null;var tableCellRef=this.tabelCellArrary[nRowIndex][nColIndex];var cellJsonRet=new Object;cellJsonRet.row=nRowIndex;cellJsonRet.column=nColIndex;cellJsonRet.text=null==tableCellRef.text?GlobalMacro.DefaultEmptyText:tableCellRef.text;cellJsonRet.cellName=CTableCell.getCellName(nRowIndex,nColIndex);if(0===nRowIndex){cellJsonRet.stroke=this.headTextColor;cellJsonRet.font=this.getHeaderFontString();cellJsonRet.isUnderline=this.headTextFontUnderLine}else{cellJsonRet.stroke=this.contentTextColor;cellJsonRet.font=this.getContentFontString();cellJsonRet.isUnderline=this.contentTextFontUnderLine}return cellJsonRet};CompTable.prototype.getHeaderFontString=function(nRowIndex,nColIndex){var retFontString="";!0===this.headTextFontItaly&&(retFontString+=this.ITALIC());!0===this.headTextFontBold&&(retFontString+=" "+this.BOLD());null!=this.headTextFontSize&&-1==(retFontString+=" "+this.headTextFontSize).indexOf("px")&&(retFontString+="px ");null!=this.headTextFontName&&(retFontString+=" "+this.headTextFontName);return retFontString};CompTable.prototype.ParseHeadFontString=function(strFont){if(!(null==strFont||strFont.length<=0)){-1!==strFont.search(this.BOLD())&&(this.headTextFontBold=!0);-1!==strFont.search(this.ITALIC())&&(this.headTextFontItaly=!0);var fontSizeArrary=strFont.match(this.FONTSIZEREG());if(null!=fontSizeArrary&&fontSizeArrary.length>0){var fontString=fontSizeArrary[0];var exIndex=fontString.search("px");-1!==exIndex&&(this.headTextFontSize=parseInt(fontString.substring(0,exIndex),10))}var dataArrary=strFont.split("\\s");if(0!==dataArrary.length){var fontName=dataArrary[dataArrary.length-1];this.headTextFontName=fontName instanceof String?fontName:"arial"}-1!==strFont.search(this.BOLD)&&(this.headTextFontBold=!0)}};CompTable.prototype.getContentFontString=function(nRowIndex,nColIndex){var retFontString="";!0===this.contentTextFontItaly&&(retFontString+=this.ITALIC());!0===this.contentTextFontBold&&(retFontString+=" "+this.BOLD());null!=this.contentTextFontSize&&-1==(retFontString+=" "+this.contentTextFontSize).indexOf("px")&&(retFontString+="px ");null!=this.contentTextFontName&&(retFontString+=" "+this.contentTextFontName);return retFontString};CompTable.prototype.ParseContentFontString=function(strFont){if(!(null==strFont||strFont.length<=0)){-1!==strFont.search(this.BOLD())&&(this.contentTextFontBold=!0);-1!==strFont.search(this.ITALIC())&&(this.contentTextFontItaly=!0);var fontSizeArrary=strFont.match(this.FONTSIZEREG());if(null!=fontSizeArrary&&fontSizeArrary.length>0){var fontString=fontSizeArrary[0];var exIndex=fontString.search("px");-1!==exIndex&&(this.contentTextFontSize=parseInt(fontString.substring(0,exIndex),10))}var dataArrary=strFont.split("\\s");if(0!==dataArrary.length){var fontName=dataArrary[dataArrary.length-1];this.contentTextFontName=fontName instanceof String?fontName:"arial"}-1!==strFont.search(this.BOLD)&&(this.contentTextFontBold=!0)}};CompTable.getVarCategory=function(){return netBrain.Map.CategoryMgr.Table};CompTable.EVENT_NAMES={CONTEXT_CLICK:"COMP_TABLE_CONTEXT_CLICK"};CompTable.getMapTemplate=function(templateOption,map,scope){var $=go.GraphObject.make;return $(CompTableNode,"Auto",{resizable:!0,resizeObjectName:"tableTarget",layerName:GlobalContext.NormalShapObjName,locationSpot:go.Spot.Center,contextClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTable.EVENT_NAMES.CONTEXT_CLICK,event,target)},selectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate()},new go.Binding("layerName").makeTwoWay(),new go.Binding("location","location",templateOption.locationParse).makeTwoWay(templateOption.ptStringif),$(go.Shape,{fill:"white",stroke:"black",strokeWidth:1.5},new go.Binding("stroke","tableBorderColor").makeTwoWay(),new go.Binding("strokeWidth","tableBorderWidth").makeTwoWay()),$(go.Panel,"Table",{name:"tableTarget",defaultRowSeparatorStroke:"black",defaultColumnSeparatorStroke:"black",defaultColumnSeparatorStrokeWidth:1,defaultRowSeparatorStrokeWidth:1,itemTemplate:CTableCell.getNodeTemplate(),background:"lightblue"},$(go.RowColumnDefinition,{row:0,separatorStrokeWidth:0,background:"gray"},new go.Binding("background","headerBackColor").makeTwoWay()),$(go.RowColumnDefinition,{row:1,separatorStrokeWidth:3,separatorStroke:"black"},new go.Binding("separatorStroke","headerLineColor").makeTwoWay(),new go.Binding("separatorStrokeWidth","headerLineWidth").makeTwoWay()),new go.Binding("desiredSize","size",go.Size.parse).makeTwoWay(go.Size.stringify),new go.Binding("background","tableBackColor").makeTwoWay(),new go.Binding("itemArray","cellArrary").makeTwoWay()))};function CompTableNode(){go.Node.apply(this,arguments)}go.Diagram.inherit(CompTableNode,go.Node);CompTableNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var info=JSON.parse(JSON.stringify(this.data));info.type="table";delete info.tableData;delete info._defaultTableData;visioInfos.push(info);return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};netBrain.Map=netBrain.Map||{};netBrain.Map.CompTable=CompTable}(NetBrain);!function(netBrain){var CompCallOut=function(){};(CompCallOut.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompCallOut;CompCallOut.prototype.getKey=function(){return this.key};CompCallOut.prototype.setFont=function(node,strFontName){if(null!=node){var fontParser=new FontParser;var textTitle=node.findObject("noteTitlePanelText");if(null!=textTitle){fontParser.fromString(textTitle.font);fontParser.setFontFamily(strFontName);textTitle.font=fontParser.toString()}var textTime=node.findObject("noteSysTimePanelText");if(null!=textTime){fontParser.fromString(textTime.font);fontParser.setFontFamily(strFontName);textTime.font=fontParser.toString()}var textContent=node.findObject("noteContentPanelText");if(null!=textContent){fontParser.fromString(textContent.font);fontParser.setFontFamily(strFontName);textContent.font=fontParser.toString()}}};CompCallOut.prototype.setFontSize=function(node,nSize){if(null!=node){var fontParser=new FontParser;var textTitle=node.findObject("noteTitlePanelText");if(null!=textTitle){fontParser.fromString(textTitle.font);fontParser.setFontSize(parseInt(nSize)+4+"px");textTitle.font=fontParser.toString()}var textTime=node.findObject("noteSysTimePanelText");if(null!=textTime){fontParser.fromString(textTime.font);fontParser.setFontSize(nSize-2+"px");textTime.font=fontParser.toString()}var textContent=node.findObject("noteContentPanelText");if(null!=textContent){fontParser.fromString(textContent.font);fontParser.setFontSize(nSize+"px");textContent.font=fontParser.toString()}}};CompCallOut.prototype.setFontColor=function(node,strColor){if(null!=node){var textArray=[];var textTitle=node.findObject("noteTitlePanelText");textArray.push(textTitle);var textContent=node.findObject("noteContentPanelText");textArray.push(textContent);for(var i=0;i<textArray.length;i++){var textBlock=textArray[i];null!=textBlock&&(textBlock.stroke=strColor)}}};CompCallOut.prototype.setFontStyle=function(node,strStyle){if(null!=node){var textArray=[];var textTitle=node.findObject("noteTitlePanelText");textArray.push(textTitle);var textTime=node.findObject("noteSysTimePanelText");textArray.push(textTime);var textContent=node.findObject("noteContentPanelText");textArray.push(textContent);var fontParse;var textBlock;var i;switch(strStyle){case"bold":fontParse=new FontParser;for(i=0;i<textArray.length;i++)if(null!=(textBlock=textArray[i])){fontParse.fromString(textBlock.font);var fontWeight=fontParse.getFontWeight();"bold"===(fontWeight=(fontWeight=fontWeight.trim()).toLowerCase())?fontParse.setFontWeight("normal"):fontParse.setFontWeight("bold");textBlock.font=fontParse.toString()}break;case"italic":fontParse=new FontParser;for(i=0;i<textArray.length;i++)if(null!=(textBlock=textArray[i])){fontParse.fromString(textBlock.font);var fontStyle=fontParse.getFontStyle();"italic"===(fontStyle=(fontStyle=fontStyle.trim()).toLowerCase())?fontParse.setFontStyle("normal"):fontParse.setFontStyle("italic");textBlock.font=fontParse.toString()}break;case"underscore":for(i=0;i<textArray.length;i++)null!=(textBlock=textArray[i])&&0!==i&&(textBlock.isUnderline=!textBlock.isUnderline);break;case"strikethrough":for(i=0;i<textArray.length;i++)null!=(textBlock=textArray[i])&&0!==i&&(textBlock.isStrikethrough=!textBlock.isStrikethrough)}}};CompCallOut.prototype.setLinkLineColor=function(node,strColor,diagram){diagram.links.each((function(link){null!=link&&link.category===netBrain.Map.CategoryMgr.CompCallOutLink&&link.from===node.key&&link.data.setLineColor(link,strColor)}))};CompCallOut.prototype.setLinkBackColor=function(node,strColor,diagram){diagram.links.each((function(link){null!=link&&link.category===netBrain.Map.CategoryMgr.CompCallOutLink&&link.from===node.key&&link.data.setBackColor(link,strColor)}))};CompCallOut.prototype.setBackColor=function(node,strColor){if(null!=node){var panelCallout=node.findObject("callOutPanel");null!=panelCallout&&(panelCallout.background=strColor);var panelTitle=node.findObject("noteTitlePanel");null!=panelTitle&&(panelTitle.background=strColor);var panelTime=node.findObject("noteSysTimePanel");null!=panelTime&&(panelTime.background=strColor);var panelContent=node.findObject("noteContentPanel");null!=panelContent&&(panelContent.background=strColor)}};CompCallOut.prototype.setTextAlignment=function(node,strAlignment){if(null!=node){var textArray=[];var textTitle=node.findObject("noteTitlePanelText");textArray.push(textTitle);var textTime=node.findObject("noteSysTimePanelText");textArray.push(textTime);var textContent=node.findObject("noteContentPanelText");textArray.push(textContent);for(var i=0;i<textArray.length;i++){var textBlock=textArray[i];null!=textBlock&&(textBlock.textAlign=strAlignment)}}};CompCallOut.prototype.setTitleContent=function(strTitle){this.titleContent=strTitle};CompCallOut.prototype.setTitleFont=function(cssFont,cssColor){this.titleFont=cssFont;this.titleColor=cssColor};CompCallOut.prototype.setTitleVisible=function(bVisible){this.titleVisible=bVisible};CompCallOut.prototype.setNoteContent=function(strNoteContent){this.noteContent=strNoteContent};CompCallOut.prototype.setNoteContentFont=function(cssFont,cssColor){this.noteContentFont=cssFont;this.noteContentColor=cssColor};CompCallOut.prototype.setNoteContentVisible=function(bVisible){this.noteContentVisible=bVisible};CompCallOut.prototype.setSystimeContent=function(strSysTime){this.sysTimeContent=strSysTime};CompCallOut.prototype.setSystimeContentFont=function(cssFont,cssColor){this.sysTimeFont=cssFont};CompCallOut.prototype.setSystimeContentVisible=function(bVisible){this.sysTimeVisible=bVisible};CompCallOut.prototype.setPosition=function(ptPoint){this.location=ptPoint.x+" "+ptPoint.y};CompCallOut.getDefaultJsonData=function(){return{category:CompCallOut.getVarCategory(),key:NgUtil.getGUID(),location:"100 100",size:"200 100",noteVisible:!0,noteBackColor:NetBrain.Map.Const.noteDefaultBackColor,titleBackColor:NetBrain.Map.Const.noteDefaultBackColor,titleVisible:!0,titleContent:"Title",titleFont:BindHelper.defaultHostNameFont,titleColor:"blue",sysTimeBackColor:NetBrain.Map.Const.noteDefaultBackColor,sysTimeVisible:!0,sysTimeContent:"2/19/2015 17:33",sysTimeFont:BindHelper.defaultPosLableFont,sysTimeColor:"red",noteContentBackColor:NetBrain.Map.Const.noteDefaultBackColor,noteContentVisible:!0,noteContent:"New Note",noteContentColor:"black",noteContentFont:BindHelper.defaultPosLableFont,borderColor:"#000000",borderWidth:1,borderVisible:!0,borderLineStyle:null}};CompCallOut.portShapeA="portShapeA";CompCallOut.portShapeB="portShapeB";CompCallOut.getMapTemplate=function(templateOption,map,scope){function makePort(shapeName,name,spot,output,input,size){return $(go.Shape,"Rectangle",{name:shapeName,fill:null,stroke:null,desiredSize:new go.Size(size.width,size.height),alignment:spot,alignmentFocus:spot,portId:name,fromSpot:spot,toSpot:spot,fromLinkable:output,toLinkable:input,cursor:cursorHelper.pointer})}function showSmallPorts(node,show){node.ports.each((function(port){""!==port.portId&&(port.fill=show?"rgba(0,0,0,0.3)":null)}))}var $=go.GraphObject.make;return $(CompCallOutNode,"Spot",{layerName:GlobalContext.NormalShapObjName,resizable:!0,visible:!0,minSize:new go.Size(200,28),desiredSize:new go.Size(200,100),selectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate(),mouseEnter:function(e,node){showSmallPorts(node,!0)},mouseLeave:function(e,node){showSmallPorts(node,!1)}},new go.Binding("layerName").makeTwoWay(),new go.Binding("location","location",templateOption.locationParse).makeTwoWay(templateOption.locationStringify),new go.Binding("desiredSize","size",go.Size.parse).makeTwoWay(go.Size.stringify),new go.Binding("visible","noteVisible").makeTwoWay(),new go.Binding("key","key").makeTwoWay(),$(go.Panel,"Vertical",{name:"callOutPanel",alignmentFocus:go.Spot.TopLeft,alignment:go.Spot.TopLeft,stretch:go.GraphObject.Fill},new go.Binding("background","noteBackColor").makeTwoWay(),$(go.Panel,"Spot",{name:"noteTitlePanel",stretch:go.GraphObject.Horizontal,visible:!0},new go.Binding("background","titleBackColor").makeTwoWay(),new go.Binding("visible","titleVisible").makeTwoWay(),$(go.TextBlock,{name:"noteTitlePanelText",margin:3,wrap:go.TextBlock.WrapDesiredSize,editable:!0},new go.Binding("desiredSize","desiredSize").ofObject("noteTitlePanel"),new go.Binding("text","titleContent").makeTwoWay(),new go.Binding("font","titleFont").makeTwoWay(),new go.Binding("stroke","titleColor").makeTwoWay(),new go.Binding("textAlign").makeTwoWay())),$(go.Panel,"Spot",{name:"noteSysTimePanel",stretch:go.GraphObject.Horizontal,visible:!0},new go.Binding("background","sysTimeBackColor").makeTwoWay(),new go.Binding("visible","sysTimeVisible").makeTwoWay(),$(go.TextBlock,{name:"noteSysTimePanelText",margin:3,wrap:go.TextBlock.WrapDesiredSize,editable:!0,font:BindHelper.defaultPosLableFont},new go.Binding("desiredSize","desiredSize").ofObject("noteSysTimePanel"),new go.Binding("text","sysTimeContent").makeTwoWay(),new go.Binding("font","sysTimeFont").makeTwoWay(),new go.Binding("stroke","sysTimeColor").makeTwoWay(),new go.Binding("textAlign").makeTwoWay())),$(go.Panel,"Spot",{name:"noteContentPanel",visible:!1,stretch:go.GraphObject.Horizontal},new go.Binding("background","noteContentBackColor").makeTwoWay(),new go.Binding("visible","noteContentVisible").makeTwoWay(),$(go.TextBlock,{name:"noteContentPanelText",margin:3,wrap:go.TextBlock.WrapDesiredSize,editable:!0},new go.Binding("desiredSize","desiredSize").ofObject("noteContentPanel"),new go.Binding("text","noteContent").makeTwoWay(),new go.Binding("font","noteContentFont").makeTwoWay(),new go.Binding("stroke","noteContentColor").makeTwoWay(),new go.Binding("textAlign").makeTwoWay()))),$(go.Shape,"RoundedRectangle",{name:netBrain.Map.DrawShapeCommonAttr.ObjName,alignmentFocus:go.Spot.Center,alignment:go.Spot.Center,isPanelMain:!0,fill:null},new go.Binding("stroke","borderColor").makeTwoWay(),new go.Binding("strokeWidth","borderWidth").makeTwoWay(),new go.Binding("visible","borderVisible").makeTwoWay(),new go.Binding("strokeDashArray","borderLineStyle").makeTwoWay()),makePort(CompCallOut.portShapeA,"B",go.Spot.Bottom,!0,!1,{width:17,height:10}),makePort(CompCallOut.portShapeB,"",go.Spot.Center,!1,!0,{width:3,height:3}))};CompCallOut.getVarCategory=function(){return netBrain.Map.CategoryMgr.CallOut};function CompCallOutNode(){go.Node.apply(this,arguments)}go.Diagram.inherit(CompCallOutNode,go.Node);CompCallOutNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var noteTitlePanel=this.findObject("noteTitlePanel");if(noteTitlePanel.visible){var noteTitleInfo=visioTools.getTextVisioInfo(this,"noteTitlePanelText");noteTitleInfo.background=noteTitlePanel.background;visioInfos.push(noteTitleInfo)}var noteSysTimePanel=this.findObject("noteSysTimePanel");if(noteSysTimePanel.visible){var noteSysTimeInfo=visioTools.getTextVisioInfo(this,"noteSysTimePanelText");noteSysTimeInfo.background=noteSysTimePanel.background;visioInfos.push(noteSysTimeInfo)}var noteContentPanel=this.findObject("noteContentPanel");if(noteContentPanel.visible){var noteContentInfo=visioTools.getTextVisioInfo(this,"noteContentPanelText");noteContentInfo.background=noteContentPanel.background;visioInfos.push(noteContentInfo)}var shapeInfo=visioTools.getShapeVisioInfo(this,netBrain.Map.DrawShapeCommonAttr.ObjName);visioInfos.push(shapeInfo);var portShapeAInfo=visioTools.getShapeVisioInfo(this,CompCallOut.portShapeA);visioInfos.push(portShapeAInfo);var portShapeBInfo=visioTools.getShapeVisioInfo(this,CompCallOut.portShapeB);visioInfos.push(portShapeBInfo);return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};var DrawCallOutTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="CalloutDrawing";this.ShapeType="Rectangle";this.ShapeGeoType=go.Geometry.Rectangle;this.archetypePartData=CompCallOut.getDefaultJsonData();this.Init()};(DrawCallOutTool.prototype=new netBrain.Map.DrawShapeToolBase).finishShape=function(){var diagram=this.diagram;var shape=this.temporaryShape;if(null!==shape&&null!==this.archetypePartData){this.removeLastPoint();var tempgeo=shape.geometry;var viewpt=diagram.viewportBounds.position;var geo=tempgeo.copy();var pos=geo.normalize();pos.x=viewpt.x-pos.x+this.diagram.padding.left;pos.y=viewpt.y-pos.y+this.diagram.padding.top;var nodeData=diagram.model.copyNodeData(this.archetypePartData);var tmpPt=netBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(new go.Point(pos.x,pos.y),diagram);nodeData.location=tmpPt.x+" "+tmpPt.y;geo.normalize();nodeData.geo=go.Geometry.stringify(geo);nodeData.size=geo.bounds.width+" "+geo.bounds.height;netBrain.Map.CompPrototypeFactory.buildCompPrototype(nodeData);diagram.model.addNodeData(nodeData);if(geo.type===go.Geometry.Line){var node=diagram.findNodeForData(nodeData);if(null!=node){var lineShape=node.findObject("shapeObj");if(null!=lineShape&&null!=lineShape.geometry){var pathFigures=lineShape.geometry.figures;for(var i=0;i<pathFigures.size;i++){var onePathFigure=pathFigures.get(i);if(null!=onePathFigure){onePathFigure.copy().isFilled=!1}}}}}this.transactionResult=this.name}this.stopTool();this.isAutoUnRegister&&this.UnRegister()};netBrain.Map=netBrain.Map||{};netBrain.Map.CompCallOutTempplateOpt=function(){this.locationParse=function(){};this.locationStringify=function(){}};netBrain.Map.CompCallOut=CompCallOut;netBrain.Map.DrawCallOutTool=DrawCallOutTool}(NetBrain);!function(netBrain){var FreehandDrawingTool=function(){netBrain.Map.DrawShapeToolBase.call(this);this.name="FreehandDrawing";this._archetypePartData={};this._temporaryShape=go.GraphObject.make(go.Shape,{name:"SHAPE",fill:null,strokeWidth:1.5});go.GraphObject.make(go.Part,{layerName:"Tool"},this._temporaryShape)};(FreehandDrawingTool.prototype=new netBrain.Map.DrawShapeToolBase).canStart=function(){if(!this.isEnabled)return!1;var diagram=this.diagram;if(null===diagram||diagram.isReadOnly||diagram.isModelReadOnly)return!1;if(null===diagram.model)return!1;if(!diagram.firstInput.left)return!1;var obj=diagram.findObjectAt(diagram.firstInput.documentPoint,null,null);return!(null==obj||!this.isLinkableObj(obj.part.category))||null===obj};FreehandDrawingTool.prototype.doActivate=function(){netBrain.Map.DrawShapeToolBase.prototype.doActivate.call(this);this.diagram.isMouseCaptured=!0;this.diagram.currentCursor="crosshair";this.isActive=!0};FreehandDrawingTool.prototype.doDeactivate=function(){netBrain.Map.DrawShapeToolBase.prototype.doDeactivate.call(this);null!==this.temporaryShape&&this.diagram.remove(this.temporaryShape.part);this.diagram.currentCursor="";this.diagram.isMouseCaptured=!1};FreehandDrawingTool.prototype.addPoint=function(p){var fig,geo;var shape=this.temporaryShape;if(null!==shape){var viewpt=this.diagram.viewportBounds.position;var q=new go.Point(p.x-viewpt.x,p.y-viewpt.y);var part=shape.part;if(null===part.diagram){fig=new go.PathFigure(q.x,q.y,!0);(geo=new go.Geometry).figures.add(fig);this.temporaryShape.geometry=geo;part.position=viewpt;this.diagram.add(part)}var segs=shape.geometry.figures.first().segments;var idx=segs.count-1;if(idx>=0){var last=segs.elt(idx);if(Math.abs(q.x-last.endX)<.5&&Math.abs(q.y-last.endY)<.5)return}fig=(geo=shape.geometry.copy()).figures.first();var seg=new go.PathSegment(go.PathSegment.Line,q.x,q.y);fig.segments.add(seg);shape.geometry=geo}};FreehandDrawingTool.prototype.doMouseDown=function(){if(!this.isActive){this.doActivate();this.addPoint(this.diagram.lastInput.documentPoint)}};FreehandDrawingTool.prototype.doMouseMove=function(){this.isActive&&this.addPoint(this.diagram.lastInput.documentPoint)};FreehandDrawingTool.prototype.doMouseUp=function(){var started=!1;if(this.isActive){started=!0;var diagram=this.diagram;this.addPoint(diagram.lastInput.documentPoint);var viewpt=diagram.viewportBounds.position;var geo=this.temporaryShape.geometry.copy();var pos=geo.normalize();pos.x=viewpt.x-pos.x;pos.y=viewpt.y-pos.y;diagram.startTransaction(this.name);var d=diagram.model.copyNodeData(this.archetypePartData);diagram.model.addNodeData(d);var part=diagram.findPartForData(d);part.location=new go.Point(pos.x+geo.bounds.width/2,pos.y+geo.bounds.height/2);var shape=part.findObject("SHAPE");null!==shape&&(shape.geometry=geo)}this.stopTool();started&&diagram.commitTransaction(this.name)};Object.defineProperty(FreehandDrawingTool.prototype,"temporaryShape",{get:function(){return this._temporaryShape},set:function(val){if(this._temporaryShape!==val&&null!==val){val.name="SHAPE";var panel=this._temporaryShape.panel;panel.remove(this._temporaryShape);this._temporaryShape=val;panel.add(this._temporaryShape)}}});Object.defineProperty(FreehandDrawingTool.prototype,"archetypePartData",{get:function(){return this._archetypePartData},set:function(val){this._archetypePartData=val}});netBrain.Map=netBrain.Map||{};netBrain.Map.FreehandDrawingTool=FreehandDrawingTool}(NetBrain);!function(netBrain){var DrawSelectPath=function(){netBrain.Map.FreehandDrawingTool.call(this);this.name="Do nothing";this.devJsonArrary=[];this.graphicStyle=null};(DrawSelectPath.prototype=new netBrain.Map.FreehandDrawingTool).doMouseDown=function(){netBrain.Map.FreehandDrawingTool.prototype.doMouseDown.call(this)};DrawSelectPath.prototype.setGraphicStyle=function(graphicStyle){this.graphicStyle=graphicStyle};DrawSelectPath.prototype.getGraphicStyle=function(){return this.graphicStyle};DrawSelectPath.prototype.Register=function(diagram){netBrain.Map.FreehandDrawingTool.prototype.Register.call(this,diagram);GlobalContext.isDrawPathSelect=!0};DrawSelectPath.prototype.UnRegister=function(diagram,bNeedCallback){netBrain.Map.FreehandDrawingTool.prototype.UnRegister.call(this,diagram,bNeedCallback);GlobalContext.isDrawPathSelect=!1};DrawSelectPath.prototype.doMouseUp=function(){this.transactionResult=this.name;this.stopTool();var compPath=netBrain.Map.CompPathNewBase.buildPathFromDevices(this.devJsonArrary);if(null!=compPath){netBrain.Map.CompPrototypeFactory.buildCompPrototype(compPath);compPath.setType(netBrain.Map.Const.LinkType.Dash);compPath.setColor(function(withoutColor){var color="RGB(255, 255, 128)";do{var colorLength=Object.getOwnPropertyNames(netBrain.Map.Const.ColorLibrary).length;var index=(range=void 0,rand=void 0,range=colorLength-1-(min=1),rand=Math.random(),min+Math.round(rand*range));var i=0;for(var colorName in netBrain.Map.Const.ColorLibrary){if(i===index){color=netBrain.Map.Const.ColorLibrary[colorName];break}i++}}while(withoutColor===color);var min,range,rand;return color}());this.diagram.startTransaction("Add Path");this.diagram.model.addLinkData(compPath);this.diagram.commitTransaction("Add Path")}delete this.devJsonArrary;this.devJsonArrary=[];this.isAutoUnRegister&&this.UnRegister()};DrawSelectPath.prototype.doMouseMove=function(){if(this.isActive){this.addPoint(this.diagram.lastInput.documentPoint);var part=this.diagram.findPartAt(this.diagram.lastInput.documentPoint);if(null!=part&&this.isLinkableObj(part.category)){var key=part.data.key;if(0!==this.devJsonArrary.length&&this.devJsonArrary[this.devJsonArrary.length-1].key===key)return;this.devJsonArrary.push(part.data)}}};DrawSelectPath.prototype.isLinkableObj=function(category){return null!=category&&(category===netBrain.Map.CategoryMgr.NetworkDevice||category===netBrain.Map.CategoryMgr.Stencil||category===netBrain.Map.CategoryMgr.StencilExt||category===netBrain.Map.CategoryMgr.L2Device||category===netBrain.Map.CategoryMgr.Media||category===netBrain.Map.CategoryMgr.CallOut)};netBrain.Map=netBrain.Map||{};netBrain.Map.DrawSelectPath=DrawSelectPath}(NetBrain);!function(netBrain){function createPathPointIcon(option){var $=go.GraphObject.make;return $(go.Panel,go.Panel.Auto,{alignment:go.Spot.TopCenter,alignmentFocus:go.Spot.BottomCenter},$(go.Shape,{fill:option.backgroundColor,figure:"Circle",desiredSize:new go.Size(16,16),stroke:null}),$(go.Shape,{fill:"#ffffff",desiredSize:option.size,stroke:null,geometry:option.iconSvg}))}var DiagramPathManager=function(netMapOperator){this._hasPathTip=!1;this._curMainPath=null;var $=go.GraphObject.make;var compLabel=netBrain.Map.CCompLabel;this._PathAAdornmentTemplate=$(go.Adornment,"Spot",$(go.Placeholder),createPathPointIcon({backgroundColor:"#fab34f",iconSvg:compLabel.getPathPointIcon(compLabel.PATH_ICON_A),size:new go.Size(8,8)}));this._PathRAdornmentTemplate=$(go.Adornment,"Spot",$(go.Placeholder),createPathPointIcon({backgroundColor:"#fab34f",iconSvg:compLabel.getPathPointIcon(compLabel.PATH_ICON_R),size:new go.Size(8,8)}));this._PathBAdornmentTemplate=$(go.Adornment,"Spot",$(go.Placeholder),createPathPointIcon({backgroundColor:"#77c211",iconSvg:compLabel.getPathPointIcon(compLabel.PATH_ICON_B),size:new go.Size(7,8)}));this._PathSAdornmentTemplate=$(go.Adornment,"Spot",$(go.Placeholder),createPathPointIcon({backgroundColor:"#77c211",iconSvg:compLabel.getPathPointIcon(compLabel.PATH_ICON_S),size:new go.Size(7,8)}));this.pathTip=null;this.netMapOperator=netMapOperator;this.NODE_TYPE={FROMNODE:"FROM",TONODE:"TO"};this.CAST_TYPE={UNICAST:"UNICAST",MULTICAST:"MULTICAST"}};DiagramPathManager.prototype.setPathTip=function(pathTip){this.pathTip=pathTip};DiagramPathManager.prototype.getPathTip=function(){return this.pathTip};DiagramPathManager.prototype.onViewportBoundsChanged=function(e){if(null!=e){var diagram=e.diagram;this.closePathTip(diagram)}};DiagramPathManager.prototype.onDeletePathObj=function(diagram,pathObj){if(null!=this._curMainPath&&this._curMainPath===pathObj){this.closePathTip(diagram);null!=this._curMainPath.fromNode&&this._curMainPath.fromNode.removeAdornment("pathAAdornment");null!=this._curMainPath.toNode&&this._curMainPath.toNode.removeAdornment("pathBAdornment");this._curMainPath=null}};DiagramPathManager.prototype.getFromNodeAndToNodeFromPath=function(diagram,path){var retData={fromNode:null,toNode:null};if(!path||!diagram)return retData;if(path.fromNode)retData.fromNode=path.fromNode;else{var fromDevId=NgUtil.getValueFromObjAndPath(path.data,"hoplist.0.hops.0.fromDev.devId");fromDevId&&(retData.fromNode=diagram.findNodeForKey(fromDevId))}if(path.data&&!path.data.isFailedPath){var nodes=NgUtil.getValueFromObjAndPath(path.data,"hoplist.0._tmpDrawNodes");if(nodes&&nodes.length>0){var lastNode=nodes[nodes.length-1];retData.toNode=diagram.findNodeForKey(lastNode.node.data.key)}}else retData.toNode=path.toNode;return retData};DiagramPathManager.prototype.showPathAB=function(diagram,path){var findData;if(this._curMainPath){if(null!=(findData=this.getFromNodeAndToNodeFromPath(diagram,this._curMainPath)).fromNode){findData.fromNode.removeAdornment("pathAAdornment");findData.fromNode.removeAdornment("pathBAdornment")}if(null!=findData.toNode){findData.toNode.removeAdornment("pathBAdornment");findData.toNode.removeAdornment("pathAAdornment")}}findData=this.getFromNodeAndToNodeFromPath(diagram,path);var template,category;if(path&&path.data){var buildAdornmentIconTemplateFromNodeType=function(isA2B,castType){var dpm=new DiagramPathManager;var template=void 0;var isUnicast=castType===dpm.CAST_TYPE.UNICAST;var isMulticast=castType===dpm.CAST_TYPE.MULTICAST;return function(nodeType){var isDest=nodeType===dpm.NODE_TYPE.TONODE&&isA2B||nodeType===dpm.NODE_TYPE.FROMNODE&&!isA2B;var isSrc=nodeType===dpm.NODE_TYPE.FROMNODE&&isA2B||nodeType===dpm.NODE_TYPE.TONODE&&!isA2B;isUnicast&&isDest?template=dpm._PathBAdornmentTemplate:isUnicast&&isSrc?template=dpm._PathAAdornmentTemplate:isMulticast&&isDest?template=dpm._PathSAdornmentTemplate:isMulticast&&isSrc&&(template=dpm._PathRAdornmentTemplate);if(void 0===template)throw Error("Failed to build adornment template!");return template}}(function(path){return!1!==path.data.isA2B}(path),this.getCastType(path));if(null!=findData.toNode){template=buildAdornmentIconTemplateFromNodeType(this.NODE_TYPE.TONODE);category="pathAAdornment";addIconAdornment(findData.toNode,template.copy(),category)}if(null!=findData.fromNode){template=buildAdornmentIconTemplateFromNodeType(this.NODE_TYPE.FROMNODE);category="pathBAdornment";addIconAdornment(findData.fromNode,template.copy(),category)}}this._curMainPath=path};DiagramPathManager.prototype.getCastType=function(path){var routingScheme=path.data.routingScheme;return 0===routingScheme||void 0===routingScheme?this.CAST_TYPE.UNICAST:1===routingScheme?this.CAST_TYPE.MULTICAST:void 0};function addIconAdornment(node,template,category){var a=template.copy();a.category=category;a.adornedObject=node;node.addAdornment(category,a)}DiagramPathManager.prototype.refreshPathAB=function(diagram){var currPath=this._curMainPath;if(currPath){var newPath=diagram.findLinkForData(currPath.data);newPath&&this.showPathAB(diagram,newPath)}};DiagramPathManager.prototype.closePathTip=function(diagram){this._hasPathTip&&null!=this.pathTip&&this.pathTip.hideTip()};DiagramPathManager.prototype.onBackgroundSingleClicked=function(e){var diagram=e.diagram;if(diagram){this.closePathTip(diagram);var currPath=this._curMainPath;if(currPath){var pathData=currPath.data;if(netBrain.Map.CategoryMgr.isPath(pathData.category)){var documentPoint=NgUtil.getValueFromObjAndPath(diagram,"lastInput.documentPoint");if(documentPoint){var obj=diagram.findObjectAt(documentPoint);if(obj){var adornment=obj.part;var category=adornment.category;var device=adornment.adornedObject;if(device){var ptInput=device.getDocumentPoint(go.Spot.TopCenter);var ptInputView=diagram.transformDocToView(ptInput);var ptPosTip={x:ptInputView.x-40,y:ptInputView.y-94-25};var subHops=pathData.getSubHops(0);if(subHops){var hops=subHops.hops;if(hops&&0!==hops.length){var selectHopInfo={selectHops:subHops};if("pathAAdornment"===category){selectHopInfo.selectHopId=hops[0].hopId;selectHopInfo.isFrom=!0;this.pathTip.showTip(ptPosTip,pathData,selectHopInfo)}else if("pathBAdornment"===category){selectHopInfo.selectHopId=hops[hops.length-(hops.length>1?2:1)].hopId;1===hops.length?selectHopInfo.isFrom=!0:selectHopInfo.isFrom=!1;this.pathTip.showTip(ptPosTip,pathData,selectHopInfo)}}}}}}}}}};DiagramPathManager.prototype.onChangedSelection=function(e){var diagram=e.diagram;this.closePathTip(diagram)};DiagramPathManager.prototype.openPathTip=function(diagram,path,device,pathdata,selectHopInfo){if(device){this._hasPathTip=!0;var ptInput=device.getDocumentPoint(go.Spot.TopCenter);var ptInputView=diagram.transformDocToView(ptInput);var ptPosTip={x:ptInputView.x-40,y:ptInputView.y-94-25};this.pathTip.showTip(ptPosTip,pathdata,selectHopInfo)}};DiagramPathManager.prototype.onDiagramChanged=function(e){var node;e.change===go.ChangedEvent.Property&&"location"===e.propertyName&&e.object instanceof go.Node?(node=e.object)._nbPaths&&node._nbPaths.each((function(l){l.diagram&&l.invalidateRoute()})):e.change===go.ChangedEvent.Property&&"position"===e.propertyName&&e.object instanceof netBrain.Map.CompL2Port?null!=(node=e.object.part)&&node._nbPaths&&node._nbPaths.each((function(l){l.diagram&&l.invalidateRoute()})):e.change===go.ChangedEvent.Remove&&e.object instanceof go.Layer?e.oldValue instanceof go.Node?(node=e.oldValue)._nbPaths&&node._nbPaths.each((function(l){l.invalidateRoute()})):(e.oldValue,netBrain.Map.BasePathLink):e.change===go.ChangedEvent.Insert&&(e.object,go.Layer)};DiagramPathManager.prototype.getTipContent=function(pathData){return pathData.getSource()+" => "+pathData.getDest()};DiagramPathManager.prototype.onPathClicked=function(path,selectHopInfo){if(path&&(path instanceof netBrain.Map.PathLink||path instanceof netBrain.Map.BasePathLink)&&path.isSelected){var diagram=path.diagram;var curPoint=diagram.lastInput.documentPoint;this.closePathTip(diagram);var device=null;var thickness=3;var tmpPath=path.findObject("PATH");if(tmpPath){var subPathShape=tmpPath.findObject("PATH-subPathShape");subPathShape&&subPathShape.strokeWidth&&(thickness=subPathShape.strokeWidth)}var pathData=path.data;var pathCount=pathData.getSubPathCount();var isL2Style=this.netMapOperator.getNetMap().isL2MapStyle();for(var index=0;index<pathCount;index++){var subHops=pathData.getSubHops(index);var subPoints=subHops._tmpDrawPoints;var subNodes=subHops._tmpDrawNodes;if(null!=subPoints&&null!=subNodes){var subDeviceIndex=this._findDeviceIndex(subPoints,curPoint,thickness);if(subDeviceIndex>=0){isL2Style&&(subDeviceIndex=this.getCurrDeviceIndexWithL2Style(subNodes,subDeviceIndex));var deviceInfo=this._getDevice(diagram,subNodes,subDeviceIndex);selectHopInfo.selectHops=subHops;selectHopInfo.selectHopId=deviceInfo.hopId;selectHopInfo.isFrom=deviceInfo.isFrom;if(device=deviceInfo.device)break}}}netBrain.Map.CategoryMgr.isPath(pathData.category)&&this.openPathTip(diagram,path,device,pathData,selectHopInfo);this.showPathAB(diagram,path)}};DiagramPathManager.redrawPath=function(diagram){null!=diagram&&diagram.links.each((function(l){null!=l.data&&netBrain.Map.CategoryMgr.isPathLink(l.data.getCategory())&&l.makeSubPaths(l)}))};DiagramPathManager.prototype._getDevice=function(diagram,subNodes,subDeviceIndex){var deviceInfo={};var nodeInfo=subNodes[subDeviceIndex+1];if(null==nodeInfo||null==nodeInfo.node)return null;deviceInfo.hopId=nodeInfo.hopId;deviceInfo.hopIndex=nodeInfo.hopIndex;deviceInfo.isFrom=!1;var nodeData=nodeInfo.perNode.data;if(!netBrain.Map.gMediaTypeMgr.isMediaType(nodeData.getDevType())){nodeInfo=subNodes[subDeviceIndex];deviceInfo.isFrom=!0}var node=nodeInfo.node;var port=nodeInfo.port;var dev=go.Node.prototype.findPort.call(node,port);deviceInfo.device=dev||node;return deviceInfo};DiagramPathManager.prototype._findDeviceIndex=function(points,curPoint,thickness){var flag=0;for(var i=0,len=points.length;i<len&&i+3<len;i+=3){var s=points[i];var c1=points[i+1];var c2=points[i+2];var e=points[i+3];if(NgUtil.bezierContainsPoint(s.x,s.y,c1.x,c1.y,c2.x,c2.y,e.x,e.y,.5,curPoint.x,curPoint.y,thickness||3))return flag;flag++}return-1};DiagramPathManager.prototype.getCurrDeviceIndexWithL2Style=function(subNodes,subDeviceIndex){var sum=0;var currIndex=subDeviceIndex;for(var i=0,len=subNodes.length;i<len;i++){var subNode=subNodes[i];netBrain.Map.CategoryMgr.isNetworkDevice(subNode.node.category)?sum+=0===i?0:2:sum+=1;if(sum>=subDeviceIndex){currIndex=i;break}}return currIndex};DiagramPathManager.prototype.onPathContextClicked=function(path,selectHopInfo){if(path&&path.isSelected&&NetBrain.Map.CategoryMgr.isPath(path.category)){var diagram=path.diagram;var curPoint=diagram.lastInput.documentPoint;var thickness=3;var tmpPath=path.findObject("PATH");if(tmpPath){var subPathShape=tmpPath.findObject("PATH-subPathShape");subPathShape&&subPathShape.strokeWidth&&(thickness=subPathShape.strokeWidth)}var pathData=path.data;var pathCount=pathData.getSubPathCount();var isL2Style=this.netMapOperator.getNetMap().isL2MapStyle();var flag=!1;for(var index=0;index<pathCount;index++){var subHops=pathData.getSubHops(index);var subPoints=subHops._tmpDrawPoints;var subNodes=subHops._tmpDrawNodes;if(null!=subPoints&&null!=subNodes){var subDeviceIndex=this._findDeviceIndex(subPoints,curPoint,thickness);if(subDeviceIndex>=0){isL2Style&&(subDeviceIndex=this.getCurrDeviceIndexWithL2Style(subNodes,subDeviceIndex));var deviceInfo=this._getDevice(diagram,subNodes,subDeviceIndex);selectHopInfo.selectHops=subHops;selectHopInfo.selectHopId=deviceInfo.hopId;selectHopInfo.isFrom=deviceInfo.isFrom;if(deviceInfo.device){flag=!0;break}}}}flag&&(path.lastContextClickedInfo=selectHopInfo)}};netBrain.Map=netBrain.Map||{};netBrain.Map.DiagramPathManager=DiagramPathManager}(NetBrain);function CompMultiPath(){var compMultiPathJson={key:this.generateMultiPathKey(),mainPathKey:"",subPathKey:[],fromNodeKey:null,toNodeKey:null};this.multiPathData=compMultiPathJson}CompMultiPath.prototype={construct:CompMultiPath};CompMultiPath.prototype.toJson=function(){return this.multiPathData};CompMultiPath.prototype.fromJson=function(jsonData){this.multiPathData=jsonData};CompMultiPath.prototype.generateMultiPathKey=function(){return Guid()};CompMultiPath.prototype.setFromNode=function(nodeKey){this.multiPathData.fromNodeKey=nodeKey};CompMultiPath.prototype.setToNode=function(nodeKey){this.multiPathData.toNodeKey=nodeKey};CompMultiPath.prototype.getFromNode=function(){return this.multiPathData.fromNodeKey};CompMultiPath.prototype.getToNode=function(){return this.multiPathData.toNodeKey};CompMultiPath.prototype.getKey=function(){return this.multiPathData.key};CompMultiPath.prototype.setKey=function(key){this.multiPathData.key=key};CompMultiPath.prototype.addMainPathKey=function(mainPathKey){null!=mainPathKey&&(this.multiPathData.mainPathKey=mainPathKey)};CompMultiPath.prototype.getMainPathKey=function(){return this.multiPathData.mainPathKey};CompMultiPath.prototype.getAllSubPathKey=function(){return this.multiPathData.subPathKey};CompMultiPath.prototype.addSubPathKey=function(pathKey){null!=pathKey&&this.multiPathData.subPathKey.push(pathKey)};CompMultiPath.prototype.updateAllPathCurveRation=function(diagram){if(null!=diagram){var countTime;var link;var tmpArray=[];tmpArray=this.getAllSubPathKey();var mapAllSbuPathLink={};for(var it=diagram.links;it.next();)if(null!=(link=it.value)&&!(tmpArray.indexOf(link.key)<0)){null==mapAllSbuPathLink[link.data.from+link.data.to]&&(mapAllSbuPathLink[link.data.from+link.data.to]=[]);mapAllSbuPathLink[link.data.from+link.data.to].push(link)}_.each(mapAllSbuPathLink,(function(subLinkArray){countTime=2;for(var i=0;i<subLinkArray.length;i++)if(null!=(link=subLinkArray[i])){link.data.customizedCurveRatio=10-countTime;countTime+=2;diagram.model.updateTargetBindings(link.data)}}))}};function DeviceGraphicInfoWrapper(){this.data=DeviceGraphicInfoWrapper.getDefaultDevGraphicInfo()}DeviceGraphicInfoWrapper.prototype.constructor=DeviceGraphicInfoWrapper;DeviceGraphicInfoWrapper.prototype.fromJson=function(jsonData){this.data=jsonData};DeviceGraphicInfoWrapper.prototype.setImageName=function(strImageName){if(null==this.data.imageList||this.data.imageList.length<=0){this.data.imageList=[];this.data.imageList.push(DeviceGraphicInfoWrapper.getDefaultImageInfo())}this.data.imageList[0].name=strImageName};DeviceGraphicInfoWrapper.prototype.setImageList=function(imageList){this.data.imageList=imageList};DeviceGraphicInfoWrapper.prototype.setImageNameByStatus=function(status,strImageName){if(null!=status&&null!=strImageName)for(var i=0;i<this.data.imageList.length;i++){var imgInfo=this.data.imageList[i];null!=imgInfo&&(imgInfo.status===status&&(imgInfo.name=strImageName))}};DeviceGraphicInfoWrapper.prototype.toJson=function(){return this.data};DeviceGraphicInfoWrapper.getDefaultImageInfo=function(){return{name:"00000000-0000-0000-0000-000000000058.png",size:"208 171",scale:NetBrain.Map.Const.iconOnMapScale,status:1}};DeviceGraphicInfoWrapper.getDefaultDevGraphicInfo=function(){return{loc:"0 0",imageList:[DeviceGraphicInfoWrapper.getDefaultImageInfo()],font:{faceName:BindHelper.defaultHostNameFont,fontSize:"9"}}};function DeviceLabelInfoWrapper(){this.data=DeviceLabelInfoWrapper.getDefaultViewInfo()}DeviceLabelInfoWrapper.prototype.constructor=DeviceLabelInfoWrapper;DeviceLabelInfoWrapper.prototype.fromJson=function(jsonData){this.data=jsonData};DeviceLabelInfoWrapper.prototype.toJson=function(){return this.data};DeviceLabelInfoWrapper.prototype.getLabelInfoByIndex=function(nIndex){return null==this.data||null==nIndex||nIndex<0||nIndex>=this.data.length?null:this.data[nIndex]};DeviceLabelInfoWrapper.prototype.setLabelInfoByIndex=function(nIndex,labelInfoJson){if(null==labelInfoJson||null==this.data||null==nIndex||nIndex<0||nIndex>=this.data.length)return null;this.data[nIndex]=labelInfoJson};DeviceLabelInfoWrapper.prototype.addLabel=function(strDisplayName,fontColor,backColor){if(null!=strDisplayName){var posName="pos";posName+=this.data.length+1;var labelInfo=DeviceLabelInfoWrapper.getOnePosInfo();labelInfo.posName=posName;labelInfo.posInfo.displayInfo=strDisplayName;null!=fontColor&&(labelInfo.labelGraphicInfo.color=fontColor);null!=backColor&&(labelInfo.labelGraphicInfo.bgcolor=backColor)}};DeviceLabelInfoWrapper.getOnePosInfo=function(){return{dataViewInfo:{dataViewType:DataViewType.dvGraphic},posName:"pos1",posInfo:{displayInfo:"stencilName"},taglist:["<tag1>","<tag2>"],labelGraphicInfo:{scale:.75,color:"black",bgcolor:"white",font:{faceName:BindHelper.defaultPosLableFont,fontSize:9}}}};DeviceLabelInfoWrapper.getDefaultViewInfo=function(){return{devGraphicInfo:DeviceGraphicInfoWrapper.getDefaultDevGraphicInfo(),dataViewInfo:{dataViewType:DataViewType.dvGraphic}}};!function(netBrain){var CompL3Device=function(type){0===arguments.length?go.Node.call(this):go.Node.call(this,type)};go.Diagram.inherit(CompL3Device,go.Node);CompL3Device.prototype.findPort=function(pid){if(""===pid)return go.Node.prototype.findPort.call(this,pid);var panel=this.findPortFromLinkLabel(pid);return null==panel?go.Node.prototype.findPort.call(this,pid):panel};CompL3Device.prototype.findPortFromLinkLabel=function(pid){var link=null;var isFrom,isTo;var it=this.linksConnected;for(;it.next();){var item=it.value;if(""===item.fromPortId&&null!=item.data){isFrom=item.data.from===this.data.key;isTo=item.data.to===this.data.key;if(isFrom&&item.data.fromPort===pid||isTo&&item.data.toPort===pid){link=item;break}}}if(null==link)return null;var panel=isFrom?link.findObject(netBrain.Map.CompTopolink.srcInftNameLabelPanel):isTo?link.findObject(netBrain.Map.CompTopolink.destInftNameLabelPanel):null;return null==panel||panel.opacity<.1||!panel.visible?null:panel};CompL3Device.prototype.getVisioInfo=function(){};var CompDevice=function(){netBrain.Map.CompBase.call(this);this.category=netBrain.Map.CategoryMgr.NetworkDevice};CompDevice.hostNameLable="hostName";CompDevice.devPosInfoLabelPanel="devPosLabelPanel";CompDevice.devPosInfoLabel="devPosLabel";CompDevice.plusRedIcon="plusRedIcon";CompDevice.highlightBgEllipse="highlightObjectBgEllipse";CompDevice.highlightBgItemsPanel="highlightObjectBgItemsPanel";CompDevice.highlightBgItem="highlightObjectBgItem";CompDevice.alarmLabel="alarmLabel";CompDevice.EVENT_NAMES={HOSTNAME_PANEL_CLICK:"COMP_DEVICE_HOSTNAME_PANEL_CLICK",HOSTNAME_PANEL_MOUSE_ENTER:"COMP_DEVICE_HOSTNAME_PANEL_MOUSE_ENTER",HOSTNAME_PANEL_MOUSE_LEAVE:"COMP_DEVICE_HOSTNAME_PANEL_MOUSE_LEAVE",HOSTNAME_LABEL_CLICK:"COMP_DEVICE_HOSTNAME_LABEL_CLICK",PICTURE_CONTEXT_CLICK:"COMP_DEVICE_PICTURE_CONTEXT_CLICK",PICTURE_CLICK:"COMP_DEVICE_PICTURE_CLICK",PICTURE_MOUSE_ENTER:"COMP_DEVICE_PICTURE_MOUSE_ENTER",PICTURE_MOUSE_LEAVE:"COMP_DEVICE_PICTURE_MOUSE_LEAVE",PICTURE_DOUBLE_CLICK:"COMP_DEVICE_PICTURE_DOUBLE_CLICK",PLUS_ICON_CLICK:"COMP_DEVICE_PLUS_ICON_CLICK"};CompDevice.devPosPanelEnter=function(target,isInEdit){!isInEdit||target.part.opacity<1||(target.panel.background="rgba(27, 127, 194, 0.4)")};CompDevice.devPosPanelLeave=function(target,isInEdit){!isInEdit||target.part.opacity<1||(target.panel.background="rgba(27, 127, 194, 0)")};CompDevice.getEditModeToolTip=function(dataviewData){var text="Device Showing:\n\n";if(null==dataviewData)return text;var posList=dataviewData.devPosList;for(var i in posList)"__gohashid"!==i&&(text+=posList[i].posInfo.displayTemplate+"\n");return text};CompDevice.getThePostListPanel=function(map,scope,showPlusFlag){return(0,go.GraphObject.make)(go.Panel,"Vertical",{margin:new go.Margin(0,0,0,0),name:CompDevice.devPosInfoLabelPanel,itemTemplate:netBrain.Map.CCompLabel.getDeviceLabelTemplate(map,scope)},new go.Binding("itemArray","dataViewData",BindHelper.toTarget_device_itemArray))};CompDevice.getEditLabelIcon=function(labelData){return go.Geometry.fillPath(LabelIconSvg.editPencil)};CompDevice.getTheHostNameTextBlock=function(map,scope,showPlusFlag){var $=go.GraphObject.make;return $(go.Panel,"Horizontal",{margin:new go.Margin(0,0,3,0),visible:!0,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.HOSTNAME_PANEL_CLICK,event,target)},mouseEnter:function(event,target){if(null!==target.diagram&&!target.diagram.isReadOnly&&!netBrain.Map.CategoryMgr.isDeviceCategory(target.part.data.category)){if(target.part.data.getDataViewType()!==DataViewType.dvDynamic){target.findObject(CompDevice.hostNameLable).editable=!0;target.findObject("editLabelIcon").opacity=1}scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.HOSTNAME_PANEL_MOUSE_ENTER,event,target)}},mouseLeave:function(event,target){if(null!==target.diagram&&!target.diagram.isReadOnly&&!netBrain.Map.CategoryMgr.isDeviceCategory(target.part.data.category)){target.findObject(CompDevice.hostNameLable).editable=!1;target.findObject("editLabelIcon").opacity=0;scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.HOSTNAME_PANEL_MOUSE_LEAVE,event,target)}}},$(go.TextBlock,{name:CompDevice.hostNameLable,editable:!1,stroke:"black",font:BindHelper.defaultHostNameFont,isMultiline:!1,position:new go.Point(0,0),click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.HOSTNAME_LABEL_CLICK,event,target)}},new go.Binding("text","hostName",BindHelper.toTarget_device_hostnameText),new go.Binding("margin","visible",(function(visible,obj){var margin=BindHelper.toTarget_device_hostnameMargin(visible);obj.part instanceof netBrain.Map.CompL2Device&&(margin.left=10);return margin})).ofObject("highlightObject"),new go.Binding("background","",(function(){return scope.isEditMode()?null:"white"}))),$(go.Panel,"Auto",{name:"editLabelIcon",visible:!0,opacity:0,background:"white"},$(go.Shape,{fill:"#0D2798",margin:new go.Margin(0,0,0,4),strokeWidth:0,geometry:netBrain.Map.CCompLabel.getEditLabelIcon(),height:12,width:12})))};CompDevice.getTheMainPanel=function(map,scope,showPlusFlag){var $=go.GraphObject.make;return $(go.Panel,"Auto",{name:"PICTURE"},$(go.Shape,{isPanelMain:!0,fill:"#ddedf8",stroke:null,strokeWidth:0,opacity:.6},new go.Binding("opacity","isSelected",(function(isSelected){return isSelected?.6:0})).ofObject()),$(go.Panel,{name:"highlightObject"},$(go.Shape,{name:CompDevice.highlightBgEllipse,fill:"transparent",visible:!1,figure:"Ellipse",width:70,height:50,strokeWidth:2},new go.Binding("desiredSize","dataViewData",BindHelper.toTarget_device_highlightSize),new go.Binding("visible","dataViewData",(function(dataViewData){var data=dataViewData&&dataViewData.devHighlightList;return null!=data&&(!!_.some(dataViewData.devHighlightLegend,(function(item){return!item.isHide}))&&data.length>0)}))),$(go.Panel,{name:CompDevice.highlightBgItemsPanel,itemTemplate:$(go.Panel,$(go.Shape,{name:CompDevice.highlightBgItem,margin:1,stroke:null,strokeWidth:0},new go.Binding("fill","",BindHelper.colorToStringForDevice).makeTwoWay((function(fill,data,model){model.setDataProperty(data,"color",BindHelper.colorToInt(fill))})),new go.Binding("geometry","data",(function(v,node){var hightLength=0;null!=node.panel&&null!=node.panel.panel&&null!=node.panel.panel.itemArray&&(hightLength=node.panel.panel.itemArray.length);if(hightLength>0){var delta=360/hightLength;var srcAngle=node.panel.itemIndex*delta;var rx=35;var ry=25;if(node.part&&node.part.data&&node.part.data.dataViewData){var size=BindHelper.toTarget_device_highlightSize(node.part.data.dataViewData);rx=size.width/2;ry=size.height/2}var tempGeometry="F M "+rx+" "+ry+" B "+srcAngle+" "+delta+" "+rx+" "+ry+" "+rx+" "+ry+" z";return go.Geometry.parse(tempGeometry)}})).ofObject()))},new go.Binding("itemArray","dataViewData",(function(dataViewData){var result=[];if(dataViewData&&dataViewData.devHighlightList){var highlightList=dataViewData.devHighlightList;var map={};highlightList.forEach((function(highlight){if(!highlight.isHide&&highlight.legendName&&!map[highlight.legendName]){map[highlight.legendName]=highlight;result.push(highlight)}}))}return result})))),$(go.Panel,"Spot",{name:"picturePanel"},$(go.Picture,{margin:new go.Margin(2,3,2,3),desiredSize:new go.Size(881,635),portId:"",name:"IMAGE",cursor:"point",contextClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.PICTURE_CONTEXT_CLICK,event,target)},click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.PICTURE_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.PICTURE_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.PICTURE_MOUSE_LEAVE,event,target)},doubleClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.PICTURE_DOUBLE_CLICK,event,target)}},new go.Binding("desiredSize","dataViewData",BindHelper.toTarget_device_desiredSizeWithScale),new go.Binding("source","dataViewData",BindHelper.toTarget_device_source)),$(go.Panel,go.Panel.Auto,{name:"plusIcon",visible:!1,alignment:new go.Spot(1,0,-5,5),alignmentFocus:go.Spot.Center,click:function(s,e){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDevice.EVENT_NAMES.PLUS_ICON_CLICK,s,e)}},new go.Binding("visible","devCategory",(function(devCategory){if(scope.isEditMode())return!1;var bVisible=!1;if(null!=showPlusFlag&&!showPlusFlag)return!1;null!=devCategory&&(bVisible=!NetBrain.Map.gMediaTypeMgr.isMediaType(devCategory));return bVisible})),$(go.Shape,{fill:"transparent",desiredSize:new go.Size(16,16),stroke:null}),$(go.Shape,{fill:"#ffffff",figure:"Circle",desiredSize:new go.Size(16,16),stroke:null}),$(go.Shape,{fill:"#CC3333",desiredSize:new go.Size(14,14),stroke:null,name:CompDevice.plusRedIcon,geometry:netBrain.Map.CCompLabel.getRedplusIcon()}))))};CompDevice.getMapTemplate=function(map,scope,showPlusFlag,bChangeToPanel){var $=go.GraphObject.make;var hostNamePanel=CompDevice.getTheHostNameTextBlock(map,scope,showPlusFlag);var postPanel=CompDevice.getThePostListPanel(map,scope,showPlusFlag);hostNamePanel.alignment=go.Spot.Center;postPanel.alignment=go.Spot.Center;postPanel.itemTemplate.alignment=go.Spot.Center;return $(CompL3Device,"Vertical",{locationObjectName:"IMAGE",locationSpot:go.Spot.Center,layerName:GlobalContext.DeviceLayerName,selectionObjectName:"PICTURE",shadowOffset:new go.Point(1,2),shadowBlur:20,shadowColor:"#2999E3",copyable:!1,selectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate()},new go.Binding("layerName").makeTwoWay(),new go.Binding("isShadowed").makeTwoWay(),new go.Binding("selectable","opacity",(function(opacity){return opacity>=1})).ofObject(),new go.Binding("visible").makeTwoWay(),new go.Binding("location","location",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)})).makeTwoWay((function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)})),CompDevice.getTheMainPanel(map,scope,showPlusFlag),hostNamePanel,postPanel)};(CompDevice.prototype=new netBrain.Map.CompBase).setDevPosLabelEditable=function(nodeObj,bEditable){if(null==nodeObj)return!1;var devPosPanel=nodeObj.findObject(CompDevice.devPosInfoLabelPanel);if(null==devPosPanel)return!1;for(var devPosPanelIt=devPosPanel.elements;devPosPanelIt.next();)if((devPosPanel=devPosPanelIt.value)instanceof go.Panel){var textObj=devPosPanel.findObject(CompDevice.devPosInfoLabel);if(null==textObj)continue;textObj.editable=bEditable}return!0};CompDevice.prototype.setHostnameEditalbe=function(nodeObj,bEditable){if(null!=nodeObj){var textObj=nodeObj.findObject(CompDevice.hostNameLable);null!=textObj&&(textObj.editable=bEditable)}};CompDevice.prototype.setEditableMode=function(nodeObj,bEditable){if(nodeObj.category===netBrain.Map.CategoryMgr.NetworkDevice){this.setHostnameEditalbe(nodeObj,bEditable);this.setDevPosLabelEditable(nodeObj,bEditable);return!0}};CompDevice.prototype.isEditableMode=function(nodeObj){};CompDevice.prototype.getVisible=function(){return this.visible};CompDevice.prototype.setVisible=function(obj){this.visible=obj};CompDevice.prototype.getOpacity=function(){return this.opacity};CompDevice.prototype.setOpacity=function(obj){this.opacity=obj};CompDevice.prototype.getShadowed=function(){return this.isShadowed};CompDevice.prototype.setShadowed=function(obj){this.isShadowed=obj};CompDevice.prototype.getHostname=function(){return this.hostName};CompDevice.prototype.setHostname=function(obj){this.hostName=obj};CompDevice.prototype.setTopoType=function(obj){this.topoType=obj};CompDevice.prototype.getKey=function(){return this.key};CompDevice.prototype.setKey=function(obj){this.key=obj};CompDevice.prototype.getDeviceMainIp=function(){var posList=this.getPosList();if(null==posList)return null;for(var index=0;index<posList.length;index++){var posData=posList[index];if(null!=posData){if("mgmtIP"===posData.posInfo.displayTemplate){return posData.posInfo.displayInfo}}}return null};CompDevice.prototype.getDevType=function(){return this.devType};CompDevice.prototype.setDevType=function(obj){this.devType=obj};CompDevice.prototype.getDevCategory=function(){return this.devCategory};CompDevice.prototype.setDevCategory=function(obj){this.devCategory=obj};CompDevice.prototype.getCategory=function(){return this.category};CompDevice.prototype.setCategory=function(obj){this.category=obj};CompDevice.prototype.getDataViewData=function(){return this.dataViewData};CompDevice.prototype.setDataViewData=function(obj){return this.dataViewData=obj};CompDevice.prototype.getDataViewGroupId=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewGroupId")};CompDevice.prototype.setDataViewGroupId=function(dataViewId){this.dataViewData.dataViewInfo.dataViewGroupId=dataViewId};CompDevice.prototype.getDataViewTaskInfoId=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewTaskInfoId")};CompDevice.prototype.setDataViewTaskInfoId=function(dataViewTaskInfoId){this.dataViewData.dataViewInfo.dataViewTaskInfoId=dataViewTaskInfoId};CompDevice.prototype.getDataViewDefinitionId=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewDefinitionId")};CompDevice.prototype.setDataViewDefinitionId=function(dataViewDefinitionId){this.dataViewData.dataViewInfo.dataViewDefinitionId=dataViewDefinitionId};CompDevice.prototype.getDataViewType=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewType")};CompDevice.prototype.setDataViewType=function(dataViewType){this.dataViewData.dataViewInfo.dataViewType=dataViewType};CompDevice.prototype.getDataViewName=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"name")};CompDevice.prototype.setDataViewName=function(dataViewName){this.dataViewData.dataViewInfo.name=dataViewName};CompDevice.prototype.getDataViewInfoProp=function(dataViewId,propName){var result=null;var dataViewInfo=this.getDataViewInfo(dataViewId);dataViewInfo&&(result=dataViewInfo[propName]);if(!result){var dataViewInfos=this.getDataViewInfos();_.isArray(dataViewInfos)&&dataViewInfos.length>0&&(result=dataViewInfos[0][propName])}return result};CompDevice.prototype.getDataViewInfo=function(dataViewId){var result=null;if(this.dataViewData)if(dataViewId&&this.dataViewData.dataViewInfos){result=_.find(this.dataViewData.dataViewInfos,(function(item){return item.dataViewGroupId===dataViewId}))}else this.dataViewData.dataViewInfo?result=this.dataViewData.dataViewInfo:this.dataViewData.dataViewInfos&&this.dataViewData.dataViewInfos.length>0&&(result=this.dataViewData.dataViewInfos[0]);return result};CompDevice.prototype.isDefaultDataView=function(){var flag=!1;var dataViewInfos=this.getDataViewInfos();dataViewInfos?_.isArray(dataViewInfos)&&1===dataViewInfos.length&&dataViewInfos[0].dataViewType===DataViewType.dvDefault?flag=!0:dataViewInfos.dataViewType===DataViewType.dvDefault&&(flag=!0):flag=!0;return flag};CompDevice.prototype.isContainsDataViewId=function(dataViewId){var flag=!1;var dataViewInfos=this.getDataViewInfos();if(dataViewInfos)if(_.isArray(dataViewInfos)){flag=!!_.find(dataViewInfos,{dataViewGroupId:dataViewId})}else flag=dataViewInfos.dataViewGroupId===dataViewId;return flag};CompDevice.prototype.getDataViewInfos=function(){var result=null;this.dataViewData&&(this.dataViewData.dataViewInfos?result=this.dataViewData.dataViewInfos:this.dataViewData.dataViewInfo&&(result=this.dataViewData.dataViewInfo));return result};CompDevice.prototype.setDataViewInfo=function(obj){null==this.dataViewData?this.dataViewData={dataViewInfo:obj}:this.dataViewData.dataViewInfo=obj};CompDevice.prototype.getShowScale=function(){return null==this.dataViewData?null:null==this.dataViewData.devGraphicInfo?null:null==this.dataViewData.devGraphicInfo.imageList||this.dataViewData.devGraphicInfo.imageList.length<=0?null:this.dataViewData.devGraphicInfo.imageList[0].scale};CompDevice.prototype.setShowScale=function(obj){if(null==this.dataViewData)return null;if(null==this.dataViewData.devGraphicInfo)return null;if(null==this.dataViewData.devGraphicInfo.imageList||this.dataViewData.devGraphicInfo.imageList.length<=0)return null;this.dataViewData.devGraphicInfo.imageList[0].scale=obj};CompDevice.prototype.getLocation=function(){return this.location};CompDevice.prototype.setLocation=function(obj){this.location=obj};CompDevice.prototype.getImageName=function(){return null==this.dataViewData?null:null==this.dataViewData.devGraphicInfo?null:null==this.dataViewData.devGraphicInfo.imageList[0]?null:this.dataViewData.devGraphicInfo.imageList[0].name};CompDevice.prototype.changeIcon=function(newIconSrc){if(null==this.dataViewData)return null;if(null==this.dataViewData.devGraphicInfo)return null;if(null==this.dataViewData.devGraphicInfo.imageList[0])return null;this.dataViewData.devGraphicInfo.imageList[0].name=newIconSrc};CompDevice.prototype.getDevGraphicInfo=function(){return NgUtil.getValueFromObjAndPath(this,"dataViewData.devGraphicInfo")};CompDevice.prototype.setDevGraphicInfo=function(newDevGraphicInfo){this.dataViewData.devGraphicInfo=newDevGraphicInfo};CompDevice.prototype.getJsData=function(){return this};CompDevice.prototype.getViewList=function(){return this.viewList};CompDevice.prototype.resetDataViewList=function(dvList){this.viewList=dvList};CompDevice.prototype.getDataViewData=function(){return this.dataViewData};CompDevice.prototype.setDataViewData=function(obj){this.dataViewData=obj};CompDevice.prototype.getDVName=function(){var viewInfo=this.getViewInfo();return null==viewInfo?null:viewInfo.name};CompDevice.prototype.getDVID=function(){var viewInfo=this.getViewInfo();return null==viewInfo?null:viewInfo.ID};CompDevice.prototype.getDVType=function(){var viewInfo=this.getViewInfo();return null==viewInfo?null:viewInfo.viewType};CompDevice.prototype.getPosList=function(){return null==this.dataViewData?null:this.dataViewData.devPosList};CompDevice.prototype.setPosList=function(devPosList){null==this.dataViewData?this.dataViewData={devPosList:devPosList}:this.dataViewData.devPosList=devPosList};CompDevice.prototype.getIntfObjByIntfId=function(intfId){var ret=this.getIntfInfo(intfId);return ret&&ret.intf||null};CompDevice.prototype.getIntfPosListByIntfId=function(intfId){var ret=this.getIntfInfo(intfId);return ret&&ret.intfPosList||null};CompDevice.prototype.getGraphDevNoteList=function(){return this.graphDevNoteList};CompDevice.prototype.addGraphDevNote=function(obj){null==this.graphDevNoteList&&(this.graphDevNoteList=[]);return this.graphDevNoteList.push(obj)};CompDevice.prototype.getBaseDevNoteList=function(){return this.baseDevNoteList};CompDevice.prototype.addBaseDevNote=function(obj){null==this.baseDevNoteList&&(this.baseDevNoteList=[]);return this.baseDevNoteList.push(obj)};CompDevice.getDefaultJsonData=function(){return{category:netBrain.Map.CategoryMgr.NetworkDevice,key:NgUtil.getGUID(),isShadowed:!1,visible:!0,hostName:"stencialName1",intfInfoList:[],highlightDataList:[],dataViewData:DeviceLabelInfoWrapper.getDefaultViewInfo(),status:1}};CompDevice.getL3DeviceFromL2Device=function(compL2Device){if(null==compL2Device)return null;var compL3Dev=NgUtil.cloneJson(compL2Device);compL3Dev.category=netBrain.Map.CategoryMgr.NetworkDevice;return netBrain.Map.CompPrototypeFactory.buildCompPrototype(compL3Dev)?compL3Dev:null};CompDevice.prototype.getIntfInfo=function(intfValue){var intfInfoList=NgUtil.getValueFromObjAndPath(this,"dataViewData.intfInfoList");if(intfInfoList){return _.find(intfInfoList,(function(item){return intfValue===NgUtil.getValueFromObjAndPath(item,"intf.intfKeyObj.value")}))}};CompDevice.prototype.getIntfInfoIndex=function(intfValue){var intfInfoList=NgUtil.getValueFromObjAndPath(this,"dataViewData.intfInfoList");if(intfInfoList){return _.findIndex(intfInfoList,(function(item){return intfValue===NgUtil.getValueFromObjAndPath(item,"intf.intfKeyObj.value")}))}};CompDevice.prototype.getDataUnitList=function(){if(null==this.dataViewData)return null;if(null==this.dataViewData.devPosList)return null;var dataUnitList=[];for(var i=0;i<this.dataViewData.devPosList.length;i++){var pos=this.dataViewData.devPosList[i];var duArr=NgUtil.getValueFromObjAndPath(pos,"posInfo.dataUnitList");_.isArray(duArr)&&dataUnitList.push.apply(dataUnitList,duArr)}return dataUnitList};CompDevice.prototype.init=function(){null==this.dataViewData.intfInfoList&&(this.dataViewData.intfInfoList=[]);null==this.dataViewData.highlightDataList&&(this.dataViewData.highlightDataList=[])};CompDevice.prototype.getIntfInfoList=function(){return this.dataViewData.intfInfoList};CompDevice.prototype.getIntfInfoHighlightList=function(){var intfInfoList=this.getIntfInfoList();return _.compact(_.flatten(_.map(intfInfoList,(function(ii){return ii.intfHighlightList})),!0))};CompDevice.prototype.isLoadedIntfInfo=function(intfId){return!!this.getIntfInfo(intfId)};CompDevice.prototype.getHighlightDataList=function(){return this.dataViewData.devHighlightList};CompL3Device.prototype.getHighlightBgVisioInfo=function(){var infos=[];this.findObject(CompDevice.highlightBgItemsPanel).elements.each((function(tmp){var itemObj=tmp.findObject(CompDevice.highlightBgItem);var itemInfo=netBrain.Map.visioTools.getShapeInfo(itemObj);infos.push(itemInfo)}));return infos};CompL3Device.prototype.getPicVisioInfo=function(){var picObj=this.findObject("IMAGE");return netBrain.Map.visioTools.getPictureInfo(picObj,!0)};CompL3Device.prototype.getAlarmVisioInfo=function(){var infos=[];this.findObject(CompDevice.devPosInfoLabelPanel).elements.each((function(tmp){var itemObj=tmp.findObject(CompDevice.alarmLabel);var itemInfo=netBrain.Map.visioTools.getShapeInfo(itemObj);"undefined"!==itemInfo.type&&infos.push(itemInfo)}));return infos};CompL3Device.prototype.getPlusVisioInfo=function(){if(this.findObject("plusIcon").visible){var plusObj=this.findObject(CompDevice.plusRedIcon);return netBrain.Map.visioTools.getShapeInfo(plusObj)}};CompL3Device.prototype.getHostNameVisioInfo=function(){var hostNameObj=this.findObject(CompDevice.hostNameLable);return netBrain.Map.visioTools.getTextInfo(hostNameObj)};CompL3Device.prototype.getPosListVisioInfos=function(){var infos=[];var CCompLabel=netBrain.Map.CCompLabel;this.findObject(CompDevice.devPosInfoLabelPanel).elements.each((function(pos){var labelInfos=CCompLabel.getDeviceLabelVisioInfos(pos);infos=infos.concat(labelInfos)}));return infos};CompL3Device.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var highlightBgInfos=this.getHighlightBgVisioInfo();visioInfos=visioInfos.concat(highlightBgInfos);var picInfo=this.getPicVisioInfo();visioInfos.push(picInfo);var plusInfo=this.getPlusVisioInfo();plusInfo&&visioInfos.push(plusInfo);var hostNameInfo=this.getHostNameVisioInfo();visioInfos.push(hostNameInfo);var posListInfos=this.getPosListVisioInfos();visioInfos=(visioInfos=visioInfos.concat(posListInfos)).concat(this.getAlarmVisioInfo());return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};netBrain.Map=netBrain.Map||{};netBrain.Map.CompL3Device=CompL3Device;netBrain.Map.CompDevice=CompDevice}(NetBrain);!function(netBrain){var CompL2Device=function(type){0===arguments.length?go.Node.call(this):go.Node.call(this,type)};go.Diagram.inherit(CompL2Device,go.Node);CompL2Device._createPicTemplate=function(map,scope,showPlusFlag){var picPanel=new go.Panel(go.Panel.Vertical);picPanel.name="PIC";picPanel.add(netBrain.Map.CompDevice.getTheMainPanel(map,scope,showPlusFlag));return picPanel};CompL2Device._createPosTemplate=function(map,scope,showPlusFlag){var panel=new go.Panel(go.Panel.Vertical);var posList=netBrain.Map.CompDevice.getThePostListPanel(map,scope,showPlusFlag);var hostName=netBrain.Map.CompDevice.getTheHostNameTextBlock(map,scope,showPlusFlag);hostName.bind(new go.Binding("cursor","category",(function(category){var cursor="";category===netBrain.Map.CompStencil.getVarCategory()&&(cursor="pointer");return cursor})));hostName.alignment=go.Spot.Left;posList.alignment=go.Spot.Left;posList.itemTemplate.alignment=go.Spot.Left;panel.add(hostName);panel.add(posList);panel.bind(new go.Binding("scale","",(function(data,node){return node.diagram.commandHandler.space>1?1/node.diagram.commandHandler.space:1})));return panel};CompL2Device._createPortTemplate=function(map,scope){var portsPanel=new go.Panel(go.Panel.Position);portsPanel.name="PORTS";portsPanel.alignment=go.Spot.TopLeft;portsPanel.alignmentFocus=go.Spot.TopLeft;portsPanel.bind(new go.Binding("itemArray","dataViewData",(function(v){return v&&v.intfInfoList||[]})));portsPanel.itemTemplate=new CompL2Port(go.Panel.Auto,map,scope);portsPanel.bind(new go.Binding("itemArray","dataViewData",(function(v,node){null!=node&&null!=node.part&&null!=node.part.initBounds&&node.part.initBounds();return node.itemArray})));return portsPanel};CompL2Device.getMapTemplateNew=function(map,scope,showPlusFlag){var template=new CompL2Device(go.Panel.Spot);template.selectionObjectName="PICTURE";template.locationObjectName="IMAGE";template.locationSpot=go.Spot.Center;template.layerName=GlobalContext.DeviceLayerName;template.bind(new go.Binding("location","location",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)})).makeTwoWay((function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)})));var devicePanel=new go.Panel(go.Panel.Auto);devicePanel.name="BODY";var shape=new go.Shape("Rectangle");shape.name="DEVICE";shape.fill="transparent";shape.width=150;shape.height=6*CompL2Port.getHeight()+3*CompL2Port.getVSpace();shape.strokeWidth=1;devicePanel.add(shape);var picPosPanel=new go.Panel(go.Panel.Horizontal);picPosPanel.name="CORE";picPosPanel.add(CompL2Device._createPicTemplate(map,scope,showPlusFlag));picPosPanel.add(CompL2Device._createPosTemplate(map,scope,showPlusFlag));devicePanel.add(picPosPanel);template.add(devicePanel);template.add(CompL2Device._createPortTemplate(map,scope));template.bind(new go.Binding("scale","",(function(v,node){var device=node.part.findObject("DEVICE");var scale=Math.max(node.diagram.commandHandler.space,1);device.strokeWidth=1/scale;return scale})));template.selectionAdornmentTemplate=NormalSelectAdormenTemplate.getNodeTemplate();template.linkConnected=CompL2Device.linkConnected;template.selectionChanged=CompL2Device.selectionChanged;return template};CompL2Device.prototype.updatePortData=function(port){var compDevice=this.data;if(null!=compDevice){var obj=compDevice.getIntfInfo(NgUtil.getValueFromObjAndPath(port,"intfInfo.intf.intfKeyObj.value"));obj&&_.extend(obj,port.intfInfo)}};CompL2Device.findIntfData=function(model,link,direction){var links=model.linkDataArray;for(var i=0,len=links.length;i<len;i++){var linkData=links[i];if(direction){if(null!=link.fromNode&&null!=link.fromNode.data&&model.getFromKeyForLinkData(linkData)===link.fromNode.data.getKey()&&model.getFromPortIdForLinkData(linkData)===link.fromPortId)return linkData}else if(null!=link.toNode&&null!=link.toNode.data&&model.getToKeyForLinkData(linkData)===link.toNode.data.getKey()&&model.getToPortIdForLinkData(linkData)===link.toPortId)return linkData}return null};CompL2Device.l3LinkFromPortIdProperty="fromPortIntf";CompL2Device.l3LinkToPortIdProperty="toPortIntf";CompL2Device.l2LinkFromPortIdProperty="fromPort";CompL2Device.l2LinkToPortIdProperty="toPort";CompL2Device.getlinkToPortIdPropertyByFromPort=function(data){return this.linkFromPortIdProperty===CompL2Device.l3LinkFromPortIdProperty?data[CompL2Device.l3LinkToPortIdProperty]||"":this.linkFromPortIdProperty===CompL2Device.l2LinkFromPortIdProperty&&data[CompL2Device.l2LinkToPortIdProperty]||""};CompL2Device.getLinkFromPortIdProperty=function(){return function(data){return(!0===data.isL2LinkStyle?data[CompL2Device.l2LinkFromPortIdProperty]:netBrain.Map.CategoryMgr.isTopolink(data.category)?"":data[CompL2Device.l2LinkFromPortIdProperty])||""}};CompL2Device.getLinkToPortIdProperty=function(){return function(data){return(!0===data.isL2LinkStyle?data[CompL2Device.l2LinkToPortIdProperty]:netBrain.Map.CategoryMgr.isTopolink(data.category)?"":data[CompL2Device.l2LinkToPortIdProperty])||""}};CompL2Device.linkConnected=function(self,link,port){if(null!=self.diagram){self.diagram.startTransaction("linkConnected");var model=self.diagram.model;var compDevice=self.data;var inftId=null;var direction=self===link.fromNode;if(""!==(inftId=direction?link.fromPortId:link.toPortId)&&!compDevice.isLoadedIntfInfo(inftId)){var intfData=null;intfData={intfInfo:{intf:{intfKeyObj:{schema:"intfs._id",value:inftId}}}};var ifList=compDevice.getIntfInfoList();if(null==ifList){ifList=[];model.setDataProperty(compDevice,"intfInfoList",ifList)}if(null!=ifList){var oldIf=_.find(ifList,(function(item){return NgUtil.getValueFromObjAndPath(item,"intf.intfKeyObj.value","a")===NgUtil.getValueFromObjAndPath(intfData,"intfInfo.intf.intfKeyObj.value","b")}));oldIf?_.extend(oldIf,intfData.intfInfo):model.addArrayItem(ifList,NgUtil.cloneJson(intfData.intfInfo))}if((port=direction?link.fromPort:link.toPort)instanceof CompL2Port){var row=0;for(;row<4;){var pos=self.getNextNotUsedPos(row);if(pos){port.setPortPos(pos.row,pos.col);break}++row}if(row>3){port.setPortPos(-1,-1);self.calcBounds()}}}self.diagram.commitTransaction("linkConnected")}};CompL2Device.selectionChanged=function(obj){if(!obj.isSelected){var ports=obj.getPorts(CompL2Device.SelectedPort);for(var i=0;i<ports.length;++i)ports[i].selectPort(!1)}};CompL2Device.AllPort=0;CompL2Device.SelectedPort=1;CompL2Device.UnSelectedPort=2;CompL2Device.VisiblePort=3;CompL2Device.UnVisiblePort=4;CompL2Device.prototype.getPorts=function(state){switch(state){case CompL2Device.AllPort:return this._getPorts((function(port){return!0}));case CompL2Device.SelectedPort:return this._getPorts((function(port){return port.isPortSelected()}));case CompL2Device.UnSelectedPort:return this._getPorts((function(port){return!port.isPortSelected()}));case CompL2Device.VisiblePort:return this._getPorts((function(port){return port.visible}));case CompL2Device.UnVisiblePort:return this._getPorts((function(port){return!port.visible}));default:return this._getPorts((function(port){return!0}))}};CompL2Device.prototype._getPorts=function(pred){var ports=[];var table=this.findObject("PORTS");if(null!=table)for(var it=table.elements;it.next();){var port=it.value;pred(port)&&ports.push(port)}return ports};CompL2Device.prototype.getRowPorts=function(state,row){switch(state){case CompL2Device.AllPort:return this._getPorts((function(port){return port._ifRow===row}));case CompL2Device.SelectedPort:return this._getPorts((function(port){return port.isPortSelected()&&port._ifRow===row}));case CompL2Device.UnSelectedPort:return this._getPorts((function(port){return!port.isPortSelected()&&port._ifRow===row}));case CompL2Device.VisiblePort:return this._getPorts((function(port){return port.visible&&port._ifRow===row}));case CompL2Device.UnVisiblePort:return this._getPorts((function(port){return!port.visible&&port._ifRow===row}));default:return this._getPorts((function(port){return port._ifRow===row}))}};CompL2Device.prototype.getPort=function(row,col){var list=new go.List;var ports=this.getPorts(CompL2Device.VisiblePort);for(var i=0;i<ports.length;++i){var port=ports[i];var pos=port.getPortPos();pos.row===row&&pos.col===col&&list.add(port)}return list};CompL2Device.prototype.getMostFitPortPos=function(port,pt){var rect=this.getPortsRect();var width=CompL2Port.getWidth();var height=CompL2Port.getHeight();var hSpace=CompL2Port.getHSpace();var vSpace=CompL2Port.getVSpace();(pt=port.panel.getLocalPoint(pt)).offset(-width/2,-height/2);var left=Math.abs(pt.x-rect.x);var top=Math.abs(pt.y-rect.y);var right=Math.abs(pt.x-rect.x-rect.width);var bottom=Math.abs(pt.y-rect.y-rect.height);var min=Math.min(left,top,right,bottom);var mod;var pos={};if(min==left){pos.x=rect.x;pos.y=Math.min(rect.y+rect.height-height-vSpace,Math.max(rect.y+vSpace,pt.y));(mod=(pos.y-rect.y-height)%(height+vSpace))<(height+vSpace)/2?pos.y-=mod:pos.y+=height+vSpace-mod;rect.y+rect.height-height-vSpace-pos.y<-1e-6&&(pos.y-=height+vSpace);pos.row=3;pos.col=Math.min(Math.round((pos.y-rect.y-vSpace)/(height+vSpace)),this.getColCount(3)-1)}else if(min==top){pos.x=Math.min(rect.x+rect.width-width-hSpace,Math.max(rect.x+hSpace,pt.x));pos.y=rect.y;(mod=(pos.x-rect.x-width)%(width+hSpace))<(width+hSpace)/2?pos.x-=mod:pos.x+=width+hSpace-mod;rect.x+rect.width-width-hSpace-pos.x<-1e-6&&(pos.x-=width+hSpace);pos.row=0;pos.col=Math.round((pos.x-rect.x-hSpace)/(width+hSpace))}else if(min==right){pos.x=rect.x+rect.width-width;pos.y=Math.min(rect.y+rect.height-height-vSpace,Math.max(rect.y+vSpace,pt.y));(mod=(pos.y-rect.y-height)%(height+vSpace))<(height+vSpace)/2?pos.y-=mod:pos.y+=height+vSpace-mod;rect.y+rect.height-height-vSpace-pos.y<-1e-6&&(pos.y-=height+vSpace);pos.row=2;pos.col=Math.min(Math.round((pos.y-rect.y-vSpace)/(height+vSpace)),this.getColCount(2)-1)}else if(min==bottom){pos.x=Math.min(rect.x+rect.width-width-hSpace,Math.max(rect.x+hSpace,pt.x));pos.y=rect.y+rect.height-height;(mod=(pos.x-rect.x-width)%(width+hSpace))<(width+hSpace)/2?pos.x-=mod:pos.x+=width+hSpace-mod;rect.x+rect.width-width-hSpace-pos.x<-1e-6&&(pos.x-=width+hSpace);pos.row=1;pos.col=Math.round((pos.x-rect.x-hSpace)/(width+hSpace))}return pos};CompL2Device.prototype.getColCount=function(row){var rect=this.getPortsRect();var count=0;if(0===row||1===row){var width=CompL2Port.getWidth();var hSpace=CompL2Port.getHSpace();count=Math.floor((rect.width-hSpace)/(width+hSpace))}else if(2===row||3===row){var height=CompL2Port.getHeight();var vSpace=CompL2Port.getVSpace();var vMargin=CompL2Port.getVSideMargin();count=Math.floor((rect.height-vSpace-2*vMargin)/(height+vSpace))}return count};CompL2Device.prototype.getPortsRect=function(){return this.findObject("DEVICE").naturalBounds.copy()};CompL2Device.prototype.getPortPos=function(row,col){if(null==row||null==col){row=0;col=0}var width=CompL2Port.getWidth();var height=CompL2Port.getHeight();var hSpace=CompL2Port.getHSpace();var vSpace=CompL2Port.getVSpace();var vMargin=CompL2Port.getVSideMargin();var rect=this.getPortsRect();var pos={};pos.row=row;pos.col=col;switch(row){case 0:pos.x=hSpace+col*(width+hSpace);pos.y=rect.y;break;case 1:pos.x=hSpace+col*(width+hSpace);pos.y=rect.y+rect.height-height;break;case 2:pos.x=rect.x+rect.width-width;pos.y=vMargin+vSpace+col*(height+vSpace);break;case 3:pos.x=rect.x;pos.y=vMargin+vSpace+col*(height+vSpace)}return pos};CompL2Device.prototype.getNextNotUsedPos=function(row){var ports=this.getPorts(CompL2Device.VisiblePort);var listUsed=new go.Set;var i;for(i=0;i<ports.length;++i){var pos=ports[i].getPortPos();row===pos.row&&listUsed.add(pos.col)}(listUsed=listUsed.toList()).sort((function(first,second){return first<second?-1:1}));var col=0;for(i=0;i<listUsed.count&&!(col<listUsed.elt(i));++i)col>listUsed.elt(i)?col=listUsed.elt(i):++col;return col<this.getColCount(row)?this.getPortPos(row,col):null};CompL2Device.prototype.calcBounds=function(enlarge){var list=new go.List;list.add(this);this.diagram.computePartsBounds(list);var portWidth=CompL2Port.getWidth();var portHSpace=CompL2Port.getHSpace();var core=this.findObject("CORE");var minWidth=core.naturalBounds.width+portHSpace+portHSpace;minWidth<150&&(minWidth=150);var ports=this.getPorts(CompL2Device.VisiblePort);var width=portHSpace+ports.length/2*(portWidth+portHSpace);width<minWidth&&(width=minWidth);width+=(portWidth+portHSpace-(width-portHSpace)%(portWidth+portHSpace))%(portWidth+portHSpace);var maxCol=0;for(var i=0;i<ports.length;++i){(pos=ports[i].getPortPos()).col>maxCol&&(maxCol=pos.col)}width<(minWidth=portHSpace+(maxCol+1)*(portWidth+portHSpace))&&(width=minWidth);var portHeight=CompL2Port.getHeight();var portVSpace=CompL2Port.getVSpace();var vMargin=CompL2Port.getVSideMargin();var minHeight=core.naturalBounds.height+portVSpace+portVSpace+2*vMargin;minHeight<86&&(minHeight=86);maxCol=0;for(i=0;i<ports.length;++i){var pos;(2===(pos=ports[i].getPortPos()).row||3===pos.row)&&pos.col>maxCol&&(maxCol=pos.col)}var height=portVSpace+(maxCol+1)*(portHeight+portVSpace)+2*vMargin;height<minHeight&&(height=minHeight);var device=this.findObject("DEVICE");if(!(enlarge&&device.width>width)){this.diagram.startTransaction("calcBounds");device.width=width;device.height=height;this.layoutPorts();this.diagram.commitTransaction("calcBounds")}};CompL2Device.prototype.layoutPorts=function(){var ports=this.getPorts(CompL2Device.VisiblePort);var row=0;for(var i=0;i<ports.length;++i){var pos=ports[i].getPortPos();if(pos.row>=0&&pos.col>=0)ports[i].setPortPos(pos.row,pos.col);else{for(;row<4;){if(pos=this.getNextNotUsedPos(row)){ports[i].setPortPos(pos.row,pos.col);break}++row}if(row>3)break}}i>0&&this.linksConnected.each((function(link){link.invalidateLayout()}))};CompL2Device.prototype.initBounds=function(){this.calcBounds()};CompL2Device.prototype.findSelectedPorts=function(){return this.getPorts(CompL2Device.SelectedPort)};CompL2Device.prototype.removeSelectedPorts=function(){var _this=this;var selectedPorts=this.findSelectedPorts();if(!_.isArray(selectedPorts)||selectedPorts.length<1)return 0;this.diagram.startTransaction("remove selected ports");_.each(selectedPorts,(function(port){_this.removeLinksByPort(port);port.selectPort(!1);_this.removePort(port)}));this.diagram.commitTransaction("remove selected ports");return selectedPorts.count};CompL2Device.prototype.removePort=function(port){var intfInfoList=this.data.getIntfInfoList();if(_.isArray(intfInfoList)&&!(intfInfoList.length<1)){var index=this.data.getIntfInfoIndex(port.portId);if(-1!==index){this.diagram.startTransaction("remove port");this.diagram.model.removeArrayItem(intfInfoList,index);this.diagram.commitTransaction("remove port")}}};CompL2Device.prototype.removeLinksByPort=function(port){var portId=port.portId;var diagram=this.diagram;diagram.startTransaction("remove links by port");var removeLinks=[];this.linksConnected.each((function(link){(link.fromPortId&&link.fromPortId===portId||link.toPortId&&link.toPortId===portId)&&removeLinks.push(link)}));removeLinks.forEach((function(link){diagram.remove(link)}));diagram.commitTransaction("remove links by port")};CompL2Device.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var CompL3Device=netBrain.Map.CompL3Device;var rectObj=this.findObject("DEVICE");var rectInfo=visioTools.getShapeInfo(rectObj);visioInfos.push(rectInfo);var highlightBgInfos=CompL3Device.prototype.getHighlightBgVisioInfo.apply(this);visioInfos=visioInfos.concat(highlightBgInfos);var picInfo=CompL3Device.prototype.getPicVisioInfo.apply(this);visioInfos.push(picInfo);var plusInfo=CompL3Device.prototype.getPlusVisioInfo.apply(this);plusInfo&&visioInfos.push(plusInfo);var hostNameInfo=CompL3Device.prototype.getHostNameVisioInfo.apply(this);visioInfos.push(hostNameInfo);var posListInfos=CompL3Device.prototype.getPosListVisioInfos.apply(this);visioInfos=visioInfos.concat(posListInfos);var portsArr=this.getPorts(CompL2Device.VisiblePort);_.each(portsArr,(function(port){var portInfo=port.getVisioInfo();visioInfos.push(portInfo)}));return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};var CompL2Port=function CompL2Port(type,map,scope){0===arguments.length?go.Panel.call(this):go.Panel.call(this,type);if(3===arguments.length){this._isPortSelected=null;this._ifRow=-1;this._ifCol=-1;this._autoLocked=!1;this.name=netBrain.Map.CategoryMgr.L2Port;this.bind(new go.Binding("portId","intf",(function(data){return data.intfKeyObj.value})));this.bind(new go.Binding("_ifRow","ifRow"));this.bind(new go.Binding("_ifCol","ifCol"));this.bind(new go.Binding("_autoLocked","autoLocked",(function(v){!1;return!1})));this.fromEndSegmentLength=20;this.toEndSegmentLength=20;var shape=new go.Shape("Rectangle");shape.name="SHAPE";shape.fill="transparent";shape.stroke="black";shape.fromSpot=go.Spot.Top;shape.toSpot=go.Spot.Top;shape.cursor="pointer";shape.width=CompL2Port.getWidth();shape.height=CompL2Port.getHeight();shape.bind(new go.Binding("stroke","_isPortSelected",(function(sel){return sel?"#1b7cb4":"black"})).ofObject(netBrain.Map.CategoryMgr.L2Port));shape.bind(new go.Binding("fill","intfHighlightList",BindHelper.toTarget_port_highlightColor));this.add(shape);shape.bind(new go.Binding("strokeWidth","",(function(v,node){return 1/Math.max(node.diagram.commandHandler.space,1)})));this.click=function(e,obj){if(!obj.isPortSelected()&&obj.part.isSelected){var ports=obj.part.getPorts(CompL2Device.SelectedPort);for(var i=0;i<ports.length;++i)ports[i].selectPort(!1);obj.selectPort(!0)}};this.mouseEnter=function(event,target){scope.$emit("l2PortMousEnter",event,target)};this.mouseLeave=function(event,target){scope.$emit("l2PortMouseLeave",event,target)};this.mouseHover=CompL2Port.mouseHover}};NgUtil.inherit(CompL2Port,go.Panel);CompL2Port.prototype.copy=function(){var copy=go.Panel.prototype.copy.call(this);copy._isPortSelected=this._isPortSelected;copy._ifRow=this._ifRow;copy._ifCol=this._ifCol;copy._autoLocked=this._autoLocked;return copy};CompL2Port.mouseHover=function(e,obj){};CompL2Port.getWidth=function(zoom){return 11*(zoom||1)};CompL2Port.getHeight=function(zoom){return 8*(zoom||1)};CompL2Port.getHSpace=function(zoom){return CompL2Port.getWidth(zoom)};CompL2Port.getVSpace=function(zoom){return 10*(zoom||1)};CompL2Port.getVSideMargin=function(){return 2};CompL2Port.prototype.getPortPos=function(){var pos={};pos.row=this._ifRow;pos.col=this._ifCol;pos.autoLocked=this._autoLocked;pos.x=this.position.x;pos.y=this.position.y;return pos};CompL2Port.prototype.setPortPos=function(row,col,temp){if(row>=0&&col>=0){var pos=this.part.getPortPos(row,col);this.position=new go.Point(pos.x,pos.y);switch(row){case 0:this.fromSpot=go.Spot.Top;this.toSpot=go.Spot.Top;break;case 1:this.fromSpot=go.Spot.Bottom;this.toSpot=go.Spot.Bottom;break;case 2:this.fromSpot=go.Spot.Right;this.toSpot=go.Spot.Right;break;case 3:this.fromSpot=go.Spot.Left;this.toSpot=go.Spot.Left}}if(!0!==temp){this.diagram.model.setDataProperty(this,"_ifRow",row);this.diagram.model.setDataProperty(this,"_ifCol",col);this.diagram.model.setDataProperty(this.data,"autoLocked",this._autoLocked);this.diagram.model.setDataProperty(this.data,"ifRow",row);this.diagram.model.setDataProperty(this.data,"ifCol",col)}};CompL2Port.prototype.isAutoLocked=function(){return this._autoLocked};CompL2Port.prototype.setAutoLock=function(flag){!1;this._autoLocked=!1};CompL2Port.prototype.isPortSelected=function(){return this._isPortSelected};CompL2Port.prototype.selectPort=function(isSelected){this._isPortSelected=isSelected;var diagram=this.diagram;var oldskips=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;this.updateTargetBindings("_isPortSelected");diagram.skipsUndoManager=oldskips};CompL2Port.prototype.getDevice=function(){return this.part};CompL2Port.prototype.getVisioInfo=function(){var shapeObj=this.findObject("SHAPE");var shapeInfo=netBrain.Map.visioTools.getShapeInfo(shapeObj);shapeInfo.connectId=shapeObj.part.data.key+this.portId;return shapeInfo};netBrain.Map=netBrain.Map||{};netBrain.Map.CompL2Device=CompL2Device;netBrain.Map.CompL2Port=CompL2Port}(NetBrain);!function(netBrain){var CompVirtualNode=function(){netBrain.Map.CompDevice.call(this);this.category=netBrain.Map.CategoryMgr.VirtualNode};CompVirtualNode.prototype=new netBrain.Map.CompDevice;CompVirtualNode.getMapTemplate=function(map,scope,showPlusFlag,bChangeToPanel){return netBrain.Map.CompDevice.getMapTemplate(map,scope,showPlusFlag,bChangeToPanel)};netBrain.Map=netBrain.Map||{};netBrain.Map.CompVirtualNode=CompVirtualNode}(NetBrain);!function(netBrain){var CompGenericVirtualNode=function(){netBrain.Map.CompBase.call(this)};(CompGenericVirtualNode.prototype=new netBrain.Map.CompBase).init=function(){};CompGenericVirtualNode.prototype.getCategory=function(){return this.category};CompGenericVirtualNode.prototype.getLocation=function(){return this.location};CompGenericVirtualNode.prototype.setLocation=function(obj){this.location=obj};CompGenericVirtualNode.prototype.getDevType=function(){return this.devType};CompGenericVirtualNode.prototype.setDevType=function(obj){this.devType=obj};CompGenericVirtualNode.prototype.getKey=function(){return this.key};CompGenericVirtualNode.prototype.setKey=function(obj){this.key=obj};CompGenericVirtualNode.prototype.getHostname=function(){return this.hostName};CompGenericVirtualNode.prototype.setHostname=function(obj){this.hostName=obj};CompGenericVirtualNode.prototype.getHighlightDataList=function(){return this.dataViewData.devHighlightList};CompGenericVirtualNode.prototype.getJsData=function(){return this};netBrain.Map=netBrain.Map||{};netBrain.Map.CompGenericVirtualNode=CompGenericVirtualNode}(NetBrain);!function(netBrain){var CompGenericGroupNode=function(){netBrain.Map.CompBase.call(this)};(CompGenericGroupNode.prototype=new netBrain.Map.CompBase).init=function(){};CompGenericGroupNode.prototype.getCategory=function(){return this.category};CompGenericGroupNode.prototype.getLocation=function(){return this.location};CompGenericGroupNode.prototype.setLocation=function(obj){this.location=obj};CompGenericGroupNode.prototype.getDevType=function(){return this.devType};CompGenericGroupNode.prototype.setDevType=function(obj){this.devType=obj};CompGenericGroupNode.prototype.getKey=function(){return this.key};CompGenericGroupNode.prototype.setKey=function(obj){this.key=obj};CompGenericGroupNode.prototype.getHostname=function(){return this.hostName};CompGenericGroupNode.prototype.setHostname=function(obj){this.hostName=obj};CompGenericGroupNode.prototype.getHighlightDataList=function(){return this.dataViewData.devHighlightList};CompGenericGroupNode.prototype.getJsData=function(){return this};function TreeNetwork(){go.TreeNetwork.call(this)}go.Diagram.inherit(TreeNetwork,go.TreeNetwork);TreeNetwork.prototype.addParts=function(parts,toplevelonly,pred){if(null!==parts){void 0===toplevelonly&&(toplevelonly=!1);void 0===pred&&(pred=null);null===pred&&(pred=function(part){if(part instanceof Node){return!part.isLinkLabel}if(part instanceof Link){var link=part;var from=link.fromNode;if(null===from||from.isLinkLabel)return!1;var to=link.toNode;return null!==to&&!to.isLinkLabel}return!1});var it=parts.iterator;for(;it.next();){if((part=it.value)instanceof go.Node){var node=part;if((!toplevelonly||node.isTopLevel)&&node.canLayout()&&pred(node))if(node instanceof go.Group&&null===node.layout);else{if(null!==this.findVertex(node))continue;if(node.containingGroup!=this.layout.group)continue;var pNetworkNode=this.createVertex();pNetworkNode.node=node;this.addVertex(pNetworkNode);this.layout.roots.add(pNetworkNode)}}}it.reset();for(;it.next();){var part;if((part=it.value)instanceof go.Link){var link=part;if((!toplevelonly||link.isTopLevel)&&link.canLayout()&&pred(link)&&null===this.findEdge(link)){var fromNode=link.fromNode;var toNode=link.toNode;if(null!==fromNode&&null!==toNode&&fromNode!==toNode){for(;fromNode.containingGroup&&this.layout.group!=fromNode.containingGroup;)fromNode=fromNode.containingGroup;for(;toNode.containingGroup&&this.layout.group!=toNode.containingGroup;)toNode=toNode.containingGroup;var fromVertex=this.findGroupVertex(fromNode);var toVertex=this.findGroupVertex(toNode);null!==fromVertex&&null!==toVertex&&this.linkVertexes(fromVertex,toVertex,null)}}}}}};CompGenericGroupNode.TreeLayout=function(){go.TreeLayout.call(this)};go.Diagram.inherit(CompGenericGroupNode.TreeLayout,go.TreeLayout);CompGenericGroupNode.TreeLayout.prototype.createNetwork=function(){return new TreeNetwork};CompGenericGroupNode.TreeLayout.prototype.makeNetwork=function(coll){var net=this.createNetwork();net.layout=this;var pred=function(part){if(part instanceof go.Node){var node=part;return!node.isLinkLabel&&"Comment"!==node.category}if(part instanceof go.Link){var link=part;var from=link.fromNode;if(null===from||from.isLinkLabel||"Comment"===from.category)return!1;var to=link.toNode;return null!==to&&!to.isLinkLabel&&"Comment"!==to.category}return!1};if(coll instanceof go.Diagram){var diagram=coll;net.addParts(diagram.nodes,!0,pred);net.addParts(diagram.links,!0,pred)}else if(coll instanceof go.Group){var group=coll;net.addParts(group.memberParts,!1,pred)}else net.addParts(coll.iterator,!1,pred);return net};netBrain.Map=netBrain.Map||{};netBrain.Map.CompGenericGroupNode=CompGenericGroupNode}(NetBrain);!function(netBrain){var CompDeviceGroup=function(){netBrain.Map.CompBase.call(this);this.category=netBrain.Map.CategoryMgr.NetworkDevice};CompDeviceGroup.hostNameLable="hostName";CompDeviceGroup.EVENT_NAMES={PICTURE_PANEL_DOUBLE_CLICK:"COMP_DEVICE_GROUP_PICTURE_PANEL_DOUBLE_CLICK",PICTURE_CLICK:"COMP_DEVICE_GROUP_PICTURE_CLICK",PICTURE_MOUSE_ENTER:"COMP_DEVICE_GROUP_PICTURE_MOUSE_ENTER",PICTURE_MOUSE_LEAVE:"COMP_DEVICE_GROUP_PICTURE_MOUSE_LEAVE",HOSTNAME_CLICK:"COMP_DEVICE_GROUP_HOSTNAME_CLICK",HOSTNAME_DOUBLE_CLICK:"COMP_DEVICE_GROUP_HOSTNAME_DOUBLE_CLICK"};CompDeviceGroup.getTheHostNameTextBlock=function(map,scope,showPlusFlag){var $=go.GraphObject.make;return $(go.TextBlock,{name:CompDeviceGroup.hostNameLable,alignment:new go.Spot(.5,.6,0,0),alignmentFocus:go.Spot.Center,editable:!1,stroke:"black",font:BindHelper.defaultHostNameFont,cursor:"pointer",margin:new go.Margin(6,0,0,0),maxLines:1,maxSize:new go.Size(1*NetBrain.Map.Const.DefautDeviceGroupSize.split(" ")[0]*NetBrain.Map.Const.iconOnMapScale,NaN),isMultiline:!1,overflow:go.TextBlock.OverflowEllipsis,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceGroup.EVENT_NAMES.HOSTNAME_CLICK,event,target)},doubleClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceGroup.EVENT_NAMES.HOSTNAME_DOUBLE_CLICK,event,target)}},{toolTip:$(go.Adornment,"Auto",$(go.Shape,{fill:"#FFFFCC"}),$(go.TextBlock,{margin:6},new go.Binding("text","hostName")))},new go.Binding("text","hostName",BindHelper.toTarget_device_hostnameText))};CompDeviceGroup.getTheMainPanel=function(map,scope,showPlusFlag){var $=go.GraphObject.make;return $(go.Panel,"Spot",{alignment:new go.Spot(.5,.5,0,0),alignmentFocus:go.Spot.Center},$(go.Panel,"Spot",{name:"picturePanel",doubleClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceGroup.EVENT_NAMES.PICTURE_PANEL_DOUBLE_CLICK,event,target)}},$(go.Picture,{margin:new go.Margin(1,3,1,3),desiredSize:go.Size.parse(NetBrain.Map.Const.DefautDeviceGroupSize),portId:"",name:"IMAGE",cursor:"point",scale:NetBrain.Map.Const.iconOnMapScale,source:NetBrain.NG.Const.iconImagePath+"Cluster.png",click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceGroup.EVENT_NAMES.PICTURE_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceGroup.EVENT_NAMES.PICTURE_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceGroup.EVENT_NAMES.PICTURE_MOUSE_LEAVE,event,target)}})))};function CompDeviceGroupNode(){go.Node.apply(this,arguments)}go.Diagram.inherit(CompDeviceGroupNode,go.Node);CompDeviceGroupNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var picObj=this.findObject("IMAGE");var picInfo=visioTools.getPictureInfo(picObj,!0);visioInfos.push(picInfo);var hostNameInfo=visioTools.getTextVisioInfo(this,CompDeviceGroup.hostNameLable);visioInfos.push(hostNameInfo);return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};CompDeviceGroup.getMapTemplate=function(map,scope,showPlusFlag,bChangeToPanel){return(0,go.GraphObject.make)(CompDeviceGroupNode,"Spot",{layerName:GlobalContext.DeviceLayerName,selectionObjectName:"picturePanel",shadowOffset:new go.Point(1,2),shadowBlur:20,shadowColor:"#2999E3",selectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate()},new go.Binding("layerName").makeTwoWay(),new go.Binding("isShadowed").makeTwoWay(),new go.Binding("opacity"),new go.Binding("selectable","opacity",(function(opacity){return!(opacity<1)})),new go.Binding("visible").makeTwoWay(),new go.Binding("location","location",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)})).makeTwoWay((function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)})),CompDeviceGroup.getTheMainPanel(map,scope,showPlusFlag),CompDeviceGroup.getTheHostNameTextBlock(map,scope,showPlusFlag))};(CompDeviceGroup.prototype=new netBrain.Map.CompBase).setHostnameEditalbe=function(nodeObj,bEditable){if(null!=nodeObj){var textObj=nodeObj.findObject(CompDeviceGroup.hostNameLable);null!=textObj&&(textObj.editable=bEditable)}};CompDeviceGroup.prototype.isEditableMode=function(nodeObj){};CompDeviceGroup.prototype.getVisible=function(){return this.visible};CompDeviceGroup.prototype.setVisible=function(obj){this.visible=obj};CompDeviceGroup.prototype.getOpacity=function(){return this.opacity};CompDeviceGroup.prototype.setOpacity=function(obj){this.opacity=obj};CompDeviceGroup.prototype.getShadowed=function(){return this.isShadowed};CompDeviceGroup.prototype.setShadowed=function(obj){this.isShadowed=obj};CompDeviceGroup.prototype.getHostname=function(){return this.hostName};CompDeviceGroup.prototype.setHostname=function(obj){this.hostName=obj};CompDeviceGroup.prototype.getKey=function(){return this.key};CompDeviceGroup.prototype.setKey=function(obj){this.key=obj};CompDeviceGroup.prototype.getDevType=function(){return this.devType};CompDeviceGroup.prototype.setDevType=function(obj){this.devType=obj};CompDeviceGroup.prototype.getDevCategory=function(){return this.devCategory};CompDeviceGroup.prototype.setDevCategory=function(obj){this.devCategory=obj};CompDeviceGroup.prototype.getCategory=function(){return this.category};CompDeviceGroup.prototype.setCategory=function(obj){varObj.this.category=obj};CompDeviceGroup.prototype.getShowScale=function(){return null==this.devGroupGraphicInfo?null:null==this.devGroupGraphicInfo.imageList||this.devGroupGraphicInfo.imageList.length<=0?null:this.devGroupGraphicInfo.imageList[0].scale};CompDeviceGroup.prototype.setShowScale=function(obj){if(null==this.devGroupGraphicInfo)return null;if(null==this.devGroupGraphicInfo.imageList||this.devGroupGraphicInfo.imageList.length<=0)return null;this.devGroupGraphicInfo.imageList[0].scale=obj};CompDeviceGroup.prototype.getLocation=function(){return this.location};CompDeviceGroup.prototype.setLocation=function(obj){this.location=obj};CompDeviceGroup.prototype.getImageName=function(){return null==this.devGroupGraphicInfo?null:null==this.devGroupGraphicInfo.imageList[0]?null:this.devGroupGraphicInfo.imageList[0].name};CompDeviceGroup.prototype.getJsData=function(){return this};CompDeviceGroup.prototype.getGraphDevGroupNoteList=function(){return this.graphDevGroupNoteList};CompDeviceGroup.prototype.addGraphDevGroupNote=function(obj){null==this.graphDevGroupNoteList&&(this.graphDevGroupNoteList=[]);return this.graphDevGroupNoteList.push(obj)};CompDeviceGroup.prototype.getBaseDevGroupNoteList=function(){return this.baseDevNoteList};CompDeviceGroup.prototype.addBaseDevGroupNote=function(obj){null==this.baseDevNoteList&&(this.baseDevNoteList=[]);return this.baseDevNoteList.push(obj)};CompDeviceGroup.getDefaultJsonData=function(){return{category:netBrain.Map.CategoryMgr.Cluter,key:NgUtil.getGUID(),location:"0 0",isShadowed:!1,visible:!0,hostName:"Device Group",status:1}};CompDeviceGroup.getVarCategory=function(){return netBrain.Map.CategoryMgr.Cluter};netBrain.Map=netBrain.Map||{};netBrain.Map.CompDeviceGroup=CompDeviceGroup}(NetBrain);!function(netBrain){var CompMedia=function(category){netBrain.Map.CompDevice.call(this);this.category=category};CompMedia.getDefaultJson=function(){return{category:netBrain.Map.CategoryMgr.Media,hostName:"",key:"",devType:"",devCategory:"",status:1,topoType:"",dataViewData:{devGraphicInfo:{imageList:[{name:"",size:"",scale:NetBrain.Map.Const.iconOnMapScale,status:1}],font:{faceName:BindHelper.defaultHostNameFont,fontSize:"9"}},devHighlightList:[]}}};(CompMedia.prototype=new netBrain.Map.CompDevice).construct=CompMedia;CompMedia.prototype.CreateMeidaJsonDataByNbrInfo=function(nbrInfo){return null==nbrInfo?null:this.CreateMeidaJsonDataByInfo(nbrInfo.getMediaName(),nbrInfo.getMedia(),nbrInfo.getMediaType(),nbrInfo.getTopoType())};CompMedia.prototype.CreateMeidaJsonDataByInfo=function(hostName,key,mediaType,topoType){if(null!=hostName&&null!=key&&null!=mediaType){var defaultData=this.construct.getDefaultJson();defaultData.hostName=hostName;defaultData.key=key;defaultData.devType=mediaType;defaultData.devCategory=mediaType;defaultData.topoType=topoType;defaultData.dataViewData={devGraphicInfo:{imageList:[{name:NetBrain.Map.gMediaTypeMgr.getIconNameByType(mediaType),size:NetBrain.Map.gMediaTypeMgr.getStrSizeByType(mediaType),scale:NetBrain.Map.Const.iconOnMapScale,status:1}]}};return defaultData}};CompMedia.prototype.setImageByMediaType=function(mediaType){null!=mediaType&&(this.dataViewData={devGraphicInfo:{imageList:[{name:NetBrain.Map.gMediaTypeMgr.getIconNameByType(mediaType),size:NetBrain.Map.gMediaTypeMgr.getStrSizeByType(mediaType),scale:NetBrain.Map.Const.iconOnMapScale,status:1}]}})};CompMedia.getVarCategory=function(){return netBrain.Map.CategoryMgr.Media};CompMedia.EVENT_NAMES={PICTURE_CLICK:"COMP_MEDIA_PICTURE_CLICK",PICTURE_CONTEXT_CLICK:"COMP_MEDIA_PICTURE_CONTEXT_CLICK"};CompMedia.getTheHostNameTextBlock=function(map,scope,showPlusFlag){var $=go.GraphObject.make;return $(go.TextBlock,{name:netBrain.Map.CompDevice.hostNameLable,editable:!1,stroke:"black",maxSize:new go.Size(250,1/0),font:BindHelper.defaultMediaHostNameFont,margin:new go.Margin(6,0,0,0),overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,textAlign:"center",toolTip:$(go.Adornment,"Auto",$(go.Shape,{fill:"#FFFFCC"}),$(go.TextBlock,{maxSize:new go.Size(600,1/0),margin:new go.Margin(12,6,12,6)},new go.Binding("text","hostName",BindHelper.toTarget_media_hostnameText)))},new go.Binding("text","hostName",BindHelper.toTarget_media_hostnameText),new go.Binding("opacity","hostName",(function(v,node){return""===v?0:1})),new go.Binding("background","",(function(){return scope.isEditMode()?null:"white"})),new go.Binding("maxLines","hostName",BindHelper.toTarget_media_hostnameLines))};CompMedia.getTheMainPanel=function(map,scope,showPlusFlag){var $=go.GraphObject.make;return $(go.Panel,$(go.Panel,"Auto",{name:"picturePanel"},$(go.Shape,{isPanelMain:!0,fill:"#ddedf8",stroke:null,strokeWidth:0,opacity:.6},new go.Binding("opacity","isSelected",(function(isSelected){return isSelected?.6:0})).ofObject()),$(go.Picture,{margin:new go.Margin(2,3,2,3),desiredSize:new go.Size(881,635),portId:"",name:"IMAGE",cursor:"point",click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompMedia.EVENT_NAMES.PICTURE_CLICK,event,target)},contextClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompMedia.EVENT_NAMES.PICTURE_CONTEXT_CLICK,event,target)}},new go.Binding("desiredSize","dataViewData",BindHelper.toTarget_media_desiredSize),new go.Binding("source","dataViewData",BindHelper.toTarget_media_source))))};function CompMediaNode(){go.Node.apply(this,arguments)}go.Diagram.inherit(CompMediaNode,go.Node);CompMediaNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var picObj=this.findObject("IMAGE");var picInfo=visioTools.getPictureInfo(picObj,!0);visioInfos.push(picInfo);var hostNameObj=this.findObject(netBrain.Map.CompDevice.hostNameLable);if(hostNameObj.isVisibleObject()){var hostNameInfo=visioTools.getTextInfo(hostNameObj);var maxLines=hostNameObj.maxLines;if(maxLines>1){var textArr=hostNameObj.text.split("\n");var textFont=hostNameObj.font;var widthArr=[];_.each(textArr.slice(0,maxLines),(function(text){var width=NgUtil.CanvasTools.calcHeight(textFont,text);widthArr.push(width)}));var currWidth=_.max(widthArr);var maxSizeWidth=hostNameObj.maxSize.width;_.isNumber(maxSizeWidth)&&!_.isNaN(maxSizeWidth)&&(currWidth=Math.min(maxSizeWidth,currWidth));var diffHalfWidth=(currWidth-hostNameInfo.bounds.width)/2;hostNameInfo.bounds.left-=diffHalfWidth;hostNameInfo.bounds.right+=diffHalfWidth;hostNameInfo.bounds.width=currWidth}visioInfos.push(hostNameInfo)}return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};CompMedia.getMapTemplate=function(map,scope,showPlusFlag,bChangeToPanel){return(0,go.GraphObject.make)(CompMediaNode,"Vertical",{locationObjectName:"IMAGE",locationSpot:go.Spot.Center,layerName:GlobalContext.DeviceLayerName,selectionObjectName:"picturePanel",shadowOffset:new go.Point(1,2),shadowBlur:20,shadowColor:"#2999E3",copyable:!1,selectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate()},new go.Binding("layerName").makeTwoWay(),new go.Binding("isShadowed").makeTwoWay(),new go.Binding("selectable","opacity",(function(opacity){return opacity>=1})).ofObject(),new go.Binding("visible").makeTwoWay(),new go.Binding("location","location",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)})).makeTwoWay((function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)})),CompMedia.getTheMainPanel(map,scope,showPlusFlag),CompMedia.getTheHostNameTextBlock(map,scope,showPlusFlag))};netBrain.Map=netBrain.Map||{};netBrain.Map.CompMedia=CompMedia}(NetBrain);!function(netBrain){var CompStencil=function CompStencil(){this.category=CompStencil.getVarCategory();this.key=NgUtil.getGUID();this.isShadowed=!1;this.visible=!0;this.hostName="";this.dataViewData=DeviceLabelInfoWrapper.getDefaultViewInfo()};(CompStencil.prototype=new netBrain.Map.CompDevice).constructor=CompStencil;CompStencil.prototype.setEditableMode=function(nodeObj,bEditable){if(nodeObj.category===CompStencil.getVarCategory()){netBrain.Map.CompDevice.prototype.setHostnameEditalbe.call(this,nodeObj,bEditable);netBrain.Map.CompDevice.prototype.setDevPosLabelEditable.call(this,nodeObj,bEditable);return!0}};CompStencil.prototype.isEditableMode=function(nodeObj){};CompStencil.prototype.setHostName=function(strHostName){this.hostName=strHostName};CompStencil.prototype.setImageName=function(strImageName){var tmpVar=new DeviceGraphicInfoWrapper;tmpVar.fromJson(this.dataViewData.devGraphicInfo);tmpVar.setImageName(strImageName);this.dataViewData.devGraphicInfo=tmpVar.toJson()};CompStencil.prototype.setPosition=function(x,y){this.setLocation(x+" "+y)};CompStencil.prototype.addDeviceInfo=function(strHostName){};CompStencil.getDefaultJsonData=function(){var jsonData=netBrain.Map.CompDevice.getDefaultJsonData();jsonData.category=CompStencil.getVarCategory();return jsonData};CompStencil.getVarCategory=function(){return netBrain.Map.CategoryMgr.Stencil};CompStencil.prototype.setImageSize=function(size){this.dataViewData.devGraphicInfo.imageList[0].size=size};CompStencil.getMapTemplate=function(map,scope,showPlusFlag){var template=netBrain.Map.CompDevice.getMapTemplate(map,scope,showPlusFlag);template.copyable=!0;var hostNamePanel=template.findObject(netBrain.Map.CompDevice.hostNameLable);hostNamePanel.bind(new go.Binding("font","displayName",(function(v,node){if(v){var displayName=v.toUpperCase();if(-1!==_.findIndex(["BUS","WAN","LAN","DMVPN","MUTE LAN","VPC"],(function(mn){return mn===displayName})))return BindHelper.defaultMediaHostNameFont}return BindHelper.defaultHostNameFont})));hostNamePanel.panel.cursor="pointer";return template};netBrain.Map=netBrain.Map||{};netBrain.Map.CompStencil=CompStencil;var ComStencilExt=function(){this.category=netBrain.Map.CategoryMgr.StencilExt};ComStencilExt.getVarCategory=function(){return netBrain.Map.CategoryMgr.StencilExt};ComStencilExt.getMapTemplate=function(map,scope,showPlusFlag){return netBrain.Map.CompDevice.getMapTemplate(map,scope,showPlusFlag)};ComStencilExt.getDefaultJsonData=function(){var jsonData=netBrain.Map.CompDevice.getDefaultJsonData();jsonData.category=netBrain.Map.CategoryMgr.StencilExt;return jsonData};(ComStencilExt.prototype=new netBrain.Map.CompStencil).constructor=CompStencil;netBrain.Map.ComStencilExt=ComStencilExt}(NetBrain);!function(netBrain){var CompUnknownIp=function(){netBrain.Map.CompDevice.call(this);this.category=netBrain.Map.CategoryMgr.UnknownIp};(CompUnknownIp.prototype=new netBrain.Map.CompDevice).getHostname=function(){return this.hostName};CompUnknownIp.prototype.setHostname=function(obj){this.hostName=obj};CompUnknownIp.prototype.getKey=function(){return this.key};CompUnknownIp.prototype.setKey=function(obj){this.key=obj};CompUnknownIp.prototype.getDevType=function(){return this.devType};CompUnknownIp.prototype.setDevType=function(obj){this.devType=obj};CompUnknownIp.prototype.getDevCategory=function(){return this.devCategory};CompUnknownIp.prototype.setDevCategory=function(obj){this.devCategory=obj};CompUnknownIp.getVarCategory=function(){return netBrain.Map.CategoryMgr.UnknownIp};CompUnknownIp.EVENT_NAMES={IMAGE_CLICK:"COMP_UNKNOWN_IP_IMAGE_CLICK",HOSTNAME_CLICK:"COMP_UNKNOWN_IP_HOSTNAME_CLICK"};CompUnknownIp.getMapTemplate=function(templateOpt,map,scope){var $=go.GraphObject.make;return $(CompUnknownIpNode,"Spot",{selectionObjectName:"IMAGE",layerName:GlobalContext.DeviceLayerName,shadowOffset:new go.Point(2,2),shadowBlur:25,shadowColor:"blue",selectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate()},new go.Binding("layerName").makeTwoWay(),new go.Binding("isShadowed").makeTwoWay(),new go.Binding("opacity"),new go.Binding("visible").makeTwoWay(),new go.Binding("location","location",templateOpt.locationParse).makeTwoWay(templateOpt.ptStringif),$(go.Panel,"Spot",$(go.Panel,"Spot",{alignment:new go.Spot(.5,.5,0,40)},$(go.Panel,"Auto",{name:"PICTURE"},$(go.Shape,{isPanelMain:!0,fill:"#ddedf8",stroke:null,strokeWidth:0,opacity:.6},new go.Binding("opacity","isSelected",(function(isSelected){return isSelected?.6:0})).ofObject()),$(go.Picture,{desiredSize:new go.Size(881,635),portId:"",name:"IMAGE",cursor:"point",click:function(event,target){scope.$emit(CompUnknownIp.EVENT_NAMES.COMP_UNKNOWN_IP_IMAGE_CLICK,event,target)}},new go.Binding("desiredSize","dataViewData",BindHelper.toTarget_media_desiredSize),new go.Binding("source","dataViewData",BindHelper.toTarget_device_source))),$(go.TextBlock,{name:"hostName",margin:1,editable:!1,alignment:new go.Spot(.5,1,0,10),stroke:"black",background:"white",font:BindHelper.defaultHostNameFont,click:function(event,target){scope.$emit(CompUnknownIp.EVENT_NAMES.COMP_UNKNOWN_IP_HOSTNAME_CLICK,event,target)}},new go.Binding("text","hostName")))))};CompUnknownIp.getDevGraphicInfo=function(imageList){var devGraphicInfo=new DeviceGraphicInfoWrapper;devGraphicInfo.setImageName("00000000-0000-0000-0000-00000000009a.png");imageList&&devGraphicInfo.setImageList(imageList);return devGraphicInfo.toJson()};CompUnknownIp.getDefaultJson=function(imageList){var dataViewData=DeviceLabelInfoWrapper.getDefaultViewInfo();dataViewData.devGraphicInfo=CompUnknownIp.getDevGraphicInfo(imageList);return{category:CompUnknownIp.getVarCategory(),hostName:"0.0.0.0",key:NgUtil.getGUID(),devType:1036,devCategory:1036,dataViewData:dataViewData}};function CompUnknownIpNode(){go.Node.apply(this,arguments)}go.Diagram.inherit(CompUnknownIpNode,go.Node);CompUnknownIpNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var picObj=this.findObject("IMAGE");var picInfo=visioTools.getPictureInfo(picObj,!0);visioInfos.push(picInfo);var hostNameInfo=visioTools.getTextVisioInfo(this,"hostName");visioInfos.push(hostNameInfo);return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};netBrain.Map=netBrain.Map||{};netBrain.Map.CompUnknownIp=CompUnknownIp}(NetBrain);!function(netBrain){var BasePathLink=function(type){this.selectedHops=[];go.Link.apply(this,arguments)};go.Diagram.inherit(BasePathLink,go.Link);BasePathLink.prototype.makeSubPaths=function(link){this.computePoints()};BasePathLink.prototype.computePoints=function(){var _this=this;var data=this.data;var diff=data.getDiff();var minValue=new go.Point;var maxBgWidth=this.getMaxBgWidth();var count=data.getSubPathCount();if(count>1){_.every(data.hoplist.slice(1),(function(hop){return!0===hop.isHide}))&&(count=1)}this.clearPoints();for(var index=0;index<count;index++){var subPath=data.getSubPath(index);var subNodes=this.makeSubPathNodes(subPath);var subPoints=this.makeSubPathPoints(subNodes,diff);if(subPoints){if(this.points.length>0){var pp=this.points.elt(this.points.count-1);this.addPoint(new go.Point(pp.x,pp.y));var np=subPoints[0];this.addPoint(new go.Point(np.x,np.y))}var customPoints=data.getCustomPoints(0);(subPoints=this.mergeCustomPoints(subPoints,customPoints,index)).forEach((function(pt){pt.x=Number(pt.x.toFixed(2));pt.y=Number(pt.y.toFixed(2));_this.addPoint(pt)}));subPoints.forEach((function(pt){minValue.x=Math.min(pt.x,minValue.x);minValue.y=Math.min(pt.y,minValue.y)}))}var subHops=data.getSubHops(index);subHops._tmpDrawNodes=subNodes;subHops._tmpDrawPoints=subPoints;var pathShapePanel=this.findObject("PATH");if(subPoints){var midPoint=NgUtil.Bezier.computeMidPoint(this.points.toArray());this.updateSubShape(subPoints,index,minValue,midPoint,maxBgWidth);pathShapePanel.elt(index).visible=!subHops.isHide}else pathShapePanel.elt(index).visible=!1}return!0};BasePathLink.prototype.updateSubShape=function(points,index,minValue,midPoint,maxBgWidth){var pathPanel=this.findObject("PATH");if(pathPanel&&0!==pathPanel.elements.count){var tmpPanel=pathPanel.elt(index);var bg=tmpPanel.elt(0);var lineStr=this.createSubPathShape(points,minValue);bg.geometry=go.Geometry.parse(lineStr);var line=tmpPanel.elt(1);line.geometry=go.Geometry.parse(lineStr);var offset=(bg.strokeWidth-line.strokeWidth)/2;line.alignmentFocus=new go.Spot(0,0,-offset,-offset);var arrow=tmpPanel.elt(2);var position=points[points.length-1].copy();position.y-=minValue.y;position.x-=minValue.x;var p=points[points.length-2].copy();p.y-=minValue.y;p.x-=minValue.x;var angle=go.Point.direction(p.x,p.y,position.x,position.y);arrow.angle=angle;var width=8*arrow.scale/2;var dAngle=angle-45;dAngle<0&&(dAngle+=360);var rad=angle*Math.PI/180;var mx=width*Math.cos(rad);var my=width*Math.sin(rad);var strokeWidth=bg.strokeWidth;position.x+=strokeWidth/2;position.y+=strokeWidth/2;arrow.alignment=new go.Spot(0,0,position.x-mx,position.y-my);var measureDistance=0;var distance=Math.sqrt(2)*width;measureDistance=dAngle>=45&&dAngle<=135?distance*Math.sin(dAngle*Math.PI/180):dAngle>=135&&dAngle<=225?distance*Math.cos(dAngle*Math.PI/180):dAngle>=225&&dAngle<=315?distance*Math.sin(dAngle*Math.PI/180):distance*Math.cos(dAngle*Math.PI/180);measureDistance=Math.abs(measureDistance);var offsetX=0;var offsetY=0;position.x-mx-measureDistance<0&&(offsetX=position.x-mx-measureDistance);position.y-my-measureDistance<0&&(offsetY=position.y-my-measureDistance);offset=new go.Point(midPoint.x-minValue.x-offsetX+maxBgWidth/2,midPoint.y-minValue.y-offsetY+maxBgWidth/2);var diffX=Math.min(minValue.x,0);var diffY=Math.min(minValue.y,0);tmpPanel.position=new go.Point(diffX+(maxBgWidth-line.strokeWidth)/2,diffY+(maxBgWidth-line.strokeWidth)/2);pathPanel.alignmentFocus=new go.Spot(0,0,offset.x,offset.y)}};BasePathLink.prototype.getMaxBgWidth=function(){var pathPanel=this.findObject("PATH");var maxWidth=-1;pathPanel.elements.each((function(item){var bg=item.elt(0);bg.strokeWidth>maxWidth&&(maxWidth=bg.strokeWidth)}));return maxWidth};BasePathLink.prototype.makeSubPathNodes=function(subPath){var _this=this;var oldNodes=[];if(subPath&&subPath.length>1){var diagram=this.diagram;subPath.forEach((function(sub){var node=diagram.findNodeForKey(sub.key);if(node instanceof go.Node&&node.location.isReal()){var pathPoint={hopIndex:sub.hopIndex,hopId:sub.hopId,node:node,port:sub.port};"inPort"in sub&&sub.inPort&&(pathPoint.inPort=sub.inPort);"outPort"in sub&&sub.outPort&&(pathPoint.outPort=sub.outPort);if(_this.getPointLocation(pathPoint)){oldNodes.length>0&&(pathPoint.perNode=oldNodes[oldNodes.length-1].node);oldNodes.push(pathPoint);if(node!==_this.toNode&&node!==_this.fromNode){var set=node._nbPaths;set||(set=node._nbPaths=new go.Set(go.Link));set.contains(_this)||set.add(_this)}}}}))}if(oldNodes.length<2)return null;var nodes=_.map(oldNodes,(function(n){return n}));1===nodes.length&&nodes.push(oldNodes[oldNodes.length-1]);return nodes};BasePathLink.prototype.getPointLocation=function(pathPoint){return go.Node.prototype.findPort.call(pathPoint.node,pathPoint.port).getDocumentPoint(go.Spot.Center)};BasePathLink.prototype.makeSubPathPoints=function(nodes,diff){var refPoints=[];if(!nodes||nodes.length<2)return null;var ratio=.25+.4*(diff=diff||.5);var locArr=this.getLocArrFromSubPaths(nodes);for(var i=0;i<locArr.length-1;i++){var startLoc=locArr[i];var endLoc=locArr[i+1];refPoints.push(startLoc);var distance=Math.sqrt(Math.pow(endLoc.x-startLoc.x,2)+Math.pow(endLoc.y-startLoc.y,2))*ratio;var firstCtrlPt=this.getPrevCtrlPoint(locArr,i,startLoc,endLoc,distance,refPoints);refPoints.push(firstCtrlPt);var secondCtrlPt=this.getNextCtrlPoint(locArr,i,startLoc,endLoc,distance,refPoints);refPoints.push(secondCtrlPt)}var last=nodes[nodes.length-1].node;var lastPort=go.Node.prototype.findPort.call(last,nodes[nodes.length-1].port);var endPt;var isL2SPN=isL2StylePathNew(this);var intfInfoList=NgUtil.getValueFromObjAndPath(last,"data.dataViewData.intfInfoList");if(isL2SPN&&_.isArray(intfInfoList)&&intfInfoList.length>0)endPt=locArr[locArr.length-1];else{var directionPoint=this.data.getCustomPointsBySegIndex(0,refPoints.length-1)||refPoints[refPoints.length-1];endPt=this.getLinkPointFromPoint(last,lastPort,lastPort.getDocumentPoint(go.Spot.Center),directionPoint,!1)}refPoints.push(endPt);4===refPoints.length&&(refPoints[1]=new go.Point(refPoints[1].x,refPoints[0].y));return refPoints.length<4?null:refPoints};BasePathLink.prototype.getPrevCtrlPoint=function(locArr,index,startLoc,endLoc,distance,refPoints){var prevPt;prevPt=index>0?locArr[index-1]:locArr[index];var origX=endLoc.x-prevPt.x;var origY=endLoc.y-prevPt.y;var offset=this.getCtrlPointOffset(origX,origY,distance);return new go.Point(startLoc.x+offset.x,startLoc.y+offset.y)};BasePathLink.prototype.getNextCtrlPoint=function(locArr,index,startLoc,endLoc,distance,refPoints){var point;if(index<locArr.length-2){var nextPt=locArr[index+2];var origX=nextPt.x-startLoc.x;var origY=nextPt.y-startLoc.y;var offset=this.getCtrlPointOffset(origX,origY,distance);point=new go.Point(endLoc.x-offset.x,endLoc.y-offset.y)}else{var lastPt=locArr[index+1];var prevPt=refPoints[refPoints.length-1];point=new go.Point((prevPt.x+lastPt.x)/2,(prevPt.y+lastPt.y)/2)}return point};BasePathLink.prototype.getCtrlPointOffset=function(origX,origY,distance){var singX=origX===Math.abs(origX)?1:-1;var singY=origY===Math.abs(origY)?1:-1;var targX=0;var targY=distance;if(0!==origX){targX=Math.sqrt(Math.pow(distance,2)/(Math.pow(origY/origX,2)+1));targY=Math.abs(origY/origX*targX)}return new go.Point(targX*singX,targY*singY)};BasePathLink.prototype.getLocArrFromSubPaths=function(subNodes){var _this=this;var arr=[];var isL2SPN=isL2StylePathNew(this);var netmap=getNetmap();subNodes.forEach((function(subNode){if(!isL2SPN||netmap&&!function(nodeData){var netmap=getNetmap();var flag=!1;netmap&&_.isFunction(netmap.isL2DeviceStyle)&&(flag=netmap.isL2DeviceStyle(nodeData));return flag}(subNode.node.data)||!subNode.inPort&&!subNode.outPort)arr.push(_this.getPointLocation(subNode));else{subNode.inPort&&arr.push(_this.getPointLocation({node:subNode.node,port:subNode.inPort}));netBrain.Map.CategoryMgr.isNetworkDevice(subNode.node.category)||arr.push(_this.getPointLocation(subNode));subNode.outPort&&subNode.outPort!==subNode.inPort&&arr.push(_this.getPointLocation({node:subNode.node,port:subNode.outPort}))}}));return arr};BasePathLink.prototype.getGeometryStringBySubPath=function(subPath){var nodes=this.makeSubPathNodes(subPath);var points=this.makeSubPathPoints(nodes,this.data.getDiff());var minX=0,minY=0;points.forEach((function(pt){minX=Math.min(pt.x,minX);minY=Math.min(pt.y,minY)}));return this.createSubPathShape(points,new go.Point(minX,minY))};BasePathLink.prototype.createSubPathShape=function(points,minValue){var strLine="M ";var first=points[0];strLine+=first.x-minValue.x+" "+(first.y-minValue.y)+" ";for(var i=1,len=points.length;i<len;i+=3){var ctrl1=points[i];var ctrl2=points[i+1];var start=points[i+2];strLine+=" C "+(ctrl1.x-minValue.x)+" "+(ctrl1.y-minValue.y)+" "+(ctrl2.x-minValue.x)+" "+(ctrl2.y-minValue.y)+" "+(start.x-minValue.x)+" "+(start.y-minValue.y)}return strLine};BasePathLink.prototype.mergeCustomPoints=function(points,customPoints,index){if(customPoints){var hoplist=NgUtil.getValueFromObjAndPath(this,"data.hoplist");var pointsCountObj={};var count=0;_.each(hoplist,(function(obj,i){var tmpPoints=obj._tmpDrawPoints;var len=tmpPoints&&tmpPoints.length||0;var minValue=count;var maxValue=count+=len;pointsCountObj[i]={min:minValue,max:maxValue}}));var getCurrIndexFromSegIndex=function(segIndex,index){return segIndex-2*index-pointsCountObj[index].min};var isValid=function(segIndex,index){var flag=!1;var obj=pointsCountObj[index];var minValue=obj.min;var maxValue=obj.max;(segIndex-=2*index)>=minValue&&segIndex<maxValue&&(flag=!0);return flag};for(var segIndex in customPoints)if(isValid(segIndex,index)){var currIndex=getCurrIndexFromSegIndex(segIndex,index);if(points[currIndex]){var hp=customPoints[segIndex];points[currIndex]=new go.Point(hp.x,hp.y)}}return points}};BasePathLink.isL2Style=!1;BasePathLink.prototype.getVisioInfo=function(){var visioInfos=[];var _this=this;var visioTools=netBrain.Map.visioTools;var pathPanel=this.findObject("PATH");var hoplist=this.data.hoplist;_.each(hoplist,(function(hop,index){var drawPoints=hop._tmpDrawPoints;if(drawPoints){var points=[];_.each(drawPoints,(function(dp){points.push(dp.x+" "+dp.y)}));var bounds;for(var i=0;i<points.length-1;i+=3){var p0=go.Point.parse(points[i]);var p1=go.Point.parse(points[i+1]);var p2=go.Point.parse(points[i+2]);var p3=go.Point.parse(points[i+3]);var bz=new NgUtil.Bezier(p0,p1,p2,p3);bz.segment(1,0);var tmpBounds=bz.getBounds();bounds=bounds?bounds.unionRect(tmpBounds):tmpBounds}var hopPath=pathPanel.elt(index);var hopIndex=hopPath.itemIndex;var customHopLine=NgUtil.getValueFromObjAndPath(_this,"data.customMapStyle."+hopIndex+".line");var strokeWidth=customHopLine&&customHopLine.strokeWidth||(0===index?6:3);var strokeDashArray=customHopLine&&customHopLine.strokeDashArray||hop.type;var stroke=customHopLine&&customHopLine.stroke||hop.color;var opacity=hopPath.opacity;var info={type:"path",color:stroke,lineType:strokeDashArray,points:points,lineWidth:strokeWidth,opacity:opacity,bounds:{top:bounds.top,right:bounds.right,bottom:bounds.bottom,left:bounds.left,width:bounds.width,height:bounds.height}};visioInfos.push(info);if(hopPath&&hopPath.visible){var arrowInfo=visioTools.getShapeVisioInfo(hopPath,"PATH-subPathArrow");visioInfos.push(arrowInfo)}}}));return visioTools.buildLinkVisioInfo(visioInfos,this.data,this)};BasePathLink.prototype.selectHop=function(hop){var diagram=this.diagram;if(diagram&&hop.name===netBrain.Map.CompPathNewBase.PathShapeContainer){diagram.startTransaction("selectHop");diagram.model.setDataProperty(hop.data,"isSelected",!0);this.selectedHops.push(hop);diagram.commitTransaction("selectHop")}};BasePathLink.prototype.unselectHop=function(hop){var diagram=this.diagram;if(diagram&&hop.name===netBrain.Map.CompPathNewBase.PathShapeContainer){diagram.startTransaction("unselectHop");diagram.model.setDataProperty(hop.data,"isSelected",!1);this.selectedHops=_.without(this.selectedHops,hop);diagram.commitTransaction("unselectHop")}};BasePathLink.prototype.selectAllHops=function(){var diagram=this.diagram;if(diagram){var _this=this;diagram.startTransaction("selectAllHops");this.selectedHops=[];this.findObject("PATH").elements.each((function(hop){_this.selectHop(hop)}));diagram.commitTransaction("selectAllHops")}};BasePathLink.prototype.clearAllSelectedHops=function(){var diagram=this.diagram;if(diagram){diagram.startTransaction("clearAllSelectedHops");_.each(this.selectedHops,(function(hop){diagram.model.setDataProperty(hop.data,"isSelected",!1)}));this.selectedHops=[];diagram.commitTransaction("clearAllSelectedHops")}};BasePathLink.prototype.isHopSelected=function(hop){return _.contains(this.selectedHops,hop)};BasePathLink.prototype.getSelectedHops=function(){var selectedHops=[];this.isSelected&&(selectedHops=this.selectedHops);return selectedHops};var PathLink=function(type){BasePathLink.apply(this,arguments)};go.Diagram.inherit(PathLink,BasePathLink);function isL2StylePathNew(path){var netmap=getNetmap();var isL2Style=BasePathLink.isL2Style;netmap&&(isL2Style=netmap.isL2MapStyle());var isPath=netBrain.Map.CategoryMgr.isPath(path.category);return!0===isL2Style&&isPath}function getNetmap(){return NetBrain.Map.currentActiveMapPage}netBrain.Map=netBrain.Map||{};netBrain.Map.BasePathLink=BasePathLink;netBrain.Map.PathLink=PathLink}(NetBrain);!function(netBrain){var CompHighlightBg=function(){this.highlightNodeMap={};this.highlightNodeStyle={figure:"Rectangle",fill:"#ffe789",stroke:"#ff6600",strokeWidth:1,strokeDashArray:[3,2],opacity:.6}};CompHighlightBg.category="highlightBg";CompHighlightBg.prototype.buildHighlightNodeTemplate=function(style){var $=go.GraphObject.make;return $(go.Adornment,go.Panel.Auto,{category:CompHighlightBg.category,layerName:""},$(go.Shape,style),$(go.Placeholder))};CompHighlightBg.prototype.makeHighlightNodeBg=function(node,style){if(node instanceof go.Node){style=_.extend(this.highlightNodeStyle,style);var bg=this.buildHighlightNodeTemplate(style);var mainPanel=node.selectionObject;var bounds=mainPanel.naturalBounds;var sc=mainPanel.getDocumentScale();var sw=0;mainPanel instanceof go.Shape&&(sw=mainPanel.strokeWidth);bg.placeholder.desiredSize=new go.Size((bounds.width+sw)*sc,(bounds.height+sw)*sc);bg.adornedObject=node;node.addAdornment(bg.category,bg);bg.location=mainPanel.getDocumentPoint(go.Spot.TopLeft);this.addHighlightMap(node,style);return bg}};CompHighlightBg.prototype.removeHighlightNodeBg=function(node){if(node instanceof go.Node){node.removeAdornment(CompHighlightBg.category);this.removeHighlightMap(node)}};CompHighlightBg.prototype.getHighlightBgList=function(){var result=[];_.each(this.highlightNodeMap,(function(obj){result.push({key:obj.key,style:obj.style})}));return result};CompHighlightBg.prototype.addHighlightMap=function(node,style){var key=node.data.key;this.highlightNodeMap[key]={key:key,style:style}};CompHighlightBg.prototype.removeHighlightMap=function(node){delete this.highlightNodeMap[node.data.key]};netBrain.Map=netBrain.Map||{};netBrain.Map.CompHighlightBg=CompHighlightBg}(NetBrain);!function(netBrain){var CompVirtualGroupNode=function(){netBrain.Map.CompGenericGroupNode.call(this);this.category=netBrain.Map.CategoryMgr.VirtualGroupNode};(CompVirtualGroupNode.prototype=new netBrain.Map.CompGenericGroupNode).init=function(){};CompVirtualGroupNode.plusRedIcon="plusRedIcon";CompVirtualGroupNode.hostName="hostName";CompVirtualGroupNode.bgShapeName="bgShapeName";CompVirtualGroupNode.getMapTemplate=function(map,scope,showPlusFlag){var $=go.GraphObject.make;return $(go.Group,"Auto",{background:"transparent",computesBoundsAfterDrag:!0,handlesDragDropForMembers:!0,layout:$(NetBrain.Map.CompGenericGroupNode.TreeLayout,{angle:90,arrangement:go.TreeLayout.ArrangementHorizontal,isRealtime:!1,isOngoing:!1})},new go.Binding("location","location",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)})).makeTwoWay((function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)})),new go.Binding("background","isHighlighted",(function(h){return h?"rgba(255,0,0,0.2)":"transparent"})).ofObject(),$(go.Shape,"Rectangle",{name:CompVirtualGroupNode.bgShapeName,fill:null,background:"#FFFFEE",stroke:"#000000",strokeWidth:2}),$(go.Panel,"Vertical",$(go.Panel,"Horizontal",{stretch:go.GraphObject.Horizontal},$("SubGraphExpanderButton",{alignment:go.Spot.Right,margin:5}),$(go.TextBlock,{name:CompVirtualGroupNode.hostName,alignment:go.Spot.Left,editable:!0,margin:new go.Margin(5,32,0,0),font:"bold 18px sans-serif",opacity:.75,stroke:"#404040"},new go.Binding("text","hostName").makeTwoWay())),$(go.Placeholder,{padding:5,alignment:go.Spot.TopLeft})),$(go.Panel,go.Panel.Auto,{name:"plusIcon",visible:!1,alignment:new go.Spot(1,0,-5,5),alignmentFocus:go.Spot.Center,click:function(s,e){scope&&_.isFunction(scope.$emit)&&scope.$emit(NetBrain.Map.CompDevice.EVENT_NAMES.PLUS_ICON_CLICK,s,e)}},new go.Binding("visible","devCategory",(function(devCategory){return showPlusFlag})),$(go.Shape,{fill:"transparent",desiredSize:new go.Size(16,16),stroke:null}),$(go.Shape,{fill:"#ffffff",figure:"Circle",desiredSize:new go.Size(16,16),stroke:null}),$(go.Shape,{name:CompVirtualGroupNode.plusRedIcon,fill:"#CC3333",desiredSize:new go.Size(14,14),stroke:null,geometry:NetBrain.Map.CCompLabel.getRedplusIcon()})))};function CompGraphVirtualGroupNode(){go.Group.apply(this,arguments)}go.Diagram.inherit(CompGraphVirtualGroupNode,go.Group);CompGraphVirtualGroupNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var bgShapeInfo=visioTools.getShapeVisioInfo(this,CompVirtualGroupNode.bgShapeName);visioInfos.push(bgShapeInfo);var hostNameInfo=visioTools.getTextVisioInfo(this,CompVirtualGroupNode.hostName);visioInfos.push(hostNameInfo);if(this.findObject("plusIcon").visible){var plusObj=this.findObject(CompDevice.plusRedIcon);var plusInfo=visioTools.getShapeInfo(plusObj);visioInfos.push(plusInfo)}return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};netBrain.Map=netBrain.Map||{};netBrain.Map.CompVirtualGroupNode=CompVirtualGroupNode}(NetBrain);!function(netBrain){var CompPathNewBase=function(){};(CompPathNewBase.prototype=new netBrain.Map.CompDrawShapeBase).construct=CompPathNewBase;CompPathNewBase.prototype.init=function(){if(null!=this.fromDev){this.from=this.fromDev.ID||this.fromDev._id;this.fromDev.ID=this.from}if(null!=this.toDev){this.to=this.toDev.ID||this.toDev._id;this.toDev.ID=this.to}this.fromPortIntf=netBrain.Map.CategoryMgr.TracePath;this.toPortIntf=netBrain.Map.CategoryMgr.TracePath;this.diff=this.diff||function createDiff(from,to,n){var diff=Math.random();var key=[from,to].sort().join(",");if(pathDiffDict[key]){if(0!==_.select(pathDiffDict[key],(function(value){return Math.abs(value-diff)<pathDiffDict.nearly})).length){n=n||1;var size=1/pathDiffDict.nearly;(pathDiffDict[key].length>=size||n/size>size)&&pathDiffDict[key].shift();return createDiff(from,to,n+1)}pathDiffDict[key].push(diff)}else pathDiffDict[key]=[diff];return diff}(this.from,this.to);this.customPoints=this.customPoints||[]};var pathDiffDict={nearly:.137};CompPathNewBase.getVarCategory=function(){return netBrain.Map.CategoryMgr.TracePath};CompPathNewBase.prototype.getKey=function(){return this.pathId};CompPathNewBase.prototype.getTaskId=function(){return this.taskId};CompPathNewBase.prototype.getFromDevName=function(){return null!=this.fromDev?this.fromDev.devName:null};CompPathNewBase.prototype.getToDevName=function(){return null!=this.toDev?this.toDev.devName:null};CompPathNewBase.prototype.getSource=function(){return this.source};CompPathNewBase.prototype.getDest=function(){return this.dest};CompPathNewBase.prototype.getSubPaths=function(){return this.hoplist};CompPathNewBase.prototype.getSubPathCount=function(){var count=0;var subPaths=this.hoplist;null!=subPaths&&(count=subPaths.length);return count};CompPathNewBase.prototype.getSubPath=function(index){var pathInfo=[];var port;var subPaths=this.hoplist;if(Array.isArray(subPaths)&&index>=0&&index<subPaths.length){var path=subPaths[index];if(Array.isArray(path.hops))for(var i=0;i<path.hops.length;i++){var link=path.hops[i];if(null!=link){if(0==i&&null!=link.fromDev){port="";link.fromIntf&&link.fromIntf.intfKeyObj&&link.fromIntf.intfKeyObj.value&&(port=link.fromIntf.intfKeyObj.value);pathInfo.push({hopIndex:i,hopId:link.hopId,key:link.fromDev.devId,port:port})}null!=link.mediaId&&pathInfo.push({hopIndex:i,hopId:link.hopId,key:link.mediaId,port:""});if(null!=link.toDev){port="";link.fromIntf&&link.fromIntf.intfKeyObj&&link.fromIntf.intfKeyObj.value&&(port=link.fromIntf.intfKeyObj.value);pathInfo.push({hopIndex:i,hopId:link.hopId,key:link.toDev.devId,port:port})}}}}return pathInfo};CompPathNewBase.prototype.getSubHops=function(index){var subHops=this.hoplist;return Array.isArray(subHops)&&index>=0&&index<subHops.length?subHops[index]:null};CompPathNewBase.prototype.isLivePath=function(){return 1===this.dataSource.type};CompPathNewBase.prototype.isHistoryPath=function(){return!this.isLivePath()};CompPathNewBase.prototype.getColor=function(){return this.color};CompPathNewBase.prototype.setColor=function(color){this.color=color;if(!(null==this.hoplist||this.hoplist.length<0))for(var i=0;i<this.hoplist.length;i++){this.hoplist[i].color=color}};CompPathNewBase.prototype.setType=function(type){_.isNumber(type)&&(type=BindHelper.lineTypeToArray(type));this.type=type;if(!(null==this.hoplist||this.hoplist.length<0))for(var i=0;i<this.hoplist.length;i++){this.hoplist[i].type=type}};CompPathNewBase.prototype.getDiff=function(){return this.diff};CompPathNewBase.prototype.setDiff=function(diff){this.diff=diff};CompPathNewBase.prototype.getCustomPoints=function(index){return isNaN(index)?this.customPoints:this.customPoints[index]||{}};CompPathNewBase.prototype.setCustomPoints=function(index,obj){this.customPoints[index]=obj};CompPathNewBase.prototype.getCustomPointsBySegIndex=function(index,segIndex){return this.getCustomPoints(index)[segIndex]};CompPathNewBase.PathShapeContainer="PATH-shape-container";CompPathNewBase.makeMapTemplate=function(template,templateOption){template.curve=go.Link.Bezier;template.layerName=GlobalContext.LinkLayerName;template.selectionAdornmentTemplate=go.GraphObject.make(go.Adornment,"Link",{});template.selectionChanged=function(part){part.isSelected||part.clearAllSelectedHops()};template.reshapable=!0;var line=new go.Shape;line.name="LINE";line.isPanelMain=!0;line.stroke="pink";line.strokeWidth=3;line.opacity=0;template.add(line);var pathPanel=new go.Panel(go.Panel.Position);pathPanel.name="PATH";pathPanel.bind(new go.Binding("itemArray","hoplist"));var subPathTmpl=new go.Panel(go.Panel.Spot);subPathTmpl.name=CompPathNewBase.PathShapeContainer;var bgShape=NormalSelectAdormenTemplate.getPathBgShapeTemplate();subPathTmpl.add(bgShape);var subPathShape=new go.Shape;subPathShape.name="PATH-subPathShape";subPathShape.alignmentFocus=go.Spot.TopLeft;subPathShape.alignment=go.Spot.TopLeft;subPathShape.stroke="pink";subPathShape.strokeWidth=3;subPathShape.bind(new go.Binding("strokeWidth","hops",(function(v,obj){return obj.panel&&0===obj.panel.itemIndex?6:3})));subPathShape.bind(new go.Binding("strokeDashArray","type"));subPathShape.bind(new go.Binding("stroke","color"));subPathShape.bind(new go.Binding("stroke","",BindHelper.getPathCustomLineStroke));subPathShape.bind(new go.Binding("strokeWidth","",BindHelper.getPathCustomLineStrokeWidth));subPathShape.bind(new go.Binding("strokeDashArray","",BindHelper.getPathCustomLineStrokeDashArray));subPathTmpl.add(subPathShape);var subPathArrow=new go.Shape;subPathArrow.name="PATH-subPathArrow";subPathArrow.toArrow="Standard";subPathArrow.alignmentFocus=go.Spot.Center;subPathArrow.stroke=null;subPathArrow.strokeWidth=0;subPathArrow.scale=3;subPathArrow.fill="pink";subPathArrow.bind(new go.Binding("fill","color"));subPathArrow.bind(new go.Binding("fill","",BindHelper.getPathCustomLineFill));subPathArrow.bind(new go.Binding("scale","strokeWidth",BindHelper.getPathCustomArrowScale).ofObject("PATH-subPathShape"));subPathTmpl.add(subPathArrow);subPathTmpl.bind(new go.Binding("opacity","itemIndex",(function(i){return 0===i?1:.5})).ofObject());subPathTmpl.bind(new go.Binding("visible","isHide",(function(isHide,obj){return!!obj.data._tmpDrawPoints&&!isHide})));pathPanel.itemTemplate=subPathTmpl;template.add(pathPanel)};CompPathNewBase.EVENT_NAMES={CLICK:"COMP_PATH_NEW_BASE_CLICK"};CompPathNewBase.getMapTemplate=function(templateOption,map,scope){var template=new netBrain.Map.BasePathLink;CompPathNewBase.makeMapTemplate(template,templateOption);template.click=function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompPathNewBase.EVENT_NAMES.CLICK,event,target)};return template};CompPathNewBase.getDefaultJsonData=function(){return{category:netBrain.Map.CategoryMgr.TracePath,key:NgUtil.getGUID(),pathId:NgUtil.getGUID(),fromDev:null,toDev:null,hoplist:[]}};CompPathNewBase.buildPathFromDevices=function(deviceList){var hops=[];var length=deviceList.length;if(length<2)return null;for(var index=0;index<length-1;index++){var compDevFrom=deviceList[index];var compDevTo=deviceList[index+1];if("function"!=typeof compDevFrom.getKey&&"function"!=typeof compDevTo.getKey)return;if(compDevFrom.getKey()!==compDevTo.getKey()){var hop={fromDev:{devId:compDevFrom.getKey()},fromIntf:{intfKeyObj:{value:""}},toDev:{devId:compDevTo.getKey()},toIntf:{intfKeyObj:{value:""}}};hops.push(hop)}}return hops.length<1?null:{category:netBrain.Map.CategoryMgr.TracePath,key:NgUtil.getGUID(),pathId:NgUtil.getGUID(),fromDev:{ID:hops[0].fromDev.devId},toDev:{ID:hops[hops.length-1].toDev.devId},hoplist:[{hops:hops}]}};var CompPathNew=function(){};(CompPathNew.prototype=new CompPathNewBase).construct=CompPathNew;CompPathNew.getVarCategory=function(){return netBrain.Map.CategoryMgr.PathNew};CompPathNew.EVENT_NAMES={CLICK:"COMP_PATH_NEW_CLICK",CONTEXT_CLICK:"COMP_PATH_NEW_CONTEXT_CLICK"};CompPathNew.getMapTemplate=function(templateOption,map,scope){var template=new netBrain.Map.PathLink;CompPathNewBase.makeMapTemplate(template,templateOption);template.click=function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompPathNew.EVENT_NAMES.CLICK,event,target)};template.contextClick=function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompPathNew.EVENT_NAMES.CONTEXT_CLICK,event,target)};return template};CompPathNew.prototype.getSubPath=function(index){var pathInfo=[];var tmpObj;var port;var subPaths=this.hoplist;if(Array.isArray(subPaths)&&index>=0&&index<subPaths.length){var path=subPaths[index];if(Array.isArray(path.hops))for(var i=0;i<path.hops.length;i++){var link=path.hops[i];if(null!=link&&(i!==path.hops.length-1||!link.toDev||!link.toDev.devId)){if(link.fromDev){port=NgUtil.getValueFromObjAndPath(link,"fromIntf.intfKeyObj.value","");if(0===i){tmpObj={hopIndex:i,hopId:link.hopId,key:link.fromDev.devId,port:"",outPort:port};pathInfo.push(tmpObj)}else{pathInfo[pathInfo.length-1].outPort=port}}if(link.mediaId&&!link.isP2P){tmpObj={hopIndex:i,hopId:link.hopId,key:link.mediaId,port:""};pathInfo.push(tmpObj)}if(link.toDev){tmpObj={hopIndex:i,hopId:link.hopId,key:link.toDev.devId,port:""};port=NgUtil.getValueFromObjAndPath(link,"toIntf.intfKeyObj.value","");tmpObj.inPort=port;pathInfo.push(tmpObj)}}}}return pathInfo};netBrain.Map=netBrain.Map||{};netBrain.Map.CompPathNewBase=CompPathNewBase;netBrain.Map.CompPathNew=CompPathNew}(NetBrain);!function(netBrain){function CCompLabel(jsdata){this.data=jsdata}CCompLabel.prototype={constructor:CCompLabel,getPosName:function(){return this.data.posName},setPosName:function(obj){this.data.posName=obj},getDisplay:function(){return void 0===this.data.posInfo?null:this.data.posInfo.displayInfo},setDisplay:function(obj){this.data.posInfo&&"string"==typeof obj&&(this.data.posInfo.displayInfo=obj)},getShowScale:function(){return void 0===this.data.labelGraphicInfo?null:this.data.labelGraphicInfo.scale},setShowScale:function(obj){this.data.labelGraphicInfo&&(this.data.labelGraphicInfo.scale=obj)},getColor:function(){return this.data.labelGraphicInfo.color},setColor:function(obj){this.data.labelGraphicInfo.color=obj},getBgColor:function(){return this.data.labelGraphicInfo.bgcolor},setBgColor:function(obj){this.data.labelGraphicInfo.bgcolor=obj}};CCompLabel.LabelIconSvg={link:"M1520 1216q0-40-28-68l-208-208q-28-28-68-28-42 0-72 32 3 3 19 18.5t21.5 21.5 15 19 13 25.5 3.5 27.5q0 40-28 68t-68 28q-15 0-27.5-3.5t-25.5-13-19-15-21.5-21.5-18.5-19q-33 31-33 73 0 40 28 68l206 207q27 27 68 27 40 0 68-26l147-146q28-28 28-67zm-703-705q0-40-28-68l-206-207q-28-28-68-28-39 0-68 27l-147 146q-28 28-28 67 0 40 28 68l208 208q27 27 68 27 42 0 72-31-3-3-19-18.5t-21.5-21.5-15-19-13-25.5-3.5-27.5q0-40 28-68t68-28q15 0 27.5 3.5t25.5 13 19 15 21.5 21.5 18.5 19q33-31 33-73zm895 705q0 120-85 203l-147 146q-83 83-203 83-121 0-204-85l-206-207q-83-83-83-203 0-123 88-209l-88-88q-86 88-208 88-120 0-204-84l-208-208q-84-84-84-204t85-203l147-146q83-83 203-83 121 0 204 85l206 207q83 83 83 203 0 123-88 209l88 88q86-88 208-88 120 0 204 84l208 208q84 84 84 204z",table:"M576 1376v-192q0-14-9-23t-23-9h-320q-14 0-23 9t-9 23v192q0 14 9 23t23 9h320q14 0 23-9t9-23zm0-384v-192q0-14-9-23t-23-9h-320q-14 0-23 9t-9 23v192q0 14 9 23t23 9h320q14 0 23-9t9-23zm512 384v-192q0-14-9-23t-23-9h-320q-14 0-23 9t-9 23v192q0 14 9 23t23 9h320q14 0 23-9t9-23zm-512-768v-192q0-14-9-23t-23-9h-320q-14 0-23 9t-9 23v192q0 14 9 23t23 9h320q14 0 23-9t9-23zm512 384v-192q0-14-9-23t-23-9h-320q-14 0-23 9t-9 23v192q0 14 9 23t23 9h320q14 0 23-9t9-23zm512 384v-192q0-14-9-23t-23-9h-320q-14 0-23 9t-9 23v192q0 14 9 23t23 9h320q14 0 23-9t9-23zm-512-768v-192q0-14-9-23t-23-9h-320q-14 0-23 9t-9 23v192q0 14 9 23t23 9h320q14 0 23-9t9-23zm512 384v-192q0-14-9-23t-23-9h-320q-14 0-23 9t-9 23v192q0 14 9 23t23 9h320q14 0 23-9t9-23zm0-384v-192q0-14-9-23t-23-9h-320q-14 0-23 9t-9 23v192q0 14 9 23t23 9h320q14 0 23-9t9-23zm128-320v1088q0 66-47 113t-113 47h-1344q-66 0-113-47t-47-113v-1088q0-66 47-113t113-47h1344q66 0 113 47t47 113z",file:"M1596 476q14 14 28 36h-472v-472q22 14 36 28zm-476 164h544v1056q0 40-28 68t-68 28h-1344q-40 0-68-28t-28-68v-1600q0-40 28-68t68-28h800v544q0 40 28 68t68 28zm160 736v-64q0-14-9-23t-23-9h-704q-14 0-23 9t-9 23v64q0 14 9 23t23 9h704q14 0 23-9t9-23zm0-256v-64q0-14-9-23t-23-9h-704q-14 0-23 9t-9 23v64q0 14 9 23t23 9h704q14 0 23-9t9-23zm0-256v-64q0-14-9-23t-23-9h-704q-14 0-23 9t-9 23v64q0 14 9 23t23 9h704q14 0 23-9t9-23z",attachment:"M1596 1385q0 117-79 196t-196 79q-135 0-235-100l-777-776q-113-115-113-271 0-159 110-270t269-111q158 0 273 113l605 606q10 10 10 22 0 16-30.5 46.5t-46.5 30.5q-13 0-23-10l-606-607q-79-77-181-77-106 0-179 75t-73 181q0 105 76 181l776 777q63 63 145 63 64 0 106-42t42-106q0-82-63-145l-581-581q-26-24-60-24-29 0-48 19t-19 48q0 32 25 59l410 410q10 10 10 22 0 16-31 47t-47 31q-12 0-22-10l-410-410q-63-61-63-149 0-82 57-139t139-57q88 0 149 63l581 581q100 98 100 235z",extra:"M8.5,24.8c-3.6,0-6.6,2.9-6.6,6.6s2.9,6.6,6.6,6.6c3.6,0,6.6-2.9,6.6-6.6S12.1,24.8,8.5,24.8z M8.5,34c-1.4,0-2.6-1.2-2.6-2.6s1.2-2.6,2.6-2.6c1.4,0,2.6,1.2,2.6,2.6S9.9,34,8.5,34z M32.1,24.8c-3.6,0-6.6,2.9-6.6,6.6s2.9,6.6,6.6,6.6c3.6,0,6.6-2.9,6.6-6.6S35.7,24.8,32.1,24.8z M32.1,34c-1.4,0-2.6-1.2-2.6-2.6s1.2-2.6,2.6-2.6c1.4,0,2.6,1.2,2.6,2.6S33.5,34,32.1,34z M55.7,24.8c-3.6,0-6.6,2.9-6.6,6.6s2.9,6.6,6.6,6.6c3.6,0,6.6-2.9,6.6-6.6S59.3,24.8,55.7,24.8z M55.7,34c-1.4,0-2.6-1.2-2.6-2.6s1.2-2.6,2.6-2.6c1.4,0,2.6,1.2,2.6,2.6S57.1,34,55.7,34z",list:"M512 1248v192q0 40-28 68t-68 28h-320q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h320q40 0 68 28t28 68zm0-512v192q0 40-28 68t-68 28h-320q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h320q40 0 68 28t28 68zm1280 512v192q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h960q40 0 68 28t28 68zm-1280-1024v192q0 40-28 68t-68 28h-320q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h320q40 0 68 28t28 68zm1280 512v192q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h960q40 0 68 28t28 68zm0-512v192q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-192q0-40 28-68t68-28h960q40 0 68 28t28 68z",formatNote:"M1 1h10v3.003L8.536 3H3.23L1.28 4.358 M5 3h2v10H5z",editPencil:"M58.2,13.6l-2.9,3c2.9,4.4,4.6,9.7,4.6,15.4c0,15.4-12.5,27.9-27.9,27.9C16.6,59.9,4.1,47.4,4.1,32S16.6,4.1,32,4.1c4.8,0,9.4,1.2,13.3,3.4l2.8-3.1C43.4,1.6,37.9,0,32,0C14.3,0,0,14.3,0,32s14.3,32,32,32c17.7,0,32-14.3,32-32C64,25.2,61.9,18.8,58.2,13.6zM54.8,6.7c0,0,0,0.2-0.1,0.6c-0.1,0.4-0.1,1-0.2,1.7c-0.1,0.7-0.2,1.6-0.5,2.6c-0.1,0.5-0.2,1-0.3,1.5c0,0.3-0.2,0.5-0.5,0.6c-0.2,0.2-0.4,0.4-0.5,0.6c-2.8,3.2-6.6,7.5-10.4,11.8S34.9,34.7,32,37.9c-0.2,0.2-0.4,0.4-0.5,0.6c-0.1,0.2-0.3,0.4-0.6,0.5c-0.5,0.2-1,0.4-1.5,0.5c-0.9,0.3-1.8,0.6-2.5,0.8c-0.7,0.2-1.3,0.4-1.7,0.5C24.9,41,24.7,41,24.7,41s0-0.2,0.1-0.6c0.1-0.4,0.1-1,0.2-1.7c0.1-0.7,0.3-1.6,0.5-2.6c0.1-0.5,0.2-1,0.3-1.5c0-0.3,0.2-0.5,0.4-0.6c0.2-0.2,0.4-0.4,0.5-0.6c2.8-3.2,6.6-7.5,10.4-11.8s7.5-8.6,10.4-11.8c0.2-0.2,0.4-0.4,0.5-0.6c0.1-0.2,0.3-0.4,0.5-0.5C49,8.4,49.5,8.2,50,8c0.9-0.3,1.8-0.6,2.5-0.8c0.7-0.2,1.3-0.3,1.7-0.4C54.6,6.7,54.8,6.7,54.8,6.7zM19,44 L39.8,44 39.8,51 19,51z",gdrList:"M6.9,3.2C6.6,3.1,6.6,2.8,6.8,2.6L9.4,1c0.3-0.1,0.5,0,0.5,0.3v0.8h1.9c0.2,0,0.3,0.2,0.3,0.3v0.7 c0,0.2-0.1,0.3-0.3,0.3H9.9v0.9c0,0.3-0.2,0.5-0.5,0.3L6.9,3.2z M12,7.2v1.9c0,0.5-0.4,0.9-0.7,0.9H0.8c-0.4,0-0.7-0.4-0.7-0.9 V0.9C0.1,0.4,0.5,0,0.8,0h5.2c0.2,0,0.4,0.2,0.4,0.5S6.2,1,6.1,1H1.7C1.3,1,0.9,1.3,0.9,1.8v6.3C0.9,8.7,1.3,9,1.7,9h8.7 c0.4,0,0.7-0.4,0.7-0.9V5.6c0-0.2,0.2-0.4,0.4-0.4c0.2,0,0.4,0.2,0.4,0.5 M6,2.9H1.8c-0.2,0-0.4-0.2-0.4-0.4s0.1-0.4,0.4-0.4H6 c0.2,0,0.4,0.2,0.4,0.4C6.4,2.8,6.2,2.9,6,2.9z M6,5.3H1.8c-0.2,0-0.4-0.2-0.4-0.4c0-0.2,0.2-0.4,0.4-0.4H6 c0.2,0,0.4,0.2,0.4,0.4C6.4,5.1,6.2,5.3,6,5.3z M9,7.7H1.8c-0.2,0-0.4-0.2-0.4-0.4c0-0.2,0.2-0.4,0.4-0.4H9 c0.2,0,0.4,0.2,0.4,0.4C9.4,7.5,9.2,7.7,9,7.7z"};CCompLabel.getLabelIconDataUnit=function(posInfo,node){var iconString=node.geometry;if(null==iconString&&NgUtil.getValueFromObjAndPath(posInfo,"dataUnitList.0")){switch(posInfo.dataUnitList[0].valueType){case DataUnitType.uList_primitive_subtype:case DataUnitType.uList_object_subtype:case DataUnitType.uTable:case DataUnitType.uParserTable:iconString=CCompLabel.LabelIconSvg.table;break;case DataUnitType.uDoc:iconString=CCompLabel.LabelIconSvg.attachment;break;case DataUnitType.uHyperLink:iconString=CCompLabel.LabelIconSvg.link;break;case DataUnitType.uConfigFile:iconString=CCompLabel.LabelIconSvg.file;break;case DataUnitType.uObject:iconString=CCompLabel.LabelIconSvg.list;break;case DataUnitType.uParagraph:iconString=CCompLabel.LabelIconSvg.formatNote;break;case DataUnitType.uList:iconString=CCompLabel.LabelIconSvg.gdrList}null!=iconString&&(iconString=go.Geometry.parse(go.Geometry.fillPath(iconString))).normalize()}return iconString};CCompLabel.getLabelIconOverflow=function(posName,node){var iconString=node.geometry;null==iconString&&posName===DataViewPosName.overflowPos&&(iconString=CCompLabel.createExtraIconString());return iconString};CCompLabel.createExtraIconString=function(){var iconString=CCompLabel.createExtraIconString.iconString;if(!iconString){iconString=CCompLabel.LabelIconSvg.extra;(iconString=go.Geometry.parse(go.Geometry.fillPath(iconString))).normalize();CCompLabel.createExtraIconString.iconString=iconString}return iconString};CCompLabel.isExtraIcon=function(el){var labelIcon=el.findObject("labelIcon");var iconString=CCompLabel.createExtraIconString.iconString;return labelIcon&&iconString&&labelIcon.geometryString===iconString.toString()};CCompLabel.getEditLabelIcon=function(labelData){var iconString=CCompLabel.LabelIconSvg.editPencil;(iconString=go.Geometry.parse(go.Geometry.fillPath(iconString))).normalize();return iconString};CCompLabel.getRedplusIcon=function(){return parseGeometry("M237 556 c-160 -59 -217 -252 -114 -388 69 -92 198 -123 302 -74 193 91 194 353 2 453 -43 22 -143 27 -190 9z m133 -141 l0 -55 55 0 55 0 0 -45 0 -45 -55 0 -55 0 0 -55 0 -55 -45 0 -45 0 0 55 0 55 -55 0 -55 0 0 45 0 45 55 0 55 0 0 55 0 55 45 0 45 0 0 -55z")};CCompLabel.getPathPointAIcon=function(){return parseGeometry("M 38.377731,174.01215 C 35.60517,166.78697 83.982558,31.347104 90.186163,28.966558 c 9.17399,-3.520391 34.445027,-1.985885 37.219977,2.260069 1.50409,2.301405 13.60523,34.625348 26.89141,71.830983 17.16544,48.06879 23.16002,68.86949 20.71287,71.87197 -1.89412,2.32394 -9.15585,4.22535 -16.13718,4.22535 -14.31403,0 -17.64917,-3.01456 -23.53041,-21.26861 l -4.12977,-12.81791 -24.06916,0.98692 -24.06915,0.98692 -5.024627,13.52113 c -2.763542,7.43662 -6.624375,14.63868 -8.579624,16.00458 -6.714132,4.69035 -29.015609,2.85718 -31.092768,-2.55581 z m 80.762679,-64.42016 c 2.11257,-2.11257 -6.86168,-31.726727 -11.01187,-36.338108 -2.45868,-2.731896 -13.480652,24.925664 -13.480652,33.827148 0,4.46205 20.445382,6.5581 24.492522,2.51096 z")};CCompLabel.getPathPointBIcon=function(){return parseGeometry("M 55.597674,174.84223 C 54.687458,172.47025 54.354917,138.62518 54.85869,99.630964 l 0.915958,-70.898569 27.042254,-1.095842 c 33.625178,-1.362603 59.268848,3.943797 68.971918,14.272237 11.20739,11.929724 12.78369,29.658818 3.96576,44.604099 l -7.33675,12.434859 7.76292,8.263242 c 6.10141,6.49466 7.76291,12.13662 7.76291,26.36051 0,15.4247 -1.4692,19.63077 -9.94869,28.48146 -5.47178,5.7113 -15.3591,11.88721 -21.97183,13.72423 -18.19024,5.05327 -74.391405,4.36572 -76.425466,-0.93496 z m 67.541156,-34.80199 c 12.30829,-12.30828 1.34552,-25.97054 -19.61067,-24.43965 -12.517573,0.91444 -14.063403,2.0034 -15.047846,10.60045 -0.603431,5.26972 -0.270896,11.73451 0.738984,14.36619 2.545359,6.63311 27.141582,6.25097 33.919532,-0.52699 z M 121.9253,79.153275 c 7.55903,-9.108081 -0.33083,-16.618063 -17.45868,-16.618063 -15.216781,0 -19.852206,5.186819 -15.281125,17.098861 2.607742,6.795667 26.998135,6.437486 32.739805,-0.480798 z")};CCompLabel.PATH_ICON_A="A";CCompLabel.PATH_ICON_B="B";CCompLabel.PATH_ICON_R="R";CCompLabel.PATH_ICON_S="S";CCompLabel.getPathPointIcon=function(type){var pathString="";if(type===this.PATH_ICON_S)pathString="M10.7714844,9.67382812 C10.7714844,10.4355507 10.4960965,11.033201 9.9453125,11.4667969 C9.3945285,11.9003928 8.63477047,12.1171875 7.66601562,12.1171875 C6.69726078,12.1171875 5.90429996,11.9667984 5.28710938,11.6660156 L5.28710938,10.3417969 C5.67773633,10.5253915 6.09277124,10.6699213 6.53222656,10.7753906 C6.97168188,10.8808599 7.38085748,10.9335938 7.75976562,10.9335938 C8.3144559,10.9335938 8.72363149,10.8281261 8.98730469,10.6171875 C9.25097788,10.4062489 9.3828125,10.1230487 9.3828125,9.76757812 C9.3828125,9.44726402 9.26171996,9.17578236 9.01953125,8.953125 C8.77734254,8.73046764 8.27734754,8.4667984 7.51953125,8.16210938 C6.73827734,7.84570154 6.1875016,7.48437703 5.8671875,7.078125 C5.5468734,6.67187297 5.38671875,6.1835966 5.38671875,5.61328125 C5.38671875,4.89843393 5.64062246,4.33593955 6.1484375,3.92578125 C6.65625254,3.51562295 7.33788635,3.31054688 8.19335938,3.31054688 C9.01367598,3.31054688 9.83007406,3.49023258 10.6425781,3.84960938 L10.1972656,4.9921875 C9.43554307,4.6718734 8.75586236,4.51171875 8.15820312,4.51171875 C7.70507586,4.51171875 7.3613293,4.61035058 7.12695312,4.80761719 C6.89257695,5.0048838 6.77539062,5.26562338 6.77539062,5.58984375 C6.77539062,5.81250111 6.82226516,6.0029289 6.91601562,6.16113281 C7.00976609,6.31933673 7.16406143,6.4687493 7.37890625,6.609375 C7.59375107,6.7500007 7.98046596,6.93554572 8.5390625,7.16601562 C9.16797189,7.42773568 9.62890479,7.67187387 9.921875,7.8984375 C10.2148452,8.12500113 10.4296868,8.38085795 10.5664062,8.66601562 C10.7031257,8.9511733 10.7714844,9.28710744 10.7714844,9.67382812 Z";else if(type===this.PATH_ICON_R)pathString="M6.69628906,7.41796875 L7.66894531,7.41796875 C8.32129232,7.41796875 8.79394385,7.29687621 9.08691406,7.0546875 C9.37988428,6.81249879 9.52636719,6.45312738 9.52636719,5.9765625 C9.52636719,5.49218508 9.36816564,5.1445323 9.05175781,4.93359375 C8.73534998,4.7226552 8.25879225,4.6171875 7.62207031,4.6171875 L6.69628906,4.6171875 L6.69628906,7.41796875 Z M6.69628906,8.578125 L6.69628906,12 L5.29589844,12 L5.29589844,3.43359375 L7.71582031,3.43359375 C8.82129459,3.43359375 9.63964578,3.64062293 10.1708984,4.0546875 C10.7021511,4.46875207 10.9677734,5.09374582 10.9677734,5.9296875 C10.9677734,6.99609908 10.4130915,7.75585711 9.30371094,8.20898438 L11.7236328,12 L10.1298828,12 L8.07910156,8.578125 L6.69628906,8.578125 Z";else if(type===this.PATH_ICON_A)pathString="M 38.377731,174.01215 C 35.60517,166.78697 83.982558,31.347104 90.186163,28.966558 c 9.17399,-3.520391 34.445027,-1.985885 37.219977,2.260069 1.50409,2.301405 13.60523,34.625348 26.89141,71.830983 17.16544,48.06879 23.16002,68.86949 20.71287,71.87197 -1.89412,2.32394 -9.15585,4.22535 -16.13718,4.22535 -14.31403,0 -17.64917,-3.01456 -23.53041,-21.26861 l -4.12977,-12.81791 -24.06916,0.98692 -24.06915,0.98692 -5.024627,13.52113 c -2.763542,7.43662 -6.624375,14.63868 -8.579624,16.00458 -6.714132,4.69035 -29.015609,2.85718 -31.092768,-2.55581 z m 80.762679,-64.42016 c 2.11257,-2.11257 -6.86168,-31.726727 -11.01187,-36.338108 -2.45868,-2.731896 -13.480652,24.925664 -13.480652,33.827148 0,4.46205 20.445382,6.5581 24.492522,2.51096 z";else{if(type!==this.PATH_ICON_B)throw Error("Unknow path icon type!");pathString="M 55.597674,174.84223 C 54.687458,172.47025 54.354917,138.62518 54.85869,99.630964 l 0.915958,-70.898569 27.042254,-1.095842 c 33.625178,-1.362603 59.268848,3.943797 68.971918,14.272237 11.20739,11.929724 12.78369,29.658818 3.96576,44.604099 l -7.33675,12.434859 7.76292,8.263242 c 6.10141,6.49466 7.76291,12.13662 7.76291,26.36051 0,15.4247 -1.4692,19.63077 -9.94869,28.48146 -5.47178,5.7113 -15.3591,11.88721 -21.97183,13.72423 -18.19024,5.05327 -74.391405,4.36572 -76.425466,-0.93496 z m 67.541156,-34.80199 c 12.30829,-12.30828 1.34552,-25.97054 -19.61067,-24.43965 -12.517573,0.91444 -14.063403,2.0034 -15.047846,10.60045 -0.603431,5.26972 -0.270896,11.73451 0.738984,14.36619 2.545359,6.63311 27.141582,6.25097 33.919532,-0.52699 z M 121.9253,79.153275 c 7.55903,-9.108081 -0.33083,-16.618063 -17.45868,-16.618063 -15.216781,0 -19.852206,5.186819 -15.281125,17.098861 2.607742,6.795667 26.998135,6.437486 32.739805,-0.480798 z"}return parseGeometry(pathString)};CCompLabel.getDrillDownActionIconBackground=function(){return parseGeometry("M70 15.018 65 15.018 65 10C65 7.239 62.761 5 60 5L10 5C7.239 5 5 7.239 5 10L5 50C5 52.761 7.239 55 10 55L60 55 60 55.018 68.662 55.018C66.933 58.007 63.701 60.018 60 60.018L10 60.018C4.477 60.018 0 55.541 0 50.018L0 10.018C0 4.496 4.477 0 10 0L60 0C65.523 0 70 4.496 70 10.018L70 15.018Z")};CCompLabel.getDrillDownActionIcon=function(){return parseGeometry("M43.308 51.982C44.974 51.982 53.538 44.799 69 30.434 53.458 15.997 44.894 8.778 43.308 8.778 40.93 8.778 42.795 21.98 41.514 21.98 40.935 21.98 30.863 21.906 19.685 17.086 5.768 11.084 7.739 3.255 6.682 2.313 5.978 1.685 5.084 1.949 4 3.104 4.585 13.008 8.107 21.458 14.565 28.455 21.022 35.451 30.106 38.786 41.815 38.459 41.145 47.474 41.643 51.982 43.308 51.982Z")};CCompLabel.getDrillDownIcon=function(){return parseGeometry("M4.618 4.997l5.85.93-2.693 1.165 2.73 2.59-1.233 1.241L6.64 8.196l-1.121 2.68z")};CCompLabel.DRILL_DOWN_CIRCLE_STROKE_COLOR="#A6CCEA";CCompLabel.DRILL_DOWN_ARROW_FILL_COLOR="#1E1D1D";CCompLabel.DRILL_DOWN_ICON_INFO={default:"img/modules/qmap/icon-nb-drilldown.png",mouseOver:"img/modules/qmap/icon-nb-drilldown-hover.png"};function parseGeometry(svgStr){var iconString=go.Geometry.parse(go.Geometry.fillPath(svgStr));iconString.normalize();return iconString}CCompLabel.showLabelIcon=function(){};CCompLabel.EVENT_NAMES={DEVICE_LABEL_PANEL_CLICK:"COMP_LABEL_DEVICE_LABEL_PANEL_CLICK",DEVICE_LABEL_PANEL_MOUSE_ENTER:"COMP_LABEL_DEVICE_LABEL_PANEL_MOUSE_ENTER",DEVICE_LABEL_PANEL_MOUSE_LEAVE:"COMP_LABEL_DEVICE_LABEL_PANEL_MOUSE_LEAVE",DEVICE_DRILL_DOWN_ICON_CLICK:"COMP_LABEL_DEVICE_DRILL_DOWN_ICON_CLICK",DEVICE_EDIT_DATA_UNIT_ICON_CLICK:"COMP_LABEL_DEVICE_EDIT_DATA_UNIT_ICON_CLICK",LINK_PANEL_MOUSE_ENTER:"COMP_LABEL_LINK_PANEL_MOUSE_ENTER",LINK_PANEL_MOUSE_LEAVE:"COMP_LABEL_LINK_PANEL_MOUSE_LEAVE",LINK_LABEL_ICON_PANEL_CLICK:"COMP_LABEL_LINK_LABEL_ICON_PANEL_CLICK",LINK_LABEL_ICON_PANEL_MOUSE_ENTER:"COMP_LABEL_LINK_LABEL_ICON_PANEL_MOUSE_ENTER",LINK_LABEL_ICON_PANEL_MOUSE_LEAVE:"COMP_LABEL_LINK_LABEL_ICON_PANEL_MOUSE_LEAVE",LINK_TEXT_CLICK:"COMP_LABEL_LINK_TEXT_CLICK",LINK_TEXT_MOUSE_ENTER:"COMP_LABEL_LINK_TEXT_MOUSE_ENTER",LINK_TEXT_MOUSE_LEAVE:"COMP_LABEL_LINK_TEXT_MOUSE_LEAVE",LINK_ALARM_LABEL_CLICK:"COMP_LABEL_LINK_ALARM_LABEL_CLICK",LINK_ALARM_LABEL_MOUSE_ENTER:"COMP_LABEL_LINK_ALARM_LABEL_MOUSE_ENTER",LINK_ALARM_LABEL_MOUSE_LEAVE:"COMP_LABEL_LINK_ALARM_LABEL_MOUSE_LEAVE",LINK_DRILL_DOWN_ICON_CLICK:"COMP_LABEL_LINK_DRILL_DOWN_ICON_CLICK",LINK_EDIT_DATA_UNIT_ICON_CLICK:"COMP_LABEL_LINK_EDIT_DATA_UNIT_ICON_CLICK"};CCompLabel.linkPosTextPanel="linkPosTextPanel";CCompLabel.drillDownIconPicture="drillDownIconPicture";CCompLabel.drillDownActionIconBackground="drillDownActionIconBackground";CCompLabel.drillDownActionIcon="drillDownActionIcon";CCompLabel.drillDownActionIconColors={default:{background:"#979696",arrow:"#FC7E01"},hover:{background:"#70AEF9",arrow:"#2485F9"}};CCompLabel.ENABLE_DATA_UNIT_EDIT=!0;CCompLabel.getDeviceLabelTemplate=function(map,scope,isL2Device){var $=go.GraphObject.make;return $(go.Panel,"Horizontal",{visible:!0,margin:new go.Margin(3,0,0,0),alignment:go.Spot.Center,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.DEVICE_LABEL_PANEL_CLICK,event,target)},mouseEnter:function(event,target){if(null!==target.diagram&&!target.diagram.isReadOnly){if(CCompLabel.ENABLE_DATA_UNIT_EDIT){var labelName=netBrain.Map.CompDevice.devPosInfoLabel;target.findObject(labelName).text&&(target.findObject("editLabelIcon").opacity=1)}scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.DEVICE_LABEL_PANEL_MOUSE_ENTER,event,target)}},mouseLeave:function(event,target){if(null!==target.diagram&&!target.diagram.isReadOnly){CCompLabel.ENABLE_DATA_UNIT_EDIT&&(target.findObject("editLabelIcon").opacity=0);scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.DEVICE_LABEL_PANEL_MOUSE_LEAVE,event,target)}}},new go.Binding("visible","posInfo",BindHelper.toTarget_device_visible),new go.Binding("visible","extraData",BindHelper.toTarget_device_extraData_visible),new go.Binding("cursor","posInfo",BindHelper.toTarget_device_label_cursor),$(go.Panel,"Auto",new go.Binding("background","extraData",BindHelper.toTarget_label_overflow_bgColor),$(go.Shape,{height:12,opacity:0,visible:!1},new go.Binding("visible","posName",(function(posName,node){return posName===DataViewPosName.overflowPos}))),$(go.Shape,{name:"labelIcon",fill:"#7AABDE",margin:new go.Margin(0,0,0,15),strokeWidth:0,background:"transparent"},new go.Binding("geometry","posInfo",CCompLabel.getLabelIconDataUnit),new go.Binding("geometry","posName",CCompLabel.getLabelIconOverflow),new go.Binding("fill","posInfo",BindHelper.toTarget_label_dataunit_icon_fillColor),new go.Binding("fill","extraData",BindHelper.toTarget_label_overflow_fillColor),new go.Binding("height","posName",(function(posName){return posName===DataViewPosName.overflowPos?5:10})),new go.Binding("height","posInfo",BindHelper.toTarget_label_icon_height),new go.Binding("width","posName",(function(posName){return posName===DataViewPosName.overflowPos?20:10})),new go.Binding("width","posInfo",BindHelper.toTarget_label_icon_width),new go.Binding("visible","geometry",(function(svgString){return null!=svgString})).ofObject("labelIcon"),new go.Binding("margin","posName",(function(posName,node){var part=node.part;return posName===DataViewPosName.overflowPos&&part&&part instanceof netBrain.Map.CompL3Device?new go.Margin(0,3,0,3):new go.Margin(0,0,0,15)})))),$(go.TextBlock,{name:netBrain.Map.CompDevice.devPosInfoLabel,background:"white",font:BindHelper.defaultPosLableFont,isMultiline:!1,position:new go.Point(0,0),stroke:"black"},new go.Binding("visible","posInfo",BindHelper.getLabelVisibleFromPosInfoDefaultTrue),new go.Binding("text","posInfo",BindHelper.toTarget_device_posText).makeTwoWay((function(v,labelData){labelData.posInfo.displayInfo=v;return labelData.posInfo})),new go.Binding("visible","text",(function(v,node){return""!==v})).ofObject(netBrain.Map.CompDevice.devPosInfoLabel),new go.Binding("text","text",(function(v,node){null!=node.part.calcBounds&&node.part.calcBounds();return v})).ofObject(netBrain.Map.CompDevice.devPosInfoLabel),new go.Binding("isMultiline","text",(function(v){return-1!==v.indexOf("\n")})).ofObject(netBrain.Map.CompDevice.devPosInfoLabel),new go.Binding("isUnderline","posInfo",BindHelper.toTarget_label_underline),new go.Binding("stroke","posInfo",BindHelper.toTarget_device_posStrokeDataUnitType),new go.Binding("stroke","labelGraphicInfo",BindHelper.toTarget_device_posStrokeGraphicInfo),new go.Binding("background","labelGraphicInfo",BindHelper.toTarget_device_posBackground),new go.Binding("background","posInfo",BindHelper.toTarget_device_label_backcolor),new go.Binding("background","dataUnitInfo",BindHelper.toTarget_device_label_dataUnitInfo_backcolor),new go.Binding("font","labelGraphicInfo",BindHelper.toTarget_device_posFont),new go.Binding("margin","posName",(function(v,node){var flag;var panelData=node.panel.data;node.part.data.getDataViewInfo(panelData.dataViewId);flag=isPosEditIconVisble(scope,panelData);var labelIconFlag=!1;var labelIcon=node.panel.findObject("labelIcon");labelIcon&&(labelIconFlag=labelIcon.visible);var drillDownIconFlag=!1;var drillDownIcon=node.panel.findObject("drillDownIcon");drillDownIcon&&(drillDownIconFlag=drillDownIcon.visible);var isL2Device=node.part instanceof netBrain.Map.CompL2Device;return flag?new go.Margin(0,0,0,labelIconFlag||isL2Device?10:15):new go.Margin(0,drillDownIconFlag?0:15,0,labelIconFlag||isL2Device?10:15)}))),CCompLabel.getDrillDownIconPanel(scope,CCompLabel.EVENT_NAMES.DEVICE_DRILL_DOWN_ICON_CLICK),CCompLabel.getEditDataUnitIconPanel(scope,CCompLabel.EVENT_NAMES.DEVICE_EDIT_DATA_UNIT_ICON_CLICK),$(go.Panel,"Auto",{visible:!1,alignment:go.Spot.Center},new go.Binding("visible","posInfo",BindHelper.getLabelVisibleFromPosInfoDefaultFalse),$(go.Shape,{name:netBrain.Map.CompDevice.alarmLabel,strokeWidth:1,fill:"pink",margin:new go.Margin(0,15,0,15),desiredSize:new go.Size(18,13)},new go.Binding("fill","posInfo",BindHelper.getAlarmLabelColor))))};CCompLabel.getLinkLabelTemplate=function(normalLinkTemplateOption,scope){var $=go.GraphObject.make;return $(go.Panel,"Position",{mouseEnter:function(event,target){if(null!==target.diagram&&!target.diagram.isReadOnly){if(CCompLabel.ENABLE_DATA_UNIT_EDIT){var labelName=netBrain.Map.CompTopolink.linkPosInfoLabel;if(target.findObject(labelName).text){if(target.data.posInfo.dataUnitList[0].valueType===DataUnitType.uCompoundVar)return;target.findObject("editLabelIcon").opacity=1}}scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_PANEL_MOUSE_ENTER,event,target)}},mouseLeave:function(event,target){if(null!==target.diagram&&!target.diagram.isReadOnly){CCompLabel.ENABLE_DATA_UNIT_EDIT&&(target.findObject("editLabelIcon").opacity=0);scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_PANEL_MOUSE_LEAVE,event,target)}}},new go.Binding("visible","posInfo",BindHelper.toTarget_device_visible),new go.Binding("visible","extraData",BindHelper.toTarget_device_extraData_visible),new go.Binding("cursor","posInfo",BindHelper.toTarget_link_label_cursor),$(go.Panel,"Auto",{name:CCompLabel.linkPosTextPanel,position:new go.Point(0,0)},$(go.Panel,"Horizontal",$(go.Panel,"Auto",{position:new go.Point(-16,-2),click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_LABEL_ICON_PANEL_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_LABEL_ICON_PANEL_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_LABEL_ICON_PANEL_MOUSE_LEAVE,event,target)}},new go.Binding("background","extraData",BindHelper.toTarget_label_overflow_bgColor),$(go.Shape,{height:12,opacity:0,visible:!1},new go.Binding("visible","posName",(function(posName,node){return posName===DataViewPosName.overflowPos}))),$(go.Shape,{name:"labelIcon",fill:"#7AABDE",margin:new go.Margin(0,4,0,4),strokeWidth:0,cursor:"pointer",position:new go.Point(0,0)},new go.Binding("geometry","posInfo",CCompLabel.getLabelIconDataUnit),new go.Binding("geometry","posName",CCompLabel.getLabelIconOverflow),new go.Binding("fill","posInfo",BindHelper.toTarget_label_dataunit_icon_fillColor),new go.Binding("fill","extraData",BindHelper.toTarget_label_overflow_fillColor),new go.Binding("height","posName",(function(posName){return posName===DataViewPosName.overflowPos?5:10})),new go.Binding("height","posInfo",BindHelper.toTarget_label_icon_height),new go.Binding("width","posName",(function(posName){return posName===DataViewPosName.overflowPos?20:10})),new go.Binding("width","posInfo",BindHelper.toTarget_label_icon_width)),new go.Binding("visible","geometry",(function(svgString){return null!=svgString})).ofObject("labelIcon")),$(go.TextBlock,{name:netBrain.Map.CompTopolink.linkPosInfoLabel,isMultiline:!1,background:"white",editable:!1,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_TEXT_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_TEXT_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_TEXT_MOUSE_LEAVE,event,target)},font:BindHelper.defaultPosLableFont,margin:new go.Margin(0,3,0,3),position:new go.Point(0,0)},new go.Binding("visible","posInfo",BindHelper.getLabelVisibleFromPosInfoDefaultTrue),new go.Binding("text","posInfo",BindHelper.toTarget_device_posText).makeTwoWay((function(v,labelData){labelData.posInfo.displayInfo=v;return labelData.posInfo})),new go.Binding("text","text",(function(v,node){return v})).ofObject(netBrain.Map.CompTopolink.linkPosInfoLabel),new go.Binding("opacity","text",(function(v,data){return""!==v?1:0})).ofObject(netBrain.Map.CompTopolink.linkPosInfoLabel),new go.Binding("isUnderline","posInfo",BindHelper.toTarget_label_underline),new go.Binding("stroke","posInfo",BindHelper.toTarget_device_posStrokeDataUnitType),new go.Binding("stroke","labelGraphicInfo",BindHelper.toTarget_device_posStrokeGraphicInfo),new go.Binding("background","labelGraphicInfo",BindHelper.toTarget_device_posBackground),new go.Binding("background","posInfo",BindHelper.toTarget_device_label_backcolor),new go.Binding("background","dataUnitInfo",BindHelper.toTarget_device_label_dataUnitInfo_backcolor),new go.Binding("font","labelGraphicInfo",BindHelper.toTarget_device_posFont)),CCompLabel.getDrillDownIconPanel(scope,CCompLabel.EVENT_NAMES.LINK_DRILL_DOWN_ICON_CLICK),CCompLabel.getEditDataUnitIconPanel(scope,CCompLabel.EVENT_NAMES.LINK_EDIT_DATA_UNIT_ICON_CLICK),$(go.Panel,"Auto",{visible:!1,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_ALARM_LABEL_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_ALARM_LABEL_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CCompLabel.EVENT_NAMES.LINK_ALARM_LABEL_MOUSE_LEAVE,event,target)}},new go.Binding("visible","posInfo",BindHelper.getLabelVisibleFromPosInfoDefaultFalse),$(go.Shape,{name:netBrain.Map.CompTopolink.alarmLabel,strokeWidth:1,fill:"pink",desiredSize:new go.Size(18,13)},new go.Binding("fill","posInfo",BindHelper.getAlarmLabelColor))))))};CCompLabel.getDrillDownIconPanel=function(scope,eventName){var $=go.GraphObject.make;return $(go.Panel,"Position",{name:"drillDownIcon",visible:!1,background:"white",cursor:"pointer",margin:new go.Margin(0,0,0,4),click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(eventName,event,target)},mouseEnter:function(event,target){var colors=CCompLabel.drillDownActionIconColors.hover;target.findObject(CCompLabel.drillDownActionIconBackground).fill=colors.background;target.findObject(CCompLabel.drillDownActionIcon).fill=colors.arrow},mouseLeave:function(event,target){var colors=CCompLabel.drillDownActionIconColors.default;target.findObject(CCompLabel.drillDownActionIconBackground).fill=colors.background;target.findObject(CCompLabel.drillDownActionIcon).fill=colors.arrow}},new go.Binding("visible","posInfo",BindHelper.toTarget_label_drillDown_icon_visible),$(go.Shape,{name:CCompLabel.drillDownActionIconBackground,fill:CCompLabel.drillDownActionIconColors.default.background,width:10,height:8,geometry:CCompLabel.getDrillDownActionIconBackground(),strokeWidth:0}),$(go.Shape,{name:CCompLabel.drillDownActionIcon,fill:CCompLabel.drillDownActionIconColors.default.arrow,width:10,height:8,position:new go.Point(5,1),geometry:CCompLabel.getDrillDownActionIcon(),strokeWidth:0}))};CCompLabel.getEditDataUnitIconPanel=function(scope,eventName){var $=go.GraphObject.make;return $(go.Panel,"Auto",{name:"editLabelIcon",visible:!0,background:"white",opacity:0,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(eventName,event,target)}},new go.Binding("visible","data",(function(v,node){return isPosEditIconVisble(scope,v)})).ofObject(),$(go.Shape,{fill:"#0D2798",margin:new go.Margin(0,0,0,4),geometry:CCompLabel.getEditLabelIcon(),strokeWidth:0},new go.Binding("height","posName",(function(posName){return posName===DataViewPosName.overflowPos?5:12})),new go.Binding("width","posName",(function(posName){return posName===DataViewPosName.overflowPos?15:12}))))};CCompLabel.getDeviceLabelVisioInfos=function(posObj){var infos=[];if(!posObj.visible)return infos;var labelIconObj=posObj.findObject("labelIcon");if(labelIconObj.visible&&labelIconObj.panel.visible&&labelIconObj.geometry){var labelIconInfo=netBrain.Map.visioTools.getShapeInfo(labelIconObj);infos.push(labelIconInfo)}if(posObj.data.posName!==DataViewPosName.overflowPos){var labelObj=posObj.findObject(netBrain.Map.CompDevice.devPosInfoLabel);if(labelObj.visible){var labelInfo=netBrain.Map.visioTools.getTextInfo(labelObj);infos.push(labelInfo)}var drillDownIconInfo=CCompLabel.getDrillDownIconVisioInfo(posObj);drillDownIconInfo&&infos.push(drillDownIconInfo)}return infos};CCompLabel.getLinkLabelVisioInfos=function(posObj){var infos=[];if(!posObj.visible)return infos;var labelIconObj=posObj.findObject("labelIcon");if(labelIconObj.visible&&labelIconObj.panel.visible&&labelIconObj.geometry){var labelIconInfo=netBrain.Map.visioTools.getShapeInfo(labelIconObj);infos.push(labelIconInfo)}if(posObj.data.posName!==DataViewPosName.overflowPos){var labelObj=posObj.findObject(netBrain.Map.CompTopolink.linkPosInfoLabel);var labelInfo=netBrain.Map.visioTools.getTextInfo(labelObj);infos.push(labelInfo);var drillDownIconInfo=CCompLabel.getDrillDownIconVisioInfo(posObj);drillDownIconInfo&&infos.push(drillDownIconInfo)}return infos};CCompLabel.getDrillDownIconVisioInfo=function(posObj){var picObj=posObj.findObject(CCompLabel.drillDownActionIcon);return netBrain.Map.visioTools.getShapeInfo(picObj,!0)};function isPosEditIconVisble(scope,posData){var flag=!!scope.isEditMode()&&posData.posName!==DataViewPosName.overflowPos;if(flag){var duType=NgUtil.getValueFromObjAndPath(posData,"posInfo.dataUnitList.0.valueType");flag=DataUnitTypeHelper.canEditDataUnit(duType)}return flag}netBrain.Map=netBrain.Map||{};netBrain.Map.CCompLabel=CCompLabel}(NetBrain);!function(netBrain){function CLinkLine(){netBrain.Map.CompBase.call(this);this.category=netBrain.Map.CategoryMgr.TopoLink}CLinkLine.prototype=new netBrain.Map.CompBase;CLinkLine.prototype.getVisible=function(){return this.visible};CLinkLine.prototype.setVisible=function(obj){this.visible=obj};CLinkLine.prototype.getOpacity=function(){return this.opacity};CLinkLine.prototype.setOpacity=function(obj){this.opacity=obj};CLinkLine.prototype.getShadowed=function(){return this.isShadowed};CLinkLine.prototype.setShadowed=function(obj){this.isShadowed=obj};CLinkLine.prototype.getFromKey=function(){return this.from};CLinkLine.prototype.setFromKey=function(obj){this.from=obj};CLinkLine.prototype.getToKey=function(){return this.to};CLinkLine.prototype.setToKey=function(obj){this.to=obj};CLinkLine.prototype.setIntfGraphicInfoPropsSrc=function(color,width){var newColor=void 0===color?null:color;var newWidth=void 0===width?null:width;if(this.intfSrc)if(this.intfSrc.intfInfo)if(this.intfSrc.intfInfo.intfGraphicInfo){this.intfSrc.intfInfo.intfGraphicInfo.color=color;this.intfSrc.intfInfo.intfGraphicInfo.width=width}else this.intfSrc.intfInfo.intfGraphicInfo={color:newColor,width:newWidth};else this.intfSrc.intfInfo={intfGraphicInfo:{color:newColor,width:newWidth}};else this.intfSrc={intfInfo:{intfGraphicInfo:{color:newColor,width:newWidth}}}};CLinkLine.prototype.setIntfGraphicInfoPropsDest=function(color,width){var newColor=void 0===color?null:color;var newWidth=void 0===width?null:width;if(this.intfDest)if(this.intfDest.intfInfo)if(this.intfDest.intfInfo.intfGraphicInfo){this.intfDest.intfInfo.intfGraphicInfo.color=color;this.intfDest.intfInfo.intfGraphicInfo.width=width}else this.intfDest.intfInfo.intfGraphicInfo={color:newColor,width:newWidth};else this.intfDest.intfInfo={intfGraphicInfo:{color:newColor,width:newWidth}};else this.intfDest={intfInfo:{intfGraphicInfo:{color:newColor,width:newWidth}}}};CLinkLine.prototype.getGraphicInfoSrc=function(){return this.intfSrc&&this.intfSrc.intfInfo&&this.intfSrc.intfInfo.intfGraphicInfo?this.intfSrc.intfInfo.intfGraphicInfo:null};CLinkLine.prototype.setGraphicInfoSrc=function(obj){_.isObject(obj)&&(this.intfSrc?this.intfSrc.intfInfo?this.intfSrc.intfInfo.intfGraphicInfo=obj:this.intfSrc.intfInfo={intfGraphicInfo:obj}:this.intfSrc={intfInfo:{intfGraphicInfo:obj}})};CLinkLine.prototype.getGraphicInfoDest=function(){return this.intfDest&&this.intfDest.intfInfo&&this.intfDest.intfInfo.intfGraphicInfo?this.intfDest.intfInfo.intfGraphicInfo:null};CLinkLine.prototype.setGraphicInfoDest=function(obj){_.isObject(obj)&&(this.intfDest?this.intfDest.intfInfo?this.intfDest.intfInfo.intfGraphicInfo=obj:this.intfDest.intfInfo={intfGraphicInfo:obj}:this.intfDest={intfInfo:{intfGraphicInfo:obj}})};CLinkLine.prototype.getIntfKeyObjSrc=function(){return null==this.intfSrc?null:null==this.intfSrc.intfInfo?null:null==this.intfSrc.intfInfo.intf?null:this.intfSrc.intfInfo.intf.intfKeyObj};CLinkLine.prototype.getIntfKeyObjDest=function(){return null==this.intfDest?null:null==this.intfDest.intfInfo?null:null==this.intfDest.intfInfo.intf?null:this.intfDest.intfInfo.intf.intfKeyObj};CLinkLine.prototype.getIntfValueSrc=function(){return null==this.intfSrc?null:null==this.intfSrc.intfInfo?null:null==this.intfSrc.intfInfo.intf?this.intfSrc.intfInfo.intfKeyObj?this.intfSrc.intfInfo.intfKeyObj.value:null:null==this.intfSrc.intfInfo.intf.intfKeyObj?null:this.intfSrc.intfInfo.intf.intfKeyObj.value};CLinkLine.prototype.getIntfValueDest=function(){return null==this.intfDest?null:null==this.intfDest.intfInfo?null:null==this.intfDest.intfInfo.intf?this.intfDest.intfInfo.intfKeyObj?this.intfDest.intfInfo.intfKeyObj.value:null:null==this.intfDest.intfInfo.intf.intfKeyObj?null:this.intfDest.intfInfo.intf.intfKeyObj.value};CLinkLine.prototype.getIntfSrc=function(){return this.intfSrc};CLinkLine.prototype.getIntfVSNodeIdentifySrc=function(){var nodeData=this.getIntfNodeDataSrc();return nodeData?{id:nodeData.id,nodeIdentify:nodeData.nodeIdentify,visualSpaceInfo:nodeData.visualSpaceInfo}:null};CLinkLine.prototype.getIntfNodeDataSrc=function(){return null==this.intfSrc?null:null==this.intfSrc.intfInfo?null:null==this.intfSrc.intfInfo.intf?null:this.intfSrc.intfInfo.intf.intfNodeData};CLinkLine.prototype.setIntfSrc=function(obj){this.intfSrc=obj;this.fromPort=this.getIntfValueSrc()||""};CLinkLine.prototype.getSrcIntfSMode=function(){return null==this.intfSrc?null:null==this.intfSrc.intfInfo?null:null==this.intfSrc.intfInfo.intf?null:this.intfSrc.intfInfo.intf.mode};CLinkLine.prototype.getDestIntfMode=function(){return null==this.intfDest?null:null==this.intfDest.intfInfo?null:null==this.intfDest.intfInfo.intf?null:this.intfDest.intfInfo.intf.mode};CLinkLine.prototype.getSrcIntfVpc=function(){return null==this.intfSrc?null:null==this.intfSrc.intfInfo?null:null==this.intfSrc.intfInfo.intf?null:this.intfSrc.intfInfo.intf.vpc};CLinkLine.prototype.getDestIntfVpc=function(){return null==this.intfDest?null:null==this.intfDest.intfInfo?null:null==this.intfDest.intfInfo.intf?null:this.intfDest.intfInfo.intf.vpc};CLinkLine.prototype.getIntfDest=function(){return this.intfDest};CLinkLine.prototype.getIntfVSNodeIdentifyDest=function(){var nodeData=this.getIntfNodeDataDest();return nodeData?{id:nodeData.id,nodeIdentify:nodeData.nodeIdentify,visualSpaceInfo:nodeData.visualSpaceInfo}:null};CLinkLine.prototype.getIntfNodeDataDest=function(){return null==this.intfDest?null:null==this.intfDest.intfInfo?null:null==this.intfDest.intfInfo.intf?null:this.intfDest.intfInfo.intf.intfNodeData};CLinkLine.prototype.setIntfDest=function(obj){this.intfDest=obj;this.toPort=this.getIntfValueDest()||""};CLinkLine.prototype.getIntfInfoSrc=function(){return this.intfSrc&&this.intfSrc.intfInfo?this.intfSrc.intfInfo:null};CLinkLine.prototype.getIntfInfoDest=function(){return this.intfDest&&this.intfDest.intfInfo?this.intfDest.intfInfo:null};CLinkLine.prototype.setIntfInfoSrc=function(obj){if(_.isObject(obj))if(this.intfSrc)if(this.intfSrc.intfInfo&&this.intfSrc.intfInfo.intf){var oldIntf=angular.copy(this.intfSrc.intfInfo.intf);this.intfSrc.intfInfo=obj;this.intfSrc.intfInfo=obj;_.extend(oldIntf,obj.intf);this.intfSrc.intfInfo.intf=oldIntf}else this.intfSrc.intfInfo=obj;else this.intfSrc={intfInfo:obj}};CLinkLine.prototype.setIntfInfoDest=function(obj){if(_.isObject(obj))if(this.intfDest)if(this.intfDest.intfInfo&&this.intfDest.intfInfo.intf){var oldIntf=angular.copy(this.intfDest.intfInfo.intf);this.intfDest.intfInfo=obj;this.intfDest.intfInfo=obj;_.extend(oldIntf,obj.intf);this.intfDest.intfInfo.intf=oldIntf}else this.intfDest.intfInfo=obj;else this.intfDest={intfInfo:obj}};CLinkLine.prototype.getIntfPosListSrc=function(index){return this.intfSrc&&this.intfSrc.intfInfo&&this.intfSrc.intfInfo.intfPosList?_.isArray(this.intfSrc.intfInfo.intfPosList)?void 0===index?this.intfSrc.intfInfo.intfPosList:index>this.intfSrc.intfInfo.intfPosList.length?this.intfSrc.intfInfo.intfPosList[this.intfSrc.intfInfo.intfPosList.length-1]:this.intfSrc.intfInfo.intfPosList[index]:this.intfSrc.intfInfo.intfPosList:null};CLinkLine.prototype.getIntfPosListDest=function(index){return this.intfDest&&this.intfDest.intfInfo&&this.intfDest.intfInfo.intfPosList?_.isArray(this.intfDest.intfInfo.intfPosList)?void 0===index?this.intfDest.intfInfo.intfPosList:index>this.intfDest.intfInfo.intfPosList.length?this.intfDest.intfInfo.intfPosList[this.intfDest.intfInfo.intfPosList.length-1]:this.intfDest.intfInfo.intfPosList[index]:this.intfDest.intfInfo.intfPosList:null};CLinkLine.prototype.setIntfPosListSrc=function(obj){_.isArray(obj)&&(this.intfSrc?this.intfSrc.intfInfo?this.intfSrc.intfInfo.intfPosList=obj:this.intfSrc.intfInfo={intfPosList:obj}:this.intfSrc={intfInfo:{intfPosList:obj}})};CLinkLine.prototype.setIntfPosListDest=function(obj){_.isArray(obj)&&(this.intfDest?this.intfDest.intfInfo?this.intfDest.intfInfo.intfPosList=obj:this.intfDest.intfInfo={intfPosList:obj}:this.intfDest={intfInfo:{intfPosList:obj}})};CLinkLine.prototype.getTopoType=function(){return this.topoType};CLinkLine.prototype.setTopoType=function(obj){this.topoType=obj};CLinkLine.prototype.getIsP2P=function(){return this.isP2P};CLinkLine.prototype.setIsP2P=function(obj){this.isP2P=obj};CLinkLine.prototype.getJsData=function(){return this};CLinkLine.prototype.getMedia=function(){return this.mediaId};CLinkLine.prototype.setMedia=function(obj){this.mediaId=obj};CLinkLine.prototype.getIsPortChannel=function(){return this.isPortChannel};CLinkLine.prototype.setIsPortChannel=function(obj){this.isPortChannel=obj};CLinkLine.prototype.setL2TopoLinkMode=function(key){this.l2TopoLinkMode=key};CLinkLine.prototype.getL2TopoLinkMode=function(){return this.l2TopoLinkMode};CLinkLine.prototype.getViewInfosSrc=function(){return this.intfSrc?this.intfSrc.dataViewInfos||this.intfSrc.dataViewInfo:null};CLinkLine.prototype.getViewInfoSrc=function(dataViewId){var result=null;if(this.intfSrc)if(dataViewId&&this.intfSrc.dataViewInfos){result=_.find(this.intfSrc.dataViewInfos,(function(item){return item.dataViewGroupId===dataViewId}))}else this.intfSrc.dataViewInfo&&(result=this.intfSrc.dataViewInfo);return result};CLinkLine.prototype.setViewInfosSrc=function(obj){if(_.isObject(obj)){this.intfSrc=this.intfSrc||{};if(_.isArray(obj))this.intfSrc.dataViewInfos=obj;else{this.intfSrc.dataViewInfo=obj;delete this.intfSrc.dataViewInfos}}};CLinkLine.prototype.getDataViewInfoProp=function(dataViewId,propName,isDest){var result=null;var dataViewInfo=isDest?this.getViewInfoDest(dataViewId):this.getViewInfoSrc(dataViewId);dataViewInfo&&(result=dataViewInfo[propName]);if(!result){var dataViewInfos=isDest?this.getViewInfosDest():this.getViewInfosSrc();_.isArray(dataViewInfos)&&dataViewInfos.length>0&&(result=dataViewInfos[0][propName])}return result};CLinkLine.prototype.getViewInfosDest=function(){return this.intfDest?this.intfDest.dataViewInfos||this.intfDest.dataViewInfo:null};CLinkLine.prototype.getViewInfoDest=function(dataViewId){var result=null;if(this.intfDest)if(dataViewId&&this.intfDest.dataViewInfos){result=_.find(this.intfDest.dataViewInfos,(function(item){return item.dataViewGroupId===dataViewId}))}else!dataViewId&&this.intfDest.dataViewInfos?result=this.intfDest.dataViewInfos:this.intfDest.dataViewInfo&&(result=this.intfDest.dataViewInfo);return result};CLinkLine.prototype.setViewInfosDest=function(obj){if(_.isObject(obj)){this.intfDest=this.intfDest||{};if(_.isArray(obj))this.intfDest.dataViewInfos=obj;else{this.intfDest.dataViewInfo=obj;delete this.intfDest.dataViewInfos}}};CLinkLine.prototype.getDataViewGroupIdSrc=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewGroupId",!1)};CLinkLine.prototype.getDataViewGroupIdDest=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewGroupId",!0)};CLinkLine.prototype.isInDataViewGroupIds=function(dataViewId,isDest){var flag=!1;var dataViewInfos=isDest?this.getViewInfoDest():this.getViewInfosSrc();if(dataViewInfos)if(_.isArray(dataViewInfos)){flag=-1!==_.findIndex(dataViewInfos,{dataViewGroupId:dataViewId})}else flag=dataViewInfos.dataViewGroupId===dataViewId;return flag};CLinkLine.prototype.isDefaultDataView=function(isDest){var flag=!1;var dataViewInfos=isDest?this.getViewInfosDest():this.getViewInfosSrc();dataViewInfos?_.isArray(dataViewInfos)&&1===dataViewInfos.length&&dataViewInfos[0].dataViewType===DataViewType.dvDefault?flag=!0:dataViewInfos.dataViewType===DataViewType.dvDefault&&(flag=!0):flag=!0;return flag};CLinkLine.prototype.getDataViewTypeSrc=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewType",!1)};CLinkLine.prototype.getDataViewTypeDest=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewType",!0)};CLinkLine.prototype.getDVIDSrc=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewGroupId",!1)};CLinkLine.prototype.getDVIDDest=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"dataViewGroupId",!0)};CLinkLine.prototype.getDVNameSrc=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"name",!1)};CLinkLine.prototype.getDVNameDest=function(dataViewId){return this.getDataViewInfoProp(dataViewId,"name",!0)};CLinkLine.prototype.setDVNameSrc=function(obj){null==this.intfSrc.dataViewInfo?this.intfSrc.dataViewInfo={name:obj}:this.intfSrc.dataViewInfo.name=obj};CLinkLine.prototype.setDVNameDest=function(obj){null==this.intfDest.dataViewInfo?this.intfDest.dataViewInfo={name:obj}:this.intfDest.dataViewInfo.name=obj};CLinkLine.prototype.getSrcDisplayInfo=function(){return this.intfSrc&&this.intfSrc.intfInfo&&this.intfSrc.intfInfo.intf&&this.intfSrc.intfInfo.intf.intfDisplaySchemaObj?this.intfSrc.intfInfo.intf.intfDisplaySchemaObj.value:null};CLinkLine.prototype.getDestDisplayInfo=function(){return this.intfDest&&this.intfDest.intfInfo&&this.intfDest.intfInfo.intf&&this.intfDest.intfInfo.intf.intfDisplaySchemaObj?this.intfDest.intfInfo.intf.intfDisplaySchemaObj.value:null};CLinkLine.prototype.setSrcPosListGraphicProps=function(posIndex,scale,color,bgcolor,fontFamily,fontSize){var selectIndex=void 0===posIndex?0:posIndex;var newScale=void 0===scale?null:scale;var newColor=void 0===color?null:color;var newBgColor=void 0===bgcolor?null:bgcolor;var newFont=void 0===fontFamily||void 0===fontSize?null:{faceName:fontFamily,fontSize:fontSize};var intfPosListItem=this.getIntfPosListSrc(selectIndex);intfPosListItem.labelGraphicInfo||(intfPosListItem.labelGraphicInfo={});null!==newScale&&(intfPosListItem.labelGraphicInfo.scale=newScale);null!==newColor&&(intfPosListItem.labelGraphicInfo.color=newColor);null!==newBgColor&&(intfPosListItem.labelGraphicInfo.bgcolor=newBgColor);null!==newFont&&(intfPosListItem.labelGraphicInfo.font=newFont)};CLinkLine.prototype.setDestPosListGraphicProps=function(posIndex,scale,color,bgcolor,font,fontSize){var selectIndex=void 0===posIndex?0:posIndex;var newScale=void 0===scale?null:scale;var newColor=void 0===color?null:color;var newBgColor=void 0===bgcolor?null:bgcolor;var newFont="undefined"==typeof fontFamily||void 0===fontSize?null:{faceName:fontFamily,fontSize:fontSize};var intfPosListItem=this.getIntfPosListDest(selectIndex);intfPosListItem.labelGraphicInfo||(intfPosListItem.labelGraphicInfo={});null!==newScale&&(intfPosListItem.labelGraphicInfo.scale=newScale);null!==newColor&&(intfPosListItem.labelGraphicInfo.color=newColor);null!==newBgColor&&(intfPosListItem.labelGraphicInfo.bgcolor=newBgColor);null!==newFont&&(intfPosListItem.labelGraphicInfo.font=newFont)};CLinkLine.prototype.isEqualLinkLine=function(otherLinkLine){var mediaInfo=this.getMediaInfo();var fromKey=this.getFromKey();var otherFromKey=otherLinkLine.getFromKey();var intfValueSrc=this.getIntfValueSrc();var otherIntfValueSrc=otherLinkLine.getIntfValueSrc();var toKey=this.getToKey();var otherToKey=otherLinkLine.getToKey();var topoType=this.getTopoType();var otherTopoType=otherLinkLine.getTopoType();var intfValueDest=this.getIntfValueDest();var otherIntfValueDest=otherLinkLine.getIntfValueDest();return mediaInfo&&"MuteLan"===mediaInfo.mediaType&&fromKey===otherFromKey&&intfValueSrc===otherIntfValueSrc?3:fromKey===otherFromKey&&toKey===otherToKey&&topoType===otherTopoType&&isEqualIntfValue(intfValueSrc,otherIntfValueSrc)&&isEqualIntfValue(intfValueDest,otherIntfValueDest)?1:fromKey===otherToKey&&toKey===otherFromKey&&topoType===otherTopoType&&isEqualIntfValue(intfValueSrc,otherIntfValueDest)&&isEqualIntfValue(intfValueDest,otherIntfValueSrc)?2:0};CLinkLine.prototype.isEqualAutoLinkLineForSite=function(otherLinkLine){var fromKey=this.getFromKey();var otherFromKey=otherLinkLine.getFromKey();var toKey=this.getToKey();var otherToKey=otherLinkLine.getToKey();var topoType=this.getTopoType();var otherTopoType=otherLinkLine.getTopoType();return fromKey===otherFromKey&&toKey===otherToKey&&topoType===otherTopoType?1:fromKey===otherToKey&&toKey===otherFromKey&&topoType===otherTopoType?2:0};CLinkLine.prototype.isEqualLinkLineByNbrInfo=function(nbrInfo){return this.getFromKey()===nbrInfo.getFromKey()&&this.getToKey()===nbrInfo.getToKey()&&this.getTopoType()===nbrInfo.getTopoType()&&isEqualIntfValue(this.getIntfValueSrc(),nbrInfo.getSrcIntfValue())&&isEqualIntfValue(this.getIntfValueDest(),nbrInfo.getDestIntfValue())?1:this.getFromKey()===nbrInfo.getToKey()&&this.getToKey()===nbrInfo.getFromKey()&&this.getTopoType()===nbrInfo.getTopoType()&&isEqualIntfValue(this.getIntfValueSrc(),nbrInfo.getDestIntfValue())&&isEqualIntfValue(this.getIntfValueDest(),nbrInfo.getSrcIntfValue())?2:0};CLinkLine.prototype.isEqualLinkLineByData=function(devId,intf,topoType){return this.getFromKey()===devId&&this.getIntfValueSrc()===intf.intfKeyObj.value?1:this.getToKey()===devId&&this.getIntfValueDest()===intf.intfKeyObj.value?2:0};CLinkLine.prototype.isEqualBorderLineByData=function(data){return this.getFromKey()===data.from&&this.getToKey()===data.to?1:0};CLinkLine.prototype.isLogicLineExisted=function(data){return this.getIsPortChannel()&&(this.getDevIdSrc()===data.getFromKey()&&this.getDevIdDest()===data.getToKey()||this.getDevIdSrc()===data.getToKey()&&this.getDevIdDest()===data.getFromKey())?1:0};CLinkLine.prototype.getLinkLineKey=function(){var linkLineKey=new CLinkLineKey;linkLineKey.setFromKey(this.getFromKey());linkLineKey.setToKey(this.getToKey());linkLineKey.setTopoType(this.getTopoType());linkLineKey.setIsP2P(this.getIsP2P());linkLineKey.setMedia(this.getMedia());linkLineKey.setSrcIntf(this.getIntfSrc());linkLineKey.setDestIntf(this.getIntfDest());return linkLineKey};CLinkLine.prototype.getLayers=function(){return this.layers};CLinkLine.prototype.setLayers=function(layers){this.layers=layers};CLinkLine.prototype.getDevIdSrc=function(){return this.devIdSrc};CLinkLine.prototype.setDevIdSrc=function(obj){this.devIdSrc=obj};CLinkLine.prototype.getDevIdDest=function(){return this.devIdDest};CLinkLine.prototype.setDevIdDest=function(obj){this.devIdDest=obj};CLinkLine.prototype.getDataUnitListSrc=function(){if(this.intfSrc&&this.intfSrc.intfInfo&&this.intfSrc.intfInfo.intfPosList){var dataUnitList=[];for(var i=0;i<this.intfSrc.intfInfo.intfPosList.length;i++){var pos=this.intfSrc.intfInfo.intfPosList[i];pos&&pos.posInfo&&pos.posInfo.dataUnitList&&dataUnitList.push.apply(dataUnitList,pos.posInfo.dataUnitList)}return dataUnitList}return null};CLinkLine.prototype.getDataUnitListDest=function(){if(null==this.intfDest)return null;if(null==this.intfDest.intfInfo)return null;if(null==this.intfDest.intfInfo.intfPosList)return null;var dataUnitList=[];for(var i=0;i<this.intfDest.intfInfo.intfPosList.length;i++){var pos=this.intfDest.intfInfo.intfPosList[i];null!=pos&&(null!=pos.posInfo&&null!=pos.posInfo.dataUnitList&&dataUnitList.push.apply(dataUnitList,pos.posInfo.dataUnitList))}return dataUnitList};CLinkLine.prototype.getMediaInfo=function(){return this.mediaInfo};CLinkLine.prototype.setMediaInfo=function(obj){this.mediaInfo=obj};CLinkLine.prototype.getKey=function(){return null};CLinkLine.prototype.getHighlightDataListSrc=function(){return this.intfSrc&&this.intfSrc.intfInfo&&this.intfSrc.intfInfo.intfHighlightList||[]};CLinkLine.prototype.setHighlightDataListSrc=function(obj){this.intfSrc&&this.intfSrc.intfInfo&&(this.intfSrc.intfInfo.intfHighlightList=obj)};CLinkLine.prototype.getHighlightDataListDest=function(){return this.intfDest&&this.intfDest.intfInfo&&this.intfDest.intfInfo.intfHighlightList||[]};CLinkLine.prototype.setHighlightDataListDest=function(obj){this.intfDest&&this.intfDest.intfInfo&&(this.intfDest.intfInfo.intfHighlightList=obj)};function isEqualIntfValue(intfValue,otherIntfValue){return intfValue===otherIntfValue||""===intfValue&&null==otherIntfValue||null==intfValue&&""===otherIntfValue}netBrain.Map=netBrain.Map||{};netBrain.Map.CLinkLine=CLinkLine}(NetBrain);!function(netBrain){function CompGraphHighlightNeighborLink(){go.Link.call(this)}go.Diagram.inherit(CompGraphHighlightNeighborLink,netBrain.Map.TopoCustomizeLink);CompGraphHighlightNeighborLink.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var lineShapeInfo=visioTools.getShapeVisioInfo(this,"LINE");lineShapeInfo&&visioInfos.push(lineShapeInfo);var fromArrowShapeInfo=visioTools.getShapeVisioInfo(this,CompHighlightNeighborLink.fromArrowName);visioTools.addDirection(fromArrowShapeInfo,!0);fromArrowShapeInfo&&visioInfos.push(fromArrowShapeInfo);var fromTextInfo=visioTools.getTextVisioInfo(this,CompHighlightNeighborLink.fromTextName);if(fromTextInfo){visioTools.addDirection(fromTextInfo,!0);var fromLabelAngle=this.findObject(CompHighlightNeighborLink.fromTextName).angle;fromTextInfo.angle=fromLabelAngle;visioInfos.push(fromTextInfo)}var toArrowShapeInfo=visioTools.getShapeVisioInfo(this,CompHighlightNeighborLink.toArrowName);visioTools.addDirection(toArrowShapeInfo,!1);toArrowShapeInfo&&visioInfos.push(toArrowShapeInfo);var toTextInfo=visioTools.getTextVisioInfo(this,CompHighlightNeighborLink.toTextName);if(toTextInfo){visioTools.addDirection(toTextInfo,!1);var toLabelAngle=this.findObject(CompHighlightNeighborLink.toTextName).angle;toTextInfo.angle=toLabelAngle;visioInfos.push(toTextInfo)}return visioTools.buildLinkVisioInfo(visioInfos,this.data,this)};var CompHighlightNeighborLink=function(){this.category=netBrain.Map.CategoryMgr.HighlightNeighborLink};CompHighlightNeighborLink.fromArrowName="fromArrow";CompHighlightNeighborLink.toArrowName="toArrow";CompHighlightNeighborLink.fromTextName="fromText";CompHighlightNeighborLink.toTextName="toText";CompHighlightNeighborLink.getMapTemplate=function(diagram){var template=new CompGraphHighlightNeighborLink;template.layerName=GlobalContext.LinkLayerName;template.curve=go.Link.Bezier;template.reshapable=!0;template.adjusting=go.Link.Scale;var line=new go.Shape;line.name="LINE";line.isPanelMain=!0;line.stroke="purple";line.strokeWidth=3;line.bind(new go.Binding("stroke","",BindHelper.colorToStringForhigHightNeighbor).makeTwoWay((function(fill,data,model){model.setDataProperty(data,"color",BindHelper.colorToInt(fill))})));line.bind(new go.Binding("strokeWidth","width"));line.bind(new go.Binding("strokeWidth","thickness"));line.bind(new go.Binding("strokeDashArray","type",BindHelper.lineTypeToArray).makeTwoWay(BindHelper.lineTypeToInt));line.bind(new go.Binding("strokeDashArray","lineType",BindHelper.lineTypeToArray).makeTwoWay(BindHelper.lineTypeToInt));line.bind(new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject());template.add(line);var fromArrow=new go.Shape;fromArrow.name=CompHighlightNeighborLink.fromArrowName;fromArrow.fromArrow="BackwardTriangle";fromArrow.stroke=null;fromArrow.strokeWidth=0;fromArrow.scale=2;fromArrow.fill="purple";fromArrow.visible=!1;fromArrow.bind(new go.Binding("fill","",BindHelper.colorToStringForhigHightNeighbor).makeTwoWay((function(fill,data,model){model.setDataProperty(data,"color",BindHelper.colorToInt(fill))})));fromArrow.bind(new go.Binding("visible","twoWay"));fromArrow.bind(new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject());template.add(fromArrow);var toArrow=new go.Shape;toArrow.name=CompHighlightNeighborLink.toArrowName;toArrow.toArrow="Triangle";toArrow.stroke=null;toArrow.strokeWidth=0;toArrow.scale=2;toArrow.fill="purple";toArrow.bind(new go.Binding("fill","",BindHelper.colorToStringForhigHightNeighbor).makeTwoWay((function(fill,data,model){model.setDataProperty(data,"color",BindHelper.colorToInt(fill))})));toArrow.bind(new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject());template.add(toArrow);var fromText=new go.TextBlock;fromText.name=CompHighlightNeighborLink.fromTextName;fromText.background="white",fromText.font=BindHelper.defaultPosLableFont;fromText.isMultiline=!1;fromText.segmentIndex=0;fromText.alignmentFocus=new go.Spot(0,1,-25,10);fromText.segmentOrientation=go.Link.OrientUpright;fromText.bind(new go.Binding("text","fromText"));template.add(fromText);var toText=new go.TextBlock;toText.name=CompHighlightNeighborLink.toTextName;toText.background="white",toText.font=BindHelper.defaultPosLableFont;toText.isMultiline=!1;toText.segmentIndex=-1;toText.alignmentFocus=new go.Spot(1,0,25,-10);toText.segmentOrientation=go.Link.OrientUpright;toText.bind(new go.Binding("text","toText"));template.add(toText);template.bind(new go.Binding("points","points",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayParse(diagram,data,node)})).makeTwoWay((function(pts,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayStringify(diagram,pts,data)})));template.selectionAdornmentTemplate=NormalSelectAdormenTemplate.getLinkTemplate();return template};CompHighlightNeighborLink.getDefaultJsData=function(){return{key:"0",category:netBrain.Map.CategoryMgr.HighlightNeighborLink,color:"blue",width:3,type:2,legend:"",fromText:"",toText:"",twoWay:!0}};CompHighlightNeighborLink.prototype.getJsData=function(){return this};CompHighlightNeighborLink.prototype.init=function(){this.fromPortIntf=netBrain.Map.CategoryMgr.HighlightNeighborLink;this.toPortIntf=netBrain.Map.CategoryMgr.HighlightNeighborLink};CompHighlightNeighborLink.prototype.getCategory=function(){return this.category};CompHighlightNeighborLink.prototype.setCategory=function(obj){this.category=obj};CompHighlightNeighborLink.prototype.getFromKey=function(){return this.from};CompHighlightNeighborLink.prototype.setFromKey=function(obj){this.from=obj};CompHighlightNeighborLink.prototype.getToKey=function(){return this.to};CompHighlightNeighborLink.prototype.setToKey=function(obj){this.to=obj};CompHighlightNeighborLink.prototype.getKey=function(){return this.key};CompHighlightNeighborLink.prototype.setKey=function(obj){this.key=obj};CompHighlightNeighborLink.prototype.getColor=function(){return this.color};CompHighlightNeighborLink.prototype.setColor=function(obj){this.color=obj};CompHighlightNeighborLink.prototype.getWidth=function(){return this.width};CompHighlightNeighborLink.prototype.setWidth=function(obj){this.width=obj};CompHighlightNeighborLink.prototype.getType=function(){return this.type};CompHighlightNeighborLink.prototype.setType=function(obj){this.type=obj};CompHighlightNeighborLink.prototype.getLegend=function(){return this.legend};CompHighlightNeighborLink.prototype.setLegend=function(obj){this.legend=obj};CompHighlightNeighborLink.prototype.getFromText=function(){return this.fromText};CompHighlightNeighborLink.prototype.setFromText=function(obj){this.fromText=obj};CompHighlightNeighborLink.prototype.getToText=function(){return this.toText};CompHighlightNeighborLink.prototype.setToText=function(obj){this.toText=obj};CompHighlightNeighborLink.prototype.getTwoWay=function(){return this.twoWay};CompHighlightNeighborLink.prototype.setTwoWay=function(obj){this.twoWay=obj};netBrain.Map=netBrain.Map||{};netBrain.Map.CompHighlightNeighborLink=CompHighlightNeighborLink}(NetBrain);!function(netBrain){function CompGraphHopLink(){go.Link.call(this)}go.Diagram.inherit(CompGraphHopLink,netBrain.Map.TopoCustomizeLink);CompGraphHopLink.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var lineShapeInfo=visioTools.getShapeVisioInfo(this,"LINE");lineShapeInfo&&visioInfos.push(lineShapeInfo);var toArrowShapeInfo=visioTools.getShapeVisioInfo(this,CompHopLink.toArrowName);visioTools.addDirection(toArrowShapeInfo,!1);toArrowShapeInfo&&visioInfos.push(toArrowShapeInfo);var toTextInfo=visioTools.getTextVisioInfo(this,CompHopLink.toTextName);if(toTextInfo){visioTools.addDirection(toTextInfo,!1);var angle=this.findObject(CompHopLink.toTextName).angle;toTextInfo.angle=angle;visioInfos.push(toTextInfo)}return visioTools.buildLinkVisioInfo(visioInfos,this.data,this)};var CompHopLink=function(){this.category=netBrain.Map.CategoryMgr.HopLink};CompHopLink.toArrowName="toArrow";CompHopLink.toTextName="toText";CompHopLink.getMapTemplate=function(diagram){var formatColor=function(color,node){var newColor=BindHelper.colorToStringForDrawHop(color);if(color!==newColor){var part=node.part;part&&part.diagram&&part.diagram.model.setDataProperty(part.data,"color",newColor)}return newColor};var template=new CompGraphHopLink;template.layerName=GlobalContext.LinkLayerName;template.curve=go.Link.Bezier;template.reshapable=!0;template.adjusting=go.Link.Scale;var line=new go.Shape;line.name="LINE";line.isPanelMain=!0;line.stroke="purple";line.strokeWidth=3;line.bind(new go.Binding("stroke","color",formatColor).makeTwoWay(BindHelper.colorToInt));line.bind(new go.Binding("strokeWidth","width"));line.bind(new go.Binding("strokeDashArray","type",BindHelper.lineTypeToArray).makeTwoWay(BindHelper.lineTypeToInt));line.bind(new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject());template.add(line);var toArrow=new go.Shape;toArrow.name=CompHopLink.toArrowName;toArrow.toArrow="Triangle";toArrow.stroke=null;toArrow.strokeWidth=0;toArrow.scale=2;toArrow.fill="purple";toArrow.bind(new go.Binding("fill","color",formatColor).makeTwoWay(BindHelper.colorToInt));toArrow.bind(new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject());template.add(toArrow);var toText=new go.TextBlock;toText.name=CompHopLink.toTextName;toText.background="white",toText.font=BindHelper.defaultPosLableFont;toText.isMultiline=!1;toText.segmentIndex=-1;toText.alignmentFocus=new go.Spot(1,1,25,10);toText.segmentOrientation=go.Link.OrientUpright;toText.bind(new go.Binding("text","text"));template.add(toText);template.bind(new go.Binding("points","points",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayParse(diagram,data,node)})).makeTwoWay((function(pts,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayStringify(diagram,pts,data)})));template.selectionAdornmentTemplate=NormalSelectAdormenTemplate.getLinkTemplate();return template};CompHopLink.getDefaultJsData=function(){return{key:"0",category:netBrain.Map.CategoryMgr.HopLink,color:"blue",width:3,type:2,text:"to"}};CompHopLink.prototype.getJsData=function(){return this};CompHopLink.prototype.init=function(){this.fromPortIntf=netBrain.Map.CategoryMgr.HopLink;this.toPortIntf=netBrain.Map.CategoryMgr.HopLink};CompHopLink.prototype.getCategory=function(){return this.category};CompHopLink.prototype.setCategory=function(obj){this.category=obj};CompHopLink.prototype.getFromKey=function(){return this.from};CompHopLink.prototype.setFromKey=function(obj){this.from=obj};CompHopLink.prototype.getToKey=function(){return this.to};CompHopLink.prototype.setToKey=function(obj){this.to=obj};CompHopLink.prototype.getKey=function(){return this.key};CompHopLink.prototype.setKey=function(obj){this.key=obj};CompHopLink.prototype.getColor=function(){return this.color};CompHopLink.prototype.setColor=function(obj){this.color=obj};CompHopLink.prototype.getWidth=function(){return this.width};CompHopLink.prototype.setWidth=function(obj){this.width=obj};CompHopLink.prototype.getType=function(){return this.type};CompHopLink.prototype.setType=function(obj){this.type=obj};CompHopLink.prototype.getText=function(){return this.text};CompHopLink.prototype.setText=function(obj){this.text=obj};netBrain.Map=netBrain.Map||{};netBrain.Map.CompHopLink=CompHopLink}(NetBrain);!function(netBrain){function CompGraphNormalLink(){go.Link.call(this)}go.Diagram.inherit(CompGraphNormalLink,netBrain.Map.TopoCustomizeLink);CompGraphNormalLink.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var lineShapeInfo=visioTools.getShapeVisioInfo(this,"LINE");lineShapeInfo&&visioInfos.push(lineShapeInfo);var textObj=this.findObject(CompNormalLink.normalLinkTextName);if(textObj&&textObj.visible){var textInfo=visioTools.getTextInfo(textObj);var angle=textObj.angle;textInfo.angle=angle;textInfo.bounds.width=textObj.naturalBounds.width;textInfo.bounds.height=textObj.naturalBounds.height;visioTools.addDirection(textInfo,!1);visioInfos.push(textInfo)}return visioTools.buildLinkVisioInfo(visioInfos,this.data,this)};var CompNormalLink=function(){this.category=netBrain.Map.CategoryMgr.NormalLink};CompNormalLink.prototype=new netBrain.Map.CLinkLine;CompNormalLink.normalLinkTextName="normalLinkText";CompNormalLink.getMapTemplate=function(diagram){var template=new CompGraphNormalLink;template.layerName=GlobalContext.LinkLayerName;template.reshapable=!0;template.adjusting=go.Link.Scale;template.fromSpot=go.Spot.None;template.toSpot=go.Spot.None;var line=new go.Shape;line.name="LINE";line.isPanelMain=!0;line.stroke="purple";line.strokeWidth=3;line.bind(new go.Binding("stroke","color"));line.bind(new go.Binding("strokeWidth","width"));line.bind(new go.Binding("strokeDashArray","type",BindHelper.getLineType));line.bind(new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject());template.add(line);var midPos=new go.TextBlock;midPos.name=CompNormalLink.normalLinkTextName;midPos.visible=!1;midPos.segmentOrientation=go.Link.OrientUpright;midPos.font=BindHelper.defaultPosLableFont;midPos.background="white";midPos.bind(new go.Binding("text","text"));midPos.bind(new go.Binding("visible","text",(function(v,node){return""!==v})));template.add(midPos);template.bind(new go.Binding("points","points",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayParse(diagram,data,node)})).makeTwoWay((function(pts,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayStringify(diagram,pts,data)})));template.selectionAdornmentTemplate=NormalSelectAdormenTemplate.getLinkTemplate();return template};CompNormalLink.getDefaultJsData=function(){return{key:"0",category:netBrain.Map.CategoryMgr.NormalLink,fromPortIntf:netBrain.Map.CategoryMgr.NormalLink,toPortIntf:netBrain.Map.CategoryMgr.NormalLink,intfSrc:{},intfDest:{},color:"black",width:1,type:null,text:""}};CompNormalLink.prototype.getJsData=function(){return this};CompNormalLink.prototype.init=function(){this.fromPortIntf=this.fromPortIntf||netBrain.Map.CategoryMgr.NormalLink;this.toPortIntf=this.toPortIntf||netBrain.Map.CategoryMgr.NormalLink};CompNormalLink.prototype.getCategory=function(){return this.category};CompNormalLink.prototype.setCategory=function(obj){this.category=obj};CompNormalLink.prototype.getFromKey=function(){return this.from};CompNormalLink.prototype.setFromKey=function(obj){this.from=obj};CompNormalLink.prototype.getToKey=function(){return this.to};CompNormalLink.prototype.setToKey=function(obj){this.to=obj};CompNormalLink.prototype.getKey=function(){return this.key};CompNormalLink.prototype.setKey=function(obj){this.key=obj};CompNormalLink.prototype.getIntfSrc=function(){return this.intfSrc};CompNormalLink.prototype.setIntfSrc=function(obj){this.intfSrc=obj;this.fromPort=this.getIntfValueSrc()||"";this.fromPortIntf=this.getIntfValueSrc()||netBrain.Map.CategoryMgr.NormalLink};CompNormalLink.prototype.setIntfDest=function(obj){this.intfDest=obj;this.toPort=this.getIntfValueDest()||"";this.toPortIntf=this.getIntfValueDest()||netBrain.Map.CategoryMgr.NormalLink};CompNormalLink.prototype.getColor=function(){return this.color};CompNormalLink.prototype.setColor=function(obj){this.color=obj};CompNormalLink.prototype.getWidth=function(){return this.width};CompNormalLink.prototype.setWidth=function(obj){this.width=obj};CompNormalLink.prototype.getType=function(){return this.type};CompNormalLink.prototype.setType=function(obj){this.type=obj};CompNormalLink.prototype.getText=function(){return this.text};CompNormalLink.prototype.setText=function(obj){this.text=obj};netBrain.Map=netBrain.Map||{};netBrain.Map.CompNormalLink=CompNormalLink}(NetBrain);!function(netBrain){var CQMap=function(titleIndex){CQDoc.call(this);this._type=NgDocType.Map;this.qmapJsWrapper=new netBrain.Map.CQMapJsWrapper(titleIndex);this.refreshWindowCallBack=NgUtil.getRefreshWindowCallBack;this.policyInfo=null;this.defaultIconObj={}};(CQMap.prototype=new CQDoc).getMapJsWraper=function(){return this.qmapJsWrapper};CQMap.prototype.toJson=function(){this.qmapJsWrapper.removeAllPage();for(var i=0;i<this._docList.length;i++){var page=this._docList[i];this.qmapJsWrapper.addMapPageData(page.toJson())}return this.qmapJsWrapper.getJsData()};CQMap.prototype.fromJson=function(jsData){this.qmapJsWrapper.resetJsData(jsData);var pageList=this.qmapJsWrapper.getPageList();if(null!=pageList){var version=this.qmapJsWrapper.getVersion();this._docList=[];for(var i=0;i<pageList.length;i++){var pageJson=pageList[i];var netmap=new netBrain.Map.CNetMap;netmap.fromJson(pageJson,version);this.addDoc(netmap)}this.realModify=!1;this.realNew=!1;this.realSaveAs=!1;this.qmapJsWrapper.removeAllPage()}};CQMap.prototype.setRefreshWindowCallBack=function(callBackFnc){null!=callBackFnc&&(this.refreshWindowCallBack=callBackFnc)};CQMap.prototype.getActive=function(){return this.qmapJsWrapper.getActive()};CQMap.prototype.setActive=function(active){this.qmapJsWrapper.setActive(active)};CQMap.prototype.getTitle=function(){return this.qmapJsWrapper.getTitle()};CQMap.prototype.setTitle=function(obj){this.qmapJsWrapper.setTitle(obj)};CQMap.prototype.getDocId=function(){return this.qmapJsWrapper&&this.qmapJsWrapper.getMapId()};CQMap.prototype.setDocId=function(docId){this.qmapJsWrapper.setMapId(docId)};CQMap.prototype.getModify=function(){return this.getRealModify()};CQMap.prototype.isModify=function(){return!!this.getRealModify()||!!this.isChildrenModify()},CQMap.prototype.setModify=function(bModify,bChangeChildren){this.setRealModify(bModify);null!=bChangeChildren&&!0===bChangeChildren&&this.setChildrenModify(bModify);this.refreshTitle()};CQMap.prototype.getUpdatedBy=function(){return this.qmapJsWrapper.getUpdatedBy()};CQMap.prototype.setUpdatedBy=function(obj){this.qmapJsWrapper.setUpdatedBy(obj)};CQMap.prototype.getCreateTm=function(){return this.qmapJsWrapper.getCreateTm()};CQMap.prototype.getModifyTm=function(){return this.qmapJsWrapper.getModifyTm()};CQMap.prototype.getEditRight=function(){return this.qmapJsWrapper.getEditRight()};CQMap.prototype.setEditRight=function(userName,userId){this.qmapJsWrapper.setEditRight(userName,userId)};CQMap.prototype.getStatus=function(){return this.qmapJsWrapper.getStatus()};CQMap.prototype.setStatus=function(obj){this.qmapJsWrapper.setStatus(obj)};CQMap.prototype.getNew=function(){return this.getRealNew()};CQMap.prototype.setNew=function(obj){this.setRealNew(obj)};CQMap.prototype.getActiveNetmap=function(){var netMap=null;for(var i=0;i<this._docList.length;i++)if(!0===this._docList[i].realActive){netMap=this._docList[i];break}null==netMap&&(netMap=this._docList[0]).setActive(!0);return netMap};CQMap.prototype.getNetmapById=function(pageId){var netMap=null;for(var i=0;i<this._docList.length;i++)if(pageId===this._docList[i].getDocId()){netMap=this._docList[i];break}return netMap};CQMap.prototype.setChildrenModify=function(bModify){for(var index=0;index<this._docList.length;index++){var pageItem=this._docList[index];null!=pageItem&&pageItem.isModify()&&pageItem.setModify(bModify)}};CQMap.prototype.isChildrenModify=function(){var bChildrenModify=!1;for(var index=0;index<this._docList.length;index++){var pageItem=this._docList[index];if(null!=pageItem&&pageItem.isModify()){bChildrenModify=!0;break}}return bChildrenModify};CQMap.prototype.refreshTitle=function(){this.isChildrenModify()||this.isModify()?this.setTitle(this.qmapJsWrapper.getTitle()+""):this.setTitle(this.qmapJsWrapper.getTitle());null!=this.refreshWindowCallBack&&this.refreshWindowCallBack()};CQMap.prototype.doSave=function(){this.isModify()&&this.setUpdatedBy(gUserName);angular.forEach(this._docList,(function(mapPage){mapPage.doSave()}),null);this.realSaveAs=!1;this.setModify(!1,!0)};CQMap.prototype.openMap=function(mapData){this.qmapJsWrapper.resetJsData(mapData);this.setDocId(this.qmapJsWrapper.getMapId());this.setActive(this.qmapJsWrapper.getActive());this.setTitle(this.qmapJsWrapper.getTitle());this.setRealNew(!1);this.mapPageData=[];var pageList=this.qmapJsWrapper.getPageList();for(var i=0;i<pageList.length;i++){var mapPageData=pageList[i];var tempPageObj=new netBrain.Map.CNetMap;tempPageObj.doOpen(mapPageData);tempPageObj.setTitle(mapPageData.title);tempPageObj.setDocId(mapPageData._id);tempPageObj.setImage(mapPageData.pageExtraData.image);tempPageObj.setOwner(mapPageData.owner);tempPageObj.setActive(mapPageData.active);this._docList.push(tempPageObj)}},CQMap.prototype.isLock=function(){return this.qmapJsWrapper.isLock()};CQMap.prototype.setLock=function(bLock){this.qmapJsWrapper.setLock(bLock);for(var i=0;i<this._docList.length;i++){var netMapPage=this._docList[i];null!=netMapPage&&netMapPage.setReadOnly(bLock)}};CQMap.prototype.getPngList=function(){var pngList=[];for(var i=0;i<this._docList.length;i++){var image=this._docList[i].realImage;null!=image&&image.length>=28?pngList.push(image):pngList.push(this._docList[i].realImage)}return pngList};CQMap.prototype.getImageSizeList=function(){var sizeList=[];for(var i=0;i<this._docList.length;i++){var imageSize=this._docList[i].getNetMapJsWrapper().getImageSize();sizeList.push(imageSize)}return sizeList};CQMap.prototype.duplicateNetMap=function(netMap){var newNetMap=netMap.clone();if(null==newNetMap)return null;var strNewName=this.getNewDocName(newNetMap.getDocType());newNetMap.setTitle(strNewName);newNetMap.setTopologyType(netBrain.Map.Const.NetmapTopoLogy.general);newNetMap.setDocId(NgUtil.getGUID());newNetMap.setIsFirstView(!1);var index=this.getDocIndex(netMap);-1===index?this.addDoc(newNetMap):this.insertDoc(newNetMap,index+1);return newNetMap};CQMap.prototype.createSubDoc=function(bInsert){var doc=new netBrain.Map.CNetMap;var newName=this.getNewDocName(doc.getDocType());doc.setTitle(newName);doc.setDocId(doc.getDocId());if(bInsert){this.addDoc(doc);this.deactiveAllPage();doc.setActive(!0)}return doc};CQMap.prototype.getAllPage=function(){return this._docList};CQMap.prototype.deletePage=function(netMapPage){if(null==netMapPage)return!1;for(var i=0;i<this._docList.length;i++){var oneDoc=this._docList[i];if(null!=oneDoc&&oneDoc.getDocId()===netMapPage.getDocId()){this._docList.splice(i,1);break}}var pageList=this.qmapJsWrapper.getPageList();if(null!=pageList)for(var j=0;j<pageList.length;j++){var pageJson=pageList[j];if(null!=pageJson&&pageJson.ID===netMapPage.getDocId()){pageList.splice(j,1);break}}this.setModify(!0,!1);return!0};CQMap.prototype.deactiveAllPage=function(){for(var pageIndex=0;pageIndex<this._docList.length;pageIndex++){var onePage=this._docList[pageIndex];null!=onePage&&onePage.setActive(!1)}};CQMap.prototype.clone=function(){var jsData=this.toJson();var map=new CQMap;map.fromJson(jsData);map.setDocId(NgUtil.getGUID());map.setActive(!1);for(var i=0;i<map._docList.length;++i){var netmap=map._docList[i];netmap.setDocId(NgUtil.getGUID());netmap.setActive(!1)}return map};CQMap.prototype.getRefDocList=function(){return this.qmapJsWrapper.getRefDocList()};CQMap.prototype.setRefDocList=function(obj){this.qmapJsWrapper.setRefDocList(obj)};CQMap.prototype.addRefDoc=function(obj){this.qmapJsWrapper.addRefDoc(obj)};CQMap.prototype.getMapType=function(){return this.qmapJsWrapper.getMapType()};CQMap.prototype.setMapType=function(obj){this.qmapJsWrapper.setMapType(obj)};CQMap.prototype.setCurrentRBA=function(rba){this.currentRBA=rba};CQMap.prototype.getCurrentRBA=function(){return this.currentRBA};CQMap.prototype.getCurrentRunbook=function(){return this.currentRunbook};CQMap.prototype.setCurrentRunbook=function(runbook){this.currentRunbook=runbook};CQMap.prototype.setRBAOpend=function(opened){this.rbaOpend=opened};CQMap.prototype.getRBAOpend=function(){return this.rbaOpend};CQMap.prototype.showRbaTab=function(){return this.currentRBA&&!0===this.rbaOpend};CQMap.prototype.setDataViewOpend=function(opened){this.dataViewOpend=opened};CQMap.prototype.getDataViewOpend=function(){return this.dataViewOpend};CQMap.prototype.setInstantRunbookOpend=function(opened){this.InstantRunbookOpend=opened};CQMap.prototype.getInstantRunbookOpend=function(){return this.InstantRunbookOpend};CQMap.prototype.setCurrentInstantRunbook=function(instantRunbook){this.currentInstantRunbook=instantRunbook};CQMap.prototype.getCurrentInstantRunbook=function(){return this.currentInstantRunbook};CQMap.prototype.showInstantRunbookTab=function(){return!0===this.InstantRunbookOpend};CQMap.prototype.setInstantQappOpend=function(opened){this.instantQappOpend=opened};CQMap.prototype.getInstantQappOpend=function(){return this.instantQappOpend};CQMap.prototype.setCurrentInstantQapp=function(instantQapp){this.currentInstantQapp=instantQapp};CQMap.prototype.getCurrentInstantQapp=function(){return this.currentInstantQapp};CQMap.prototype.setFromMapId=function(mapId){this.qmapJsWrapper.setFromMapId(mapId)};CQMap.prototype.getFromMapId=function(){return this.qmapJsWrapper.getFromMapId()};CQMap.prototype.isMonitoring=function(){for(var i=0;i<this._docList.length;i++){var oneDoc=this._docList[i];if(null!=oneDoc&&oneDoc.isMonitoring())return!0}return!1};CQMap.prototype.getNodeImgUrls=function(){var imgUrlsObj={};var imgUrls=[];_.forEach(this.getAllPage(),(function(page){var nodes=page.newNodeList;nodes&&_.forEach(nodes,(function(node){var dataViewData=node.dataViewData;if(dataViewData){var imgUrl=BindHelper.toTarget_device_source(dataViewData);imgUrlsObj[imgUrl]=imgUrl}}))}));_.forEach(imgUrlsObj,(function(v,k){imgUrls.push(v)}));return imgUrls};CQMap.prototype.setTopoLinkPolicyInfo=function(policyInfo){this.policyInfo=function(policyArr){if(!policyArr)return null;policyArr=JSON.parse(JSON.stringify(policyArr));var policyInfo={};_.each(policyArr,(function(item){_.each(item.policys,(function(pItem){_.isArray(pItem.policyItems)&&(pItem.policyItems=JSON.parse(JSON.stringify(NgUtil.changeJsonValueToString(pItem.policyItems)).toUpperCase()))}));policyInfo[item.topoType.toUpperCase()]=item.policys}));return policyInfo}(policyInfo)};CQMap.prototype.getTopoLinkPolicyInfo=function(){return this.policyInfo};CQMap.prototype.setDefaultIconList=function(iconList){this.defaultIconObj=_.indexBy(iconList,"type")};CQMap.prototype.getDefaultIconByDevType=function(devType){return this.defaultIconObj[devType]};CQMap.prototype.getTopoLinkStyleFromPolicy=function(topoType,srcData,destData){var styleObj={};var policyInfo=this.policyInfo;var defaultTopoLinkStyle=policyInfo[""][0].topoLinkStyle;if(srcData||destData)if(""===topoType){styleObj.src=defaultTopoLinkStyle;styleObj.dest=defaultTopoLinkStyle}else{var topoPolicys=policyInfo[topoType=topoType.toUpperCase()];if(srcData){srcData=JSON.parse(JSON.stringify(srcData));srcData=JSON.parse(JSON.stringify(NgUtil.changeJsonValueToString(srcData)).toUpperCase())}else srcData={};if(destData){destData=JSON.parse(JSON.stringify(destData));destData=JSON.parse(JSON.stringify(NgUtil.changeJsonValueToString(destData)).toUpperCase())}else destData={};var srcTopoPolicy=getCurrIntfPolicyInfo(topoPolicys,srcData,destData);if(srcTopoPolicy&&!0===srcTopoPolicy.applyBoth){styleObj.src=srcTopoPolicy.topoLinkStyle;styleObj.dest=srcTopoPolicy.topoLinkStyle}else{srcTopoPolicy&&(styleObj.src=srcTopoPolicy.topoLinkStyle);var destTopoPolicy=getCurrIntfPolicyInfo(topoPolicys,destData,srcData);destTopoPolicy&&(styleObj.dest=destTopoPolicy.topoLinkStyle)}styleObj.src=styleObj.src||defaultTopoLinkStyle;styleObj.dest=styleObj.dest||defaultTopoLinkStyle}else{styleObj.src=defaultTopoLinkStyle;styleObj.dest=defaultTopoLinkStyle}return styleObj};function getCurrIntfPolicyInfo(topoPolicys,sourceData,otherData){return _.find(topoPolicys,(function(currTopoPolicy){var flag=!1;var policyItems=currTopoPolicy.policyItems;if(!0===currTopoPolicy.applyBoth){var policyItemArray=_.partition(policyItems,(function(item){return"TRUE"===item.ISSOURCE}));var sourcePolicyItems=policyItemArray[0];var otherPolicyItems=policyItemArray[1];if(0===currTopoPolicy.logicalCondition){var flag1=isEveryMatched(sourcePolicyItems,sourceData);var flag2=isEveryMatched(otherPolicyItems,otherData);if(!0!==(flag=flag1&&flag2)){flag1=isEveryMatched(sourcePolicyItems,otherData);flag2=isEveryMatched(otherPolicyItems,sourceData);flag=flag1&&flag2}}else if(1===currTopoPolicy.logicalCondition){flag1=isAnyMatched(sourcePolicyItems,sourceData);flag2=isAnyMatched(otherPolicyItems,otherData);if(!0!==(flag=flag1&&flag2)){flag1=isAnyMatched(sourcePolicyItems,otherData);flag2=isAnyMatched(otherPolicyItems,sourceData);flag=flag1&&flag2}}}else 0===currTopoPolicy.logicalCondition?flag=isEveryMatched(policyItems,sourceData):1===currTopoPolicy.logicalCondition&&(flag=isAnyMatched(policyItems,sourceData));return flag}))}function isEveryMatched(policyItems,data){return _.every(policyItems,(function(item){var sValue=data[item.KEY];return isMatchedByType(item.VALUE,sValue,item.MATCHTYPE)}))}function isAnyMatched(policyItems,data){return _.some(policyItems,(function(item){var sValue=data[item.KEY];return isMatchedByType(item.VALUE,sValue,item.MATCHTYPE)}))}function isMatchedByType(iValues,sValue,matchType){var flag=!1;switch(matchType){case"0":flag=iValues===sValue;break;case"1":flag=iValues!==sValue;break;case"2":flag=_.contains(iValues,sValue);break;default:flag=iValues===sValue}return flag}netBrain.Map=netBrain.Map||{};netBrain.Map.CQMap=CQMap}(NetBrain);function _typeof3(obj){return(_typeof3="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}!function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};modules[moduleId].call(module.exports,module,module.exports,__webpack_require__);module.l=!0;return module.exports}__webpack_require__.m=modules;__webpack_require__.c=installedModules;__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})};__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});Object.defineProperty(exports,"__esModule",{value:!0})};__webpack_require__.t=function(value,mode){1&mode&&(value=__webpack_require__(value));if(8&mode)return value;if(4&mode&&"object"===_typeof3(value)&&value&&value.__esModule)return value;var ns=Object.create(null);__webpack_require__.r(ns);Object.defineProperty(ns,"default",{enumerable:!0,value:value});if(2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns};__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};__webpack_require__.d(getter,"a",getter);return getter};__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)};__webpack_require__.p="";__webpack_require__(__webpack_require__.s="./app/modules/nbQmap/path.es6.js")}({"./app/modules/nbQmap/models/qmap/graphic/DrawTextboxTool.es6.js":function(module,__webpack_exports__,__webpack_require__){__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,"CompTextbox",(function(){return CompTextbox}));__webpack_require__.d(__webpack_exports__,"DrawTextboxTool",(function(){return DrawTextboxTool}));var _babel_runtime_helpers_assertThisInitialized__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@babel/runtime/helpers/assertThisInitialized.js");var _babel_runtime_helpers_assertThisInitialized__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_babel_runtime_helpers_assertThisInitialized__WEBPACK_IMPORTED_MODULE_0__);var _babel_runtime_helpers_get__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@babel/runtime/helpers/get.js");var _babel_runtime_helpers_get__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_babel_runtime_helpers_get__WEBPACK_IMPORTED_MODULE_1__);var _babel_runtime_helpers_createClass__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@babel/runtime/helpers/createClass.js");var _babel_runtime_helpers_createClass__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_babel_runtime_helpers_createClass__WEBPACK_IMPORTED_MODULE_2__);var _babel_runtime_helpers_classCallCheck__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/@babel/runtime/helpers/classCallCheck.js");var _babel_runtime_helpers_classCallCheck__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_babel_runtime_helpers_classCallCheck__WEBPACK_IMPORTED_MODULE_3__);var _babel_runtime_helpers_possibleConstructorReturn__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/@babel/runtime/helpers/possibleConstructorReturn.js");var _babel_runtime_helpers_possibleConstructorReturn__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_babel_runtime_helpers_possibleConstructorReturn__WEBPACK_IMPORTED_MODULE_4__);var _babel_runtime_helpers_getPrototypeOf__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./node_modules/@babel/runtime/helpers/getPrototypeOf.js");var _babel_runtime_helpers_getPrototypeOf__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(_babel_runtime_helpers_getPrototypeOf__WEBPACK_IMPORTED_MODULE_5__);var _babel_runtime_helpers_inherits__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./node_modules/@babel/runtime/helpers/inherits.js");var _babel_runtime_helpers_inherits__WEBPACK_IMPORTED_MODULE_6___default=__webpack_require__.n(_babel_runtime_helpers_inherits__WEBPACK_IMPORTED_MODULE_6__);var CompTextboxNode=function(_window$NetBrain$Map$){_babel_runtime_helpers_inherits__WEBPACK_IMPORTED_MODULE_6___default()(CompTextboxNode,_window$NetBrain$Map$);function CompTextboxNode(){_babel_runtime_helpers_classCallCheck__WEBPACK_IMPORTED_MODULE_3___default()(this,CompTextboxNode);return _babel_runtime_helpers_possibleConstructorReturn__WEBPACK_IMPORTED_MODULE_4___default()(this,_babel_runtime_helpers_getPrototypeOf__WEBPACK_IMPORTED_MODULE_5___default()(CompTextboxNode).call(this))}return CompTextboxNode}(window.NetBrain.Map.CompDrawShapeBaseNode);var CompTextbox=function(_window$NetBrain$Map$2){_babel_runtime_helpers_inherits__WEBPACK_IMPORTED_MODULE_6___default()(CompTextbox,_window$NetBrain$Map$2);function CompTextbox(){_babel_runtime_helpers_classCallCheck__WEBPACK_IMPORTED_MODULE_3___default()(this,CompTextbox);return _babel_runtime_helpers_possibleConstructorReturn__WEBPACK_IMPORTED_MODULE_4___default()(this,_babel_runtime_helpers_getPrototypeOf__WEBPACK_IMPORTED_MODULE_5___default()(CompTextbox).call(this))}_babel_runtime_helpers_createClass__WEBPACK_IMPORTED_MODULE_2___default()(CompTextbox,null,[{key:"getMapTemplate",value:function(templateOption,map,scope){var $=go.GraphObject.make;var template=$(CompTextboxNode,"Spot",window.NetBrain.Map.DrawShapeCommonAttr.getCommonNodeAttr(templateOption,map,scope),$(go.Shape,window.NetBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr()));var textBlock=$(go.TextBlock,window.NetBrain.Map.DrawShapeCommonAttr.getCommonTextBlockAttrWithoutGeo());textBlock.text="Text something";var textBlockWrapper=$(go.Panel,textBlock);template.add(textBlockWrapper);return template}},{key:"getVarCategory",value:function(){return window.NetBrain.Map.CategoryMgr.Textbox}}]);return CompTextbox}(window.NetBrain.Map.CompDrawShapeBase);var DrawTextboxTool=function(_window$NetBrain$Map$3){_babel_runtime_helpers_inherits__WEBPACK_IMPORTED_MODULE_6___default()(DrawTextboxTool,_window$NetBrain$Map$3);function DrawTextboxTool(){var _this;_babel_runtime_helpers_classCallCheck__WEBPACK_IMPORTED_MODULE_3___default()(this,DrawTextboxTool);_this=_babel_runtime_helpers_possibleConstructorReturn__WEBPACK_IMPORTED_MODULE_4___default()(this,_babel_runtime_helpers_getPrototypeOf__WEBPACK_IMPORTED_MODULE_5___default()(DrawTextboxTool).call(this));window.NetBrain.Map.DrawShapeToolBase.call(_babel_runtime_helpers_assertThisInitialized__WEBPACK_IMPORTED_MODULE_0___default()(_this));_this.name="RectangleDrawing";_this.backColor="rgba(0,0,0,0)";_this.ShapeType="Rectangle";_this.ShapeGeoType=go.Geometry.Rectangle;_this.archetypePartData={category:CompTextbox.getVarCategory(),color:"rgba(0,0,0,0)",source:"",shapeLineColor:"black",shapeLineWidth:0,lineStyle:null,font:"normal 20px Arial"};_this.Init();return _this}_babel_runtime_helpers_createClass__WEBPACK_IMPORTED_MODULE_2___default()(DrawTextboxTool,[{key:"finishShape",value:function(){_babel_runtime_helpers_get__WEBPACK_IMPORTED_MODULE_1___default()(_babel_runtime_helpers_getPrototypeOf__WEBPACK_IMPORTED_MODULE_5___default()(DrawTextboxTool.prototype),"finishShape",this).call(this);this.diagram.commandHandler.editTextBlock()}}]);return DrawTextboxTool}(window.NetBrain.Map.DrawShapeToolBase)},"./app/modules/nbQmap/models/qmap/graphic/cursorHelper.es6.js":function(module,__webpack_exports__,__webpack_require__){__webpack_require__.r(__webpack_exports__);__webpack_exports__.default={grab:"url(img/openhand.cur),pointer",grabbing:"url(img/closehand.cur),pointer",pointer:"pointer",move:"move",crosshair:"crosshair",auto:"auto"}},"./app/modules/nbQmap/path.es6.js":function(module,__webpack_exports__,__webpack_require__){__webpack_require__.r(__webpack_exports__);var _models_qmap_graphic_DrawTextboxTool_es6__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./app/modules/nbQmap/models/qmap/graphic/DrawTextboxTool.es6.js");var _models_qmap_graphic_cursorHelper_es6__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./app/modules/nbQmap/models/qmap/graphic/cursorHelper.es6.js");window.NetBrain.Map=window.NetBrain.Map||{};window.NetBrain.Map.CompTextbox=_models_qmap_graphic_DrawTextboxTool_es6__WEBPACK_IMPORTED_MODULE_0__.CompTextbox;window.NetBrain.Map.DrawTextboxTool=_models_qmap_graphic_DrawTextboxTool_es6__WEBPACK_IMPORTED_MODULE_0__.DrawTextboxTool;window.cursorHelper=_models_qmap_graphic_cursorHelper_es6__WEBPACK_IMPORTED_MODULE_1__.default},"./node_modules/@babel/runtime/helpers/assertThisInitialized.js":function(module,exports){module.exports=function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}},"./node_modules/@babel/runtime/helpers/classCallCheck.js":function(module,exports){module.exports=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}},"./node_modules/@babel/runtime/helpers/createClass.js":function(module,exports){function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;"value"in descriptor&&(descriptor.writable=!0);Object.defineProperty(target,descriptor.key,descriptor)}}module.exports=function(Constructor,protoProps,staticProps){protoProps&&_defineProperties(Constructor.prototype,protoProps);staticProps&&_defineProperties(Constructor,staticProps);return Constructor}},"./node_modules/@babel/runtime/helpers/get.js":function(module,exports,__webpack_require__){var superPropBase=__webpack_require__("./node_modules/@babel/runtime/helpers/superPropBase.js");function _get(target,property,receiver){"undefined"!=typeof Reflect&&Reflect.get?module.exports=_get=Reflect.get:module.exports=_get=function(target,property,receiver){var base=superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(receiver):desc.value}};return _get(target,property,receiver||target)}module.exports=_get},"./node_modules/@babel/runtime/helpers/getPrototypeOf.js":function(module,exports){function _getPrototypeOf(o){module.exports=_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)};return _getPrototypeOf(o)}module.exports=_getPrototypeOf},"./node_modules/@babel/runtime/helpers/inherits.js":function(module,exports,__webpack_require__){var setPrototypeOf=__webpack_require__("./node_modules/@babel/runtime/helpers/setPrototypeOf.js");module.exports=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}});superClass&&setPrototypeOf(subClass,superClass)}},"./node_modules/@babel/runtime/helpers/possibleConstructorReturn.js":function(module,exports,__webpack_require__){var _typeof=__webpack_require__("./node_modules/@babel/runtime/helpers/typeof.js");var assertThisInitialized=__webpack_require__("./node_modules/@babel/runtime/helpers/assertThisInitialized.js");module.exports=function(self,call){return!call||"object"!==_typeof(call)&&"function"!=typeof call?assertThisInitialized(self):call}},"./node_modules/@babel/runtime/helpers/setPrototypeOf.js":function(module,exports){function _setPrototypeOf(o,p){module.exports=_setPrototypeOf=Object.setPrototypeOf||function(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}module.exports=_setPrototypeOf},"./node_modules/@babel/runtime/helpers/superPropBase.js":function(module,exports,__webpack_require__){var getPrototypeOf=__webpack_require__("./node_modules/@babel/runtime/helpers/getPrototypeOf.js");module.exports=function(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=getPrototypeOf(object)););return object}},"./node_modules/@babel/runtime/helpers/typeof.js":function(module,exports){function _typeof2(obj){return(_typeof2="function"==typeof Symbol&&"symbol"===_typeof3(Symbol.iterator)?function(obj){return _typeof3(obj)}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof3(obj)})(obj)}function _typeof(obj){"function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?module.exports=_typeof=function(obj){return _typeof2(obj)}:module.exports=_typeof=function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof2(obj)};return _typeof(obj)}module.exports=_typeof}});function GraphicStyle(){this.lineWidth=1;this.lineStyle=null;this.lineArrowStyle="from";this.lineColor="black";this.fillColor="white";this.fontSize=20;this.fontFamily="Arial";this.fontBold=!1;this.fontItalic=!1;this.fontUnderLine=!1;this.fontStrike=!1;this.fontColor="black";this.alignmentStyle="left";this.textNumber=!1}function DrawTextStyle(){GraphicStyle.apply(this);this.fillColor=NetBrain.Map.Const.noteDefaultBackColor}function DrawTextboxStyle(){GraphicStyle.apply(this);this.lineStyle=[1,1];this.fillColor="transparent"}!function(netBrain){var CNetMap=function(diagram,model){CQDoc.call(this);this._type=NgDocType.Page;this._diagram=diagram;this._model=model;this._netmapJsWrapper=new netBrain.Map.CNetMapJsWrapper;this.qMapId=null;this.currentScopeRef=null;this._cmdTarget=null;this._netmapOperator=null;this._layoutTools=null;this._mapViewOption=new netBrain.Map.CMapViewOption;this.isMapPanelTabShow=!1;this.isShowDomain=!1;this.dataViewInfo=new NetMapDVInfoHelper;this._isApplyDVAfterRun=!1;this._highlightBg=new netBrain.Map.CompHighlightBg};(CNetMap.prototype=new CQDoc).getDeviceIconRatio=function(deviceId){return this._model.findNodeDataForKey(deviceId).iconRatio||1};CNetMap.prototype.toJson=function(){return this._netmapJsWrapper.getJsData()};function fixupLegacyDevNodeData(node){node.devNodeData||(node.devNodeData={id:node.key,isGroup:!1,isRealDev:!0,nodeIdentify:{nbPathSchema:VisualSpaceConstant.legacySchema,nbPathValue:node.key},role:"",visualSpaceInfo:{visualSpaceInstanceId:VisualSpaceConstant.defaultVisualSpaceInstanceId,visualSpaceName:VisualSpaceConstant.defaultVisualSpaceName}});return!0}CNetMap.prototype.fixupLegacyIntfNodeData=fixupLegacyIntfNodeData;function fixupLegacyIntfNodeData(intf){if(!intf.intfNodeData){var idx=intf.intfKeyObj.schema.indexOf("._id");if(idx>0){var schema=intf.intfKeyObj.schema.substr(0,idx);intf.intfNodeData={id:intf.intfKeyObj.value,isRealIntf:!0,nodeIdentify:{nbPathSchema:schema,nbPathValue:intf.intfKeyObj.value},visualSpaceInfo:{visualSpaceInstanceId:VisualSpaceConstant.defaultVisualSpaceInstanceId,visualSpaceName:VisualSpaceConstant.defaultVisualSpaceName}};return!0}}return!1}CNetMap.prototype.fromJson=function(jsData,version){this._netmapJsWrapper.resetJsData(jsData);this.realModify=!1;this.realNew=!1;this.realSaveAs=!1;this.realImage=this.getImage();if(version&&version<="7.0b"){var modify=!1;var nodeList=this._netmapJsWrapper.getNodeDataArray();if(null!=nodeList)for(var i=0;i<nodeList.length;i++){var temp=nodeList[i];netBrain.Map.CategoryMgr.isNetworkDevice(temp.category)&&(modify=fixupLegacyDevNodeData(temp)||modify)}var linkList=this._netmapJsWrapper.getLinkDataArray();if(null!=linkList)for(var j=0;j<linkList.length;j++){var temp1=linkList[j];if(netBrain.Map.CategoryMgr.isTopolink(temp1.category)){temp1.intfSrc&&temp1.intfSrc.intfInfo&&temp1.intfSrc.intfInfo.intf&&(modify=fixupLegacyIntfNodeData(temp1.intfSrc.intfInfo.intf)||modify);temp1.intfDest&&temp1.intfDest.intfInfo&&temp1.intfDest.intfInfo.intf&&(modify=fixupLegacyIntfNodeData(temp1.intfDest.intfInfo.intf)||modify)}}this.setModify(modify);(nodeList&&nodeList.length>0||linkList&&linkList.length>0)&&this.setVisualSpaceInfo({visualSpaceInstanceId:VisualSpaceConstant.defaultVisualSpaceInstanceId,visualSpaceName:VisualSpaceConstant.defaultVisualSpaceName},!0)}jsData.currVersion=version};CNetMap.prototype.isL2MapStyle=function(){return this._netmapJsWrapper.isL2Style()};CNetMap.prototype.setL2MapStyle=function(){if(null!=this._netmapJsWrapper){var transactionName=NgUtil.getUniqueStr("Set L2 Map Style");this._diagram.startTransaction(transactionName);this._model.setDataProperty(this._netmapJsWrapper.getRefData(),"l2Style",!0);this._diagram.commitTransaction(transactionName);this.setModify(!0)}};CNetMap.prototype.isL3MapStyle=function(){return!this._netmapJsWrapper.isL2Style()};CNetMap.prototype.setL3MapStyle=function(){if(null!=this._netmapJsWrapper){var transactionName=NgUtil.getUniqueStr("Set L3 Map Style");this._diagram.startTransaction(transactionName);this._model.setDataProperty(this._netmapJsWrapper.getRefData(),"l2Style",!1);this._diagram.commitTransaction(transactionName);this.setModify(!0)}};CNetMap.prototype.getActive=function(){return this._netmapJsWrapper.getActive()};CNetMap.prototype.setActive=function(active){this._netmapJsWrapper.setActive(active)};CNetMap.prototype.getTitle=function(){return this._netmapJsWrapper.getTitle()};CNetMap.prototype.setTitle=function(obj){this._netmapJsWrapper.setTitle(obj)};CNetMap.prototype.getDocId=function(){return this._netmapJsWrapper.getPageId()};CNetMap.prototype.setDocId=function(docId){this._netmapJsWrapper.setPageId(docId)};CNetMap.prototype.getModify=function(){return this.getRealModify()};CNetMap.prototype.isModify=function(){return this.getRealModify()};CNetMap.prototype.setModify=function(bModify){if(bModify!==this.isModify()){this.setRealModify(bModify);null!=netBrain.Map.currentActiveMap&&netBrain.Map.currentActiveMap.refreshTitle()}};CNetMap.prototype.setMapLegend=function(obj){this._netmapJsWrapper.setMapLegend(obj)};CNetMap.prototype.getMapLegend=function(){return this._netmapJsWrapper.getMapLegend()};CNetMap.prototype.setNetMapLegend=function(){this.getCurrentScope().$broadcast("setNetMapLegend")};CNetMap.prototype.setExtendData=function(obj){this._netmapJsWrapper.setExtendData(obj)};CNetMap.prototype.getExtendData=function(){return this._netmapJsWrapper.getExtendData()};CNetMap.prototype.getExtendDataViewData=function(){return this._netmapJsWrapper.getExtendDataViewData()};CNetMap.prototype.getExtendDataViewTemplateData=function(){return this._netmapJsWrapper.getExtendDataViewTemplateData()};CNetMap.prototype.getExtendRunbookData=function(){return this._netmapJsWrapper.getExtendRunbookData()};CNetMap.prototype.getDefaultExtendData=function(){return this._netmapJsWrapper.getDefaultExtendData()};CNetMap.prototype.getMapAutoLinkOptionList=function(vspaceId){return this._netmapJsWrapper?this._netmapJsWrapper.getMapAutoLinkOptionList(vspaceId):[]};CNetMap.prototype.setMapAutoLinkOptionList=function(obj,vsId){this._netmapJsWrapper.setMapAutoLinkOptionList(obj,vsId)};CNetMap.prototype.isMapAutoLinkOptionListEmpty=function(){return this._netmapJsWrapper.isMapAutoLinkOptionListEmpty()};CNetMap.prototype.setMapAutoLinkOptionExcluedeMip=function(obj){this._netmapJsWrapper.setMapAutoLinkOptionExcluedeMip(obj)};CNetMap.prototype.getMapAutoLinkOptionExcluedeMip=function(){return this._netmapJsWrapper.getMapAutoLinkOptionExcluedeMip()};CNetMap.prototype.getChangedToDefaultDataview=function(){return this._netmapJsWrapper.getChangedToDefaultDataview()};CNetMap.prototype.getDeviceRemovedNote=function(){return this._netmapJsWrapper.getDeviceRemovedNote()};CNetMap.prototype.getL3StyleInExpandedStyle=function(){return this._netmapJsWrapper.getL3StyleInExpandedStyle()};CNetMap.prototype.setL3StyleInExpandedStyle=function(arr){this._netmapJsWrapper.setL3StyleInExpandedStyle(arr)};CNetMap.prototype.isInL3StyleInExpandedStyle=function(devCategory){var expandedStyle=this.getL3StyleInExpandedStyle();return _.contains(expandedStyle,devCategory+"")};CNetMap.prototype.getInterfaceHighlightMode=function(){return this._netmapJsWrapper.getInterfaceHighlightMode()};CNetMap.prototype.setInterfaceHighlightMode=function(mode){this._netmapJsWrapper.setInterfaceHighlightMode(mode)};CNetMap.prototype.getUpdatedBy=function(){return this._netmapJsWrapper.getUpdatedBy()};CNetMap.prototype.setUpdatedBy=function(obj){return this._netmapJsWrapper.setUpdatedBy(obj)};CNetMap.prototype.getNew=function(){return this.getRealNew()};CNetMap.prototype.setNew=function(obj){this.setRealNew(obj)};CNetMap.prototype.getImage=function(){return this._netmapJsWrapper.getImage()};CNetMap.prototype.setImage=function(image){this.realImage=image};CNetMap.prototype.setCmdTarget=function(cmdTarget){this._cmdTarget=cmdTarget};CNetMap.prototype.getCmdTarget=function(){return this._cmdTarget};CNetMap.prototype.setNetmapOperator=function(netmapOperator){this._netmapOperator=netmapOperator};CNetMap.prototype.getNetmapOperator=function(){return this._netmapOperator};CNetMap.prototype.setLayoutTools=function(layoutTools){this._layoutTools=layoutTools};CNetMap.prototype.getLayoutTools=function(){return this._layoutTools};CNetMap.prototype.isReadOnly=function(bNeedDlgUnlockIfTrue){if(null!=bNeedDlgUnlockIfTrue&&!0===bNeedDlgUnlockIfTrue&&!0===this._netmapJsWrapper.isReadOnly()){!0===confirm("This map is readonly, are you sure you want to unlock it.")&&this.setReadOnly(!1)}return this._netmapJsWrapper.isReadOnly()};CNetMap.prototype.setReadOnly=function(bReadOnly){this._netmapJsWrapper.setReadOnly(bReadOnly);this._resetDiagramReadModel();this.setModify(!0);null!=this._netmapOperator&&(bReadOnly?this._netmapOperator.setReadonlyMode():this._netmapOperator.setStandardMode())};CNetMap.prototype.addL2StyleProperty=function(diagram){if(diagram){var _this=this;diagram.model.nodeCategoryProperty=function(obj){return _this.isL2DeviceStyle(obj)?netBrain.Map.CategoryMgr.L2Device:obj.category};diagram.model.linkCategoryProperty=function(obj){obj.isL2LinkStyle=!1;if(_this.isL2LinkStyle(obj)){obj.isL2LinkStyle=!0;return netBrain.Map.CategoryMgr.L2TopoLink}return obj.category===netBrain.Map.CategoryMgr.VirtualTopoLink?netBrain.Map.CategoryMgr.TopoLink:obj.category}}};CNetMap.prototype.setGoJsContext=function(diagram,model){this._diagram=diagram;this._model=model;if(this._model){this._model.nodeIsGroupProperty=function(obj){return!(!obj||!obj.devNodeData)&&obj.devNodeData.isGroup};this._model.nodeGroupKeyProperty=function(obj){return obj&&obj.devNodeData?obj.devNodeData.group:""}}};CNetMap.prototype.getParentQmap=function(){return netBrain.Map.currentActiveMap};CNetMap.prototype.setCurrentScope=function(currentScopeRef){this.currentScopeRef=currentScopeRef};CNetMap.prototype.getCurrentScope=function(){return this.currentScopeRef};CNetMap.prototype.getNetMapJsWrapper=function(){return this._netmapJsWrapper};CNetMap.prototype.resetNetMapJsWrapper=function(jsData){this._netmapJsWrapper.resetJsData(jsData)};CNetMap.prototype.setBackColor=function(strCssColor){if(null!=strCssColor){this._netmapJsWrapper.setBkColor(strCssColor);if(this.getCurrentScope()&&this.getCurrentScope().netmapDiagramStyle){this.getCurrentScope().netmapDiagramStyle["background-color"]=strCssColor;this.getCurrentScope().$root.$broadcast("BackgroundColorChange",strCssColor)}}};CNetMap.prototype.getBackColor=function(){return this.getCurrentScope()&&this.getCurrentScope().netmapDiagramStyle?this.getCurrentScope().netmapDiagramStyle["background-color"]:this._netmapJsWrapper.getBkColor()};CNetMap.prototype.doSave=function(){if(null==this._model)return!1;this.isModify()&&this._netmapJsWrapper.setUpdatedBy(gUserName);var model=JSON.parse(this._model.toJson());this._netmapJsWrapper.setNodeDataArray(model.nodeDataArray);this._netmapJsWrapper.setLinkDataArray(model.linkDataArray);this._netmapJsWrapper.setModelData(model.modelData);this._netmapJsWrapper.setViewportPosition(this._diagram.position.x+" "+this._diagram.position.y);this._netmapJsWrapper.setImage(this.getImageBase64());this._netmapJsWrapper.setImageSize(this.getContextImageSize());this.layoutLinkLabels(!0);var visioInfos=this.getVisioInfos();this._netmapJsWrapper.setVisioInfos(visioInfos);this.realModify=!1;this.realNew=!1;this.realSaveAs=!1;this.realImage=this.getImage();return!0};CNetMap.prototype.doSaveOnEditMode=function(dataViewSrc){var json=this.toJson();var nodeDataArray=this._model.nodeDataArray;var linkDataArray=this._model.linkDataArray;for(var i=0;i<nodeDataArray.length;i++)nodeDataArray[i]._netmap=null;for(var j=0;j<linkDataArray.length;j++)linkDataArray[j]._netmap=null;json.nodeDataArray=nodeDataArray;json.linkDataArray=linkDataArray};CNetMap.prototype.getZoomStep=function(){var mapOptionJson=this.getMapViewOptionJson();return null!=mapOptionJson&&null!=mapOptionJson.step?mapOptionJson.step:.05};CNetMap.prototype.setZoomStep=function(dZoomStep){if(null!=dZoomStep){var mapOptionJson=this.getMapViewOptionJson();null!=mapOptionJson&&null!=mapOptionJson.step&&(mapOptionJson.step=dZoomStep)}};CNetMap.prototype.getSpace=function(){return null!=this._netmapJsWrapper?this._netmapJsWrapper.getSpace():1};CNetMap.prototype.setSpace=function(dZoom){null!=this._netmapJsWrapper&&this._netmapJsWrapper.setSpace(dZoom)};CNetMap.prototype.getImageHighDefinition=function(){if(null==this._diagram)return null;if(null==this._diagram.documentBounds)return null;var d=this._diagram.documentBounds;var properties={background:this.getBackColor(),maxSize:new go.Size(d.width,d.height),type:"image/jpeg",details:1,scale:1};properties=_.extend(properties,{});var imageData=this._diagram.makeImageData(properties);var prefix="data:image/jpeg;base64,";if(imageData&&imageData.length>prefix.length){return imageData.substr(prefix.length)}return""};CNetMap.prototype.getImageBase64=function(notLimited,customOptions){if(null==this._diagram)return null;if(null==this._diagram.documentBounds)return null;var d=this._diagram.documentBounds;var options=_.extend({},customOptions);if(notLimited){options.size=new go.Size(Math.min(d.width,12e3),Math.min(d.height,12e3));options.scale=1}else{var ratioW=customOptions&&customOptions.width?customOptions.width:1500;var ratioH=customOptions&&customOptions.height?customOptions.height:1500;var scale=Math.min(Math.min(ratioW/d.width,ratioH/d.height),1);options.size=new go.Size(d.width*scale,d.height*scale);options.scale=scale}options.width&&delete options.width;options.height&&delete options.height;var mapJPG=this._getImageCore(options);return mapJPG?"data:,"===mapJPG.src?"":mapJPG.src:""};CNetMap.prototype.getContextImageSize=function(){if(null==this._diagram)return null;if(null==this._diagram.documentBounds)return null;var d=this._diagram.documentBounds;var scale=Math.min(Math.min(1500/d.width,1500/d.height),1);return{width:d.width*scale,height:d.height*scale}};CNetMap.prototype.setDisplayMode=function(obj){if(null!=this._netmapJsWrapper&&this.getDisplayMode()!==obj){this._netmapJsWrapper.setDisplayMode(obj);this.setModify(!0)}};CNetMap.prototype.getDisplayMode=function(){if(null!=this._netmapJsWrapper)return this._netmapJsWrapper.getDisplayMode()};CNetMap.prototype.setIsNeatUp=function(obj,dontChangeModify){if(null!=this._netmapJsWrapper&&this.getIsNeatUp()!==obj)if(!0!==dontChangeModify){var transactionName=NgUtil.getUniqueStr("set Is NeatUp");this._diagram.startTransaction(transactionName);this._model.setDataProperty(this._netmapJsWrapper.getRefData(),"isNeatUp",obj);this._diagram.commitTransaction(transactionName);this.setModify(!0)}else this._netmapJsWrapper.setIsNeatUp(obj)};CNetMap.prototype.getIsNeatUp=function(){if(null!=this._netmapJsWrapper)return this._netmapJsWrapper.getIsNeatUp()};CNetMap.prototype.isDisplaySwitchMode=function(){return null!=this._netmapJsWrapper&&this._netmapJsWrapper.getDisplayMode()===netBrain.Map.Const.NetmapDisplayMode.switchMode};CNetMap.prototype.isDisplayPinMode=function(){return null!=this._netmapJsWrapper&&this._netmapJsWrapper.getDisplayMode()===netBrain.Map.Const.NetmapDisplayMode.pinMode};CNetMap.prototype.isMapViewOptionEmpty=function(){var mapViewOptionJsonData=this._netmapJsWrapper.getMapViewOption();return null==mapViewOptionJsonData||null==mapViewOptionJsonData.options};CNetMap.prototype.getMapViewOptionJson=function(){return this._netmapJsWrapper.getMapViewOption()};CNetMap.prototype.setMapViewOptionJson=function(mapViewOptionJson){if(null!=mapViewOptionJson){var temp=JSON.stringify(mapViewOptionJson);mapViewOptionJson=JSON.parse(temp);this._netmapJsWrapper.setMapViewOption(mapViewOptionJson)}else this._netmapJsWrapper.setMapViewOption(this._mapViewOption.toJson())};CNetMap.prototype.setNetMapType=function(netMapType){this._netmapJsWrapper.setNetMapType(netMapType)};CNetMap.prototype.getNetMapType=function(){return this._netmapJsWrapper.getNetMapType()};CNetMap.prototype.getMapId=function(){return this.qMapId};CNetMap.prototype.setMapId=function(obj){this.qMapId=obj};CNetMap.prototype.addAttachment=function(obj){if(null!=this._netmapJsWrapper){if(this._netmapJsWrapper.addAttachment(obj)){this.setModify(!0);return!0}return!1}};CNetMap.prototype.getApplyDataViewInfo=function(){if(null!=this._netmapJsWrapper)return this._netmapJsWrapper.getApplyDataViewInfo()};CNetMap.prototype.setApplyDataViewInfo=function(obj){null!=this._netmapJsWrapper&&this._netmapJsWrapper.setApplyDataViewInfo(obj)};CNetMap.prototype.getApplyDataViewTemplate=function(){return null!=this._netmapJsWrapper?this._netmapJsWrapper.getApplyDataViewTemplate():null};CNetMap.prototype.setApplyDataViewTemplate=function(obj){null!=this._netmapJsWrapper&&this._netmapJsWrapper.setApplyDataViewTemplate(obj)};CNetMap.prototype.removeApplyDataViewTemplate=function(obj){null!=this._netmapJsWrapper&&this._netmapJsWrapper.removeApplyDataViewTemplate(obj)};CNetMap.prototype.clearDataViewTemplate=function(){null!=this._netmapJsWrapper&&this._netmapJsWrapper.clearDataViewTemplate()};CNetMap.prototype.isAppliedDataView=function(){return null!=this._netmapJsWrapper&&this._netmapJsWrapper.isAppliedDataView()};CNetMap.prototype.getLastAppliedDataView=function(){if(null!=this._netmapJsWrapper)return this._netmapJsWrapper.getLastAppliedDataView()};CNetMap.prototype.removeAllAppliedDataViews=function(){null!=this._netmapJsWrapper&&this._netmapJsWrapper.removeAllAppliedDataViewInfos()};CNetMap.prototype.isMonitoring=function(){if(null!=this._netmapJsWrapper)return this._netmapJsWrapper.isMonitoring()};CNetMap.prototype.removeAllAppliedDataViewInfosExceptById=function(dvgId){if(null!=this._netmapJsWrapper)return this._netmapJsWrapper.removeAllAppliedDataViewInfosExceptById(dvgId)};CNetMap.prototype.setIsMonitoring=function(obj){null!=this._netmapJsWrapper&&this._netmapJsWrapper.setIsMonitoring(obj);obj||this.setApplyDVAfterRun(!1)};CNetMap.prototype.isApplyDVAfterRun=function(){return this._isApplyDVAfterRun};CNetMap.prototype.setApplyDVAfterRun=function(obj){this._isApplyDVAfterRun=obj};CNetMap.prototype.getTopologyType=function(){if(null!=this._netmapJsWrapper)return this._netmapJsWrapper.getTopologyType()};CNetMap.prototype.setTopologyType=function(obj){null!=this._netmapJsWrapper&&this._netmapJsWrapper.setTopologyType(obj)};CNetMap.prototype.clone=function(){var json=this.toJson();var newNetMap=new CNetMap;newNetMap.fromJson(json);newNetMap.setDocId(NgUtil.getGUID());newNetMap._diagram=null;newNetMap._model=null;newNetMap.$$hashKey=void 0;return newNetMap};CNetMap.prototype.enableUndoManager=function(){null!=this._diagram&&(this._diagram.undoManager.isEnabled=!0)};CNetMap.prototype.doOpen=function(jsData){var _diagramDiv=jQuery(this._diagram.div);if(null==jsData||null==this._diagram||null==this._model)return!1;var needToFixLinks=function(jsData){var version=jsData.currVersion;return/^7\.0/.test(version)}(jsData);!0===jsData.isFrom6X&&netBrain.Map.fixLinkTools?netBrain.Map.fixLinkTools.prevFixLinksFrom6X(this,jsData):needToFixLinks&&netBrain.Map.fixLinkTools.prevFixLinks(this,jsData);this._netmapJsWrapper.resetJsData(jsData);this.setActive(this._netmapJsWrapper.getActive());this.setDocId(this._netmapJsWrapper.getPageId());this.setTitle(this._netmapJsWrapper.getTitle());var oldskip=this._diagram.skipsUndoManager;this._diagram.startTransaction("doOpen");if(null!=this._diagram){this._diagram.position.x?this._diagram.initialPosition=go.Point.parse(this._netmapJsWrapper.getViewportPosition()||"0 0"):this._diagram.initialPosition=go.Point.parse(-_diagramDiv.width()/2+" "+-_diagramDiv.height()/2);var space=this._netmapJsWrapper.getSpace();null!=space&&this._diagram.commandHandler.initZoom(space)}if(null!=this._model){this._model.undoManager.maxHistoryLength=50;var visualSpaceInfo=this.getVisualSpaceInfo();var nodeList=this._netmapJsWrapper.getNodeDataArray();if(null!=nodeList){var newNodeList=[];for(var i=0;i<nodeList.length;i++){var temp=nodeList[i];if(!visualSpaceInfo&&temp.devNodeData&&!temp.devNodeData.visualSpaceInfo!=!visualSpaceInfo){if(visualSpaceInfo)return!1;visualSpaceInfo=temp.devNodeData.visualSpaceInfo}netBrain.Map.CompPrototypeFactory.buildCompPrototype(temp);newNodeList.push(temp)}this.newNodeList=newNodeList}var linkList=this._netmapJsWrapper.getLinkDataArray();this._diagram.animationManager.isEnabled=!1;if(null!=linkList){var newLinkList=[];for(var j=0;j<linkList.length;j++){var temp1=linkList[j];netBrain.Map.CompPrototypeFactory.buildCompPrototype(temp1);jsData.topologyType===netBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite&&(temp1.category=netBrain.Map.CategoryMgr.SimpleLink);newLinkList.push(temp1)}this.newLinkList=newLinkList}this.checkBigOverviewMap(jsData);this.displaySomeTopologyViewLeafSites(jsData,500);this._model.nodeDataArray=this.newNodeList;this._model.linkDataArray=this.newLinkList;this.setVisualSpaceInfo(visualSpaceInfo)}this.setBackColor(this._netmapJsWrapper.getBkColor());this._resetDiagramReadModel();var needDoSave=!1;if(this.getIsFirstView()&&this.getParentQmap()&&this.getParentQmap().getMapType()!==NetBrain.Map.Const.MapType.overViewMap){var cmdTarget=this.getCmdTarget();cmdTarget&&cmdTarget.onForceDirectedNew();if(null!=this.getNetmapOperator()&&this.getParentQmap()&&this.getParentQmap().getMapType()===NetBrain.Map.Const.MapType.visualSpaceOverViewMap){null==this.getLayoutTools()&&this.setLayoutTools(new NetBrain.Map.LayoutToolsHelper(this.getNetmapOperator()));var layoutTools=this.getLayoutTools();layoutTools.getLayoutStyleById("62adb752-7416-44e4-8d2e-9a55adbf5793").then((function(defaultTemplateStyle){defaultTemplateStyle||(defaultTemplateStyle={_id:"62adb752-7416-44e4-8d2e-9a55adbf5793",name:"SDN-Node-Layout",orientation:"t",type:1,layers:[{maximumDeviceCount:8,scale:2,associateTags:["ipn"]},{maximumDeviceCount:8,scale:2,associateTags:["spine","vrf","epg","outside"]},{maximumDeviceCount:8,scale:2,associateTags:["leaf","subnet","contract"],layerLevel:2},{maximumDeviceCount:8,scale:2,associateTags:["vcenter"],layerLevel:3},{maximumDeviceCount:8,scale:2,associateTags:["other","controller","endsys"],layerLevel:4}]});layoutTools.layoutForSDN(defaultTemplateStyle)}))}var diagram=this._diagram;diagram.viewportBounds.height<diagram.documentBounds.height?diagram.alignDocument(go.Spot.TopLeft,go.Spot.TopLeft):diagram.centerRect(diagram.documentBounds);needDoSave=!0}this.refreshMapViewOptionVisible(void 0,!0);this._diagram.commitTransaction("doOpen");if(needDoSave){this._diagram.links.each((function(link){netBrain.Map.CategoryMgr.isHighlightLink(link.data.category)&&link.invalidateRoute()}));this.layoutLinkLabels();this.doSave();this.setModify(!1)}var isLinkFixed=!1;if(!0===jsData.isFrom6X&&netBrain.Map.fixLinkTools){netBrain.Map.fixLinkTools.fixLinksFrom6X(this,jsData);isLinkFixed=!0}else if(needToFixLinks){netBrain.Map.fixLinkTools.fixLinks(this,jsData);delete jsData.currVersion;isLinkFixed=!0}isLinkFixed&&jsData.l2Style&&!this.isReadOnly()&&(this.isLinkFixed=isLinkFixed);this._diagram.skipsUndoManager=oldskip;return!0};CNetMap.prototype.displaySomeTopologyViewLeafSites=function(jsData,maxLength){if(!this.topologyViewOperator&&jsData.topologyType===netBrain.Map.Const.NetmapTopoLogy.overViewTopologySite){if(!this._model)return;var nodeDataArray=this.newNodeList;var linkDataArray=this.newLinkList;maxLength=maxLength||500;nodeDataArray.length>maxLength&&this.setTopologyViewHideTipMessage(maxLength,nodeDataArray.length);this.topologyViewOperator=new netBrain.Map.SliceOperator(nodeDataArray,linkDataArray,{maxLength:maxLength});var tmpNodeDataArray=this.topologyViewOperator.getNodes();var tmpLinkDataArray=this.topologyViewOperator.getLinks();this.newNodeList=tmpNodeDataArray;this.newLinkList=tmpLinkDataArray}};CNetMap.prototype.displayTopologyViewAllLeafSites=function(){var diagram=this._diagram;if(diagram){if(this._netmapJsWrapper.getTopologyType()===netBrain.Map.Const.NetmapTopoLogy.overViewTopologySite){var topologyViewOperator=this.topologyViewOperator;if(topologyViewOperator){var nodeDataArray=diagram.model.nodeDataArray;var overageNodes=topologyViewOperator.getOverageNodes(nodeDataArray);var overageLinks=topologyViewOperator.getOverageLinks(nodeDataArray);if(0!==overageNodes.length||0!==overageLinks.length){diagram.startTransaction("displayAllLeafSites");diagram.model.addNodeDataCollection(overageNodes);diagram.model.addLinkDataCollection(overageLinks);this.refreshMapViewOptionVisible();diagram.commitTransaction("displayAllLeafSites")}}}}};var compileTopologyViewHideTipMessage=_.template(NetBrain.Map.Message.ShowBigOverviewTipCompileTopologyView);CNetMap.prototype.setTopologyViewHideTipMessage=function(maxLength,actualLength){var tipMessage=compileTopologyViewHideTipMessage({max:maxLength,actual:actualLength});this.getCurrentScope().showBigTopologyViewTip(tipMessage,!0)};CNetMap.prototype.checkBigOverviewMap=function(jsData){if(function(jsData){return jsData.topologyType===netBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite}(jsData)&&this.hasBigData()){var actualSitesCount=this.newNodeList.length;this.hideMoreSite();this.setHideSiteNote(actualSitesCount);this._diagram.updateAllTargetBindings()}};CNetMap.prototype.hideMoreSite=function(){var rootSite=this.findRootSite();this.linkDic=this.createLinkDic();this.nodeDic=this.createNodeDic();this.nodeLinkDic=this.createNodeLinkDic();this.checkByLevel([rootSite.key],1);this.newLinkList=this.removeHideSiteLinks();this.linkDic=this.nodeDic=this.nodeLinkDic=null};CNetMap.prototype.removeHideSiteLinks=function(){var nodeLinkDic=this.nodeLinkDic;return _.partition(this.newLinkList,(function(link){return nodeLinkDic[link.to]}))[0]};CNetMap.prototype.createLinkDic=function(){var linkDic=createEmptyDic();var links=this.newLinkList;_.each(links,(function(link){var from=link.from;linkDic[from]||(linkDic[from]=createEmptyDic());linkDic[from][link.to]=!0}));return linkDic};CNetMap.prototype.createNodeLinkDic=function(){var linkDic=createEmptyDic();var links=this.newLinkList;_.each(links,(function(link){linkDic[link.to]=link}));return linkDic};CNetMap.prototype.createNodeDic=function(){var nodeDic=createEmptyDic();var nodes=this.newNodeList;_.each(nodes,(function(node){nodeDic[node.key]=node}));return nodeDic};function createEmptyDic(){return Object.create(null)}CNetMap.prototype.checkByLevel=function(currentLevelSites,total){for(;total<2e3;){var result=this.checkOneLevel(currentLevelSites,total);if(!result)return;currentLevelSites=result.nextLevelSites;total=result.total}};CNetMap.prototype.checkOneLevel=function(currentLevelSites,total){var nextLevelSites=[];var currentSite=null;for(;currentSite=currentLevelSites.shift();){var childrenSites=this.getChildrenSites(currentSite);if(!(total+childrenSites.length<=2e3)){var canShow=2e3-total;var splitedSites=this.splitSitesShowAndHide(childrenSites,canShow);this.hideSites(currentSite,splitedSites.hideSites);this.collapseSites(currentLevelSites);nextLevelSites=nextLevelSites.concat(splitedSites.showSites);this.collapseSites(nextLevelSites);return}total+=childrenSites.length;nextLevelSites=nextLevelSites.concat(childrenSites)}return{nextLevelSites:nextLevelSites,total:total}};CNetMap.prototype.collapseSites=function(sites){sites.forEach((function(site){var childrenSites=this.getChildrenSites(site);if(childrenSites.length>0){this.nodeDic[site].defaultExpand=!1;this.hideSites(site,childrenSites)}}),this)};CNetMap.prototype.hideSites=function(currentSite,hideSitesSeed){var allHideSiteDic=this.getAllHideSitesDic(hideSitesSeed);var spliteSites=_.partition(this.newNodeList,(function(site){return allHideSiteDic[site.key]}));this.nodeDic[currentSite].removeChildren=spliteSites[0];this.nodeDic[currentSite].removeLinks=this.removeLinks(currentSite);this.newNodeList=spliteSites[1]};CNetMap.prototype.removeLinks=function(currentSite){var nodeLinkDic=this.nodeLinkDic;var removeNodes=this.nodeDic[currentSite].removeChildren;var removeLinks=[];_.each(removeNodes,(function(node){removeLinks.push(nodeLinkDic[node.key]);nodeLinkDic[node.key]=!1}));return removeLinks};CNetMap.prototype.getAllHideSitesDic=function(hideSitesSeed){var hideSitesDic=createEmptyDic();var seed=hideSitesSeed;var nextSeed;for(;seed.length>0;){nextSeed=[];_.each(seed,(function(key){hideSitesDic[key]=!0;nextSeed=nextSeed.concat(this.getChildrenSites(key))}),this);seed=nextSeed}return hideSitesDic};CNetMap.prototype.splitSitesShowAndHide=function(childrenSites,canShow){var sortedSites=this.sortByChildren(childrenSites);return{showSites:sortedSites.splice(0,canShow),hideSites:sortedSites}};CNetMap.prototype.sortByChildren=function(sites){var self=this;var nodeDic=this.nodeDic;return sites.sort((function(a,b){var aChildrenCount=self.getChildrenSites(a).length;var bChildrenCount=self.getChildrenSites(b).length;return aChildrenCount!==bChildrenCount?bChildrenCount-aChildrenCount:nodeDic[b].deviceCount-nodeDic[a].deviceCount}))};CNetMap.prototype.getChildrenSites=function(key){return _.keys(this.linkDic[key])};CNetMap.prototype.findRootSite=function(){return _.find(this.newNodeList,(function(site){return site.isRoot()}))};var compileHideSiteTipMessage=_.template(NetBrain.Map.Message.ShowBigOverviewTip);CNetMap.prototype.setHideSiteNote=function(siteCount){var tipMessage=compileHideSiteTipMessage({max:2e3,actual:siteCount});this.getCurrentScope().showBigOverviewTip(tipMessage)};CNetMap.prototype.hasBigData=function(){return this.newNodeList.length>2e3};CNetMap.prototype.getGoJsDiagram=function(){return this._diagram};CNetMap.prototype._resetDiagramReadModel=function(){if(null!=this._diagram){this._diagram.isReadOnly=this.isReadOnly();this._diagram.isModelReadOnly=this.isReadOnly()}};CNetMap.prototype._getSelectedDeviceId=function(){for(var it=this._diagram.selection.iterator;it.next();){var currSelected=it.value;if(currSelected instanceof go.Node)return currSelected.data.key}return null};CNetMap.prototype._getSelectedDeviceName=function(){for(var it=this._diagram.selection.iterator;it.next();){var currSelected=it.value;if(currSelected instanceof go.Node)return currSelected.data.getName()}return null};CNetMap.prototype._getImageCore=function(customOptions){if(null==this._diagram)return null;if(null==this._diagram.documentBounds)return null;var d=this._diagram.documentBounds;var properties={background:this.getBackColor(),maxSize:new go.Size(d.width,d.height),details:1,scale:1};properties=_.extend(properties,customOptions);return this._diagram.makeImage(properties)};CNetMap.prototype._addNode=function(nodeData){if(null!=nodeData&&null!=nodeData.category)if(!nodeData.devNodeData||this.setVisualSpaceInfo(nodeData.devNodeData.visualSpaceInfo)){if(null==this._model.findNodeDataForKey(nodeData.key)){var transactionName=NgUtil.getUniqueStr("add node");this._diagram.startTransaction(transactionName);this._model.addNodeData(nodeData);this._diagram.commitTransaction(transactionName);this.setModify(!0)}}else this.getNetmapOperator().log};CNetMap.prototype._removeNode=function(nodeData){if(null!=nodeData&&null!=this._model.findNodeDataForKey(nodeData.key)){var transactionName=NgUtil.getUniqueStr("remove node");this._diagram.startTransaction(transactionName);var node=this._diagram.findNodeForKey(nodeData.key);if(null!=node){var links=node.linksConnected;this._model.removeNodeData(nodeData);var linkDatas=[];links.each((function(link){null!=link.diagram&&linkDatas.push(link.data)}));_.each(linkDatas,this._removeLink.bind(this))}this._diagram.commitTransaction(transactionName);this.setModify(!0)}};CNetMap.prototype._isExistNode=function(nodeData){return null!=this._model.findNodeDataForKey(nodeData.key)};CNetMap.prototype._highlightNode=function(node,$q){if(node.category!==netBrain.Map.CategoryMgr.UnknownIp){var self=this;var tempImgList1;var tempImgList2;var compDev=self._diagram.findNodeForKey(node.key);if(compDev){node._netmap&&delete node._netmap;var tempNode=angular.copy(node);var iconImagePath=NetBrain.NG.Const.iconImagePath;var objImage=compDev.findObject("IMAGE");objImage&&(tempImgList1=objImage.source);if(node.category&&"Media"==node.category)tempImgList2="Wan"==node.devType?iconImagePath+"00000000-0000-0000-0000-0000000000b6.png":"Dmvpn"==node.devType?iconImagePath+"00000000-0000-0000-0000-000000000057.png":"Lan"==node.devType?iconImagePath+"00000000-0000-0000-0000-000000000083.png":"Bus"==node.devType?iconImagePath+"00000000-0000-0000-0000-0000000000c1.png":iconImagePath+"00000000-0000-0000-0000-000000000083.png";else if(node.category&&"Site"===node.category)tempImgList2=iconImagePath+"00000000-0000-0000-0000-0000000000bf.png";else if(node.category&&"Cluster"===node.category)tempImgList2=iconImagePath+"00000000-0000-0000-0000-0000000000bd.png";else if(5===tempNode.dataViewData.devGraphicInfo.imageList.length){tempNode.dataViewData.devGraphicInfo.imageList.splice(0,4);tempImgList2=NetBrain.deviceIcon.getIconStreamURIById(tempNode.dataViewData.devGraphicInfo.imageList[0].name)}else tempImgList2=0===tempNode.dataViewData.devGraphicInfo.imageList.length?iconImagePath+"Unclassified Router_CheckFail.png":NetBrain.deviceIcon.getIconStreamURIById(tempNode.dataViewData.devGraphicInfo.imageList[0].name);compDev.Inteval=1;if(!compDev.flag){!function toDo(){if(!self._diagram)return;var objImage=compDev.findObject("IMAGE");if(objImage&&objImage.source!==tempImgList2&&objImage.source!==tempImgList1){compDev.flag=!1;$q&&$q.resolve();return}if(compDev.Inteval>6){compDev.flag=!1;$q&&$q.resolve();return}compDev.Inteval%2?function(){var objImage=compDev.findObject("IMAGE");if(objImage){var oldskip=self._diagram.skipsUndoManager;self._diagram.skipsUndoManager=!0;objImage.source=tempImgList2;self._diagram.skipsUndoManager=oldskip}}():function(){var objImage=compDev.findObject("IMAGE");if(objImage){var oldskip2=self._diagram.skipsUndoManager;self._diagram.skipsUndoManager=!0;objImage.source=tempImgList1;self._diagram.skipsUndoManager=oldskip2}}();setTimeout((function(){compDev.Inteval++;toDo()}),500)}();compDev.flag=!0}return}}};CNetMap.prototype._getCompDeviceByKey=function(key){return null==this._model?null:this._model.findNodeDataForKey(key)};CNetMap.prototype._getGraphDeviceByKey=function(key){return null==this._diagram?null:this._diagram.findNodeForKey(key)};CNetMap.prototype._isExistDeviceByHostname=function(hostName){if(null==hostName)return!1;var nodes=this._model.nodeDataArray;for(var index=0;index<nodes.length;index++){var node=nodes[index];if(netBrain.Map.CategoryMgr.isNetworkDevice(node.getCategory())&&node.getHostname()===hostName)return!0}return!1};CNetMap.prototype._centerNode=function(nodeData,skipsSelectNode){if(null!=nodeData){var destObject=this._diagram.findNodeForKey(nodeData.key);if(null!=destObject){!0!==skipsSelectNode&&this._diagram.select(destObject);this._diagram.centerRect(destObject.actualBounds)}}};CNetMap.prototype._selectNodes=function(selectNodeDataArray){var diagram=this._diagram;if(diagram&&_.isArray(selectNodeDataArray)){var selectNodeSet=new go.Set;selectNodeDataArray.forEach((function(nodeData){var node=diagram.findNodeForKey(nodeData.key);node&&selectNodeSet.add(node)}));diagram.selectCollection(selectNodeSet)}};CNetMap.prototype._centerPathDevice=function(destObject){null!=destObject&&this._diagram.centerRect(destObject.actualBounds)};CNetMap.prototype._findProperNeighborPosition=function(srcDevJsonObj,distance){var ptPosRet=null;var compDev=this._model.findNodeDataForKey(srcDevJsonObj.key);var loc=null==compDev?"200 200":compDev.getLocation();if(null!=loc){var ptPos=go.Point.parse(loc);var ptDistance=distance||60;ptPosRet=netBrain.Map.GoDiagramPositionUtil.findProperZoomPosByTargetOriginPos(this._diagram,ptPos,ptDistance);ptPosRet=netBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(ptPosRet,this._diagram)}return ptPosRet};CNetMap.prototype._addLink=function(linkData){if(null!=linkData&&null!=linkData.category){netBrain.Map.CategoryMgr.isTopolink(linkData.category)&&(linkData.intfSrc||linkData.intfDest||(linkData.intfSrc={}));var transactionName=NgUtil.getUniqueStr("add link");this._diagram.startTransaction(transactionName);this._model.addLinkData(linkData);this._diagram.commitTransaction(transactionName);this.setModify(!0)}};CNetMap.prototype._removeLink=function(linkData){if(null!=linkData){var transactionName=NgUtil.getUniqueStr("remove link");this._diagram.startTransaction(transactionName);this._model.removeLinkData(linkData);this._diagram.commitTransaction(transactionName);this.setModify(!0)}};CNetMap.prototype._getLinkByData=function(linkData){return null==linkData?null:this._diagram.findLinkForData(linkData)};CNetMap.prototype._clearAllSelection=function(){var it=this._diagram.selection.iterator;var array=[];for(;it.next();)array.push(it.value);_.each(array,(function(item){item.isSelected=!1}))};CNetMap.prototype._getLinkByKey=function(key){if(null==key)return null;var linkData=this._getLinkDataByKey(key);return this._diagram.findLinkForData(linkData)};CNetMap.prototype._getLinkDataByKey=function(key){if(null==key)return null;for(var i in this._model.linkDataArray)if(this._model.linkDataArray.hasOwnProperty(i)){var linkData=this._model.linkDataArray[i];if(linkData.getKey()===key)return linkData}return null};CNetMap.prototype._updateNormalLink=function(normalLinkData){if(normalLinkData){var transactionName=NgUtil.getUniqueStr("update normal link");this._diagram.startTransaction(transactionName);this._model.removeLinkData(normalLinkData);normalLinkData.points=null;this._model.addLinkData(normalLinkData);this._diagram.commitTransaction(transactionName);this.setModify(!0)}};CNetMap.prototype._updateLink=function(compLink){if(null!=compLink){var linkData=this._getLinkDataByKey(compLink.getKey());var transactionName=NgUtil.getUniqueStr("update link");this._diagram.startTransaction(transactionName);if(null!=linkData){compLink.setColor(linkData.getColor());compLink.setDiff(linkData.getDiff());this._model.removeLinkData(linkData)}this._model.addLinkData(compLink);this._diagram.commitTransaction(transactionName);this.setModify(!0)}};CNetMap.prototype._getAllDevices=function(bExcludeMedia){var nodes=this._model.nodeDataArray;var devices=[];for(var index=0;index<nodes.length;index++){var node=nodes[index];if(netBrain.Map.CategoryMgr.isNetworkDevice(node.getCategory())){if(bExcludeMedia&&null!=node.getDevType()&&netBrain.Map.gMediaTypeMgr.isMediaType(node.getDevType()))continue;devices.push(node)}}return devices};CNetMap.prototype._getAllSites=function(bExcludeMedia){var nodes=this._model.nodeDataArray;var sites=[];for(var index=0;index<nodes.length;index++){var node=nodes[index];if(netBrain.Map.CategoryMgr.isSite(node.getCategory())){if(bExcludeMedia&&null!=node.getDevType()&&netBrain.Map.gMediaTypeMgr.isMediaType(node.getDevType()))continue;sites.push(node)}}return sites};CNetMap.prototype._getAllDevicesByFilter=function(bExcludeMedia,callbackFilter){var nodes=this._model.nodeDataArray;var devices=[];for(var index=0;index<nodes.length;index++){var node=nodes[index];if(netBrain.Map.CategoryMgr.isNetworkDevice(node.getCategory())){if(bExcludeMedia&&null!=node.getDevType()&&netBrain.Map.gMediaTypeMgr.isMediaType(node.getDevType()))continue;if(callbackFilter&&!callbackFilter(node))continue;devices.push(node)}}return devices};CNetMap.prototype._getAllDrawObjectsByFilter=function(callbackFilter){var arrNode=this._model.nodeDataArray;var arrDrawObject=[];for(var index=0;index<arrNode.length;index++){var objNode=arrNode[index];if(objNode instanceof netBrain.Map.DrawObject){if(callbackFilter&&!callbackFilter(objNode))continue;arrDrawObject.push(objNode)}}return arrDrawObject};CNetMap.prototype._getSelectDrawObjectsByFilter=function(callbackFilter){var diagram=this._diagram;var nodes=[];diagram.selection.each((function(e){if(e.data&&e instanceof go.Node){if(callbackFilter&&!callbackFilter(e))return!0;nodes.push(e.data)}}));return nodes};CNetMap.prototype.getSelectedLinks=function(){var links=[];this._diagram.selection.each((function(item){item.data&&item instanceof go.Link&&links.push(item)}));return links};CNetMap.prototype._getGrapghObjectsByFilter=function(callbackFilter){var diagram=this._diagram;var nodes=[];diagram.nodes.each((function(e){if(e instanceof go.Node){if(callbackFilter&&!callbackFilter(e))return!0;nodes.push(e)}}));return nodes};CNetMap.prototype._getAllTopoLink=function(){var links=this._model.linkDataArray;var topoLinks=[];for(var index=0;index<links.length;index++){var oneLink=links[index];null!=oneLink&&(netBrain.Map.CategoryMgr.isTopolink(oneLink.category)&&topoLinks.push(oneLink))}return topoLinks};CNetMap.prototype._getAllNormalLink=function(){var links=this._model.linkDataArray;var topoLinks=[];for(var index=0;index<links.length;index++){var oneLink=links[index];null!=oneLink&&(netBrain.Map.CategoryMgr.isNormalLink(oneLink.category)&&topoLinks.push(oneLink))}return topoLinks};CNetMap.prototype._getAllTopoLinksByFilter=function(callbackFilter){var links=this._model.linkDataArray;var topoLinks=[];for(var index=0;index<links.length;index++){var oneLink=links[index];null!=oneLink&&(netBrain.Map.CategoryMgr.isTopolink(oneLink.category)&&(callbackFilter&&!callbackFilter(oneLink)||topoLinks.push(oneLink)))}return topoLinks};CNetMap.prototype._getAllLinksByFilter=function(callbackFilter){var links=this._model.linkDataArray;var topoLinks=[];for(var index=0;index<links.length;index++){var oneLink=links[index];null!=oneLink&&(callbackFilter&&!callbackFilter(oneLink)||topoLinks.push(oneLink))}return topoLinks};CNetMap.prototype._getAllPathsByFilter=function(callbackFilter){var links=this._model.linkDataArray;var topoLinks=[];for(var index=0;index<links.length;index++){var oneLink=links[index];null!=oneLink&&(netBrain.Map.CategoryMgr.isPath(oneLink.category)&&(callbackFilter&&!callbackFilter(oneLink)||topoLinks.push(oneLink)))}return topoLinks};CNetMap.prototype._getTopoLinksByDevId=function(devId){if(null==devId)return null;var links=this._model.linkDataArray;var topoLinks=[];for(var index=0;index<links.length;index++){var oneLink=links[index];null!=oneLink&&(netBrain.Map.CategoryMgr.isTopolink(oneLink.category)&&(oneLink.getFromKey()!==devId&&oneLink.getToKey()!==devId||topoLinks.push(oneLink)))}return topoLinks};CNetMap.prototype._switchViewFromDevice=function(compNewDev,bForce){if(null!=compNewDev){var compOldDev=this._model.findNodeDataForKey(compNewDev.getKey());if(null!=compOldDev&&(bForce||compOldDev.getDataViewGroupId()!==compNewDev.getDataViewGroupId())){var newIntfInfo=compNewDev.getIntfInfoList();var oldIntfInfo=compOldDev.getIntfInfoList();var oldIntfKeys=_.map(oldIntfInfo,(function(p){return p.intf.intfKeyObj.value}));var newIntfKyes=_.map(newIntfInfo,(function(p){return p.intf.intfKeyObj.value}));var diffKeys=_.difference(oldIntfKeys,newIntfKyes);_.each(oldIntfInfo,(function(p){if(_.contains(diffKeys,p.intf.intfKeyObj.value)){p.intfGraphicInfo={};p.intfHighlightList=[];p.intfPosList=[];p.intfColorSchema={};p.intfNotes=[]}}));if(!compNewDev.isDefaultDataView()){var oldDevGraphicInfo=compOldDev.getDevGraphicInfo();compNewDev.setDevGraphicInfo(oldDevGraphicInfo)}compOldDev.setDataViewData(compNewDev.getDataViewData());compOldDev.dataViewData.intfInfoList=oldIntfInfo;var noSetArr=[];for(var i=0,len=newIntfInfo.length;i<len;i++)if(newIntfInfo[i].intf){var key=newIntfInfo[i].intf.intfKeyObj.value;var tmpInfo=_.find(oldIntfInfo,(function(oii){return(oii.intfInfo?oii.intfInfo:oii.intfDataView?oii.intfDataView.intfInfo:oii).intf.intfKeyObj.value===key}));if(tmpInfo&&tmpInfo.intf){var intfNodeData=tmpInfo.intf.intfNodeData||newIntfInfo[i].intf.intfNodeData;tmpInfo.intf={};tmpInfo.intfGraphicInfo={};tmpInfo.intfHighlightList=[];tmpInfo.intfPosList=[];tmpInfo.intfColorSchema={};tmpInfo.intfNotes=[];_.extend(tmpInfo,newIntfInfo[i]);tmpInfo.intf.intfNodeData=intfNodeData}else{var tmpObj=newIntfInfo[i];noSetArr.push(tmpObj)}}var map=this._diagram;var oldskip=map.skipsUndoManager;map.skipsUndoManager=!0;this._model.updateTargetBindings(compOldDev);noSetArr.length>0&&this.isL2MapStyle()&&map.rebuildParts();this.setModify(!0);map.skipsUndoManager=oldskip}}};CNetMap.prototype.isOptionDisplayByPosName=function(strPosName){if(null==strPosName)return!0;if(!this.getMapViewOptionJson())return!0;var ret=this.getMapViewOptionJson().options.find((function(item){return item.posName===strPosName}));return null==ret||ret.display};CNetMap.prototype.getOptionScaleByPosName=function(strPosName){if(null==strPosName)return 0;if(!this.getMapViewOptionJson())return!0;var ret=this.getMapViewOptionJson().options.find((function(item){return item.posName===strPosName}));return null==ret?0:ret.scaleThreshold};CNetMap.prototype.checkLinkLabelsVisible=function(link,curSpace){for(var it=link.elements;it.next();){var ele=it.value;if(ele instanceof go.Panel)for(var itt=ele.elements;itt.next();){var elee=itt.value;if(elee instanceof go.Panel){if(!1===NgUtil.getValueFromObjAndPath(elee.data,"posInfo.dataUnitList.0.valueEx.isVisiable"))continue;if(!1===elee.overflowVisible)continue;elee.data&&elee.data.posName&&(null!=elee.data.posInfo&&elee.data.posInfo.displayInfo||elee.data.extraData)&&(this.isOptionDisplayByPosName(elee.data.posName)?elee.visible=curSpace>=this.getOptionScaleByPosName(elee.data.posName):elee.visible=!1)}}}var elePanel1=link.findObject(netBrain.Map.CompTopolink.srcInftNameLabel);null!=elePanel1&&null!=elePanel1.part.data&&null!=elePanel1.part.data.getSrcDisplayInfo()&&""!==elePanel1.part.data.getSrcDisplayInfo()&&(this.isOptionDisplayByPosName("intfPos0")?elePanel1.visible=curSpace>=this.getOptionScaleByPosName("intfPos0"):elePanel1.visible=!1);var elePanel2=link.findObject(netBrain.Map.CompTopolink.destInftNameLabel);null!=elePanel2&&null!=elePanel2.part.data&&null!=elePanel2.part.data.getDestDisplayInfo()&&""!==elePanel2.part.data.getDestDisplayInfo()&&(this.isOptionDisplayByPosName("intfPos0")?elePanel2.visible=curSpace>=this.getOptionScaleByPosName("intfPos0"):elePanel2.visible=!1)};CNetMap.prototype.checkDeviceLabelsVisible=function(node,curSpace){var elePanel1=node.findObject(netBrain.Map.CompDevice.devPosInfoLabelPanel);if(null!=elePanel1)for(var itPanel1=elePanel1.elements;itPanel1.next();){var elePanel2=itPanel1.value;if(null!=elePanel2&&elePanel2 instanceof go.Panel){if(!1===NgUtil.getValueFromObjAndPath(elePanel2.data,"posInfo.dataUnitList.0.valueEx.isVisiable"))continue;if(!1===elePanel2.overflowVisible)continue;for(var itPanel2=elePanel2.elements;itPanel2.next();){var eleText=itPanel2.value;null!=eleText&&(eleText instanceof go.TextBlock&&elePanel2.data&&elePanel2.data.posName&&(elePanel2.data.posInfo&&(elePanel2.data.posInfo.displayInfo||""===elePanel2.data.posInfo.displayInfo)||elePanel2.data.extraData)&&(this.isOptionDisplayByPosName(elePanel2.data.posName)?elePanel2.visible=curSpace>=this.getOptionScaleByPosName(elePanel2.data.posName):elePanel2.visible=!1))}}}var elePanel3=node.findObject(netBrain.Map.CompDevice.hostNameLable);null!=elePanel3&&(this.isOptionDisplayByPosName("devHostName")?elePanel3.visible=curSpace>=this.getOptionScaleByPosName("devHostName"):elePanel3.visible=!1)};CNetMap.prototype.checkDeviceNoteVisible=function(node,curSpace){node.category===netBrain.Map.CategoryMgr.DeviceNote&&null!=node.data&&(this.isOptionDisplayByPosName("devNote")?node.visible=curSpace>=this.getOptionScaleByPosName("devNote"):node.visible=!1)};CNetMap.prototype.checkDrawShapesVisible=function(node,curSpace){if(netBrain.Map.CategoryMgr.isOtherShapesCategory(node.category)){var posName=DataViewPosName.otherDrawShapes;this.isOptionDisplayByPosName(posName)?node.visible=curSpace>=this.getOptionScaleByPosName(posName):node.visible=!1}};CNetMap.prototype.checkL2DeviceBound=function(node){null!=node.calcBounds&&node.calcBounds()};CNetMap.prototype.layoutLinkLabels=function(isAll){new netBrain.Map.LinkLableLayoutTool(this._diagram).LayOut(this._diagram,isAll)};CNetMap.prototype.layoutL2Ports=function(devicePortsInfo){new netBrain.Map.L2PortsLayoutTool(this._diagram,this).layout(devicePortsInfo)};CNetMap.prototype.redrawPath=function(){netBrain.Map.DiagramPathManager.redrawPath(this._diagram)};CNetMap.prototype.refreshMapViewOptionVisible=function(bSkipTransaction,withoutPortLayout,zoomSpace){if(!(this.getTopologyType()===netBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite)){var map=this._diagram;var oldskip=map.skipsUndoManager;map.skipsUndoManager=!0;null!=bSkipTransaction&&bSkipTransaction||this._diagram.startTransaction("refreshMapViewOptionVisible");var curSpace=zoomSpace||map.commandHandler.space;var node,link;if(this.isL2MapStyle()){for(var k=0;k<map.model.nodeDataArray.length;k++){if(null===map.model.nodeDataArray[k])return;node=map.findNodeForData(map.model.nodeDataArray[k]);this.checkDeviceLabelsVisible(node,curSpace);this.checkDeviceNoteVisible(node,curSpace);this.checkDrawShapesVisible(node,curSpace);this.checkL2DeviceBound(node)}for(var m=0;m<map.model.linkDataArray.length;m++){if(null===map.model.linkDataArray[m])return;if(!(link=map.findLinkForData(map.model.linkDataArray[m])))break;this.checkLinkLabelsVisible(link,curSpace)}}else{for(var i=0;i<map.model.nodeDataArray.length;i++){if(null===map.model.nodeDataArray[i])return;node=map.findNodeForData(map.model.nodeDataArray[i]);this.checkDeviceLabelsVisible(node,curSpace);this.checkDeviceNoteVisible(node,curSpace);this.checkDrawShapesVisible(node,curSpace)}for(var j=0;j<map.model.linkDataArray.length;j++){if(null===map.model.linkDataArray[j])return;if(!(link=map.findLinkForData(map.model.linkDataArray[j])))break;this.checkLinkLabelsVisible(link,curSpace)}}null!=bSkipTransaction&&bSkipTransaction||this._diagram.commitTransaction("refreshMapViewOptionVisible");this.layoutLinkLabels();map.skipsUndoManager=oldskip}};CNetMap.prototype._drawDeviceHighlight=function(data){var diagram=this._diagram;if(null!=diagram){var model=this._model;if(null!=model){var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("drawDeviceHighlight");diagram.startTransaction(transactionName);var compDevice=this._getCompDeviceByKey(data.devId);var hlList=compDevice.getHighlightDataList();if(null==hlList||!1===data.append){hlList=[];model.setDataProperty(compDevice,"highlightDataList",hlList)}if(null!=hlList){model.addArrayItem(hlList,data);model.updateTargetBindings(compDevice,"highlightDataList")}diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;this.setModify(!0)}}};CNetMap.prototype._drawLinkHighlightNew=function(datas,interfaceData){if(datas){var data=datas[0];var diagram=this._diagram;if(null!=diagram){var model=this._model;if(null!=model){var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("drawLinkHighlight");diagram.startTransaction(transactionName);var links=this._getTopoLinksByDevId(data.devId);for(var i in links)if(links.hasOwnProperty(i)){var compLink=links[i];var result=compLink.isEqualLinkLineByData(data.devId,interfaceData,data.topoType);var hlList=null;if(0===result)continue;if(1===result){if(null==(hlList=compLink.getHighlightDataListSrc())||!1===data.append){hlList=[];compLink.setHighlightDataListSrc(hlList);model.setDataProperty(compLink,"intfSrc",compLink.intfSrc)}null!=hlList&&compLink.setHighlightDataListSrc(hlList.concat(datas))}else if(2===result){if(null==(hlList=compLink.getHighlightDataListDest())||!1===data.append){hlList=[];compLink.setHighlightDataListDest(hlList);model.setDataProperty(compLink,"intfDest",compLink.intfDest)}null!=hlList&&compLink.setHighlightDataListDest(hlList.concat(datas))}var link=diagram.findLinkForData(compLink);null!=link&&link.invalidateRoute()}diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;this.setModify(!0)}}}};CNetMap.prototype._drawLinkHighlight=function(data){var diagram=this._diagram;if(null!=diagram){var model=this._model;if(null!=model){var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("drawLinkHighlight");diagram.startTransaction(transactionName);var links=this._getTopoLinksByDevId(data.devId);for(var i in links)if(links.hasOwnProperty(i)){var compLink=links[i];var result=compLink.isEqualLinkLineByData(data.devId,data.intf,data.topoType);var hlList=null;if(0===result)continue;if(1===result){if(null==(hlList=compLink.getHighlightDataListSrc())||!1===data.append){hlList=[];model.setDataProperty(compLink,"highlightDataListSrc",hlList)}null!=hlList&&model.addArrayItem(hlList,data)}else if(2===result){if(null==(hlList=compLink.getHighlightDataListDest())||!1===data.append){hlList=[];model.setDataProperty(compLink,"highlightDataListDest",hlList)}null!=hlList&&model.addArrayItem(hlList,data)}var link=diagram.findLinkForData(compLink);null!=link&&link.invalidateRoute()}diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;this.setModify(!0)}}};CNetMap.prototype._clearDrawHighlight=function(){var diagram=this._diagram;if(null!=diagram){var model=this._model;if(null!=model){var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("clearDrawHighlight");diagram.startTransaction(transactionName);var nodes=model.nodeDataArray;for(var index=0;index<nodes.length;index++){var node=nodes[index];netBrain.Map.CategoryMgr.isNetworkDevice(node.getCategory())&&null!=node.getHighlightDataList()&&model.setDataProperty(node,"highlightDataList",null)}var hlLinks=[];var links=model.linkDataArray;for(index=0;index<links.length;index++){var oneLink=links[index];if(netBrain.Map.CategoryMgr.isHighlightLink(oneLink.category))hlLinks.push(oneLink);else if(netBrain.Map.CategoryMgr.isTopolink(oneLink.category)){null!=oneLink.getHighlightDataListSrc()&&model.setDataProperty(oneLink,"highlightDataListSrc",null);null!=oneLink.getHighlightDataListDest()&&model.setDataProperty(oneLink,"highlightDataListDest",null)}}for(var i in hlLinks)hlLinks.hasOwnProperty(i)&&model.removeLinkData(hlLinks[i]);diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;this.setModify(!0)}}};CNetMap.prototype._setDeviceHighlightColor=function(legendName,color){var diagram=this._diagram;if(null!=diagram){var model=this._model;if(null!=model){var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("setDeviceHighlightColor");diagram.startTransaction(transactionName);var nodes=model.nodeDataArray;var newColor=netBrain.Map.randomColorSrvc.getIntColor(color);for(var index=0;index<nodes.length;index++){var node=nodes[index];if(netBrain.Map.CategoryMgr.isNetworkDevice(node.getCategory())){var list=node.getHighlightDataList();if(null!=list){for(var i=0;i<list.length;i++){var object=list[i];legendName===getLegendName(object)&&model.setDataProperty(object,"color",newColor)}model.updateTargetBindings(node,"color")}}}diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;this.setModify(!0)}}};CNetMap.prototype._setLinkHighlightColor=function(legendName,color){var diagram=this._diagram;if(null!=diagram){var model=this._model;if(null!=model){var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("setLinkHighlightColor");diagram.startTransaction(transactionName);var newColor=netBrain.Map.randomColorSrvc.getIntColor(color);var links=model.linkDataArray;var object;for(var index=0;index<links.length;index++){var oneLink=links[index];if(netBrain.Map.CategoryMgr.isTopolink(oneLink.category)){var srcList=oneLink.getHighlightDataListSrc();if(null!=srcList)for(var i=0;i<srcList.length;i++)legendName===getLegendName(object=srcList[i])&&model.setDataProperty(object,"color",newColor);var destList=oneLink.getHighlightDataListDest();if(null!=destList)for(var j=0;j<destList.length;j++)legendName===getLegendName(object=destList[j])&&model.setDataProperty(object,"color",newColor);model.updateTargetBindings(oneLink,"color")}}diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;this.setModify(!0)}}};CNetMap.prototype._setPortHighlightColor=function(legendName,color){var diagram=this._diagram;if(null!=diagram){var model=this._model;if(null!=model){var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("setPortHighlightColor");diagram.startTransaction(transactionName);var newColor=netBrain.Map.randomColorSrvc.getIntColor(color);_.each(model.nodeDataArray,(function(nodeData){if(netBrain.Map.CategoryMgr.isNetworkDevice(nodeData.category)){var highlightList=nodeData.getIntfInfoHighlightList();_.each(highlightList,(function(hl){legendName===getLegendName(hl)&&model.setDataProperty(hl,"color",newColor)}));model.updateTargetBindings(nodeData,"color")}}));diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;this.setModify(!0)}}};CNetMap.prototype._setNeighborHighlightColor=function(legend,color){var diagram=this._diagram;if(null!=diagram){var model=this._model;if(null!=model){var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("setNeighborHighlightColor");diagram.startTransaction(transactionName);var newColor=netBrain.Map.randomColorSrvc.getIntColor(color);var links=model.linkDataArray;for(var index=0;index<links.length;index++){var oneLink=links[index];netBrain.Map.CategoryMgr.isHighlightNeighborLink(oneLink.category)&&(oneLink.legend===legend&&model.setDataProperty(oneLink,"color",newColor))}diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;this.setModify(!0)}}};CNetMap.prototype._redo=function(){null!=this._diagram&&this._diagram.redo()};CNetMap.prototype._undo=function(){null!=this._diagram&&this._diagram.undo()};CNetMap.prototype._getSelectNodeId=function(){this._diagram.selection.each((function(e){if(e.data&&e instanceof go.Node)return e.data.getKey()}));return null};CNetMap.prototype._getSelectNodesByCategory=function(category){var diagram=this._diagram;var nodes=[];diagram.selection.each((function(e){e.data&&e.data.getCategory()===category&&nodes.push(e.data)}));return nodes};CNetMap.prototype._updateAllTargetBindings=function(){if(null!=this._diagram)try{this._diagram.updateAllTargetBindings()}finally{console.warn("finish to update all target bindings.")}};CNetMap.prototype._getViewCenterX=function(){return null==this._diagram?null:null==this._diagram.viewportBounds?null:null==this._diagram.viewportBounds.center?null:this._diagram.viewportBounds.center.x};CNetMap.prototype._getViewCenterY=function(){return null==this._diagram?null:null==this._diagram.viewportBounds?null:null==this._diagram.viewportBounds.center?null:this._diagram.viewportBounds.center.y};CNetMap.prototype.getViewportBounds=function(){var bounds={left:0,top:0,right:1,bottom:1,width:1,height:1};var viewportBounds=NgUtil.getValueFromObjAndPath(this,"_diagram.viewportBounds");if(viewportBounds){bounds.left=viewportBounds.left;bounds.right=viewportBounds.right;bounds.top=viewportBounds.top;bounds.bottom=viewportBounds.bottom;bounds.width=viewportBounds.width;bounds.height=viewportBounds.height;bounds.center={x:viewportBounds.centerX,y:viewportBounds.centerY}}return bounds};CNetMap.prototype.setMapPanelTabShow=function(isShow){this.isMapPanelTabShow=isShow};CNetMap.prototype.getMapPanelTabShow=function(){return this.isMapPanelTabShow};CNetMap.prototype.delete=function(){this._diagram.commandHandler.deleteSelection()};CNetMap.prototype.getSimpleNodeDataArray=function(){var result=[];this.isL2MapStyle();netBrain.Map.CategoryMgr.isOtherShapesCategory;var model=JSON.parse(this._model.toJson());var diagram=this._diagram;model.nodeDataArray.forEach((function(data){var node=diagram.findNodeForKey(data.key);if(node){var actualBounds=node.actualBounds;data.bounds={left:actualBounds.left,top:actualBounds.top,right:actualBounds.right,bottom:actualBounds.bottom};result.push(data)}}));return result};CNetMap.prototype.getSimpleLinkDataArray=function(){var result=[];_.each(this._model.linkDataArray,(function(link){result.push({from:link.from,fromPort:link.fromPort,to:link.to,toPort:link.toPort})}));return result};CNetMap.prototype.updateNodesLoc=function(nodesLocArr){var model=this._model;var nodesLocObj={};_.each(nodesLocArr,(function(nodeLoc){nodesLocObj[nodeLoc.key]=nodeLoc.location}));_.each(this._model.nodeDataArray,(function(node){var loc=nodesLocObj[node.key];loc&&model.setDataProperty(node,"location",loc)}))};CNetMap.prototype.getViewportBounds=function(){return this._diagram.viewportBounds};CNetMap.prototype.showHighlightBg=function(deviceIds,style){var diagram=this._diagram;var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var highlightBg=this._highlightBg;this.hideHighlightBg(deviceIds);_.each(deviceIds,(function(deviceId){var node=diagram.findNodeForKey(deviceId);node&&highlightBg.makeHighlightNodeBg(node,style)}));diagram.skipsUndoManager=oldskip};CNetMap.prototype.hideHighlightBg=function(deviceIds){var diagram=this._diagram;var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var highlightBg=this._highlightBg;_.each(deviceIds,(function(deviceId){var node=diagram.findNodeForKey(deviceId);node&&highlightBg.removeHighlightNodeBg(node)}));diagram.skipsUndoManager=oldskip};CNetMap.prototype.refreshHighlightBgFromCache=function(){var _this=this;var highlightList=this._highlightBg.getHighlightBgList();_.each(highlightList,(function(obj){_this.hideHighlightBg([obj.key]);_this.showHighlightBg([obj.key],obj.style)}))};CNetMap.prototype.pinNodes=function(deviceIds){};CNetMap.prototype.unpinNodes=function(deviceIds){};CNetMap.prototype.updateDeviceIconRatio=function(deviceId,ratio){if(_.isNumber(ratio)){var model=this._model;var data=model.findNodeDataForKey(deviceId);data&&model.setDataProperty(data,"iconRatio",ratio)}};CNetMap.prototype.updateTargetBindings=function(deviceIds){var model=this._model;_.each(deviceIds,(function(deviceId){var data=model.findNodeDataForKey(deviceId);data&&model.updateTargetBindings(data)}))};CNetMap.prototype.scroll=function(x,y){var diagram=this._diagram;var dirX=x>0?"right":"left";var dirY=y>0?"down":"up";diagram.scroll("pixel",dirX,Math.abs(x));diagram.scroll("pixel",dirY,Math.abs(y))};CNetMap.prototype.selectOtherSameTypeNodes=function(part){var diagram=part.diagram;if(diagram){var graphicTypeMgr=netBrain.Map.graphicTypeMgr;var list;var filterFun;if(netBrain.Map.CategoryMgr.isLink(part.category)){filterFun=graphicTypeMgr.getFilterLinksFunction(part.data);list=diagram.links}else{filterFun=graphicTypeMgr.getFilterNodesFunction(part.data);list=diagram.nodes}if(_.isFunction(filterFun)){var isPathLink=netBrain.Map.CategoryMgr.isPathLink;list.each((function(tmpObj){if(filterFun(tmpObj.data)){tmpObj.isSelected=!0;isPathLink(tmpObj.category)&&tmpObj.selectAllHops()}}))}}};CNetMap.prototype.refreshSelectionStyle=function(){var diagram=this._diagram;if(diagram){var selection=diagram.selection;selection.size<2||selection.each((function(part){part instanceof go.Node&&part.updateAdornments()}))}};CNetMap.prototype.setVisualSpaceInfo=function(visualSpaceInfo,force){if(null!=this._netmapJsWrapper){var myVisualSpaceInfo=this.getVisualSpaceInfo();if(force||!myVisualSpaceInfo!=!visualSpaceInfo){if(this._diagram&&this._model){var transactionName=NgUtil.getUniqueStr("setVisualSpaceInfo");this._diagram.startTransaction(transactionName);this._model.setDataProperty(this._netmapJsWrapper.getRefData(),"visualSpaceInfo",visualSpaceInfo);this._diagram.commitTransaction(transactionName)}else this._netmapJsWrapper.setVisualSpaceInfo(visualSpaceInfo);this.setModify(!0);return!0}if(visualSpaceInfo&&myVisualSpaceInfo.visualSpaceInstanceId==visualSpaceInfo.visualSpaceInstanceId)return!0}return!1},CNetMap.prototype.getVisualSpaceInfo=function(){return this._netmapJsWrapper?this._netmapJsWrapper.getVisualSpaceInfo():null},CNetMap.prototype.isDefaultVisualSpaceInfo=function(){var visualSpaceInfo=this._netmapJsWrapper.getVisualSpaceInfo();return!visualSpaceInfo||visualSpaceInfo.visualSpaceInstanceId==VisualSpaceConstant.defaultVisualSpaceInstanceId},CNetMap.prototype.getIsFirstView=function(){return null==this._netmapJsWrapper||this._netmapJsWrapper.getIsFirstView()};CNetMap.prototype.setIsFirstView=function(isFirstView){null!=this._netmapJsWrapper&&this._netmapJsWrapper.setIsFirstView(isFirstView)};CNetMap.prototype.getIsFrom6X=function(){return null==this._netmapJsWrapper||this._netmapJsWrapper.getIsFrom6X()};CNetMap.prototype.setIsFrom6X=function(isFrom6X){null!=this._netmapJsWrapper&&this._netmapJsWrapper.setIsFrom6X(isFrom6X)};CNetMap.prototype.getNodeByData=function(data){if(data){var diagram=this._diagram;if(diagram){return diagram.findNodeForData(data)}}};CNetMap.prototype.getLinksByDeviceIdAndInftId=function(devId,intfId){var links=[];this._diagram;var device=this._getGraphDeviceByKey(devId);if(device){device.findLinksConnected(intfId).each((function(l){links.push(l)}))}return links};CNetMap.prototype.updateNoteContent=function(noteId,content){var noteData=this._getCompDeviceByKey(noteId);this._diagram.model.setDataProperty(noteData,"noteContent",content)};CNetMap.prototype.updateNoteModifyTime=function(noteId){this._getCompDeviceByKey(noteId).setModifyTime(new Date,this._diagram)};CNetMap.prototype.removeAllLinkHighlightFlag=function(){};CNetMap.prototype.getConnectedLinkDatasByDeviceId=function(devId){var links=[];var device=this._getGraphDeviceByKey(devId);device&&device.linksConnected.each((function(l){links.push(l.data)}));return links};CNetMap.prototype.getConnectedLinkDatasByDeviceIdAndFilter=function(devId,filterFun){var links=[];var device=this._getGraphDeviceByKey(devId);var isFun=_.isFunction(filterFun);device&&device.linksConnected.each((function(l){if(isFun){filterFun(l.data)&&links.push(l.data)}else links.push(l.data)}));return links};CNetMap.prototype.isL2DeviceStyle=function(obj){var flag=!1;this.isL2MapStyle()&&this.hasL2DeviceStyle(obj)&&(flag=!0);return flag};CNetMap.prototype.isL2LinkStyle=function(obj){var flag=!1;if(this.isL2MapStyle()&&netBrain.Map.CategoryMgr.isTopolink(obj.category)){var fromKey=obj.from;var toKey=obj.to;var fromNode=this._getGraphDeviceByKey(fromKey);var toNode=this._getGraphDeviceByKey(toKey);(fromNode&&toNode&&this.isL2DeviceStyle(fromNode.data)||this.isL2DeviceStyle(toNode.data))&&(flag=!0)}return flag};CNetMap.prototype.hasL2DeviceStyle=function(obj){var flag=!1;var CategoryMgr=netBrain.Map.CategoryMgr;if(CategoryMgr.isDeviceCategory(obj.category))flag=!this.isInL3StyleInExpandedStyle(obj.devCategory);else if(CategoryMgr.isStencilDevice(obj.category)){var img=NgUtil.getValueFromObjAndPath(obj,"dataViewData.devGraphicInfo.imageList.0.name");var simulate=netBrain.Map.Const.stencilImgSimulateDevCategory[img];simulate&&(flag=!this.isInL3StyleInExpandedStyle(simulate))}return flag};CNetMap.prototype.updateNodeStyle=function(nodeData,newCategory){var diagram=this._diagram;if(diagram){var transactionName=NgUtil.getUniqueStr("updateNodeStyle");diagram.startTransaction(transactionName);diagram.model.setCategoryForNodeData(nodeData,newCategory);diagram.commitTransaction(transactionName)}};CNetMap.prototype.updateLinkStyle=function(linkData,newCategory){var diagram=this._diagram;if(diagram){var transactionName=NgUtil.getUniqueStr("updateLinkStyle");diagram.startTransaction(transactionName);diagram.model.setCategoryForLinkData(linkData,newCategory);diagram.commitTransaction(transactionName)}};CNetMap.prototype.refreshMapWithViewStyle=function(devCategory){var diagram=this._diagram;if(diagram&&this.isL2MapStyle()){var transactionName=NgUtil.getUniqueStr("refreshMapWithViewStyle");diagram.startTransaction(transactionName);diagram.model.nodeDataArray=[].concat(diagram.model.nodeDataArray);diagram.model.linkDataArray=[].concat(diagram.model.linkDataArray);var changedNodes=function(diagram,devCategory){var nodes=[];var isNetworkDevice=netBrain.Map.CategoryMgr.isNetworkDevice;diagram.nodes.each((function(n){var data=n.data;isNetworkDevice(data.category)&&data.devCategory+""==devCategory+""&&nodes.push(n)}));return nodes}(diagram,devCategory);var changedNodeKeys=_.map(changedNodes,(function(cn){return cn.data.key}));var portInfos=netBrain.Map.L2PortsLayoutTool.getPortsInfoByDeviceKeys(changedNodeKeys,diagram);0!==portInfos.length&&this.layoutL2Ports(portInfos);_.each(changedNodes,(function(node){node.linksConnected.each((function(l){netBrain.Map.CategoryMgr.isTopolink(l.data.category)&&l.invalidateRoute()}))}));this.refreshMapViewOptionVisible();diagram.commitTransaction(transactionName);diagram.model.undoManager.clear()}};CNetMap.prototype.moveMapToVisibleNode=function(){var diagram=this._diagram;if(diagram){diagram.centerRect(diagram.documentBounds);if(!(diagram.nodes.count<1)){var noNodeInViewport=!0;var viewportBounds=diagram.viewportBounds;diagram.nodes.each((function(node){noNodeInViewport&&(noNodeInViewport=!node.actualBounds.intersectsRect(viewportBounds))}));if(noNodeInViewport){var node=diagram.nodes.first();diagram.centerRect(node.actualBounds)}}}};CNetMap.prototype.getVisioInfos=function(){var result=[];var diagram=this._diagram;if(!diagram)return result;diagram.nodes.each((function(n){n.isVisible()&&_.isFunction(n.getVisioInfo)&&result.push(n.getVisioInfo())}));diagram.links.each((function(l){netBrain.Map.CategoryMgr.isTopolink(l.data.category)?l.isVisible()&&_.isFunction(l.getVisioInfo)&&(l.data.points||l.data.pointsL2)&&result.push(l.getVisioInfo()):l.isVisible()&&_.isFunction(l.getVisioInfo)&&result.push(l.getVisioInfo())}));return result};CNetMap.prototype.disableNodes=function(keys){var diagram=this._diagram;if(diagram){var op=this._netmapOperator;var opacity=netBrain.Map.Const.EditDataViewMode.DisableStyle.opacity;var tsName=NgUtil.getUniqueStr("disableNodes");op.startTransaction(tsName);_.each(keys,(function(key){var node=diagram.findNodeForKey(key);if(node){node.opacity=opacity;node.selectable=!1}}));op.commitTransaction(tsName)}};CNetMap.prototype.disableAllNodes=function(){var diagram=this._diagram;if(diagram){var keys=_.pluck(diagram.model.nodeDataArray,"key");this.disableNodes(keys)}};CNetMap.prototype.enableNodes=function(keys){var diagram=this._diagram;if(diagram){var op=this._netmapOperator;var opacity=netBrain.Map.Const.EditDataViewMode.EnableStyle.opacity;var tsName=NgUtil.getUniqueStr("enableNodes");op.startTransaction(tsName);_.each(keys,(function(key){var node=diagram.findNodeForKey(key);if(node){node.opacity=opacity;node.selectable=!0}}));op.commitTransaction(tsName)}};CNetMap.prototype.enableAllNodes=function(keys){var diagram=this._diagram;if(diagram){keys=_.pluck(diagram.model.nodeDataArray,"key");this.enableNodes(keys)}};CNetMap.prototype.disableLinks=function(linkObjs){var diagram=this._diagram;if(diagram){var op=this._netmapOperator;var opacity=netBrain.Map.Const.EditDataViewMode.DisableStyle.opacity;var tsName=NgUtil.getUniqueStr("disableLinks");op.startTransaction(tsName);_.each(linkObjs,(function(linkObj){var linkData=linkObj.data;var link=diagram.findLinkForData(linkData);link&&setLinkStatus(link,linkObj.seg,opacity,!1)}));op.commitTransaction(tsName)}};CNetMap.prototype.disableAllLinks=function(){var diagram=this._diagram;if(diagram){var seg=netBrain.Map.Const.EditDataViewMode.LinkSeg.ALL;var linkObjs=_.map(diagram.model.linkDataArray,(function(data){return{data:data,seg:seg}}));this.disableLinks(linkObjs)}};CNetMap.prototype.enableLinks=function(linkObjs){var diagram=this._diagram;if(diagram){var op=this._netmapOperator;var opacity=netBrain.Map.Const.EditDataViewMode.EnableStyle.opacity;var tsName=NgUtil.getUniqueStr("enableLinks");op.startTransaction(tsName);_.each(linkObjs,(function(linkObj){var linkData=linkObj.data;var link=diagram.findLinkForData(linkData);link&&setLinkStatus(link,linkObj.seg,opacity,!0)}));op.commitTransaction(tsName)}};CNetMap.prototype.enableAllLinks=function(){var diagram=this._diagram;if(diagram){var linkObjs=_.map(diagram.model.linkDataArray,(function(data){return{data:data,seg:0}}));this.enableLinks(linkObjs)}};CNetMap.prototype.enableLinksByDeviceIdAndIntfs=function(devId,intfValues){if(this._diagram){var CategoryMgr=netBrain.Map.CategoryMgr;var dev=this._getGraphDeviceByKey(devId);if(dev){var linkObjs=[];dev.linksConnected.each((function(link){var data=link.data;if(CategoryMgr.isTopolink(data.category)){var intfKeySrc=NgUtil.getValueFromObjAndPath(data,"intfSrc.intfInfo.intf.intfKeyObj.value");var isFrom=_.contains(intfValues,intfKeySrc);var isTo=!1;if(!isFrom){var intfKeyDest=NgUtil.getValueFromObjAndPath(data,"intfDest.intfInfo.intf.intfKeyObj.value");isTo=_.contains(intfValues,intfKeyDest)}if(isFrom||isTo){var seg=isFrom?1:2;var otherNode=isFrom?link.toNode:link.fromNode;CategoryMgr.isNetworkDevice(otherNode.data.category)||(seg=0);linkObjs.push({data:data,seg:seg})}}}));this.enableLinks(linkObjs)}}};CNetMap.prototype.enableMapOnceByParams=function(keys,linkObjs){var diagram=this._diagram;if(diagram){var op=this._netmapOperator;var oldskip=diagram.skipsUndoManager;var tsName=NgUtil.getUniqueStr("enableMapOnceByParams");op.startTransaction(tsName);diagram.skipsUndoManager=!0;if(keys){this.disableAllNodes();this.enableNodes(keys)}if(linkObjs){this.disableAllLinks();this.enableLinks(linkObjs)}diagram.skipsUndoManager=oldskip;op.commitTransaction(tsName)}};CNetMap.prototype.enableWholeMapOnce=function(){var diagram=this._diagram;if(diagram){var op=this._netmapOperator;var oldskip=diagram.skipsUndoManager;var tsName=NgUtil.getUniqueStr("enableWholeMapOnce");op.startTransaction(tsName);diagram.skipsUndoManager=!0;this.enableAllNodes();this.enableAllLinks();diagram.skipsUndoManager=oldskip;op.commitTransaction(tsName)}};CNetMap.prototype.isNodeEnabled=function(key){if(this._diagram){var node=this._getGraphDeviceByKey(key);return!!node&&1===node.opacity&&node.pickable}};CNetMap.prototype.enableDelete=function(){var diagram=this._diagram;diagram&&(diagram.allowDelete=!0)};CNetMap.prototype.disableDelete=function(){var diagram=this._diagram;diagram&&(diagram.allowDelete=!1)};CNetMap.prototype.enableUndo=function(){var diagram=this._diagram;diagram&&(diagram.undoManager.isEnabled=!0)};CNetMap.prototype.disableUndo=function(){var diagram=this._diagram;diagram&&(diagram.undoManager.isEnabled=!1)};CNetMap.prototype.enableReshape=function(){var diagram=this._diagram;diagram&&(diagram.allowReshape=!0)};CNetMap.prototype.disableReshape=function(){var diagram=this._diagram;diagram&&(diagram.allowReshape=!1)};CNetMap.prototype.enableMapOperator=function(){if(this._diagram){var op=this._netmapOperator;var tsName=NgUtil.getUniqueStr("enableMapOperator");op.startTransaction(tsName);this.enableDelete();this.enableUndo();this.enableReshape();op.commitTransaction(tsName)}};CNetMap.prototype.disableMapOperator=function(){var diagram=this._diagram;if(diagram){var op=this._netmapOperator;var tsName=NgUtil.getUniqueStr("disableMapOperator");op.startTransaction(tsName);this.disableDelete();this.disableUndo();this.disableReshape();diagram.links.each((function(l){l.reshapable=!1}));op.commitTransaction(tsName)}};CNetMap.prototype.getNodesInViewport=function(filter){var diagram=this._diagram;if(diagram){var hasFilter=_.isFunction(filter);var result=[];var viewportBounds=diagram.viewportBounds;diagram.nodes.each((function(node){if(node.actualBounds.intersectsRect(viewportBounds)){var data=node.data;hasFilter?filter(data)&&result.push(data):result.push(data)}}));return result}};CNetMap.prototype.isInPanelNamed=function(subject,panelName){var flag=!1;var count=10;var tempPanel=subject;var part=subject.part;for(;count>0;){if(tempPanel instanceof go.Panel&&tempPanel.name===panelName){flag=!0;break}if(tempPanel.panel===part)break;tempPanel=tempPanel.panel;count--}return flag};CNetMap.prototype.reCalcLinks=function(){var diagram=this._diagram;if(diagram){var op=this._netmapOperator;var tsName=NgUtil.getUniqueStr("reCalcLinks");op.startTransaction(tsName);diagram.links.each((function(link){link.diagram&&link.invalidateRoute()}));op.commitTransaction(tsName)}};CNetMap.prototype.reCalcLinksByDeviceKeys=function(deviceKeys){if(this._diagram){var _this=this;var links=new go.Set;_.each(deviceKeys,(function(key){var node=_this._getGraphDeviceByKey(key);node&&node.linksConnected.each((function(l){links.add(l)}))}));var op=this._netmapOperator;var tsName=NgUtil.getUniqueStr("reCalcLinksByDeviceKeys");op.startTransaction(tsName);links.each((function(link){link.diagram&&link.invalidateRoute()}));op.commitTransaction(tsName)}};CNetMap.prototype.changeLinkLineStyle=function(links,newLineStyle){var diagram=this._diagram;diagram&&_.each(links,(function(link){var linkData=link.data;var customMapStyle=linkData.customMapStyle||{};var src=customMapStyle.src||{};var srcLineCustomStyle=src.line||{};_.extend(srcLineCustomStyle,newLineStyle);src.line=srcLineCustomStyle;customMapStyle.src=src;var dest=customMapStyle.dest||{};var destLineCustomStyle=dest.line||{};_.extend(destLineCustomStyle,newLineStyle);dest.line=destLineCustomStyle;customMapStyle.dest=dest;diagram.model.setDataProperty(linkData,"customMapStyle",customMapStyle);link.updateTargetBindings();link.invalidateRoute()}))};CNetMap.prototype.changePathLineStyle=function(paths,newLineStyle){var diagram=this._diagram;diagram&&_.each(paths,(function(link){var linkData=link.data;var customMapStyle=linkData.customMapStyle||{};var selectedHops=link.getSelectedHops();_.each(selectedHops,(function(hop){var hopSrc=customMapStyle[hop.itemIndex]||{};var hopLineCustomStyle=hopSrc.line||{};_.extend(hopLineCustomStyle,newLineStyle);hopSrc.line=hopLineCustomStyle;customMapStyle[hop.itemIndex]=hopSrc}));diagram.model.setDataProperty(linkData,"customMapStyle",customMapStyle);link.updateTargetBindings();link.invalidateRoute()}))};CNetMap.prototype.removeLinkLineCustomizedStyle=function(links){var diagram=this._diagram;diagram&&_.each(links,(function(link){var linkData=link.data;if(linkData.customMapStyle){diagram.model.setDataProperty(linkData,"customMapStyle",null);link.updateTargetBindings();link.invalidateRoute()}}))};CNetMap.prototype.calcPolicyStyle=function(linkData){if(netBrain.Map.CategoryMgr.isTopolink(linkData.category)){var qmap=this.getParentQmap();if(qmap){if(qmap.getTopoLinkPolicyInfo()){var intfExtendDataSrc=NgUtil.getValueFromObjAndPath(linkData,"intfSrc.intfInfo.intf.intfExtendData");var intfExtendDataDest=NgUtil.getValueFromObjAndPath(linkData,"intfDest.intfInfo.intf.intfExtendData");var styleObj=qmap.getTopoLinkStyleFromPolicy(linkData.topoType,intfExtendDataSrc,intfExtendDataDest);var styleSrc=styleObj.src;var styleDest=styleObj.dest;if(styleSrc){var src=(policyStyle=linkData.policyStyle||{}).src||{};var srcPolicyLineStyle=src.line||{};srcPolicyLineStyle.stroke=styleSrc.linkColor;srcPolicyLineStyle.strokeWidth=styleSrc.linkThickness;srcPolicyLineStyle.strokeDashArray=styleSrc.linkStyle;srcPolicyLineStyle.isCreateLegend=styleSrc.isCreateLegend;srcPolicyLineStyle.name=styleSrc.name;src.line=srcPolicyLineStyle;policyStyle.src=src;linkData.policyStyle=policyStyle}if(styleDest){var policyStyle;var dest=(policyStyle=linkData.policyStyle||{}).dest||{};var destPolicyLineStyle=dest.line||{};destPolicyLineStyle.stroke=styleDest.linkColor;destPolicyLineStyle.strokeWidth=styleDest.linkThickness;destPolicyLineStyle.strokeDashArray=styleDest.linkStyle;destPolicyLineStyle.isCreateLegend=styleDest.isCreateLegend;destPolicyLineStyle.name=styleDest.name;dest.line=destPolicyLineStyle;policyStyle.dest=dest;linkData.policyStyle=policyStyle}}}}};CNetMap.prototype.calcUnknownEndSystemPolicyStyleWhenOneLink=function(srcCompDev,destCompDev,linkLine){var policyStyle=linkLine.policyStyle;if(policyStyle){var srcDevType=srcCompDev.getDevType();var destDevType=destCompDev.getDevType();1005===srcDevType&&1005!==destDevType?policyStyle.dest&&(policyStyle.src=policyStyle.dest):1005===destDevType&&1005!==srcDevType&&policyStyle.src&&(policyStyle.dest=policyStyle.src)}};CNetMap.prototype.calcUnknownEndSystemPolicyStyleWhenTwoLinks=function(srcCompDev,destCompDev,srcLinkLine,destLinkLine){var srcDevType=srcCompDev.getDevType();var destDevType=destCompDev.getDevType();if(1005===srcDevType&&1005!==destDevType){var destPolicyStyle=destLinkLine.policyStyle;destPolicyStyle&&(srcLinkLine.policyStyle=destPolicyStyle)}else if(1005===destDevType&&1005!==srcDevType){var srcPolicyStyle=destLinkLine.policyStyle;srcPolicyStyle&&(destLinkLine.policyStyle=srcPolicyStyle)}};CNetMap.prototype.calcUnknownEndSystemPolicyAfterAddLinks=function(newLinks){var diagram=this._diagram;if(diagram){var model=diagram.model;var CategoryMgr=netBrain.Map.CategoryMgr;var unknownLinks=[];_.each(newLinks,(function(link){var from=link.from;var to=link.to;var fromData=model.findNodeDataForKey(from);var toData=model.findNodeDataForKey(to);fromData&&toData&&(CategoryMgr.isNetworkDevice(fromData.category)&&CategoryMgr.isMedia(toData.category)&&1005===fromData.getDevType()?unknownLinks.push({linkData:link,fromData:fromData,toData:toData,isSource:!0}):CategoryMgr.isNetworkDevice(toData.category)&&CategoryMgr.isMedia(fromData.category)&&1005===toData.getDevType()&&unknownLinks.push({linkData:link,fromData:fromData,toData:toData,isSource:!1}))}));_.each(unknownLinks,(function(unknownLinkObj){var linkData=unknownLinkObj.linkData;var isSource=unknownLinkObj.isSource;var mediaNode=diagram.findNodeForData(isSource?unknownLinkObj.toData:unknownLinkObj.fromData);if(mediaNode){var mediaLinkDatas=[];mediaNode.linksConnected.each((function(link){if(link.data!==linkData&&CategoryMgr.isTopolink(link.category)){var isNotUnknownLink=!1;if(link.fromNode!==mediaNode){var fromNodeData=link.fromNode.data;isNotUnknownLink=CategoryMgr.isNetworkDevice(fromNodeData.category)&&1005!==fromNodeData.getDevType()}else if(link.toNode!==mediaNode){var toNodeData=link.toNode.data;isNotUnknownLink=CategoryMgr.isNetworkDevice(toNodeData.category)&&1005!==toNodeData.getDevType()}isNotUnknownLink&&mediaLinkDatas.push(link.data)}}));if(mediaLinkDatas.length>0){var otherLinkData=mediaLinkDatas[mediaLinkDatas.length-1];model.setDataProperty(linkData,"policyStyle",otherLinkData.policyStyle)}}}))}};CNetMap.prototype.changeIntfHighlightMode=function(modeId){this.setInterfaceHighlightMode(modeId);var diagram=this._diagram;if(diagram&&this.isL2MapStyle()){var CategoryMgr=netBrain.Map.CategoryMgr;var CompL2Device=netBrain.Map.CompL2Device;var CompL2TopoLink=netBrain.Map.CompL2TopoLink;var transactionName=NgUtil.getUniqueStr("changeIntfHighlightMode");diagram.startTransaction(transactionName);diagram.nodes.each((function(node){CategoryMgr.isNetworkDevice(node.data.category)&&node instanceof CompL2Device&&node.updateTargetBindings("dataViewData")}));diagram.links.each((function(link){if(CategoryMgr.isTopolink(link.data.category)&&link instanceof CompL2TopoLink){link.updateTargetBindings("intfSrc");link.updateTargetBindings("intfDest");link.invalidateRoute()}}));this.refreshMapViewOptionVisible();diagram.commitTransaction(transactionName);this.setModify(!0);diagram.model.undoManager.clear()}};CNetMap.prototype.getCompoundNoteNodes=function(){var diagram=this._diagram;if(diagram){var CategoryMgr=netBrain.Map.CategoryMgr;var compoundNotes=[];diagram.nodes.each((function(note){var noteData=note.data;CategoryMgr.isDeviceNote(noteData.category)&&noteData.noteFromType===netBrain.Map.Const.NoteFromType.DataView&&!0===noteData.isCompound&&compoundNotes.push(note)}));return compoundNotes}};CNetMap.prototype.getCompoundNoteNodesByDeviceId=function(devId){var allCompoundNotes=this.getCompoundNoteNodes();return _.filter(allCompoundNotes,(function(item){return _.contains(item.data.deviceIds,devId)}))};CNetMap.prototype.showCompoundNoteLinks=function(target){var diagram=this._diagram;if(diagram){var netMapOperator=this.getNetmapOperator();if(netMapOperator){var partData=target.part.data;if(partData.isCompound){var transactionName=NgUtil.getUniqueStr("showCompoundNoteLinks");diagram.startTransaction(transactionName);var deviceIds=partData.deviceIds;for(var i=0;i<deviceIds.length;i++)netMapOperator.addNormalLink(partData.key,deviceIds[i],!0);diagram.commitTransaction(transactionName)}}}};CNetMap.prototype.hideCompoundNoteLinks=function(target){var diagram=this._diagram;if(diagram){if(target.part.data.isCompound){var transactionName=NgUtil.getUniqueStr("hideCompoundNoteLinks");diagram.startTransaction(transactionName);var arr=[];target.part.linksConnected.each((function(link){arr.push(link)}));_.each(arr,(function(link){diagram.remove(link)}));diagram.commitTransaction(transactionName)}}};function getLegendName(obj){return obj.legendName||obj.legend}function setLinkStatus(link,seg,opacity,canPick){if(netBrain.Map.CategoryMgr.isTopolink(link.data.category)){var CompTopolink=netBrain.Map.CompTopolink;var panelNames1=[CompTopolink.BaseLineForShowSrc,CompTopolink.srcInftNameLabel];var panelNames2=[CompTopolink.BaseLineForShowDest,CompTopolink.destInftNameLabel];_.each(_.range(9),(function(i){panelNames1.push("intfSrc_"+i);panelNames2.push("intfDest_"+i)}));var LinkSeg=netBrain.Map.Const.EditDataViewMode.LinkSeg;var panelNames;switch(seg){case LinkSeg.ALL:panelNames=panelNames1.concat(panelNames2);break;case LinkSeg.FROM:panelNames=panelNames1;break;case LinkSeg.TO:panelNames=panelNames2}_.each(panelNames,(function(panelName){var tmpObj=link.findObject(panelName);if(tmpObj){tmpObj.opacity=opacity;tmpObj.selectable=canPick}}))}else{link.opacity=opacity;link.selectable=canPick}}netBrain.Map=netBrain.Map||{};netBrain.Map.CNetMap=CNetMap}(NetBrain);!function(netBrain){function getInnerObjBounds(obj,withOutTextBoundsFixed){var topLeft=obj.getDocumentPoint(go.Spot.TopLeft);var bottomRight=obj.getDocumentPoint(go.Spot.BottomRight);var bounds=obj.actualBounds;var width,height;if(!0!==withOutTextBoundsFixed&&obj instanceof go.TextBlock){width=bounds.width;height=bounds.height}else{width=Math.abs(bottomRight.x-topLeft.x);height=Math.abs(bottomRight.y-topLeft.y)}return{left:topLeft.x,top:topLeft.y,right:bottomRight.x,bottom:bottomRight.y,width:width,height:height}}function getTextInfo(textObj,withOutBoundsFixed){if(!textObj.isVisibleObject())return{type:"undefined"};var result={type:"text"};if(textObj instanceof go.TextBlock){["text","font","textAlign","stroke","background","isMultiline","isStrikethrough","isUnderline","spacingAbove","spacingBelow"].forEach((function(propName){result[propName]=textObj[propName]}));result.bounds=getInnerObjBounds(textObj,withOutBoundsFixed)}return result}function getShapeInfo(shapeObj){if(!shapeObj.isVisibleObject())return{type:"undefined"};var result={type:"shape"};if(shapeObj instanceof go.Shape){["fill","geometryString","stroke","strokeCap","strokeDashArray","strokeJoin","strokeWidth","angle"].forEach((function(propName){result[propName]=shapeObj[propName]}));result.bounds=getInnerObjBounds(shapeObj)}return result}function getNodeOrLinkLayerIndex(part){var layerIndex=0;var diagram=part.diagram;if(diagram){var pLayerName=part.layerName;var i=0;diagram.layers.each((function(layer){layer.name===pLayerName&&(layerIndex=i);i++}))}return layerIndex}var visioTools={getPartBounds:function(part){var bounds=part.actualBounds;return{left:bounds.x,top:bounds.y,right:bounds.x+bounds.width,bottom:bounds.y+bounds.height,width:bounds.width,height:bounds.height}},getInnerObjBounds:getInnerObjBounds,getTextInfo:getTextInfo,getTextVisioInfo:function(panel,name,withOutBoundsFixed){var textObj=panel.findObject(name);return textObj&&textObj.isVisibleObject()?getTextInfo(textObj,withOutBoundsFixed):{type:"undefined"}},getShapeInfo:getShapeInfo,getShapeVisioInfo:function(panel,name){var shapeObj=panel.findObject(name);return shapeObj&&shapeObj.isVisibleObject()?getShapeInfo(shapeObj):{type:"undefined"}},getPictureInfo:function(picObj,isMainPic){if(!picObj.isVisibleObject())return{type:"undefined"};var result={type:"picture"};if(picObj instanceof go.Picture){["source","width","height"].forEach((function(propName){result[propName]=picObj[propName]}));result.bounds=getInnerObjBounds(picObj);isMainPic&&(result.connectId="default")}return result},buildNodeVisioInfo:function(visioInfos,data,part){var tmpLoc=function(data,node){var diagram=node.diagram;return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(diagram,data)}(data.location,part);var location=go.Point.stringify(tmpLoc);return{type:"node",infos:visioInfos=_.filter(visioInfos,(function(info){return"undefined"!==info.type})),layerIndex:getNodeOrLinkLayerIndex(part),key:data.key,location:location,bounds:visioTools.getPartBounds(part)}},buildLinkVisioInfo:function(visioInfos,data,part){var tmpPts=function(data,node){var diagram=node.diagram;return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayParse(diagram,data,node)}(data.points||data.pointsL2,part);var points=[];_.isFunction(tmpPts.each)&&tmpPts.each((function(pt){points.push(go.Point.stringify(pt))}));return{type:"link",infos:visioInfos=_.filter(visioInfos,(function(info){return"undefined"!==info.type})),layerIndex:getNodeOrLinkLayerIndex(part),from:data.from,fromConnectedId:data.from+data.fromPort,to:data.to,toConnectedId:data.to+data.toPort,points:points}},addDirection:function(info,isFrom){info&&(_.isArray(info)?_.each(info,(function(obj){obj.isFrom=isFrom})):info.isFrom=isFrom);return info},addLayerName:function(info,layerName){info&&(_.isArray(info)?_.each(info,(function(obj){obj.layerName=layerName})):info.layerName=layerName);return info},getLayerIndexByLayerName:function(diagram,layerName){var layerIndex=0;if(diagram){var i=0;diagram.layers.each((function(layer){layer.name===layerName&&(layerIndex=i);i++}))}return layerIndex}};netBrain.Map=netBrain.Map||{};netBrain.Map.visioTools=visioTools}(NetBrain);function CompModelManage(diagram){this.diagram=diagram}CompModelManage.prototype.constructor=CompModelManage;CompModelManage.prototype.setDiagram=function(diagram){this.diagram=diagram};CompModelManage.prototype.setAllCompEditableModel=function(bEditable){if(null!=this.diagram){this.diagram.nodes.each((function(node){if(null!=node&&null!=node.data)try{node.data.setEditableMode(node,bEditable)}catch(e){console.error(e)}}));this.diagram.links.each((function(link){if(null!=link&&null!=link.data)try{link.data.setEditableMode(link,bEditable)}catch(e){console.error(e)}}))}};!function(netBrain){var CNetMapOperator=function(netmap,dataViewCacheSrvc,rootScope,q,nbAlertSrvc,applyDataViewSrvc,log){this._netmap=netmap;this._nbAlertSrvc=nbAlertSrvc;this._rootScope=rootScope;this._q=q;this.pathTip=new PathTip(netmap);this.diagramPathManager=new netBrain.Map.DiagramPathManager(this);this.diagramPathManager.setPathTip(this.pathTip);this._dataViewCacheSrvc=dataViewCacheSrvc;this._applyDataViewSrvc=applyDataViewSrvc;this.log=log;null!=netmap&&netmap.setNetmapOperator(this);this.netmapModeBase=new netBrain.Map.NetmapStandardMode;this.netmapModeBase.setNetmap(netmap);this.netmapModeBase.setRootScope(this._rootScope);this.netmapModeBase.setQ(this._q)};var portChannelHelper=netBrain.MapImprovements.PortChannelHelper;CNetMapOperator.prototype={constructor:CNetMapOperator,getLinkFromDeviceIntfValue:function(device,value){return _getLinkFromDeviceIntfValue(device,value)},getRootScope:function(){return this._rootScope},getDeviceIconRatio:function(deviceId){return this._netmap.getDeviceIconRatio(deviceId)},setRootScope:function(rootScope){this._rootScope=rootScope},getQ:function(){return this._q},setQ:function(q){this._q=q},getNetMap:function(){return this._netmap},setStandardMode:function(){this.netmapModeBase=new netBrain.Map.NetmapStandardMode;this.netmapModeBase.setNetmap(this._netmap);this.netmapModeBase.setRootScope(this._rootScope);this.netmapModeBase.setQ(this._q)},setReadonlyMode:function(){this.netmapModeBase=new netBrain.Map.NetmapReadonlyMode;this.netmapModeBase.setNetmap(this._netmap);this.netmapModeBase.setRootScope(this._rootScope);this.netmapModeBase.setQ(this._q)},getDataviewGroupId:function(){return null==this._netmap?null:this._netmap.getDataviewGroupId()},setExtendData:function(obj){this._netmap.setExtendData(obj)},getExtendData:function(){return this._netmap.getExtendData()},getExtendDataViewData:function(){return this._netmap.getExtendDataViewData()},getExtendDataViewTemplateData:function(){return this._netmap.getExtendDataViewTemplateData()},getExtendRunbookData:function(){return this._netmap.getExtendRunbookData()},getDiagramPathManager:function(){return this.diagramPathManager},getPathTip:function(){return this.pathTip},getJson:function(guid,mapName,diagram){if(null==this._netmap)return null;var netmap=this._netmap;netmap.doSave();var netMapJsWrapper=netmap.getNetMapJsWrapper();return null==netMapJsWrapper?null:netMapJsWrapper.getJsData()},getExtendNbrOp:function(){return null==this.netmapModeBase?null:this.netmapModeBase.getExtendNbrOp()},getAddDevicesOp:function(){return null==this.netmapModeBase?null:this.netmapModeBase.getAddDevicesOp()},getAutolinkOp:function(){return null==this.netmapModeBase?null:this.netmapModeBase.getAutolinkOp()},getDataViewApplyOp:function(){return null==this.netmapModeBase?null:this.netmapModeBase.getDataViewApplyOp()},getGraphicOp:function(){return null==this.netmapModeBase?null:this.netmapModeBase.getGraphicOp()},getVisualSpaceOp:function(){return null==this.netmapModeBase?null:this.netmapModeBase.getVisualSpaceOp()},alignLeft:function(){var graphicOp=this.getGraphicOp();null!=graphicOp&&graphicOp.alignLeft()},alignRight:function(){var graphicOp=this.getGraphicOp();null!=graphicOp&&graphicOp.alignRight()},alignTop:function(){var graphicOp=this.getGraphicOp();null!=graphicOp&&graphicOp.alignTop()},alignBottom:function(){var graphicOp=this.getGraphicOp();null!=graphicOp&&graphicOp.alignBottom()},alignCenterX:function(){var graphicOp=this.getGraphicOp();null!=graphicOp&&graphicOp.alignCenterX()},alignCenterY:function(){var graphicOp=this.getGraphicOp();null!=graphicOp&&graphicOp.alignCenterY()},layoutSelection:function(){var graphicOp=this.getGraphicOp();null!=graphicOp&&graphicOp.layoutSelection()},selectNodes:function(nodeKeys){var graphicOp=this.getGraphicOp();return null!=graphicOp&&graphicOp.selectNodes(nodeKeys)},addDeviceNote:function(objNote,ptPosDisplay){objNote.noteFromType||(objNote.noteFromType=NetBrain.Map.Const.NoteFromType.Normal);var graphicOp=this.getGraphicOp();if(null==graphicOp)return!1;try{return graphicOp.addDeviceNote(objNote,ptPosDisplay)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}},getCompDeviceByKey:function(devId){return this._netmap._getCompDeviceByKey(devId)},addDeviceNoteRefDevice:function(devId,objNote){if(null===devId)return null;"string"==typeof devId&&(devId=[devId]);if(null===this.getGraphicOp())return!1;var netmap=this._netmap;if(null===netmap)return!1;try{var compDevice=netmap._getCompDeviceByKey(devId[0]);if(null==compDevice)return!1;var ptProperPos=netmap._findProperNeighborPosition(compDevice,100);null==ptProperPos&&(ptProperPos=new go.Point(500,500));var transactionName=NgUtil.getUniqueStr("addDeviceNoteRefDevice");netmap._diagram.startTransaction(transactionName);var ptTip={x:ptProperPos.x,y:ptProperPos.y};var noteGrphicObj=this.addDeviceNote(objNote,ptTip);if(null==noteGrphicObj)return!1;for(var i=0;i<devId.length;i++)this.addNormalLink(noteGrphicObj.key,devId[i]);netmap._diagram.commitTransaction(transactionName);return!0}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString());return!1}return!1},getDeviceCompoundNoteByDeviceIdsAndTitle:function(deviceIds,objNote){var diagram=this._netmap._diagram;var CategoryMgr=netBrain.Map.CategoryMgr;return _.find(diagram.model.nodeDataArray,(function(item){return CategoryMgr.isDeviceNote(item.category)&&item.isCompound&&item.noteTitle===objNote.title&&_.intersection(item.deviceIds,deviceIds).length}))},updateDeviceCompoundNote:function(existNote,deviceIds,objNote){var netmap=this._netmap;if(netmap){var diagram=netmap._diagram;if(diagram){var transactionName=NgUtil.getUniqueStr("updateDeviceCompoundNote");this.startTransaction(transactionName);existNote.deviceIds=deviceIds;existNote.setNoteContent(objNote.content,diagram);existNote.setModifyTime(objNote.time,diagram);this.commitTransaction(transactionName)}}},addDeviceCompoundNoteRefDevices:function(deviceIds,objNote){if(null===this.getGraphicOp())return!1;var netmap=this._netmap;if(null===netmap)return!1;try{var compDevice=netmap._getCompDeviceByKey(deviceIds[0]);if(null==compDevice)return!1;var ptProperPos=netmap._findProperNeighborPosition(compDevice,100);null==ptProperPos&&(ptProperPos=new go.Point(500,500));var transactionName=NgUtil.getUniqueStr("addDeviceCompoundNoteRefDevices");netmap._diagram.startTransaction(transactionName);objNote.deviceIds=deviceIds;var ptTip={x:ptProperPos.x,y:ptProperPos.y};if(null==this.addDeviceNote(objNote,ptTip))return!1;netmap._diagram.commitTransaction(transactionName);return!0}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString());return!1}return!1},findDeviceNoteRefDeviceByNoteTitle:function(devId,title){var netmap=this._netmap;if(netmap){var note;var device=netmap._getGraphDeviceByKey(devId);if(device){var isDeviceNoteOrNote=netBrain.Map.CategoryMgr.isDeviceNoteOrNote;device.linksConnected.each((function(l){note||(l.fromNode===device&&isDeviceNoteOrNote(l.toNode.category)&&l.toNode.data.noteTitle===title?note=l.toNode.data:l.toNode===device&&isDeviceNoteOrNote(l.fromNode.category)&&l.fromNode.data.noteTitle===title&&(note=l.fromNode.data))}))}return note}},addIntfNoteRefDevice:function(devId,intf,objNote){if(null===devId)return null;if(null===this.getGraphicOp())return!1;var netmap=this._netmap;if(null===netmap)return!1;try{var compDevice=netmap._getCompDeviceByKey(devId);if(null==compDevice)return!1;var ptProperPos=null;null==(ptProperPos=objNote.location?go.Point.parse(objNote.location):netmap._findProperNeighborPosition(compDevice))&&(ptProperPos=new go.Point(500,500));var transactionName=NgUtil.getUniqueStr("addIntfNoteRefDevice");netmap._diagram.startTransaction(transactionName);var ptTip={x:ptProperPos.x,y:ptProperPos.y};var noteGrphicObj=this.addDeviceNote(objNote,ptTip);if(null==noteGrphicObj)return!1;this.addIntfaceLink({from:noteGrphicObj.key,to:devId,intfSrc:null,color:NetBrain.Map.Const.noteLinkDefaultBackColor,intfDest:{dataViewInfo:{dataViewType:DataViewType.dvDefault},intfInfo:{intf:intf}}});netmap._diagram.commitTransaction(transactionName);return!0}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString());return!1}return!1},findIntfNoteRefDeviceByNoteTitle:function(devId,intfId,noteTitle){var links=this.getLinksByDeviceIdAndInftId(devId,intfId);var note;var isDeviceNoteOrNote=netBrain.Map.CategoryMgr.isDeviceNoteOrNote;_.filter(links,(function(l){var flag=!1;if(l.fromPortId===intfId&&isDeviceNoteOrNote(l.toNode.category)&&l.toNode.data.noteTitle===noteTitle){note=l.toNode.data;flag=!0}else if(l.toPortId===intfId&&isDeviceNoteOrNote(l.fromNode.category)&&l.fromNode.data.noteTitle===noteTitle){note=l.fromNode.data;flag=!0}return flag}));return note},getLinksByDeviceIdAndInftId:function(devId,intfId){var netmap=this._netmap;return netmap?netmap.getLinksByDeviceIdAndInftId(devId,intfId):[]},getIntf:function(devId,intf){var netmap=this._netmap;if(null===netmap||!intf||!intf.intfKeyObj)return null;try{var topoLinks=netmap._getAllTopoLink();for(var i=0;i<topoLinks.length;i++){var linkLine=topoLinks[i];var topoType=linkLine.getTopoType();var devIdDest=linkLine.getDevIdDest();var intfInfoDest=linkLine.getIntfInfoDest();if(devId==devIdDest&&intfInfoDest&&intfInfoDest.intf&&intfInfoDest.intf.intfKeyObj.value===intf.intfKeyObj.value)return{devId:devIdDest,intf:intfInfoDest.intf,topoType:topoType};var devIdSrc=linkLine.getDevIdSrc();var intfInfoSrc=linkLine.getIntfInfoSrc();if(devId==devIdSrc&&intfInfoSrc&&intfInfoSrc.intf&&intfInfoSrc.intf.intfKeyObj.value===intf.intfKeyObj.value)return{devId:devIdSrc,intf:intfInfoSrc.intf,topoType:topoType}}}catch(ex){return null}},removePathNotes:function(pathData){var netmap=this._netmap;var diagram=netmap._diagram;var pathNotes=_.filter(diagram.model.nodeDataArray,(function(node){return isPathNote(node)&&node.pathId&&node.pathId===pathData.pathId}));var transactionName=NgUtil.getUniqueStr("removePathNotes");netmap._diagram.startTransaction(transactionName);_.each(pathNotes,(function(note){netmap._removeNode(note)}));netmap._diagram.commitTransaction(transactionName)},removeDataViewNote:function(deviceIds,onlyIntfNote){var netmap=this._netmap;var allWillDeleteNote=[];if(null===netmap)return allWillDeleteNote;try{var transactionName=NgUtil.getUniqueStr("removeDataViewNote");netmap._diagram.startTransaction(transactionName);if(deviceIds&&deviceIds.length>0)_.each(deviceIds,(function(devId){var node=netmap._diagram.findNodeForKey(devId);if(node){node.linksConnected.each((function(link){if(link){if(link.toNode&&netBrain.Map.CategoryMgr.isDeviceNote(link.toNode.data.category)&&link.toNode.data.noteFromType===netBrain.Map.Const.NoteFromType.DataView){if(!0===onlyIntfNote&&!link.data.fromPort)return;allWillDeleteNote.push(link.toNode.data)}if(link.fromNode&&netBrain.Map.CategoryMgr.isDeviceNote(link.fromNode.data.category)&&link.fromNode.data.noteFromType===netBrain.Map.Const.NoteFromType.DataView){if(!0===onlyIntfNote&&!link.data.toPort)return;allWillDeleteNote.push(link.fromNode.data)}}}))}}));else{allWillDeleteNote=netmap._getAllDrawObjectsByFilter((function(node){return netBrain.Map.CategoryMgr.isDeviceNote(node.category)&&node.noteFromType===netBrain.Map.Const.NoteFromType.DataView}))}_.each(allWillDeleteNote,(function(item){netmap._removeNode(item)}));netmap._diagram.commitTransaction(transactionName);return allWillDeleteNote}catch(ex){return allWillDeleteNote}},extendNeighbors:function(nbrInfoList,onlyExtendToMedia,isNew,isNewNbrConstruction){try{var extendNbrOp=this.getExtendNbrOp();return null==extendNbrOp?null:0===nbrInfoList.length?null:extendNbrOp.extendNeighbors(nbrInfoList,onlyExtendToMedia,isNew,isNewNbrConstruction)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}},extendNeighborsWithDataViewsSegment:function(nbrInfoList,dataViewsSegment,applyDataViewSrvc){try{var extendNbrOp=this.getExtendNbrOp();return null==extendNbrOp?null:extendNbrOp.extendNeighborsWithDataViewsSegment(nbrInfoList,dataViewsSegment,null,!1,applyDataViewSrvc)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}},doAddBoardlink:function(dataViewCacheSrvc,site,deviceInfoList,text){try{var extendNbrOp=this.getExtendNbrOp();return null==extendNbrOp?null:extendNbrOp.doAddBoardlinkOnDiagram(dataViewCacheSrvc,site,deviceInfoList,text)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}},addDevices:function(httpExternNbrSrvc,devInfoList,topoTypeId,nbrSite,drawLocation,autoLinkOptionSrvc,applyDataViewSrvc,avoidBlockUI,isNotAutoLink){var deferred=this._q.defer();try{var addDevicesOp=this.getAddDevicesOp();if(null==addDevicesOp||null==devInfoList){deferred.resolve();return deferred.promise}var nbrNodeList=[];if(devInfoList[0].isSite){var sites=this.getAllSites();for(var i=0;i<sites.length;i++)nbrNodeList.push({id:sites[i].getKey(),isSite:!0});var devices=this.getAllDevcies(null,!0);for(var j=0;j<devices.length;j++)1024===devices[j].devType&&nbrNodeList.push({id:devices[j].getKey(),isSite:!1,isMPLSCloud:!0})}else{var devices1=this.getAllDevcies(null,!0);for(var k=0;k<devices1.length;k++)nbrNodeList.push({id:devices1[k].getKey(),isSite:!1})}nbrNodeList.length>0&&devInfoList.forEach((function(item){nbrNodeList.push(item)}));if(autoLinkOptionSrvc)return autoLinkOptionSrvc&&autoLinkOptionSrvc.autolinkOption().then((function(topoIds){if(void 0!==topoIds){var topoIdList="";topoIds&&angular.isArray(topoIds)&&(topoIdList=topoIds.join(","));var promise=addDevicesOp.addDevices(httpExternNbrSrvc,devInfoList,topoIdList,nbrSite,nbrNodeList,applyDataViewSrvc,drawLocation,avoidBlockUI);null!=promise&&promise.then((function(){deferred.resolve()}),(function(){deferred.reject()}));return deferred.promise}}));isNotAutoLink&&(nbrNodeList=null);var promise=addDevicesOp.addDevices(httpExternNbrSrvc,devInfoList,topoTypeId,nbrSite,nbrNodeList,applyDataViewSrvc,drawLocation,avoidBlockUI);null!=promise&&promise.then((function(){deferred.resolve()}),(function(){deferred.reject()}));return deferred.promise}catch(ex){deferred.resolve();return deferred.promise}},selectAllLinkByTopoType:function(topoTypeID){var autolinkOp=this.getAutolinkOp();if(null!=autolinkOp)return autolinkOp.selectAllLinkByTopoType(topoTypeID)},unlinkAllByTopoType:function(topoTypeID){var autolinkOp=this.getAutolinkOp();if(null!=autolinkOp)return autolinkOp.unlinkAllByTopoType(topoTypeID)},autoLink:function(httpExternNbrSrvc,topoTypeId,nbAlertSrvc,applyDataViewSrvc){try{var autolinkOp=this.getAutolinkOp();if(null==autolinkOp)return;return autolinkOp.autoLink(httpExternNbrSrvc,topoTypeId,nbAlertSrvc,applyDataViewSrvc)}catch(ex){console.warn("autoLink get error: "+ex.toString())}},autoLinkByNodeIds:function(httpExternNbrSrvc,nodes,autoLinkOptionSrvc,dataViewCacheSrvc,nbAlertSrvc,skipLayoutNodeIds){var autolinkOp=this.getAutolinkOp();if(null!=autolinkOp&&null!=nodes){var devInfoList=[];nodes.forEach((function(item){devInfoList.push(NgUtil.cloneJson(item))}));var nbrList=[];if(nodes[0].isMPLSCloud){var sites=this.getAllSites();for(var i=0;i<sites.length;i++)nbrList.push({id:sites[i].getKey(),isSite:!0});var devices=this.getAllDevcies(null,!0);for(var j=0;j<devices.length;j++){var obj={id:devices[j].getKey(),vsNodeIdentify:devices[j].getVSNodeIdentify(),isSite:!1,hostName:devices[j].getHostname()};nbrList.push(obj)}}else if(devInfoList[0].isSite){sites=this.getAllSites();for(i=0;i<sites.length;i++)nbrList.push({id:sites[i].getKey(),isSite:!0});devices=this.getAllDevcies(null,!0);for(j=0;j<devices.length;j++)if(1024===devices[j].devType){obj={id:devices[j].getKey(),vsNodeIdentify:devices[j].getVSNodeIdentify(),isSite:!1,isMPLSCloud:!0,hostName:devices[j].getHostname()};nbrList.push(obj)}}else{devices=this.getAllDevcies(null,!0);for(j=0;j<devices.length;j++){obj={id:devices[j].getKey(),vsNodeIdentify:devices[j].getVSNodeIdentify(),isSite:!1,hostName:devices[j].getHostname()};nbrList.push(obj)}}return autoLinkOptionSrvc&&autoLinkOptionSrvc.autolinkOption().then((function(topoIds){if(topoIds)return autolinkOp.autoLinkByNodeIds(httpExternNbrSrvc,devInfoList,nbrList,topoIds.join(","),dataViewCacheSrvc,nbAlertSrvc,skipLayoutNodeIds)}))}},flaotMeauAutoLink:function(httpExternNbrSrvc,mediaId,topoTypeID,nbAlertSrvc,applyDataViewSrvc){try{var autolinkOp=this.getAutolinkOp();if(null==autolinkOp)return;return autolinkOp.flaotMeauAutoLink(httpExternNbrSrvc,mediaId,topoTypeID,nbAlertSrvc,applyDataViewSrvc)}catch(ex){console.log("flaotMeauAutoLink get error: "+ex.toString())}},autoLinkBetweenDevices:function(httpExternNbrSrvc,lsCompDev,topoTypeID,nbAlertSrvc){var autolinkOp=this.getAutolinkOp();if(null!=autolinkOp)return autolinkOp.autoLinkBetweenDevices(httpExternNbrSrvc,lsCompDev,topoTypeID,nbAlertSrvc)},onSelectionDeleted:function(e){var netmap=this._netmap;if(null!=netmap&&null!=e&&null!=e.subject&&!(e.subject.count<=0)){var transactionName=NgUtil.getUniqueStr("onSelectionDeleted");netmap._diagram.startTransaction(transactionName);var it=e.subject.iterator;for(;it.next();){var part=it.value;null!=part&&(part instanceof netBrain.Map.PathLink||part instanceof netBrain.Map.BasePathLink)&&null!=this.diagramPathManager&&this.diagramPathManager.onDeletePathObj(this._netmap._diagram,part)}netmap._diagram.commitTransaction(transactionName);(function(e){var result=!1;e.subject.each((function(o){o.data&&o.data.dataViewData&&(result=!0)}));return result})(e)&&this.getRootScope().$emit("refreshDataViewList",!0)}},onClipboardPasted:function(e){var diagramModel=e.diagram.model;var stencilParts=diagramModel.nodeDataArray.filter((function(partData){return"CompStencil"===partData.constructor.name}));var stencilCategoryMap=_.groupBy(stencilParts,"displayName");var maxApendixMap=_.mapObject(stencilCategoryMap,(function(partsData){return partsData.reduce((function(max,partData){var appendix=partData.hostName.replace(partData.displayName,"");return/^\d+$/.test(appendix)?max>parseInt(appendix)?max:parseInt(appendix):max}),0)}));e.subject.each((function(part){var thisPartData=diagramModel.findNodeDataForKey(part.key);if("CompStencil"===thisPartData.constructor.name){maxApendixMap[thisPartData.displayName]++;var newDisplayName=thisPartData.displayName+maxApendixMap[thisPartData.displayName];var newLocation=thisPartData.location.split(" ").map((function(p){return Number(p)+Math.floor(200*Math.random()-100)})).join(" ");diagramModel.setDataProperty(thisPartData,"hostName",newDisplayName);diagramModel.setDataProperty(thisPartData,"location",newLocation)}}))},dropPosition:function(dragDeviceCount,event){var diagramWidth=this._netmap._diagram.div.getBoundingClientRect().width;var ptLocation;if((ptLocation=event?netBrain.Map.GoDiagramPositionUtil.getDropPtLocation(this._netmap._diagram,event):netBrain.Map.GoDiagramPositionUtil.getPosRet(this._netmap._diagram)).x+140*dragDeviceCount.x>diagramWidth){dragDeviceCount.x=0;dragDeviceCount.y++;ptLocation.x+=140*dragDeviceCount.x;ptLocation.y+=140*dragDeviceCount.y}else{ptLocation.x+=140*dragDeviceCount.x;ptLocation.y+=140*dragDeviceCount.y}return ptLocation},highlightNode:function(node){var $q=this._q.defer();this._netmap._highlightNode(node,$q);return $q.promise},checkExistNodeForAddToMap:function(nodeIds){var transactionName=NgUtil.getUniqueStr("check node exist");var self=this;self._netmap._diagram.startTransaction(transactionName);var diagram=self._netmap._diagram;var newNodeIds=[];_.each(nodeIds,(function(id){var findnode=diagram.findNodeForKey(id);if(findnode){self._netmap._centerNode(findnode.data,!0);self.highlightNode(findnode.data)}else newNodeIds.push(id)}));self._netmap._diagram.commitTransaction(transactionName);return newNodeIds},dropDeviceByDefault:function(dataViewsSegmentIn,event,ptLocationNew,httpExternNbrSrvc,autoLinkOptionSrvc,dataViewCacheSrvc,nbAlertSrvc,applyDataViewSrvc,skipLayoutNodeIds){var $q=this._q.defer();if(null==dataViewsSegmentIn){$q.resolve();return $q.promise}var self=this;var addNodeIds=_.pluck(dataViewsSegmentIn.devDataViewSegmentList,"devId");addNodeIds=self.checkExistNodeForAddToMap(addNodeIds);dataViewsSegmentIn.devDataViewSegmentList=_.filter(dataViewsSegmentIn.devDataViewSegmentList,(function(item){return _.contains(addNodeIds,item.devId)}));if(0===dataViewsSegmentIn.devDataViewSegmentList.length){$q.resolve();return $q.promise}this._dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegmentIn).then((function(dataViewsSegmentOut){if(null==dataViewsSegmentOut){$q.resolve();return $q.promise}dataViewsSegmentOut.__proto__=new DataViewsSegment;var devDataViewSegmentList=dataViewsSegmentOut.getDevDataViewSegmentList();var transactionName=NgUtil.getUniqueStr("drop all device");self._netmap._diagram.startTransaction(transactionName);if(null!=devDataViewSegmentList){var rectMap=self._netmap._diagram.div.getBoundingClientRect();var deviceNodeInfoList=[];var ptLocation=ptLocationNew;null==ptLocation&&null!=event&&event.clientX>rectMap.left&&event.clientY>rectMap.top&&(ptLocation=netBrain.Map.GoDiagramPositionUtil.getDropPtLocation(self._netmap._diagram,event));var lastNode,node;if(1===devDataViewSegmentList.length){event||(ptLocation=netBrain.Map.GoDiagramPositionUtil.getPosRet(self._netmap._diagram));if(null!=(node=dataViewsSegmentOut.getDevSegmentDevDataView(devDataViewSegmentList[0]))){lastNode=node;self.dropDeviceByDataView(node,ptLocation)}}else{var selectNodeArray=[];for(var i=0;i<devDataViewSegmentList.length;i++){var devDataViewSegment=devDataViewSegmentList[i];if(null!=(node=dataViewsSegmentOut.getDevSegmentDevDataView(devDataViewSegment))){if(dataViewsSegmentIn){var segmentInList=dataViewsSegmentIn.getDevDataViewSegmentList();var inItem=_.find(segmentInList,(function(item){if(item.devId===devDataViewSegment.devId)return item}));if(null!=inItem&&null!=inItem.ptLocation){ptLocation=inItem.ptLocation;deviceNodeInfoList.push({data:node,location:ptLocation})}}self._netmap._isExistNode(node)&&selectNodeArray.push(node);if(self.dropDeviceByDataView(node,ptLocation)){if(i%16==0){lastNode=node;ptLocation=self._netmap._findProperNeighborPosition(lastNode)}}else;}}self._netmap._selectNodes(selectNodeArray)}}var devList=[];var autolinkPromise;if(null!=devDataViewSegmentList){for(i=0;i<devDataViewSegmentList.length;i++){var dataViewSegment=devDataViewSegmentList[i];if(dataViewSegment){var devNodeData={id:dataViewSegment.devId};dataViewSegment.devDataView&&(devNodeData=dataViewSegment.devDataView.devNodeData||devNodeData);var device=self.getCompDeviceByKey(devNodeData.id);if(device){(devNodeData.visualSpaceInfo?devNodeData.visualSpaceInfo.visualSpaceInstanceId:null)==(device.devNodeData&&device.devNodeData.visualSpaceInfo?device.devNodeData.visualSpaceInfo.visualSpaceInstanceId:null)&&devList.push({id:dataViewSegment.devId,vsNodeIdentify:{id:devNodeData.id,nodeIdentify:devNodeData.nodeIdentify,visualSpaceInfo:devNodeData.visualSpaceInfo},isMPLSCloud:null!=dataViewSegment.devDataView&&1024===dataViewSegment.devDataView.devType,hostName:null==dataViewSegment.devDataView?"":dataViewSegment.devDataView.hostName})}}}skipLayoutNodeIds=skipLayoutNodeIds&&Array.isArray(skipLayoutNodeIds)?skipLayoutNodeIds.concat(_.pluck(selectNodeArray,"key")):_.pluck(selectNodeArray,"key");devList.length>0&&(autolinkPromise=self.autoLinkByNodeIds(httpExternNbrSrvc,devList,autoLinkOptionSrvc,dataViewCacheSrvc,nbAlertSrvc,skipLayoutNodeIds));(autolinkPromise=autolinkPromise||self._q.resolve()).then((function(){if(devDataViewSegmentList.length>1){var noLink=!0;var info,data,device;for(var k=0,len=deviceNodeInfoList.length;k<len;k++){data=(info=deviceNodeInfoList[k]).data;if(device=self._netmap._diagram.findNodeForKey(data.key)){if(device.linksConnected.count>0){noLink=!1;break}}}if(noLink)for(var ii=0,length=deviceNodeInfoList.length;ii<length;ii++){data=(info=deviceNodeInfoList[ii]).data;var location=info.location;(device=self._netmap._diagram.findNodeForKey(data.key))&&(device.location=location)}}}))}(autolinkPromise=autolinkPromise||self._q.resolve()).then((function(){var dragDeviceIds=_.pluck(devDataViewSegmentList,"devId");applyDataViewSrvc.applyDataviewsOnDevices(dragDeviceIds,null,self._netmap,!1,!0);self._netmap._diagram.commitTransaction(transactionName);var diagram=self._netmap._diagram;var moveToNode;if(lastNode)moveToNode=lastNode;else{var moveToNodeId=_.find(dragDeviceIds,(function(id){return diagram.model.findNodeDataForKey(id)}));moveToNodeId&&(moveToNode=diagram.model.findNodeDataForKey(moveToNodeId))}if(moveToNode){var device=diagram.findNodeForKey(moveToNode.key);device&&!device.actualBounds.intersectsRect(diagram.viewportBounds)&&self._netmap._centerNode(moveToNode,!0);self._netmap.layoutLinkLabels()}$q.resolve()}))}));return $q.promise},dropDeviceByDragDeviceData:function(dragDevObj,event,ptLocation,httpExternNbrSrvc,autoLinkOptionSrvc,dataViewCacheSrvc,nbAlertSrvc,applyDataViewSrvc){var deferred=this._q.defer();var lsMediaInfos=[];var dataViewsSegmentIn=new DataViewsSegment;if(dragDevObj&&Array.isArray(dragDevObj))for(var i=0;i<dragDevObj.length;i++){var theObj=dragDevObj[i];if(theObj.isMedia){lsMediaInfos.push({id:theObj.id,topoType:theObj.topoType,isMedia:theObj.isMedia,isWAN:theObj.isWAN,isMPLSCloud:theObj.isMPLSCloud,location:theObj.ptLocation});theObj.isMPLSCloud&&dataViewsSegmentIn.addDev(theObj.id,theObj.ptLocation,theObj.isMPLSCloud)}else dataViewsSegmentIn.addDev(theObj.id,theObj.ptLocation,theObj.isMPLSCloud,theObj.devNodeData)}else dragDevObj.isMedia?lsMediaInfos.push({id:dragDevObj.id,topoType:dragDevObj.topoType,isMedia:dragDevObj.isMedia,isWAN:dragDevObj.isWAN,isDMVPN:dragDevObj.isDMVPN,location:dragDevObj.ptLocation}):dataViewsSegmentIn.addDev(dragDevObj.id,dragDevObj.ptLocation,dragDevObj.isMPLSCloud,dragDevObj.devNodeData);if(lsMediaInfos.length>0)return this.addDevices(httpExternNbrSrvc,lsMediaInfos,lsMediaInfos[0].topoType);if(dataViewsSegmentIn.getDevDataViewSegmentList().length>0)return this.dropDeviceByDefault(dataViewsSegmentIn,event,ptLocation,httpExternNbrSrvc,autoLinkOptionSrvc,dataViewCacheSrvc,nbAlertSrvc,applyDataViewSrvc);deferred.resolve();return deferred.promise},drawSite:function(httpSiteSrvc,drawObjs,event,httpExternNbrSrvc,autoLinkOptionSrvc,dataViewCacheSrvc,nbAlertSrvc,applyDataViewSrvc){if(null!=drawObjs&&httpSiteSrvc)try{var context=this;var siteIds=_.pluck(drawObjs,"id");if(0===(siteIds=context.checkExistNodeForAddToMap(siteIds)).length)return;var sites=[];var ptLocation;ptLocation=event?netBrain.Map.GoDiagramPositionUtil.getDropPtLocation(context._netmap._diagram,event):netBrain.Map.GoDiagramPositionUtil.getPosRet(context._netmap._diagram);httpSiteSrvc.getSitesByIds(siteIds).then((function(data){sites=data;var devList=[];angular.forEach(sites,(function(site){Object.setPrototypeOf(site,new SitePropertie);var srcCompDev=context._getCompSite(site);context.dropDeviceByDataView(srcCompDev,ptLocation);devList.push({id:site.ID,isSite:!0})}));context.autoLinkByNodeIds(httpExternNbrSrvc,devList,autoLinkOptionSrvc,dataViewCacheSrvc,nbAlertSrvc,[])}),(function(reason){}))}catch(ex){console.warn("drawSite get error: "+ex.toString())}},drawMedia:function(httpMediaSrvc,drawObjs,event){if(null!=drawObjs&&httpMediaSrvc){var context=this;var mediaIds=_.pluck(drawObjs,"id");var medias=[];0!==(mediaIds=context.checkExistNodeForAddToMap(mediaIds)).length&&httpMediaSrvc.listMediaInfosByIds(null,mediaIds).then((function(data){medias=data;angular.forEach(medias,(function(media){Object.setPrototypeOf(media,new SitePropertie);var srcCompDev=context._getCompMedia(media);var ptLocation=null;event&&1===medias.length&&(ptLocation=netBrain.Map.GoDiagramPositionUtil.getDropPtLocation(context._netmap._diagram,event));context.dropDeviceByDataView(srcCompDev,ptLocation)}))}),(function(reason){}))}},drawDeviceGroup:function(deviceGroupInfo,point){var netmap=this._netmap;if(null!=netmap&&null!=deviceGroupInfo){if(0!==this.checkExistNodeForAddToMap([deviceGroupInfo.id]).length){var compDeviceGroup=netBrain.Map.CompDeviceGroup.getDefaultJsonData();compDeviceGroup.key=deviceGroupInfo.id;compDeviceGroup.hostName=deviceGroupInfo.name;compDeviceGroup.hasInterface=deviceGroupInfo.hasInterface;try{var transactionName=NgUtil.getUniqueStr("drop device group");netmap._diagram.startTransaction(transactionName);if(null==netmap._diagram.findNodeForData(deviceGroupInfo)){netBrain.Map.CompPrototypeFactory.buildCompPrototype(compDeviceGroup);point||compDeviceGroup.setLocation(go.Point.stringify(this._getPosRet()));if(netmap._isExistNode(compDeviceGroup)){netmap._centerNode(compDeviceGroup);this.highlightNode(compDeviceGroup)}else this.addDeviceGroup(compDeviceGroup)}netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction(transactionName)}catch(ex){console.warn("drawDeviceGroup get error: "+ex.toString())}}}},addNodeGoJsTemplate:function(category,template){var netmap=this._netmap;if(null!=netmap){netmap.getGoJsDiagram().nodeTemplateMap.add(category,template)}},addLinkGoJsTemplate:function(category,template){var netmap=this._netmap;if(null!=netmap){netmap.getGoJsDiagram().linkTemplateMap.add(category,template)}},addGroupGoJsTemplate:function(category,template){var netmap=this._netmap;if(null!=netmap){netmap.getGoJsDiagram().groupTemplateMap.add(category,template)}},drawVisualSpaceNode:function(visualSpaceObj,point){var netmap=this._netmap;if(null!=netmap&&null!=visualSpaceObj)try{var transactionName=NgUtil.getUniqueStr("drop visual space");netmap._diagram.startTransaction(transactionName);netmap._isExistNode(visualSpaceObj)?netmap._centerNode(visualSpaceObj):this.addVisualSpaceNode(visualSpaceObj);netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction(transactionName)}catch(ex){console.log("drawvisualspace get error: "+ex.toString())}},dropDeviceByDataView:function(devDataView,point){if(null==devDataView)return!1;var isExist=!1;var netmap=this._netmap;if(null==netmap)return!1;if(!this.getVisualSpaceOp().preDropNodeByDataView(devDataView,point))return!1;try{var transactionName=NgUtil.getUniqueStr("drop device");netmap._diagram.startTransaction(transactionName);if(null==netmap._diagram.findNodeForData(devDataView)){point||(point=netmap._findProperNeighborPosition({key:1}));if(netmap._isExistNode(devDataView)){netmap._centerNode(devDataView,!0);this.highlightNode(devDataView);isExist=!0}else{var compNewDev=devDataView;netBrain.Map.CompPrototypeFactory.buildCompPrototype(devDataView);compNewDev.setLocation(go.Point.stringify(point));this.addDevice(compNewDev);netmap.refreshMapViewOptionVisible();netmap.getCurrentScope().notifyHighlightChanged()}}netmap._diagram.commitTransaction(transactionName);return isExist}catch(ex){console.warn("dropDeviceByDataView get error: "+ex.toString())}},highLightDevices:function(event,d){var netmap=this._netmap;if(netmap){var data=d.value||d;var promises=[];var alldevices=netmap._getAllDevices();for(var i=data.dataViewInfo.dataViewGroup.relativeDevices.length-1;i>=0;i--){if(d=_.find(alldevices,(function(device){return device.key===data.dataViewInfo.dataViewGroup.relativeDevices[i]}))){var promise=this.highlightNode(d);promises.push(promise)}}return this._q.all(promises)}},applyDv:function(event,d,applyDataView,addinionalDevices){var data=d.value||d;var diagram=this._netmap.getGoJsDiagram();if(diagram){diagram.skipsUndoManager=!0;var deferred=this._q.defer();applyDataView(event,data,addinionalDevices).then((function(){deferred.resolve();diagram.skipsUndoManager=!1}),(function(){diagram.skipsUndoManager=!1}));return deferred.promise}},applyDataView:function(dataViewCacheSrvc,applyDataViewInfoObj,devId,isForceApply,isIgnoreOthers,applyDataViewSrvc){if(null!=applyDataViewInfoObj){var netmap=this._netmap;if(null!=netmap){var deferred=this._q.defer();netmap.setApplyDataViewInfo(applyDataViewInfoObj);netmap.isMonitoring()&&netmap.setApplyDVAfterRun(!0);if(null==devId||Array.isArray(devId))if(Array.isArray(devId)){var promise2=this.applyDataViewOnDevices(dataViewCacheSrvc,applyDataViewInfoObj.getDataViewGroupId(),devId,isForceApply,isIgnoreOthers);null!=promise2&&promise2.then((function(){deferred.resolve()}),(function(){deferred.reject()}))}else{var applyType=applyDataViewInfoObj.getApplyType();if(applyType===DataViewApplyType.dvgApply){var promise4=null;if(netmap.isDisplaySwitchMode()){var dataViewApplyOp=this.getDataViewApplyOp();if(null==dataViewApplyOp){deferred.reject();return deferred.promise}netmap.removeAllAppliedDataViews();netmap.setApplyDataViewInfo(applyDataViewInfoObj);promise4=dataViewApplyOp.resetDefaultDataView(dataViewCacheSrvc)}promise4?promise4.then((function(){applyDataViewSrvc.applyDataviewsOnDevicesWithPermissionAlert([],applyDataViewInfoObj.dataViewInfo.dataViewGroupId,netmap).then((function(){deferred.resolve()}),(function(){deferred.reject()}))}),(function(){deferred.reject()})):applyDataViewSrvc.applyDataviewsOnDevicesWithPermissionAlert([],applyDataViewInfoObj.dataViewInfo.dataViewGroupId,netmap).then((function(){deferred.resolve()}),(function(){deferred.reject()}))}else if(applyType===DataViewApplyType.compoundDVApply){var promise5=this.applyCompoundDataView(dataViewCacheSrvc,applyDataViewInfoObj);null!=promise5&&promise5.then((function(){deferred.resolve()}),(function(){deferred.reject()}))}}else{var promise1=this.applyDataViewOnOneDevice(dataViewCacheSrvc,applyDataViewInfoObj.getDataViewGroupId(),devId,isForceApply,isIgnoreOthers);null!=promise1&&promise1.then((function(){deferred.resolve()}),(function(){deferred.reject()}))}return deferred.promise}}},applyDataViewGroup:function(dataViewCacheSrvc,dvgId,isForceApply,time){try{var deferred=this._q.defer();var dataViewApplyOp=this.getDataViewApplyOp();if(null==dataViewApplyOp){deferred.reject();return deferred.promise}var promise=dataViewApplyOp.applyDataViewGroup(dataViewCacheSrvc,dvgId,isForceApply,time);null!=promise&&promise.then((function(){deferred.resolve()}),(function(){deferred.reject()}));return deferred.promise}catch(ex){console.error("applyDataViewGroup get error: "+ex.toString())}},applyDataViewGroupByAlog:function(dataViewCacheSrvc,applyDataViewInfo,alogId,isForceApply,time){try{if(null==applyDataViewInfo)return null;var deferred=this._q.defer();var netmap=this._netmap;netmap.setApplyDataViewInfo(applyDataViewInfo);netmap.isMonitoring()&&netmap.setApplyDVAfterRun(!0);var dataViewApplyOp=this.getDataViewApplyOp();if(null==dataViewApplyOp){deferred.reject();return deferred.promise}if(applyDataViewInfo.getApplyType()!==DataViewApplyType.dvgApply){deferred.reject();return deferred.promise}var promise=dataViewApplyOp.applyDataViewGroupByAlog(dataViewCacheSrvc,applyDataViewInfo.getDataViewGroupId(),alogId,isForceApply,time);null!=promise&&promise.then((function(data){deferred.resolve(data)}),(function(error){deferred.reject(error)}));return deferred.promise}catch(ex){console.error("applyDataViewGroupByAlog get error: "+ex.toString())}},applyDataViewOnOneDevice:function(dataViewCacheSrvc,dvgId,devId,isForceApply,isIgnoreOthers){try{var deferred=this._q.defer();var dataViewApplyOp=this.getDataViewApplyOp();if(null==dataViewApplyOp){deferred.reject();return deferred.promise}if(null==devId)return;var devIds=[];devIds.push(devId);var promise=dataViewApplyOp.applyDataViewOnDevices(dataViewCacheSrvc,dvgId,devIds,isForceApply,isIgnoreOthers);null!=promise&&promise.then((function(){deferred.resolve()}),(function(){deferred.reject()}));return deferred.promise}catch(ex){console.error("applyDataViewOnOneDevice get error: "+ex.toString())}},applyDataViewOnDevices:function(dataViewCacheSrvc,dvgId,devIds,isForceApply,isIgnoreOthers){try{var deferred=this._q.defer();var dataViewApplyOp=this.getDataViewApplyOp();if(null==dataViewApplyOp){deferred.reject();return deferred.promise}if(null==devIds){deferred.reject();return deferred.promise}var promise=dataViewApplyOp.applyDataViewOnDevices(dataViewCacheSrvc,dvgId,devIds,isForceApply,isIgnoreOthers);null!=promise&&promise.then((function(){deferred.resolve()}),(function(){deferred.reject()}));return deferred.promise}catch(ex){console.error("applyDataViewOnDevices get error: "+ex.toString())}},applyCompoundDataView:function(dataViewCacheSrvc,applyDataViewInfoObj){try{var deferred=this._q.defer();var dataViewApplyOp=this.getDataViewApplyOp();if(null==dataViewApplyOp){deferred.reject();return deferred.promise}var promise=dataViewApplyOp.applyCompoundDataView(dataViewCacheSrvc,applyDataViewInfoObj);null!=promise&&promise.then((function(){deferred.resolve()}),(function(){deferred.reject()}));return deferred.promise}catch(ex){console.error("applyCompandDataView get error: "+ex.toString())}},resetDefaultDataView:function(dataViewCacheSrvc,bSetApplyDVAfterRun,exceptDvgId,notRemoveAppliedDataviews){try{var deferred=this._q.defer();var dataViewApplyOp=this.getDataViewApplyOp();if(null==dataViewApplyOp){deferred.reject();return deferred.promise}var netmap=this._netmap;netmap.isMonitoring()&&(bSetApplyDVAfterRun||null==bSetApplyDVAfterRun)&&netmap.setApplyDVAfterRun(!0);notRemoveAppliedDataviews||netmap.removeAllAppliedDataViewInfosExceptById(exceptDvgId);netmap.setBackColor(NetBrain.Map.Const.nbDefaultPageColor);var promise=dataViewApplyOp.resetDefaultDataView(dataViewCacheSrvc);null!=promise&&promise.then((function(){deferred.resolve()}),(function(ex){console.error(ex);deferred.reject()}));return deferred.promise}catch(ex){console.error("resetDefaultDataView get error: "+ex.toString())}},resetDefaultDataViewByDeviceIds:function(dataViewCacheSrvc,forDeviceIds){try{var deferred=this._q.defer();var dataViewApplyOp=this.getDataViewApplyOp();if(null==dataViewApplyOp){deferred.reject();return deferred.promise}var promise=dataViewApplyOp.resetDefaultDataViewByDeviceIds(dataViewCacheSrvc,forDeviceIds);null!=promise&&promise.then((function(){deferred.resolve()}),(function(){deferred.reject()}));return deferred.promise}catch(ex){console.error("resetDefaultDataViewByDeviceIds get error: "+ex.toString())}},drawStencilItem:function(stencilItemObj,event){try{var ptLocation=netBrain.Map.GoDiagramPositionUtil.getDropPtLocation(this._netmap._diagram,event);if(null==ptLocation)return;this.addOneStencil(stencilItemObj,ptLocation)}catch(ex){console.warn("drawStencilItem get error: "+ex.toString())}return!0},addOneStencil:function(stencilItemObj,ptLocation){if(null!=stencilItemObj){var netmap=this._netmap;if(null==netmap)return null;var posIndex=0;var allHaveStencilItems=netmap._getAllDrawObjectsByFilter((function(node){return(node.getCategory()===netBrain.Map.CategoryMgr.Stencil||node.getCategory()===netBrain.Map.CategoryMgr.StencilExt)&&0===node.getHostname().indexOf(stencilItemObj.displayName)}));for(var i=0;i<allHaveStencilItems.length;i++){var honame=allHaveStencilItems[i].getHostname();var index=parseInt(honame.replace(stencilItemObj.displayName,""));posIndex=Math.max(posIndex,index+1)}try{void 0===ptLocation&&(ptLocation=this._getPosRet());this.addStencil(stencilItemObj.displayName+posIndex,stencilItemObj,ptLocation);netmap.refreshMapViewOptionVisible()}catch(ex){console.warn("addOneStencil get error: "+ex.toString())}}},addOneTable:function(nRow,nCol){var netmap=this._netmap;if(null!=netmap){if(null!=netmap.getGoJsDiagram())try{var comTable=new netBrain.Map.CompTable;comTable.CreateTable(nRow,nCol);var size=comTable.getDefaultTableSize();var ptCenter=this._getPosRet();ptCenter.offset(-size.width/2,-size.height/2);comTable.setPosition(ptCenter);comTable.UpdateDataToJson();var tableData=comTable.getNodeDataJsonObj();netBrain.Map.CompPrototypeFactory.buildCompPrototype(tableData);netmap._addNode(tableData)}catch(ex){console.warn("addOneTable get error: "+ex.toString())}}},doLayout:function(){try{var netmap=this._netmap;if(null==netmap)return;var transactionName=NgUtil.getUniqueStr("doLayout");netmap._diagram.startTransaction(transactionName);var layout=netmap._diagram.layout;var bForce=layout instanceof netBrain.Map.ForceDirectedLayoutEx;var bTree=layout instanceof go.TreeLayout;var bCircular=layout instanceof go.CircularLayout;if(!(bForce||bTree||bCircular)){var layoutEx=new netBrain.Map.ForceDirectedLayoutEx;netmap._diagram.layout=layoutEx}netmap._diagram.layoutDiagram(!0);netmap._diagram.commitTransaction(transactionName)}catch(ex){console.warn("doLayout get error: "+ex.toString())}},treeLayout:function(){try{var netmap=this._netmap;if(null==netmap)return;var transactionName=NgUtil.getUniqueStr("treeLayout");netmap._diagram.startTransaction(transactionName);new netBrain.Map.QMapTreeLayout(1,!1).doLayout(netmap._diagram);netmap._diagram.commitTransaction(transactionName);netmap.refreshMapViewOptionVisible()}catch(ex){console.warn("treeLayout get error: "+ex.toString())}},treeLayoutNew:function(direction){try{var netmap=this._netmap;if(null==netmap)return;var diagram=netmap._diagram;var transactionName=NgUtil.getUniqueStr("treeLayoutNew");diagram.startTransaction(transactionName);var options={direction:direction,nodeDistance:5};netmap.getTopologyType()===netBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite&&(options.rootNodeId=netmap.findRootSite().key);new netBrain.Map.LayoutToolsHelper(this).treeLayout(options);diagram.commitTransaction(transactionName);netmap.refreshMapViewOptionVisible()}catch(ex){console.warn("treeLayoutNew get error: "+ex.toString())}},forceDirectedLayout:function(){try{var netmap=this._netmap;if(null==netmap)return;var transactionName=NgUtil.getUniqueStr("forceDirectedLayout");netmap._diagram.startTransaction(transactionName);(new netBrain.Map.ForceDirectedLayoutEx).doLayout(netmap._diagram);netmap._diagram.commitTransaction(transactionName);netmap.refreshMapViewOptionVisible()}catch(ex){console.warn("forceDirectedLayout get error: "+ex.toString())}},forceDirectedLayoutNew:function(ids){try{var netmap=this._netmap;if(null==netmap)return;var diagram=netmap._diagram;var transactionName=NgUtil.getUniqueStr("forceDirectedLayoutNew");diagram.startTransaction(transactionName);netBrain.Map.LayoutToolsHelper(this);var options={newNodes:ids};new netBrain.Map.LayoutToolsHelper(this).symmetricLayout(options);netmap.isL2MapStyle()&&netBrain.L2Improvements.l2ImprovementsHelper.alignNodes(diagram.nodes);diagram.commitTransaction(transactionName);netmap.refreshMapViewOptionVisible()}catch(ex){console.warn("forceDirectedLayoutNew get error: "+ex.toString())}},circularLayout:function(){try{var netmap=this._netmap;if(null==netmap)return;var transactionName=NgUtil.getUniqueStr("circularLayout");netmap._diagram.startTransaction(transactionName);var layout=new go.CircularLayout;netmap.getTopologyType()===NetBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite&&(layout.sorting=go.CircularLayout.Forwards);layout.doLayout(netmap._diagram);netmap._diagram.commitTransaction(transactionName);netmap.refreshMapViewOptionVisible()}catch(ex){console.warn("circularLayout get error: "+ex.toString())}},gridLayout:function(){try{var netmap=this._netmap;if(null==netmap)return;var transactionName=NgUtil.getUniqueStr("gridLayout");netmap._diagram.startTransaction(transactionName);var layout=new go.GridLayout;layout.isRouting=!1;layout.setsPortSpots=!1;layout.spacing=new go.Size(36*netmap.getSpace(),36*netmap.getSpace());var size=netmap._diagram.nodes.count;size>0&&(layout.wrappingColumn=Math.floor(Math.sqrt(size)));layout.doLayout(netmap._diagram);netmap._diagram.commitTransaction(transactionName);netmap.refreshMapViewOptionVisible()}catch(ex){console.warn("gridLayout get error: "+ex.toString())}},layeredDigraphLayout:function(){try{var netmap=this._netmap;if(null==netmap)return;var transactionName=NgUtil.getUniqueStr("layeredDigraphLayout");netmap._diagram.startTransaction(transactionName);var layout=new go.LayeredDigraphLayout;layout.isRouting=!1;layout.setsPortSpots=!1;layout.doLayout(netmap._diagram);netmap._diagram.commitTransaction(transactionName);netmap.refreshMapViewOptionVisible()}catch(ex){console.warn("layeredDigraphLayout get error: "+ex.toString())}},getAppliedDataViewGroupList:function(){var netmap=this._netmap;if(null==netmap)return null;if(null==netmap._getAllDevices(!0))return null;var dvGroupList=[];var appliedDataviews=netmap._netmapJsWrapper.pageData.appliedDataviews;if(appliedDataviews.length>0)appliedDataviews.forEach((function(dataViewInfo){dvGroupList.push(function(dataView){if(!dataView)return null;var id=null;dataView.dataViewInfo&&(id=dataView.dataViewInfo.ID||dataView.dataViewInfo.dataViewGroupId||dataView.dataViewInfo._id);!id&&dataView.compoundDataViewInfo&&(id=dataView.compoundDataViewInfo.compoundDataViewId);!id&&dataView.dataViewInfo&&dataView.dataViewInfo.dataViewGroup&&(id=dataView.dataViewInfo.dataViewGroup._id||dataView.dataViewInfo.dataViewGroup.ID||dataView.dataViewInfo.dataViewGroup.docId);return id}(dataViewInfo))}));else if(netmap.getApplyDataViewInfo&&null!=netmap.getApplyDataViewInfo()){var applyDataViewInfo=netmap.getApplyDataViewInfo().dataViewInfo;applyDataViewInfo&&applyDataViewInfo.dataViewGroupId&&dvGroupList.push(applyDataViewInfo.dataViewGroupId)}return dvGroupList},getAppliedDynamicDataViewGroupList:function(){var netmap=this._netmap;if(null==netmap)return null;if(null==netmap._getAllDevices(!0))return null;return[]},updateDeviceDataOnMap:function(devObj){var netmap=this._netmap;if(null==netmap)return null;var diagram=netmap._diagram;var allDevices=netmap._getAllDevices();for(var i=0;i<allDevices.length;i++){var currDev=allDevices[i];if(devObj.deviceId===currDev.key){var currDevDataView=currDev.dataViewData;currDevDataView.devPosList=devObj.devPosList;currDevDataView.deviceNotes=devObj.deviceNotes;this.updateDataViewNotesFromDevice(currDev,devObj.deviceNotes);diagram.findNodeForKey(currDev.key).updateTargetBindings();break}}netmap.refreshMapViewOptionVisible()},updateDataViewNotesFromDevice:function(deviceData,dataViewNotes){var netmap=this._netmap;if(netmap){var diagram=netmap._diagram;if(diagram){var _this=this;var dataViewNoteType=netBrain.Map.Const.NoteFromType.DataView;var CategoryMgr=netBrain.Map.CategoryMgr;var deviceId=deviceData.key;var deviceNode=netmap._getGraphDeviceByKey(deviceId);var otherNodes=deviceNode.findNodesConnected();var existNotes=[];otherNodes.each((function(otherNode){var oNData=otherNode.data;if(CategoryMgr.isDeviceNote(oNData.category)&&oNData.noteFromType===dataViewNoteType){deviceNode.findLinksBetween(otherNode).any((function(link){var linkData=link.data;return linkData.intfSrc&&!linkData.intfSrc.intfInfo&&linkData.intfDest&&!linkData.intfDest.intfInfo}))&&existNotes.push(otherNode)}}));var changeInfo=this.getDataViewNotesChangeInfo(deviceId,existNotes,dataViewNotes,(function(link){var linkData=link.data;return linkData.from===noteKey&&linkData.to===deviceId||linkData.to===noteKey&&linkData.from===deviceId}),!0);var transactionName=NgUtil.getUniqueStr("updateDataViewNotesFromDevice");this.startTransaction(transactionName);_.each(changeInfo.deleteLinks,(function(link){diagram.remove(link)}));_.each(changeInfo.deleteNotes,(function(note){diagram.remove(note)}));_.each(changeInfo.updateNotes,(function(opInfo){opInfo.existNote.data.setNoteContent(opInfo.noteInfo.content,diagram)}));_.each(changeInfo.addNotes,(function(newNoteInfo){_this.addDeviceNoteRefDevice(deviceId,newNoteInfo)}));_.each(changeInfo.addLinks,(function(note){_this.addNormalLink(deviceId,note.data.key)}));this.commitTransaction(transactionName)}}},updateLinkDataOnMap:function(linkObj,fromOrTo){var netmap=this._netmap;if(null==netmap)return null;var diagram=netmap._diagram;var allTopolinks=netmap._getAllTopoLink();var deviceId=linkObj.deviceId;var intfValue=linkObj.intf.intfKeyObj.value;for(var i=0;i<allTopolinks.length;i++){var currLink=allTopolinks[i];if(currLink[fromOrTo]===deviceId){if((fromOrTo.toLowerCase().indexOf("from")>=0?currLink.intfSrc:currLink.intfDest).intfInfo.intf.intfKeyObj.value===intfValue){var intfInfo=("from"===fromOrTo?currLink.intfSrc:currLink.intfDest).intfInfo;intfInfo.intfPosList=linkObj.intfPosList;intfInfo.intfNotes=linkObj.intfNotes;this.updateDataViewNotesFromIntf(linkObj);diagram.findLinkForData(currLink).updateTargetBindings()}}}netmap.refreshMapViewOptionVisible()},updateDataViewNotesFromIntf:function(linkObj){var netmap=this._netmap;if(netmap){var diagram=netmap._diagram;if(diagram){var _this=this;var dataViewNoteType=netBrain.Map.Const.NoteFromType.DataView;var CategoryMgr=netBrain.Map.CategoryMgr;var deviceId=linkObj.deviceId;var intfValue=linkObj.intf.intfKeyObj.value;var deviceNode=netmap._getGraphDeviceByKey(deviceId);var otherNodes=deviceNode.findNodesConnected();var existNotes=[];otherNodes.each((function(otherNode){var oNData=otherNode.data;if(CategoryMgr.isDeviceNote(oNData.category)&&oNData.noteFromType===dataViewNoteType){deviceNode.findLinksBetween(otherNode).any((function(link){var linkData=link.data;return linkData.from===deviceId&&linkData.fromPort===intfValue||linkData.to===deviceId&&linkData.toPort===intfValue}))&&existNotes.push(otherNode)}}));var changeInfo=this.getDataViewNotesChangeInfo(deviceId,existNotes,linkObj.intfNotes,(function(link){var linkData=link.data;return linkData.from===noteKey&&linkData.to===deviceId&&linkData.toPort===intfValue||linkData.to===noteKey&&linkData.from===deviceId&&linkData.fromPort===intfValue}),!1);var transactionName=NgUtil.getUniqueStr("updateDataViewNotesFromIntf");this.startTransaction(transactionName);_.each(changeInfo.deleteLinks,(function(link){diagram.remove(link)}));_.each(changeInfo.deleteNotes,(function(note){diagram.remove(note)}));_.each(changeInfo.updateNotes,(function(opInfo){opInfo.existNote.data.setNoteContent(opInfo.noteInfo.content,diagram)}));_.each(changeInfo.addNotes,(function(newNoteInfo){_this.addIntfNoteRefDevice(deviceId,linkObj.intf,newNoteInfo)}));_.each(changeInfo.addLinks,(function(note){_this.addNormalLink(deviceId,note.data.key)}));this.commitTransaction(transactionName)}}},getDataViewNotesChangeInfo:function(deviceId,existNotes,dataViewNotes,filterLinkFun,isDeviceOp){var netmap=this._netmap;if(netmap){dataViewNotes=_.map(dataViewNotes,(function(noteItem){return DataViewHelper.formatNote(noteItem)}));var waitingOpNotes=netBrain.Map.noteTool.mergeDataViewNotesWithoutCompound(dataViewNotes);var waitingOpNoteObj=_.indexBy(waitingOpNotes,"title");var addNotes=[];var updateNotes=[];var deleteNotes=[];var deleteLinks=[];var addLinks=[];_.each(existNotes,(function(existNote){var existNoteTitle=existNote.data.noteTitle;var currWaitingOpNote=waitingOpNoteObj[existNoteTitle];if(currWaitingOpNote){var links=existNote.linksConnected;if(links.count>1){existNote.key;var linkArray=[];links.each((function(link){linkArray.push(link)}));var linkGroup=_.partition(linkArray,(function(link){return filterLinkFun(link)}));if(0===linkGroup[1].length)updateNotes.push(existNote);else{deleteLinks=_.union(deleteLinks,linkGroup[0]);addNotes.push(currWaitingOpNote)}}else{updateNotes.push({existNote:existNote,noteInfo:currWaitingOpNote});delete waitingOpNoteObj[existNoteTitle]}}else deleteNotes.push(existNote)}));_.each(waitingOpNoteObj,(function(v){addNotes.push(v)}));return{addNotes:addNotes,updateNotes:updateNotes,deleteNotes:deleteNotes,deleteLinks:deleteLinks,addLinks:addLinks}}},updateDataViewNoteInfoByLinkedInfos:function(note,noteLinkedInfos){var netmap=this._netmap;if(netmap){var CategoryMgr=netBrain.Map.CategoryMgr;var oldTitle=note.oldTitle;delete note.oldTitle;_.each(noteLinkedInfos,(function(info){var deviceId=info.deviceId;var intfId=info.intfId;var device=netmap._getGraphDeviceByKey(deviceId);if(device){var notes;intfId?device.linksConnected.each((function(link){if(!notes){var linkData=link.data;if(CategoryMgr.isTopolink(linkData.category)){if(linkData.getIntfValueSrc()===intfId&&linkData.from===deviceId)notes=NgUtil.getValueFromObjAndPath(linkData,"intfSrc.intfInfo.intfNotes");else{linkData.getIntfValueDest()===intfId&&linkData.to===deviceId&&(notes=NgUtil.getValueFromObjAndPath(linkData,"intfDest.intfInfo.intfNotes"))}}}})):notes=device.data.dataViewData.deviceNotes;if(notes){var index=_.findIndex(notes,(function(dn){return!!dn.isCompound==!!note.isCompound&&dn.title===oldTitle}));-1!=index&&(notes[index]=note)}}}))}},_getLinkLineByDevIdAndIntfId:function(topoType,devId,intfId){var output={linkLines:[],bResult:!1};var netmap=this._netmap;if(null==netmap)return output;if(null==topoType||null==devId||null==intfId)return output;var topoLinks=netmap._getTopoLinksByDevId(devId);if(null!=topoLinks)for(var j=0;j<topoLinks.length;j++){var linkLine=topoLinks[j];if(linkLine.getFromKey()===devId&&linkLine.getIntfValueSrc()===intfId&&linkLine.getTopoType()===topoType){output.linkLines.push({linkLine:linkLine,bSrc:!0});output.bResult=!0}if(linkLine.getToKey()===devId&&linkLine.getIntfValueDest()===intfId&&linkLine.getTopoType()===topoType){output.linkLines.push({linkLine:linkLine,bSrc:!1});output.bResult=!0}}return output},_getNeatMediaTopoLinks:function(){var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllTopoLinksByFilter((function(link){if(link.isP2P||null==link.getMedia())return!1;var destData=netmap._getCompDeviceByKey(link.getToKey());return null!=destData&&!netBrain.Map.gMediaTypeMgr.isMediaType(destData.getDevType())}))},_getCanNeatMedias:function(){var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllDrawObjectsByFilter((function(node){if(netBrain.Map.CategoryMgr.isMedia(node.getCategory())&&netBrain.Map.gMediaTypeMgr.isMediaType(node.getDevType())){var topoLinks=netmap._getTopoLinksByDevId(node.getKey());if(null!=topoLinks&&2===topoLinks.length){var link1=topoLinks[0];var link2=topoLinks[1];if(link1.getFromKey()!==link2.getFromKey()&&link1.getFromKey()!==node.getDevType()&&link2.getFromKey()!==node.getDevType())return!0}}return!1}))},_isNeatUpMedia:function(neat){var netmap=this._netmap;return null!=netmap&&(netmap.getIsNeatUp()&&neat)},_buildLinkLineByNbrInfo:function(srcCompDev,destCompDev,nbrInfo,linkLines){null==linkLines&&(linkLines=[]);if(null==nbrInfo||null==srcCompDev||null==destCompDev)return linkLines.length;var netmap=this._netmap;if(null==netmap)return linkLines.length;var srcTmpSrcCompDev=srcCompDev;var srcTmpDestCompDev=destCompDev;var tmpSrcIntfDataView=nbrInfo.getSrcIntfDataView();var tmpDestIntfDataView=nbrInfo.getDestIntfDataView();var tmpSrcDevId=nbrInfo.getSrcDevId();var tmpDestDevId=nbrInfo.getDestDevId();var tmpSrcSrcHighlightDataList=nbrInfo.getSrcHighlightDataList();var tmpDestHighlightDataList=nbrInfo.getDestHighlightDataList();if(nbrInfo.getFromKey()===srcCompDev.getKey()||nbrInfo.getToKey()===destCompDev.getKey()){srcTmpSrcCompDev=srcCompDev;srcTmpDestCompDev=destCompDev}else{if(nbrInfo.getFromKey()!==destCompDev.getKey()&&nbrInfo.getToKey()!==srcCompDev.getKey()){console.warn("nbrInfo is not match");return linkLines.length}tmpSrcIntfDataView=nbrInfo.getDestIntfDataView();tmpDestIntfDataView=nbrInfo.getSrcIntfDataView();tmpSrcDevId=nbrInfo.getDestDevId();tmpDestDevId=nbrInfo.getSrcDevId();tmpSrcSrcHighlightDataList=nbrInfo.getDestHighlightDataList();tmpDestHighlightDataList=nbrInfo.getSrcHighlightDataList()}if(srcCompDev&&srcCompDev.devNodeData&&srcCompDev.devNodeData.group&&(nbrInfo.getFromKey()===srcCompDev.devNodeData.group&&nbrInfo.getToKey()===srcCompDev.devNodeData.id||nbrInfo.getFromKey()===srcCompDev.devNodeData.id&&nbrInfo.getToKey()===srcCompDev.devNodeData.group))return linkLines.length;if(destCompDev&&destCompDev.devNodeData&&destCompDev.devNodeData.group&&(nbrInfo.getFromKey()===destCompDev.devNodeData.group&&nbrInfo.getToKey()===destCompDev.devNodeData.id||nbrInfo.getFromKey()===destCompDev.devNodeData.id&&nbrInfo.getToKey()===destCompDev.devNodeData.group))return linkLines.length;var l2TopoLinkMode=netBrain.MapImprovements.l2TopoLinkMode;var linkLine={};if(nbrInfo.getIsP2P()||this._isNeatUpMedia(nbrInfo.getNeat())||nbrInfo.getMediaInfo()&&nbrInfo.getMediaInfo().mediaType==NetBrain.Map.Const.MediaType.Serial){(linkLine=netBrain.Map.CompBase.buildCompTopolink(nbrInfo.getCategory())).setFromKey(nbrInfo.getFromKey());linkLine.setToKey(nbrInfo.getToKey());linkLine.setTopoType(nbrInfo.getTopoType());linkLine.setIsP2P(nbrInfo.getIsP2P());linkLine.setIntfSrc(nbrInfo.getSrcIntfDataView());linkLine.setIntfDest(nbrInfo.getDestIntfDataView());linkLine.setDevIdSrc(nbrInfo.getSrcDevId());linkLine.setDevIdDest(nbrInfo.getDestDevId());linkLine.setMedia(nbrInfo.getMedia());linkLine.setMediaInfo(nbrInfo.getMediaInfo());linkLine.setHighlightDataListSrc(nbrInfo.getSrcHighlightDataList());linkLine.setHighlightDataListDest(nbrInfo.getDestHighlightDataList());linkLine.setIsPortChannel(nbrInfo.getIsPortChannel());l2TopoLinkMode.createL2TopoLinkMode(linkLine);netmap.calcPolicyStyle(linkLine);netmap.calcUnknownEndSystemPolicyStyleWhenOneLink(srcCompDev,destCompDev,linkLine);null!=linkLine&&linkLines.push(linkLine)}else{var bSrcDevMedia=netBrain.Map.gMediaTypeMgr.isMediaType(srcTmpSrcCompDev.getDevType());var bDestDevMedia=netBrain.Map.gMediaTypeMgr.isMediaType(srcTmpDestCompDev.getDevType());if(bSrcDevMedia){(linkLine=netBrain.Map.CompBase.buildCompTopolink(nbrInfo.getCategory())).setFromKey(srcTmpSrcCompDev.getKey());linkLine.setToKey(srcTmpDestCompDev.getKey());linkLine.setTopoType(nbrInfo.getTopoType());linkLine.setIsP2P(nbrInfo.getIsP2P());linkLine.setIntfSrc(null);linkLine.setIntfDest(tmpDestIntfDataView);linkLine.setDevIdSrc(null);linkLine.setDevIdDest(tmpDestDevId);linkLine.setMedia(nbrInfo.getMedia());linkLine.setMediaInfo(nbrInfo.getMediaInfo());linkLine.setHighlightDataListSrc(null);linkLine.setHighlightDataListDest(tmpDestHighlightDataList);linkLine.setIsPortChannel(nbrInfo.getIsPortChannel());l2TopoLinkMode.createL2TopoLinkMode(linkLine);netmap.calcPolicyStyle(linkLine);null!=linkLine&&linkLines.push(linkLine)}else if(bDestDevMedia){(linkLine=netBrain.Map.CompBase.buildCompTopolink(nbrInfo.getCategory())).setFromKey(srcTmpSrcCompDev.getKey());linkLine.setToKey(srcTmpDestCompDev.getKey());linkLine.setTopoType(nbrInfo.getTopoType());linkLine.setIsP2P(nbrInfo.getIsP2P());linkLine.setIntfSrc(tmpSrcIntfDataView);linkLine.setIntfDest(null);linkLine.setDevIdSrc(tmpSrcDevId);linkLine.setDevIdDest(null);linkLine.setMedia(nbrInfo.getMedia());linkLine.setMediaInfo(nbrInfo.getMediaInfo());linkLine.setHighlightDataListSrc(tmpSrcSrcHighlightDataList);linkLine.setHighlightDataListDest(null);linkLine.setIsPortChannel(nbrInfo.getIsPortChannel());l2TopoLinkMode.createL2TopoLinkMode(linkLine);netmap.calcPolicyStyle(linkLine);null!=linkLine&&linkLines.push(linkLine)}else{var compMedia=this._buildCompMediaByInfo(nbrInfo.getMediaName(),nbrInfo.getMedia(),nbrInfo.getMediaType(),nbrInfo.getMediaTopoType());if(null==compMedia)return linkLines.length;if(!netBrain.Map.gMediaTypeMgr.isMediaType(compMedia.getDevType())){console.warn("error: Media Type "+compMedia.getDevType());return linkLines.length}this._buildLinkLineByNbrInfo(srcCompDev,compMedia,nbrInfo,linkLines);var srcLinkLine=linkLines[linkLines.length-1];this._buildLinkLineByNbrInfo(destCompDev,compMedia,nbrInfo,linkLines);var destLinkLine=linkLines[linkLines.length-1];netmap.calcUnknownEndSystemPolicyStyleWhenTwoLinks(srcCompDev,destCompDev,srcLinkLine,destLinkLine)}}return linkLines.length},_buildCompMediaByInfo:function(hostName,mediaKey,mediaType,topoType){if(null==mediaKey||null==mediaType||""===mediaKey||""===mediaType||""===topoType)return null;var compMedia=netBrain.Map.CompBase.buildCompMedia();compMedia.setHostname(hostName);compMedia.setKey(mediaKey);compMedia.setDevType(mediaType);compMedia.setDevCategory(mediaType);compMedia.setTopoType(topoType);compMedia.setImageByMediaType(mediaType);return compMedia},_makeCompDevicePosition:function(compDevice,srcCompDevice,destCompDevice){var ptProperPos=null;var netmap=this._netmap;null!=netmap&&(ptProperPos=netmap._findProperNeighborPosition(srcCompDevice));null==ptProperPos&&(ptProperPos=new go.Point(500,500));null!=compDevice&&null!=compDevice.setLocation&&compDevice.setLocation(go.Point.stringify(ptProperPos))},_getCompMedia:function(mediaInfo,objcategory){if(null==mediaInfo)return null;var tempNbrInfo=new CNeighborInfo(null,null,null,null,mediaInfo.topoType,null,mediaInfo.ID,{mediaName:mediaInfo.uniName,mediaType:mediaInfo.type,hsrp:mediaInfo.hsrp,vrf:mediaInfo.vrf,zone:mediaInfo.zone});objcategory=netBrain.Map.CategoryMgr.Media;var compMedia=new netBrain.Map.CompMedia(objcategory).CreateMeidaJsonDataByNbrInfo(tempNbrInfo);if(null==compMedia)return null;netBrain.Map.CompPrototypeFactory.buildCompPrototype(compMedia);return compMedia},_getCompSite:function(sitePropertie){if(sitePropertie){var compSite=netBrain.Map.CompSite.getJson(sitePropertie.siteCategory);netBrain.Map.CompPrototypeFactory.buildCompPrototype(compSite);compSite.setDisplayName(sitePropertie.name);compSite.setKey(sitePropertie.ID);compSite.setSiteCategory(sitePropertie.siteCategory);compSite.setDeviceCount(sitePropertie.deviceCount);return compSite}},_getSitePropertie:function(sitesCache){if(null==sitesCache)return null;var sites=[];for(var i in sitesCache)sitesCache.hasOwnProperty(i)&&sites.push(sitesCache[i]);var sitePropertie={sitePropertieList:sites};Object.setPrototypeOf(sitePropertie,new SitePropertie);return sitePropertie},_getIntfDataView:function(id,intf,topoTypeId,dataViewsSegment){if(null==id||null==intf||null==topoTypeId||null==dataViewsSegment)return null;var intfDataViewSegment=dataViewsSegment.getIntfSegmentIntfDataViewSegment(id,intf.intfKeyObj,topoTypeId);var intfDataView=dataViewsSegment.getIntfSegmentIntfDataView(intfDataViewSegment);null==intfDataView&&(intfDataView={dataViewInfo:{dataViewGroupId:"",dataViewTaskInfoId:"",name:"",dataViewType:DataViewType.dvDefault,dataViewDefinitionId:""},intfInfo:intf,intfPosList:[{posName:DataViewPosName.intfPos0,posInfo:{dataUnitList:[{type:DataUnitSourceType.uSrcGDR,uId:intf.intfDisplaySchemaObj.schema,value:intf.intfDisplaySchemaObj.value,valueType:DataUnitType.uString,unit:"",perfix:"",valueExpr:""}],displayTemplate:"",displayInfo:intf.intfDisplaySchemaObj.value,isCustomize:!1,isLock:!1}}]});return intfDataView},_getCompDevice:function(dataView){var compDevice=null;if(null!=dataView){compDevice=NgUtil.cloneJson(dataView)}else compDevice=netBrain.Map.CompDevice.getDefaultJsonData();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compDevice);return compDevice},removelogicLinkExisted:function(data){var netmap=this._netmap;if(null==netmap)return!1;var links=netmap._getAllTopoLink();for(var i=0;i<links.length;i++){var linkLine=links[i];linkLine.isLogicLineExisted(data)&&netmap._removeLink(linkLine)}return!0},checkBorderLinkExist:function(data){var netmap=this._netmap;if(null==netmap)return!1;var links=netmap._getAllNormalLink();for(var i=0;i<links.length;i++){if(links[i].isEqualBorderLineByData(data))return!0}return!1},checkNbrLinkExist1:function(nbrInfo,nbr,dataViewsSegment,sites){if(null==nbr)return!1;var netmap=this._netmap;if(null==netmap)return!1;nbrInfo.setSrcIntfDataView(this._getIntfDataView(nbr.id,nbr.intf,nbr.topoTypeId,dataViewsSegment));nbrInfo.setDestIntfDataView(this._getIntfDataView(nbr.nbrId,nbr.nbrIntf,nbr.topoTypeId,dataViewsSegment));nbrInfo.setSrcDevId(nbr.devId);nbrInfo.setDestDevId(nbr.nbrDevId);var srcDevDataView=null;var destDevDataView=null;var srcCompDev=null;var destCompDev=null;var site=null;if(nbr.devId===nbr.id){srcDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbr.id);srcCompDev=this._getCompDevice(srcDevDataView)}else{site=sites.getSitePropertieById(nbr.id);srcCompDev=this._getCompSite(site)}if(nbr.nbrDevId===nbr.nbrId){destDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbr.nbrId);destCompDev=this._getCompDevice(destDevDataView)}else{site=sites.getSitePropertieById(nbr.nbrId);destCompDev=this._getCompSite(site)}if(null!=srcCompDev&&null!=destCompDev){var topoLinks;var mapVer=netmap.getParentQmap().qmapJsWrapper.getVersion();var isBerfor71a=NetBrain.Map.Const.MapVersionList.indexOf("IE 7.1a")>NetBrain.Map.Const.MapVersionList.indexOf(mapVer);if(nbrInfo.getIsP2P()||this._isNeatUpMedia(nbrInfo.getNeat())||isBerfor71a&&("Site"===srcCompDev.category||"Site"===destCompDev.category)||!isBerfor71a&&nbrInfo.getMediaInfo().mediaType==NetBrain.Map.Const.MediaType.Serial){topoLinks=netmap._getAllTopoLink();for(var i=0;i<topoLinks.length;i++)if(topoLinks[i].isEqualLinkLineByNbrInfo(nbrInfo))return!0}else{var bSrcDevMedia=nbrInfo.getFromKey()===nbrInfo.getMedia();var bDestDevMedia=nbrInfo.getToKey()===nbrInfo.getMedia();if(bSrcDevMedia||bDestDevMedia){topoLinks=netmap._getAllTopoLink();for(var j=0;j<topoLinks.length;j++)if(topoLinks[j].isEqualLinkLineByNbrInfo(nbrInfo))return!0}else{var srcNbrInfo=new CNeighborInfo(nbrInfo.getFromKey(),nbrInfo.getMedia(),nbrInfo.getSrcIntf(),null,nbrInfo.getTopoType(),!1,nbrInfo.getMedia());topoLinks=netmap._getAllTopoLink();var bSrcExist=!1;var bDestExist=!1;for(var k=0;k<topoLinks.length;k++)if(topoLinks[k].isEqualLinkLineByNbrInfo(srcNbrInfo)){bSrcExist=!0;break}var destNbrInfo=new CNeighborInfo(nbrInfo.getMedia(),nbrInfo.getToKey(),null,nbrInfo.getDestIntf(),nbrInfo.getTopoType(),!1,nbrInfo.getMedia());for(var ii=0;ii<topoLinks.length;ii++)if(topoLinks[ii].isEqualLinkLineByNbrInfo(destNbrInfo)){bDestExist=!0;break}if(bSrcExist&&bDestExist)return!0}}return!1}},checkNbrLinkExist:function(nbrInfo){if(null==nbrInfo)return!1;var netmap=this._netmap;if(null==netmap)return!1;var topoLinks;if(nbrInfo.getIsP2P()||this._isNeatUpMedia(nbrInfo.getNeat())){topoLinks=netmap._getAllTopoLink();for(var i=0;i<topoLinks.length;i++)if(topoLinks[i].isEqualLinkLineByNbrInfo(nbrInfo))return!0}else{var bSrcDevMedia=nbrInfo.getFromKey()===nbrInfo.getMedia();var bDestDevMedia=nbrInfo.getToKey()===nbrInfo.getMedia();if(bSrcDevMedia||bDestDevMedia){topoLinks=netmap._getAllTopoLink();for(var j=0;j<topoLinks.length;j++)if(topoLinks[j].isEqualLinkLineByNbrInfo(nbrInfo))return!0}else{var srcNbrInfo=new CNeighborInfo(nbrInfo.getFromKey(),nbrInfo.getMedia(),nbrInfo.getSrcIntf(),null,nbrInfo.getTopoType(),!1,nbrInfo.getMedia());topoLinks=netmap._getAllTopoLink();var bSrcExist=!1;var bDestExist=!1;for(var k=0;k<topoLinks.length;k++)if(topoLinks[k].isEqualLinkLineByNbrInfo(srcNbrInfo)){bSrcExist=!0;break}var destNbrInfo=new CNeighborInfo(nbrInfo.getMedia(),nbrInfo.getToKey(),null,nbrInfo.getDestIntf(),nbrInfo.getTopoType(),!1,nbrInfo.getMedia());for(var ii=0;ii<topoLinks.length;ii++)if(topoLinks[ii].isEqualLinkLineByNbrInfo(destNbrInfo)){bDestExist=!0;break}if(bSrcExist&&bDestExist)return!0}}return!1},getAllRealInterfaceList:function(){var allIntfList=this.getAllInterfaceList();return _.filter(allIntfList,(function(obj){return!1!==NgUtil.getValueFromObjAndPath(obj,"intf.intfNodeData.isRealIntf")}))},getAllInterfaceList:function(){var allLinkInterfaceList=this.getAllLinkInterfaceList();var allPortList=this.getAllPortList();allLinkInterfaceList&&allPortList&&_.each(allPortList,(function(item){if(!_.find(allLinkInterfaceList,(function(linkInterface){return!!(linkInterface&&linkInterface.intf&&linkInterface.intf.intfKeyObj&&item&&item.intf&&item.intf.intfKeyObj)&&linkInterface.intf.intfKeyObj.value===item.intf.intfKeyObj.value})))return allLinkInterfaceList.push(item)}));return allLinkInterfaceList},getAllPortList:function(){var intfList=[];var output;var devices=this.getAllDevcies(null,!0);_.each(devices,(function(device){device.dataViewData.intfInfoList&&_.each(device.dataViewData.intfInfoList,(function(item){output={devId:device.key,intf:item.intf,topoType:"L2_Topo_Type"};intfList.push(output)}))}));return intfList},getAllLinkInterfaceList:function(){var netmap=this._netmap;if(null==netmap)return null;var intfList=[];var intfUnique={};var topoLinks=netmap._getAllTopoLink();for(var i=0;i<topoLinks.length;i++){var linkLine=topoLinks[i];var devIdDest=linkLine.getDevIdDest();var intfInfoDest=linkLine.getIntfInfoDest();var topoType=linkLine.getTopoType();var output;if(null!=devIdDest&&""!==devIdDest&&null!=intfInfoDest&&null!=intfInfoDest.intf&&intfInfoDest.intf.intfKeyObj&&intfInfoDest.intf.intfKeyObj.value&&!intfUnique.hasOwnProperty(intfInfoDest.intf.intfKeyObj.value)){intfUnique[intfInfoDest.intf.intfKeyObj.value]=!0;output={devId:devIdDest,intf:intfInfoDest.intf,topoType:topoType};intfList.push(output)}var devIdSrc=linkLine.getDevIdSrc();var intfInfoSrc=linkLine.getIntfInfoSrc();if(null!=devIdSrc&&""!==devIdSrc&&null!=intfInfoSrc&&null!=intfInfoSrc.intf&&intfInfoSrc.intf.intfKeyObj&&intfInfoSrc.intf.intfKeyObj.value&&!intfUnique.hasOwnProperty(intfInfoSrc.intf.intfKeyObj.value)){intfUnique[intfInfoSrc.intf.intfKeyObj.value]=!0;output={devId:devIdSrc,intf:intfInfoSrc.intf,topoType:topoType};intfList.push(output)}}return intfList},getAllDevicesByDvgId:function(dvgId){if(null==dvgId)return null;var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllDevicesByFilter(!0,(function(node){return node.getDataViewGroupId()===dvgId}))},addDevice:function(compDevice){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addDevice(compDevice)}catch(ex){console.warn("addDevice get error: "+ex.toString())}},addVisualSpaceNode:function(compVasualSpaceNode){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addVisualSpaceNode(compVasualSpaceNode)}catch(ex){console.log("addVisualSpaceNode get error: "+ex.toString())}},addDeviceGroup:function(compDeviceGroup){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addDeviceGroup(compDeviceGroup)}catch(ex){console.warn("addDeviceGroup get error: "+ex.toString())}},addUnknownIp:function(hostName,key,location){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addUnknownIp(hostName,key,location)}catch(ex){console.warn("addUnknownIp get error: "+ex.toString())}},addUnknownIpForOneIp:function(hostName,key,location,imageList){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addUnknownIp(hostName,key,location,imageList)}catch(ex){console.warn("addUnknownIp get error: "+ex.toString())}},addStencil:function(strHostName,stencilItemObj,ptPosition){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addStencil(strHostName,stencilItemObj,ptPosition)}catch(ex){console.warn("addStencil get error: "+ex.toString())}},addHyperLink:function(strName,strUrl){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addHyperLink(strName,strUrl)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}},addLinkLine:function(compLink,isAutoLink){var flag=!1;try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;flag=graphicOp.addLinkLine(compLink,isAutoLink)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}return flag},addLinkLines:function(compLinks,isAutoLink){var newAddLinks;try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;newAddLinks=graphicOp.addLinkLines(compLinks,isAutoLink)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}return newAddLinks||[]},addNormalLink:function(fromKey,toKey,isCompoundNoteLink){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addNormalLink(fromKey,toKey,isCompoundNoteLink)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}},addSiteBorderLink:function(data){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addSiteBorderLink(data)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}},addIntfaceLink:function(data){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.addIntfaceLink(data)}catch(ex){this._nbAlertSrvc&&this._nbAlertSrvc.error(ex.toString())}},updatePath:function(compPath){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;graphicOp.updatePath(compPath)}catch(ex){console.warn("updatePath get error: "+ex.toString())}},drawDeviceHighlight:function(data){var netmap=this._netmap;null!=netmap&&netmap._drawDeviceHighlight(data)},drawLinkHighlight:function(data){var netmap=this._netmap;null!=netmap&&netmap._drawLinkHighlight(data)},drawLinkHighlightNew:function(data,interfaceData){var netmap=this._netmap;null!=netmap&&netmap._drawLinkHighlightNew(data,interfaceData)},drawHighlightNeighborLink:function(data){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;var netmap=this._netmap;if(null==netmap)return;var diagram=netmap.getGoJsDiagram();if(null===diagram)return;var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;graphicOp.addHighlightNeighborLink(data);diagram.skipsUndoManager=oldskip}catch(ex){console.warn("drawHighlightNeighborLink get error: "+ex.toString())}},drawHopLink:function(data){try{var graphicOp=this.getGraphicOp();if(null==graphicOp)return;var netmap=this._netmap;if(null==netmap)return;var diagram=netmap.getGoJsDiagram();if(null===diagram)return;var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;graphicOp.addHopLink(data);diagram.skipsUndoManager=oldskip}catch(ex){console.warn("drawHopLink get error: "+ex.toString())}},clearDrawHighlight:function(){var netmap=this._netmap;null!=netmap&&netmap._clearDrawHighlight()},setDeviceHighlightColor:function(legend,color){var netmap=this._netmap;null!=netmap&&netmap._setDeviceHighlightColor(legend,color)},setLinkHighlightColor:function(legend,color){var netmap=this._netmap;null!=netmap&&netmap._setLinkHighlightColor(legend,color)},setPortHighlightColor:function(legend,color){var netmap=this._netmap;null!=netmap&&netmap._setPortHighlightColor(legend,color)},setNeighborHighlightColor:function(legend,color){var netmap=this._netmap;null!=netmap&&netmap._setNeighborHighlightColor(legend,color)},tryMoveToRightArea:function(lsDevObjs){if(null!=lsDevObjs&&null!=this._netmap._diagram){var viewX=this._netmap._getViewCenterX();if(null!=viewX){var tempCompDev=null;for(var i=0;i<lsDevObjs.length;i++)if(null!=(tempCompDev=this._netmap._getCompDeviceByKey(lsDevObjs[i].id))){var loc=tempCompDev.getLocation();if(null!=loc){var ptPos=go.Point.parse(loc);if(null!=ptPos){var viewPos=this._netmap._diagram.transformViewToDoc(ptPos);if(null!=viewPos&&viewPos.x>viewX)return}}}null!=tempCompDev&&this._netmap._centerNode(tempCompDev)}}},getAllDevcies:function(bExcludeMedia,bIncludeNonRealDevice){var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllDrawObjectsByFilter((function(node){var bResult=!1;bResult=bExcludeMedia?netBrain.Map.CategoryMgr.isNetworkDevice(node.category):netBrain.Map.CategoryMgr.isNetworkDevice(node.category)&&!netBrain.Map.gMediaTypeMgr.isMediaType(node.category);bIncludeNonRealDevice||(bResult=bResult&&(null==node.devNodeData||node.devNodeData.isRealDev));return bResult}))},getAllSites:function(){var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllDrawObjectsByFilter((function(node){return netBrain.Map.CategoryMgr.isSite(node.category)}))},getAllDeviceGroups:function(){var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllDrawObjectsByFilter((function(node){return netBrain.Map.CategoryMgr.isCluter(node.category)}))},getAllPaths:function(){var netmap=this._netmap;return null==netmap?null:netmap._getAllPathsByFilter()},getSelectedDevcies:function(bExcludeMedia){var netmap=this._netmap;if(null==netmap)return null;return netmap._getSelectDrawObjectsByFilter((function(node){return bExcludeMedia?netBrain.Map.CategoryMgr.isNetworkDevice(node.category):netBrain.Map.CategoryMgr.isNetworkDevice(node.category)&&!netBrain.Map.gMediaTypeMgr.isMediaType(node.category)}))},getSelectedSites:function(){var netmap=this._netmap;if(null==netmap)return null;return netmap._getSelectDrawObjectsByFilter((function(node){return netBrain.Map.CategoryMgr.isSite(node.category)}))},getSelectedDeviceGroups:function(){var netmap=this._netmap;if(null==netmap)return null;return netmap._getSelectDrawObjectsByFilter((function(node){return netBrain.Map.CategoryMgr.isCluter(node.category)}))},getSelectedPaths:function(){var netmap=this._netmap;return null==netmap?null:netmap._getAllPathsByFilter()},getSelectedNodes:function(){var netmap=this._netmap;if(null==netmap)return null;return netmap._getSelectDrawObjectsByFilter((function(node){return!0}))},getSelectedLinks:function(){var netmap=this._netmap;return null==netmap?[]:netmap.getSelectedLinks()},getPelByName:function(bStencilName){var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllDrawObjectsByFilter((function(node){return node.hostName===bStencilName}))},getDeviceByHostName:function(hostName){var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllDrawObjectsByFilter((function(node){return netBrain.Map.CategoryMgr.isDeviceCategory(node.category)&&node.hostName===hostName}))},getMapNote:function(bTitle,bNoteType){var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllDrawObjectsByFilter((function(node){return netBrain.Map.CategoryMgr.isNote(node.category)&&node.noteTitle===bTitle&&node.noteType===bNoteType}))},getDeviceNote:function(bDeviceId,bTitle,bNoteType,pathId){var netmap=this._netmap;if(null==netmap)return null;var compDevice=netmap._getCompDeviceByKey(bDeviceId);if(null==compDevice)return!1;return netmap._getAllDrawObjectsByFilter((function(node){if(netBrain.Map.CategoryMgr.isDeviceNote(node.category)&&node.noteTitle===bTitle&&node.noteType===bNoteType){var compDeviceD=netmap._diagram.findNodeForData(compDevice);var links=netmap._diagram.findNodeForData(node).findLinksBetween(compDeviceD,null,null);var anyLinks=links.any((function(item){return null!=item.data.intfSrc&&void 0===item.data.intfSrc.intfInfo&&null!=item.data.intfDest&&void 0===item.data.intfDest.intfInfo}));if(links.count>0&&anyLinks)return!isPathNote(node)||node.pathId===pathId}return!1}))},getDeviceIntfNote:function(bDeviceId,bIntf,bTitle,bNoteType){var netmap=this._netmap;if(null==netmap)return null;var compDevice=netmap._getCompDeviceByKey(bDeviceId);if(null==compDevice)return!1;return netmap._getAllDrawObjectsByFilter((function(node){if(netBrain.Map.CategoryMgr.isDeviceNote(node.category)&&node.noteTitle===bTitle&&node.noteType===bNoteType){var compDeviceD=netmap._diagram.findNodeForData(compDevice);var links=netmap._diagram.findNodeForData(node).findLinksBetween(compDeviceD,null,null);if(links.count>0&&links.any((function(link){return null!=link.data&&(link.data.from===bDeviceId&&link.data.fromPort===bIntf.intfKeyObj.value||link.data.to===bDeviceId&&link.data.toPort===bIntf.intfKeyObj.value)})))return!0}return!1}))},checkDeviceIntfLink:function(bDeviceId,bIntf){var netmap=this._netmap;if(null==netmap)return!1;var device=netmap._getGraphDeviceByKey(bDeviceId);if(null==device)return!1;return device.linksConnected.any((function(link){return null!=link.data&&(link.data.from===bDeviceId&&link.data.fromPort===bIntf.intfKeyObj.value||link.data.to===bDeviceId&&link.data.toPort===bIntf.intfKeyObj.value)}))},getLinkByKey:function(key){var netmap=this._netmap;return null==netmap?null:netmap._getLinkByKey(key)},getPathsByTaskId:function(taskId){var netmap=this._netmap;if(null==netmap)return null;return netmap._getAllPathsByFilter((function(data){return data.getTaskId()===taskId}))},centerPathDevice:function(device){var netmap=this._netmap;return null==netmap?null:netmap._centerPathDevice(device)},showAllPortChannels:function(actionObj){actionObj.mapOperator=this;portChannelHelper.showAllPortChannels(actionObj)},showAllPhysicalPorts:function(actionObj){actionObj.mapOperator=this;portChannelHelper.showAllPhysicalPorts(actionObj)},showPortChannel:function(actionObj){actionObj.mapOperator=this;portChannelHelper.showPortChannel(actionObj)},showPhysicalPorts:function(actionObj){actionObj.mapOperator=this;portChannelHelper.showPhysicalPorts(actionObj)},displayL2MapStyle:function(){var netMap=this._netmap;if(null!==netMap){var diagram=netMap.getGoJsDiagram();if(null!==diagram&&!netMap.isL2MapStyle())try{netBrain.Map.BasePathLink.isL2Style=!0;var transactionName=NgUtil.getUniqueStr("displayL2Style");netMap._diagram.startTransaction(transactionName);var linkTemplateOption=new netBrain.Map.TopoLinkTemplateOption;netBrain.Map.CompTopolink.initSomeLinkTemplateOption(linkTemplateOption);linkTemplateOption.linkLabelMouseHover=netMap.getCurrentScope().linkLabelMouseHover;linkTemplateOption.linkLabelMouseLeave=netMap.getCurrentScope().linkLabelMouseLeave;linkTemplateOption.linkLabelClick=netMap.getCurrentScope().linkLabelClick;linkTemplateOption.linkLabelMouseEnter=netMap.getCurrentScope().linkLabelMouseEnter;linkTemplateOption.linkSelectChangeFunc=function(p){p.isSelected?p.layerName="Foreground":p.layerName=""};linkTemplateOption.isEditMode=netMap.getCurrentScope().isEditMode;linkTemplateOption.editLinkShow=netMap.getCurrentScope().openEditLink;linkTemplateOption.getEditDataView=netMap.getCurrentScope().getEditDataView;netMap.setL2MapStyle();diagram.model.linkFromPortIdProperty=netBrain.Map.CompL2Device.getLinkFromPortIdProperty();diagram.model.linkToPortIdProperty=netBrain.Map.CompL2Device.getLinkToPortIdProperty();resetLocWithFactor(diagram,2);this.diagramPathManager&&this.diagramPathManager.refreshPathAB(diagram);netMap._diagram.commitTransaction(transactionName);diagram.links.each((function(l){l.invalidateRoute()}));netMap.layoutL2Ports();netMap.refreshMapViewOptionVisible();diagram.model.undoManager.clear()}catch(ex){console.warn("displayL2MapStyle get error: "+ex.toString())}}},displayL3MapStyle:function(){var netMap=this._netmap;if(null!==netMap){var diagram=netMap.getGoJsDiagram();if(null!==diagram&&!netMap.isL3MapStyle())try{netBrain.Map.BasePathLink.isL2Style=!1;var transactionName=NgUtil.getUniqueStr("displayL3Style");netMap._diagram.startTransaction(transactionName);var linkTemplateOption=new netBrain.Map.TopoLinkTemplateOption;netBrain.Map.CompTopolink.initSomeLinkTemplateOption(linkTemplateOption);linkTemplateOption.linkLabelMouseHover=netMap.getCurrentScope().linkLabelMouseHover;linkTemplateOption.linkLabelMouseLeave=netMap.getCurrentScope().linkLabelMouseLeave;linkTemplateOption.linkLabelClick=netMap.getCurrentScope().linkLabelClick;linkTemplateOption.linkLabelMouseEnter=netMap.getCurrentScope().linkLabelMouseEnter;linkTemplateOption.linkSelectChangeFunc=function(p){p.isSelected?p.layerName="Foreground":p.layerName=""};linkTemplateOption.isEditMode=netMap.getCurrentScope().isEditMode;linkTemplateOption.editLinkShow=netMap.getCurrentScope().openEditLink;linkTemplateOption.getEditDataView=netMap.getCurrentScope().getEditDataView;netBrain.Map.CompTopolink.getMapTemplate(linkTemplateOption,diagram,!1,netMap.getCurrentScope());netMap.setL3MapStyle();diagram.model.linkFromPortIdProperty=netBrain.Map.CompL2Device.getLinkFromPortIdProperty();diagram.model.linkToPortIdProperty=netBrain.Map.CompL2Device.getLinkToPortIdProperty();resetLocWithFactor(diagram,.5);this.diagramPathManager&&this.diagramPathManager.refreshPathAB(diagram);netMap._diagram.commitTransaction(transactionName);diagram.links.each((function(l){l.invalidateRoute()}));netMap.refreshMapViewOptionVisible();diagram.model.undoManager.clear()}catch(ex){console.warn("displayL3MapStyle get error: "+ex.toString())}}},_showNeatMedia:function(){var netmap=this._netmap;if(null!=netmap){var links=this._getNeatMediaTopoLinks();var transactionName=NgUtil.getUniqueStr("show neat media");netmap._diagram.startTransaction(transactionName);netmap.setIsNeatUp(!1);var addedMedias=[];for(var i in links)if(links.hasOwnProperty(i)){var linkLine=links[i];var tempNbrInfo=new CNeighborInfo(linkLine.getFromKey(),linkLine.getToKey(),null,null,linkLine.getTopoType(),linkLine.getIsP2P(),linkLine.getMedia(),linkLine.getMediaInfo());tempNbrInfo.setSrcIntfDataView(NgUtil.cloneJsonUseJQuery(linkLine.getIntfSrc()));tempNbrInfo.setDestIntfDataView(NgUtil.cloneJsonUseJQuery(linkLine.getIntfDest()));tempNbrInfo.setSrcDevId(linkLine.getDevIdSrc());tempNbrInfo.setDestDevId(linkLine.getDevIdDest());tempNbrInfo.setSrcHighlightDataList(NgUtil.cloneJsonUseJQuery(linkLine.getHighlightDataListSrc()));tempNbrInfo.setDestHighlightDataList(NgUtil.cloneJsonUseJQuery(linkLine.getHighlightDataListDest()));var srcCompDev=netmap._getCompDeviceByKey(linkLine.getFromKey());var destCompDev=netmap._getCompDeviceByKey(linkLine.getToKey());var compMedia=this._buildCompMediaByInfo(tempNbrInfo.getMediaName(),tempNbrInfo.getMedia(),tempNbrInfo.getMediaType(),tempNbrInfo.getMediaTopoType());if(null==compMedia)continue;netmap._removeLink(linkLine);if(null==netmap._model.findNodeDataForKey(compMedia.getKey())){this._makeCompDevicePosition(compMedia,srcCompDev);netmap._addNode(compMedia);addedMedias.push(compMedia.key)}var linkLines=[];this._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);if(linkLine.customMapStyle&&2===linkLines.length){var link1=linkLines[0];if(linkLine.customMapStyle.src){link1.customMapStyle={};link1.customMapStyle.src=linkLine.customMapStyle.src;link1.customMapStyle.dest=linkLine.customMapStyle.src}var link2=linkLines[1];if(linkLine.customMapStyle.dest){link2.customMapStyle={};link2.customMapStyle.src=linkLine.customMapStyle.dest;link2.customMapStyle.dest=linkLine.customMapStyle.dest}}for(var k in linkLines)linkLines.hasOwnProperty(k)&&this.addLinkLine(linkLines[k])}if(addedMedias.length>0){var symmetricLayout=NetBrain.TopoTools.layoutHelper.symmetricLayout;var options={newNodes:addedMedias};var jsWrapper=netmap.getNetMapJsWrapper();options.isL2Style=jsWrapper&&jsWrapper.isL2Style();symmetricLayout(netmap._diagram,options)}netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction(transactionName)}},_hideNeatmedia:function(mediaInfos){var netmap=this._netmap;if(null!=netmap){var transactionName=NgUtil.getUniqueStr("hide neat media");netmap._diagram.startTransaction(transactionName);netmap.setIsNeatUp(!0);for(var i in mediaInfos)if(mediaInfos.hasOwnProperty(i)){var media=mediaInfos[i];if(!media.neat)continue;var topoLinks=netmap._getTopoLinksByDevId(media.mediaId);if(null!=topoLinks&&2===topoLinks.length){var link1=topoLinks[0];var link2=topoLinks[1];var tempNbrInfo=new CNeighborInfo(link1.getFromKey(),link2.getFromKey(),null,null,link1.getTopoType(),link1.getIsP2P(),media.mediaId,media);tempNbrInfo.setSrcIntfDataView(NgUtil.cloneJsonUseJQuery(link1.getIntfSrc()));tempNbrInfo.setDestIntfDataView(NgUtil.cloneJsonUseJQuery(link2.getIntfSrc()));tempNbrInfo.setSrcDevId(link1.getDevIdSrc());tempNbrInfo.setDestDevId(link2.getDevIdSrc());tempNbrInfo.setSrcHighlightDataList(NgUtil.cloneJsonUseJQuery(link1.getHighlightDataListSrc()));tempNbrInfo.setDestHighlightDataList(NgUtil.cloneJsonUseJQuery(link2.getHighlightDataListSrc()));var srcCompDev=netmap._getCompDeviceByKey(link1.getFromKey());var destCompDev=netmap._getCompDeviceByKey(link2.getFromKey());var linkLines=[];this._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);var newTmpLink=linkLines[0];newTmpLink.customMapStyle={};link1.customMapStyle&&!_.isEmpty(link1.customMapStyle.src)&&(newTmpLink.customMapStyle.src=link1.customMapStyle.src);link2.customMapStyle&&!_.isEmpty(link2.customMapStyle.src)&&(newTmpLink.customMapStyle.dest=link2.customMapStyle.src);_.isEmpty(newTmpLink.customMapStyle)&&delete newTmpLink.customMapStyle;netmap._removeLink(link1);netmap._removeLink(link2);var compMedia=netmap._getCompDeviceByKey(media.mediaId);netmap._removeNode(compMedia);for(var k in linkLines)linkLines.hasOwnProperty(k)&&this.addLinkLine(linkLines[k])}}netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction(transactionName)}},_getPosRet:function(){var x=this._netmap._diagram.div.clientWidth/2;var y=this._netmap._diagram.div.clientHeight/2;var ptPos=this._netmap._diagram.transformViewToDoc(new go.Point(x,y));ptPos=netBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(ptPos,this._netmap._diagram);var nu=this._netmap._diagram.nodes.count>0?200:0;var ptPosRet=netBrain.Map.GoDiagramPositionUtil.findProperZoomPosByTargetOriginPos(this._netmap._diagram,ptPos,150,nu);return ptPosRet=netBrain.Map.GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(ptPosRet,this._netmap._diagram)},makeNeatMap:function(httpExternNbrSrvc,isNeatUp){var netmap=this._netmap;if(null!=netmap)if(isNeatUp){var medias=this._getCanNeatMedias();if(null==medias||medias.length<=0){netmap.setIsNeatUp(!0);return}var mediaInfos=[];for(var i=0;i<medias.length;i++){var media=medias[i];mediaInfos.push({mediaId:media.getKey(),mediaName:media.getHostname()[0],mediaType:media.getDevType(),neat:!1})}var netmapOperator=this;httpExternNbrSrvc.getMediaNeatInfos(null,mediaInfos).then((function(result){null!=result&&netmapOperator._hideNeatmedia(result.mediaInfos)}),(function(){console.warn("Failed call getMediaNeatInfos")}))}else this._showNeatMedia()},setDeviceSelected:function(deviceKey){this._netmap._diagram.findNodeForKey(deviceKey).isSelected=!0},setDeviceSelectedStatus:function(deviceKey){var dev=this._netmap._diagram.findNodeForKey(deviceKey);var adornment=NormalSelectAdormenTemplate.borderSelectNodeTemplate();adornment.category="borderSelectNodeTemplate";adornment.adornedObject=dev;dev.addAdornment("borderSelectNodeTemplate",adornment)},removeDeviceSelectedStatus:function(deviceKey){this._netmap._diagram.findNodeForKey(deviceKey).removeAdornment("borderSelectNodeTemplate")},setDeviceDisabledStatus:function(deviceKey){this._netmap._diagram.findNodeForKey(deviceKey).opacity=.6},removeDeviceDisabledStatus:function(deviceKey){this._netmap._diagram.findNodeForKey(deviceKey).opacity=1},deleteDevcieDataViewPostion:function(deviceKey,pos){var dev=this._netmap._diagram.findNodeForKey(deviceKey);var posIndex;if(pos.indexOf("devPos")>-1){if((posIndex=_.findIndex(dev.data.dataViewData.devPosList,(function(item){return item.posName===pos})))>-1){dev.data.dataViewData.devPosList.splice(posIndex,1);dev.updateTargetBindings()}}else{var it=dev.findLinksOutOf().iterator;for(;it.next();){var part=it.value;if(null!=part.data&&(posIndex=_.findIndex(part.data.intfSrc.intfInfo.intfPosList,(function(item){return item.posName===pos})))>-1){part.data.intfSrc.intfInfo.intfPosList.splice(posIndex,1);part.updateTargetBindings()}}this._netmap.layoutLinkLabels()}},setDevcieDataViewPositionLabelGraphicInfo:function(deviceKey,pos,labelGraphicInfo){var dev=this._netmap._diagram.findNodeForKey(deviceKey);var posObj;if(pos.indexOf("devPos")>-1){(posObj=_.find(dev.data.dataViewData.devPosList,(function(item){return item.posName===pos}))).labelGraphicInfo.bgColor=labelGraphicInfo.bgColor;posObj.labelGraphicInfo.color=labelGraphicInfo.color;dev.updateTargetBindings()}else{var it=dev.findLinksOutOf().iterator;for(;it.next();){var part=it.value;if(null!=part.data){(posObj=_.find(part.data.intfSrc.intfInfo.intfPosList,(function(item){return item.posName===pos}))).labelGraphicInfo.bgColor=labelGraphicInfo.bgColor;posObj.labelGraphicInfo.color=labelGraphicInfo.color;var destIntfPosList=NgUtil.getValueFromObjAndPath(part.data,"intfDest.intfInfo.intfPosList");if(destIntfPosList){var posObjDest=_.find(destIntfPosList,(function(item){return item.posName===pos}));if(posObjDest){posObjDest.labelGraphicInfo.bgColor=labelGraphicInfo.bgColor;posObjDest.labelGraphicInfo.color=labelGraphicInfo.color}}part.updateTargetBindings()}}this._netmap.layoutLinkLabels()}},blinkDevcieDataViewPostion:function(deviceKey,pos){var dev=this._netmap._diagram.findNodeForKey(deviceKey);if(pos.indexOf("devPos")>-1){var posObj=_.find(dev.data.dataViewData.devPosList,(function(item){return item.posName===pos}));var currText;dev&&(currText=function(dev,posInfo){var du=null;var posLabelPanel=dev.findObject(netBrain.Map.CompDevice.devPosInfoLabelPanel);if(posLabelPanel){var currPanel=posLabelPanel.findItemPanelForData(posInfo);currPanel&&(du=currPanel.findObject(netBrain.Map.CompDevice.devPosInfoLabel))}return du}(dev,posObj));if(currText){var bColor=currText.background;setColor({posObj:posObj,currNode:currText,colors:[bColor,"#ff0000"===bColor?"blue":"red"],nCount:6,nSleep:200,repCount:0,dev:dev})}}else{var it=dev.findLinksOutOf().iterator;for(;it.next();){var part=it.value;setTimeout(ecu,100,{part:part,self:this,pos:pos})}}},selectAndActiveDeviceById:function(id){var self=this;var dataViewsSegmentIn=new DataViewsSegment;dataViewsSegmentIn.addDev(id);this._dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegmentIn).then((function(dataViewsSegmentOut){if(null!=dataViewsSegmentOut){dataViewsSegmentOut.__proto__=new DataViewsSegment;var devDataViewSegmentList=dataViewsSegmentOut.getDevDataViewSegmentList();var transactionName=NgUtil.getUniqueStr("drop all device");self._netmap._diagram.startTransaction(transactionName);if(devDataViewSegmentList&&1===devDataViewSegmentList.length){var node=dataViewsSegmentOut.getDevSegmentDevDataView(devDataViewSegmentList[0]);if(null!=node){var netmap=self._netmap;if(netmap._isExistNode(node)){netmap._centerNode(node);self.highlightNode(node)}}}netmap._diagram.commitTransaction(transactionName)}}))},highlightPosList:function(arr,skipRefreshMapView,bkColor){if(_.isArray(arr)){var hardCodePosBackground=bkColor||"#ffe7b3";var netmap=this._netmap;var diagram=netmap.getGoJsDiagram();if(diagram){diagram.startTransaction("highlightDataUnits");arr.forEach((function(obj){var deviceKey=obj.key;var device=diagram.findNodeForKey(deviceKey);if(device){var devPosList=device.data.dataViewData.devPosList;obj.devPosNameList.forEach((function(newPosName){var pos=_.find(devPosList,(function(oldPos){return oldPos.posName===newPosName}));if(pos){pos.dataUnitInfo=pos.dataUnitInfo||{};pos.dataUnitInfo.bgColor=hardCodePosBackground}}));diagram.model.updateTargetBindings(device.data);obj.intfList.forEach((function(intfObj){var link=_getLinkFromDeviceIntfValue(device,intfObj.value);if(link){var data=link.data;var intfPosNameList=intfObj.intfPosNameList;var intfInfoObj=data.fromPort===intfObj.value?data.intfSrc:data.intfDest;if(intfInfoObj){var intfPosList=intfInfoObj.intfInfo.intfPosList;intfPosNameList.forEach((function(intfName){var intf=_.find(intfPosList,(function(oldInf){return oldInf.posName===intfName}));if(intf){intf.dataUnitInfo=intf.dataUnitInfo||{};intf.dataUnitInfo.bgColor=hardCodePosBackground}}));diagram.model.updateTargetBindings(link.data)}}}))}}));netmap.removeAllLinkHighlightFlag();!0!==skipRefreshMapView&&netmap.refreshMapViewOptionVisible();diagram.commitTransaction("highlightDataUnits")}}},submitNoteToolText:function(){var diagram=this._netmap._diagram;diagram&&diagram.toolManager.textEditingTool.acceptText(go.TextEditingTool.MouseDown)},getPathByPathId:function(pathId){if(this._netmap._diagram){return this.getLinkByKey(pathId)}},showPathByPathId:function(pathId){var diagram=this._netmap._diagram;if(diagram){var path=this.getPathByPathId(pathId);path&&diagram.select(path)}},showPathABByPathId:function(pathId){var diagram=this._netmap._diagram;if(diagram){var path=this.getPathByPathId(pathId);path&&this.diagramPathManager.showPathAB(diagram,path)}},showPathTip:function(pathObj,deviceId,selectHopInfo){var diagram=this._netmap._diagram;if(diagram){var path=this.getPathByPathId(pathObj.pathId);if(path){var deviceNode=diagram.findNodeForKey(deviceId);deviceNode&&this.diagramPathManager.openPathTip(diagram,path,deviceNode,path.data,selectHopInfo)}}},showPathABAndTip:function(path,deviceId,skipSelect){var diagram=this._netmap._diagram;if(diagram){var pathnew=this.getPathByPathId(path.pathId);if(pathnew){!0!==skipSelect&&diagram.select(pathnew);this.diagramPathManager.showPathAB(diagram,pathnew);if(deviceId){var deviceNode=diagram.findNodeForKey(deviceId);deviceNode&&this.diagramPathManager.openPathTip(diagram,pathnew,deviceNode,pathnew.data)}}}},changeHopsVisibleByPathId:function(pathId,isShow){var pathnew=this.getPathByPathId(pathId);if(pathnew){var transactionName=NgUtil.getUniqueStr("changeHopsVisibleByPathId");this.startTransaction(transactionName);var isHide=!isShow;_.each(pathnew.data.hoplist,(function(item,index){index>0&&(item.isHide=isHide)}));pathnew.isSelected=!1;pathnew.updateTargetBindings();pathnew.startRoute();pathnew.makeSubPaths();pathnew.commitRoute();this.commitTransaction(transactionName)}},updatePathNoteVisible:function(hopIds,isHide){this._netmap._diagram.nodes.each((function(node){var nodeData=node.data;if(NetBrain.Map.CategoryMgr.isDeviceNote(nodeData.category)&&_.contains(hopIds,nodeData.hopId)){nodeData.isHopHide=isHide;node.updateTargetBindings()}}))},deletePathByPathId:function(pathId){var diagram=this._netmap._diagram;if(diagram){var pathnew=this.getPathByPathId(pathId);if(pathnew){var transactionName=NgUtil.getUniqueStr("deletePathByPathId");this.startTransaction(transactionName);diagram.remove(pathnew);this.commitTransaction(transactionName)}}},setMapAutoLinkOptionExcluedeMip:function(obj){this._netmap.setMapAutoLinkOptionExcluedeMip(obj)},getMapAutoLinkOptionExcluedeMip:function(){return this._netmap.getMapAutoLinkOptionExcluedeMip()},startTransaction:function(name){var diagram=this._netmap._diagram;diagram&&diagram.startTransaction(name)},commitTransaction:function(name){var diagram=this._netmap._diagram;diagram&&diagram.commitTransaction(name)},getSimpleNodeDataArray:function(){return this._netmap?this._netmap.getSimpleNodeDataArray():[]},getSimpleLinkDataArray:function(){return this._netmap?this._netmap.getSimpleLinkDataArray():[]},updateNodesLoc:function(locations){var transactionName=NgUtil.getUniqueStr("updateNodesLoc");this.startTransaction(transactionName);this._netmap.updateNodesLoc(locations);this.commitTransaction(transactionName)},getViewportBounds:function(){return this._netmap.getViewportBounds()},showHighlightBg:function(deviceIds,style){if(this._netmap){var transactionName=NgUtil.getUniqueStr("showHighlightBg");this.startTransaction(transactionName);this._netmap.showHighlightBg(deviceIds);this.commitTransaction(transactionName)}},hideHighlightBg:function(deviceIds){if(this._netmap){if(!_.isArray(deviceIds)){var nodes=this.getSimpleNodeDataArray();deviceIds=_.pluck(nodes,"key")}if(_.isArray(deviceIds)&&deviceIds.length>0){var transactionName=NgUtil.getUniqueStr("showHighlightBg");this.startTransaction(transactionName);this._netmap.hideHighlightBg(deviceIds);this.commitTransaction(transactionName)}}},refreshHighlightBgFromCache:function(){var transactionName=NgUtil.getUniqueStr("showHighlightBg");this.startTransaction(transactionName);this._netmap.refreshHighlightBgFromCache();this.commitTransaction(transactionName)},pinNodes:function(deviceIds){console.log("pinNodes success.")},unpinNodes:function(deviceIds){console.log("unpinNodes success.")},updateDeviceIconSize:function(deviceId,scale){console.log("updateDeviceIconSize success.")},updateDeviceIconRatio:function(deviceId,ratio){var transactionName=NgUtil.getUniqueStr("updateDeviceIconRatio");this.startTransaction(transactionName);this._netmap.updateDeviceIconRatio(deviceId,ratio);this.commitTransaction(transactionName)},updateDevicesIconRatio:function(deviceIds,ratio){var netMap=this._netmap;var transactionName=NgUtil.getUniqueStr("updateDeviceIconRatio");this.startTransaction(transactionName);_.each(deviceIds,(function(deviceId){netMap.updateDeviceIconRatio(deviceId,ratio)}));netMap.updateTargetBindings(deviceIds);this.commitTransaction(transactionName)},refreshSelectionStyle:function(){this._netmap.refreshSelectionStyle()},selectOtherSameTypeNodes:function(part){this._netmap.selectOtherSameTypeNodes(part)},appendNoteContent:function(noteKey,waitAppendContent){var netmap=this._netmap;if(netmap){var note=netmap._getGraphDeviceByKey(noteKey);if(note){var transactionName=NgUtil.getUniqueStr("appendNoteContent");this.startTransaction(transactionName);var newContent=netBrain.Map.noteTool.mergeContent(note.data.noteContent,waitAppendContent);netmap.updateNoteContent(noteKey,newContent);netmap.updateNoteModifyTime(noteKey);note.data.tryGrowHeight(note);this.commitTransaction(transactionName)}}},mergeToOneNote:function(noteDatas){var netmap=this._netmap;if(netmap){var diagram=netmap.getGoJsDiagram();if(diagram&&_.isArray(noteDatas)&&!(noteDatas.length<2)){var transactionName=NgUtil.getUniqueStr("mergeToOneNote");this.startTransaction(transactionName);var firstNote=netmap._getGraphDeviceByKey(noteDatas[0].key);var existLinkObj={};firstNote.linksConnected.each((function(l){var data=l.data;var key=makeTempLinkKey(data);existLinkObj[key]=!0;var toFromKey=makeTempLinkKey({from:data.to,fromPort:data.toPort,to:data.from,toPort:data.fromPort});existLinkObj[toFromKey]=!0}));var waitingUpdateLinks=[];var waitingRemoveParts=[];_.each(noteDatas.slice(1),(function(noteData){var note=netmap.getNodeByData(noteData);if(note){note.linksConnected.each((function(link){var linkData=link.data;linkData.from===note.data.key?waitingUpdateLinks.push({link:link,dir:"from"}):linkData.to===note.data.key&&waitingUpdateLinks.push({link:link,dir:"to"})}));waitingRemoveParts.push(note)}}));var newContent=netBrain.Map.noteTool.mergeToOneNoteContent(noteDatas);var oneNoteData=noteDatas[0];_.each(waitingUpdateLinks,(function(obj){var linkData=obj.link.data;var tmpLinkData={from:linkData.from,fromPort:linkData.fromPort,to:linkData.to,toPort:linkData.toPort};tmpLinkData[obj.dir]=oneNoteData.key;var tmpKey=makeTempLinkKey(tmpLinkData);if(existLinkObj[tmpKey])waitingRemoveParts.push(obj.link);else{diagram.model.setDataProperty(linkData,obj.dir,oneNoteData.key);existLinkObj[tmpKey]=!0;var toFromKey=makeTempLinkKey({from:tmpLinkData.to,fromPort:tmpLinkData.toPort,to:tmpLinkData.from,toPort:tmpLinkData.fromPort});existLinkObj[toFromKey]=!0}}));var oneNote=netmap.getNodeByData(oneNoteData);if(oneNote){oneNote.data.setLastModifyUser(window.gUserName,diagram);oneNote.data.setModifyTime(new Date,diagram);oneNote.data.setNoteContent(newContent,diagram);oneNote.data.tryGrowHeight(oneNote)}_.each(waitingRemoveParts,(function(part){diagram.remove(part)}));this.commitTransaction("mergeToOneNote")}}},mergeDeviceNoteRefDevice:function(deviceId,noteObj){var existNote=this.findDeviceNoteRefDeviceByNoteTitle(deviceId,noteObj.title);existNote?this.appendNoteContent(existNote.key,noteObj.content):this.addDeviceNoteRefDevice(deviceId,noteObj)},mergeIntfNoteRefDevice:function(deviceId,intf,noteObj){var existNote=this.findIntfNoteRefDeviceByNoteTitle(deviceId,intf.intfKeyObj.value,noteObj.title);existNote?this.appendNoteContent(existNote.key,noteObj.content):this.addIntfNoteRefDevice(deviceId,intf,noteObj)},a:function(nodeData){nodeData.devCategory=9;this._netmap.hasL2DeviceStyle=function(devCategory){return 1001===devCategory||9===devCategory};this.updateNodesLinksStyle([nodeData],[])},updateNodesLinksStyle:function(nodes,links){var netmap=this._netmap;if(netmap){var transactionName=NgUtil.getUniqueStr("updateNodesLinksStyle");this.startTransaction(transactionName);_.each(nodes,(function(node){var newCategory=netBrain.Map.CategoryMgr.NetworkDevice;netmap.isL2DeviceStyle(node)&&(newCategory=netBrain.Map.CategoryMgr.L2Device);netmap.updateNodeStyle(node,newCategory)}));_.each(links,(function(link){var newCategory=netBrain.Map.CategoryMgr.TopoLink;netmap.isL2LinkStyle(link)&&(newCategory=netBrain.Map.CategoryMgr.L2TopoLink);netmap.updateLinkStyle(link,newCategory)}));this.commitTransaction(transactionName)}},changeLinkLineStyle:function(links,newLineStyle){var netmap=this._netmap;if(netmap){var tsName=NgUtil.getUniqueStr("changeLinkStyle");this.startTransaction(tsName);var CategoryMgr=netBrain.Map.CategoryMgr;var groups=_.partition(links,(function(link){return CategoryMgr.isPathLink(link.category)}));netmap.changeLinkLineStyle(groups[1],newLineStyle);netmap.changePathLineStyle(groups[0],newLineStyle);netmap.refreshMapViewOptionVisible();this.commitTransaction(tsName)}},changeSelectedLinksLineStroke:function(stroke){var links=this.getLinksWhichCanBeChangedStyle();this.changeLinkLineStyle(links,{stroke:stroke})},changeSelectedLinksLineStrokeWidth:function(width){var links=this.getLinksWhichCanBeChangedStyle();this.changeLinkLineStyle(links,{strokeWidth:width})},changeSelectedLinksLineStrokeDashArray:function(strokeDashArray){var links=this.getLinksWhichCanBeChangedStyle();this.changeLinkLineStyle(links,{strokeDashArray:strokeDashArray})},getLinksWhichCanBeChangedStyle:function(){var links=this.getSelectedLinks();var isCustomizableLink=netBrain.Map.CategoryMgr.isCustomizableLink;return _.filter(links,(function(link){return isCustomizableLink(link.data.category)}))},removeLinkLineCustomizedStyle:function(strokeDashArray){var netmap=this._netmap;if(netmap){var links=this.getLinksWhichCanBeChangedStyle();var tsName=NgUtil.getUniqueStr("removeLinkLineCustomizedStyle");this.startTransaction(tsName);netmap.removeLinkLineCustomizedStyle(links);netmap.refreshMapViewOptionVisible();this.commitTransaction(tsName)}}};function isPathNote(noteData){return noteData.noteFromType===netBrain.Map.Const.NoteFromType.Path}function _getLinkFromDeviceIntfValue(device,value){var links=device.linksConnected;var currLink=null;links.each((function(link){currLink||link.data.fromPort!==value&&link.data.toPort!==value||(currLink=link)}));return currLink}function setColor(opts){var posObj=opts.posObj,colors=opts.colors,currNode=opts.currNode,dev=opts.dev;var currColor=colors[opts.repCount%2];if(currNode)currNode.background=currColor;else{posObj.labelGraphicInfo.bgColor=currColor;dev.updateTargetBindings()}opts.repCount++;opts.repCount<=opts.nCount&&setTimeout(setColor,opts.nSleep,opts)}function createOpts(posObj,oldColor,nCount,nSleep,repCount,self,currNode){return{posObj:posObj,currNode:currNode,colors:[oldColor,"#ff0000"===oldColor?"blue":"red"],nCount:nCount,nSleep:nSleep,repCount:repCount,part:currNode.part,self:self}}function ecu(opt){var part=opt.part,self=opt.self,pos=opt.pos;if(null!=part.data){var posObj=_.find(part.data.intfSrc.intfInfo.intfPosList,(function(item){return item.posName===pos}));if(posObj){var currText=getLinkCurrDataUnitByPosInfo(part,posObj,!0);if(currText){ecuSetColor(createOpts(posObj,currText.background,6,200,0,self,currText))}}var destIntfPosList=NgUtil.getValueFromObjAndPath(part.data,"intfDest.intfInfo.intfPosList");if(destIntfPosList){var posObjDest=_.find(destIntfPosList,(function(item){return item.posName===pos}));if(posObjDest){var currTextDest=getLinkCurrDataUnitByPosInfo(part,posObjDest,!1);if(currTextDest){ecuSetColor(createOpts(posObjDest,currTextDest.background,6,200,0,self,currTextDest))}}}}}function ecuSetColor(opts){var aPosObj=opts.posObj,part=opts.part,currNode=opts.currNode,self=opts.self,colors=opts.colors,nCount=opts.nCount;var currColor=colors[opts.repCount%2];if(currNode)currNode.background=currColor;else{aPosObj.labelGraphicInfo.bgColor=currColor;part.updateTargetBindings()}self._netmap.layoutLinkLabels();opts.repCount++;opts.repCount<=nCount&&setTimeout(ecuSetColor,opts.nSleep,opts)}function getLinkCurrDataUnitByPosInfo(link,posInfo,isFrom){var du=null;var intfNumArr=posInfo.posName.match(/\d/);if(intfNumArr.length>0){var intfKey=(isFrom?"intfSrc":"intfDest")+"_"+(intfNumArr[0]-1);var posLabelPanel=link.findObject(intfKey);if(posLabelPanel){var currPanel=posLabelPanel.findItemPanelForData(posInfo);currPanel&&(du=currPanel.findObject(netBrain.Map.CompTopolink.linkPosInfoLabel))}}return du}function resetLocWithFactor(diagram,factor){if(diagram&&_.isNumber(factor)&&!(factor<=0)){var nodes=diagram.nodes;if(nodes&&0!==nodes.count){var first=nodes.first();var firstLoc=first.location;var px0=firstLoc.x;var py0=firstLoc.y;nodes.each((function(node){if(node!==first){var p1Loc=node.location;var px1=p1Loc.x;var py1=p1Loc.y;var diffX=px1-px0||1e-6;var diffY=py1-py0;var k=diffY/diffX;var dis=Math.sqrt(diffY*diffY+diffX*diffX);var newPoints=function(p0,dis,k){var tx=Math.sqrt(dis*dis/(k*k+1));var x1=tx+p0.x;var x2=-tx+p0.x;var y1=k*(x1-p0.x)+p0.y;var y2=k*(x2-p0.x)+p0.y;return[{x:x1,y:y1},{x:x2,y:y2}]}(firstLoc,dis*=factor,k);var np1=newPoints[0];var np2=newPoints[1];var newLoc;newLoc=(np1.x-px1)*(np1.x-px1)+(np1.y-py1)*(np1.y-py1)<(np2.x-px1)*(np2.x-px1)+(np2.y-py1)*(np2.y-py1)?np1.x+" "+np1.y:np2.x+" "+np2.y;node.location=go.Point.parse(newLoc)}}))}}}function makeTempLinkKey(linkData){var from=linkData.from||"";var to=linkData.to||"";return[from,linkData.fromPort||"",to,linkData.toPort||""].join("-")}netBrain.Map=netBrain.Map||{};netBrain.Map.CNetMapOperator=CNetMapOperator}(NetBrain);!function(netBrain){function getPointBetweenP0AndP1(p0,p1){var x,y;var diffX=Math.min(Math.abs(p1.x-p0.x),3);var diffY=Math.min(Math.abs(p1.y-p0.y),3);switch(getDirection(p0,p1)){case 0:x=p1.x;y=p0.y-diffY;break;case 1:x=p0.x+diffX;y=p1.y;break;case 2:x=p1.x;y=p0.y+diffY;break;case 3:x=p0.x-diffX;y=p0.y;break;default:x=p0.x;y=p0.y}return{x:x,y:y}}function getDirection(p0,p1){var dir=-1;p1.x===p0.x?dir=p1.y-p0.y>0?2:0:p1.y===p0.y&&(dir=p1.x-p0.x>0?1:3);return dir}function isL2DeviceStyle(devKey,jsData){var flag=!1;var obj=_.find(jsData.nodeDataArray,(function(node){return node.key===devKey}));if(obj&&netBrain.Map.CategoryMgr.isDeviceCategory(obj.category)){var l3StylesList=jsData.l3StyleInExpandedStyle;flag=!_.contains(l3StylesList,obj.devCategory+"")}return flag}function createPointBetweenTwoPoints(p0,p1,nextDir){var p;var xFlag=p0.x===p1.x;var yFlag=p0.y===p1.y;xFlag||yFlag||(0===nextDir||2===nextDir?p={x:p1.x,y:p0.y}:1!==nextDir&&3!==nextDir||(p={x:p0.x,y:p1.y}));return p}var fixLinkTools={prevFixLinksFrom6X:function(netmap,jsData){if(!0===jsData.l2Style&&!0===jsData.isFrom6X){var zoomLinkHandler=netBrain.Map.zoomLinkHandler;_.each(jsData.linkDataArray,(function(link){if(_.isArray(link.pointsL2)){var pointsL2=function(pointsL2From6X){var newPoints=[];_.each(pointsL2From6X,(function(p){newPoints.push(p.split(",").join(""))}));var pso=netBrain.Map.zoomLinkHandler.forTest.pointsToObj(newPoints);var p0=pso[0];var p1=pso[1];var p2=pso[pso.length-2];var p3=pso[pso.length-1];var addP1=getPointBetweenP0AndP1(p0,p1);newPoints.splice(1,0,addP1.x+" "+addP1.y);var addP2=getPointBetweenP0AndP1(p3,p2);newPoints.splice(newPoints.length-1,0,addP2.x+" "+addP2.y);return newPoints}(link.pointsL2);link.pointsL2From6X=pointsL2;link.pointsL2=null;if(!((pointsL2=function(points){var newPoints=[];_.each(points,(function(p){p!==newPoints[newPoints.length-1]&&newPoints.push(p)}));return newPoints}(pointsL2)).length<2)){var p0=(pointsL2=zoomLinkHandler.forTest.pointsToObj(pointsL2))[0];var p1=pointsL2[1];var p2=pointsL2[pointsL2.length-2];var p3=pointsL2[pointsL2.length-1];var fromDir=4;isL2DeviceStyle(link.from,jsData)&&(fromDir=getDirection(p0,p1));link.fromSpotFrom6X=fromDir;var toDir=4;isL2DeviceStyle(link.to,jsData)&&(toDir=getDirection(p3,p2));link.toSpotFrom6X=toDir}}}))}},fixLinksFrom6X:function(netmap,jsData){if(!0===jsData.l2Style&&!0===jsData.isFrom6X){var diagram=netmap._diagram;var getSimilarPoints=netBrain.Map.zoomLinkHandler.forTest.getSimilarPoints;var linkDataArray=diagram.model.linkDataArray;var newLinks=[];var changedCount=0;_.each(linkDataArray,(function(link){var pointsL2From6X=link.pointsL2From6X;if(_.isArray(pointsL2From6X)&&pointsL2From6X.length>2&&_.isArray(link.pointsL2)){var newPointsL2=getSimilarPoints(link.pointsL2,pointsL2From6X);newPointsL2=function(points,fDir,tDir){if(points.length<4)return points;var p0=(points=netBrain.Map.zoomLinkHandler.forTest.pointsToObj(points))[0];var p1=points[1];var nextDir=getDirection(p1,points[2]);var np0=createPointBetweenTwoPoints(p0,p1,nextDir);np0&&points.splice(1,0,np0);var p2=points[points.length-2];var p3=points[points.length-1];nextDir=getDirection(p2,points[points.length-3]);var np1=createPointBetweenTwoPoints(p3,p2,nextDir);np1&&points.splice(-1,0,np1);return points=netBrain.Map.zoomLinkHandler.forTest.pointsToString(points)}(newPointsL2);link.pointsL2=newPointsL2;delete link.pointsL2From6X;changedCount++}newLinks.push(link)}));delete jsData.isFrom6X;changedCount>0&&(diagram.model.linkDataArray=newLinks);return newLinks}},prevFixLinks:function(netmap,jsData){if(!0===jsData.l2Style){netBrain.Map.zoomLinkHandler;_.each(jsData.linkDataArray,(function(link){if(_.isArray(link.pointsL2)){var pointsL2=link.pointsL2;link.oldPointsL2=pointsL2;link.pointsL2=null}}))}},fixLinks:function(netmap,jsData){if(!0===jsData.l2Style){var diagram=netmap._diagram;var getSimilarPoints=netBrain.Map.zoomLinkHandler.forTest.getSimilarPoints;var linkDataArray=diagram.model.linkDataArray;var newLinks=[];var changedCount=0;_.each(linkDataArray,(function(link){var oldPointsL2=link.oldPointsL2;if(_.isArray(oldPointsL2)&&oldPointsL2.length>2&&_.isArray(link.pointsL2)){var newPointsL2=getSimilarPoints(link.pointsL2,oldPointsL2);link.pointsL2=newPointsL2;delete link.oldPointsL2;changedCount++}newLinks.push(link)}));changedCount>0&&(diagram.model.linkDataArray=newLinks);return newLinks}}};netBrain.Map=netBrain.Map||{};netBrain.Map.fixLinkTools=fixLinkTools}(NetBrain);!function(netBrain){function SliceOperator(nodes,links,options){if(!Array.isArray(nodes)||!Array.isArray(links))throw new Error("SliceOperator arguments error.");this.options=_.extend({maxLength:500},options);this._nodes=[];this._links=[];this._overageNodes=[];this._overageLinks=[];this._slice(nodes,links)}SliceOperator.prototype.getNodes=function(){return this._nodes};SliceOperator.prototype.getLinks=function(){return this._links};SliceOperator.prototype.getOverageNodes=function(nodeDataArray){if(!Array.isArray(nodeDataArray))throw new Error("SliceOperator.prototype.getOverageNodes nodeDataArray is not an array.");if(0===this._overageNodes.length)return[];var result=[];var map=new Map;nodeDataArray.forEach((function(node){map.set(node.key,node)}));this._overageNodes.forEach((function(node){map.get(node.key)||result.push(node)}));return result};SliceOperator.prototype.getOverageLinks=function(nodeDataArray){if(!Array.isArray(nodeDataArray))throw new Error("SliceOperator.prototype.getOverageLinks nodeDataArray is not an array.");if(0===this._overageLinks.length)return[];var result=[];var map=new Map;nodeDataArray.forEach((function(node){map.set(node.key,node)}));this._overageLinks.forEach((function(link){map.get(link.from)&&map.get(link.to)||result.push(link)}));return result};SliceOperator.prototype._slice=function(nodes,links){var maxLength=this.options.maxLength;if(nodes.length<maxLength){this._nodes=this._nodes.concat(nodes);this._links=this._links.concat(links)}else this._doSlice(nodes,links)};SliceOperator.prototype._doSlice=function(nodes,links){var nodesMap=this._buildNodesMap(nodes,links);this._sliceNodesMap(nodesMap,links)};SliceOperator.prototype._sliceNodesMap=function(nodesMap,links){var nodes=[];nodesMap.forEach((function(node){nodes.push(node)}));var maxLength=this.options.maxLength;nodes=_.sortBy(nodes,(function(node){return-node.links.length}));var currNodes=_.map(nodes.splice(0,maxLength),(function(node){return node.node}));var overageNodes=_.map(nodes,(function(node){return node.node}));var cnsMap=new Map;_.each(currNodes,(function(cn){cnsMap.set(cn.key,!0)}));var linksSet=new Set;currNodes.forEach((function(node){nodesMap.get(node.key).links.forEach((function(link){cnsMap.has(link.from)&&cnsMap.has(link.to)&&linksSet.add(link)}))}));var currLinks=Array.from(linksSet);var overageLinks=[];links.forEach((function(link){linksSet.has(link)||overageLinks.push(link)}));this._nodes=currNodes;this._overageNodes=overageNodes;this._links=currLinks;this._overageLinks=overageLinks};SliceOperator.prototype._buildNodesMap=function(nodes,links){var map=new Map;nodes.forEach((function(node){map.set(node.key,{node:node,links:[]})}));links.forEach((function(link){var from=link.from;var to=link.to;var fromNode=map.get(from);fromNode&&fromNode.links.push(link);var toNode=map.get(to);toNode&&toNode.links.push(link)}));return map};netBrain.Map=netBrain.Map||{};netBrain.Map.SliceOperator=SliceOperator}(NetBrain);!function(netBrain){var AbstractOp=function(){this._netmap=null;this._rootScope=null;this._q=null};AbstractOp.prototype={constructor:AbstractOp,setNetmap:function(netmap){this._netmap=netmap},getNetmap:function(){return this._netmap},setRootScope:function(rootScope){this._rootScope=rootScope},getRootScope:function(){return this._rootScope},getQ:function(){return this._q},setQ:function(q){this._q=q},isDoable:function(){return!0}};netBrain.Map=netBrain.Map||{};netBrain.Map.AbstractOp=AbstractOp}(NetBrain);!function(netBrain){var DataViewApplyOp=function(){netBrain.Map.AbstractOp.call(this)};(DataViewApplyOp.prototype=new netBrain.Map.AbstractOp).replaceLinkLine=function(linkLine,compDev,promises){if(null===linkLine||null===compDev)return!1;if(this.isDoable()){var netmap=this._netmap;if(null===netmap)return!1;var promise=null;if(linkLine.getFromKey()===compDev.getKey()){var intfValue=linkLine.getIntfValueSrc();var intfInfo=compDev.getIntfInfo(intfValue);if(intfInfo){var linkObj=netmap._diagram.findLinkForData(linkLine.getJsData());var intfInfoSrc=linkLine.getIntfInfoSrc();if(intfInfo&&intfInfoSrc&&intfInfoSrc.intf&&intfInfoSrc.intf){intfInfo.intf=intfInfo.intf||{};intfInfo.intf.intfNodeData=intfInfoSrc.intf.intfNodeData}if(compDev.getIntfObjByIntfId(linkLine.getIntfKeyObjSrc().value)){linkLine.setIntfInfoSrc(intfInfo);linkLine.setViewInfosSrc(compDev.getDataViewInfos())}netmap._model.updateTargetBindings(linkObj.data);linkObj.invalidateRoute();return!0}notDefaultDataView(linkLine)&&(promise=setLinkToDefault(compDev.getKey(),this,intfValue,linkLine.getFromKey(),linkLine.getToKey(),!0))&&promises.push(promise)}else if(linkLine.getToKey()===compDev.getKey()){var intfValue1=linkLine.getIntfValueDest();var intfInfo1=compDev.getIntfInfo(intfValue1);if(intfInfo1){var linkObj1=netmap._diagram.findLinkForData(linkLine.getJsData());var intfInfoDest=linkLine.getIntfInfoDest();if(intfInfo1&&intfInfoDest&&intfInfoDest.intf&&intfInfoDest.intf){intfInfo1.intf=intfInfo1.intf||{};intfInfo1.intf.intfNodeData=intfInfoDest.intf.intfNodeData}if(compDev.getIntfObjByIntfId(linkLine.getIntfKeyObjDest().value)){linkLine.setIntfInfoDest(intfInfo1);linkLine.setViewInfosDest(compDev.getDataViewInfos())}netmap._model.updateTargetBindings(linkObj1.data);linkObj1.invalidateRoute();return!0}notDefaultDataView(linkLine)&&(promise=setLinkToDefault(compDev.getKey(),this,intfValue1,linkLine.getFromKey(),linkLine.getToKey(),!1))&&promises.push(promise)}}};DataViewApplyOp.prototype.doApplyDataViewsSegment=function(dataViewsSegment,bRefresh){if(null!==this._netmap&&null!==dataViewsSegment&&this.isDoable()){var netmap=this._netmap;var diagram=netmap._diagram;var oldskips=diagram.skipsUndoManager;var devId=null;var compDev=null;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("doApplyDataViewsSegment");netmap._diagram.startTransaction(transactionName);var devDataViewSegmentList=dataViewsSegment.getDevDataViewSegmentList();if(devDataViewSegmentList)for(var i=0;i<devDataViewSegmentList.length;i++){var devDataViewSegment=devDataViewSegmentList[i];if(null!==(devId=dataViewsSegment.getDevSegmentDevId(devDataViewSegment))&&null!==(compDev=netmap._getCompDeviceByKey(devId))){var newDevData=dataViewsSegment.getDevSegmentDevDataView(devDataViewSegment);if(newDevData){var compNewDev=NgUtil.cloneJson(newDevData);netBrain.Map.CompPrototypeFactory.buildCompPrototype(compNewDev);netmap._switchViewFromDevice(compNewDev,!0)}}}var intfDataViewSegmentList=dataViewsSegment.getIntfDataViewSegmentList();var willUpdateLinks=[];if(intfDataViewSegmentList)for(var j=0;j<intfDataViewSegmentList.length;j++){var intfDataViewSegment=intfDataViewSegmentList[j];if(null!==(devId=dataViewsSegment.getIntfSegmentDevId(intfDataViewSegment))){var topoType=dataViewsSegment.getIntfSegmentIntfTopoType(intfDataViewSegment);if(null!==topoType){var intfId=dataViewsSegment.getIntfSegmentIntfKeyValue(intfDataViewSegment);if(null!==intfId&&(compDev=netmap._getCompDeviceByKey(devId))&&compDev.dataViewData&&compDev.dataViewData.intfInfoList){var intfInfo=_.find(compDev.dataViewData.intfInfoList,(function(intf){if(intf.intf)return intf.intf.intfKeyObj.value===intfId;if(intf.intfKey)return intf.intfKey.value===intfId;if(!intf.intfDataView)return intf.intfInfo.intf.intfKeyObj.value===intfId;intf.intfDataView.intfInfo.intf.intfKeyObj.value}));intfInfo&&(intfInfo.intfInfo?intfInfo.intfInfo.intfPosList=intfDataViewSegmentList[j].intfDataView.intfInfo.intfPosList:intfInfo.intfPosList=intfDataViewSegmentList[j].intfDataView.intfInfo.intfPosList);var output=netmap.getNetmapOperator()._getLinkLineByDevIdAndIntfId(topoType,devId,intfId);if(null!==output&&output.bResult){var linkLines=output.linkLines;if(linkLines)for(var k=0;k<linkLines.length;k++){var bSrc=linkLines[k].bSrc;var linkLine=linkLines[k].linkLine;var dataViewInfo=dataViewsSegment.getIntfSegmentIntfDataViewInfo(intfDataViewSegment);var intfInfo1=dataViewsSegment.getIntfSegmentIntfInfo(intfDataViewSegment);intfInfo1&&(intfInfo1=NgUtil.cloneJson(intfInfo1));if(bSrc){var linkObj=netmap._diagram.findLinkForData(linkLine.getJsData());var intfInfoSrc=linkLine.getIntfInfoSrc();if(intfInfoSrc&&intfInfoSrc.intf&&intfInfoSrc.intf){intfInfo1.intf=intfInfo1.intf||{};intfInfo1.intf.intfNodeData=intfInfoSrc.intf.intfNodeData}linkLine.setIntfInfoSrc(intfInfo1);linkLine.setViewInfosSrc(dataViewInfo);willUpdateLinks.push(linkObj.data)}else{var linkObj1=netmap._diagram.findLinkForData(linkLine.getJsData());var intfInfoDest=linkLine.getIntfInfoDest();if(intfInfoDest&&intfInfoDest.intf&&intfInfoDest.intf){intfInfo1.intf=intfInfo1.intf||{};intfInfo1.intf.intfNodeData=intfInfoDest.intf.intfNodeData}linkLine.setIntfInfoDest(intfInfo1);linkLine.setViewInfosDest(dataViewInfo);willUpdateLinks.push(linkObj1.data)}}}}}}}_.each(_.uniq(willUpdateLinks),(function(line){netmap._model.updateTargetBindings(line)}));netmap._diagram.commitTransaction(transactionName);netmap._diagram.undoManager.clear();diagram.skipsUndoManager=oldskips;if(bRefresh){netmap.refreshMapViewOptionVisible();setTimeout((function(){if(angular){angular.element(document).injector().get("nb.dataview.dataViewInfoMgr").notifyApplyDataViewListener(netmap,!0)}}),30)}}};DataViewApplyOp.prototype.doApplyDataViewsSegmentTemp=function(dataViewsSegment){if(null!==this._netmap&&null!==dataViewsSegment&&this.isDoable()){var netmap=this._netmap;var diagram=netmap._diagram;var oldskips=diagram.skipsUndoManager;var devId=null;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("doApplyDataViewsSegment");netmap._diagram.startTransaction(transactionName);var devDataViewSegmentList=dataViewsSegment.getDevDataViewSegmentList();if(null!==devDataViewSegmentList)for(var i=0;i<devDataViewSegmentList.length;i++){var devDataViewSegment=devDataViewSegmentList[i];if(null!==(devId=dataViewsSegment.getDevSegmentDevId(devDataViewSegment))){if(null!==netmap._getCompDeviceByKey(devId)){var newDevData=dataViewsSegment.getDevSegmentDevDataView(devDataViewSegment);if(null!==newDevData){var compNewDev=NgUtil.cloneJson(newDevData);netBrain.Map.CompPrototypeFactory.buildCompPrototype(compNewDev);netmap._switchViewFromDevice(compNewDev,!0)}}}}var intfDataViewSegmentList=dataViewsSegment.getIntfDataViewSegmentList();if(null!==intfDataViewSegmentList)for(var j=0;j<intfDataViewSegmentList.length;j++){var intfDataViewSegment=intfDataViewSegmentList[j];if(null!==(devId=dataViewsSegment.getIntfSegmentDevId(intfDataViewSegment))){var topoType=dataViewsSegment.getIntfSegmentIntfTopoType(intfDataViewSegment);if(null!==topoType){var intfId=dataViewsSegment.getIntfSegmentIntfKeyValue(intfDataViewSegment);if(null!==intfId){var output=netmap.getNetmapOperator()._getLinkLineByDevIdAndIntfId(topoType,devId,intfId);if(null!==output&&output.bResult){var linkLines=output.linkLines;for(var k=0;k<linkLines.length;k++){var bSrc=linkLines[k].bSrc;var linkLine=linkLines[k].linkLine;var dataViewInfo=dataViewsSegment.getIntfSegmentIntfDataViewInfo(intfDataViewSegment);var intfInfo=dataViewsSegment.getIntfSegmentIntfInfo(intfDataViewSegment);var linkObj=null;if(bSrc){linkObj=netmap._diagram.findLinkForData(linkLine.getJsData());linkLine.setIntfInfoSrc(intfInfo);linkLine.setViewInfosSrc(dataViewInfo);netmap._model.updateTargetBindings(linkObj.data)}else{linkObj=netmap._diagram.findLinkForData(linkLine.getJsData());linkLine.setIntfInfoDest(intfInfo);linkLine.setViewInfosDest(dataViewInfo);netmap._model.updateTargetBindings(linkObj.data)}}}}}}}netmap._diagram.commitTransaction(transactionName);netmap._diagram.undoManager.clear();diagram.skipsUndoManager=oldskips;netmap.refreshMapViewOptionVisible();setTimeout((function(){if(angular){angular.element(document).injector().get("nb.dataview.dataViewInfoMgr").notifyApplyDataViewListener(netmap,!0)}}),30)}};function notDefaultDataView(linkLine){var srcDataViewInfo=linkLine.getIntfSrc();var descDataViewInfo=linkLine.getIntfDest();return!isDefaultDataView(srcDataViewInfo)||!isDefaultDataView(descDataViewInfo)}function isDefaultDataView(dvInfo){return!dvInfo||!(!dvInfo.dataViewInfo||"dvDefault"!==dvInfo.dataViewInfo.dataViewType)}function formatDeviceHighlight(highlightItem){return NgUtil.cloneJson(highlightItem)}function formatInterfaceHighlight(highlightItem){return NgUtil.cloneJson(highlightItem)}function formatNote(noteItem){return DataViewHelper.formatNote(noteItem)}DataViewApplyOp.prototype.addIntfMergeNotes=function(key,intfInfo,cacheNotes){if(this._netmap){var netmapOperator=this._netmap.getNetmapOperator();if(netmapOperator){if(netmapOperator.getIntf(key,intfInfo.intf)){var intfNotes=[];_.each(intfInfo.intfNotes,(function(noteItem){var tmpNote=formatNote(noteItem);if(_.isArray(cacheNotes)){var findNote=cacheNotes.find((function(item){return item.noteTitle===noteItem.title}));findNote&&(tmpNote.location=findNote.location)}intfNotes.push(tmpNote)}));var waitingIntfNotes=netBrain.Map.noteTool.mergeDataViewNotesWithoutCompound(intfNotes);_.each(waitingIntfNotes,(function(note){netmapOperator.addIntfNoteRefDevice(key,intfInfo.intf,note)}))}}}};DataViewApplyOp.prototype.doApplyDataViewGroup=function(dvgId,devDVObjList,dataViewsSegment,isForceApply){if(null!==this._netmap&&null!==devDVObjList&&this.isDoable()){var self=this;var netmap=this._netmap;var diagram=netmap._diagram;var oldskips=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("doApplyDataViewGroup");netmap._diagram.startTransaction(transactionName);if(null===netmap._getAllDevices(!0))return!1;var netmapOperator=netmap.getNetmapOperator();var promises=[];var deviceDataViewCompoundNotes=[];for(var i=0,len=devDVObjList.length;i<len;i++)if(devDVObjList[i]&&devDVObjList[i].key){var key=devDVObjList[i].key;if(null!==key){var compDev=netmap._getCompDeviceByKey(key);if(null!==compDev&&(compDev.getDataViewGroupId()!==dvgId||isForceApply)){netmapOperator.removeDataViewNote([devDVObjList[i].key]);var compNewDev=NgUtil.cloneJson(devDVObjList[i]);netBrain.Map.CompPrototypeFactory.buildCompPrototype(compNewDev);_.each(compNewDev.dataViewData.intfInfoList,(function(item){item.intfNotes&&item.intfNotes.length>0&&self.addIntfMergeNotes(key,item);if(item.intfHighlightList&&item.intfHighlightList.length>0){item.intfHighlightList=_.map(item.intfHighlightList,(function(highlightItem){var hl=formatInterfaceHighlight(highlightItem);hl.devId=compNewDev.key;hl.topoType="L3_Topo_Type";return hl}));item.intfHighlightList=applyOverwrite(item.intfHighlightList);netmapOperator.drawLinkHighlightNew(item.intfHighlightList,item.intf)}}));if(compNewDev.dataViewData.deviceNotes&&compNewDev.dataViewData.deviceNotes.length>0){var deviceNotes=[];_.each(compNewDev.dataViewData.deviceNotes,(function(noteItem){deviceNotes.push(formatNote(noteItem))}));var waitingDeviceNotes=netBrain.Map.noteTool.mergeDataViewNotesWithoutCompound(deviceNotes);_.each(waitingDeviceNotes,(function(note){netmapOperator.addDeviceNoteRefDevice(key,note)}));var tmpCompoundNotes=_.filter(deviceNotes,(function(dn){return dn.isCompound}));deviceDataViewCompoundNotes.push({deviceId:key,notes:tmpCompoundNotes})}if(compNewDev.dataViewData.devHighlightList&&compNewDev.dataViewData.devHighlightList.length>0){compNewDev.dataViewData.devHighlightList=_.map(compNewDev.dataViewData.devHighlightList,(function(highlightItem){return formatDeviceHighlight(highlightItem)}));compNewDev.dataViewData.devHighlightList=applyOverwrite(compNewDev.dataViewData.devHighlightList)}var topoLinks=netmap._getTopoLinksByDevId(compDev.getKey());if(null!==topoLinks)for(var j=0;j<topoLinks.length;j++){var linkLine=topoLinks[j];this.replaceLinkLine(linkLine,compNewDev,promises)}netmap._switchViewFromDevice(compNewDev,isForceApply)}}}var waitingCompoundNotes=netBrain.Map.noteTool.mergeDataViewCompoundNotes(deviceDataViewCompoundNotes);_.each(waitingCompoundNotes,(function(noteInfo){var deviceIds=noteInfo.deviceIds;var note=noteInfo.note;var existNote=netmapOperator.getDeviceCompoundNoteByDeviceIdsAndTitle(deviceIds,note);existNote?netmapOperator.updateDeviceCompoundNote(existNote,deviceIds,note):netmapOperator.addDeviceCompoundNoteRefDevices(deviceIds,note)}));this._q.all(promises).then((function(){netmap.isDisplaySwitchMode()&&null!==dataViewsSegment&&dataViewsSegment.isValid()&&self.doApplyDataViewsSegment(dataViewsSegment,!1);netmap.reCalcLinks();netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction(transactionName);netmap._diagram.undoManager.clear();diagram.skipsUndoManager=oldskips;setTimeout((function(){if(angular){var dataViewInfoMgr=angular.element(document).injector().get("nb.dataview.dataViewInfoMgr");angular.element(document).injector().get("nb.runbook.actionTaskForDataViewSrvc").getLastDataViewGroup(netmap.getDocId()).then((function(d){if(d&&d.data){_.find(netmap.dataViewInfo.dataViewGroupInfos,(function(item){return item.ID===dvgId}))||netmap.dataViewInfo.dataViewGroupInfos.push(d.data)}dataViewInfoMgr.notifyListener(null,netmap);dataViewInfoMgr.notifyApplyDataViewListener(netmap)}))}}),30);netmap.setNetMapLegend();self.publishApplyDataViewEvent()}))}};function applyOverwrite(devHighlightList){var lastOverwriteIndex=_.findLastIndex(devHighlightList,(function(hl){return!hl.append}));return-1===lastOverwriteIndex?devHighlightList:devHighlightList.slice(lastOverwriteIndex)}DataViewApplyOp.prototype.applyDataViewGroup=function(dataViewCacheSrvc,dvgId,isForceApply,time){if(null!==dataViewCacheSrvc&&null!==dvgId&&null!==this._netmap){var devices=this._netmap._getAllDevices(!0);if(null!==devices){var deffered=null;null!==this._q&&(deffered=this._q.defer());var devIds=[];for(var i=0;i<devices.length;i++){var dev=devices[i];devIds.push(dev.getKey())}var promise=dataViewCacheSrvc.getDeviceDataViewsByDataViewGroupIdAndDevIds(null,dvgId,devIds,time);promise.context=this;promise.then((function(devDVObjList){var netmap=promise.context._netmap;if(netmap.isDisplaySwitchMode()){var dataViewsSegment=new DataViewsSegment;if(promise.context.filterDeviceAndInterfaceByDevDVObjList(devDVObjList,dataViewsSegment)&&dataViewsSegment.isValid()){var promiseInner=dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment,netmap);promiseInner.context=promise.context;promiseInner.dvgId=dvgId;promiseInner.dataViewsSegment=dataViewsSegment;promiseInner.devDVObjList=devDVObjList;promiseInner.then((function(dataViewsSegmentOut){if(null!==dataViewsSegmentOut){netmap.getNetmapOperator().removeDataViewNote();dataViewsSegmentOut.__proto__=new DataViewsSegment;promiseInner.context.doApplyDataViewGroup(promiseInner.dvgId,promiseInner.devDVObjList,dataViewsSegmentOut,isForceApply);null!==deffered&&deffered.resolve()}else null!==deffered&&deffered.resolve()}),(function(){null!==deffered&&deffered.reject("Failed call applyDataViewGroup.dataViewCacheSrvc.getDataViewsSegment")}))}else{promise.context.doApplyDataViewGroup(dvgId,devDVObjList,null,isForceApply);null!==deffered&&deffered.resolve()}}else{promise.context.doApplyDataViewGroup(dvgId,devDVObjList,null,isForceApply);null!==deffered&&deffered.resolve()}}),(function(){null!==deffered&&deffered.reject("The target devices included in the data view are not displayed on the map.")}));return null!==deffered?deffered.promise:void 0}}};DataViewApplyOp.prototype.applyDataViewGroupByAlog=function(dataViewCacheSrvc,dvgId,alogId,isForceApply,time){if(null!==dataViewCacheSrvc&&null!==dvgId&&null!==this._netmap){var devices=this._netmap._getAllDevices(!0);if(null!==devices){var deffered=null;null!==this._q&&(deffered=this._q.defer());var devIds=[];for(var i=0;i<devices.length;i++){var dev=devices[i];devIds.push(dev.getKey())}var promise=dataViewCacheSrvc.getDeviceDataViewsByAlogIdAndDevIds(null,dvgId,alogId,devIds,time);promise.context=this;promise.then((function(devDVObjList){var netmap=promise.context._netmap;if(netmap.isDisplaySwitchMode()){var dataViewsSegment=new DataViewsSegment;if(promise.context.filterDeviceAndInterfaceByDevDVObjList(devDVObjList,dataViewsSegment)&&dataViewsSegment.isValid()){var promiseInner=dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment,netmap);promiseInner.context=promise.context;promiseInner.dvgId=dvgId;promiseInner.dataViewsSegment=dataViewsSegment;promiseInner.devDVObjList=devDVObjList;promiseInner.then((function(dataViewsSegmentOut){if(null!==dataViewsSegmentOut){dataViewsSegmentOut.__proto__=new DataViewsSegment;promiseInner.context.doApplyDataViewGroup(promiseInner.dvgId,promiseInner.devDVObjList,dataViewsSegmentOut,isForceApply)}else null!==deffered&&deffered.resolve(dataViewsSegmentOut)}),(function(){null!==deffered&&deffered.reject("Failed call applyDataViewGroup.dataViewCacheSrvc.getDataViewsSegment")}))}else{promise.context.doApplyDataViewGroup(dvgId,devDVObjList,null,isForceApply);null!==deffered&&deffered.resolve(devDVObjList)}}else{promise.context.doApplyDataViewGroup(dvgId,devDVObjList,null,isForceApply);null!==deffered&&deffered.resolve(devDVObjList)}}),(function(){null!==deffered&&deffered.reject("The target devices included in the data view are not displayed on the map.")}));return null!==deffered?deffered.promise:void 0}}};DataViewApplyOp.prototype.filterDeviceAndInterfaceByDevDVObjList=function(devDVObjList,dataViewsSegment){if(null===this._netmap||null===devDVObjList||null===dataViewsSegment)return!1;var netmap=this._netmap;var bFind=!1;var dev=null;var devices=netmap._getAllDevices(!0);if(null===devices)return!1;for(var i=0;i<devices.length;i++){dev=devices[i];bFind=!1;for(var ii=0;ii<devDVObjList.length;ii++){var devDVObj=devDVObjList[ii];if(dev.getKey()===devDVObj.key){bFind=!0;break}}bFind||dataViewsSegment.addDev(dev.getKey(),null,null,dev.getDevNodeData())}var allTopolinks=netmap._getAllTopoLink();if(null===allTopolinks)return!1;for(var j=0;j<allTopolinks.length;j++){var currLink=allTopolinks[j];var topoType=currLink.getTopoType();if(null!==topoType){bFind=!1;var intfValueSrc=currLink.getIntfValueSrc();if(null!==intfValueSrc){for(var jj=0;jj<devDVObjList.length;jj++){(dev=devDVObjList[jj]).__proto__=new netBrain.Map.CompDevice;if(null!==dev.getIntfInfo(intfValueSrc)){bFind=!0;break}}if(!bFind){var from=currLink.getFromKey();var intfKeyObjSrc=currLink.getIntfKeyObjSrc();null!==from&&null!==intfKeyObjSrc&&intfKeyObjSrc.value&&dataViewsSegment.addIntf(from,intfKeyObjSrc,topoType)}}var intfValueDest=currLink.getIntfValueDest();if(null!==intfValueDest){bFind=!1;for(var kk=0;kk<devDVObjList.length;kk++){(dev=devDVObjList[kk]).__proto__=new netBrain.Map.CompDevice;if(null!==dev.getIntfInfo(intfValueDest)){bFind=!0;break}}if(!bFind){var to=currLink.getToKey();var intfKeyObjDest=currLink.getIntfKeyObjDest();null!==to&&null!==intfKeyObjDest&&intfKeyObjDest.value&&dataViewsSegment.addIntf(to,intfKeyObjDest,topoType)}}}}return!0};DataViewApplyOp.prototype.applyDataViewOnDevices=function(dataViewCacheSrvc,dvgId,devIds,isForceApply,isIgnoreOthers){if(null!==dataViewCacheSrvc&&null!==dvgId&&null!==devIds&&0!==devIds.length&&null!==this._netmap){var deffered=null;null!==this._q&&(deffered=this._q.defer());var promise=dataViewCacheSrvc.getDeviceDataViewsByDataViewGroupIdAndDevIds(null,dvgId,devIds);promise.context=this;promise.then((function(devDVObjList){var netmap=promise.context._netmap;if(!isIgnoreOthers&&netmap.isDisplaySwitchMode()){var dataViewsSegment=new DataViewsSegment;if(promise.context.filterDeviceAndInterfaceByDevDVObjList(devDVObjList,dataViewsSegment)&&dataViewsSegment.isValid()){var promiseInner=dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment,netmap);promiseInner.context=promise.context;promiseInner.dvgId=dvgId;promiseInner.dataViewsSegment=dataViewsSegment;promiseInner.devDVObjList=devDVObjList;promiseInner.then((function(dataViewsSegmentOut){if(null!==dataViewsSegmentOut){dataViewsSegmentOut.__proto__=new DataViewsSegment;promiseInner.context.doApplyDataViewGroup(promiseInner.dvgId,promiseInner.devDVObjList,dataViewsSegmentOut,isForceApply)}else null!==deffered&&deffered.resolve()}),(function(){null!==deffered&&deffered.reject("Failed call applyDataViewOnDevices.dataViewCacheSrvc.getDataViewsSegment")}))}else{promise.context.doApplyDataViewGroup(dvgId,devDVObjList,null,isForceApply);null!==deffered&&deffered.resolve()}}else{promise.context.doApplyDataViewGroup(dvgId,devDVObjList,null,isForceApply);null!==deffered&&deffered.resolve()}}),(function(e){if("The data is not found."===e)deffered.resolve();else{null!==deffered&&deffered.reject("Failed call applyDataViewOnDevices")}}));return null!==deffered?deffered.promise:void 0}};DataViewApplyOp.prototype.applyCompoundDataView=function(dataViewCacheSrvc,applyDataViewInfoObj){if(null!==dataViewCacheSrvc&&null!==applyDataViewInfoObj){var compoundDVId=applyDataViewInfoObj.getCompoundDataViewId();if(null!==compoundDVId){var dvgId=applyDataViewInfoObj.getSelectedDataViewId();if(null!==this._netmap){var devices=this._netmap._getAllDevices(!0);if(null!==devices){var deffered=null;null!==this._q&&(deffered=this._q.defer());var devIds=[];for(var i=0;i<devices.length;i++){var dev=devices[i];devIds.push(dev.getKey())}var promise=dataViewCacheSrvc.getExclusiveDeviceDataViewsByCompoundDVIdAndDevIds(null,compoundDVId,dvgId,devIds);promise.context=this;promise.then((function(devDVObjList){if(null!==devDVObjList&&!(devDVObjList.length<=0)){var netmap=promise.context._netmap;var dvgId;var devDVTemp=devDVObjList[0];devDVTemp.__proto__=new netBrain.Map.CompDevice;if(null!==(dvgId=devDVTemp.getDataViewGroupId()))if(netmap.isDisplaySwitchMode()){var dataViewsSegment=new DataViewsSegment;if(promise.context.filterDeviceAndInterfaceByDevDVObjList(devDVObjList,dataViewsSegment)&&dataViewsSegment.isValid()){var promiseInner=dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment,netmap);promiseInner.context=promise.context;promiseInner.dvgId=dvgId;promiseInner.dataViewsSegment=dataViewsSegment;promiseInner.devDVObjList=devDVObjList;promiseInner.then((function(dataViewsSegmentOut){if(null!==dataViewsSegmentOut){dataViewsSegmentOut.__proto__=new DataViewsSegment;promiseInner.context.doApplyDataViewGroup(promiseInner.dvgId,promiseInner.devDVObjList,dataViewsSegmentOut)}else null!==deffered&&deffered.resolve()}),(function(){null!==deffered&&deffered.reject("Failed call applyCompoundDataView.")}))}else{promise.context.doApplyDataViewGroup(dvgId,devDVObjList);null!==deffered&&deffered.resolve()}}else{promise.context.doApplyDataViewGroup(dvgId,devDVObjList);null!==deffered&&deffered.resolve()}}}),(function(){null!==deffered&&deffered.reject("Failed call applyCompoundDataView")}));return null!==deffered?deffered.promise:void 0}}}}};DataViewApplyOp.prototype.resetDefaultDataView=function(dataViewCacheSrvc){if(null===dataViewCacheSrvc)return null;if(null===this._netmap)return null;var netmap=this._netmap;var netmapOperator=netmap.getNetmapOperator();var jsWrapper=netmap.getNetMapJsWrapper();var defaultData=jsWrapper.getDefaultExtendData();jsWrapper.setExtendData(defaultData);var dataViewsSegment=new DataViewsSegment;var devices=netmap._getAllDevices(!0);if(null===devices)return null;var deffered=null;null!==this._q&&(deffered=this._q.defer());for(var i=0;i<devices.length;i++){var dev=devices[i];var devNodeData=NgUtil.cloneJson(dev.getDevNodeData());devNodeData&&(devNodeData.visualSpaceInfo=netmap.getVisualSpaceInfo());dataViewsSegment.addDev(dev.getKey(),null,null,devNodeData)}var allTopolinks=netmap._getAllTopoLink();for(i=0;i<allTopolinks.length;i++){var currLink=allTopolinks[i];var topoType=currLink.getTopoType();if(null!==topoType){var from=currLink.getFromKey();var intfKeyObjSrc=currLink.getIntfKeyObjSrc();if(null!==from&&null!==intfKeyObjSrc&&intfKeyObjSrc.value){(intfNodeData=NgUtil.cloneJson(currLink.getIntfNodeDataSrc()))&&(intfNodeData.visualSpaceInfo=netmap.getVisualSpaceInfo());dataViewsSegment.addIntf(from,intfKeyObjSrc,topoType,intfNodeData)}var to=currLink.getToKey();var intfKeyObjDest=currLink.getIntfKeyObjDest();if(null!==to&&null!==intfKeyObjDest&&intfKeyObjDest.value){var intfNodeData;(intfNodeData=NgUtil.cloneJson(currLink.getIntfNodeDataDest()))&&(intfNodeData.visualSpaceInfo=netmap.getVisualSpaceInfo());dataViewsSegment.addIntf(to,intfKeyObjDest,topoType,intfNodeData)}}}netmapOperator.removeDataViewNote();var promise=dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment,netmap);promise.context=this;promise.then((function(dataViewsSegmentOut){if(null!==dataViewsSegmentOut){dataViewsSegmentOut.__proto__=new DataViewsSegment;promise.context.doApplyDataViewsSegment(dataViewsSegmentOut,!0);netmap.setNetMapLegend();null!==deffered&&deffered.resolve()}else null!==deffered&&deffered.resolve()}),(function(){null!==deffered&&deffered.reject("Failed call resetDefaultDataView")}));return null!==deffered?deffered.promise:void 0};function setLinkToDefault(devId,that,intfInfoKey,fromKey,toKey,isFrom){var deffered=null;null!==that._q&&(deffered=that._q.defer());var netmap=that._netmap;var dataViewsSegment=new DataViewsSegment;var allTopolinks=netmap._getAllTopoLink();for(var i=0;i<allTopolinks.length;i++){var currLink=allTopolinks[i];var topoType=currLink.getTopoType();if(null!==topoType){var from=currLink.getFromKey();var to=currLink.getToKey();try{if(from===fromKey&&to===toKey&&currLink.intfDest&&currLink.intfDest.intfInfo.intf.intfKeyObj.value===intfInfoKey||from===fromKey&&to===toKey&&currLink.intfSrc&&currLink.intfSrc.intfInfo.intf.intfKeyObj.value===intfInfoKey)if(isFrom){var intfKeyObjSrc=currLink.getIntfKeyObjSrc();if(null!==from&&null!==intfKeyObjSrc&&intfKeyObjSrc.value){(intfNodeData=NgUtil.cloneJson(currLink.getIntfNodeDataSrc()))&&(intfNodeData.visualSpaceInfo=netmap.getVisualSpaceInfo());dataViewsSegment.addIntf(from,intfKeyObjSrc,topoType,intfNodeData)}}else{var intfKeyObjDest=currLink.getIntfKeyObjDest();if(null!=to&&null!=intfKeyObjDest&&intfKeyObjDest.value){var intfNodeData;(intfNodeData=NgUtil.cloneJson(currLink.getIntfNodeDataDest()))&&(intfNodeData.visualSpaceInfo=netmap.getVisualSpaceInfo());dataViewsSegment.addIntf(to,intfKeyObjDest,topoType,intfNodeData)}}}catch(err){console.log(err)}}}var promise=angular.element(document).injector().get("nb.netbrain.dataViewCacheSrvc").getDataViewsSegment(null,dataViewsSegment,netmap);promise.context=that;return promise.then((function(dataViewsSegmentOut){if(null!==dataViewsSegmentOut){dataViewsSegmentOut.__proto__=new DataViewsSegment;promise.context.doApplyDataViewsSegment(dataViewsSegmentOut,!1);null!==deffered&&deffered.resolve()}else null!==deffered&&deffered.resolve()}),(function(){null!==deffered&&deffered.reject("Failed call resetDefaultDataView")}))}DataViewApplyOp.prototype.resetDefaultDataViewByDeviceIds=function(dataViewCacheSrvc,forDeviceIds){if(null===dataViewCacheSrvc)return null;if(null===this._netmap)return null;var netmap=this._netmap;var netmapOperator=netmap.getNetmapOperator();var dataViewsSegment=new DataViewsSegment;var devices=netmap._getAllDevices(!0);if(null===devices)return null;var deffered=null;null!==this._q&&(deffered=this._q.defer());for(var j=0;j<devices.length;j++){var dev=devices[j];dataViewsSegment.addDev(dev.getKey(),null,null,dev.getDevNodeData())}var allTopolinks=netmap._getAllTopoLink();for(var i=0;i<allTopolinks.length;i++){var currLink=allTopolinks[i];var topoType=currLink.getTopoType();if(null!==topoType){var from=currLink.getFromKey();var intfKeyObjSrc=currLink.getIntfKeyObjSrc();null!==from&&null!==intfKeyObjSrc&&intfKeyObjSrc.value&&dataViewsSegment.addIntf(from,intfKeyObjSrc,topoType);var to=currLink.getToKey();var intfKeyObjDest=currLink.getIntfKeyObjDest();null!==to&&null!==intfKeyObjDest&&intfKeyObjDest.value&&dataViewsSegment.addIntf(to,intfKeyObjDest,topoType)}}if(forDeviceIds){dataViewsSegment.devDataViewSegmentList=_.filter(dataViewsSegment.devDataViewSegmentList,(function(item){return forDeviceIds.indexOf(item.devId)>-1}));dataViewsSegment.intfDataViewSegmentList=_.filter(dataViewsSegment.intfDataViewSegmentList,(function(item){return forDeviceIds.indexOf(item.devId)>-1}));netmapOperator.removeDataViewNote(forDeviceIds)}else netmapOperator.removeDataViewNote();var promise=dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment,netmap);promise.context=this;promise.then((function(dataViewsSegmentOut){if(null!==dataViewsSegmentOut){dataViewsSegmentOut.__proto__=new DataViewsSegment;promise.context.doApplyDataViewsSegment(dataViewsSegmentOut,!0);null!==deffered&&deffered.resolve()}else null!==deffered&&deffered.resolve()}),(function(){null!==deffered&&deffered.reject("Failed call resetDefaultDataView")}));return null!==deffered?deffered.promise:void 0};DataViewApplyOp.prototype.publishApplyDataViewEvent=function(){var rootScope=this.getRootScope();if(null!==rootScope&&null!==this._netmap){var netmap=this._netmap;netmap.setModify(!0);rootScope.$emit(applyDataViewEvent.applyDataView,{docId:netmap.getDocId(),applyDataViewInfo:netmap.getApplyDataViewInfo()})}};DataViewApplyOp.prototype.removeIntfNotes=function(key){return null===this._netmap?null:this._netmap.getNetmapOperator().removeDataViewNote([key],!0)};DataViewApplyOp.prototype.addIntfNotes=function(key,intfInfo,noteItems,cacheNote){if(null===this._netmap||!noteItems)return null;var netmapOperator=this._netmap.getNetmapOperator();netmapOperator.getIntf(key,intfInfo.intf)&&_.each(noteItems,(function(noteItem){var newFormatNote=formatNote(noteItem);if(cacheNote){var findNote=cacheNote.find((function(item){return item.noteTitle===noteItem.title}));findNote&&(newFormatNote.location=findNote.location)}netmapOperator.addIntfNoteRefDevice(key,intfInfo.intf,newFormatNote)}))};DataViewApplyOp.prototype.addDeviceNotes=function(key,noteItems){if(null===this._netmap)return null;var netmapOperator=this._netmap.getNetmapOperator();_.each(noteItems,(function(noteItem){netmapOperator.addDeviceNoteRefDevice(key,formatNote(noteItem))}))};netBrain.Map=netBrain.Map||{};netBrain.Map.DataViewApplyOp=DataViewApplyOp}(NetBrain);!function(netBrain){var DataViewApplyReadonlyOp=function(){netBrain.Map.DataViewApplyOp.call(this)};(DataViewApplyReadonlyOp.prototype=new netBrain.Map.DataViewApplyOp).isDoable=function(){return!1};netBrain.Map=netBrain.Map||{};netBrain.Map.DataViewApplyReadonlyOp=DataViewApplyReadonlyOp}(NetBrain);!function(netBrain){var DataViewApplyStandardOp=function(){netBrain.Map.DataViewApplyOp.call(this)};DataViewApplyStandardOp.prototype=new netBrain.Map.DataViewApplyOp;netBrain.Map=netBrain.Map||{};netBrain.Map.DataViewApplyStandardOp=DataViewApplyStandardOp}(NetBrain);!function(netBrain){var ExtendNbrOp=function(){netBrain.Map.AbstractOp.call(this)};(ExtendNbrOp.prototype=new netBrain.Map.AbstractOp)._getCompMedia=function(mediaInfo,objcategory){if(null==mediaInfo)return null;var tempNbrInfo=new CNeighborInfo(null,null,null,null,mediaInfo.topoType,null,mediaInfo.mediaId,{mediaName:mediaInfo.mediaName,mediaType:mediaInfo.mediaType});objcategory=netBrain.Map.CategoryMgr.Media;var compMedia=new netBrain.Map.CompMedia(objcategory).CreateMeidaJsonDataByNbrInfo(tempNbrInfo);if(null==compMedia)return null;netBrain.Map.CompPrototypeFactory.buildCompPrototype(compMedia);return compMedia},ExtendNbrOp.prototype._getCompDevice=function(dataView,id,name,devType){var compDevice=null;if(null!=dataView){compDevice=dataView;netBrain.Map.CompPrototypeFactory.buildCompPrototype(compDevice)}else{if(1004===devType){(compDevice=netBrain.Map.CompDevice.getDefaultJsonData()).devType=1004;compDevice.devCategory=1004}else compDevice=netBrain.Map.CompUnknownIp.getDefaultJson();var netmap=this.getNetmap();if(netmap){var qmap=netmap.getParentQmap();if(qmap){var iconInfo=qmap.getDefaultIconByDevType(devType);var imgList0=NgUtil.getValueFromObjAndPath(compDevice,"dataViewData.devGraphicInfo.imageList.0");if(iconInfo&&imgList0){imgList0.name=iconInfo.name;imgList0.scale=iconInfo.scale;imgList0.size=iconInfo.size}}}netBrain.Map.CompPrototypeFactory.buildCompPrototype(compDevice);compDevice.setKey(id);compDevice.setHostname(name)}return compDevice};ExtendNbrOp.prototype._getCompSite=function(sitePropertie){var compSite=netBrain.Map.CompSite.getJson(sitePropertie.siteCategory);netBrain.Map.CompPrototypeFactory.buildCompPrototype(compSite);compSite.setDisplayName(sitePropertie.name);compSite.setKey(sitePropertie.ID);compSite.setSiteCategory(sitePropertie.siteCategory);compSite.setDeviceCount(sitePropertie.deviceCount);return compSite};ExtendNbrOp.prototype._getIntfDataView=function(id,intf,topoTypeId,dataViewsSegment){if(null==id||null==intf||null==topoTypeId||null==dataViewsSegment)return null;var intfDataViewSegment=dataViewsSegment.getIntfSegmentIntfDataViewSegment(id,intf.intfKeyObj,topoTypeId);var intfDataView=dataViewsSegment.getIntfSegmentIntfDataView(intfDataViewSegment);null==intfDataView&&(intfDataView={dataViewInfo:{dataViewGroupId:"",dataViewTaskInfoId:"",name:"",dataViewType:DataViewType.dvDefault,dataViewDefinitionId:""},intfInfo:{intf:intf,intfPosList:[{posName:DataViewPosName.intfPos0,posInfo:{dataUnitList:[{displayName:"",type:DataUnitSourceType.uSrcGDR,uId:intf.intfDisplaySchemaObj.schema,value:intf.intfDisplaySchemaObj.value,valueType:DataUnitType.uString,unit:"",perfix:"",valueExpr:""}],displayTemplate:"",displayInfo:intf.intfDisplaySchemaObj.value,isCustomize:!1,isLock:!1}}]}});return intfDataView};ExtendNbrOp.prototype.extendMediaNeighbor=function(nbrInfo,tempNbrInfo,dataViewsSegment,addedNodeKeys,addedDevcieNodeKeys,linkLines){var netmap=this._netmap;if(null==netmap||null==nbrInfo||null==dataViewsSegment)return!1;var bReComputeDataViewType=!1;var destDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbrInfo.nbrId);var destCompDev=this._getCompDevice(destDevDataView,nbrInfo.nbrId,nbrInfo.nbrName);if(null==destCompDev)return!1;destCompDev.devNodeData=destCompDev.devNodeData?destCompDev.devNodeData:nbrInfo.nbrDevNodeData;var destDevJsonObj=destCompDev.getJsData();var compMedia=null;if(!netmap.getNetmapOperator()._isNeatUpMedia(tempNbrInfo.getNeat())&&null!=(compMedia=netmap.getNetmapOperator()._buildCompMediaByInfo(tempNbrInfo.getMediaName(),tempNbrInfo.getMedia(),tempNbrInfo.getMediaType(),tempNbrInfo.getMediaTopoType()))&&null==netmap._model.findNodeDataForKey(compMedia.getKey())){netmap._addNode(compMedia);null!=compMedia.key&&addedNodeKeys.push(compMedia.key);bReComputeDataViewType=!0}if(null==netmap._model.findNodeDataForKey(destDevJsonObj.getKey())){netmap.getNetmapOperator().addDevice(destCompDev);if(null!=destCompDev.key){addedNodeKeys.push(destCompDev.key);addedDevcieNodeKeys.push(destCompDev.key)}bReComputeDataViewType=!0}var tmpLinkLines=[];netmap.getNetmapOperator()._buildLinkLineByNbrInfo(destCompDev,compMedia,tempNbrInfo,tmpLinkLines);netmap.getNetmapOperator().removelogicLinkExisted(tempNbrInfo);for(var k in tmpLinkLines)if(tmpLinkLines.hasOwnProperty(k)){linkLines.push(tmpLinkLines[k]);bReComputeDataViewType=!0}return bReComputeDataViewType};ExtendNbrOp.prototype.addBoardlinkOnDiagram=function(site,dataViewsSegment,devices,text){if(null!=site){var srcCompDev=this._getCompSite(site);var netmap=this._netmap;var addedNodeKeys=[];var bReComputeDataViewType=!1;var transactionName=NgUtil.getUniqueStr("addBoardlinkOnDiagram");netmap._diagram.startTransaction(transactionName);for(var i in devices)if(devices.hasOwnProperty(i)){var device=devices[i];var destDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(device.id);var destCompDev=this._getCompDevice(destDevDataView);if(null==destCompDev)continue;if(null==netmap._model.findNodeDataForKey(destCompDev.getKey())){netmap.getNetmapOperator().addDevice(destCompDev);null!=destCompDev.key&&addedNodeKeys.push(destCompDev.key);bReComputeDataViewType=!0}if(null==netmap._model.findNodeDataForKey(srcCompDev.getKey())){netmap.getNetmapOperator().addDevice(srcCompDev);null!=srcCompDev.key&&addedNodeKeys.push(srcCompDev.key);bReComputeDataViewType=!0}var data={from:srcCompDev.key,to:destCompDev.key,text:text};netmap.getNetmapOperator().addSiteBorderLink(data)}bReComputeDataViewType&&netmap.refreshMapViewOptionVisible();new netBrain.Map.LayoutToolsHelper(netmap.getNetmapOperator()).extendNeighborLayout({newNodes:addedNodeKeys});(new netBrain.Map.LinkLableLayoutTool).LayOut(netmap._diagram);netmap._diagram.commitTransaction(transactionName);netmap._diagram.clearSelection();var netmapOperator=netmap.getNetmapOperator();null!=netmapOperator&&netmapOperator.selectNodes(addedNodeKeys)}},ExtendNbrOp.prototype.checkDevice=function(compDevice,addedDevcieKeys){var devKey=compDevice.getKey();if(-1===addedDevcieKeys.indexOf(devKey)){this._netmap.getNetmapOperator().highlightNode(compDevice)}};ExtendNbrOp.prototype.extendOnDiagram=function(nbrInfoList,dataViewsSegment,onlyExtendToMedia,isNew,isFromExtendDiaglo){var addedNodeKeys=[];var addedDevcieNodeKeys=[];var netmap=this._netmap;var bReComputeDataViewType=!1;var transactionName=NgUtil.getUniqueStr("extend neighbors");netmap._diagram.startTransaction(transactionName);var requireCheckDevice=[];var newAddLinks=[];for(var i in nbrInfoList)if(nbrInfoList.hasOwnProperty(i)){var nbrInfo=nbrInfoList[i];var tempNbrInfo=new CNeighborInfo(nbrInfo.id,nbrInfo.nbrId,nbrInfo.intf,nbrInfo.nbrIntf,nbrInfo.topoTypeId,nbrInfo.isP2P,nbrInfo.mediaId,nbrInfo.mediaInfo);tempNbrInfo.setSrcIntfDataView(this._getIntfDataView(nbrInfo.id,nbrInfo.intf,nbrInfo.topoTypeId,dataViewsSegment));tempNbrInfo.setDestIntfDataView(this._getIntfDataView(nbrInfo.nbrId,nbrInfo.nbrIntf,nbrInfo.topoTypeId,dataViewsSegment));tempNbrInfo.setSrcDevId(nbrInfo.devId);tempNbrInfo.setDestDevId(nbrInfo.nbrDevId);if(netBrain.Map.gMediaTypeMgr.isMuteLanType(tempNbrInfo.getMediaType())||nbrInfo.mediaId===nbrInfo.nbrDevId||nbrInfo.devId===nbrInfo.nbrDevId){var linkLines=[];if(this.extendMuteLanNeighbor(tempNbrInfo,dataViewsSegment,addedNodeKeys,addedDevcieNodeKeys,linkLines)){_.each(linkLines,(function(link){!0===netmap.getNetmapOperator().addLinkLine(link)&&newAddLinks.push(link)}));bReComputeDataViewType=!0}continue}if(!nbrInfo.id){linkLines=[];if(this.extendMediaNeighbor(nbrInfo,tempNbrInfo,dataViewsSegment,addedNodeKeys,addedDevcieNodeKeys,linkLines)){_.each(linkLines,(function(link){!0===netmap.getNetmapOperator().addLinkLine(link)&&newAddLinks.push(link)}));bReComputeDataViewType=!0}continue}if(!nbrInfo.nbrId)continue;var srcDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbrInfo.id);var destDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbrInfo.nbrId);var srcCompDev=this._getCompDevice(srcDevDataView,nbrInfo.id,nbrInfo.name,nbrInfo.devType);var destCompDev=this._getCompDevice(destDevDataView,nbrInfo.nbrId,nbrInfo.nbrName,nbrInfo.nbrDevType);if(null==srcCompDev)continue;if(null==destCompDev)continue;var srcDevKey=srcCompDev.getKey();if(netmap._model.findNodeDataForKey(srcDevKey))isFromExtendDiaglo||requireCheckDevice.push(srcCompDev);else{netmap.getNetmapOperator().addDevice(srcCompDev);if(null!=srcCompDev.key){addedNodeKeys.push(srcCompDev.key);addedDevcieNodeKeys.push(srcCompDev.key)}}var destDevJsonObj=destCompDev.getJsData();if(nbrInfo.isP2P){if(null==netmap._model.findNodeDataForKey(destDevJsonObj.getKey())){netmap.getNetmapOperator().addDevice(destCompDev);if(null!=destCompDev.key){addedNodeKeys.push(destCompDev.key);addedDevcieNodeKeys.push(destCompDev.key)}bReComputeDataViewType=!0}else requireCheckDevice.push(destCompDev);linkLines=[];netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);for(var k in linkLines)if(linkLines.hasOwnProperty(k)){!0===netmap.getNetmapOperator().addLinkLine(linkLines[k])&&newAddLinks.push(linkLines[k]);bReComputeDataViewType=!0}}else{var bSrcDevMedia=netBrain.Map.gMediaTypeMgr.isMediaType(srcCompDev.getDevType());var bDestDevMedia=netBrain.Map.gMediaTypeMgr.isMediaType(destCompDev.getDevType());if(bSrcDevMedia||bDestDevMedia){linkLines=[];netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);for(var h in linkLines)if(linkLines.hasOwnProperty(h)){!0===netmap.getNetmapOperator().addLinkLine(linkLines[h])&&newAddLinks.push(linkLines[h]);bReComputeDataViewType=!0}}else{var compMedia=null;if(!netmap.getNetmapOperator()._isNeatUpMedia(tempNbrInfo.getNeat())&&null!=(compMedia=netmap.getNetmapOperator()._buildCompMediaByInfo(tempNbrInfo.getMediaName(),tempNbrInfo.getMedia(),tempNbrInfo.getMediaType(),tempNbrInfo.getMediaTopoType()))&&null==netmap._model.findNodeDataForKey(compMedia.getKey())){netmap._addNode(compMedia);null!=compMedia.key&&addedNodeKeys.push(compMedia.key);bReComputeDataViewType=!0}if(null!=netmap._model.findNodeDataForKey(destDevJsonObj.getKey())||onlyExtendToMedia)requireCheckDevice.push(destCompDev);else{netmap.getNetmapOperator().addDevice(destCompDev);if(null!=destCompDev.key){addedNodeKeys.push(destCompDev.key);addedDevcieNodeKeys.push(destCompDev.key)}bReComputeDataViewType=!0}linkLines=[];netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);for(var j in linkLines)if(!onlyExtendToMedia||destCompDev.key!==linkLines[j].from){!0===netmap.getNetmapOperator().addLinkLine(linkLines[j])&&newAddLinks.push(linkLines[j]);bReComputeDataViewType=!0}}}}this.afterExtendOnDiagram(netmap,newAddLinks,bReComputeDataViewType,addedNodeKeys,transactionName,addedDevcieNodeKeys,requireCheckDevice)};ExtendNbrOp.prototype.extendOnDiagram2=function(nbrInfoList,dataViewsSegment,onlyExtendToMedia,isNew,isFromExtendDiaglo){var addedNodeKeys=[];var addedDevcieNodeKeys=[];var netmap=this._netmap;var transactionName=NgUtil.getUniqueStr("extend neighbors");netmap._diagram.startTransaction(transactionName);var linkLines=[];var requireCheckDevice=[];for(var i in nbrInfoList){(tempNbrInfo=new CNeighborInfo((nbrInfo=nbrInfoList[i]).id,nbrInfo.nbrId,nbrInfo.intf,nbrInfo.nbrIntf,nbrInfo.topoTypeId,nbrInfo.isP2P,nbrInfo.mediaId,nbrInfo.mediaInfo)).setSrcIntfDataView(this._getIntfDataView(nbrInfo.id,nbrInfo.intf,nbrInfo.topoTypeId,dataViewsSegment));tempNbrInfo.setDestIntfDataView(this._getIntfDataView(nbrInfo.nbrId,nbrInfo.nbrIntf,nbrInfo.topoTypeId,dataViewsSegment));tempNbrInfo.setSrcDevId(nbrInfo.devId);tempNbrInfo.setDestDevId(nbrInfo.nbrDevId);tempNbrInfo.setCategory(nbrInfo.category);if(netmap.getIsNeatUp()&&nbrInfo.mediaInfo&&nbrInfo.mediaInfo.neat||nbrInfo.isP2P){if(!nbrInfo.id){this.extendMediaNeighbor(nbrInfo,tempNbrInfo,dataViewsSegment,addedNodeKeys,addedDevcieNodeKeys,linkLines);continue}if(!nbrInfo.nbrId)continue;var srcDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbrInfo.id);var destDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbrInfo.nbrId);var srcCompDev=this._getCompDevice(srcDevDataView,nbrInfo.id,nbrInfo.name);var destCompDev=this._getCompDevice(destDevDataView,nbrInfo.nbrId,nbrInfo.nbrName);if(null==srcCompDev)continue;if(null==destCompDev)continue;var srcDevKey=srcCompDev.getKey();if(netmap._model.findNodeDataForKey(srcDevKey))isFromExtendDiaglo||requireCheckDevice.push(srcCompDev);else{netmap.getNetmapOperator().addDevice(srcCompDev);if(null!=srcCompDev.key){addedNodeKeys.push(srcCompDev.key);addedDevcieNodeKeys.push(srcCompDev.key)}}var destDevJsonObj=destCompDev.getJsData();if(null==netmap._model.findNodeDataForKey(destDevJsonObj.getKey())){netmap.getNetmapOperator().addDevice(destCompDev);if(null!=destCompDev.key){addedNodeKeys.push(destCompDev.key);addedDevcieNodeKeys.push(destCompDev.key)}}else requireCheckDevice.push(destCompDev);netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines)}else nbrInfo.isP2P||this.extendMuteLanNeighbor(tempNbrInfo,dataViewsSegment,addedNodeKeys,addedDevcieNodeKeys,linkLines)}for(var i in nbrInfoList){var nbrInfo;var tempNbrInfo=new CNeighborInfo((nbrInfo=nbrInfoList[i]).id,nbrInfo.nbrId,nbrInfo.intf,nbrInfo.nbrIntf,nbrInfo.topoTypeId,nbrInfo.isP2P,nbrInfo.mediaId,nbrInfo.mediaInfo,null,null,null,null,nbrInfo.inPortChannel);netmap.getNetmapOperator().removelogicLinkExisted(tempNbrInfo)}var newAddLinks=netmap.getNetmapOperator().addLinkLines(linkLines);!0;this.afterExtendOnDiagram(netmap,newAddLinks,!0,addedNodeKeys,transactionName,addedDevcieNodeKeys,requireCheckDevice)};ExtendNbrOp.prototype.afterExtendOnDiagram=function(netmap,newAddLinks,bReComputeDataViewType,addedNodeKeys,transactionName,addedDevcieNodeKeys,requireCheckDevice){netmap.calcUnknownEndSystemPolicyAfterAddLinks(newAddLinks);bReComputeDataViewType&&netmap.refreshMapViewOptionVisible();var diagram=netmap._diagram;new netBrain.Map.LayoutToolsHelper(netmap.getNetmapOperator()).extendNeighborLayout({newNodes:addedNodeKeys});if(netmap.isL2MapStyle()){var diagramNodes=netmap.getGoJsDiagram().nodes;netBrain.L2Improvements.l2ImprovementsHelper.alignNodes(diagramNodes)}diagram.updateAllTargetBindings();if(netmap.isL2MapStyle()){var portInfos=netBrain.Map.L2PortsLayoutTool.getAllPortsInfoByDeviceKeysAndLinkInfos(addedNodeKeys,newAddLinks,diagram);netmap.layoutL2Ports(portInfos)}(new netBrain.Map.LinkLableLayoutTool).LayOut(diagram);netmap.removeAllLinkHighlightFlag();netmap._diagram.commitTransaction(transactionName);netmap._diagram.clearSelection();var netmapOperator=netmap.getNetmapOperator();null!=netmapOperator&&netmapOperator.selectNodes(addedDevcieNodeKeys);for(var k in requireCheckDevice)this.checkDevice(requireCheckDevice[k],addedDevcieNodeKeys);return addedDevcieNodeKeys};ExtendNbrOp.prototype.extendMuteLanNeighbor=function(tempNbrInfo,dataViewsSegment,addedNodeKeys,addedDevcieNodeKeys,linkLines){if(null==tempNbrInfo||null==dataViewsSegment)return!1;if(!this.isDoable())return!1;var bReComputeDataViewType=!1;var fromKey=tempNbrInfo.getFromKey();var toKey=tempNbrInfo.getToKey();if(null==fromKey&&null==toKey)return!1;if(null==this._netmap)return!1;var netmap=this._netmap;var compRealDev=null;if(null!=fromKey){var srcDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(fromKey);srcDevDataView||(srcDevDataView=netmap._getCompDeviceByKey(fromKey));compRealDev=this._getCompDevice(srcDevDataView)}else if(null!=toKey){var destDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(toKey);destDevDataView||(destDevDataView=netmap._getCompDeviceByKey(fromKey));compRealDev=this._getCompDevice(destDevDataView)}if(null==compRealDev)return!1;var compMedia=netmap.getNetmapOperator()._buildCompMediaByInfo(tempNbrInfo.getMediaName(),tempNbrInfo.getMedia(),tempNbrInfo.getMediaType(),tempNbrInfo.getMediaTopoType());if(null!=compMedia){var devKey=compRealDev.getJsData().getKey();if(!netmap._model.findNodeDataForKey(devKey)){netmap.getNetmapOperator().addDevice(compRealDev);if(null!=compRealDev.key){addedNodeKeys.push(compRealDev.key);addedDevcieNodeKeys.push(compRealDev.key)}}if(null==netmap._model.findNodeDataForKey(compMedia.getKey())){netmap._addNode(compMedia);null!=compMedia.key&&null!=addedNodeKeys&&addedNodeKeys.push(compMedia.key);bReComputeDataViewType=!0}var tmpLinkLines=[];netmap.getNetmapOperator()._buildLinkLineByNbrInfo(compRealDev,compMedia,tempNbrInfo,tmpLinkLines);for(var k in tmpLinkLines){linkLines.push(tmpLinkLines[k]);bReComputeDataViewType=!0}return bReComputeDataViewType}};ExtendNbrOp.prototype.extendNeighbors=function(nbrInfoList,onlyExtendToMedia,isNew,isNewNbrConstruction){if(null==nbrInfoList||0===nbrInfoList.length)return null;if(!this.isDoable())return null;if(null==this._netmap)return null;var netmap=this._netmap;var dataViewsSegment=new DataViewsSegment;for(var i in nbrInfoList){var info=nbrInfoList[i];dataViewsSegment.addDev(info.id,null,null,info.devNodeData);null!=info.intf&&null!=info.intf.intfKeyObj&&dataViewsSegment.addIntf(info.id,info.intf.intfKeyObj,info.topoTypeId,info.intf.intfNodeData);dataViewsSegment.addDev(info.nbrId,null,null,info.nbrDevNodeData);null!=info.nbrIntf&&null!=info.nbrIntf.intfKeyObj&&dataViewsSegment.addIntf(info.nbrId,info.nbrIntf.intfKeyObj,info.topoTypeId,info.nbrIntf.intfNodeData);dataViewsSegment.addDev(info.mediaId)}var context=this;return angular.element(document).injector().get("nb.netbrain.dataViewCacheSrvc").getDataViewsSegment(null,dataViewsSegment).then((function(dataViewsSegmentOut){if(null!=dataViewsSegmentOut){Object.setPrototypeOf(dataViewsSegmentOut,new DataViewsSegment);isNewNbrConstruction?context.extendOnDiagram2(nbrInfoList,dataViewsSegmentOut,onlyExtendToMedia,isNew,!0):context.extendOnDiagram(nbrInfoList,dataViewsSegmentOut,onlyExtendToMedia,isNew,!0);var applyDataViewSrvc=angular.element(document).injector().get("nb.dataview.applyDataViewSrvc");var devIds=[];_.each(nbrInfoList,(function(item){devIds.push(item.devId);devIds.push(item.nbrDevId)}));applyDataViewSrvc.applyDataviewsOnDevices(devIds,null,netmap,!1,!0);netmap.refreshMapViewOptionVisible();netmap.setNetMapLegend()}}),(function(){throw new Error("get data views failed!")}))};ExtendNbrOp.prototype.doAddBoardlinkOnDiagram=function(dataViewCacheSrvc,site,deviceInfoList,text){if(null==deviceInfoList||0===deviceInfoList.length)return null;if(!this.isDoable())return null;if(null==this._netmap)return null;var dataViewsSegment=new DataViewsSegment;for(var i in deviceInfoList){var info=deviceInfoList[i];dataViewsSegment.addDev(info.id,null,null,info.devNodeData)}var context=this;var promise=dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment);promise.then((function(dataViewsSegmentOut){if(null!=dataViewsSegmentOut){Object.setPrototypeOf(dataViewsSegmentOut,new DataViewsSegment);context.addBoardlinkOnDiagram(site,dataViewsSegmentOut,deviceInfoList,text)}}),(function(){throw new Error("get data views failed!")}));return promise};ExtendNbrOp.prototype.extendNeighborsWithDataViewsSegment=function(nbrInfoList,dataViewsSegment,onlyExtendToMedia,isNew,applyDataViewSrvc){if(null!=nbrInfoList&&null!=dataViewsSegment){var netmap=this._netmap;Object.setPrototypeOf(dataViewsSegment,new DataViewsSegment);var addDeviceIDs=[];for(var i in nbrInfoList){var info=nbrInfoList[i];addDeviceIDs.push(info.id)}this.extendOnDiagram(nbrInfoList,dataViewsSegment,onlyExtendToMedia,isNew,!1);applyDataViewSrvc||(applyDataViewSrvc=angular.element(document).injector().get("nb.dataview.applyDataViewSrvc"));var devIds=[];_.each(nbrInfoList,(function(item){devIds.push(item.devId);devIds.push(item.nbrDevId)}));applyDataViewSrvc&&applyDataViewSrvc.applyDataviewsOnDevices(devIds,null,netmap,!1,!0)}};netBrain.Map=netBrain.Map||{};netBrain.Map.ExtendNbrOp=ExtendNbrOp}(NetBrain);!function(netBrain){var ExtendNbrReadonlyOp=function(){netBrain.Map.ExtendNbrOp.call(this)};(ExtendNbrReadonlyOp.prototype=new netBrain.Map.ExtendNbrOp).isDoable=function(){return!1};netBrain.Map=netBrain.Map||{};netBrain.Map.ExtendNbrReadonlyOp=ExtendNbrReadonlyOp}(NetBrain);!function(netBrain){var ExtendNbrStandardOp=function(){netBrain.Map.ExtendNbrOp.call(this)};ExtendNbrStandardOp.prototype=new netBrain.Map.ExtendNbrOp;netBrain.Map=netBrain.Map||{};netBrain.Map.ExtendNbrStandardOp=ExtendNbrStandardOp}(NetBrain);!function(netBrain){var AutolinkOp=function(){netBrain.Map.AbstractOp.call(this)};AutolinkOp.prototype=new netBrain.Map.AbstractOp;var sitesCache=null;AutolinkOp.prototype._getCompDevice=function(dataView){var compDevice=null;if(null!=dataView){compDevice=NgUtil.cloneJson(dataView)}else compDevice=netBrain.Map.CompDevice.getDefaultJsonData();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compDevice);return compDevice};AutolinkOp.prototype._getCompMedia=function(mediaInfo,objcategory){if(null==mediaInfo)return null;var tempNbrInfo=new CNeighborInfo(null,null,null,null,null,null,mediaInfo.ID,{mediaName:mediaInfo.uniName,mediaType:mediaInfo.type});objcategory=netBrain.Map.CategoryMgr.Media;var compMedia=new netBrain.Map.CompMedia(objcategory).CreateMeidaJsonDataByNbrInfo(tempNbrInfo);if(null==compMedia)return null;netBrain.Map.CompPrototypeFactory.buildCompPrototype(compMedia);return compMedia};AutolinkOp.prototype._getIntfDataView=function(id,intf,topoTypeId,dataViewsSegment){if(null==id||null==intf||null==topoTypeId||null==dataViewsSegment)return null;var intfDataViewSegment=dataViewsSegment.getIntfSegmentIntfDataViewSegment(id,intf.intfKeyObj,topoTypeId);var intfDataView=dataViewsSegment.getIntfSegmentIntfDataView(intfDataViewSegment);var intfDisplaySchemaObjValue=null!=intf.intfDisplaySchemaObj?intf.intfDisplaySchemaObj.value:"";null==intfDataView&&(intfDataView={dataViewInfo:{dataViewGroupId:"",dataViewTaskInfoId:"",name:"",dataViewType:DataViewType.dvDefault,dataViewDefinitionId:""},intfInfo:{intf:intf},intfPosList:[{posName:DataViewPosName.intfPos0,posInfo:{dataUnitList:[{type:DataUnitSourceType.uSrcGDR,uId:null!=intf.intfDisplaySchemaObj?intf.intfDisplaySchemaObj.schema:"",value:intfDisplaySchemaObjValue,valueType:DataUnitType.uString,unit:"",perfix:"",valueExpr:""}],displayTemplate:"",displayInfo:intf.isSite?intf.borderDeviceName+"("+intfDisplaySchemaObjValue+")":intfDisplaySchemaObjValue,isCustomize:!1,isLock:!1}}]});return intfDataView};AutolinkOp.prototype._getCompSite=function(sitePropertie){var compSite=netBrain.Map.CompSite.getJson(sitePropertie.siteCategory);netBrain.Map.CompPrototypeFactory.buildCompPrototype(compSite);compSite.setDisplayName(sitePropertie.name);compSite.setKey(sitePropertie.ID);compSite.setSiteCategory(sitePropertie.siteCategory);compSite.setDeviceCount(sitePropertie.deviceCount);compSite.setParentId(sitePropertie.parentId);compSite.setParentPath(sitePropertie.parentPath);return compSite};AutolinkOp.prototype.doAutoLink=function(nbrInfoList,dataViewsSegment,sites,mediaInfo){var medias=[];if(null==this._netmap)return medias;if(!this.isDoable())return medias;var allNewLinks=[];var netmap=this._netmap;if(!_.isArray(nbrInfoList)||!nbrInfoList.length)return medias;var noTopoLinkNbrInfoList=function(netmap,nbrInfoList){var noTopoLinkNbrInfoList=[];var allTopoLinks=netmap._getAllTopoLink();if(!allTopoLinks.length)return nbrInfoList;var p2PTopoLinks=_.filter(allTopoLinks,(function(topolink){return""===topolink.mediaId||null==topolink.mediaId||void 0===topolink.mediaId}));var mpTopoLinks=_.reject(allTopoLinks,(function(topolink){return""===topolink.mediaId||null==topolink.mediaId||void 0===topolink.mediaId}));var p2PTopoLinkObjs=function(allTopoLinks){var obj={};_.isArray(allTopoLinks)&&_.each(allTopoLinks,(function(topoLink){var key=topoLink.from+topoLink.topoType+topoLink.to;_.findKey(obj,key)||(obj[key]=key)}));return obj}(p2PTopoLinks);var mpTopoLinkObjs=function(mptopoLinks){var obj={};_.each(mptopoLinks,(function(topoLink){var key=topoLink.mediaId;obj[key]?obj[key].push(topoLink.from+topoLink.topoType):obj[key]=[topoLink.from+topoLink.topoType];topoLink.mediaInfo&&topoLink.mediaInfo.neat&&(obj[key]?obj[key].push(topoLink.to+topoLink.topoType):obj[key]=[topoLink.to+topoLink.topoType])}));return obj}(mpTopoLinks);_.each(nbrInfoList,(function(nbrInfo){if(nbrInfo.isP2P){var p2PKey=nbrInfo.devId+nbrInfo.topoTypeId+nbrInfo.nbrDevId;var p2PReverseKey=nbrInfo.nbrDevId+nbrInfo.topoTypeId+nbrInfo.devId;p2PTopoLinkObjs[p2PKey]||p2PTopoLinkObjs[p2PReverseKey]||noTopoLinkNbrInfoList.push(nbrInfo)}else{var keys=_.keys(mpTopoLinkObjs);_.some(keys,(function(key){return mpTopoLinkObjs[key].indexOf(nbrInfo.id+nbrInfo.topoTypeId)>-1&&mpTopoLinkObjs[key].indexOf(nbrInfo.nbrId+nbrInfo.topoTypeId)>-1}))||noTopoLinkNbrInfoList.push(nbrInfo)}}));return noTopoLinkNbrInfoList}(netmap,nbrInfoList);var transactionName=NgUtil.getUniqueStr("auto link");netmap._diagram.startTransaction(transactionName);var alreadyHandleBorderDevName=[];for(var i in noTopoLinkNbrInfoList)if(noTopoLinkNbrInfoList.hasOwnProperty(i)){var nbrInfo=noTopoLinkNbrInfoList[i];if("group"==nbrInfo.linkStyle)continue;var tempNbrInfo=new CNeighborInfo(nbrInfo.id,nbrInfo.nbrId,nbrInfo.intf,nbrInfo.nbrIntf,nbrInfo.topoTypeId,nbrInfo.isP2P,nbrInfo.mediaId,nbrInfo.mediaInfo,nbrInfo.isPortChannel);tempNbrInfo.setCategory(nbrInfo.category);var srcborderDeviceNameAndintfObj={intfDisplaySchemaObj:null!=nbrInfo.intf?nbrInfo.intf.intfDisplaySchemaObj:null,intfKeyObj:null!=nbrInfo.intf?nbrInfo.intf.intfKeyObj:null,borderDeviceName:nbrInfo.borderDeviceName?nbrInfo.borderDeviceName:nbrInfo.devName,isSite:nbrInfo.id!==nbrInfo.devId};var destborderDeviceNameAndintfObj={intfDisplaySchemaObj:null!=nbrInfo.nbrIntf?nbrInfo.nbrIntf.intfDisplaySchemaObj:null,intfKeyObj:nbrInfo.nbrIntf?nbrInfo.nbrIntf.intfKeyObj:null,borderDeviceName:nbrInfo.nbrName?nbrInfo.nbrName:nbrInfo.nbrDevName,isSite:nbrInfo.nbrId!==nbrInfo.nbrDevId};tempNbrInfo.setSrcDevId(nbrInfo.devId);tempNbrInfo.setDestDevId(nbrInfo.nbrDevId);var key;nbrInfo.intf&&(key=nbrInfo.devId+nbrInfo.intf.intfKeyObj.value+nbrInfo.topoTypeId);var srcIntfDataView=this._getIntfDataView(nbrInfo.devId,srcborderDeviceNameAndintfObj,nbrInfo.topoTypeId,dataViewsSegment);if(void 0===nbrInfo.isSite&&nbrInfo.id!==nbrInfo.devId&&_.indexOf(alreadyHandleBorderDevName,key)<0){alreadyHandleBorderDevName.push(key);srcIntfDataView.intfInfo.intf.intfDisplaySchemaObj.value=nbrInfo.devName+"("+srcIntfDataView.intfInfo.intf.intfDisplaySchemaObj.value+")"}tempNbrInfo.setSrcIntfDataView(srcIntfDataView);nbrInfo.nbrIntf&&(key=nbrInfo.nbrDevId+nbrInfo.nbrIntf.intfKeyObj.value+nbrInfo.topoTypeId);var destIntfDataView=this._getIntfDataView(nbrInfo.nbrDevId,destborderDeviceNameAndintfObj,nbrInfo.topoTypeId,dataViewsSegment);if(void 0===nbrInfo.isSite&&nbrInfo.nbrId!==nbrInfo.nbrDevId&&_.indexOf(alreadyHandleBorderDevName,key)<0){alreadyHandleBorderDevName.push(key);destIntfDataView.intfInfo.intf.intfDisplaySchemaObj.value=nbrInfo.nbrDevName+"("+destIntfDataView.intfInfo.intf.intfDisplaySchemaObj.value+")"}tempNbrInfo.setDestIntfDataView(destIntfDataView);var srcDevDataView=null;var destDevDataView=null;var srcCompDev=null;var destCompDev=null;var site;if(nbrInfo.devId===nbrInfo.id)srcCompDev=null!=(srcDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbrInfo.id))?this._getCompDevice(srcDevDataView):this._getCompMedia(mediaInfo);else{site=sites.getSitePropertieById(nbrInfo.id);srcCompDev=this._getCompSite(site)}if(nbrInfo.nbrDevId===nbrInfo.nbrId)destCompDev=null!=(destDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbrInfo.nbrId))?this._getCompDevice(destDevDataView):this._getCompMedia(mediaInfo);else{site=sites.getSitePropertieById(nbrInfo.nbrId);destCompDev=this._getCompSite(site)}if(null==srcCompDev)continue;if(null==destCompDev)continue;if("Site"===srcCompDev.category&&"Site"===destCompDev.category){var srcCompDevParentPath=srcCompDev.getParentPath();var destCompDevParentPath=destCompDev.getParentPath();if(srcCompDevParentPath.length>destCompDevParentPath.length){if(srcCompDevParentPath.indexOf(destCompDev.getKey())>-1)continue}else if(destCompDevParentPath.indexOf(srcCompDev.getKey())>-1)continue}var k;var linkLines=[];if(nbrInfo.isP2P){if(!nbrInfo.isP2P&&tempNbrInfo.getTopoType()!==NetBrain.Map.Const.TopoLinkType.IPv4L3Topology&&tempNbrInfo.getTopoType()!==NetBrain.Map.Const.TopoLinkType.IPv6L3Topology)continue;netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);if("Site"===srcCompDev.category||"Site"===destCompDev.category)for(k in linkLines){!0===netmap.getNetmapOperator().addLinkLine(linkLines[k],!0)&&allNewLinks.push(linkLines[k])}else for(k in linkLines){!0===netmap.getNetmapOperator().addLinkLine(linkLines[k])&&allNewLinks.push(linkLines[k])}}else{var bSrcDevMedia=netBrain.Map.gMediaTypeMgr.isMediaType(srcCompDev.getDevType());var bDestDevMedia=netBrain.Map.gMediaTypeMgr.isMediaType(destCompDev.getDevType());if(bSrcDevMedia||bDestDevMedia){netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);for(k in linkLines){!0===netmap.getNetmapOperator().addLinkLine(linkLines[k])&&allNewLinks.push(linkLines[k])}}else{if(!netmap.getNetmapOperator()._isNeatUpMedia(tempNbrInfo.getNeat())){var compMedia=netmap.getNetmapOperator()._buildCompMediaByInfo(tempNbrInfo.getMediaName(),tempNbrInfo.getMedia(),tempNbrInfo.getMediaType(),tempNbrInfo.getMediaTopoType());if(null==compMedia)continue;if(null==netmap._model.findNodeDataForKey(compMedia.getKey())){var ptProperPos=netmap._findProperNeighborPosition(srcCompDev);ptProperPos.x+=9;ptProperPos.y-=3;null==ptProperPos&&(ptProperPos=new go.Point(500,500));compMedia.setLocation(go.Point.stringify(ptProperPos));netmap._addNode(compMedia);medias.push(compMedia.key)}}netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);for(k in linkLines){!0===netmap.getNetmapOperator().addLinkLine(linkLines[k])&&allNewLinks.push(linkLines[k])}}}}netmap.calcUnknownEndSystemPolicyAfterAddLinks(allNewLinks);var portInfos=netBrain.Map.L2PortsLayoutTool.getPortsInfoByLinkInfos(allNewLinks,netmap.getGoJsDiagram());netmap.layoutL2Ports(portInfos);netmap.refreshMapViewOptionVisible();netmap.setNetMapLegend();netmap._diagram.commitTransaction(transactionName);return medias};function getSitePropertie(){if(null==sitesCache)return null;var sites=[];for(var i in sitesCache)sites.push(sitesCache[i]);var sitePropertie={sitePropertieList:sites};Object.setPrototypeOf(sitePropertie,new SitePropertie);return sitePropertie}AutolinkOp.prototype.selectAllLinkByTopoType=function(topoTypeID){var hasLink=!1;if(this.isDoable()&&null!=this._netmap){this._netmap._clearAllSelection();var allTopoLinks=this._netmap._getAllTopoLink();for(var i=0;i<allTopoLinks.length;i++){var topoLink=allTopoLinks[i];if(topoLink.topoType===topoTypeID){var goLink=this._netmap._getLinkByData(topoLink);goLink&&(goLink.isSelected=!0);hasLink=!0}}return hasLink}};AutolinkOp.prototype.unlinkAllByTopoType=function(topoTypeID){var redirectNormalLink=function(that,fromOrTo){var normalLinkData=null;var allNormalLinks=that._netmap._getAllNormalLink();var findFromLink=_.find(allNormalLinks,{from:fromOrTo});if(findFromLink){findFromLink.intfSrc=null;findFromLink.fromPort="";findFromLink.fromPortIntf=netBrain.Map.CategoryMgr.NormalLink;normalLinkData=findFromLink}var findToLink=_.find(allNormalLinks,{to:fromOrTo});if(findToLink){findToLink.intfDest=null;findToLink.toPort="";findToLink.toPortIntf=netBrain.Map.CategoryMgr.NormalLink;normalLinkData=findToLink}normalLinkData&&that._netmap._updateNormalLink(normalLinkData);return normalLinkData};var hasLink=!1;if(this.isDoable()&&null!=this._netmap){var allTopoLinks=this._netmap._getAllTopoLink();for(var i=0;i<allTopoLinks.length;i++){var topoLinkData=allTopoLinks[i];redirectNormalLink(this,topoLinkData.from);redirectNormalLink(this,topoLinkData.to);if(topoLinkData.topoType===topoTypeID){this._netmap._removeLink(topoLinkData);if(topoLinkData.mediaId){var compMedia=this._netmap._getCompDeviceByKey(topoLinkData.mediaId);this._netmap._removeNode(compMedia)}hasLink=!0}}return hasLink}};AutolinkOp.prototype.autoLink=function(httpExternNbrSrvc,topoTypeId,nbAlertSrvc,applyDataViewSrvc){if(this.isDoable()&&null!=this._netmap){var netmap=this._netmap;var devSiteInfoList=[];var devDeviceInfoList=[];var sites=netmap._getAllSites();for(var j=0;j<sites.length;j++){var srcCompSite=sites[j];devSiteInfoList.push({id:srcCompSite.getKey(),isSite:!0})}var devices=netmap._getAllDevices();for(var i=0;i<devices.length;i++){var srcCompDev=devices[i];var obj={id:srcCompDev.getKey(),vsNodeIdentify:srcCompDev.getVSNodeIdentify(),isSite:!1,hostName:srcCompDev.getHostname()};if(1024===srcCompDev.devType){obj.isMPLSCloud=!0;devSiteInfoList.push(obj)}devDeviceInfoList.push(obj)}if(0!==devSiteInfoList.length||0!==devDeviceInfoList.length){var context=this;var autolinkResult={hasLink:!1};return _doLink(devSiteInfoList).then((function(autolinkResult){return devDeviceInfoList.length>0?_doLink(devDeviceInfoList).then((function(autolinkResult){return autolinkResult})):autolinkResult.hasLink?void 0:autolinkResult}))}nbAlertSrvc&&nbAlertSrvc.warning("No available topology links can be drawn between devices or sites. Please select another topology type and try again.")}function _doLink(devInfoList){var deferred=context._q.defer();if(0===devInfoList.length){deferred.resolve(autolinkResult);return deferred.promise}return httpExternNbrSrvc.getNbrLinkInfosAndDataViewsSegment(null,devInfoList,null,topoTypeId,!1).then((function(result){if(null!=result){Object.setPrototypeOf(result.dataViewsSegment,new DataViewsSegment);sitesCache=result.sitePropertie.sitePropertieList;result.linkInfos.length>0&&(autolinkResult.hasLink=!0);context.doAutoLink(result.linkInfos,result.dataViewsSegment,getSitePropertie());var devIds=[];var segmentInList=result.dataViewsSegment.getDevDataViewSegmentList();for(var k in segmentInList){var item=segmentInList[k];devIds.push(item.devId)}applyDataViewToLink(result.linkInfos,netmap);var diagram=netmap.getGoJsDiagram();if(diagram){diagram.startTransaction("rebuild diagram");netmap.removeAllLinkHighlightFlag();netmap.refreshMapViewOptionVisible();diagram.commitTransaction("rebuild diagram")}deferred.resolve(autolinkResult);return deferred.promise}}),(function(){if(nbAlertSrvc){deferred.reject(autolinkResult);nbAlertSrvc.error({message:"Failed to call the autolink."});return deferred.promise}}))}};AutolinkOp.prototype.flaotMeauAutoLink=function(httpExternNbrSrvc,mediaId,topoTypeId,nbAlertSrvc,applyDataViewSrvc){if(this.isDoable()&&null!=this._netmap){var netmap=this._netmap;var devInfoList=[];var devices=netmap._getAllDevices();for(var i=0;i<devices.length;i++){var srcCompDev=devices[i];var obj={id:srcCompDev.getKey(),vsNodeIdentify:srcCompDev.getVSNodeIdentify(),isSite:!1,hostName:srcCompDev.getHostname()};devInfoList.push(obj)}var context=this;var autolinkResult={hasLink:!1};var deferred=context._q.defer();return httpExternNbrSrvc.getNbrInfosAndDataViewsSegment(null,devInfoList,mediaId,topoTypeId).then((function(result){if(null!=result){Object.setPrototypeOf(result.dataViewsSegment,new DataViewsSegment);result.linkInfos.length>0&&(autolinkResult.hasLink=!0);context.doAutoLink(result.linkInfos,result.dataViewsSegment,getSitePropertie(),result.mediaInfosSegment.mediaInfosSegmentList[0]);var devIds=[];var segmentInList=result.dataViewsSegment.getDevDataViewSegmentList();for(var i in segmentInList){var item=segmentInList[i];devIds.push(item.devId)}applyDataViewToLink(result.linkInfos,netmap);deferred.resolve(autolinkResult);return deferred.promise}}),(function(){nbAlertSrvc&&nbAlertSrvc.error({message:"Failed to call the autolink."})}))}};AutolinkOp.prototype.autoLinkBetweenDevices=function(httpExternNbrSrvc,lsCompDev,topoTypeId,nbAlertSrvc){if(null!=lsCompDev&&0!==lsCompDev.length&&this.isDoable()&&null!=this._netmap){var devInfoList=[];for(var j=0;j<lsCompDev.length;j++){var obj={id:lsCompDev[j].getKey(),vsNodeIdentify:lsCompDev[j].getVSNodeIdentify(),isSite:!1,hostName:lsCompDev[j].getHostname()};devInfoList.push(obj)}var context=this;return httpExternNbrSrvc.getNbrLinkInfosAndDataViewsSegment(null,devInfoList,null,topoTypeId).then((function(result){if(null!=result){Object.setPrototypeOf(result.dataViewsSegment,new DataViewsSegment);result.linkInfos.length<1&&nbAlertSrvc&&nbAlertSrvc.warning("No available topology links can be drawn between devices, Please select another topology type and try again.");context.doAutoLink(result.linkInfos,result.dataViewsSegment)}}),(function(){nbAlertSrvc&&nbAlertSrvc.error({message:"Failed to call the autolink."})}))}};AutolinkOp.prototype.autoLinkByNodeIds=function(httpExternNbrSrvc,devInfoList,nbrInfoList,topoTypeId,dataViewCacheSrvc,nbAlertSrvc,skipLayoutNodeIds){if(null!=devInfoList&&0!==devInfoList.length&&topoTypeId&&this.isDoable()&&null!=this._netmap){var netmap=this._netmap;var operator=this._netmap.getNetmapOperator();var context=this;devInfoList[0].isMPLSCloud&&!0;nbrInfoList.length>0&&nbrInfoList[0].isSite&&!0;return httpExternNbrSrvc.getNbrLinkInfosAndDataViewsSegment(null,devInfoList,nbrInfoList,topoTypeId,!1,!1,netBrain.Map.Const.AutolinkType.LinkLimit).then((function(result){if(null!=result){Object.setPrototypeOf(result.dataViewsSegment,new DataViewsSegment);Object.setPrototypeOf(result.sitePropertie,new SitePropertie);Object.setPrototypeOf(result.mediaInfosSegment,new MediaInfosSegment);var medias=context.doAutoLink(result.linkInfos,result.dataViewsSegment,result.sitePropertie);applyDataViewToLink(result.linkInfos,netmap);var ids=devInfoList.length>1?_.pluck(devInfoList,"id"):[];ids=ids.concat(medias);var needLayoutNodeIds=_.filter(ids,(function(id){return skipLayoutNodeIds.indexOf(id)<0}));needLayoutNodeIds.length>0&&operator.forceDirectedLayoutNew(needLayoutNodeIds);console.warn("autoLinkByNodeIds")}}),(function(){nbAlertSrvc&&nbAlertSrvc.error({message:"Failed to call the autolink."})}))}};AutolinkOp.prototype.applyDataViewToLink=applyDataViewToLink;function applyDataViewToLink(linkInfos,netmap,skipRefreshMapView){var diagram;if(diagram=netmap._diagram){var applyDataViewSrvc=angular.element(document).injector().get("nb.dataview.applyDataViewSrvc");var devIds=_.pluck(diagram.model.nodeDataArray,"key");applyDataViewSrvc&&applyDataViewSrvc.applyDataviewsOnDevices(devIds,null,netmap)}else;}netBrain.Map=netBrain.Map||{};netBrain.Map.AutolinkOp=AutolinkOp}(NetBrain);!function(netBrain){var AutolinkReadonlyOp=function(){netBrain.Map.AutolinkOp.call(this)};(AutolinkReadonlyOp.prototype=new netBrain.Map.AutolinkOp).isDoable=function(){return!1};netBrain.Map=netBrain.Map||{};netBrain.Map.AutolinkReadonlyOp=AutolinkReadonlyOp}(NetBrain);!function(netBrain){var AutolinkStandardOp=function(){netBrain.Map.AutolinkOp.call(this)};AutolinkStandardOp.prototype=new netBrain.Map.AutolinkOp;netBrain.Map=netBrain.Map||{};netBrain.Map.AutolinkStandardOp=AutolinkStandardOp}(NetBrain);!function(netBrain){var GraphicOp=function(){netBrain.Map.AbstractOp.call(this)};(GraphicOp.prototype=new netBrain.Map.AbstractOp).alignLeft=function(){if(null!=this._netmap&&this.isDoable()){var netmap=this._netmap;var diagram=netmap.getGoJsDiagram();if(null!=diagram&&null!=diagram.commandHandler){doL2PortLayoutAfterAlign(diagram.commandHandler.alignLeft(),netmap);netmap.layoutLinkLabels()}}};GraphicOp.prototype.alignRight=function(){if(null!=this._netmap&&this.isDoable()){var netmap=this._netmap;var diagram=netmap.getGoJsDiagram();if(null!=diagram&&null!=diagram.commandHandler){doL2PortLayoutAfterAlign(diagram.commandHandler.alignRight(),netmap);netmap.layoutLinkLabels()}}};GraphicOp.prototype.alignTop=function(){if(null!=this._netmap&&this.isDoable()){var netmap=this._netmap;var diagram=netmap.getGoJsDiagram();if(null!=diagram&&null!=diagram.commandHandler){doL2PortLayoutAfterAlign(diagram.commandHandler.alignTop(),netmap);netmap.layoutLinkLabels()}}};GraphicOp.prototype.alignBottom=function(){if(null!=this._netmap&&this.isDoable()){var netmap=this._netmap;var diagram=netmap.getGoJsDiagram();if(null!=diagram&&null!=diagram.commandHandler){doL2PortLayoutAfterAlign(diagram.commandHandler.alignBottom(),netmap);netmap.layoutLinkLabels()}}};GraphicOp.prototype.alignCenterX=function(){if(null!=this._netmap&&this.isDoable()){var netmap=this._netmap;var diagram=netmap.getGoJsDiagram();if(null!=diagram&&null!=diagram.commandHandler){doL2PortLayoutAfterAlign(diagram.commandHandler.alignCenterX(),netmap);netmap.layoutLinkLabels()}}};GraphicOp.prototype.alignCenterY=function(){if(null!=this._netmap&&this.isDoable()){var netmap=this._netmap;var diagram=netmap.getGoJsDiagram();if(null!=diagram&&null!=diagram.commandHandler){doL2PortLayoutAfterAlign(diagram.commandHandler.alignCenterY(),netmap);netmap.layoutLinkLabels()}}};GraphicOp.prototype.layoutSelection=function(){var netmap=this._netmap;if(null!=netmap&&this.isDoable()){var diagram=netmap.getGoJsDiagram();if(null!=diagram){var layout=diagram.layout;null!=layout&&layout instanceof go.ForceDirectedLayout&&layout.doLayout(diagram.selection)}}};GraphicOp.prototype.selectNodes=function(nodeKeys){var diagram=this._netmap.getGoJsDiagram();if(null==diagram||null==nodeKeys||nodeKeys.length<=0)return!1;for(var i=0;i<nodeKeys.length;i++){var key=nodeKeys[i];if(null!=key){var graphicObj=diagram.findNodeForKey(key);null!=graphicObj&&(graphicObj.isSelected=!0)}}return!0};GraphicOp.prototype.addDeviceNote=function(objNote,ptPosDisplay){var netmap=this._netmap;if(null!=netmap&&this.isDoable()&&null!=objNote&&null!=ptPosDisplay){var diagram=netmap.getGoJsDiagram();if(null!=diagram){var transactionName=NgUtil.getUniqueStr("addDeviceNote");netmap._diagram.startTransaction(transactionName);var comNote=netBrain.Map.CompDeviceNote.getDefaultJsonData(objNote.expand);comNote.__proto__=new netBrain.Map.CompDeviceNote;comNote.setData(objNote,diagram);null!=ptPosDisplay&&comNote.setPosition(ptPosDisplay);diagram.model.addNodeData(comNote);netmap._diagram.commitTransaction(transactionName);return comNote}}};GraphicOp.prototype.addDevice=function(compDev){null!=this._netmap&&this.isDoable()&&null!=compDev&&this.getNetmap()._addNode(compDev)};GraphicOp.prototype.addVisualSpaceNode=function(compVisualSpaceNode){null!=this._netmap&&this.isDoable()&&null!=compVisualSpaceNode&&this.addDevice(compVisualSpaceNode)};GraphicOp.prototype.addDeviceGroup=function(compDevGroup){null!=this._netmap&&this.isDoable()&&null!=compDevGroup&&this.addDevice(compDevGroup)};GraphicOp.prototype.addUnknownIp=function(hostName,key,location,imageList){if(null!=this._netmap&&this.isDoable()&&null!=hostName&&null!=key&&null!=location){var compDev=netBrain.Map.CompBase.buildCompUnknownIp(imageList);compDev.setKey(key);compDev.setHostname(hostName);location&&compDev.setLocation(go.Point.stringify(location));this.addDevice(compDev)}};GraphicOp.prototype.addStencil=function(strHostName,stencilItemObj,ptPosition){if(null!=this._netmap&&this.isDoable()){var strImge=stencilItemObj.ID+stencilItemObj.extension;if(null!=strHostName&&null!=strImge){var compStencil=netBrain.Map.CompBase.buildCompStencil();-1!==_.findIndex(["LAN","BUS","WAN","Site","Cluster","MPLS Cloud","Internet Wan","DMVPN","End System","Mute LAN","IP Phone","VPC"],(function(n){return 0===strHostName.indexOf(n)}))&&(compStencil=netBrain.Map.CompBase.buildCompStencilExt());compStencil.displayName=stencilItemObj.displayName;compStencil.setHostName(strHostName);compStencil.setImageName(strImge);var imgsize=stencilItemObj.width+" "+stencilItemObj.height;compStencil.setImageSize(imgsize);compStencil.setPosition(ptPosition.x,ptPosition.y);this.addDevice(compStencil);this._netmap._selectNodes([compStencil])}}};GraphicOp.prototype.addHyperLink=function(strName,strUrl){if(null!=this._netmap&&this.isDoable()){var nodeData={location:"500 500",category:"HyperLink",displayName:strName,url:strUrl,key:Guid()};netBrain.Map.CompPrototypeFactory.buildCompPrototype(nodeData);this.getNetmap()._addNode(nodeData)}};GraphicOp.prototype.addLinkLine=function(linkLine,isAutoLink){if(null==this._netmap)return!1;if(!this.isDoable())return!1;if(null==linkLine)return!1;var links=this.getNetmap()._getAllTopoLink();var bLinkExist=!1;for(var k in links)if(links.hasOwnProperty(k)){var otherlink=links[k];if(isAutoLink){if(linkLine.isEqualAutoLinkLineForSite(otherlink)){bLinkExist=!0;break}}else if(linkLine.isEqualLinkLine(otherlink)){bLinkExist=!0;break}}if(bLinkExist)return!1;this.getNetmap()._addLink(linkLine);return!0};GraphicOp.prototype.addLinkLines=function(linkLines,isAutoLink){if(null!=this._netmap&&this.isDoable()&&linkLines&&_.isArray(linkLines)){var netmap=this.getNetmap();var links=netmap._getAllTopoLink();var newAddLinks=[];linkLines.forEach((function(linkLine){var bLinkExist=!1;for(var k in links)if(links.hasOwnProperty(k)){var otherlink=links[k];if(isAutoLink){if(linkLine.isEqualAutoLinkLineForSite(otherlink)){bLinkExist=!0;break}}else if(linkLine.isEqualLinkLine(otherlink)){bLinkExist=!0;break}}if(!bLinkExist){netmap._addLink(linkLine);newAddLinks.push(linkLine)}}));return newAddLinks}};GraphicOp.prototype.addNormalLink=function(fromKey,toKey,isCompoundNoteLink){if(null!=this._netmap&&this.isDoable()&&null!=fromKey&&null!=toKey){var compLink=netBrain.Map.CompBase.buildCompNormalLink();compLink.setFromKey(fromKey);compLink.setToKey(toKey);compLink.setColor(netBrain.Map.Const.noteLinkDefaultBackColor);isCompoundNoteLink&&(compLink.isCompoundNoteLink=isCompoundNoteLink);this.getNetmap()._addLink(compLink)}};GraphicOp.prototype.addHighlightNeighborLink=function(data){if(null!=this._netmap&&this.isDoable()){if(!(!this.isLinkFromToExist(data)||this.isLinkExist(data))){var compLink=netBrain.Map.CompBase.buildCompHighlightNeighborLink();compLink.setFromKey(data.from);compLink.setToKey(data.to);compLink.setColor(data.color);compLink.setWidth(data.width);compLink.setType(data.type);compLink.setLegend(data.legend);compLink.setFromText(data.fromText);compLink.setToText(data.toText);compLink.setTwoWay(data.twoWay);this.getNetmap()._addLink(compLink)}}};GraphicOp.prototype.isLinkFromToExist=function(link){var dia=this.getNetmap()._diagram;return dia.findNodeForKey(link.from)&&dia.findNodeForKey(link.to)};GraphicOp.prototype.isLinkExist=function(link){var linkKey=generateLinkKey(link);var links=this.getNetmap()._getAllLinksByFilter((function(currentLink){return generateLinkKey(currentLink)===linkKey}));return links&&links.length>0};function generateLinkKey(link){return[link.from,link.to,link.fromText,link.toText,link.category].join("|")}GraphicOp.prototype.addHopLink=function(data){if(null!=this._netmap&&this.isDoable()){var compLink=netBrain.Map.CompBase.buildCompHopLink();compLink.setFromKey(data.from);compLink.setToKey(data.to);compLink.setColor(data.color);compLink.setWidth(data.width);compLink.setType(data.type);compLink.setText(data.text);this.getNetmap()._addLink(compLink)}};GraphicOp.prototype.addSiteBorderLink=function(data){if(null!=this._netmap&&this.isDoable()){var links=this.getNetmap()._getAllLinksByFilter((function(link){return null!=link&&link.getFromKey()===data.from&&link.getToKey()===data.to}));if(!(null!=links&&links.length>0)){var compLink=netBrain.Map.CompBase.buildCompNormalLink();compLink.setFromKey(data.from);compLink.setToKey(data.to);compLink.setType(netBrain.Map.Const.LinkType.Dash);compLink.setText(data.text);this.getNetmap()._addLink(compLink)}}};GraphicOp.prototype.addIntfaceLink=function(data){if(null!=this._netmap&&this.isDoable()){var compLink=netBrain.Map.CompBase.buildCompNormalLink();compLink.setFromKey(data.from);compLink.setToKey(data.to);compLink.setIntfSrc(data.intfSrc);compLink.setIntfDest(data.intfDest);compLink.setColor(data.color);this.getNetmap()._addLink(compLink)}};GraphicOp.prototype.updatePath=function(compPath){null!=this._netmap&&this.isDoable()&&null!=compPath&&this.getNetmap()._updateLink(compPath)};function doL2PortLayoutAfterAlign(alignNodes,netmap){if(netmap.isL2MapStyle()&&_.isArray(alignNodes)){var portInfos=netBrain.Map.L2PortsLayoutTool.getPortsInfoByDragNodes(alignNodes);portInfos.length>0&&netmap.layoutL2Ports(portInfos)}}netBrain.Map=netBrain.Map||{};netBrain.Map.GraphicOp=GraphicOp}(NetBrain);!function(netBrain){var GraphicReadonlyOp=function(){netBrain.Map.GraphicOp.call(this)};(GraphicReadonlyOp.prototype=new netBrain.Map.GraphicOp).isDoable=function(){return!1};netBrain.Map=netBrain.Map||{};netBrain.Map.GraphicReadonlyOp=GraphicReadonlyOp}(NetBrain);!function(netBrain){var GraphicStandardOp=function(){netBrain.Map.GraphicOp.call(this)};GraphicStandardOp.prototype=new netBrain.Map.GraphicOp;netBrain.Map=netBrain.Map||{};netBrain.Map.GraphicStandardOp=GraphicStandardOp}(NetBrain);!function(netBrain){var VisualSpaceOp=function(){netBrain.Map.AbstractOp.call(this);this._cacheDropNodeByDataView={count:0}};(VisualSpaceOp.prototype=new netBrain.Map.AbstractOp).getRelatedVisualSpaceInfo=function(httpSdnSrvc,target){if(!httpSdnSrvc)return null;var req={nodeItems:[]};var netMap=this.getNetmap();if(target&&target.part&&target.part.data){(devNodeData=target.part.data.getDevNodeData())&&req.nodeItems.push({id:devNodeData.id,nodeIdentify:devNodeData.nodeIdentify})}else for(var i=netMap._model.nodeDataArray.length-1;i>=0;--i){var nodeData=netMap._model.nodeDataArray[i];if(nodeData&&isNodeCanBeSwitched(nodeData)&&netBrain.Map.CategoryMgr.isDeviceCategory(nodeData.category)){var devNodeData;(devNodeData=nodeData.getDevNodeData())&&req.nodeItems.push({id:devNodeData.id,nodeIdentify:devNodeData.nodeIdentify})}}return httpSdnSrvc.getRelatedVisualSpaceInfo(req)};VisualSpaceOp.prototype.switchVisualSpace=function(httpSrvcs,option){var deferred=httpSrvcs.q.defer();var netmap=this.getNetmap();var qMap=netmap.getParentQmap();(function(vsNodeIdentifies,httpSrvcs){var deferred=httpSrvcs.q.defer();if(null==vsNodeIdentifies){deferred.reject();return}(function(httpSrvcs){var deferred=httpSrvcs.q.defer();httpSrvcs.autoLinkOptionSrvc.autolinkOption().then((function(topoIds){if(topoIds){console.log(topoIds);var topoType=[];angular.forEach(topoIds,(function(item){NetBrain.AllTopoLinkType.find((function(topoType){if(topoType.ID==item)return!0}))&&topoType.push(item)}));deferred.resolve(topoType.join(","))}}),(function(){deferred.reject("Failed call getAutoLinkOption")}));return deferred.promise})(httpSrvcs).then((function(topoType){if(topoType)return httpSrvcs.httpSdnSrvc.getSwitchVisualSpaceInfo({vsNodeIdentifies:vsNodeIdentifies,topoType:topoType,nbrSite:!1,extendtompls:!1,autolinkType:netBrain.Map.Const.AutolinkType.LinkLimit}).then((function(result){if(null!=result&&null!=result.result){(result=result.result).vsNodeIdentifies=[];_.forEach(result.dataViewsSegment.devDataViewSegmentList,(function(item){item&&item.devDataView&&item.devDataView.devNodeData&&result.vsNodeIdentifies.push({id:item.devDataView.devNodeData.id,nodeIdentify:item.devDataView.devNodeData.nodeIdentify,visualSpaceInfo:item.devDataView.devNodeData.visualSpaceInfo})}));deferred.resolve(result)}else deferred.reject("Failed call getSwitchVisualSpaceInfo")}));deferred.reject()}),(function(){deferred.reject()}));return deferred.promise})(option.vsNodeIdentifies,httpSrvcs).then((function(result){if(result&&0!=result.vsNodeIdentifies.length){qMap.doSave();var cloneNetMap=qMap.duplicateNetMap(netmap);qMap.deactiveAllPage();var vsNodeIdentify=result.vsNodeIdentifies[0];vsNodeIdentify&&vsNodeIdentify.visualSpaceInfo&&cloneNetMap.setVisualSpaceInfo(vsNodeIdentify.visualSpaceInfo,!0);!function asyncSwitchVisualSpace(qMap,netMap,httpSrvcs,option,result){if(!netMap._diagram||!netMap._model){setTimeout((function(){asyncSwitchVisualSpace(qMap,netMap,httpSrvcs,option,result)}),0);return}var skipLayoutNodeIds=[];var needRemoveNodes=[];option.vsNodeIdentifies=result.vsNodeIdentifies;!function(netMap,vsNodeIdentifies,skipLayoutNodeIds,needRemoveNodes){needRemoveNodes=needRemoveNodes||[];if(!netMap||!vsNodeIdentifies)return;skipLayoutNodeIds=skipLayoutNodeIds||[];for(var i=netMap._model.nodeDataArray.length-1;i>=0;--i){var nodeData=netMap._model.nodeDataArray[i];if(nodeData&&isNodeCanBeSwitched(nodeData)){var idx=_.findIndex(vsNodeIdentifies,(function(item){return item.id==nodeData.getKey()}));if(idx>=0)var devNodeData=vsNodeIdentifies[idx];else devNodeData=null;devNodeData^nodeData.devNodeData||devNodeData&&nodeData.devNodeData&&(devNodeData.visualSpaceInfo^nodeData.devNodeData.visualSpaceInfo||devNodeData.visualSpaceInfo.visualSpaceInstanceId!=nodeData.devNodeData.visualSpaceInfo.visualSpaceInstanceId)?devNodeData?needRemoveNodes.push({obj:nodeData,action:"delete"}):needRemoveNodes.push({obj:nodeData,action:"confirmDelete"}):idx>=0?vsNodeIdentifies.splice(idx,1):netBrain.Map.CategoryMgr.isMedia(nodeData.category)||needRemoveNodes.push({obj:nodeData,action:"confirmDelete"});var location=nodeData.getLocation();"string"==typeof location&&(location=go.Point.parse(location));skipLayoutNodeIds.push({id:nodeData.getKey(),location:location})}}}(netMap,option.vsNodeIdentifies,skipLayoutNodeIds,needRemoveNodes);if(option.isIgnoreConfirmDelete)confirm(NB_CONFIRM_NO,netMap,result,skipLayoutNodeIds,needRemoveNodes,option);else if(_.some(needRemoveNodes,(function(nodeData){return"confirmDelete"==nodeData.action}))){var stop=!1;var netmapOp=netMap.getNetmapOperator();!function blink(){if(!stop){var promises=[];_.forEach(needRemoveNodes,(function(item){if("confirmDelete"==item.action){var promise=netmapOp.highlightNode(item.obj);promises.push(promise)}}));httpSrvcs.q.all(promises).then((function(){blink()}))}}();var confirmOp={message:"We will delete blink devices",title:"Warning",iconType:NB_ICON_WARNING,buttons:[{id:NB_CONFIRM_YES,label:"Ok"}]};httpSrvcs.nbAlertSrvc.confirm(confirmOp).then((function(){stop=!0;confirm(NB_CONFIRM_YES,netMap,result,skipLayoutNodeIds,needRemoveNodes,option)}),(function(ret){stop=!0;confirm(NB_CONFIRM_YES,netMap,result,skipLayoutNodeIds,needRemoveNodes,option)}))}else confirm(NB_CONFIRM_YES,netMap,result,skipLayoutNodeIds,needRemoveNodes,option);qMap.doSave();netMap.setModify(!1);qMap.setModify(!0)}(qMap,cloneNetMap,httpSrvcs,option,result);qMap.setModify(!0);deferred.resolve(cloneNetMap)}else deferred.reject("there are no data")}),(function(){deferred.reject("Failed call getSwitchVisualSpaceInfo")}));return deferred.promise};VisualSpaceOp.prototype.preDropNodeByDataView=function(devDataView,location){if(!(devDataView&&devDataView.devNodeData&&devDataView.devNodeData.visualSpaceInfo&&devDataView.devNodeData.visualSpaceInfo.visualSpaceInstanceId))return!0;var netMap=this.getNetmap();var virtualSpaceInfo=devDataView.devNodeData.visualSpaceInfo;if(netMap.setVisualSpaceInfo(virtualSpaceInfo))return!0;var cache=null;if(this._cacheDropNodeByDataView.hasOwnProperty(virtualSpaceInfo.visualSpaceInstanceId))cache=this._cacheDropNodeByDataView[virtualSpaceInfo.visualSpaceInstanceId];else{cache={defered:null,arrDevDataView:[]};this._cacheDropNodeByDataView[virtualSpaceInfo.visualSpaceInstanceId]=cache}cache.arrDevDataView.push({obj:devDataView,location:location});this._cacheDropNodeByDataView.count++;var self=this;1==this._cacheDropNodeByDataView.count&&setTimeout((function(){self.postDropNodeByDataView()}),0);return!1};VisualSpaceOp.prototype.postDropNodeByDataView=function(){if(this._cacheDropNodeByDataView.count>0){var netMap=this.getNetmap();var scope=netMap.getCurrentScope();var cacheDropNodeByDataView=this._cacheDropNodeByDataView;var hostNames=[];_.each(cacheDropNodeByDataView,(function(cache){if(!_.isNumber(cache))for(var i=0;i<cache.arrDevDataView.length;++i){var node=cache.arrDevDataView[i];hostNames.push(node.obj.hostName)}}));var defered=this._q.defer();scope.$emit(NetBrain.Map.Event.ConfirmAddNewMapPage,netMap.getParentQmap(),defered,hostNames);var self=this;defered.promise.then((function(){_.each(cacheDropNodeByDataView,(function(cache){if(!_.isNumber(cache)){cache.defered=self._q.defer();scope.$emit(NetBrain.Map.Event.AddNewMapPage,netMap.getParentQmap(),cache.defered);for(var i=0;i<cache.arrDevDataView.length;++i){cache.arrDevDataView[i];setTimeout((function(){cache.defered.promise.then((function(newNetMap){for(var i=0;i<cache.arrDevDataView.length;++i){var node=cache.arrDevDataView[i];newNetMap.getNetmapOperator().dropDeviceByDataView(node.obj,node.location)}}),(function(){}),0)}))}}}));self._cacheDropNodeByDataView={count:0}}),(function(){self._cacheDropNodeByDataView={count:0}}))}};netBrain.Map=netBrain.Map||{};netBrain.Map.VisualSpaceOp=VisualSpaceOp;return;function isNodeCanBeSwitched(node){return!(!node||!node.category)&&!(!netBrain.Map.CategoryMgr.isDeviceCategory(node.category)&&!netBrain.Map.CategoryMgr.isMedia(node.category))}function doSwitchVisualSpace(netMap,result,skipLayoutNodeIds){if(result){if(result.dataViewsSegment){skipLayoutNodeIds=skipLayoutNodeIds||[];result.dataViewsSegment.__proto__=new DataViewsSegment;!function(netMap,skipLayoutNodeIds,dataViewsSegmentOut){if(dataViewsSegmentOut){var devDataViewSegmentList=dataViewsSegmentOut.getDevDataViewSegmentList();var netmapOperator=netMap.getNetmapOperator();var ptLocation=netBrain.Map.GoDiagramPositionUtil.getPosRet(netMap._diagram);for(var i=0;i<devDataViewSegmentList.length;i++){var devDataViewSegment=devDataViewSegmentList[i];var node=dataViewsSegmentOut.getDevSegmentDevDataView(devDataViewSegment);if(null!=node){if(skipLayoutNodeIds){var inItem=_.find(skipLayoutNodeIds,(function(item){if(item.id==devDataViewSegment.devId)return item}));null!=inItem&&null!=inItem.location&&(ptLocation=inItem.location)}netmapOperator.dropDeviceByDataView(node,ptLocation)&&i%16==0&&(ptLocation=netMap._findProperNeighborPosition(node))}}}}(netMap,skipLayoutNodeIds,result.dataViewsSegment);!function(netMap,result,skipLayoutNodeIds){if(null!=result&&null!=netMap){var netmapOperator=netMap.getNetmapOperator();var autoLinkOp=netmapOperator.getAutolinkOp();Object.setPrototypeOf(result.dataViewsSegment,new DataViewsSegment);Object.setPrototypeOf(result.sitePropertie,new SitePropertie);Object.setPrototypeOf(result.mediaInfosSegment,new MediaInfosSegment);var medias=autoLinkOp.doAutoLink(result.linkInfos,result.dataViewsSegment,result.sitePropertie);autoLinkOp.applyDataViewToLink(result.linkInfos,netMap);var ids=null!=result.dataViewsSegment.devDataViewSegmentList?_.pluck(result.dataViewsSegment.devDataViewSegmentList,"devId"):[];ids=ids.concat(medias);var needLayoutNodeIds=_.filter(ids,(function(id){return!_.some(skipLayoutNodeIds,(function(item){return item.id==id}))}));needLayoutNodeIds.length>0&&netmapOperator.forceDirectedLayoutNew(needLayoutNodeIds)}}(netMap,result,skipLayoutNodeIds)}netMap.layoutLinkLabels()}}function confirm(id,netMap,result,skipLayoutNodeIds,needRemoveNodes,option){var skip=netMap._diagram.skipsUndoManager;netMap._diagram.skipsUndoManager=!0;netMap._diagram.startTransaction("switchVisualSpace");id===NB_CONFIRM_YES?_.forEach(needRemoveNodes,(function(nodeData){netMap._removeNode(nodeData.obj)})):_.forEach(needRemoveNodes,(function(nodeData){"delete"==nodeData.action&&netMap._removeNode(nodeData.obj)}));!function(netMap,vsNodeIdentifies){for(var i=netMap._model.linkDataArray.length-1;i>=0;--i){var linkData=netMap._model.linkDataArray[i];if(linkData){var fromGojs=_.find(netMap._model.nodeDataArray,(function(item){return item.key==linkData.getFromKey()}))||null;var toGojs=_.find(netMap._model.nodeDataArray,(function(item){return item.key==linkData.getToKey()}))||null;var fromData=_.find(vsNodeIdentifies,(function(item){return item.id==linkData.getFromKey()}))||null;var toData=_.find(vsNodeIdentifies,(function(item){return item.id==linkData.getToKey()}))||null;if((!fromGojs||!toGojs)&&(!fromGojs&&!fromData||!toGojs&&!toData||(null==fromGojs&&null==toGojs||(!(null!=fromGojs||null==fromData||null==toGojs||!isNodeCanBeSwitched(toGojs))||!(null!=toGojs||null==toData||null==fromGojs||!isNodeCanBeSwitched(fromGojs)))))){netMap._model.removeLinkData(linkData);if(fromGojs&&netBrain.Map.CategoryMgr.isMedia(fromGojs.category)){(links=netMap._getTopoLinksByDevId(fromGojs.key))&&0!=links.length||netMap._removeNode(gojsData)}else if(toGojs&&netBrain.Map.CategoryMgr.isMedia(toGojs.category)){var links;(links=netMap._getTopoLinksByDevId(toGojs.key))&&0!=links.length||netMap._removeNode(toGojs)}var gojsData=fromGojs||toGojs;gojsData&&!isNodeCanBeSwitched(gojsData)&&netMap._removeNode(gojsData)}}}}(netMap,option.vsNodeIdentifies);doSwitchVisualSpace(netMap,result,skipLayoutNodeIds);netMap._diagram.commitTransaction("switchVisualSpace");netMap._diagram.skipsUndoManager=skip;if(option.listDataViewGroup&&_.isArray(option.listDataViewGroup)){var listDataViewGroup=_.clone(option.listDataViewGroup);for(var i=netMap._model.nodeDataArray.length-1;i>=0;--i){var nodeData=netMap._model.nodeDataArray[i];var idx=_.findIndex(listDataViewGroup,(function(item){return!!(item.dataViewInfo&&nodeData.dataViewData&&nodeData.dataViewData.dataViewInfo)&&item.dataViewInfo.ID==nodeData.dataViewData.dataViewInfo.dataViewGroupId}));if(idx>=0){netMap.setApplyDataViewInfo(listDataViewGroup[idx]);listDataViewGroup.splice(idx,1)}}}}}(NetBrain);!function(netBrain){var NetmapModeBase=function NetmapModeBase(){this._netmap=null;this._rootScope=null;this._q=null;this._extendNbrOp=null;this._autolinkOp=null;this._dataViewApplyOp=null;this._graphicOp=null;this._addDevicesOp=null;this._visualSpaceOp=null;this._mode=NetmapModeBase.baseMode};NetmapModeBase.baseMode="base";NetmapModeBase.editMode="edit";NetmapModeBase.historyMode="history";NetmapModeBase.previewMode="previewModel";NetmapModeBase.readOnlyMode="readOnly";NetmapModeBase.standardMode="standard";NetmapModeBase.xmapMode="xmap";NetmapModeBase.prototype={constructor:NetmapModeBase,getNetmap:function(){return this._netmap},setNetmap:function(netmap){this._netmap=netmap;null!=this._extendNbrOp&&this._extendNbrOp.setNetmap(netmap);null!=this._autolinkOp&&this._autolinkOp.setNetmap(netmap);null!=this._dataViewApplyOp&&this._dataViewApplyOp.setNetmap(netmap);null!=this._graphicOp&&this._graphicOp.setNetmap(netmap);null!=this._addDevicesOp&&this._addDevicesOp.setNetmap(netmap);null!=this._visualSpaceOp&&this._visualSpaceOp.setNetmap(netmap)},setRootScope:function(rootScope){this._rootScope=rootScope;null!=this._extendNbrOp&&this._extendNbrOp.setRootScope(rootScope);null!=this._autolinkOp&&this._autolinkOp.setRootScope(rootScope);null!=this._dataViewApplyOp&&this._dataViewApplyOp.setRootScope(rootScope);null!=this._graphicOp&&this._graphicOp.setRootScope(rootScope);null!=this._addDevicesOp&&this._addDevicesOp.setRootScope(rootScope);null!=this._visualSpaceOp&&this._visualSpaceOp.setRootScope(rootScope)},getRootScope:function(){return this._rootScope},setQ:function(q){this._q=q;null!=this._extendNbrOp&&this._extendNbrOp.setQ(q);null!=this._autolinkOp&&this._autolinkOp.setQ(q);null!=this._dataViewApplyOp&&this._dataViewApplyOp.setQ(q);null!=this._graphicOp&&this._graphicOp.setQ(q);null!=this._addDevicesOp&&this._addDevicesOp.setQ(q);null!=this._visualSpaceOp&&this._visualSpaceOp.setQ(q)},getQ:function(){return this._q},getMode:function(){return this._mode},isEditMode:function(){return this._mode===NetmapModeBase.editMode},isReadOnlyMode:function(){return this._mode===NetmapModeBase.readOnlyMode},isStandardMode:function(){return this._mode===NetmapModeBase.standardMode},getExtendNbrOp:function(){return this._extendNbrOp},setExtendNbrOp:function(op){this._extendNbrOp=op},getAutolinkOp:function(){return this._autolinkOp},setAutolinkOp:function(op){this._autolinkOp=op},getDataViewApplyOp:function(){return this._dataViewApplyOp},setDataViewApplyOp:function(op){this._dataViewApplyOp=op},getGraphicOp:function(){return this._graphicOp},setGraphicOp:function(op){this._graphicOp=op},getAddDevicesOp:function(){return this._addDevicesOp},setAddDevicesOp:function(op){this._addDevicesOp=op},setVisualSpaceOp:function(op){this._visualSpaceOp=op},getVisualSpaceOp:function(){return this._visualSpaceOp}};netBrain.Map=netBrain.Map||{};netBrain.Map.NetmapModeBase=NetmapModeBase}(NetBrain);!function(netBrain){var NetmapReadonlyMode=function(netmap){netBrain.Map.NetmapModeBase.call(this);this._extendNbrOp=new netBrain.Map.ExtendNbrReadonlyOp;this._autolinkOp=new netBrain.Map.AutolinkReadonlyOp;this._dataViewApplyOp=new netBrain.Map.DataViewApplyReadonlyOp;this._graphicOp=new netBrain.Map.GraphicReadonlyOp;this._addDevicesOp=new netBrain.Map.AddDevicesReadonlyOp;this._mode=netBrain.Map.NetmapModeBase.readOnlyMode};NetmapReadonlyMode.prototype=new netBrain.Map.NetmapModeBase;netBrain.Map=netBrain.Map||{};netBrain.Map.NetmapReadonlyMode=NetmapReadonlyMode}(NetBrain);!function(netBrain){var NetmapStandardMode=function(){netBrain.Map.NetmapModeBase.call(this);this._extendNbrOp=new netBrain.Map.ExtendNbrStandardOp;this._autolinkOp=new netBrain.Map.AutolinkStandardOp;this._dataViewApplyOp=new netBrain.Map.DataViewApplyStandardOp;this._graphicOp=new netBrain.Map.GraphicStandardOp;this._addDevicesOp=new netBrain.Map.AddDevicesStandardOp;this._visualSpaceOp=new netBrain.Map.VisualSpaceOp;this._mode=netBrain.Map.NetmapModeBase.standardMode};NetmapStandardMode.prototype=new netBrain.Map.NetmapModeBase;netBrain.Map=netBrain.Map||{};netBrain.Map.NetmapStandardMode=NetmapStandardMode}(NetBrain);!function(netBrain){var AddDevicesOp=function(){netBrain.Map.AbstractOp.call(this)};(AddDevicesOp.prototype=new netBrain.Map.AbstractOp)._getCompMedia=function(mediaInfo,objcategory){if(null==mediaInfo)return null;var tempNbrInfo=new CNeighborInfo(null,null,null,null,mediaInfo.topoType,null,mediaInfo.ID,{mediaName:mediaInfo.uniName,mediaType:mediaInfo.type,hsrp:mediaInfo.hsrp,vrf:mediaInfo.vrf,zone:mediaInfo.zone});objcategory=netBrain.Map.CategoryMgr.Media;var compMedia=new netBrain.Map.CompMedia(objcategory).CreateMeidaJsonDataByNbrInfo(tempNbrInfo);if(null==compMedia)return null;netBrain.Map.CompPrototypeFactory.buildCompPrototype(compMedia);return compMedia};AddDevicesOp.prototype._getCompSite=function(sitePropertie){var compSite=netBrain.Map.CompSite.getJson(sitePropertie.siteCategory);if(null==sitePropertie)return compSite;netBrain.Map.CompPrototypeFactory.buildCompPrototype(compSite);compSite.setDisplayName(sitePropertie.name);compSite.setKey(sitePropertie.ID);compSite.setSiteCategory(sitePropertie.siteCategory);compSite.setImgSize(sitePropertie.siteCategory);compSite.setDeviceCount(sitePropertie.deviceCount);compSite.setParentId(sitePropertie.parentId);compSite.setParentPath(sitePropertie.parentPath);return compSite};AddDevicesOp.prototype._getCompDevice=function(dataView){var compDevice=null;if(null!=dataView){compDevice=NgUtil.cloneJson(dataView)}else compDevice=netBrain.Map.CompDevice.getDefaultJsonData();netBrain.Map.CompPrototypeFactory.buildCompPrototype(compDevice);return compDevice};AddDevicesOp.prototype._getIntfDataView=function(id,intf,topoTypeId,dataViewsSegment){if(null==id||null==intf||null==topoTypeId||null==dataViewsSegment)return null;var intfDataViewSegment=dataViewsSegment.getIntfSegmentIntfDataViewSegment(id,intf.intfKeyObj,topoTypeId);var intfDataView=dataViewsSegment.getIntfSegmentIntfDataView(intfDataViewSegment);var tempintfDataView=angular.copy(intfDataView);if(null==tempintfDataView)tempintfDataView={dataViewInfo:{dataViewGroupId:"",dataViewTaskInfoId:"",name:"",dataViewType:DataViewType.dvDefault,dataViewDefinitionId:""},intfInfo:intf,intfPosList:[{posName:DataViewPosName.intfPos0,posInfo:{dataUnitList:[{type:DataUnitSourceType.uSrcGDR,uId:intf.intfDisplaySchemaObj.schema,value:intf.intfDisplaySchemaObj.value,valueType:DataUnitType.uString,unit:"",perfix:"",valueExpr:""}],displayTemplate:"",displayInfo:intf.intfDisplaySchemaObj.value,isCustomize:!1,isLock:!1}}]};else try{tempintfDataView.intfInfo.intf.intfDisplaySchemaObj.value=intf.isSite?intf.borderDeviceName+"("+tempintfDataView.intfInfo.intf.intfDisplaySchemaObj.value+")":tempintfDataView.intfInfo.intf.intfDisplaySchemaObj.value}catch(e){console.error(e)}return tempintfDataView};AddDevicesOp.prototype.doAddDevices=function(devInfoList,nbrInfoList,dataViewsSegment,sitePropertie,applyDataViewSrvc,mediaInfosSegment,drawLocation){var addedNodeKeys=[];var netmap=this._netmap;var transactionName=NgUtil.getUniqueStr("add devices");netmap._diagram.startTransaction(transactionName);this.addLinkedDevicesOnDiagram(nbrInfoList,dataViewsSegment,sitePropertie,addedNodeKeys,drawLocation);this.addDevicesOnDiagram(devInfoList,dataViewsSegment,sitePropertie,mediaInfosSegment,addedNodeKeys,drawLocation,nbrInfoList);var devIds=[];var segmentInList=dataViewsSegment.getDevDataViewSegmentList();for(var i in segmentInList){var item=segmentInList[i];devIds.push(item.devId)}applyDataViewSrvc||(applyDataViewSrvc=angular.element(document).injector().get("nb.dataview.applyDataViewSrvc"));applyDataViewSrvc&&applyDataViewSrvc.applyDataviewsOnDevices&&applyDataViewSrvc.applyDataviewsOnDevices(devIds,null,netmap,!1,!0);netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction(transactionName);netmap._diagram.clearSelection();var netmapOperator=netmap.getNetmapOperator();null!=netmapOperator&&netmapOperator.selectNodes(addedNodeKeys)};AddDevicesOp.prototype.addDevicesOnDiagram=function(devInfoList,dataViewsSegment,sitePropertie,mediaInfosSegment,addedNodeKeys,drawLocation,nbrInfoList){var netmap=this._netmap;var transactionName=NgUtil.getUniqueStr("add devices on diagram");netmap._diagram.startTransaction(transactionName);var compDevLast=null;for(var i in devInfoList){var devId=devInfoList[i].id;var devDataView=null;var compDev=null;if(devInfoList[i].isSite){var site=sitePropertie.getSitePropertieById(devId);compDev=this._getCompSite(site)}else if(devInfoList[i].isMedia){var media=mediaInfosSegment.getMediaInfoById(devId);compDev=this._getCompMedia(media)}else{devDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(devId);compDev=this._getCompDevice(devDataView);devInfoList[i].hostName&&(compDev.hostName=devInfoList[i].hostName)}if(null!=compDev){if(null==netmap._model.findNodeDataForKey(compDev.getKey())){var ptProperPos=null;ptProperPos=drawLocation;devInfoList[i].location&&(ptProperPos=new go.Point(devInfoList[i].location.x,devInfoList[i].location.y));null!=compDevLast&&(ptProperPos=netmap._findProperNeighborPosition(compDevLast));null==ptProperPos&&(ptProperPos=netBrain.Map.GoDiagramPositionUtil.getPosRet(this._netmap._diagram));null!=compDev&&compDev.setLocation(go.Point.stringify(ptProperPos));netmap.getNetmapOperator().addDevice(compDev);null!=compDev.getKey()&&addedNodeKeys.push(compDev.getKey())}compDevLast=compDev}}netmap._diagram.commitTransaction(transactionName)};AddDevicesOp.prototype.addLinkedDevicesOnDiagram=function(nbrInfoList,dataViewsSegment,sitePropertie,addedNodeKeys,drawLocation){var netmap=this._netmap;var transactionName=NgUtil.getUniqueStr("add linked devices on diagram");netmap._diagram.startTransaction(transactionName);if(nbrInfoList&&nbrInfoList.length>0)for(var i in nbrInfoList){var nbrInfo=nbrInfoList[i];var tempNbrInfo=new CNeighborInfo(nbrInfo.id,nbrInfo.nbrId,nbrInfo.intf,nbrInfo.nbrIntf,nbrInfo.topoTypeId,nbrInfo.isP2P,nbrInfo.mediaId,nbrInfo.mediaInfo);var srcborderDeviceNameAndintfObj={intfDisplaySchemaObj:nbrInfo.intf.intfDisplaySchemaObj,intfKeyObj:nbrInfo.intf.intfKeyObj,borderDeviceName:nbrInfo.borderDeviceName?nbrInfo.borderDeviceName:nbrInfo.devName,isSite:nbrInfo.id!==nbrInfo.devId};var destborderDeviceNameAndintfObj={intfDisplaySchemaObj:nbrInfo.nbrIntf.intfDisplaySchemaObj,intfKeyObj:nbrInfo.nbrIntf.intfKeyObj,borderDeviceName:nbrInfo.nbrName?nbrInfo.nbrName:nbrInfo.nbrDevName,isSite:nbrInfo.nbrId!==nbrInfo.nbrDevId};var srcIntfDataView=this._getIntfDataView(nbrInfo.devId,srcborderDeviceNameAndintfObj,nbrInfo.topoTypeId,dataViewsSegment);tempNbrInfo.setSrcIntfDataView(srcIntfDataView);var destIntfDataView=this._getIntfDataView(nbrInfo.nbrDevId,destborderDeviceNameAndintfObj,nbrInfo.topoTypeId,dataViewsSegment);tempNbrInfo.setDestIntfDataView(destIntfDataView);tempNbrInfo.setSrcDevId(nbrInfo.devId);tempNbrInfo.setDestDevId(nbrInfo.nbrDevId);var srcDevDataView=null;var destDevDataView=null;var srcCompDev=null;var destCompDev=null;var site;if(nbrInfo.devId===nbrInfo.id){srcDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbrInfo.id);srcCompDev=this._getCompDevice(srcDevDataView)}else{site=sitePropertie.getSitePropertieById(nbrInfo.id);srcCompDev=this._getCompSite(site)}if(nbrInfo.nbrDevId===nbrInfo.nbrId){destDevDataView=dataViewsSegment.getDevSegmentDevDataViewByDevId(nbrInfo.nbrId);destCompDev=this._getCompDevice(destDevDataView)}else{site=sitePropertie.getSitePropertieById(nbrInfo.nbrId);destCompDev=this._getCompSite(site)}if(null!=srcCompDev&&null!=destCompDev){var srcDevKey=srcCompDev.getKey();if(!netmap._model.findNodeDataForKey(srcDevKey)){if(drawLocation){srcCompDev.setLocation(go.Point.stringify(drawLocation));drawLocation=null}else{var loc=netmap._findProperNeighborPosition(destCompDev);srcCompDev.setLocation(go.Point.stringify(loc))}netmap.getNetmapOperator().addDevice(srcCompDev);null!=srcCompDev.key&&addedNodeKeys.push(srcCompDev.key)}if("Site"===srcCompDev.category&&"Site"===destCompDev.category){if(srcCompDev.getParentPath().length>=destCompDev.getParentPath().length){for(var k in destCompDev.getParentPath())destCompDev.getParentPath()[k]!==srcCompDev.getKey()&&srcCompDev.getParentId();if(destCompDev.getKey()===srcCompDev.getParentId())continue}else if(srcCompDev.getParentPath().length<=destCompDev.getParentPath().length){for(var h in srcCompDev.getParentPath())srcCompDev.getParentPath()[h]!==destCompDev.getKey()&&destCompDev.getParentId();if(srcCompDev.getKey()===destCompDev.getParentId())continue}}var linkLines;var ptProperPos;if(nbrInfo.isP2P){if(null==netmap._model.findNodeDataForKey(destCompDev.getKey())){null==(ptProperPos=netmap._findProperNeighborPosition(srcCompDev))&&(ptProperPos=new go.Point(500,500));null!=destCompDev&&destCompDev.setLocation(go.Point.stringify(ptProperPos));netmap.getNetmapOperator().addDevice(destCompDev);null!=destCompDev.key&&addedNodeKeys.push(destCompDev.key)}linkLines=[];netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);for(var u in linkLines)netmap.getNetmapOperator().addLinkLine(linkLines[u])}else{var bSrcDevMedia=netBrain.Map.gMediaTypeMgr.isMediaType(srcCompDev.getDevType());var bDestDevMedia=netBrain.Map.gMediaTypeMgr.isMediaType(destCompDev.getDevType());if(bSrcDevMedia||bDestDevMedia){linkLines=[];netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);for(var v in linkLines)netmap.getNetmapOperator().addLinkLine(linkLines[v])}else{var lanJsonObj=null;if(!netmap.getNetmapOperator()._isNeatUpMedia(tempNbrInfo.getNeat())){var compMedia=netmap.getNetmapOperator()._buildCompMediaByInfo(tempNbrInfo.getMediaName(),tempNbrInfo.getMedia(),tempNbrInfo.getMediaType(),tempNbrInfo.getMediaTopoType());if(null==compMedia)continue;lanJsonObj=compMedia;if(null==netmap._model.findNodeDataForKey(compMedia.getKey())){null==(ptProperPos=netmap._findProperNeighborPosition(srcCompDev))&&(ptProperPos=new go.Point(500,500));null!=compMedia&&compMedia.setLocation(go.Point.stringify(ptProperPos));netmap._addNode(compMedia.getJsData());null!=compMedia.key&&addedNodeKeys.push(compMedia.key)}}if(null==netmap._model.findNodeDataForKey(destCompDev.getKey())){null==(ptProperPos=null!=lanJsonObj?netmap._findProperNeighborPosition(lanJsonObj):netmap._findProperNeighborPosition(srcCompDev))&&(ptProperPos=new go.Point(500,500));null!=destCompDev&&destCompDev.setLocation(go.Point.stringify(ptProperPos));netmap.getNetmapOperator().addDevice(destCompDev);null!=destCompDev.key&&addedNodeKeys.push(destCompDev.key)}linkLines=[];netmap.getNetmapOperator()._buildLinkLineByNbrInfo(srcCompDev,destCompDev,tempNbrInfo,linkLines);for(var e in linkLines)netmap.getNetmapOperator().addLinkLine(linkLines[e])}}}}netmap._diagram.commitTransaction(transactionName)};AddDevicesOp.prototype.addDevices=function(httpExternNbrSrvc,devInfoList,topoTypeId,nbrSite,nbrList,applyDataViewSrvc,drawLocation,avoidBlockUI){if(null!=devInfoList&&0!==devInfoList.length){var topoType=topoTypeId||"L3_Topo_Type";if(!this.isDoable())return!1;if(null!=this._netmap){var deferred=this._q.defer();var context=this;httpExternNbrSrvc.getNbrLinkInfosAndDataViewsSegment(null,devInfoList,nbrList,topoType,nbrSite,!1,netBrain.Map.Const.AutolinkType.LinkLimit,avoidBlockUI).then((function(result){if(null!=result){result.linkInfos=_.uniq(result.linkInfos,!1,(function(item){return item.devId+item.nbrId+item.topoTypeId}));Object.setPrototypeOf(result.dataViewsSegment,new DataViewsSegment);Object.setPrototypeOf(result.sitePropertie,new SitePropertie);Object.setPrototypeOf(result.mediaInfosSegment,new MediaInfosSegment);context.doAddDevices(devInfoList,result.linkInfos,result.dataViewsSegment,result.sitePropertie,applyDataViewSrvc,result.mediaInfosSegment,drawLocation);deferred.resolve()}else deferred.reject()}),(function(){deferred.reject("Failed call addDevices")}));return deferred.promise}}};AddDevicesOp.prototype.buildSitesInfos=function(allSitesList,siteInfoList,sitePropertiesList,nbrInfoList){allSitesList.forEach((function(site){siteInfoList.push({id:site.ID,isSite:!0});sitePropertiesList.push({ID:site.ID,name:site.name,siteCategory:site.siteCategory,deviceCount:site.deviceCount});null!=site.parentId&&""!==site.parentId&&nbrInfoList.push({id:site.parentId,devId:null,inft:null,nbrId:site.ID,nbrDevId:null,nbrIntf:null,mediaId:null})}));return!0};netBrain.Map=netBrain.Map||{};netBrain.Map.AddDevicesOp=AddDevicesOp}(NetBrain);!function(netBrain){var AddDevicesReadonlyOp=function(){netBrain.Map.AddDevicesOp.call(this)};(AddDevicesReadonlyOp.prototype=new netBrain.Map.AddDevicesOp).isDoable=function(){return!1};netBrain.Map=netBrain.Map||{};netBrain.Map.AddDevicesReadonlyOp=AddDevicesReadonlyOp}(NetBrain);!function(netBrain){var AddDevicesStandardOp=function(){netBrain.Map.AddDevicesOp.call(this)};AddDevicesStandardOp.prototype=new netBrain.Map.AddDevicesOp;netBrain.Map=netBrain.Map||{};netBrain.Map.AddDevicesStandardOp=AddDevicesStandardOp}(NetBrain);function CNeighborInfo(from,to,srcIntf,destIntf,topoType,isP2P,mediaId,mediaInfo,srcDevType,destDevType,srcHostName,destHostName,isPortChannel){var nbrInfo={from:from,to:to,topoType:topoType,isP2P:isP2P,srcIntf:srcIntf,destIntf:destIntf,mediaId:mediaId,mediaInfo:mediaInfo,srcDevType:srcDevType,destDevType:destDevType,srcHostName:srcHostName,destHostName:destHostName,srcIntfDataView:null,destIntfDataView:null,srcDevId:null,destDevId:null,srcHighlightDataList:null,destHighlightDataList:null,isPortChannel:isPortChannel};this._nbrInfo=nbrInfo}CNeighborInfo.prototype={constructor:CNeighborInfo,getFromKey:function(){return this._nbrInfo.from},setFromKey:function(obj){this._nbrInfo.from=obj},getToKey:function(){return this._nbrInfo.to},setToKey:function(obj){this._nbrInfo.to=obj},getTopoType:function(){return this._nbrInfo.topoType},setTopoType:function(obj){this._nbrInfo.topoType=obj},getIsP2P:function(){return this._nbrInfo.isP2P},setIsP2P:function(obj){this._nbrInfo.isP2P=obj},getJsData:function(){return this._nbrInfo},getMedia:function(){return this._nbrInfo.mediaId},setMedia:function(obj){this._nbrInfo.mediaId=obj},getMediaInfo:function(){return this._nbrInfo.mediaInfo},setMediaInfo:function(obj){this._nbrInfo.mediaInfo=obj},getMediaType:function(){return null==this._nbrInfo.mediaInfo?null:this._nbrInfo.mediaInfo.mediaType},getMediaTopoType:function(){return null==this._nbrInfo.mediaInfo?null:this._nbrInfo.mediaInfo.topoType},getMediaName:function(){var nameArray=[];if(null==this._nbrInfo.mediaInfo)return null;nameArray.push(this._nbrInfo.mediaInfo.mediaName);this._nbrInfo.mediaInfo.vrf&&nameArray.push("VRF: "+this._nbrInfo.mediaInfo.vrf);this._nbrInfo.mediaInfo.hsrp&&nameArray.push(this._nbrInfo.mediaInfo.hsrp);return nameArray},getSrcDisplayInfo:function(){return null==this._nbrInfo.srcIntf?null:this._nbrInfo.srcIntf.intfDisplaySchemaObj.value},getDestDisplayInfo:function(){return null==this._nbrInfo.destIntf?null:this._nbrInfo.destIntf.intfDisplaySchemaObj.value},getSrcIntfValue:function(){return null==this._nbrInfo.srcIntf?null:this._nbrInfo.srcIntf.intfKeyObj.value},getDestIntfValue:function(){return null==this._nbrInfo.destIntf?null:this._nbrInfo.destIntf.intfKeyObj.value},getSrcIntf:function(){return this._nbrInfo.srcIntf},setSrcIntf:function(obj){this._nbrInfo.srcIntf=obj},getDestIntf:function(){return this._nbrInfo.destIntf},setDestIntf:function(obj){this._nbrInfo.destIntf=obj},getSrcDevType:function(){return this._nbrInfo.srcDevType},setSrcDevType:function(obj){this._nbrInfo.srcDevType=obj},getDestDevType:function(){return this._nbrInfo.destDevType},setDestDevType:function(obj){this._nbrInfo.destDevType=obj},getSrcHostName:function(){return this._nbrInfo.srcHostName},setSrcHostName:function(obj){this._nbrInfo.srcHostName=obj},getDestHostName:function(){return this._nbrInfo.destHostName},setDestHostName:function(obj){this._nbrInfo.destHostName=obj},getSrcIntfDataView:function(){return this._nbrInfo.srcIntfDataView},setSrcIntfDataView:function(obj){this._nbrInfo.srcIntfDataView=obj},getDestIntfDataView:function(){return this._nbrInfo.destIntfDataView},setDestIntfDataView:function(obj){this._nbrInfo.destIntfDataView=obj},getSrcDevId:function(){return this._nbrInfo.srcDevId},setSrcDevId:function(obj){this._nbrInfo.srcDevId=obj},getDestDevId:function(){return this._nbrInfo.destDevId},setDestDevId:function(obj){this._nbrInfo.destDevId=obj},getNeat:function(){return null!=this._nbrInfo.mediaInfo&&this._nbrInfo.mediaInfo.neat},getSrcHighlightDataList:function(){return this._nbrInfo.srcHighlightDataList},setSrcHighlightDataList:function(obj){this._nbrInfo.srcHighlightDataList=obj},getDestHighlightDataList:function(){return this._nbrInfo.destHighlightDataList},setDestHighlightDataList:function(obj){this._nbrInfo.destHighlightDataList=obj},getCategory:function(){return this._nbrInfo.category},setCategory:function(category){this._nbrInfo.category=category},setIsPortChannel:function(obj){this._nbrInfo.isPortChannel=obj},getIsPortChannel:function(){return this._nbrInfo.isPortChannel},getSrcIntfSMode:function(){return null==this._nbrInfo.srcIntf?null:this._nbrInfo.srcIntf.mode},getDestIntfMode:function(){return null==this._nbrInfo.destIntf?null:this._nbrInfo.destIntf.mode},getSrcIntfVpc:function(){return null==this._nbrInfo.srcIntf?null:this._nbrInfo.srcIntf.vpc},getDestIntfVpc:function(){return null==this._nbrInfo.destIntf?null:this._nbrInfo.destIntf.vpc}};!function(netBrain){var CNetMapJsWrapper=function(title,pageId,active){var data={ID:NgUtil.getGUID(),changedToDefaultDataview:[],deviceRemovedNote:[],docType:NgDocType.Page,netMapType:netBrain.Map.Const.NetmapType.l3Map,width:500,heigh:400,bkColor:"white",viewportPosition:"0 0",readOnly:!1,title:"Page1",active:!1,description:"",mapViewOption:null,mapAutoLinkOptionDict:{},mapAutoLinkOptionExcluedeMip:!0,l2Style:!1,layoutStyle:1,topologyType:netBrain.Map.Const.NetmapTopoLogy.general,nodeDataArray:[],linkDataArray:[],modelData:{space:1},MultiPathObjs:{},displayMode:netBrain.Map.Const.NetmapDisplayMode.switchMode,isNeatUp:!1,pageExtraData:{image:"",imageSize:{}},isFirstView:!1,isFrom6X:!1,l3StyleInExpandedStyle:null,highlightMode:-1,mapLegend:null,creator:gUserName,createTm:null,lastUpdateTime:null,updatedBy:gUserName,extendData:{extendRunbookData:{runbookId:"",runbookNodeName:"",runbookNodeId:"",runbookNodeResultName:"",runbookNodeResultId:"",lastUpdateTime:new Date},extendDataViewTemplateData:{dataViewTemplatePath:"",dataViewTemplateId:""},extendDataViewData:{dataViewName:"",dataViewId:"",dataViewGroupScope:"",lastUpdateTime:new Date}}};this.pageData=data};CNetMapJsWrapper.prototype={constructor:CNetMapJsWrapper,resetJsData:function(jsData){this.pageData=jsData;this.getExtendData()||this.setExtendData(this.getDefaultExtendData())},getRefData:function(){return this.pageData},getJsData:function(){var newJson=null;try{newJson=NgUtil.cloneJson(this.pageData)}catch(e){console.error(e)}return newJson},getChangedToDefaultDataview:function(){return this.pageData.changedToDefaultDataview},getDeviceRemovedNote:function(){return this.pageData.deviceRemovedNote},getL3StyleInExpandedStyle:function(){return this.pageData.l3StyleInExpandedStyle},setL3StyleInExpandedStyle:function(arr){this.pageData.l3StyleInExpandedStyle=arr},getInterfaceHighlightMode:function(){return this.pageData.highlightMode},setInterfaceHighlightMode:function(mode){this.pageData.highlightMode=mode},getVersion:function(){return this.pageData.version},getNetMapType:function(){return this.pageData.netMapType},setNetMapType:function(obj){this.pageData.netMapType=obj},getWidth:function(){return this.pageData.width},getHeight:function(){return this.pageData.height},getBkColor:function(){return this.pageData.bkColor},setBkColor:function(strCssColor){this.pageData.bkColor=strCssColor},getPageId:function(){return this.pageData.ID},setPageId:function(pageId){this.pageData.ID=pageId},isReadOnly:function(){return this.pageData.readOnly},setReadOnly:function(bReadOnly){this.pageData.readOnly=bReadOnly},getTitle:function(){return this.pageData.title},setTitle:function(title){this.pageData.title=title},getDescription:function(){return this.pageData.description},setDescription:function(strDescription){this.pageData.description=strDescription},isL2Style:function(){return this.pageData.l2Style},setL2Style:function(bIsL2Style){this.pageData.l2Style=bIsL2Style},getMapViewOption:function(){return this.pageData.mapViewOption},setMapViewOption:function(mapViewOptionJson){this.pageData.mapViewOption=mapViewOptionJson;mapViewOptionJson&&(this.pageData.isNeatUp=mapViewOptionJson.isNeatUp)},addAttachment:function(obj){if(null==this.pageData.pageExtraData)return!1;if(null==this.pageData.pageExtraData.docs)return!1;this.pageData.pageExtraData.docs.push(obj);return!0},getNodeDataArray:function(){return this.pageData.nodeDataArray},setNodeDataArray:function(nodeDataArray){this.pageData.nodeDataArray=nodeDataArray},getLinkDataArray:function(){return this.pageData.linkDataArray},setLinkDataArray:function(linkDataArray){this.pageData.linkDataArray=linkDataArray},setImage:function(obj){if(null==this.pageData.pageExtraData)return!1;this.pageData.pageExtraData.image=obj;return!0},getImage:function(){return null==this.pageData.pageExtraData?null:null==this.pageData.pageExtraData.image?null:this.pageData.pageExtraData.image},setImageSize:function(obj){var pageExtraData=NgUtil.getValueFromObjAndPath(this,"pageData.pageExtraData");var flag=!1;if(pageExtraData){pageExtraData.imageSize=obj;flag=!0}return flag},getImageSize:function(){return NgUtil.getValueFromObjAndPath(this,"pageData.pageExtraData.imageSize")},setActive:function(status){this.pageData.active=status},getActive:function(){return this.pageData.active},addMultiPath:function(key,value){if(null!=key&&null!=value){null==this.pageData.MultiPathObjs&&(this.pageData.MultiPathObjs={});this.pageData.MultiPathObjs[key]=value}},getOneMultiPathByKey:function(key){if(null!=key){null==this.pageData.MultiPathObjs&&(this.pageData.MultiPathObjs={});return this.pageData.MultiPathObjs[key]}},clearMultiPath:function(key){null!=this.pageData.MultiPathObjs&&null!=key?delete this.pageData.MultiPathObjs[key]:this.pageData.MultiPathObjs={}},getUpdatedBy:function(){return this.pageData.updatedBy},setUpdatedBy:function(obj){this.pageData.updatedBy=obj},getCreateTm:function(){return this.pageData.createTm},getLastUpdateTime:function(){return this.pageData.lastUpdateTime},getModelData:function(){return this.pageData.modelData},setModelData:function(obj){this.pageData.modelData=obj},getSpace:function(){return null==this.pageData.modelData?null:this.pageData.modelData.space},setSpace:function(obj){null==this.pageData.modelData?this.pageData.modelData={space:obj}:this.pageData.modelData.space=obj},setViewportPosition:function(strPosition){this.pageData.viewportPosition=strPosition},getViewportPosition:function(){return this.pageData.viewportPosition},setDisplayMode:function(obj){this.pageData.displayMode=obj;"pinMode"!==obj&&this.pageData.appliedDataviews&&_.isArray(this.pageData.appliedDataviews)&&this.pageData.appliedDataviews.length>0&&(this.pageData.appliedDataviews=[_.last(this.pageData.appliedDataviews)])},getDisplayMode:function(){return this.pageData.displayMode},setIsNeatUp:function(obj){this.pageData.isNeatUp=obj},getIsNeatUp:function(){return this.pageData.isNeatUp},setIsFirstView:function(obj){this.pageData.isFirstView=obj},getIsFirstView:function(){return this.pageData.isFirstView},setIsFrom6X:function(obj){this.pageData.isFrom6X=obj},getIsFrom6X:function(){return this.pageData.isFrom6X},getApplyDataViewInfo:function(){console.warn("do't use this method,please use getExtendData");return null},getLastAppliedDataView:function(){console.warn("do't use this method,please use getExtendData");return this.getAllAppliedDataViews()},getAllAppliedDataViews:function(){console.warn("do't use this method,please use getExtendData");return this.pageData.extendData&&this.pageData.extendData.extendDataViewData?this.pageData.extendData.extendDataViewData:null},setApplyDataViewInfo:function(obj){console.warn("do't use this method,please use setExtendData")},getApplyDataViewTemplate:function(){console.warn("do't use this method,please use getExtendData");return this.pageData.extendData&&this.pageData.extendData.extendDataViewTemplateData?this.pageData.extendData.extendDataViewTemplateData:null},setApplyDataViewTemplate:function(obj){console.warn("do't use this method,please use setExtendData")},removeApplyDataViewTemplate:function(obj){this.removeAllAppliedDataViewInfos();console.warn("do't use this method,please use setExtendData")},clearDataViewTemplate:function(){this.removeAllAppliedDataViewInfos();console.warn("do't use this method,please use setExtendData")},removeAppliedDataViewInfo:function(dv){this.removeAllAppliedDataViewInfos();console.warn("do't use this method,please use setExtendData")},removeAppliedDataViewInfoById:function(dvgId){this.removeAllAppliedDataViewInfos();console.warn("do't use this method,please use setExtendData")},removeAllAppliedDataViewInfos:function(){var defaultExtendData=this.getDefaultExtendData();this.setExtendData(defaultExtendData);console.warn("do't use this method,please use setExtendData")},removeAllAppliedDataViewInfosExceptById:function(dvgId){this.removeAllAppliedDataViewInfos();console.warn("do't use this method,please use setExtendData")},isAppliedDataView:function(){console.warn("do't use this method,please use setExtendData");return this.pageData.extendData&&this.pageData.extendData.extendDataViewData&&this.pageData.extendData.extendDataViewData.dataViewId},isAppliedDataViewsContains:function(dvgId){console.warn("do't use this method,please use setExtendData");return this.pageData.extendData&&this.pageData.extendData.extendDataViewData&&this.pageData.extendData.extendDataViewData.dataViewId===dvgId},isMonitoring:function(){return this.pageData.isMonitoring},setIsMonitoring:function(obj){this.pageData.isMonitoring=obj},getTopologyType:function(){return this.pageData.topologyType},setTopologyType:function(obj){this.pageData.topologyType=obj},setMapLegend:function(obj){this.pageData.mapLegend=obj},getMapLegend:function(){return this.pageData.mapLegend},setExtendData:function(obj){this.pageData.extendData=obj},getExtendData:function(){return this.pageData.extendData},getExtendDataViewData:function(){return this.pageData.extendData?this.pageData.extendData.extendDataViewData:null},getExtendDataViewTemplateData:function(){return this.pageData.extendData?this.pageData.extendData.extendDataViewTemplateData:null},getExtendRunbookData:function(){return this.pageData.extendData?this.pageData.extendData.extendRunbookData:null},getDefaultExtendData:function(){return{extendRunbookData:{runbookId:"",runbookNodeName:"",runbookNodeId:"",runbookNodeResultName:"",runbookNodeResultId:"",lastUpdateTime:new Date},extendDataViewTemplateData:{dataViewTemplatePath:"",dataViewTemplateId:""},extendDataViewData:{dataViewName:"",dataViewId:"",dataViewGroupScope:"",lastUpdateTime:new Date}}},setMapAutoLinkOptionExcluedeMip:function(obj){this.pageData.mapAutoLinkOptionExcluedeMip=obj},getMapAutoLinkOptionExcluedeMip:function(){return this.pageData.mapAutoLinkOptionExcluedeMip},setMapAutoLinkOptionList:function(obj,vspaceId){this.pageData.mapAutoLinkOptionDict||(this.pageData.mapAutoLinkOptionDict={});vspaceId||(vspaceId=VisualSpaceConstant.defaultVisualSpaceInstanceId);this.pageData.mapAutoLinkOptionDict[vspaceId]=obj},getMapAutoLinkOptionList:function(vspaceId){if(!this.pageData.mapAutoLinkOptionDict)return this.pageData.mapAutoLinkOptionList&&vspaceId===VisualSpaceConstant.defaultVisualSpaceInstanceId?this.pageData.mapAutoLinkOptionList:null;null===vspaceId&&(vspaceId=VisualSpaceConstant.defaultVisualSpaceInstanceId);return this.pageData.mapAutoLinkOptionDict[vspaceId]},isMapAutoLinkOptionListEmpty:function(){return null===this.pageData.mapAutoLinkOptionDict||void 0===this.pageData.mapAutoLinkOptionDict||_.isEmpty(this.pageData.mapAutoLinkOptionDict)},setVisualSpaceInfo:function(visualSpaceInfo){this.pageData.visualSpaceInfo=visualSpaceInfo},getVisualSpaceInfo:function(){return this.pageData.visualSpaceInfo},setVisioInfos:function(visioInfos){this.pageData.visioInfos=visioInfos}};netBrain.Map=netBrain.Map||{};netBrain.Map.CNetMapJsWrapper=CNetMapJsWrapper}(NetBrain);!function(netBrain){var CQMapJsWrapper=function(titleIndex){var data={ID:NgUtil.getGUID(),title:"Map"+titleIndex,creator:gUserName,updatedBy:gUserName,createTm:null,modifyTm:null,active:!1,version:netBrain.Map.Const.CurrentVersion,locked:!1,mapType:netBrain.Map.Const.MapType.general,editRight:gUserName+":"+gUserId,editor:{opUserId:gUserId,opUser:gUserName},status:0,pageList:[]};this.qmapdata=data};CQMapJsWrapper.prototype={constructor:CQMapJsWrapper,resetJsData:function(jsData){this.qmapdata=jsData},getJsData:function(){return this.qmapdata},getTitle:function(){return this.qmapdata.title},setTitle:function(title){this.qmapdata.title=title},getMapId:function(){return this.qmapdata.ID},setMapId:function(mapId){this.qmapdata.ID=mapId},getActive:function(){return this.qmapdata.active},setActive:function(active){this.qmapdata.active=active},isLock:function(){null==this.qmapdata.locked&&(this.qmapdata.locked=!1);return this.qmapdata.locked},setLock:function(bLock){this.qmapdata.locked=bLock},newPageData:function(pageId){this.addPageData("Page 1",pageId,!0);this.addPageData("+",null,!1)},addPageData:function(title,pageId,active){var newPageObj=new CNetMapJsWrapper(title,pageId,active);this.qmapdata.pageList.push(newPageObj.getJsData())},addMapPageData:function(mapPageData){this.qmapdata.pageList.push(mapPageData)},removeMapPageData:function(ind){if(1!==this.qmapdata.pageList.length){ind>0?this.qmapdata.pageList[ind-1].active=!0:ind>=0&&(this.qmapdata.pageList[ind+1].active=!0);this.qmapdata.pageList.splice(ind,1)}},removeAllPage:function(){this.qmapdata.pageList=[]},removePageData:function(ind){if(1!==this.qmapdata.pageList.length){ind>0?this.qmapdata.pageList[ind-1].active=!0:ind>=0&&(this.qmapdata.pageList[ind+1].active=!0);this.qmapdata.pageList.splice(ind,1)}},removeAllPageData:function(mapId){this.qmapdata.pageList.splice(0,this.qmapdata.pageList.length);this.qmapdata.pageList=[];this.qmapdata.pageList.length=0},getNetMapJsData:function(pageId){var tempJsData=null;angular.forEach(this.qmapdata.pageList,(function(obj){obj._id===pageId&&"+"!==obj.title&&(tempJsData=obj)}),null);return tempJsData},getPageList:function(){return this.qmapdata.pageList},getPageCount:function(){return this.qmapdata.pageList.length},getCreator:function(){return this.qmapdata.creator},setCreator:function(obj){this.qmapdata.creator=obj},getUpdatedBy:function(){return this.qmapdata.updatedBy},setUpdatedBy:function(obj){this.qmapdata.updatedBy=obj},getCreateTm:function(){return this.qmapdata.createTm},getModifyTm:function(){return this.qmapdata.modifyTm},getEditRight:function(){try{return this.qmapdata.editor&&this.qmapdata.editor.opUserId?{editorName:this.qmapdata.editor.opUser,editorId:this.qmapdata.editor.opUserId}:{editorName:"",editorId:""}}catch(ex){console.error(ex.toString());return""}},setEditRight:function(userName,userId){userName=userName||"";userId=userId||"";this.qmapdata.editor={opUserId:userId,opUser:userName,opTime:(new moment).toISOString()}},getStatus:function(){return this.qmapdata.status},setStatus:function(obj){this.qmapdata.status=obj},getRefDocList:function(){return this.qmapdata.refDocList},setRefDocList:function(obj){this.qmapdata.refDocList=obj},getFromMapId:function(){return this.qmapdata.fromMapId},setFromMapId:function(obj){this.qmapdata.fromMapId=obj},addRefDoc:function(obj){null==this.qmapdata.refDocList&&(this.qmapdata.refDocList=[]);for(var i=0;i<this.qmapdata.refDocList.length;i++){if(this.qmapdata.refDocList[i].ID===obj.ID)return}this.qmapdata.refDocList.push(obj)},getMapType:function(){return this.qmapdata.mapType},setMapType:function(obj){this.qmapdata.mapType=obj},getVersion:function(){return this.qmapdata.version},setVersion:function(version){this.qmapdata.version=version}};netBrain.Map=netBrain.Map||{};netBrain.Map.CQMapJsWrapper=CQMapJsWrapper}(NetBrain);function _defineProperty(obj,key,value){key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value;return obj}!function(netBrain){var noteMargin=10;var noteMinHeight=20+2*noteMargin;var headerMargin=new go.Margin(0,0,5,0);var contentMargin=new go.Margin(5,5,5,5);var footMargin=new go.Margin(0,0,0,0);var prefixCreateUser="Created by: ";var CompDeviceNote=function(){netBrain.Map.CompBase.call(this)};CompDeviceNote.prototype=new netBrain.Map.CompBase;CompDeviceNote.prototype.fromJson=function(noteJson){null!=noteJson&&(this.deviceNotes=noteJson)};CompDeviceNote.prototype.toJson=function(){return this};CompDeviceNote.prototype.setBorderColor=function(strCssColor){null!=strCssColor&&(this.stroke=strCssColor)};CompDeviceNote.prototype.setPosition=function(ptPoint){this.location=ptPoint.x+" "+ptPoint.y};CompDeviceNote.prototype.getPos=function(){return this.location};CompDeviceNote.prototype.getBordreColor=function(){return this.stroke};CompDeviceNote.prototype.addDeviceNote=function(strTitle,strContent){null==strTitle||null==strContent||strTitle.length<=0||strContent.length<=0||this.deviceNotes.push({noteTitle:strTitle,noteContent:strContent})};CompDeviceNote.prototype.getDeviceNoteContentByTitle=function(strTitle){for(var index=0;index<this.deviceNotes.length;index++){var noteObj=this.deviceNotes[index];if(null!=noteObj&&noteObj.noteTitle===strTitle)return noteObj.noteContent}};CompDeviceNote.getDefaultJsonData=function(isExpand){null==isExpand&&(isExpand=!0);var height=171;isExpand||(height=noteMinHeight);return{key:NgUtil.getGUID(),category:netBrain.Map.CategoryMgr.DeviceNote,titleFont:BindHelper.defaultNoteTitleFont,titleIsStrikethrough:!1,titleIsUnderline:!1,titleTextAlign:"left",titleStroke:-2,font:BindHelper.defaultNoteContentFont,bottomFont:BindHelper.defaultNoteContentFont,isStrikethrough:!1,isUnderline:!1,textAlign:NetBrain.Map.Const.Align.Left,stroke:-2,bgColor:-2,borderColor:-2,isExpand:isExpand,noteType:netBrain.Map.Const.NoteType.Append,noteFromType:netBrain.Map.Const.NoteFromType.Normal,isShowLink:!1,linkExtendData:null,isCompound:!1,size:{width:350,height:height}}};CompDeviceNote.prototype.setData=function(obj,diagram){obj.title?this.noteTitle=obj.title:this.noteTitle="";if(obj.user){this.createdBy=prefixCreateUser+obj.user;this.lastModifyUser=obj.user}obj.time&&(this.modifyTime=TimeUtil.formatDateTime(new Date(obj.time)));this.setFont(obj.fontStyle,obj.fontVariant,obj.fontWeight,obj.fontSize,obj.fontFamily,diagram);obj.expand&&(this.isExpand=obj.expand);if(obj.content){this.noteContent=obj.content;if(this.isExpand){var lineCount=obj.content.split("\n").length;this.height=Math.min(Math.max(25*lineCount,171),570);this.size.height=this.height}else this.size.height=this.height=30}else this.noteContent="";void 0!==obj.align&&""!==obj.align&&(this.textAlign=obj.align);obj.backgroundColor&&(this.bgColor=obj.backgroundColor);obj.borderColor&&(this.borderColor=obj.borderColor);obj.forecolor&&(this.stroke=obj.forecolor);this.noteType=obj.noteType;this.noteFromType=obj.noteFromType;obj.category&&(this.category=obj.category);obj.hopId&&(this.hopId=obj.hopId);obj.pathId&&(this.pathId=obj.pathId);this.isShowLink=!!obj.isShowLink;obj.linkExtendData&&(this.linkExtendData=obj.linkExtendData);obj.isCompound&&(this.isCompound=obj.isCompound);obj.deviceIds&&(this.deviceIds=obj.deviceIds);obj.refVariables&&(this.refVariables=obj.refVariables)};CompDeviceNote.getKey=function(){return this.key};CompDeviceNote.prototype.setNoteContent=function(strNoteContent){this.noteContent=strNoteContent};CompDeviceNote.prototype.setFont=function(fontstyle,fontvariant,fontweight,fontsize,fontfamily,diagram){var fontArr=this.font.split(" ");fontfamily&&(fontArr=fontArr.slice(0,4)).push(fontfamily);fontstyle&&(fontArr[0]=fontstyle);fontvariant&&(fontArr[1]=fontvariant);fontweight&&(fontArr[2]=fontweight);fontsize&&(fontArr[3]=fontsize);diagram&&diagram.model.setDataProperty(this,"font",fontArr.join(" "))};CompDeviceNote.prototype.setFontFamily=function(fontfamily,diagram){this.setFont(null,null,null,null,fontfamily,diagram)};CompDeviceNote.prototype.setFontStyle=function(fontstyle,diagram){this.setFont(fontstyle,null,null,null,null,diagram)};CompDeviceNote.prototype.setFontWeight=function(fontweight,diagram){this.setFont(null,null,fontweight,null,null,diagram)};CompDeviceNote.prototype.setFontSize=function(fontsize,diagram){this.setFont(null,null,null,fontsize,null,diagram)};CompDeviceNote.prototype.setFontColor=function(color,diagram){diagram.model.setDataProperty(this,"stroke",color)};CompDeviceNote.prototype.setUnderLine=function(isUnLine,diagram){diagram.model.setDataProperty(this,"isUnderline",isUnLine)};CompDeviceNote.prototype.setLineThrough=function(isThrough,diagram){diagram.model.setDataProperty(this,"isStrikethrough",isThrough)};CompDeviceNote.prototype.setNoteContentToMap=function(noteContent,diagram){diagram.model.setDataProperty(this,"noteContent",noteContent)};CompDeviceNote.prototype.setPragraphAlign=function(align,diagram){diagram.model.setDataProperty(this,"textAlign",align)};CompDeviceNote.prototype.setLastModifyUser=function(lastModifyUser,diagram){this.noteFromType!==netBrain.Map.Const.NoteFromType.DataView&&diagram.model.setDataProperty(this,"lastModifyUser",lastModifyUser)};CompDeviceNote.prototype.setModifyTime=function(modifyTime,diagram){diagram.model.setDataProperty(this,"modifyTime",TimeUtil.formatDateTime(modifyTime))};CompDeviceNote.prototype.setNoteContent=function(noteContent,diagram){diagram.model.setDataProperty(this,"noteContent",noteContent)};CompDeviceNote.prototype.tryGrowHeight=function(note){var part=note.part;var content=part.findObject(CompDeviceNote.noteContentTextBlockName);var textHeight=calcHeight(content.font)*calcLineCount(content);var titleRow=part.findObject(CompDeviceNote.noteTitleTextBlockName).panel.getRowDefinition(0);var expectHeight=2*noteMargin+titleRow.height+headerMargin.top+headerMargin.bottom+textHeight+contentMargin.top+contentMargin.bottom+16+footMargin.top+footMargin.bottom;expectHeight=Math.min(630,expectHeight);var body=part.findObject("Body");expectHeight>body.height&&updateBodyHeight(body,expectHeight)};CompDeviceNote.EVENT_NAMES={DEVICE_NOTE_CONTEXT_CLICK:"COMP_DEVICE_NOTE_DEVICE_NOTE_CONTEXT_CLICK",DEVICE_NOTE_MOUSE_ENTER:"COMP_DEVICE_NOTE_DEVICE_NOTE_MOUSE_ENTER",DEVICE_NOTE_MOUSE_LEAVE:"COMP_DEVICE_NOTE_DEVICE_NOTE_MOUSE_LEAVE",NOTE_CONTENT_TEXT_CLICK:"COMP_DEVICE_NOTE_NOTE_CONTENT_TEXT_CLICK",NOTE_TITLE_OR_CONTENT_CHANGE:"COMP_DEVICE_NOTE_TITLE_OR_CONTENT_CHANGE",NOTE_EXTEND_LINK_CLICK:"COMP_DEVICE_NOTE_NOTE_EXTEND_LINK_CLICK",NOTE_DATAVIEW_DETAIL_LINK_CLICK:"COMP_DEVICE_NOTE_NOTE_DATAVIEW_DETAIL_LINK_CLICK"};CompDeviceNote.bgShapeName="bgShapeName";CompDeviceNote.noteFootUserTextBlockName="noteFootDateUserBlockName";CompDeviceNote.noteFootDateTextBlockName="noteFootDateTextBlockName";CompDeviceNote.noteContentTextBlockName="noteContentTextBlockName";CompDeviceNote.noteTitleTextBlockName="noteTopTitle";CompDeviceNote.SVG_ICON={DETAIL_PANEL_12:"M0.5,0.5 11.5,0.5 11.5,11.5 0.5,11.5Z M0.5,4.5 L0.5,5.5 L11.5,5.5 L11.5,4.5 L0.5,4.5 Z M5,9.5 L10,9.5 L9.5,9 L9.5,10 L10,9.5 L5,9.5 L5.5,10 L5.5,9 L5,9.5 Z M5,7.5 L10,7.5 L9.5,7 L9.5,8 L10,7.5 L5,7.5 L5.5,8 L5.5,7 L5,7.5 Z M2,9.5 L4,9.5 L3.5,9 L3.5,10 L4,9.5 L2,9.5 L2.5,10 L2.5,9 L2,9.5 Z M2,7.5 L4,7.5 L3.5,7 L3.5,8 L4,7.5 L2,7.5 L2.5,8 L2.5,7 L2,7.5 Z"};var $=go.GraphObject.make;function calcHeight(font,text){return NgUtil.CanvasTools.calcHeight(font,text)}function calcLineCount(textBlock){var lineCount=0;var text=textBlock.text;var sc=textBlock.diagram.scale;var textScale=textBlock.getDocumentScale()*sc;var width=(textBlock.naturalBounds.width+textBlock.margin.left+textBlock.margin.right)*textScale;var font=textBlock.font;text.split("\n").forEach((function(str){var textWidth=calcHeight(font,str+"\n");lineCount+=Math.ceil(textWidth/width)}));return lineCount}function updateBodyHeight(body,newHeight){var originalHeight=body.height;var originalLocation=body.part.location;body.height=newHeight;var y=originalLocation.y+(body.height-originalHeight)/2;body.part.location=new go.Point(originalLocation.x,y)}CompDeviceNote.getMapTemplate=function(map,scope){var noteTextTool=new go.TextEditingTool;var expandIcons_min="M2.5,8l3.7,-4.7l3.7,4.7l-3.7,-4.7z",expandIcons_max="M2.5,5l3.7,4.7l3.7,-4.7l-3.7,4.7z";go.GraphObject.defineBuilder("MinMaxButton",(function(){return $(go.Panel,go.Panel.Auto,$(go.Shape,{desiredSize:new go.Size(12,7),name:"MinMaxButton",geometry:go.Geometry.parse(expandIcons_min),cursor:"pointer",strokeWidth:.6,strokeCap:"round",stroke:"#000000"},new go.Binding("geometry","isExpand",(function(isExpand){var icon=isExpand?expandIcons_min:expandIcons_max;return go.Geometry.parse(icon)}))),$(go.Shape,{desiredSize:new go.Size(12,10),cursor:"pointer",figure:"Rectangle",fill:"transparent",strokeWidth:0,click:function(e,s){scope.updateMapSrvc.canUpdateCurrentMap().then((function(){s.diagram.toolManager.hideToolTip();var part=s.part;var content=part.findObject("noteContent");if(null!==content){var body=part.findObject("Body");s.diagram.startTransaction("Collapse/Expand Panel");var isExpand=!part.data.isExpand;var bodyHeight=body.height;if(isExpand){var note=part.findObject("NOTE");bodyHeight=body.minSize.height+note.getRowDefinition(2).height+content.actualBounds.height}else bodyHeight=body.minSize.height;updateBodyHeight(body,bodyHeight);s.diagram.model.setDataProperty(part.data,"isExpand",isExpand);part.updateTargetBindings();s.diagram.commitTransaction("Collapse/Expand Panel")}}))},toolTip:$(go.Adornment,"Auto",$(go.Shape,{fill:"#FFFFCC"}),$(go.TextBlock,{margin:new go.Margin(12,6,12,6)},new go.Binding("text","isExpand",(function(v,node){return v?"Collapse the Content":"Expand the Content"}))))}))}));var _$;return $(CompDeviceNoteNode,"Auto",{selectionObjectName:"Body",resizeObjectName:"Body",layerName:GlobalContext.DeviceNoteLayerName,locationSpot:go.Spot.Center,contextClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceNote.EVENT_NAMES.DEVICE_NOTE_CONTEXT_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceNote.EVENT_NAMES.DEVICE_NOTE_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceNote.EVENT_NAMES.DEVICE_NOTE_MOUSE_LEAVE,event,target)}},new go.Binding("visible","isHopHide",(function(isHopHide,node){return void 0===isHopHide?node.visible:!isHopHide})),new go.Binding("resizable","isExpand"),new go.Binding("location","location",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)})).makeTwoWay((function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)})),$(go.Panel,"Auto",{name:"Body",desiredSize:new go.Size(350,171),alignment:go.Spot.Top,isPanelMain:!0,minSize:new go.Size(120,noteMinHeight)},new go.Binding("desiredSize","size",(function(size){return new go.Size(size.width,size.height)})).makeTwoWay(),$(go.Shape,"Rectangle",{name:CompDeviceNote.bgShapeName,stroke:NetBrain.Map.Const.noteDefaultBorderColor,strokeWidth:0},new go.Binding("fill","bgColor",BindHelper.colorToStringForNoteBackground).makeTwoWay(BindHelper.colorToInt)),$(go.Panel,"Table",{name:"NOTE",defaultRowSeparatorStroke:NetBrain.Map.Const.noteDefaultSeparatorColor,defaultRowSeparatorStrokeWidth:.5,stretch:go.GraphObject.Fill,margin:noteMargin,alignment:go.Spot.Top},new go.Binding("defaultRowSeparatorStroke","borderColor",BindHelper.colorToStringForNoteSeparatorColor).makeTwoWay(BindHelper.colorToInt),$(go.RowColumnDefinition,{row:1,sizing:go.RowColumnDefinition.ProportionalExtra}),$(go.RowColumnDefinition,{row:2,height:16}),$(go.Panel,"TableRow",{row:0,name:"noteTop"},$(go.Panel,"Table",{name:"noteTopPanel",column:0,stretch:go.GraphObject.Fill,rowSizing:go.RowColumnDefinition.ProportionalExtra},$(go.RowColumnDefinition,{column:0,sizing:go.RowColumnDefinition.ProportionalExtra}),$(go.RowColumnDefinition,{column:1,width:76},new go.Binding("width","noteFromType",(function(noteFromType){return BindHelper.toTarget_deviceNote_viewDetailVisible(noteFromType)?76:0}))),$(go.RowColumnDefinition,{column:2,width:0}),$(go.RowColumnDefinition,{column:3,width:12}),$(go.TextBlock,(_defineProperty(_$={name:CompDeviceNote.noteTitleTextBlockName,margin:new go.Margin(0,10,0,0),textAlign:"left",row:0,column:0,editable:!0,isMultiline:!0,stretch:go.GraphObject.Fill},"margin",headerMargin),_defineProperty(_$,"font",BindHelper.defaultNoteTitleFont),_$),createPathNoteEditableBinding(scope),new go.Binding("text","noteTitle",BindHelper.toTarget_deviceNote_leadingSpacePrefix).makeTwoWay(BindHelper.toTarget_deviceNote_noLeadingSpacePrefix),new go.Binding("stroke","titleStroke",BindHelper.colorToStringForNoteFore).makeTwoWay(BindHelper.colorToInt),new go.Binding("font","titleFont").makeTwoWay(),new go.Binding("isStrikethrough","titleIsStrikethrough").makeTwoWay(),new go.Binding("isUnderline","titleIsUnderline").makeTwoWay(),new go.Binding("textAlign","titleTextAlign",BindHelper.noteAlineToString).makeTwoWay(BindHelper.noteAlineToInt),{toolTip:$(go.Adornment,"Auto",$(go.Shape,{fill:"#FFFFCC"}),$(go.TextBlock,{margin:new go.Margin(12,6,12,6)},new go.Binding("text","noteTitle")))},new go.Binding("height","",(function(data,obj){var part=obj.panel.part;var noteTopTitle=part.findObject(CompDeviceNote.noteTitleTextBlockName);var lineCount=calcLineCount(noteTopTitle);lineCount=Math.max(lineCount,1);var textHeight=calcHeight(noteTopTitle.font)*lineCount;var headerHeight=textHeight+noteTopTitle.margin.top+noteTopTitle.margin.bottom;obj.panel.getRowDefinition(0).height=headerHeight;var noteRow0=part.findObject("NOTE").getRowDefinition(0);var isInit=void 0===noteRow0.lastHeight;noteRow0.lastHeight=isInit?headerHeight:noteRow0.height;noteRow0.height=headerHeight;var body=part.findObject("Body");var bodyMinHeight=headerHeight+2*noteMargin;body.minSize=new go.Size(body.minSize.width,bodyMinHeight);var headerHeightChange=noteRow0.height-noteRow0.lastHeight;var bodyHeight=NaN;isInit&&!part.data.isExpand?bodyHeight=body.minSize.height:isInit||0===headerHeightChange||(bodyHeight=body.height+headerHeightChange);_.isNumber(bodyHeight)&&!isNaN(bodyHeight)&&updateBodyHeight(body,bodyHeight);return textHeight}))),$(go.Panel,"Horizontal",{row:0,column:1,visible:!1,margin:new go.Margin(0,20,0,0),alignment:go.Spot.Top,background:"transparent",cursor:"pointer",click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceNote.EVENT_NAMES.NOTE_DATAVIEW_DETAIL_LINK_CLICK,event,target)}},new go.Binding("visible","noteFromType",BindHelper.toTarget_deviceNote_viewDetailVisible),$(go.Picture,{width:12,height:12,margin:new go.Margin(-1,5,0,0),source:"img/modules/qmap/detail-panel.png"}),$(go.TextBlock,{font:BindHelper.defaultNoteContentFont},"Details")),$("MinMaxButton",{row:0,column:3,alignment:go.Spot.Top}))),$(go.Panel,"TableRow",{row:1,name:"noteContent"},new go.Binding("visible","isExpand"),$(go.Panel,"Table",{column:0,stretch:go.GraphObject.Fill,rowSizing:go.RowColumnDefinition.ProportionalExtra,margin:contentMargin},$(go.RowColumnDefinition,{row:0,sizing:go.RowColumnDefinition.ProportionalExtra,separatorStrokeWidth:0}),$(go.RowColumnDefinition,{column:0}),$(go.TextBlock,{name:CompDeviceNote.noteContentTextBlockName,font:BindHelper.defaultNoteContentFont},createPathNoteEditableBinding(scope),new go.Binding("text","noteContent",BindHelper.toTarget_deviceNote_leadingSpacePrefix).makeTwoWay(BindHelper.toTarget_deviceNote_noLeadingSpacePrefix),new go.Binding("font","font").makeTwoWay(),new go.Binding("isStrikethrough","isStrikethrough").makeTwoWay(),new go.Binding("isUnderline","isUnderline").makeTwoWay(),new go.Binding("textAlign","textAlign",BindHelper.noteAlineToString).makeTwoWay(BindHelper.noteAlineToInt),new go.Binding("stroke","stroke",BindHelper.colorToStringForNoteFore).makeTwoWay(BindHelper.colorToInt),{row:0,column:0,stretch:go.GraphObject.Fill,editable:!0,isMultiline:!0,textEditor:noteTextTool.defaultTextEditor,spacingAbove:3,spacingBelow:3,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceNote.EVENT_NAMES.NOTE_CONTENT_TEXT_CLICK,event,target)},textValidation:function(node,oldValue,newValue){if(oldValue!==newValue&&formatContentText(oldValue)!==formatContentText(newValue)){var data=node.part.data;data.setLastModifyUser(window.gUserName,node.diagram);data.noteFromType!==NetBrain.Map.Const.NoteFromType.DataView&&data.setModifyTime(new Date,node.diagram)}return!0}}))),$(go.Panel,"TableRow",{row:2,name:"noteBottom"},new go.Binding("visible","isExpand"),$(go.Panel,"Table",{column:0,stretch:go.GraphObject.Fill,rowSizing:go.RowColumnDefinition.ProportionalExtra,margin:new go.Margin(0,0,0,0)},$(go.RowColumnDefinition,{row:0,sizing:go.RowColumnDefinition.ProportionalExtra,height:20,separatorStrokeWidth:0}),$(go.RowColumnDefinition,{column:0,sizing:go.RowColumnDefinition.ProportionalExtra}),$(go.RowColumnDefinition,{column:1}),$(go.RowColumnDefinition,{column:2,width:150}),$(go.TextBlock,{name:CompDeviceNote.noteFootUserTextBlockName,textAlign:"left",row:0,column:0,stretch:go.GraphObject.Fill,editable:!1,isMultiline:!1,spacingAbove:4,spacingBelow:4,margin:new go.Margin(0,10,0,3),overflow:go.TextBlock.OverflowEllipsis},new go.Binding("text","lastModifyUser"),new go.Binding("text","createdBy",(function(v,node){return isPathNote(node.part.data)?"":node.text?node.text:v=v.replace(prefixCreateUser,"")})),new go.Binding("font","bottomFont").makeTwoWay()),$(go.Panel,"Horizontal",{row:0,column:1,visible:!1,margin:new go.Margin(2,8,0,0),background:"transparent",cursor:"pointer",click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompDeviceNote.EVENT_NAMES.NOTE_EXTEND_LINK_CLICK,event,target)}},new go.Binding("visible","isShowLink"),$(go.Picture,{width:12,height:12,margin:new go.Margin(0,5,0,0),source:"img/modules/qmap/icon-nb-runbook-12.png"}),$(go.TextBlock,{font:BindHelper.defaultNoteContentFont},"Result")),$(go.TextBlock,{name:CompDeviceNote.noteFootDateTextBlockName,margin:footMargin,textAlign:"right",row:0,column:2,stretch:go.GraphObject.Fill,editable:!1,isMultiline:!1,spacingAbove:4,spacingBelow:4,overflow:go.TextBlock.OverflowEllipsis},new go.Binding("text","modifyTime",(function(time,node){return isPathNote(node.part.data)?"":isNaN(new Date(time))?time:TimeUtil.formatDateTime(new Date(time))})).makeTwoWay(),new go.Binding("font","bottomFont").makeTwoWay()))))))};function createPathNoteEditableBinding(scope){return new go.Binding("editable","",(function(data,node){var flag=!0;isPathNote(data)?flag=!1:data.noteFromType!==netBrain.Map.Const.NoteFromType.DataView||scope.isEditMode()||(flag=!1);return flag}))}function isPathNote(data){return data.noteFromType===netBrain.Map.Const.NoteFromType.Path}function formatContentText(text){text=text.replace(/\r\n/g,"\n");return text=BindHelper.toTarget_deviceNote_noLeadingSpacePrefix(text)}function CompDeviceNoteNode(){go.Node.apply(this,arguments)}go.Diagram.inherit(CompDeviceNoteNode,go.Node);CompDeviceNoteNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var bgInfo=visioTools.getShapeVisioInfo(this,CompDeviceNote.bgShapeName);visioInfos.push(bgInfo);var titleTextInfo=visioTools.getTextVisioInfo(this,CompDeviceNote.noteTitleTextBlockName);visioInfos.push(titleTextInfo);if(this.findObject("noteContent").visible){var contentTextInfo=visioTools.getTextVisioInfo(this,CompDeviceNote.noteContentTextBlockName);var noteTable=this.findObject("NOTE");var bd=visioTools.getInnerObjBounds(noteTable);var bd0=contentTextInfo.bounds;var tmpShape=new go.Shape;tmpShape.geometryString="M0 0L"+bd.width+" 0";tmpShape.stroke=noteTable.defaultRowSeparatorStroke;tmpShape.strokeWidth=noteTable.defaultRowSeparatorStrokeWidth;var separatorInfo=visioTools.getShapeInfo(tmpShape);separatorInfo.bounds={left:bd.left,top:bd0.top,right:bd.right,bottom:bd0.top+tmpShape.strokeWidth,width:bd.width,height:tmpShape.strokeWidth};visioInfos.push(separatorInfo);visioInfos.push(contentTextInfo);var footTextInfo=visioTools.getTextVisioInfo(this,CompDeviceNote.noteFootDateTextBlockName);var bd1=footTextInfo.bounds;var separatorInfo1=JSON.parse(JSON.stringify(separatorInfo));separatorInfo1.bounds.top=bd1.top;separatorInfo1.bounds.bottom=bd1.top+tmpShape.strokeWidth;visioInfos.push(separatorInfo1);visioInfos.push(footTextInfo);var footUserTextInfo=visioTools.getTextVisioInfo(this,CompDeviceNote.noteFootUserTextBlockName);visioInfos.push(footUserTextInfo)}return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};netBrain.Map=netBrain.Map||{};netBrain.Map.CompDeviceNote=CompDeviceNote}(NetBrain);!function(netBrain){var separatorArr=[];for(var i=0;i<60;i++)separatorArr.push("-");var LINE_SEPARATOR=separatorArr.join("")+"\n";function mergeContent(text1,text2){return text1+("\n"===(text=text1).slice(text.length-1)?"":"\n")+LINE_SEPARATOR+text2;var text}var noteTool={mergeDataViewNotesWithoutCompound:function(notes){notes=_.filter(notes,(function(item){return!item.isCompound}));var removeIndexes=[];var existInfo={};_.each(notes,(function(noteData,i){if(noteData.noteFromType===netBrain.Map.Const.NoteFromType.DataView){var title=noteData.title;if(_.isUndefined(existInfo[title]))existInfo[title]=i;else{var existIndex=existInfo[title];oNote=notes[existIndex],tmpNote=noteData,newContent=mergeContent(oNote.content,tmpNote.content),oNote.content=newContent;removeIndexes.push(i)}}var oNote,tmpNote,newContent}));return _.filter(notes,(function(note,index){return!_.contains(removeIndexes,index)}))},mergeDataViewCompoundNotes:function(compoundNotes){var noteObj={};_.each(compoundNotes,(function(item){var deviceId=item.deviceId;var notes=item.notes;_.each(notes,(function(note){var key=note.title+note.content;noteObj[key]?noteObj[key].deviceIds.push(deviceId):noteObj[key]={deviceIds:[deviceId],note:note}}))}));return _.values(noteObj)},mergeToOneNoteContent:function(notes){if(!_.isArray(notes)||notes.length<1)return null;if(1===notes.length)return notes[0];var content=notes[0].noteContent;_.each(notes.slice(1),(function(tmpNote){content=mergeContent(content,tmpNote.noteContent)}));return content},mergeContent:mergeContent};netBrain.Map=netBrain.Map||{};netBrain.Map.noteTool=noteTool}(NetBrain);function PathTip(netmap){var id=netmap.getDocId();this.parentDomId=id?"#"+id+"-container":document}PathTip.prototype={construct:PathTip,getPathTipCtrl:function(){var scopeElement=$(this.parentDomId).find("#PathTipId").get(0);return angular.element(scopeElement).scope()},showTip:function(ptPos,pathdata,selectHopInfo){var scopeCtrl=this.getPathTipCtrl();if(null!=scopeCtrl){scopeCtrl.showTipWindow(ptPos,pathdata,selectHopInfo);NgUtil.getRefreshWindowCallBack()}},hideTip:function(){var scopeCtrl=this.getPathTipCtrl();if(null!=scopeCtrl){scopeCtrl.hideTip();NgUtil.getRefreshWindowCallBack()}}};!function(netBrain){angular.module("nb.qmap").directive("pathTip",pathTip);pathTip.$inject=["$filter","$rootScope","nb.ng.licenseSrvc","nb.path.httpPathSrvc","nb.qmap.mapManagerSrvc","nb.miniTask.miniTaskUtilSrvc","nb.runbook.mapTargetDeviceSrvc"];function pathTip($filter,$rootScope,licenseSrvc,httpPathSrvc,mapManagerSrvc,miniTaskUtilSrvc,mapTargetDeviceSrvc){return{restrict:"EA",templateUrl:"modules/nbQmap/views/PathTip.html",scope:{},link:function(scope,element){scope.showTip=!1;scope.tipContent="";scope.pathA="";scope.pathB="";scope.tipPosition={left:"100px",top:"100px"};scope.automationLicenseOn=!1;scope.showTipWindow=function(ptPos,pathdata,selectHopInfo){var tipCSS=function(ptPos){if(null==ptPos)return null;var retCSS={};if($(element).parents(".tab-contentGoJS").width()-ptPos.x<414){retCSS.left=ptPos.x-300+"px";$(element).find(".tiparrow").css("left","330px")}else{retCSS.left=ptPos.x+"px";$(element).find(".tiparrow").css("left","30px")}retCSS.top=ptPos.y+"px";return retCSS}(ptPos);if(null!=tipCSS&&pathdata&&pathdata.hoplist){scope.automationLicenseOn=licenseSrvc.isModuleLicenseValid(NetBrain.NG.Const.LicenseModuleType.Automation);var curDataSource,datasource={2:"Current Baseline",4:"Historical Data",1:"Live Network"};if(pathdata.dataSource&&pathdata.dataSource.type)curDataSource=datasource[pathdata.dataSource.type];else if(pathdata.isLive||pathdata.isBaseline||pathdata.isHistory){pathdata.dataSource={};if(pathdata.isLive){pathdata.dataSource.type=1;curDataSource=datasource[1]}if(pathdata.isBaseline){pathdata.dataSource.type=2;curDataSource=datasource[2]}if(pathdata.isHistory){pathdata.dataSource.type=4;curDataSource=datasource[4]}}else{pathdata.dataSource={type:2};curDataSource=datasource[2]}scope.pathA=pathdata.fromDev.devName;scope.pathB=pathdata.toDev.devName;scope.pathdata=pathdata;scope.selectHopInfo=selectHopInfo;var tipconArr=[pathdata.protocolKeyWord,curDataSource,$filter("nbDateTime")(pathdata.pathTime)];scope.tipContent="("+tipconArr.join(", ")+")";scope.tipPosition=tipCSS;scope.showTip=!0;scope.$root&&scope.$root.$$phase||scope.$apply()}};scope.hideTip=function(){scope.showTip=!1;scope.$root&&scope.$root.$$phase||scope.$apply()};scope.toRunMonitor=function(){var qappAction={_id:"1cff8a8f-4272-4177-b5ef-b0bfc1a45411",type:1,bgColor:"#feefd6",border:"#f9ae1f",icon:"action_node_qapp_24",name:"Overall Health Monitor",isPathQapp:!0,actionType:1,defaultInput:JSON.stringify({qappList:[{qappId:"efeb0722-aa0b-c1cc-2dd5-1639447ab35a",qappName:"Overall Health Monitor [SNMP]",qappPath:"Built-in Qapps/Monitoring/Overall Health Monitor [SNMP]"}]}),operateInfo:{opUser:"NetBrain",opTime:"2017-12-20T08:27:38.772+08:00"},contextMenuIcon:"run-qapp-16"};mapTargetDeviceSrvc.transferData(qappAction);qappAction.action(qappAction)};scope.toViewDetail=function(){$rootScope.$emit(viewFrameEvent.toggleTopPanel,"pathResult",{isFromDiaramPath:!0,pathData:scope.pathdata,selectHopInfo:scope.selectHopInfo});scope.hideTip()};scope.toRunMap=function(){var qappAction={_id:"1cff8a8f-4272-4177-b5ef-b0bfc1a45411",type:1,bgColor:"#feefd6",border:"#f9ae1f",icon:"action_node_qapp_24",name:"Run Qapp",isPathQapp:!0,actionType:1,defaultInput:"",operateInfo:{opUser:"NetBrain",opTime:"2017-12-20T08:27:38.772+08:00"},contextMenuIcon:"run-qapp-16"};mapTargetDeviceSrvc.transferData(qappAction);qappAction.action(qappAction)};scope.addToSearchBar=function(){$rootScope.$broadcast("path-add-to-search-bar",scope.pathdata,!0)}},controller:function($rootScope,$scope){$rootScope.$on(NetBrain.Map.Event.ActivePageChanged,(function(){$scope.hideTip()}))}}}}(NetBrain);function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function CDlgExtendNeighbors(scope,compile,q,dialogService,$document){scope.extendNeighborTableSelections=[];scope.currentDataView=null;scope.currentEdgeGroup=null;scope.currentNbr=[];scope.activeNode=null;scope.showNode=null;this.isShow=!1;scope.mouseHoverWindowPined=!1;this._scope=scope;this._compile=compile;this._q=q;var activeNodeType=_typeof(scope.activeNode);this._activeNode=activeNodeType===NetBrain.Map.CompDevice?null:scope.activeNode;this._dialogService=dialogService;this._document=$document;this.haveShowExtendNbrDialogId=""}CDlgExtendNeighbors.prototype={constructor:CDlgExtendNeighbors,showExtendNbrDialog:function(event,target){if(this.isShow){this.haveShowExtendNbrDialogId!==target.part.data.ID&&this.haveShowExtendNbrDialogId!==target.part.data.key&&this.show(event,target);"Site"===this._scope.showNode.category?this.haveShowExtendNbrDialogId=this._scope.showNode.key:this.haveShowExtendNbrDialogId=this._scope.showNode.ID||this._scope.showNode.key}else{this.show(event,target);"Site"===this._scope.showNode.category?this.haveShowExtendNbrDialogId=this._scope.showNode.key:this.haveShowExtendNbrDialogId=this._scope.showNode.ID||this._scope.showNode.key}},show:function(event,target){this._scope.activeNode=target.part.data;this._scope.showNode=target.part.data;this._scope.$emit(NetBrain.Map.Event.CloseAllTip,{showExtendNbrDialog:!0});var self=this;var extendNbrPopUpOptions={minWidth:620,minHeight:417,height:417,autoOpen:!1,resizable:!0,position:{my:"left top",at:"right center",of:event.event},appendTo:"#realPage-"+this._scope.mapPageObj.getDocId()+"-container",draggable:{handle:".modal-header",containment:".realActive .map-canvas-containter",cancel:".extendNeighbourLeftPanel, .extendNeighbourRightPanel"},close:function(){self.isShow=!1}};var dialogService=this._dialogService;var scope=this._scope;var devType="BJ_Dis_SW1"===this._scope.activeNode.hostName?"borderDev":"innerDev";var id=scope.mapPageObj.getDocId();var template="";if("Site"===target.part.data.category)template="extendNeighbourSitePopUpTemplate.html";else{template="extendVspaceNbrPopUpTemplate.html"}dialogService.open(id,template,{data:target.part.data,scope:scope,devType:devType},extendNbrPopUpOptions);this.isShow=!0},closeExtendNbrDialog:function(){this._dialogService.close(this._scope.mapPageObj.getDocId())},getActiveNodeDataViewList:function(){return this._activeNode.getDataViewList()},getGridDataRows:function(){},getNbrInfoList:function(){},generateDataViewTree:function(activeNode){var dataViewTree=[];var tempLocalDataViewItem={};tempLocalDataViewItem.name="Local DataView";tempLocalDataViewItem.nodeType=0;tempLocalDataViewItem.description="";tempLocalDataViewItem.child=[];for(var i in activeNode.viewList)if(activeNode.viewList[i]){var tempItem={};tempItem.name=activeNode.viewList[i].viewInfo.name;tempItem.nodeType=1;tempItem.description="";tempLocalDataViewItem.child.push(tempItem)}dataViewTree.push(tempLocalDataViewItem);return dataViewTree},unique:function(arr){var r=[],obj={};var temp=[];var l=arr.length;for(var i=0;i<l;i++){var key=arr[i].nbrId+arr[i].nbrDevId+arr[i].nbrIntf.intfKeyObj.value+arr[i].topoTypeId+arr[i].mediaId;if(obj[key]){arr[i].existed&&r.splice(temp[key],1,arr[i]);arr[i].nbrIntf.mplsVrf&&r.splice(temp[key],1,arr[i])}else{obj[key]=key;temp[key]=i;r.push(arr[i])}}return r},getSitePropertie:function(arrSite){return this._scope.netmap.getNetmapOperator()._getSitePropertie(arrSite)},checkBorderLinkExisting:function(data){return!(!this._scope.netmap||!this._scope.netmap.getNetmapOperator().checkBorderLinkExist(data))},checkExisting1:function(tempNbrInfo,nbr,dataViewsSegment,sites){return!(!this._scope.netmap||!this._scope.netmap.getNetmapOperator().checkNbrLinkExist1(tempNbrInfo,nbr,dataViewsSegment,sites))},checkExisting:function(nbr){return!(!this._scope.netmap||!this._scope.netmap.getNetmapOperator().checkNbrLinkExist(nbr))},checkNodeExist:function(nodeId){if(this._scope.netmap&&this._scope.netmap._diagram){return!!this._scope.netmap._diagram.findNodeForKey(nodeId)}return!1},removelogicLinkExisted:function(nbrInfo){var netmap=this._scope.netmap;if(netmap)return netmap.getNetmapOperator().removelogicLinkExisted(nbrInfo)},currentDataViewChanged:function(){this._scope.currentEdgeGroup=this._scope.currentDataView.edgeList;this._scope.currentNbr=[]}};!function(netBrain){netBrain.Map=netBrain.Map||{};netBrain.Map.TopoLinkTemplateOption=function(){this.linkLabelBackColorParseFun=function(){console.log("subclass should implement linkLabelBackColorParseFun!")};this.linkLabelMouseHover=function(){console.log("subclass should implement linkLabelMouseHover!")};this.linkLabelMouseLeave=function(){console.log("subclass should implement linkLabelMouseLeave!")};this.linkSelectChangeFunc=function(){console.log("subclass should implement linkSelectChangeFunc!")}}}(NetBrain);!function(netBrain){var TopoLinkTemplateInfoWrapper=function(){};TopoLinkTemplateInfoWrapper.prototype.constructor=TopoLinkTemplateInfoWrapper;TopoLinkTemplateInfoWrapper.getDefaultJsonData=function(){return{category:netBrain.Map.CategoryMgr.TopoLink,from:3,to:1,topoType:"",isP2P:!0,curve:0,viewInfo:{},lineColor:"black",lineWidth:1,visible:!0,intfSrc:{dataViewInfo:{dataViewGroupId:"",dataViewTaskInfoId:"",name:"",dataViewType:"",dataViewDefinitionId:""},intfInfo:{intf:{intfKeyObj:{schema:"",value:""},intfDisplaySchemaObj:{schema:"",value:""}},intfGraphicInfo:{width:1,color:"black"},intfColorSchema:{type:"",uId:"",value:""},intfPosList:[]}},intfDest:{dataViewInfo:{dataViewGroupId:"",dataViewTaskInfoId:"",name:"",dataViewType:"",dataViewDefinitionId:""},intfInfo:{intf:{intfKeyObj:{schema:"",value:""},intfDisplaySchemaObj:{schema:"",value:""}},intfGraphicInfo:{width:1,color:"black"},intfColorSchema:{type:"",uId:"",value:""},intfPosList:[]}}}};function TopoLinkLabelInfoWrapper(){this.data=TopoLinkLabelInfoWrapper.getDefalutJsonData()}TopoLinkLabelInfoWrapper.prototype.constructor=TopoLinkLabelInfoWrapper;TopoLinkLabelInfoWrapper.prototype.fromJson=function(jsonData){null!=jsonData&&(this.data=jsonData)};TopoLinkLabelInfoWrapper.prototype.toJson=function(){return this.data};TopoLinkLabelInfoWrapper.prototype.setDisplayInfo=function(strDisplayInfo){null!=strDisplayInfo&&null!=this.data&&null!=this.data.posInfo&&(this.data.posInfo.displayInfo=strDisplayInfo)};TopoLinkLabelInfoWrapper.prototype.setFontColor=function(cssColor){null!=cssColor&&null!=this.data&&null!=this.data.labelGraphicInfo&&(this.data.labelGraphicInfo.color=cssColor)};TopoLinkLabelInfoWrapper.prototype.setBackColor=function(cssColor){null!=cssColor&&null!=this.data&&null!=this.data.labelGraphicInfo&&(this.data.labelGraphicInfo.color=cssColor)};TopoLinkLabelInfoWrapper.prototype.setFont=function(strFontName,strFontSize,strFontStyle){var fontParser=new FontParser;fontParser.fromString(BindHelper.defaultPosLableFont);null!=strFontName&&""!==strFontName&&fontParser.setFontFamily(strFontName);null!=strFontSize&&""!==strFontSize&&fontParser.setFontSize(strFontSize+"px");null!=strFontStyle&&""!==strFontStyle&&fontParser.setFontStyle(strFontStyle);null!=this.data&&null!=this.data.labelGraphicInfo&&(this.data.labelGraphicInfo.font.faceName=fontParser.toString())};TopoLinkLabelInfoWrapper.getDefalutJsonData=function(){return{posInfo:{displayInfo:"test label display info"},labelGraphicInfo:{color:"black",bgcolor:"white",font:{faceName:BindHelper.defaultPosLableFont}}}};netBrain.Map=netBrain.Map||{};netBrain.Map.TopoLinkTemplateInfoWrapper=TopoLinkTemplateInfoWrapper;netBrain.Map.TopoLinkLabelInfoWrapper=TopoLinkLabelInfoWrapper}(NetBrain);!function(netBrain){var LinkHighlightObj=function(){this.highLightJsonData={fromDevHighlightList:[],toDevHighlightList:[],bothHighLight:!0}};LinkHighlightObj.prototype.construct=LinkHighlightObj;LinkHighlightObj.prototype.devHighlightObj=function(name,color){return{name:name,color:color}};LinkHighlightObj.prototype.setBothHighLight=function(bBothHighlight){this.highLightJsonData.bothHighLight=bBothHighlight};LinkHighlightObj.prototype.isBothHighLight=function(){return this.highLightJsonData.bothHighLight};LinkHighlightObj.prototype.fromJson=function(jsonData){if(null!=jsonData){this.highLightJsonData=jsonData;null==this.highLightJsonData.fromDevHighlightList&&(this.highLightJsonData.fromDevHighlightList=[]);null==this.highLightJsonData.toDevHighlightList&&(this.highLightJsonData.toDevHighlightList=[]);null==this.highLightJsonData.toExist&&(this.highLightJsonData.toDevHighlightList.length>0?this.highLightJsonData.toExist=!0:this.highLightJsonData.toExist=!1)}};LinkHighlightObj.prototype.toJson=function(){return this.highLightJsonData};LinkHighlightObj.prototype.findObjByName=function(devHighlightList,name){if(null==devHighlightList||null==name)return null;for(var i=0;i<devHighlightList.length;i++){var hightListhObj=devHighlightList[i];if(null!=hightListhObj&&hightListhObj.name===name)return hightListhObj}return null};LinkHighlightObj.prototype.getFromDevHighLightCount=function(){return this.highLightJsonData.fromDevHighlightList.length};LinkHighlightObj.prototype.getToDevHighLightCount=function(){return this.highLightJsonData.toDevHighlightList.length};LinkHighlightObj.prototype.getFromHightShapes=function(){var shapes=[];for(var i=0;i<this.highLightJsonData.fromDevHighlightList.length;i++){var highLightData=this.highLightJsonData.fromDevHighlightList[i];null!=highLightData&&shapes.push(LinkHighlightObj.generateOneHighLightShapeForLink(highLightData.name,highLightData.color))}return shapes};LinkHighlightObj.prototype.getToHightShapes=function(){var shapes=[];for(var i=0;i<this.highLightJsonData.toDevHighlightList.length;i++){var highLightData=this.highLightJsonData.toDevHighlightList[i];null!=highLightData&&shapes.push(LinkHighlightObj.generateOneHighLightShapeForLink(highLightData.name,highLightData.color))}return shapes};LinkHighlightObj.prototype.addFromDevHighligh=function(name,color){if(null!=name&&null!=color){var devHighlightObj=this.findObjByName(this.highLightJsonData.fromDevHighlightList,name);null==devHighlightObj?this.highLightJsonData.fromDevHighlightList.push(this.devHighlightObj(name,color)):devHighlightObj.color=color}};LinkHighlightObj.prototype.addToDevHighligh=function(name,color){if(null!=name&&null!=color){var devHighlightObj=this.findObjByName(this.highLightJsonData.toDevHighlightList,name);null==devHighlightObj?this.highLightJsonData.toDevHighlightList.push(this.devHighlightObj(name,color)):devHighlightObj.color=color}};LinkHighlightObj.addHighLightForLink=function(linkObj,highLightJsonData){if(null!=linkObj&&null!=highLightJsonData){linkObj.data.LinkHighlightObjJson,linkObj.data.LinkHighlightObjJson=highLightJsonData;var tmpPoints=jQuery.extend(!0,{},linkObj.points);linkObj.points=new go.List(go.Point);linkObj.points=tmpPoints}};LinkHighlightObj.removeHighLightForLink=function(linkObj){null!=linkObj.data.LinkHighlightObjJson&&delete linkObj.data.LinkHighlightObjJson};LinkHighlightObj.generateOneHighLightShapeForLink=function(strName,color){return(0,go.GraphObject.make)(go.Shape,{name:strName,stroke:color,strokeWidth:6,visible:!0})};LinkHighlightObj.obj=new LinkHighlightObj;LinkHighlightObj.HighLightParse=function(linkPoints,linkObj){if(null==linkPoints||null==linkObj)return linkPoints;if(null==linkObj.data.LinkHighlightObjJson)return linkPoints;LinkHighlightObj.obj.fromJson(linkObj.data.LinkHighlightObjJson);var highLightPanelF=linkObj.findObject("linkHighlightF");var highLightPanelT=linkObj.findObject("linkHighlightT");LinkHighlightObj.removeAllHighLightShape(highLightPanelF);LinkHighlightObj.removeAllHighLightShape(highLightPanelT);var fromHighLightShapes=LinkHighlightObj.obj.getFromHightShapes();LinkHighlightObj.addShapeForPanel(highLightPanelF,fromHighLightShapes);var toHighLightShapes=LinkHighlightObj.obj.getToHightShapes();LinkHighlightObj.addShapeForPanel(highLightPanelT,toHighLightShapes);var nPtCount=linkPoints.length;if(6===nPtCount)if(LinkHighlightObj.obj.isBothHighLight()){LinkHighlightObj.calL2linkHighlightShape(linkPoints,highLightPanelF,!0);LinkHighlightObj.calL2linkHighlightShape(linkPoints,highLightPanelT,!1)}else if(fromHighLightShapes.length>0&&toHighLightShapes.length>0){LinkHighlightObj.calL2linkHighlightShape(linkPoints,highLightPanelF,!0);LinkHighlightObj.calL2linkHighlightShape(linkPoints,highLightPanelT,!1)}else fromHighLightShapes.length>=0?LinkHighlightObj.calL2linkHighlightShape(linkPoints,highLightPanelF):toHighLightShapes.length>=0&&LinkHighlightObj.calL2linkHighlightShape(linkPoints,highLightPanelT);else if(2===nPtCount){var startPt=linkPoints.elt(0);var endPt=linkPoints.elt(1);var midPoint=new go.Point((startPt.x+endPt.x)/2,(startPt.y+endPt.y)/2);if(LinkHighlightObj.obj.isBothHighLight()){LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,highLightPanelF,!0);LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,highLightPanelT,!1)}else if(fromHighLightShapes.length>0&&toHighLightShapes.length>0){LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,highLightPanelF,!0);LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,highLightPanelT,!1)}else fromHighLightShapes.length>=0?LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,highLightPanelF):toHighLightShapes.length>=0&&LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,highLightPanelT)}else if(4===nPtCount||3===nPtCount){var Start=linkPoints.elt(0).copy();var Ctrl1;var Ctrl2;var End;if(3===nPtCount){Ctrl1=linkPoints.elt(1).copy();Ctrl2=linkPoints.elt(1).copy();End=linkPoints.elt(2).copy()}else{Start=new go.Point(4541.112109867535,1373.8677277442705);Ctrl1=new go.Point(4861.831714722644,1452.5229678958171);Ctrl2=new go.Point(4861.831714722644,1452.5229678958171);End=new go.Point(5167.418519919716,1341.0652635024583)}if(null==linkObj.data.LinkHighlightObjJson)return linkPoints;if(LinkHighlightObj.obj.isBothHighLight()){LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,highLightPanelF,!0);LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,highLightPanelT,!1)}else if(fromHighLightShapes.length>=0&&toHighLightShapes.length>0){LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,highLightPanelF,!0);LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,highLightPanelT,!1)}else fromHighLightShapes.length>=0?LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,highLightPanelF):toHighLightShapes.length>=0&&LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,highLightPanelT)}return linkPoints};LinkHighlightObj.removeAllHighLightShape=function(highLightPanel){if(null!=highLightPanel)for(var i=highLightPanel.elements.count-1;i>=0;i--)highLightPanel.removeAt(i)};LinkHighlightObj.calCurvePosition=function(oriStart,oriCtrlPt1,oriCtrlPt2,oriEnd,highLightPanel,wholeLine,bLeft,alignBezierMid,isLine){var tmpStart=oriStart.copy();var tmpCtrl1=oriCtrlPt1.copy();var tmpCtrl2=oriCtrlPt2.copy();var tmpEnd=oriEnd.copy();var start=null;var startControl=null;var endControl=null;var end=null;var count=highLightPanel.elements.count;if(!(count<=0)){var strokeWidth=highLightPanel.elt(0).elt(0).strokeWidth;if(!0===wholeLine){start=tmpStart.copy();startControl=tmpCtrl1.copy();endControl=tmpCtrl2.copy();end=tmpEnd.copy()}else{var curveLine2=NgUtil.splitTwoBezierByPoint(tmpStart.copy(),tmpCtrl1.copy(),tmpCtrl2.copy(),tmpEnd.copy());if(!0===bLeft){start=new go.Point(curveLine2[0].startX,curveLine2[0].startY);startControl=new go.Point(curveLine2[0].ctrlPt1X,curveLine2[0].ctrlPt1Y);endControl=new go.Point(curveLine2[0].ctrlPt2X,curveLine2[0].ctrlPt2Y);end=new go.Point(curveLine2[0].endX,curveLine2[0].endY)}else{start=new go.Point(curveLine2[1].startX,curveLine2[1].startY);startControl=new go.Point(curveLine2[1].ctrlPt1X,curveLine2[1].ctrlPt1Y);endControl=new go.Point(curveLine2[1].ctrlPt2X,curveLine2[1].ctrlPt2Y);end=new go.Point(curveLine2[1].endX,curveLine2[1].endY)}}if(!bLeft){var tmp=start;start=end;end=tmp;tmp=startControl;startControl=endControl;endControl=tmp}var bx=Math.min(end.x,start.x);var by=Math.min(end.y,start.y);start.x-=bx;start.y-=by;startControl.x-=bx;startControl.y-=by;endControl.x-=bx;endControl.y-=by;end.x-=bx;end.y-=by;var cal=new NgUtil.Bezier(start.copy(),startControl.copy(),endControl.copy(),end.copy());var lines=cal.segment(count,0);var rect=cal.getBounds();var minx=0;var miny=0;for(var m=0;m<lines.length;m++)for(var n=0;n<lines[m].length;n++){lines[m][n].x<minx&&(minx=lines[m][n].x);lines[m][n].y<miny&&(miny=lines[m][n].y)}for(m=0;m<lines.length;m++)for(n=0;n<lines[m].length;n++){lines[m][n].x-=minx;lines[m][n].y-=miny}var last;for(var i=0;i<count;i++){var strLine="M ";var j=0;if(null==last){last=lines[i][0];j++}strLine+=last.x+" "+last.y+" ";for(;j<lines[i].length;j++){strLine+=" L "+lines[i][j].x.toFixed(6)+" "+lines[i][j].y.toFixed(6)+" ";last=lines[i][j]}var geo=go.Geometry.parse(strLine);highLightPanel.elt(i).elt(0).geometry=geo}var midp=new go.Point;if(alignBezierMid)NgUtil.bezierMidPoint(tmpStart.x,tmpStart.y,tmpCtrl1.x,tmpCtrl1.y,tmpCtrl2.x,tmpCtrl2.y,tmpEnd.x,tmpEnd.y,midp);else if(isLine){midp=computeMidPoint(midp,[tmpStart,tmpCtrl1,tmpEnd])}else midp=tmpCtrl1;highLightPanel.alignmentFocus=new go.Spot(0,0,midp.x-rect.x-bx+strokeWidth/2,midp.y-rect.y-by+strokeWidth/2)}};LinkHighlightObj.addPoint=function(lineF,startLength,segCount,segLengthArray,ptStart,ptEnd){var ptX,ptY;if(ptStart.x===ptEnd.x&&ptStart.y<ptEnd.y){ptX=ptEnd.x;ptY=ptStart.y+(startLength-LinkHighlightObj.getSegLength(segCount,segLengthArray));lineF.push(new go.Point(ptX,ptY))}else if(ptStart.x===ptEnd.x&&ptStart.y>ptEnd.y){ptX=ptStart.x;ptY=ptStart.y-(startLength-LinkHighlightObj.getSegLength(segCount,segLengthArray));lineF.push(new go.Point(ptX,ptY))}else if(ptStart.x<ptEnd.x&&ptStart.y===ptEnd.y){ptX=ptStart.x+(startLength-LinkHighlightObj.getSegLength(segCount,segLengthArray));ptY=ptStart.y;lineF.push(new go.Point(ptX,ptY))}else{ptX=ptStart.x-(startLength-LinkHighlightObj.getSegLength(segCount,segLengthArray));ptY=ptStart.y;lineF.push(new go.Point(ptX,ptY))}};LinkHighlightObj.getSegLength=function(segCount,segLengthArray){if(null!=segCount&&null!=segLengthArray&&!(segCount>segLengthArray.lengh)){var retVal=0;for(var i=0;i<segCount;i++)retVal+=segLengthArray[i];return retVal}};LinkHighlightObj.calL2linkHighlightShape=function(linkPointsParam,highLightPanel,bFrom){var pt;var countF=highLightPanel.elements.count;if(!(countF<=0)){var i;var linkPoints=linkPointsParam;if(null!=bFrom&&!bFrom){linkPoints=new go.List(go.Point);for(i=linkPointsParam.length-1;i>=0;i--){pt=linkPointsParam.elt(i);linkPoints.add(pt)}}var lengthSum=0;var lengthArray=[];var dirOld=-1;var dirNew=-1;var ptLast=null;var linkCornPoints=new go.List(go.Point);for(i=0;i<linkPoints.length-1;i++){var point1=linkPoints.elt(i);var point2=linkPoints.elt(i+1);var length;ptLast=point2;if(point1.x===point2.x&&point1.y!==point2.y){dirNew=0;lengthSum+=length=Math.abs(point1.y-point2.y);if(dirOld!==dirNew){lengthArray.push(length);linkCornPoints.add(point1)}else lengthArray[lengthArray.length-1]+=length;dirOld=dirNew}else if(point1.x!==point2.x&&point1.y===point2.y){dirNew=1;lengthSum+=length=Math.abs(point1.x-point2.x);if(dirOld!==dirNew){lengthArray.push(length);linkCornPoints.add(point1)}else lengthArray[lengthArray.length-1]+=length;dirOld=dirNew}}linkCornPoints.add(ptLast);var midSubLengthF=(null!=bFrom?lengthSum/2:lengthSum)/countF;var lineF=[];var ptTmp=linkCornPoints.elt(0);lineF.push(new go.Point(ptTmp.x,ptTmp.y));for(i=0;i<countF;i++){var startSegIndex=0;var endSegIndex=0;var findStartIndex=!1;var findEndIndex=!1;var startLength=midSubLengthF*i;var endLength=midSubLengthF*(i+1);var lenghtmp=0;for(var j=0;j<lengthArray.length;j++){if((lenghtmp+=lengthArray[j])>startLength&&!findStartIndex){findStartIndex=!0;startSegIndex=j}if(lenghtmp>endLength&&!findEndIndex){findEndIndex=!0;endSegIndex=j}if(findStartIndex&&findEndIndex)break}var pointEndSeg1=linkCornPoints.elt(endSegIndex);var pointEndSeg2=linkCornPoints.elt(endSegIndex+1);if(endSegIndex-startSegIndex>0)for(var ptindex=startSegIndex+1;ptindex<=endSegIndex;ptindex++){pt=linkCornPoints.elt(ptindex);lineF.push(new go.Point(pt.x,pt.y));lineF[lineF.length-1].isBroken=!0}LinkHighlightObj.addPoint(lineF,endLength,endSegIndex,lengthArray,pointEndSeg1,pointEndSeg2)}var xMin=1e6;var yMin=1e6;var xMax=0;var yMax=0;for(i=0;i<lineF.length;i++){xMin>(pt=lineF[i]).x&&(xMin=pt.x);yMin>pt.y&&(yMin=pt.y);xMax<pt.x&&(xMax=pt.x);yMax<pt.y&&(yMax=pt.y)}for(i=0;i<lineF.length;i++){(pt=lineF[i]).x-=xMin;pt.y-=yMin}var eleCount=0;i=0;for(;i<lineF.length-1;){var strLine="M ";var pt1=lineF[i];var pt2=lineF[i+1];strLine+=pt1.x+" "+pt1.y+" ";strLine+="L"+pt2.x.toFixed(6)+" "+pt2.y.toFixed(6)+" ";if(null!=pt2.isBroken&&pt2.isBroken){var pt3=lineF[i+2];strLine+="L"+pt3.x.toFixed(6)+" "+pt3.y.toFixed(6)+" ";i+=2}else i+=1;var geo=go.Geometry.parse(strLine);eleCount<countF&&(highLightPanel.elt(eleCount++).elt(0).geometry=geo)}if(null==bFrom)highLightPanel.alignmentFocus=new go.Spot(0,0,highLightPanel.actualBounds.width,highLightPanel.actualBounds.height);else{var angle;if(bFrom){angle=linkCornPoints.elt(0).directionPoint(linkCornPoints.elt(linkCornPoints.count-1));highLightPanel.alignmentFocus=angle>0&&angle<=90?new go.Spot(0,0,highLightPanel.actualBounds.width-3,highLightPanel.actualBounds.height-3):angle>90&&angle<=180?new go.Spot(0,0,0,highLightPanel.actualBounds.height):angle>180&&angle<=270?new go.Spot(0,0,3,3):new go.Spot(0,0,highLightPanel.actualBounds.width,3)}else{angle=linkCornPoints.elt(0).directionPoint(linkCornPoints.elt(linkCornPoints.count-1));highLightPanel.alignmentFocus=angle>0&&angle<=90?new go.Spot(0,0,highLightPanel.actualBounds.width-3,highLightPanel.actualBounds.height-3):angle>90&&angle<=180?new go.Spot(0,0,-3,highLightPanel.actualBounds.height):angle>180&&angle<=270?new go.Spot(0,0,3,3):new go.Spot(0,0,highLightPanel.actualBounds.width,0)}}}};LinkHighlightObj.addShapeForPanel=function(panel,shapes){if(!(null==panel||null==shapes||shapes.length<=0||panel.elements.count>0))for(var i=0;i<shapes.length;i++){var ele=shapes[i];null!=ele&&panel.add(ele)}};LinkHighlightObj.checkSamePoints=function(linkPoints,linkObj){if(null!=linkObj._hlPoints&&linkObj._hlPoints.length===linkPoints.length){for(var i=0;i<linkPoints.length;i++)if(linkPoints.elt(i).x.toFixed(2)!==linkObj._hlPoints.elt(i).x.toFixed(2)||linkPoints.elt(i).y.toFixed(2)!==linkObj._hlPoints.elt(i).y.toFixed(2)){linkObj._hlPoints=linkPoints;return!1}return!0}linkObj._hlPoints=linkPoints;return!1};LinkHighlightObj.highlightDataListParse=function(linkPoints,linkObj){if(null==linkPoints||null==linkObj||null==linkObj.data)return linkPoints;var diagram=linkObj.diagram;if(null==diagram)return linkPoints;var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;diagram.startTransaction("highlightDataListParse");var selectedBgPanel=linkObj.findObject(netBrain.Map.CompTopolink.SelectedBgPanel);var baseLineForShowSrc=linkObj.findObject(netBrain.Map.CompTopolink.BaseLineForShowSrc);var baseLineForShowDest=linkObj.findObject(netBrain.Map.CompTopolink.BaseLineForShowDest);var graphicPanelF=linkObj.findObject("linkGraphicF");var graphicPanelT=linkObj.findObject("linkGraphicT");var highlightDataListSrc=linkObj.findObject("HIGHLIGHT_SRC");var highlightDataListDest=linkObj.findObject("HIGHLIGHT_DEST");var wholeLine=null==linkObj.data.getIntfSrc()||null==linkObj.data.getIntfDest();var nPtCount=linkPoints.length;if(2===nPtCount){var startPt=linkPoints.elt(0);var endPt=linkPoints.elt(1);var midPoint=new go.Point((startPt.x+endPt.x)/2,(startPt.y+endPt.y)/2);LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,selectedBgPanel,!0,!0);LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,baseLineForShowSrc,wholeLine,!0);LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,baseLineForShowDest,wholeLine,!1);LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,graphicPanelF,wholeLine,!0);LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,graphicPanelT,wholeLine,!1);LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,highlightDataListSrc,wholeLine,!0);LinkHighlightObj.calCurvePosition(startPt,midPoint,midPoint,endPt,highlightDataListDest,wholeLine,!1)}else if(4===nPtCount||3===nPtCount){var Start=linkPoints.elt(0).copy();var Ctrl1;var Ctrl2;var End;if(3===nPtCount){Ctrl1=linkPoints.elt(1).copy();Ctrl2=linkPoints.elt(1).copy();End=linkPoints.elt(2).copy()}else{Ctrl1=linkPoints.elt(1).copy();Ctrl2=linkPoints.elt(2).copy();End=linkPoints.elt(3).copy()}var alignBezierMid=4===nPtCount;var isLine=!(linkObj.curve===go.Link.Bezier);LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,selectedBgPanel,!0,!0,alignBezierMid,isLine);LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,baseLineForShowSrc,wholeLine,!0,alignBezierMid,isLine);LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,baseLineForShowDest,wholeLine,!1,alignBezierMid,isLine);LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,graphicPanelF,wholeLine,!0,alignBezierMid,isLine);LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,graphicPanelT,wholeLine,!1,alignBezierMid,isLine);LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,highlightDataListSrc,wholeLine,!0,alignBezierMid,isLine);LinkHighlightObj.calCurvePosition(Start,Ctrl1,Ctrl2,End,highlightDataListDest,wholeLine,!1,alignBezierMid,isLine)}diagram.commitTransaction("highlightDataListParse");diagram.skipsUndoManager=oldskip;return linkPoints};LinkHighlightObj.calTargetDistancePoint=function(points,targetDistance,result){var segmentDistanceQueue=[];for(var i=0;i<points.length-1;i++){var segmentDistance;var a=points[i];var b=points[i+1];if(isApproxEqual(a.x,b.x)){(segmentDistance=b.y-a.y)<0&&(segmentDistance=-segmentDistance);segmentDistanceQueue.push(segmentDistance);segmentDistance}else if(isApproxEqual(a.y,b.y)){(segmentDistance=b.x-a.x)<0&&(segmentDistance=-segmentDistance);segmentDistanceQueue.push(segmentDistance);segmentDistance}else{segmentDistance=Math.sqrt(a.distanceSquaredPoint(b));segmentDistanceQueue.push(segmentDistance);segmentDistance}}var currentDistance=0;var currentPointIndex=0;var nextSegmentLength=0;for(;currentDistance<targetDistance&&currentPointIndex<points.length&&!(currentDistance+(nextSegmentLength=segmentDistanceQueue[currentPointIndex])>targetDistance);){currentDistance+=nextSegmentLength;currentPointIndex++}var currentPoint=points[currentPointIndex];var nextPoint=points[currentPointIndex+1];(result=result||{}).index=currentPointIndex;result.point=new go.Point;if(currentPoint.x===nextPoint.x)currentPoint.y>nextPoint.y?result.point.setTo(currentPoint.x,currentPoint.y-(targetDistance-currentDistance)):result.point.setTo(currentPoint.x,currentPoint.y+(targetDistance-currentDistance));else if(currentPoint.y===nextPoint.y)currentPoint.x>nextPoint.x?result.point.setTo(currentPoint.x-(targetDistance-currentDistance),currentPoint.y):result.point.setTo(currentPoint.x+(targetDistance-currentDistance),currentPoint.y);else{var similarTriangleRatio=(targetDistance-currentDistance)/nextSegmentLength;var dx=similarTriangleRatio*(nextPoint.x-currentPoint.x);var dy=similarTriangleRatio*(nextPoint.y-currentPoint.y);result.point.setTo(currentPoint.x+dx,currentPoint.y+dy)}};LinkHighlightObj.calL2LinkShape=function(linkPoints,highLightPanel,wholeLine,bFrom){var count=highLightPanel.elements.count;if(!(count<=0)){var strokeWidth=highLightPanel.elt(0).elt(0).strokeWidth;var numpts=linkPoints.length;if(!(numpts<6)){var minValue={};minValue.x=arrMin(linkPoints,"x");minValue.y=arrMin(linkPoints,"y");var points=[];for(i=0;i<numpts;i++){var point=linkPoints.elt(i);points.push(new go.Point(point.x-minValue.x,point.y-minValue.y))}bFrom||points.reverse();var midPoint=new go.Point;computeMidPoint(midPoint,points);var distanceAlongRoute=0;var segmentDistanceQueue=[];var i;for(i=0;i<numpts-1;i++){var segmentDistance;var a=points[i];var b=points[i+1];if(isApproxEqual(a.x,b.x)){(segmentDistance=b.y-a.y)<0&&(segmentDistance=-segmentDistance);segmentDistanceQueue.push(segmentDistance);distanceAlongRoute+=segmentDistance}else if(isApproxEqual(a.y,b.y)){(segmentDistance=b.x-a.x)<0&&(segmentDistance=-segmentDistance);segmentDistanceQueue.push(segmentDistance);distanceAlongRoute+=segmentDistance}else{segmentDistance=Math.sqrt(a.distanceSquaredPoint(b));segmentDistanceQueue.push(segmentDistance);distanceAlongRoute+=segmentDistance}}var halfDistance=0;var halfPoints=[];var result;if(wholeLine){halfDistance=distanceAlongRoute;halfPoints=points}else{halfDistance=distanceAlongRoute/2;result={};this.calTargetDistancePoint(points,halfDistance,result);(halfPoints=points.slice(0,result.index+1)).push(result.point)}for(i=0;i<count;i++){var subPoints=[];if(i<count-1){result={};this.calTargetDistancePoint(halfPoints,halfDistance/(count-i),result);(subPoints=halfPoints.splice(0,result.index+1,result.point)).push(result.point);halfDistance-=halfDistance/(count-i)}else subPoints=halfPoints;if(subPoints.length>=2){var strLine="M ";strLine+=subPoints[0].x.toFixed(6)+" "+subPoints[0].y.toFixed(6)+" ";for(var j=1;j<subPoints.length;j++)strLine+="L"+subPoints[j].x.toFixed(6)+" "+subPoints[j].y.toFixed(6)+" ";var geo=go.Geometry.parse(strLine);highLightPanel.elt(i).elt(0).geometry=geo}}highLightPanel.alignmentFocus=new go.Spot(0,0,midPoint.x+strokeWidth/2,midPoint.y+strokeWidth/2)}}};LinkHighlightObj.highlightDataListParseL2=function(linkPoints,linkObj){if(null==linkPoints||null==linkObj||null==linkObj.data)return linkPoints;var diagram=linkObj.diagram;if(null==diagram)return linkPoints;var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;diagram.startTransaction("highlightDataListParse");var selectedBgPanel=linkObj.findObject(netBrain.Map.CompTopolink.SelectedBgPanel);var baseLineForShowSrc=linkObj.findObject(netBrain.Map.CompTopolink.BaseLineForShowSrc);var baseLineForShowDest=linkObj.findObject(netBrain.Map.CompTopolink.BaseLineForShowDest);var graphicPanelF=linkObj.findObject("linkGraphicF");var graphicPanelT=linkObj.findObject("linkGraphicT");var highlightDataListSrc=linkObj.findObject("HIGHLIGHT_SRC");var highlightDataListDest=linkObj.findObject("HIGHLIGHT_DEST");var wholeLine=null==linkObj.data.getIntfSrc()||null==linkObj.data.getIntfDest();LinkHighlightObj.calL2LinkShape(linkPoints,selectedBgPanel,!0,!0);LinkHighlightObj.calL2LinkShape(linkPoints,baseLineForShowSrc,wholeLine,!0);LinkHighlightObj.calL2LinkShape(linkPoints,baseLineForShowDest,wholeLine,!1);LinkHighlightObj.calL2LinkShape(linkPoints,graphicPanelF,wholeLine,!0);LinkHighlightObj.calL2LinkShape(linkPoints,graphicPanelT,wholeLine,!1);LinkHighlightObj.calL2LinkShape(linkPoints,highlightDataListSrc,wholeLine,!0);LinkHighlightObj.calL2LinkShape(linkPoints,highlightDataListDest,wholeLine,!1);diagram.commitTransaction("highlightDataListParse");diagram.skipsUndoManager=oldskip;return linkPoints};var arrMin=function(arr,property){if(!arr||!arr.length){console.log("utils.min arr is null");throw new Error("utils.min fcuntion arr param is null")}var fn;fn=property?function(o){return o[property]}:function(o){return o};var numArr=[];for(var i=0,len=arr.length;i<len;i++){var value=fn(arr.elt(i));isNaN(value)||numArr.push(value)}return Math.min.apply(null,numArr)};var isApproxEqual=function(x,y){var d=x-y;return d<5e-8&&d>-5e-8};var computeMidPoint=function(result,points){var numpts=points.length;var distanceAlongRoute=0;var segmentDistanceQueue=[];for(var i=0;i<numpts-1;i++){var segmentDistance;var a=points[i];var b=points[i+1];if(isApproxEqual(a.x,b.x)){(segmentDistance=b.y-a.y)<0&&(segmentDistance=-segmentDistance);segmentDistanceQueue.push(segmentDistance);distanceAlongRoute+=segmentDistance}else if(isApproxEqual(a.y,b.y)){(segmentDistance=b.x-a.x)<0&&(segmentDistance=-segmentDistance);segmentDistanceQueue.push(segmentDistance);distanceAlongRoute+=segmentDistance}else{segmentDistance=Math.sqrt(a.distanceSquaredPoint(b));segmentDistanceQueue.push(segmentDistance);distanceAlongRoute+=segmentDistance}}var currentDistance=0;var currentPointIndex=0;var nextSegmentLength=0;for(;currentDistance<distanceAlongRoute/2&&currentPointIndex<numpts&&!(currentDistance+(nextSegmentLength=segmentDistanceQueue[currentPointIndex])>distanceAlongRoute/2);){currentDistance+=nextSegmentLength;currentPointIndex++}var currentPoint=points[currentPointIndex];var nextPoint=points[currentPointIndex+1];if(currentPoint.x===nextPoint.x)currentPoint.y>nextPoint.y?result.setTo(currentPoint.x,currentPoint.y-(distanceAlongRoute/2-currentDistance)):result.setTo(currentPoint.x,currentPoint.y+(distanceAlongRoute/2-currentDistance));else if(currentPoint.y===nextPoint.y)currentPoint.x>nextPoint.x?result.setTo(currentPoint.x-(distanceAlongRoute/2-currentDistance),currentPoint.y):result.setTo(currentPoint.x+(distanceAlongRoute/2-currentDistance),currentPoint.y);else{var similarTriangleRatio=(distanceAlongRoute/2-currentDistance)/nextSegmentLength;var dx=similarTriangleRatio*(nextPoint.x-currentPoint.x);var dy=similarTriangleRatio*(nextPoint.y-currentPoint.y);result.setTo(currentPoint.x+dx,currentPoint.y+dy)}return result};netBrain.Map=netBrain.Map||{};netBrain.Map.LinkHighlightObj=LinkHighlightObj}(NetBrain);!function(netBrain){function CompGraphSimpleLink(){go.Link.apply(this,arguments)}go.Diagram.inherit(CompGraphSimpleLink,go.Link);CompGraphSimpleLink.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var shapeObj=this.findObject(CompTopolink.LineName);var shapeInfo=visioTools.getShapeInfo(shapeObj);visioInfos.push(shapeInfo);return visioTools.buildLinkVisioInfo(visioInfos,this.data,this)};var CompTopolink=function(){netBrain.Map.CLinkLine.call(this)};CompTopolink.initSomeLinkTemplateOption=function(templateOptions){};CompTopolink.prototype=new netBrain.Map.CLinkLine;CompTopolink.prototype.constructor=CompTopolink;CompTopolink.prototype.init=function(){};CompTopolink.prototype.setEditableMode=function(nodeObj,bEditable){};CompTopolink.prototype.isEditableMode=function(nodeObj){};CompTopolink.prototype.setLineColor=function(link,strColor){if(link instanceof go.Link){link.findObject("baseLink").stroke=strColor;link.findObject("linkToArrow").fill=strColor;link.findObject("linkFromArrow").fill=strColor}};CompTopolink.prototype.setLineWidth=function(link,nSize){if(link instanceof go.Link){link.findObject("baseLink").strokeWidth=nSize;link.findObject("linkFromArrow").scale=Math.ceil(nSize/2.5);link.findObject("linkToArrow").scale=Math.ceil(nSize/2.5)}};CompTopolink.prototype.setLineArrow=function(link,fromTo){if(link instanceof go.Link)switch(fromTo){case"from":link.findObject("linkFromArrow").fromArrow="BackwardBoomerang";link.findObject("linkToArrow").toArrow="";break;case"to":link.findObject("linkFromArrow").fromArrow="";link.findObject("linkToArrow").toArrow="Boomerang";break;case"both":link.findObject("linkFromArrow").fromArrow="BackwardBoomerang";link.findObject("linkToArrow").toArrow="Boomerang"}};CompTopolink.prototype.setLineStyle=function(link,dashArray){link instanceof go.Link&&(link.findObject("baseLink").strokeDashArray=dashArray)};CompTopolink.getDefaultJsDataForLinkLine=function(){return netBrain.Map.TopoLinkTemplateInfoWrapper.getDefaultJsonData()};CompTopolink.PanelBuilder=function(segIndex,segOffset,source,from,to,templateOptions,scope){return(0,go.GraphObject.make)(go.Panel,"Horizontal",{name:source+"_"+from,segmentIndex:segIndex,segmentOrientation:go.Link.OrientOpposite,alignmentFocus:segOffset,margin:3,itemTemplate:netBrain.Map.CCompLabel.getLinkLabelTemplate(templateOptions,scope)},new go.Binding("itemArray",source,(function(intfObj,node){if(null==intfObj)return null;var list=intfObj.intfInfo.intfPosList;if(null==list)return null;var isDest=segIndex<0;var posList=[];for(var i=0;i<list.length;i++){var pos=list[i];var name="intfPos"+to;9===to&&(name=DataViewPosName.overflowPos);if(pos.posName===name){if(node.part.data.isDefaultDataView(isDest)&&(!pos.posInfo||null==pos.posInfo.displayInfo||""===pos.posInfo.displayInfo.trim()))break;posList.push(pos);break}}return posList})))};CompTopolink.openEditLinkDialog=function(event,target,editLinkShow,activeEditDU){var ptConvert=event.targetDiagram.transformDocToView(event.diagram.lastInput.documentPoint);var clickXPos=ptConvert.x;var clickYPos=ptConvert.y;var vpBounds=event.diagram.viewportBounds;var vpHeight=vpBounds.height;var vpWidth=vpBounds.width;var targetPos={x:clickXPos,y:clickYPos};vpWidth-clickXPos<900&&(targetPos.x-=900-(vpWidth-clickXPos));vpHeight-clickYPos<400&&(targetPos.y-=400-(vpHeight-clickYPos));editLinkShow(targetPos,target,activeEditDU)};CompTopolink.dataViewEditModeMask=function(templateOptions,scope){return(0,go.GraphObject.make)(go.Shape,"Rectangle",{name:"editDataViewLinkMask",fill:"#1B7FC2",strokeWidth:0,visible:!1,height:50,opacity:.4,segmentIndex:0,cursor:"pointer",segmentOffset:new go.Point(NaN,0),segmentOrientation:go.Link.OrientOpposite,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTopolink.EVENT_NAMES.EDIT_DATA_VIEW_LINK_MASK_CLICK,event,target)}})};CompTopolink.showDataViewLinkMask=function(event,link,tempalteOptions){if(null!=tempalteOptions&&tempalteOptions.isEditMode()&&!(link.part.opacity<1)){var baseLink=link.findObject(CompTopolink.LineName);var mask=link.findObject("editDataViewLinkMask");var mousePosition_x=event.documentPoint.x,mousePosition_y=event.documentPoint.y;var fromNodePosition=link.fromNode.part.getDocumentPoint(go.Spot.Center);var toNodePosition=link.toNode.part.getDocumentPoint(go.Spot.Center);var isDest=!1;if(Math.sqrt(Math.pow(Math.abs(mousePosition_x-fromNodePosition.x),2)+Math.pow(Math.abs(mousePosition_y-fromNodePosition.y),2))>Math.sqrt(Math.pow(Math.abs(mousePosition_x-toNodePosition.x),2)+Math.pow(Math.abs(mousePosition_y-toNodePosition.y),2))){mask.segmentIndex=-1;mask.editingNode=link.toNode.data;isDest=!0}else{mask.segmentIndex=0;mask.editingNode=link.fromNode.data}var width=baseLink.naturalBounds.width;var height=baseLink.naturalBounds.height;var length=Math.sqrt(Math.pow(width,2)+Math.pow(height,2));link.data.isP2P?mask.width=length/2:mask.width=length-5;mask.visible=!NetBrain.Map.gMediaTypeMgr.isMediaType(mask.editingNode.devCategory);return isDest}};CompTopolink.hideDataViewLinkMask=function(link,templateOptions){if(null!=templateOptions&&templateOptions.isEditMode()&&!(link.opacity<1)){var mask=link.findObject("editDataViewLinkMask");if(mask.editingNode&&_.isFunction(mask.editingNode.getDataViewGroupId)){mask.visible=!1;delete mask.editingNode}}};CompTopolink.getCategory=function(){return netBrain.Map.CategoryMgr.TopoLink};CompTopolink.LineName="baseLink";CompTopolink.SelectedBgPanel="selectedBgPanel";CompTopolink.BaseLineForShowSrc="baseLineForShowSrc";CompTopolink.BaseLineShapeForShowSrc="baseLineShapeForShowSrc";CompTopolink.BaseLineForShowDest="baseLineForShowDest";CompTopolink.BaseLineShapeForShowDest="baseLineShapeForShowDest";CompTopolink.linkPosInfoLabel="linkPosLabel";CompTopolink.srcInftNameLabel="srcInftName";CompTopolink.destInftNameLabel="destInftName";CompTopolink.srcInftNameLabelPanel="srcInftNamePanel";CompTopolink.destInftNameLabelPanel="destInftNamePanel";CompTopolink.srcLinkIntfInfoLabel="srcLinkIntfInfoLabel";CompTopolink.destLinkIntfInfoLabel="destLinkIntfInfoLabel";CompTopolink.highlightShapeName="highlightShape";CompTopolink.srcLinkGraphicShape="linkGraphicFShape";CompTopolink.destLinkGraphicShape="linkGraphicTShape";CompTopolink.alarmLabel="alarmLabel";CompTopolink.getLinkLabelPosition=function(index,defualt){return 0===index||2===index||4===index||6===index?30:1===index||3===index||5===index||7===index?defualt?31:180:defualt?32:330};CompTopolink.calcContentWidth=function(text,textBlock,diagram){var node=new go.Part;(textBlock=textBlock.copy()).text=text;node.add(textBlock);var list=new go.List;list.add(node);diagram.computePartsBounds(list);return node.measuredBounds.width};CompTopolink.getMapSimpleTemplate=function(templateOptions,diagram,bIsL2Link,scope){var $=go.GraphObject.make;return $(CompGraphSimpleLink,$(go.Shape,{name:CompTopolink.LineName}))};CompTopolink.EVENT_NAMES={LINK_LINE_MOUSE_ENTER:"COMP_TOPO_LINK_LINK_LINE_MOUSE_ENTER",LINK_LINE_MOUSE_LEAVE:"COMP_TOPO_LINK_LINK_LINE_MOUSE_LEAVE",INTF_INFO_LABEL_SRC_CLICK:"COMP_TOPO_LINK_INTF_INFO_LABEL_SRC_CLICK",INTF_INFO_LABEL_SRC_MOUSE_ENTER:"COMP_TOPO_LINK_INTF_INFO_LABEL_SRC_MOUSE_ENTER",INTF_INFO_LABEL_SRC_MOUSE_LEAVE:"COMP_TOPO_LINK_INTF_INFO_LABEL_SRC_MOUSE_LEAVE",INTF_INFO_LABEL_DEST_CLICK:"COMP_TOPO_LINK_INTF_INFO_LABEL_DEST_CLICK",INTF_INFO_LABEL_DEST_MOUSE_ENTER:"COMP_TOPO_LINK_INTF_INFO_LABEL_DEST_MOUSE_ENTER",INTF_INFO_LABEL_DEST_MOUSE_LEAVE:"COMP_TOPO_LINK_INTF_INFO_LABEL_DEST_MOUSE_LEAVE",EDIT_DATA_VIEW_LINK_MASK_CLICK:"COMP_TOPO_LINK_EDIT_DATA_VIEW_LINK_MASK_CLICK"};CompTopolink.getMapTemplate=function(templateOptions,diagram,bIsL2Link,scope){var $=go.GraphObject.make;return $(!0===bIsL2Link?netBrain.Map.L2CustomizeLink:netBrain.Map.TopoCustomizeLink,{layerName:GlobalContext.LinkLayerName,selectionAdornmentTemplate:NormalSelectAdormenTemplate.getLinkTemplate(!1),name:"LINKLINE",shadowOffset:new go.Point(0,0),shadowBlur:5,shadowColor:"#2999E3",reshapable:!0,curve:go.Link.None,adjusting:go.Link.Scale,mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTopolink.EVENT_NAMES.LINK_LINE_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTopolink.EVENT_NAMES.LINK_LINE_MOUSE_LEAVE,event,target)}},new go.Binding("layerName").makeTwoWay(),new go.Binding("curve","curve",(function(v){return 1===v?go.Link.Bezier:go.Link.None})).makeTwoWay((function(c,v){return c===go.Link.Bezier?1:0})),new go.Binding("isShadowed").makeTwoWay(),new go.Binding("opacity"),new go.Binding("visible","visible").makeTwoWay(),new go.Binding("selectable","opacity",(function(opacity){return opacity>=1})),$(go.Shape,{opacity:0,name:CompTopolink.LineName},new go.Binding("stroke","",(function(v,node){return v.data.isPortChannel?"blue":"black"})).ofObject(),new go.Binding("strokeWidth","",(function(v,node){return v.data.isPortChannel?2:1})).ofObject()),$(go.Panel,{name:CompTopolink.srcInftNameLabel,segmentIndex:0,alignmentFocus:new go.Spot(0,1,-20,4),segmentOrientation:go.Link.OrientOpposite},$(go.Panel,{},$(go.Panel,{name:CompTopolink.srcInftNameLabelPanel,position:new go.Point(0,0)},$(go.Panel,$(go.Shape,{visible:!1}),$(go.TextBlock,{name:netBrain.Map.CompTopolink.srcLinkIntfInfoLabel,editable:!1,stroke:"black",font:BindHelper.defaultInftNameFont,background:"white",click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTopolink.EVENT_NAMES.INTF_INFO_LABEL_SRC_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTopolink.EVENT_NAMES.INTF_INFO_LABEL_SRC_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTopolink.EVENT_NAMES.INTF_INFO_LABEL_SRC_MOUSE_LEAVE,event,target)}},new go.Binding("text","intfSrc",(function(intfSrc,node){if(null==intfSrc)return"";var text=NgUtil.getValueFromObjAndPath(intfSrc,"intfInfo.intf.intfDisplaySchemaObj.value","");var width=CompTopolink.calcContentWidth(text,node,diagram);var defaultDataView=node.part.data.isDefaultDataView();for(var i=0;i<9;i++){var start=CompTopolink.getLinkLabelPosition(i,defaultDataView);var label=node.part.findObject("intfSrc_"+i);if(null!=label&&!label.alignmentFocus.isNoSpot()){var focus=label.alignmentFocus.copy();focus.offsetX=-1*start-width;label.alignmentFocus=focus}}node.part._tmpSrcIntfWidth=width;return text})),new go.Binding("visible","text",(function(v,data){return""!==v})).ofObject(netBrain.Map.CompTopolink.srcLinkIntfInfoLabel)))))),CompTopolink.PanelBuilder(0,new go.Spot(0,1,-30,4),"intfSrc",0,1,templateOptions,scope),CompTopolink.PanelBuilder(0,new go.Spot(0,1,-180,4),"intfSrc",1,2,templateOptions,scope),CompTopolink.PanelBuilder(0,new go.Spot(0,1,-330,4),"intfSrc",8,9,templateOptions,scope),CompTopolink.PanelBuilder(0,new go.Spot(0,1,-30,24),"intfSrc",4,5,templateOptions,scope),CompTopolink.PanelBuilder(0,new go.Spot(0,1,-180,24),"intfSrc",5,6,templateOptions,scope),CompTopolink.PanelBuilder(0,new go.Spot(0,0,-30,-4),"intfSrc",2,3,templateOptions,scope),CompTopolink.PanelBuilder(0,new go.Spot(0,0,-180,-4),"intfSrc",3,4,templateOptions,scope),CompTopolink.PanelBuilder(0,new go.Spot(0,0,-30,-24),"intfSrc",6,7,templateOptions,scope),CompTopolink.PanelBuilder(0,new go.Spot(0,0,-180,-24),"intfSrc",7,8,templateOptions,scope),$(go.Panel,{name:CompTopolink.destInftNameLabel,segmentIndex:-1,alignmentFocus:new go.Spot(1,0,20,-4),segmentOrientation:go.Link.OrientOpposite},$(go.Panel,{},$(go.Panel,{name:CompTopolink.destInftNameLabelPanel,position:new go.Point(0,0)},$(go.Panel,$(go.Shape,{visible:!1}),$(go.TextBlock,{name:netBrain.Map.CompTopolink.destLinkIntfInfoLabel,editable:!1,stroke:"black",font:BindHelper.defaultInftNameFont,background:"white",click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTopolink.EVENT_NAMES.INTF_INFO_LABEL_DEST_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTopolink.EVENT_NAMES.INTF_INFO_LABEL_DEST_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompTopolink.EVENT_NAMES.INTF_INFO_LABEL_DEST_MOUSE_LEAVE,event,target)}},new go.Binding("text","intfDest",(function(intfDest,node){if(null==intfDest)return"";var text=NgUtil.getValueFromObjAndPath(intfDest,"intfInfo.intf.intfDisplaySchemaObj.value","");var width=CompTopolink.calcContentWidth(text,node,diagram);var defaultDataView=node.part.data.isDefaultDataView(!0);for(var i=0;i<9;i++){var start=CompTopolink.getLinkLabelPosition(i,defaultDataView);var label=node.part.findObject("intfDest_"+i);if(null!=label&&!label.alignmentFocus.isNoSpot()){var focus=label.alignmentFocus.copy();focus.offsetX=start+width;label.alignmentFocus=focus}}node.part._tmpDestIntfWidth=width;return text})),new go.Binding("visible","text",(function(v,data){return""!==v})).ofObject(netBrain.Map.CompTopolink.destLinkIntfInfoLabel)))))),CompTopolink.PanelBuilder(-1,new go.Spot(1,0,30,-4),"intfDest",0,1,templateOptions,scope),CompTopolink.PanelBuilder(-1,new go.Spot(1,0,180,-4),"intfDest",1,2,templateOptions,scope),CompTopolink.PanelBuilder(-1,new go.Spot(1,0,330,-4),"intfDest",8,9,templateOptions,scope),CompTopolink.PanelBuilder(-1,new go.Spot(1,0,30,-24),"intfDest",4,5,templateOptions,scope),CompTopolink.PanelBuilder(-1,new go.Spot(1,0,180,-24),"intfDest",5,6,templateOptions,scope),CompTopolink.PanelBuilder(-1,new go.Spot(1,1,30,4),"intfDest",2,3,templateOptions,scope),CompTopolink.PanelBuilder(-1,new go.Spot(1,1,180,4),"intfDest",3,4,templateOptions,scope),CompTopolink.PanelBuilder(-1,new go.Spot(1,1,30,24),"intfDest",6,7,templateOptions,scope),CompTopolink.PanelBuilder(-1,new go.Spot(1,1,180,24),"intfDest",7,8,templateOptions,scope),CompTopolink.dataViewEditModeMask(templateOptions,scope),NormalSelectAdormenTemplate.getLinkBgPanelTemplate(),$(go.Panel,{name:CompTopolink.BaseLineForShowSrc,visible:!1},$(go.Panel,$(go.Shape,{strokeWidth:1,name:CompTopolink.BaseLineShapeForShowSrc},new go.Binding("strokeWidth","intfSrc",(function(obj,node){node.stroke="black";node.strokeDashArray=[0];return 1})),new go.Binding("stroke","l2TopoLinkMode",BindHelper.getTrunkLinkColor),new go.Binding("strokeWidth","l2TopoLinkMode",BindHelper.getTrunkLinkWidth),new go.Binding("stroke","policyStyle",BindHelper.getCustomLineStrokeSrc),new go.Binding("strokeWidth","policyStyle",BindHelper.getCustomLineStrokeWidthSrc),new go.Binding("strokeDashArray","policyStyle",BindHelper.getCustomLineStrokeDashArraySrc),new go.Binding("stroke","customMapStyle",BindHelper.getCustomLineStrokeSrc),new go.Binding("strokeWidth","customMapStyle",BindHelper.getCustomLineStrokeWidthSrc),new go.Binding("strokeDashArray","customMapStyle",BindHelper.getCustomLineStrokeDashArraySrc))),new go.Binding("visible","intfSrc",(function(v){return!!v}))),$(go.Panel,{name:CompTopolink.BaseLineForShowDest,visible:!1},$(go.Panel,$(go.Shape,{strokeWidth:1,name:CompTopolink.BaseLineShapeForShowDest},new go.Binding("strokeWidth","intfDest",(function(obj,node){node.stroke="black";node.strokeDashArray=[0];return 1})),new go.Binding("stroke","l2TopoLinkMode",BindHelper.getTrunkLinkColor),new go.Binding("strokeWidth","l2TopoLinkMode",BindHelper.getTrunkLinkWidth),new go.Binding("stroke","policyStyle",BindHelper.getCustomLineStrokeDest),new go.Binding("strokeWidth","policyStyle",BindHelper.getCustomLineStrokeWidthDest),new go.Binding("strokeDashArray","policyStyle",BindHelper.getCustomLineStrokeDashArrayDest),new go.Binding("stroke","customMapStyle",BindHelper.getCustomLineStrokeDest),new go.Binding("strokeWidth","customMapStyle",BindHelper.getCustomLineStrokeWidthDest),new go.Binding("strokeDashArray","customMapStyle",BindHelper.getCustomLineStrokeDashArrayDest))),new go.Binding("visible","intfDest",(function(v){return!!v}))),$(go.Panel,{name:"HIGHLIGHT_SRC",itemTemplate:$(go.Panel,$(go.Shape,{strokeWidth:3,name:CompTopolink.highlightShapeName},new go.Binding("strokeDashArray","type",BindHelper.lineTypeToArray).makeTwoWay(BindHelper.lineTypeToInt),new go.Binding("strokeDashArray","lineType",BindHelper.lineTypeToArray).makeTwoWay(BindHelper.lineTypeToInt),new go.Binding("strokeWidth","width").makeTwoWay(),new go.Binding("strokeWidth","thickness").makeTwoWay(),new go.Binding("stroke","",BindHelper.colorToStringForInterface).makeTwoWay((function(fill,data,model){model.setDataProperty(data,"color",BindHelper.colorToInt(fill))}))))},new go.Binding("itemArray","intfSrc",(function(intfSrc,node){if(!BindHelper.toTarget_topolink_highlightVisible())return[];var lsRet=intfSrc&&intfSrc.intfInfo&&intfSrc.intfInfo.intfHighlightList;if(!lsRet||0===lsRet.length)return[];var itemArray=lsRet.filter(BindHelper.isLegendVisibleFilter);if(!itemArray||0===itemArray.length)return itemArray;for(var i=0;i<itemArray.length;i++)if(itemArray[i].isHide){itemArray.splice(i,1);i--}return itemArray})),new go.Binding("opacity","isSelected",(function(v,node){node.part.points.length>=0&&node.elements.count>0&&netBrain.Map.LinkHighlightObj.highlightDataListParse(node.part.points,node.part);return v?0:1})).ofObject()),$(go.Panel,{name:"HIGHLIGHT_DEST",itemTemplate:$(go.Panel,$(go.Shape,{strokeWidth:3,name:CompTopolink.highlightShapeName},new go.Binding("strokeDashArray","type",BindHelper.lineTypeToArray).makeTwoWay(BindHelper.lineTypeToInt),new go.Binding("strokeDashArray","lineType",BindHelper.lineTypeToArray).makeTwoWay(BindHelper.lineTypeToInt),new go.Binding("strokeWidth","width").makeTwoWay(),new go.Binding("strokeWidth","thickness").makeTwoWay(),new go.Binding("stroke","",BindHelper.colorToStringForInterface).makeTwoWay((function(fill,data,model){model.setDataProperty(data,"color",BindHelper.colorToInt(fill))}))))},new go.Binding("itemArray","intfDest",(function(intfDest,node){if(!BindHelper.toTarget_topolink_highlightVisible())return[];var lsRet=intfDest&&intfDest.intfInfo&&intfDest.intfInfo.intfHighlightList;if(!lsRet||0===lsRet.length)return[];var itemArray=lsRet.filter(BindHelper.isLegendVisibleFilter);if(!itemArray||0===itemArray.length)return itemArray;for(var i=0;i<itemArray.length;i++)if(itemArray[i].isHide){itemArray.splice(i,1);i--}return itemArray})),new go.Binding("opacity","isSelected",(function(v,node){node.part.points.length>=0&&node.elements.count>0&&netBrain.Map.LinkHighlightObj.highlightDataListParse(node.part.points,node.part);return v?0:1})).ofObject()),$(go.Panel,{name:"linkGraphicF"},$(go.Panel,$(go.Shape,{name:CompTopolink.srcLinkGraphicShape,strokeWidth:1,visible:!1},new go.Binding("stroke","intfSrc",BindHelper.getLinkStatusColor),new go.Binding("strokeWidth","intfSrc",BindHelper.getLinkStatusWidth),new go.Binding("visible","intfSrc",BindHelper.getLinkStatusVisible))),new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject()),$(go.Panel,{name:"linkGraphicT"},$(go.Panel,$(go.Shape,{name:CompTopolink.destLinkGraphicShape,strokeWidth:1,visible:!1},new go.Binding("stroke","intfDest",BindHelper.getLinkStatusColor),new go.Binding("strokeWidth","intfDest",BindHelper.getLinkStatusWidth),new go.Binding("visible","intfDest",BindHelper.getLinkStatusVisible))),new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject()),new go.Binding("points","points",(function(linkPoints,linkObj){return 0===linkPoints.length?linkPoints:netBrain.Map.LinkHighlightObj.highlightDataListParse(linkPoints,linkObj)})).ofObject(),new go.Binding("points","points",(function(data,node){null!=node.data&&(node.data.pointsL2=null);return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayParse(diagram,data,node)})).makeTwoWay((function(pts,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayStringify(diagram,pts,data)})))};CompTopolink.getL3TopoLinkFromL2TopoLink=function(l2TopoLink){if(null===l2TopoLink)return null;var compL3TopoLink=NgUtil.cloneJson(l2TopoLink);compL3TopoLink.category=CompTopolink.getCategory();return netBrain.Map.CompPrototypeFactory.buildCompPrototype(compL3TopoLink)?compL3TopoLink:null};netBrain.Map=netBrain.Map||{};netBrain.Map.CompTopolink=CompTopolink}(NetBrain);!function(netBrain){var CompL2TopoLink=function(type){0===arguments.length?go.Link.call(this):go.Link.call(this,type)};go.Diagram.inherit(CompL2TopoLink,go.Link);CompL2TopoLink.getLinkLabelPosition=function(index,defualt){return 0===index||2===index||4===index||6===index?21:1===index||3===index||5===index||7===index?defualt?22:172:defualt?23:323};CompL2TopoLink.EVENT_NAMES={INTF_INFO_LABEL_SRC_CLICK:"COMP_L2_TOPO_LINK_INTF_INFO_LABEL_SRC_CLICK",INTF_INFO_LABEL_SRC_MOUSE_ENTER:"COMP_L2_TOPO_LINK_INTF_INFO_LABEL_SRC_MOUSE_ENTER",INTF_INFO_LABEL_SRC_MOUSE_LEAVE:"COMP_L2_TOPO_LINK_INTF_INFO_LABEL_SRC_MOUSE_LEAVE",INTF_INFO_LABEL_DEST_CLICK:"COMP_L2_TOPO_LINK_INTF_INFO_LABEL_DEST_CLICK",INTF_INFO_LABEL_DEST_MOUSE_ENTER:"COMP_L2_TOPO_LINK_INTF_INFO_LABEL_DEST_MOUSE_ENTER",INTF_INFO_LABEL_DEST_MOUSE_LEAVE:"COMP_L2_TOPO_LINK_INTF_INFO_LABEL_DEST_MOUSE_LEAVE",LINK_LINE_MOUSE_ENTER:"COMP_L2_TOPO_LINK_LINK_LINE_MOUSE_ENTER",LINK_LINE_MOUSE_LEAVE:"COMP_L2_TOPO_LINK_LINK_LINE_MOUSE_LEAVE"};CompL2TopoLink.getMapTemplate=function(templateOptions,diagram,scope){var $=go.GraphObject.make;var template=new CompL2TopoLink;template.fromSpot=go.Spot.Default;template.toSpot=go.Spot.Default;function getSpotByType(type){var value;switch(type){case 0:value=go.Spot.Top;break;case 1:value=go.Spot.Right;break;case 2:value=go.Spot.Bottom;break;case 3:value=go.Spot.Left;break;case 4:value=go.Spot.Center;break;default:value=go.Spot.Default}return value}template.bind(new go.Binding("fromSpot","fromSpotFrom6X",getSpotByType));template.bind(new go.Binding("toSpot","toSpotFrom6X",getSpotByType));template.layerName=GlobalContext.LinkLayerName;template.reshapable=!0;template.adjusting=go.Link.None;template.routing=go.Link.AvoidsNodes;template.corner=1;var line=new go.Shape;line.name=netBrain.Map.CompTopolink.LineName;line.isPanelMain=!0;line.stroke="black";line.strokeWidth=1;line.opacity=0;line.bind(new go.Binding("stroke","",BindHelper.getTrunkLinkColor).ofObject());line.bind(new go.Binding("strokeWidth","",BindHelper.getTrunkLinkWidth).ofObject());template.add(line);template.bind(new go.Binding("points","pointsL2",(function(data,node){null!=node.data&&(node.data.points=null);return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayParse(diagram,data,node)})).makeTwoWay((function(pts,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionArrayStringify(diagram,pts,data)})));template.add($(go.Panel,{name:netBrain.Map.CompTopolink.srcInftNameLabel,segmentIndex:1,alignmentFocus:new go.Spot(0,1,-10,4),segmentOrientation:go.Link.OrientOpposite},$(go.Panel,{cursor:"pointer"},$(go.Panel,{name:netBrain.Map.CompTopolink.srcInftNameLabelPanel,position:new go.Point(0,0)},$(go.Panel,$(go.Shape,{visible:!1}),$(go.TextBlock,{name:netBrain.Map.CompTopolink.srcLinkIntfInfoLabel,editable:!1,stroke:"black",font:BindHelper.defaultInftNameFont,background:"white",click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompL2TopoLink.EVENT_NAMES.INTF_INFO_LABEL_SRC_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompL2TopoLink.EVENT_NAMES.INTF_INFO_LABEL_SRC_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompL2TopoLink.EVENT_NAMES.INTF_INFO_LABEL_SRC_MOUSE_LEAVE,event,target)}},new go.Binding("text","intfSrc",(function(intfSrc,node){if(null==intfSrc)return"";var width=netBrain.Map.CompTopolink.calcContentWidth(intfSrc.intfInfo.intf.intfDisplaySchemaObj.value,node,diagram);var defaultDataView=intfSrc.dataViewInfo.dataViewType===DataViewType.dvDefault;for(var i=0;i<9;i++){var start=netBrain.Map.CompL2TopoLink.getLinkLabelPosition(i,defaultDataView);var label=node.part.findObject("intfSrc_"+i);if(null!=label&&!label.alignmentFocus.isNoSpot()){var focus=label.alignmentFocus.copy();focus.offsetX=-1*start-width;label.alignmentFocus=focus}}node.part._tmpSrcIntfWidth=width;return intfSrc.intfInfo.intf.intfDisplaySchemaObj.value||""})),new go.Binding("visible","text",(function(v,data){return""!==v})).ofObject(netBrain.Map.CompTopolink.srcLinkIntfInfoLabel)))))));template.add(netBrain.Map.CompTopolink.PanelBuilder(1,new go.Spot(0,1,-30,4),"intfSrc",0,1,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(1,new go.Spot(0,1,-180,4),"intfSrc",1,2,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(1,new go.Spot(0,1,-330,4),"intfSrc",8,9,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(1,new go.Spot(0,1,-30,24),"intfSrc",4,5,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(1,new go.Spot(0,1,-180,24),"intfSrc",5,6,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(1,new go.Spot(0,0,-30,-4),"intfSrc",2,3,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(1,new go.Spot(0,0,-180,-4),"intfSrc",3,4,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(1,new go.Spot(0,0,-30,-24),"intfSrc",6,7,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(1,new go.Spot(0,0,-180,-24),"intfSrc",7,8,templateOptions,scope));template.add($(go.Panel,{name:netBrain.Map.CompTopolink.destInftNameLabel,segmentIndex:-2,alignmentFocus:new go.Spot(1,0,10,-4),segmentOrientation:go.Link.OrientOpposite},$(go.Panel,{cursor:"pointer"},$(go.Panel,{name:netBrain.Map.CompTopolink.destInftNameLabelPanel,position:new go.Point(0,0)},$(go.Panel,$(go.Shape,{visible:!1}),$(go.TextBlock,{name:netBrain.Map.CompTopolink.destLinkIntfInfoLabel,editable:!1,stroke:"black",font:BindHelper.defaultInftNameFont,background:"white",click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompL2TopoLink.EVENT_NAMES.INTF_INFO_LABEL_DEST_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompL2TopoLink.EVENT_NAMES.INTF_INFO_LABEL_DEST_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompL2TopoLink.EVENT_NAMES.INTF_INFO_LABEL_DEST_MOUSE_LEAVE,event,target)}},new go.Binding("text","intfDest",(function(intfDest,node){if(null==intfDest)return"";var width=netBrain.Map.CompTopolink.calcContentWidth(intfDest.intfInfo.intf.intfDisplaySchemaObj.value,node,diagram);var defaultDataView=intfDest.dataViewInfo.dataViewType===DataViewType.dvDefault;for(var i=0;i<9;i++){var start=netBrain.Map.CompL2TopoLink.getLinkLabelPosition(i,defaultDataView);var label=node.part.findObject("intfDest_"+i);if(null!=label&&!label.alignmentFocus.isNoSpot()){var focus=label.alignmentFocus.copy();focus.offsetX=start+width;label.alignmentFocus=focus}}node.part._tmpDestIntfWidth=width;return intfDest.intfInfo.intf.intfDisplaySchemaObj.value||""})),new go.Binding("visible","text",(function(v,data){return""!==v})).ofObject(netBrain.Map.CompTopolink.destLinkIntfInfoLabel)))))));template.add(netBrain.Map.CompTopolink.PanelBuilder(-2,new go.Spot(1,0,30,-4),"intfDest",0,1,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(-2,new go.Spot(1,0,180,-4),"intfDest",1,2,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(-2,new go.Spot(1,0,330,-4),"intfDest",8,9,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(-2,new go.Spot(1,0,30,-24),"intfDest",4,5,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(-2,new go.Spot(1,0,180,-24),"intfDest",5,6,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(-2,new go.Spot(1,1,30,4),"intfDest",2,3,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(-2,new go.Spot(1,1,180,4),"intfDest",3,4,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(-2,new go.Spot(1,1,30,24),"intfDest",6,7,templateOptions,scope));template.add(netBrain.Map.CompTopolink.PanelBuilder(-2,new go.Spot(1,1,180,24),"intfDest",7,8,templateOptions,scope));template.add(CompL2TopoLink.dataViewEditModeMask(templateOptions,scope));template.bind(new go.Binding("data","data",(function(data,link){null!=data&&null!=link&&null!=link.updatePortData&&link.updatePortData(data,link);return data})).ofObject());template.bind(new go.Binding("points","points",(function(linkPoints,linkObj){return netBrain.Map.LinkHighlightObj.highlightDataListParseL2(linkPoints,linkObj)})).ofObject());var selectedBgPanel=NormalSelectAdormenTemplate.getLinkBgPanelTemplate();template.add(selectedBgPanel);var baseLineSrc=new go.Panel;baseLineSrc.name=netBrain.Map.CompTopolink.BaseLineForShowSrc;baseLineSrc.visible=!1;baseLineSrc.bind(new go.Binding("visible","intfSrc",(function(v){return!!v})));var baseLineShapePanelSrc=new go.Panel;var baseLineShapeSrc=new go.Shape;baseLineShapeSrc.name=netBrain.Map.CompTopolink.BaseLineShapeForShowSrc;baseLineShapeSrc.strokeWidth=1;baseLineShapeSrc.bind(new go.Binding("strokeWidth","intfSrc",(function(obj,node){node.stroke="black";node.strokeDashArray=[0];return 1})));baseLineShapeSrc.bind(new go.Binding("stroke","l2TopoLinkMode",BindHelper.getTrunkLinkColor));baseLineShapeSrc.bind(new go.Binding("strokeWidth","l2TopoLinkMode",BindHelper.getTrunkLinkWidth));baseLineShapeSrc.bind(new go.Binding("stroke","policyStyle",BindHelper.getCustomLineStrokeSrc));baseLineShapeSrc.bind(new go.Binding("strokeWidth","policyStyle",BindHelper.getCustomLineStrokeWidthSrc));baseLineShapeSrc.bind(new go.Binding("strokeDashArray","policyStyle",BindHelper.getCustomLineStrokeDashArraySrc));baseLineShapeSrc.bind(new go.Binding("stroke","customMapStyle",BindHelper.getCustomLineStrokeSrc));baseLineShapeSrc.bind(new go.Binding("strokeWidth","customMapStyle",BindHelper.getCustomLineStrokeWidthSrc));baseLineShapeSrc.bind(new go.Binding("strokeDashArray","customMapStyle",BindHelper.getCustomLineStrokeDashArraySrc));baseLineShapePanelSrc.add(baseLineShapeSrc);baseLineSrc.add(baseLineShapePanelSrc);template.add(baseLineSrc);var baseLineDest=new go.Panel;baseLineDest.name=netBrain.Map.CompTopolink.BaseLineForShowDest;baseLineDest.visible=!1;baseLineDest.bind(new go.Binding("visible","intfDest",(function(v){return!!v})));var baseLineShapePanelDest=new go.Panel;var baseLineShapeDest=new go.Shape;baseLineShapeDest.name=netBrain.Map.CompTopolink.BaseLineShapeForShowDest;baseLineShapeDest.strokeWidth=1;baseLineShapeDest.bind(new go.Binding("strokeWidth","intfDest",(function(obj,node){node.stroke="black";node.strokeDashArray=[0];return 1})));baseLineShapeDest.bind(new go.Binding("stroke","l2TopoLinkMode",BindHelper.getTrunkLinkColor));baseLineShapeDest.bind(new go.Binding("strokeWidth","l2TopoLinkMode",BindHelper.getTrunkLinkWidth));baseLineShapeDest.bind(new go.Binding("stroke","policyStyle",BindHelper.getCustomLineStrokeDest));baseLineShapeDest.bind(new go.Binding("strokeWidth","policyStyle",BindHelper.getCustomLineStrokeWidthDest));baseLineShapeDest.bind(new go.Binding("strokeDashArray","policyStyle",BindHelper.getCustomLineStrokeDashArrayDest));baseLineShapeDest.bind(new go.Binding("stroke","customMapStyle",BindHelper.getCustomLineStrokeDest));baseLineShapeDest.bind(new go.Binding("strokeWidth","customMapStyle",BindHelper.getCustomLineStrokeWidthDest));baseLineShapeDest.bind(new go.Binding("strokeDashArray","customMapStyle",BindHelper.getCustomLineStrokeDashArrayDest));baseLineShapePanelDest.add(baseLineShapeDest);baseLineDest.add(baseLineShapePanelDest);template.add(baseLineDest);var hlTemplate=new go.Panel;var hlShape=new go.Shape;hlShape.name=netBrain.Map.CompTopolink.highlightShapeName;hlShape.strokeWidth=3;hlShape.bind(new go.Binding("strokeDashArray","type",BindHelper.lineTypeToArray).makeTwoWay(BindHelper.lineTypeToInt));hlShape.bind(new go.Binding("strokeDashArray","lineType",BindHelper.lineTypeToArray).makeTwoWay(BindHelper.lineTypeToInt));hlShape.bind(new go.Binding("strokeWidth","width").makeTwoWay());hlShape.bind(new go.Binding("strokeWidth","thickness").makeTwoWay());hlShape.bind(new go.Binding("stroke","",BindHelper.colorToStringForInterface).makeTwoWay((function(fill,data,model){model.setDataProperty(data,"color",BindHelper.colorToInt(fill))})));hlTemplate.add(hlShape);var hlSrc=new go.Panel;hlSrc.name="HIGHLIGHT_SRC";hlSrc.itemTemplate=hlTemplate;hlSrc.bind(new go.Binding("itemArray","intfSrc",(function(intfSrc){if(!BindHelper.toTarget_topolink_highlightVisible())return[];var lsRet=intfSrc&&intfSrc.intfInfo&&intfSrc.intfInfo.intfHighlightList;if(!lsRet||0===lsRet.length)return[];var itemArray=lsRet.filter(BindHelper.isLegendVisibleFilter);if(!itemArray||0===itemArray.length)return itemArray;for(var i=0;i<itemArray.length;i++)if(itemArray[i].isHide){itemArray.splice(i,1);i--}return itemArray})));hlSrc.bind(new go.Binding("opacity","isSelected",(function(v,node){node.part.points.length>=0&&node.elements.count>0&&netBrain.Map.LinkHighlightObj.highlightDataListParseL2(node.part.points,node.part);return v?0:1})).ofObject());template.add(hlSrc);var hlDest=new go.Panel;hlDest.name="HIGHLIGHT_DEST";hlDest.itemTemplate=hlTemplate;hlDest.bind(new go.Binding("itemArray","intfDest",(function(intfDest,node){if(!BindHelper.toTarget_topolink_highlightVisible())return[];var lsRet=intfDest&&intfDest.intfInfo&&intfDest.intfInfo.intfHighlightList;if(!lsRet||0===lsRet.length)return[];var itemArray=lsRet.filter(BindHelper.isLegendVisibleFilter);if(!itemArray||0===itemArray.length)return itemArray;for(var i=0;i<itemArray.length;i++)if(itemArray[i].isHide){itemArray.splice(i,1);i--}return itemArray})));hlDest.bind(new go.Binding("opacity","isSelected",(function(v,node){node.part.points.length>=0&&node.elements.count>0&&netBrain.Map.LinkHighlightObj.highlightDataListParseL2(node.part.points,node.part);return v?0:1})).ofObject());template.add(hlDest);template.add(function(){var template=new go.Panel;var shape=new go.Shape;shape.name=netBrain.Map.CompTopolink.srcLinkGraphicShape;shape.strokeWidth=1;shape.bind(new go.Binding("stroke","intfSrc",BindHelper.getLinkStatusColor));shape.bind(new go.Binding("strokeWidth","intfSrc",BindHelper.getLinkStatusWidth));template.add(shape);var link=new go.Panel;link.name="linkGraphicF";link.bind(new go.Binding("visible","intfSrc",BindHelper.getLinkStatusVisible));link.bind(new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject());link.add(template);return link}());template.add(function(){var template=new go.Panel;var shape=new go.Shape;shape.name=netBrain.Map.CompTopolink.destLinkGraphicShape;shape.strokeWidth=1;shape.visible=!1;shape.bind(new go.Binding("stroke","intfDest",BindHelper.getLinkStatusColor));shape.bind(new go.Binding("strokeWidth","intfDest",BindHelper.getLinkStatusWidth));shape.bind(new go.Binding("visible","intfDest",(function(v,node){return null!=v})));template.add(shape);var link=new go.Panel;link.name="linkGraphicT";link.bind(new go.Binding("visible","intfDest",BindHelper.getLinkStatusVisible));link.bind(new go.Binding("opacity","isSelected",(function(v,node){return v?0:1})).ofObject());link.add(template);return link}());template.selectionAdornmentTemplate=NormalSelectAdormenTemplate.getLinkTemplate(!1);template.mouseEnter=function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompL2TopoLink.EVENT_NAMES.LINK_LINE_MOUSE_ENTER,event,target)};template.mouseLeave=function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompL2TopoLink.EVENT_NAMES.LINK_LINE_MOUSE_LEAVE,event,target)};template.click=function(event,target){selectionChanged(target,scope,event)};template.selectionChanged=function(target){selectionChanged(target,scope)};return template};CompL2TopoLink.prototype.updatePortData=function(data,link){var intfSrc=data.getIntfSrc();null!=intfSrc&&null!=link.fromNode&&link.fromNode.updatePortData&&link.fromNode.updatePortData(intfSrc);var intfDest=data.getIntfDest();null!=intfDest&&null!=link.toNode&&link.toNode.updatePortData&&link.toNode.updatePortData(intfDest)};CompL2TopoLink.prototype.computePortEndSegmentLength=function(esl,node,port,spot,from){esl*=1;var thispt=this.getLinkPoint(node,port,spot,from,this.isOrthogonal,this.getOtherNode(node),this.getOtherPort(port));var otherpt=this.getLinkPoint(this.getOtherNode(node),this.getOtherPort(port),spot,from,this.isOrthogonal,node,port);if(Math.abs(thispt.x-otherpt.x)>20||Math.abs(thispt.y-otherpt.y)>20){var pos=port.getPortPos();var row=null!=pos.row?pos.row:0;var col=null!=pos.col?pos.col:0;var ports=node.getRowPorts(netBrain.Map.CompL2Device.VisiblePort,row);var count=ports.length;var index=0;for(var i=0;i<count;i++)ports[i]._ifCol<col&&index++;return 0===row||1===row?otherpt.x<thispt.x?esl+13*index*1:esl+13*(count-index-1)*1:otherpt.y<thispt.y?esl+13*index*1:esl+13*(count-index-1)*1}return esl};CompL2TopoLink.prototype.computeNodeEndSegmentLength=function(esl,node,port,spot,from){var thispt=this.getLinkPoint(node,port,spot,from,this.isOrthogonal,this.getOtherNode(node),this.getOtherPort(port));thispt.x===port.getDocumentPoint(go.Spot.Left).x?esl+=thispt.x-node.getDocumentPoint(go.Spot.Left).x:thispt.x===port.getDocumentPoint(go.Spot.Right).x?esl+=node.getDocumentPoint(go.Spot.Right).x-thispt.x:thispt.y===port.getDocumentPoint(go.Spot.Top).y?esl+=thispt.y-node.getDocumentPoint(go.Spot.Top).y:thispt.y===port.getDocumentPoint(go.Spot.Bottom).y&&(esl+=node.getDocumentPoint(go.Spot.Bottom).y-thispt.y);return esl};CompL2TopoLink.prototype.computeEndSegmentLength=function(node,port,spot,from){var esl=go.Link.prototype.computeEndSegmentLength.call(this,node,port,spot,from);return port instanceof netBrain.Map.CompL2Port?this.computePortEndSegmentLength(esl,node,port,spot,from):this.computeNodeEndSegmentLength(esl,node,port,spot,from)};CompL2TopoLink.prototype.computePoints=function(){var oldPoints=this.points.copy();var flag=go.Link.prototype.computePoints.call(this);var count=this.points.count;if(flag&&count>=8){this._operateCollinear(0,4,!0);this._operateCollinear(count-5,count-1,!1)}if(!function(newEnds,oldEnds){return isDiffPoint(newEnds.from,oldEnds.from)||isDiffPoint(newEnds.to,oldEnds.to)}(getEnds(this.points),getEnds(oldPoints))){var self=this;!function(diagram,action){var oldSkips=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;action();diagram.skipsUndoManager=oldSkips}(this.diagram,(function(){self.points=oldPoints}))}return flag};function isDiffPoint(point1,point2){return!point1||!point2||point1.x!==point2.x||point1.y!==point2.y}function getEnds(points){return{from:points.first(),to:points.last()}}CompL2TopoLink.prototype._operateCollinear=function(startIndex,endIndex,isFrom){var points=this.points;var pointArr=[];for(var i=startIndex;i<=endIndex;i++)pointArr.push(points.elt(i));var collinearType=getCollinearType.apply(null,pointArr);if(0!==collinearType){var nextIndex=isFrom?endIndex+1:startIndex-1;var lastPoint=points.elt(isFrom?endIndex:startIndex);var prevLastPoint=points.elt(isFrom?endIndex-1:startIndex+1);var nextPoint=points.elt(nextIndex);if(1===collinearType)if(nextPoint.x-lastPoint.x>0){lastPoint.x+=10;prevLastPoint.x+=10}else{lastPoint.x-=10;prevLastPoint.x-=10}else if(nextPoint.y-lastPoint.y>0){lastPoint.y+=10;prevLastPoint.y+=10}else{lastPoint.y-=10;prevLastPoint.y-=10}}};function getCollinearType(){var result=0;var points=Array.prototype.slice.apply(arguments);if(points.length<3)return result;var p0=points[0];var len=points.length;var xCount=0;var yCount=0;for(var i=1;i<len;i++){var tmpP=points[i];p0.x===tmpP.x&&xCount++;p0.y===tmpP.y&&yCount++}xCount===len-1?result=1:yCount===len-1&&(result=2);return result}CompL2TopoLink.dataViewEditModeMask=function(templateOptions,scope){var $=go.GraphObject.make;return $(go.Panel,$(go.Panel,$(go.Shape,{name:"editDataViewLinkMask",stroke:"#1B7FC2",strokeWidth:50,visible:!1,opacity:.4,cursor:"pointer",click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(netBrain.Map.CompTopolink.EVENT_NAMES.EDIT_DATA_VIEW_LINK_MASK_CLICK,event,target)}})))};CompL2TopoLink.showDataViewLinkMask=function(event,link,templateOptions){var isDest=netBrain.Map.CompTopolink.showDataViewLinkMask(event,link,templateOptions);if(null!=templateOptions&&templateOptions.isEditMode()&&!(link.part.opacity<1)){var mask=link.findObject("editDataViewLinkMask");if(!0===mask.visible){var lineObj;lineObj=isDest?link.findObject(netBrain.Map.CompTopolink.BaseLineShapeForShowDest):link.findObject(netBrain.Map.CompTopolink.BaseLineShapeForShowSrc);mask.geometry=lineObj.geometry.copy();mask.segmentIndex=-1/0;var linePanelFocus=lineObj.panel.panel.alignmentFocus;var af=new go.Spot(0,0,linePanelFocus.offsetX+24,linePanelFocus.offsetY+24);mask.panel.panel.alignmentFocus=af;mask.width=NaN}}};CompL2TopoLink.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var CompTopolink=netBrain.Map.CompTopolink;var TopoCustomizeLink=netBrain.Map.TopoCustomizeLink;var labelAngleSrc=this.findObject(CompTopolink.srcLinkIntfInfoLabel).getDocumentAngle();if(this.findObject(CompTopolink.srcInftNameLabelPanel).opacity>0){var intfNameSrcInfo=visioTools.getTextVisioInfo(this,CompTopolink.srcLinkIntfInfoLabel);if(intfNameSrcInfo){intfNameSrcInfo.angle=labelAngleSrc;visioTools.addDirection(intfNameSrcInfo,!0);visioInfos.push(intfNameSrcInfo)}}var labelAngleDest=this.findObject(CompTopolink.destLinkIntfInfoLabel).getDocumentAngle();if(this.findObject(CompTopolink.destInftNameLabelPanel).opacity>0){var intfNameDestInfo=visioTools.getTextVisioInfo(this,CompTopolink.destLinkIntfInfoLabel);if(intfNameDestInfo){intfNameDestInfo.angle=labelAngleDest;visioTools.addDirection(intfNameDestInfo,!1);visioInfos.push(intfNameDestInfo)}}var posListInfos=TopoCustomizeLink.prototype.getPosListVisioInfos.apply(this);_.each(posListInfos,(function(posInfo){posInfo.angle=posInfo.isFrom?labelAngleSrc:labelAngleDest}));visioInfos=visioInfos.concat(posListInfos);var baseLineShapeInfoSrc=visioTools.getShapeVisioInfo(this,CompTopolink.BaseLineShapeForShowSrc);visioTools.addDirection(baseLineShapeInfoSrc,!0);visioTools.addLayerName(baseLineShapeInfoSrc,1);visioInfos.push(baseLineShapeInfoSrc);var baseLineShapeInfoDest=visioTools.getShapeVisioInfo(this,CompTopolink.BaseLineShapeForShowDest);visioTools.addDirection(baseLineShapeInfoDest,!1);visioTools.addLayerName(baseLineShapeInfoDest,1);visioInfos.push(baseLineShapeInfoDest);var highlightInfos=TopoCustomizeLink.prototype.getHighlightVisioInfos.apply(this);visioInfos=visioInfos.concat(highlightInfos);var monitorSrcPanel=this.findObject("linkGraphicF");if(monitorSrcPanel&&monitorSrcPanel.visible){var mSrcInfos=visioTools.getShapeVisioInfo(this,CompTopolink.srcLinkGraphicShape);visioTools.addDirection(mSrcInfos,!0);visioTools.addLayerName(mSrcInfos,3);mSrcInfos&&visioInfos.push(mSrcInfos)}var monitorDestPanel=this.findObject("linkGraphicT");if(monitorDestPanel&&monitorDestPanel.visible){var mDestInfos=visioTools.getShapeVisioInfo(this,CompTopolink.destLinkGraphicShape);visioTools.addDirection(mDestInfos,!1);visioTools.addLayerName(mDestInfos,3);mDestInfos&&visioInfos.push(mDestInfos)}var alarmPanels=[];for(var i=0;i<=8;++i){alarmPanels.push(this.findObject("intfSrc_"+i));alarmPanels.push(this.findObject("intfDest_"+i))}alarmPanels.forEach((function(alarmPanel){alarmPanel&&alarmPanel.visible&&alarmPanel.elements.each((function(tmp){var itemObj=tmp.findObject(CompTopolink.alarmLabel);var itemInfo=netBrain.Map.visioTools.getShapeInfo(itemObj);"undefined"!==itemInfo.type&&visioInfos.push(itemInfo)}))}));return visioTools.buildLinkVisioInfo(visioInfos,this.data,this)};netBrain.Map=netBrain.Map||{};netBrain.Map.CompL2TopoLink=CompL2TopoLink;function selectionChanged(link,scope,event){if(!event||!link.isSelected||scope&&_.isFunction(scope.isEditMode)&&scope.isEditMode())scope&&_.isFunction(scope.$emit)&&scope.$emit("hideTopoLinkTip");else{var fromNode=link.fromNode;var toNode=link.toNode;if(!fromNode||!toNode)return;var fromCategory=fromNode.category;var toCategory=toNode.category;var CategoryMgr=netBrain.Map.CategoryMgr;var getInterface=function(name){var textBlock=link.findObject(name);return textBlock?textBlock.text:""};var getMediaDevType=function(node){var devType=node.data.getDevType()||"";var result=devType.toUpperCase();netBrain.Map.gMediaTypeMgr.isMuteLanType(devType)&&(result="Mute LAN");return result};var getHostname=function(node){var data=node.data;var hostname=data?data.getHostname():"";Array.isArray(hostname)&&(hostname=hostname.join(" "));return hostname};if(CategoryMgr.isSite(fromCategory)||CategoryMgr.isSite(toCategory));else{var fromHostname=getHostname(fromNode);var toHostname=getHostname(toNode);var fromInterface="";var toInterface="";var fromMediaDevType="";var toMediaDevType="";CategoryMgr.isMedia(fromCategory)?fromMediaDevType=getMediaDevType(fromNode):fromInterface=getInterface(netBrain.Map.CompTopolink.srcLinkIntfInfoLabel);CategoryMgr.isMedia(toCategory)?toMediaDevType=getMediaDevType(toNode):toInterface=getInterface(netBrain.Map.CompTopolink.destLinkIntfInfoLabel);var fromObj={hostname:fromHostname,interface:fromInterface,mediaDevType:fromMediaDevType};var toObj={hostname:toHostname,interface:toInterface,mediaDevType:toMediaDevType};if(CategoryMgr.isMedia(fromCategory)){var tmp=fromObj;fromObj=toObj;toObj=tmp}scope&&_.isFunction(scope.$emit)&&scope.$emit("showTopoLinkTip",event,{title:function(link){var topoType=link.data.topoType;var title="";var allTopoLinkType=netBrain.AllTopoLinkType;if(allTopoLinkType)for(var i=0,len=allTopoLinkType.length;i<len;i++){var tmp=allTopoLinkType[i];if(tmp&&tmp.ID===topoType){title=tmp.name;break}}return title}(link),from:fromObj,to:toObj})}}}}(NetBrain);NetBrain;!function(netBrain){function mult(a,b,c){return(a.x-c.x)*(b.y-c.y)-(b.x-c.x)*(a.y-c.y)}function intersect(p0,p1,p2,p3){var flag=!0;Math.max(p0.x,p1.x)<=Math.min(p2.x,p3.x)?flag=!1:Math.max(p0.y,p1.y)<=Math.min(p2.y,p3.y)?flag=!1:Math.max(p2.x,p3.x)<=Math.min(p0.x,p1.x)?flag=!1:Math.max(p2.y,p3.y)<=Math.min(p0.y,p1.y)?flag=!1:mult(p2,p1,p0)*mult(p1,p3,p0)<=0?flag=!1:mult(p0,p3,p2)*mult(p3,p1,p2)<=0&&(flag=!1);return flag}function overlay(p0,p1,p2,p3){var flag=!1;var seg1=[p0,p1];var seg2=[p2,p3];p0.x===p2.x&&p1.x===p3.x?(pointOnSeg(p0,"y",seg2)||pointOnSeg(p1,"y",seg2)||pointOnSeg(p2,"y",seg1)||pointOnSeg(p3,"y",seg1))&&(flag=!0):p0.y===p2.y&&p1.y===p3.y&&(pointOnSeg(p0,"x",seg2)||pointOnSeg(p1,"x",seg2)||pointOnSeg(p2,"x",seg1)||pointOnSeg(p3,"x",seg1))&&(flag=!0);return flag}function pointOnSeg(p,prop,seg){var p1=seg[0];var p2=seg[1];var pv=p[prop];var p1v=p1[prop];var p2v=p2[prop];var flag=!1;pv>Math.min(p1v,p2v)&&pv<Math.max(p1v,p2v)&&(flag=!0);return flag}function getIntersectCount(links){var lines=[];links.each((function(link){if(link instanceof netBrain.Map.CompL2TopoLink){var points=link.points.toArray();for(var i=1,len=points.length;i<len;i++){var pt0=points[i-1];var pt1=points[i];if(pt0.x!==pt1.x||pt0.y!==pt1.y){var prevLine=lines[lines.length-1];if(prevLine){var prevS=prevLine[0];var prevE=prevLine[1];if(prevS.x===prevE.x&&prevE.x===pt1.x||prevS.y===prevE.y&&prevE.y===pt1.y){prevLine[1]=pt1;continue}}lines.push([pt0,pt1])}}}}));var lineLen=lines.length;var intersectCount=0;var overlayCount=0;for(var i=0;i<lineLen;i++){var line1=lines[i];for(var j=i+1;j<lineLen;j++){var line2=lines[j];var flag=intersect(line1[0],line1[1],line2[0],line2[1]);flag&&intersectCount++;(flag=overlay(line1[0],line1[1],line2[0],line2[1]))&&overlayCount++}}console.log("intersect: ",intersectCount);console.log("overlay: ",overlayCount);return{intersectCount:intersectCount,overlayCount:overlayCount}}getIntersectCount.forTest={mult:mult,intersect:intersect,overlay:overlay,pointOnSeg:pointOnSeg,getIntersectCount:getIntersectCount};NetBrain.Map.CompL2TopoLink.getIntersectCount=getIntersectCount}(NetBrain);!function(netBrain){var CompVirtualLink=function(){netBrain.Map.CompTopolink.call(this);this.category=netBrain.Map.CategoryMgr.VirtualTopoLink};CompVirtualLink.prototype=new netBrain.Map.CompTopolink;CompVirtualLink.getMapTemplate=function(templateOptions,diagram,bIsL2Link,scope){return netBrain.Map.CompTopolink.getMapTemplate(templateOptions,diagram,bIsL2Link,scope)};CompVirtualLink.getDefaultJsDataForLinkLine=function(){var obj=netBrain.Map.CompTopolink.getDefaultJsDataForLinkLine();obj.category=netBrain.Map.CategoryMgr.VirtualTopoLink;return obj};netBrain.Map=netBrain.Map||{};netBrain.Map.CompVirtualLink=CompVirtualLink}(NetBrain);!function(netBrain){var CompGenericVirtualLink=function(){netBrain.Map.CompTopolink.call(this)};(CompGenericVirtualLink.prototype=new netBrain.Map.CompTopolink).init=function(){};CompGenericVirtualLink.getMapTemplate=null;CompGenericVirtualLink.getDefaultJsDataForLinkLine=null;netBrain.Map=netBrain.Map||{};netBrain.Map.CompGenericVirtualLink=CompGenericVirtualLink}(NetBrain);!function(netBrain){function openEditLinkDialog(event,target,showFun,activeEditDU){netBrain.Map.CompTopolink.openEditLinkDialog(event,target,showFun,activeEditDU)}function devicePictureClick(scope,event,target,activeEditDU){if(null!=scope.dlgExtendNeighbor){scope.dlgExtendNeighbor.closeExtendNbrDialog();scope.closeSwitchVisualSpaceSelect()}scope.clickDevice(event,target);if(scope.isEditMode()&&!netBrain.Map.CategoryMgr.isStencilDevice(target.part.data.category)){var ptConvert=event.targetDiagram.transformDocToView(event.diagram.lastInput.documentPoint);var clickXPos=ptConvert.x;var clickYPos=ptConvert.y;var vpBounds=event.diagram.viewportBounds;var vpHeight=vpBounds.height;var vpWidth=vpBounds.width;var targetPos={x:clickXPos,y:clickYPos};vpWidth-clickXPos<450&&(targetPos.x-=450-(vpWidth-clickXPos));vpHeight-clickYPos<550&&(targetPos.y-=550-(vpHeight-clickYPos));scope.openEditDevice(targetPos,target,activeEditDU)}}function getDataUnitPanelFromEle(ele){if(ele.data)return ele;var count=10;var tempPanel=ele;var itemData;for(;count>0;){if((tempPanel=tempPanel.panel)&&tempPanel.data){itemData=tempPanel.data;break}count--}return itemData?tempPanel:null}function drillDownIconClicked(scope,event,target){var itemPanel=getDataUnitPanelFromEle(target);if(itemPanel){var posInfo=itemPanel.data;var deviceId,intfKey;if(target.part instanceof go.Node)deviceId=target.part.data.key;else{var isFrom=itemPanel.panel.segmentIndex>-1;var linkData=target.part.data;deviceId=isFrom?linkData.from:linkData.to;intfKey=isFrom?linkData.fromPort:linkData.toPort}var info={deviceId:deviceId};intfKey&&(info.intfKey=intfKey);scope.devIntfDrillDownIconClicked(event,target,posInfo,info)}}netBrain.Map=netBrain.Map||{};netBrain.Map.mapTemplateEventsProvider=function(scope,shapeOptions,linkOptions){!function(scope){var eventNames=netBrain.Map.CompDevice.EVENT_NAMES;scope.$on(eventNames.HOSTNAME_PANEL_CLICK,(function(e,event,target){console.warn("hostname clicked.")}));scope.$on(eventNames.HOSTNAME_LABEL_CLICK,(function(e,event,target){scope.devPosLabelClicked(event,target,netBrain.Map.CompDevice.hostNameLable)}));scope.$on(eventNames.PICTURE_CLICK,(function(e,event,target){devicePictureClick(scope,event,target)}));scope.$on(eventNames.PICTURE_MOUSE_ENTER,(function(e,event,target){!function(event,target){if(target.part.category===netBrain.Map.CategoryMgr.NetworkDevice&&!scope.isEditMode()){var point=event.targetDiagram.transformDocToView(target.part.getDocumentPoint(go.Spot.TopRight));point.y-=40;point.x-=10}netBrain.Map.CompDevice.devPosPanelEnter(target,scope.isEditMode())}(event,target)}));scope.$on(eventNames.PICTURE_MOUSE_LEAVE,(function(e,event,target){netBrain.Map.CompDevice.devPosPanelLeave(target,scope.isEditMode())}));scope.$on(eventNames.PICTURE_DOUBLE_CLICK,(function(e,event,target){scope.doubleClickDevice(event,target)}));scope.$on(eventNames.PLUS_ICON_CLICK,(function(e,event,target){scope.isEditMode()||scope.redPlusClick(event,target)}))}(scope);!function(scope,linkOptions){var eventNames=netBrain.Map.CCompLabel.EVENT_NAMES;scope.$on(eventNames.DEVICE_LABEL_PANEL_CLICK,(function(e,event,target){scope.isEditMode()?devicePictureClick(scope,event,target):scope.devPosLabelClicked(event,target,"")}));scope.$on(eventNames.DEVICE_DRILL_DOWN_ICON_CLICK,(function(e,event,target){event.handled=!0;scope.isEditMode()||drillDownIconClicked(scope,event,target)}));scope.$on(eventNames.DEVICE_EDIT_DATA_UNIT_ICON_CLICK,(function(e,event,target){event.handled=!0;scope.isEditMode()&&devicePictureClick(scope,event,target.panel,!0)}));scope.$on(eventNames.LINK_DRILL_DOWN_ICON_CLICK,(function(e,event,target){event.handled=!0;scope.isEditMode()||drillDownIconClicked(scope,event,target)}));scope.$on(eventNames.LINK_EDIT_DATA_UNIT_ICON_CLICK,(function(e,event,target){event.handled=!0;linkLabelClickFork(event,getDataUnitPanelFromEle(target),!0)}));scope.$on(eventNames.LINK_LABEL_ICON_PANEL_CLICK,(function(e,event,target){event.handled=!0;linkLabelClickFork(event,target)}));scope.$on(eventNames.LINK_LABEL_ICON_PANEL_MOUSE_ENTER,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkLabelMouseEnter(event,target)}));scope.$on(eventNames.LINK_LABEL_ICON_PANEL_MOUSE_LEAVE,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkLabelMouseLeave(event,target)}));scope.$on(eventNames.LINK_TEXT_CLICK,(function(e,event,target){event.handled=!0;linkLabelClickFork(event,target)}));scope.$on(eventNames.LINK_TEXT_MOUSE_ENTER,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkLabelMouseEnter(event,target)}));scope.$on(eventNames.LINK_TEXT_MOUSE_LEAVE,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkLabelMouseLeave(event,target)}));scope.$on(eventNames.LINK_ALARM_LABEL_CLICK,(function(e,event,target){event.handled=!0;linkLabelClickFork(event,target)}));scope.$on(eventNames.LINK_ALARM_LABEL_MOUSE_ENTER,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkLabelMouseEnter(event,target)}));scope.$on(eventNames.LINK_ALARM_LABEL_MOUSE_LEAVE,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkLabelMouseLeave(event,target)}));function linkLabelClickFork(event,target,activeEditDU){if(_.isFunction(scope.isEditMode)&&scope.isEditMode()){var itemPanel=getDataUnitPanelFromEle(target);if(itemPanel){var itemData=itemPanel.data;if(itemData){var link=target.part;var isFrom=!BindHelper.isLinkLabelBelongDest(itemData.posInfo,link.data);target.editingNode=isFrom?link.fromNode.data:link.toNode.data;openEditLinkDialog(event,target,linkOptions.editLinkShow,activeEditDU)}}}else!function(event,target){linkOptions.linkLabelClick(event,target)}(event,target)}function linkLabelMouseEnter(event,target){target.opacity>.9&&linkOptions.linkLabelMouseEnter(event,target)}function linkLabelMouseLeave(event,target){target.opacity>.9&&linkOptions.linkLabelMouseLeave(event,target)}}(scope,linkOptions);!function(scope){var eventNames=netBrain.Map.CompDeviceGroup.EVENT_NAMES;scope.$on(eventNames.PICTURE_PANEL_DOUBLE_CLICK,(function(e,event,target){scope.$emit("doubleClickDeviceGroup",event,target)}));scope.$on(eventNames.HOSTNAME_DOUBLE_CLICK,(function(e,event,target){scope.$emit("doubleClickDeviceGroup",event,target)}))}(scope);!function(scope){var eventNames=netBrain.Map.CompDeviceNote.EVENT_NAMES;scope.$on(eventNames.DEVICE_NOTE_CONTEXT_CLICK,(function(e,event,target){scope.showArrangeToolbar(target)}));scope.$on(eventNames.DEVICE_NOTE_MOUSE_ENTER,(function(e,event,target){var netmap=scope.netmap;!netmap&&_.isFunction(netmap.showCompoundNoteLinks)||netmap.showCompoundNoteLinks(target)}));scope.$on(eventNames.DEVICE_NOTE_MOUSE_LEAVE,(function(e,event,target){var netmap=scope.netmap;!netmap&&_.isFunction(netmap.hideCompoundNoteLinks)||netmap.hideCompoundNoteLinks(target)}));scope.$on(eventNames.NOTE_TITLE_OR_CONTENT_CHANGE,(function(e,textBlock,data,oldTitle){if(data.noteFromType===NetBrain.Map.Const.NoteFromType.DataView){var part=textBlock.part;var noteKey=part.data.key;var linkedInfos=[];part.linksConnected.each((function(l){var linkData=l.data;var deviceKey;var portId;if(linkData.from===noteKey){deviceKey=linkData.to;portId=linkData.toPort}else{deviceKey=linkData.from;portId=linkData.fromPort}var result={deviceKey:deviceKey};portId&&(result.portId=portId);linkedInfos.push(result)}));var newNoteData=NgUtil.cloneJson(data);newNoteData.modifyTime=new Date;scope.$broadcast("dataViewNoteValueChanged",newNoteData,linkedInfos,oldTitle)}}));scope.$on(eventNames.NOTE_EXTEND_LINK_CLICK,(function(e,event,target){var linkExtendData=target.part.data.linkExtendData;scope.$emit(RunBookEvent.SelectedRunbookNodeAndResult,linkExtendData)}));scope.$on(eventNames.NOTE_DATAVIEW_DETAIL_LINK_CLICK,(function(e,event,target){var noteData=target.part.data;var CategoryMgr=NetBrain.Map.CategoryMgr;if(noteData.noteFromType===NetBrain.Map.Const.NoteFromType.DataView){var deviceId;var intf;noteData.isCompound&&_.size(noteData.deviceIds)>0?deviceId=noteData.deviceIds[0]:target.part.findLinksOutOf().each((function(link){if(CategoryMgr.isNormalLink(link.data.category)&&!deviceId){var toNode=link.toNode;CategoryMgr.isNetworkDevice(toNode.data.category)&&(deviceId=toNode.data.key);intf=NgUtil.getValueFromObjAndPath(link,"data.intfDest.intfInfo.intf")}}));if(deviceId){var deviceData=target.part.diagram.model.findNodeDataForKey(deviceId);deviceData&&scope.noteViewDetailClicked(event,target,{deviceData:deviceData,noteData:noteData,intf:intf})}}}))}(scope);!function(scope,shapeOptions){var eventNames=netBrain.Map.DrawShapeCommonAttr.EVENT_NAMES;scope.$on(eventNames.COMMON_NODE_ATTR_DOUBLE_CLICK,(function(e,event,target){shapeOptions.shapDBClick(event,target)}));scope.$on(eventNames.COMMON_NODE_ATTR_CONTEXT_CLICK,(function(e,event,target){shapeOptions.shapeClick(event,target)}))}(scope,shapeOptions);!function(scope,shapeOptions){var eventNames=netBrain.Map.CompTable.EVENT_NAMES;scope.$on(eventNames.CONTEXT_CLICK,(function(e,event,target){target.part.diagram.selection.count>1&&shapeOptions.shapeClick(event,target)}))}(scope,shapeOptions);!function(scope,shapeOptions){var eventNames=netBrain.Map.CompText.EVENT_NAMES;scope.$on(eventNames.TEXT_CONTENT_CLICK,(function(e,event,target){shapeOptions.shapeClick(event,target)}))}(scope,shapeOptions);!function(scope){var eventNames=netBrain.Map.CompSite.EVENT_NAMES;scope.$on(eventNames.MAIN_MOUSE_ENTER,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||scope.$emit("siteInfoMousEnter",event,target)}));scope.$on(eventNames.MAIN_MOUSE_LEAVE,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||scope.$emit("siteInfoMouseLeave",event,target)}));scope.$on(eventNames.MAIN_DOUBLE_CLICK,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||scope.$emit("doubleClickSite",event,target)}));scope.$on(eventNames.PLUS_ICON_CLICK,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||scope.redPlusClick(event,target)}));scope.$on(eventNames.OVERVIEW_MAIN_MOUSE_ENTER,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||scope.$emit("siteInfoMousEnter",event,target)}));scope.$on(eventNames.OVERVIEW_MAIN_MOUSE_LEAVE,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||scope.$emit("siteInfoMouseLeave",event,target)}));scope.$on(eventNames.OVERVIEW_MAIN_DOUBLE_CLICK,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||scope.$emit("doubleClickSite",event,target)}))}(scope);!function(scope,linkOptions){var eventNames=netBrain.Map.CompTopolink.EVENT_NAMES;scope.$on(eventNames.LINK_LINE_MOUSE_ENTER,(function(e,event,target){netBrain.Map.CompTopolink.showDataViewLinkMask(event,target,linkOptions)}));scope.$on(eventNames.LINK_LINE_MOUSE_LEAVE,(function(e,event,target){netBrain.Map.CompTopolink.hideDataViewLinkMask(target,linkOptions)}));scope.$on(eventNames.INTF_INFO_LABEL_SRC_CLICK,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkOptions.linkLabelClick(event,target)}));scope.$on(eventNames.INTF_INFO_LABEL_SRC_MOUSE_ENTER,(function(e,event,target){if(target.opacity>.9){if(_.isFunction(scope.isEditMode)&&scope.isEditMode())return;linkOptions.linkLabelMouseEnter(event,target)}}));scope.$on(eventNames.INTF_INFO_LABEL_SRC_MOUSE_LEAVE,(function(e,event,target){if(target.opacity>.9){if(_.isFunction(scope.isEditMode)&&scope.isEditMode())return;linkOptions.linkLabelMouseLeave(event,target)}}));scope.$on(eventNames.INTF_INFO_LABEL_DEST_CLICK,(function(e,event,target){_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkOptions.linkLabelClick(event,target)}));scope.$on(eventNames.INTF_INFO_LABEL_DEST_MOUSE_ENTER,(function(e,event,target){if(target.opacity>.9){if(_.isFunction(scope.isEditMode)&&scope.isEditMode())return;linkOptions.linkLabelMouseEnter(event,target)}}));scope.$on(eventNames.INTF_INFO_LABEL_DEST_MOUSE_LEAVE,(function(e,event,target){if(target.opacity>.9){if(_.isFunction(scope.isEditMode)&&scope.isEditMode())return;linkOptions.linkLabelMouseLeave(event,target)}}));scope.$on(eventNames.EDIT_DATA_VIEW_LINK_MASK_CLICK,(function(e,event,target){event.handled=!0;openEditLinkDialog(event,target,linkOptions.editLinkShow)}))}(scope,linkOptions);!function(scope,linkOptions){var eventNames=netBrain.Map.CompL2TopoLink.EVENT_NAMES;scope.$on(eventNames.INTF_INFO_LABEL_SRC_CLICK,(function(e,event,target){event.handled=!0;_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkOptions.linkLabelClick(event,target)}));scope.$on(eventNames.INTF_INFO_LABEL_SRC_MOUSE_ENTER,(function(e,event,target){if(target.opacity>.9){if(_.isFunction(scope.isEditMode)&&scope.isEditMode())return;linkOptions.linkLabelMouseEnter(event,target)}}));scope.$on(eventNames.INTF_INFO_LABEL_SRC_MOUSE_LEAVE,(function(e,event,target){if(target.opacity>.9){if(_.isFunction(scope.isEditMode)&&scope.isEditMode())return;linkOptions.linkLabelMouseLeave(event,target)}}));scope.$on(eventNames.INTF_INFO_LABEL_DEST_CLICK,(function(e,event,target){event.handled=!0;_.isFunction(scope.isEditMode)&&scope.isEditMode()||linkOptions.linkLabelClick(event,target)}));scope.$on(eventNames.INTF_INFO_LABEL_DEST_MOUSE_ENTER,(function(e,event,target){if(target.opacity>.9){if(_.isFunction(scope.isEditMode)&&scope.isEditMode())return;linkOptions.linkLabelMouseEnter(event,target)}}));scope.$on(eventNames.INTF_INFO_LABEL_DEST_MOUSE_LEAVE,(function(e,event,target){if(target.opacity>.9){if(_.isFunction(scope.isEditMode)&&scope.isEditMode())return;linkOptions.linkLabelMouseLeave(event,target)}}));scope.$on(eventNames.LINK_LINE_MOUSE_ENTER,(function(e,event,target){netBrain.Map.CompL2TopoLink.showDataViewLinkMask(event,target,linkOptions)}));scope.$on(eventNames.LINK_LINE_MOUSE_LEAVE,(function(e,event,target){netBrain.Map.CompTopolink.hideDataViewLinkMask(target,linkOptions)}))}(scope,linkOptions);!function(scope,linkOptions){var eventNames=netBrain.Map.CompLine.EVENT_NAMES;scope.$on(eventNames.CONTEXT_CLICK,(function(e,event,target){linkOptions.shapeClick(event,target)}))}(scope,shapeOptions);!function(scope,linkOptions){var eventNames=netBrain.Map.CompPathNewBase.EVENT_NAMES;scope.$on(eventNames.CLICK,(function(e,event,target){linkOptions.pathClick(event,target)}))}(scope,shapeOptions);!function(scope,linkOptions){var eventNames=netBrain.Map.CompPathNew.EVENT_NAMES;scope.$on(eventNames.CLICK,(function(e,event,target){linkOptions.pathClick(event,target)}));scope.$on(eventNames.CONTEXT_CLICK,(function(e,event,target){_.isFunction(linkOptions.pathContextClick)&&linkOptions.pathContextClick(event,target)}))}(scope,shapeOptions)}}(NetBrain);!function(netBrain){netBrain.Map=netBrain.Map||{};netBrain.Map.mapTemplateProvider=function(pMap,pScope,overviewsite,isL2Style){var map=void 0===pMap?null:pMap;var scope=void 0===pScope?null:pScope;var $=go.GraphObject.make;var overLapHandler=function(p){p.isSelected?p.layerName="Foreground":p.layerName=""};var fnLocationParse=function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)};var fnPointStringify=function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)};var CompMuteLanNode=function(){go.Node.apply(this,arguments)};go.Diagram.inherit(CompMuteLanNode,go.Node);CompMuteLanNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var picObj=this.findObject("IMAGE");var picInfo=visioTools.getPictureInfo(picObj,!0);visioInfos.push(picInfo);return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};var _mapMuteLanTemplate=$(CompMuteLanNode,"Spot",{portId:""},$(go.Picture,{name:"IMAGE",desiredSize:new go.Size(102,62),scale:netBrain.Map.Const.iconOnMapScale,source:netBrain.NG.Const.iconImagePath+"00000000-0000-0000-0000-00000000008e.png",cursor:"point"},new go.Binding("visible").makeTwoWay(),new go.Binding("location","location",fnLocationParse).makeTwoWay(fnPointStringify)));var CompHyperLinkNode=function(){go.Node.apply(this,arguments)};go.Diagram.inherit(CompHyperLinkNode,go.Node);CompHyperLinkNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var shapeInfo;var shapeObj=this.findObject(netBrain.Map.DrawShapeCommonAttr.ObjName);shapeObj&&(shapeInfo=visioTools.getShapeInfo(shapeObj))&&visioInfos.push(shapeInfo);var textObj=this.findObject("hyperLinkText");var textInfo=visioTools.getTextInfo(textObj);visioInfos.push(textInfo);return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};var _mapHyperLinkTemplate=$(CompHyperLinkNode,{selectionObjectName:"hyperLinkText",locationSpot:go.Spot.Center,selectionChanged:function(target){var textBlock=target.findObject("hyperLinkText");scope.netMapObjsSelection&&scope.netMapObjsSelection.insertPageObj(textBlock)}},$(go.Shape,netBrain.Map.DrawShapeCommonAttr.getCommonShapeAttr()),new go.Binding("location","location",fnLocationParse).makeTwoWay(fnPointStringify),$(go.TextBlock,{name:"hyperLinkText",stroke:"blue",isUnderline:!0,cursor:cursorHelper.pointer,margin:new go.Margin(6,0,0,2),mouseOver:function(event,target){target.stroke="lightblue"},mouseLeave:function(event,target){target.stroke="blue"},click:function(event,target){var url=target.panel.data.url;if(url){"http"!==url.substring(0,4)&&(url="http://"+url);window.open(url)}}},new go.Binding("text","displayName")));var CompMapNoteLink=function(){go.Link.apply(this,arguments)};go.Diagram.inherit(CompMapNoteLink,go.Link);CompMapNoteLink.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var shapeInfo=visioTools.getShapeVisioInfo(this,"mapNoteLinkShape");visioInfos.push(shapeInfo);return visioTools.buildLinkVisioInfo(visioInfos,this.data,this)};var _mapNotesLinkTemplate=$(CompMapNoteLink,{selectionChanged:overLapHandler},$(go.Shape,{name:"mapNoteLinkShape"}));var _mapAnonymTreeLinkTemplate=$(go.Link,{routing:go.Link.Orthogonal,corner:5},$(go.Shape,{strokeWidth:1,stroke:"#000000"}));var _nodeTemplateMap=new go.Map;var _linkTemplateMap=new go.Map;var _groupTemplateMap=new go.Map;netBrain.Map.BasePathLink.isL2Style=!!isL2Style;_nodeTemplateMap.add(netBrain.Map.CompStencil.getVarCategory(),netBrain.Map.CompStencil.getMapTemplate(map,scope));_nodeTemplateMap.add(netBrain.Map.CategoryMgr.VirtualNode,netBrain.Map.CompVirtualNode.getMapTemplate(map,scope));_nodeTemplateMap.add(netBrain.Map.CategoryMgr.NetworkDevice,netBrain.Map.CompDevice.getMapTemplate(map,scope));_nodeTemplateMap.add(netBrain.Map.CategoryMgr.L2Device,netBrain.Map.CompL2Device.getMapTemplateNew(map,scope));_nodeTemplateMap.add(netBrain.Map.CompMedia.getVarCategory(),netBrain.Map.CompMedia.getMapTemplate(map,scope));_nodeTemplateMap.add(netBrain.Map.CompDeviceGroup.getVarCategory(),netBrain.Map.CompDeviceGroup.getMapTemplate(map,scope));_nodeTemplateMap.add(netBrain.Map.ComStencilExt.getVarCategory(),netBrain.Map.CompStencil.getMapTemplate(map,scope));_nodeTemplateMap.add(netBrain.Map.CategoryMgr.MuteLan,_mapMuteLanTemplate);_nodeTemplateMap.add(netBrain.Map.CategoryMgr.DeviceNote,netBrain.Map.CompDeviceNote.getMapTemplate(map,scope));_nodeTemplateMap.add(netBrain.Map.CategoryMgr.Note,netBrain.Map.CompDeviceNote.getMapTemplate(map,scope));_nodeTemplateMap.add(netBrain.Map.CategoryMgr.HyperLink,_mapHyperLinkTemplate);var shapTemplateOption=new netBrain.Map.ShapTemplateCommonOption;shapTemplateOption.templateOption.scope=scope;shapTemplateOption.templateOption.pathClick=scope.clickMultiLink;shapTemplateOption.templateOption.pathContextClick=scope.contextClickMultiLink;shapTemplateOption.templateOption.locationParse=function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)};shapTemplateOption.templateOption.ptStringif=function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)};shapTemplateOption.templateOption.tableDBClick=scope.tableDoubleClick;shapTemplateOption.templateOption.shapDBClick=scope.ShapeDoubleClk;shapTemplateOption.templateOption.overLapHandler=overLapHandler;shapTemplateOption.templateOption.shapeClick=function(event,target){scope.showShapToolbar(target)};_nodeTemplateMap.add(netBrain.Map.CompRectangle.getVarCategory(),netBrain.Map.CompRectangle.getMapTemplate(shapTemplateOption.templateOption,map,scope));_nodeTemplateMap.add(netBrain.Map.CompPolygon.getVarCategory(),netBrain.Map.CompPolygon.getMapTemplate(shapTemplateOption.templateOption,map,scope));_nodeTemplateMap.add(netBrain.Map.CompEllipse.getVarCategory(),netBrain.Map.CompEllipse.getMapTemplate(shapTemplateOption.templateOption,map,scope));_nodeTemplateMap.add(netBrain.Map.CompCloseArea.getVarCategory(),netBrain.Map.CompCloseArea.getMapTemplate(shapTemplateOption.templateOption,map,scope));_nodeTemplateMap.add(netBrain.Map.CompCurve.getVarCategory(),netBrain.Map.CompCurve.getMapTemplate(shapTemplateOption.templateOption,map,scope));_nodeTemplateMap.add(netBrain.Map.CompTable.getVarCategory(),netBrain.Map.CompTable.getMapTemplate(shapTemplateOption.templateOption,map,scope));_nodeTemplateMap.add(netBrain.Map.CompCloud.getVarCategory(),netBrain.Map.CompCloud.getMapTemplate(shapTemplateOption.templateOption,map,scope));_nodeTemplateMap.add(netBrain.Map.CompText.getVarCategory(),netBrain.Map.CompText.getMapTemplate(shapTemplateOption.templateOption,map,scope));_nodeTemplateMap.add(netBrain.Map.CompTextbox.getVarCategory(),netBrain.Map.CompTextbox.getMapTemplate(shapTemplateOption.templateOption,map,scope));var callOutOpt=new netBrain.Map.CompCallOutTempplateOpt;callOutOpt.locationParse=fnLocationParse;callOutOpt.locationStringify=fnPointStringify;_nodeTemplateMap.add(netBrain.Map.CompCallOut.getVarCategory(),netBrain.Map.CompCallOut.getMapTemplate(callOutOpt,map,scope));overviewsite?_nodeTemplateMap.add(netBrain.Map.CategoryMgr.Site,netBrain.Map.CompSite.getOverViewMapTemplate(map,scope)):_nodeTemplateMap.add(netBrain.Map.CategoryMgr.Site,netBrain.Map.CompSite.getMapTemplate(map,scope));_nodeTemplateMap.add(netBrain.Map.CompUnknownIp.getVarCategory(),netBrain.Map.CompUnknownIp.getMapTemplate(shapTemplateOption.templateOption,map,scope));var linkTemplateOption=new netBrain.Map.TopoLinkTemplateOption;netBrain.Map.CompTopolink.initSomeLinkTemplateOption(linkTemplateOption);linkTemplateOption.linkLabelMouseHover=scope.linkLabelMouseHover;linkTemplateOption.linkLabelMouseLeave=scope.linkLabelMouseLeave;linkTemplateOption.linkLabelClick=scope.linkLabelClick;linkTemplateOption.linkLabelMouseEnter=scope.linkLabelMouseEnter;linkTemplateOption.linkSelectChangeFunc=overLapHandler;linkTemplateOption.isEditMode=scope.isEditMode;linkTemplateOption.editLinkShow=scope.openEditLink;linkTemplateOption.getEditDataView=scope.getEditDataView;_groupTemplateMap.add(netBrain.Map.CategoryMgr.VirtualGroupNode,netBrain.Map.CompVirtualGroupNode.getMapTemplate(map,scope,!0));isL2Style||_linkTemplateMap.add(netBrain.Map.CategoryMgr.SimpleLink,netBrain.Map.CompTopolink.getMapSimpleTemplate(linkTemplateOption,map,!1,scope));_linkTemplateMap.add(netBrain.Map.CategoryMgr.VirtualTopoLink,netBrain.Map.CompVirtualLink.getMapTemplate(linkTemplateOption,map,!1,scope));_linkTemplateMap.add(netBrain.Map.CategoryMgr.TopoLink,netBrain.Map.CompTopolink.getMapTemplate(linkTemplateOption,map,!1,scope));_linkTemplateMap.add(netBrain.Map.CategoryMgr.L2TopoLink,netBrain.Map.CompL2TopoLink.getMapTemplate(linkTemplateOption,map,scope));_linkTemplateMap.add(netBrain.Map.CompLine.getVarCategory(),netBrain.Map.CompLine.getMapTemplate(shapTemplateOption.templateOption,map,scope));_linkTemplateMap.add(netBrain.Map.CompCallOutLink.getVarCategory(),netBrain.Map.CompCallOutLink.getMapTemplate());_linkTemplateMap.add(netBrain.Map.CategoryMgr.DeviceNoteLink,_mapNotesLinkTemplate);_linkTemplateMap.add(netBrain.Map.CompPathNewBase.getVarCategory(),netBrain.Map.CompPathNewBase.getMapTemplate(shapTemplateOption.templateOption,map,scope));_linkTemplateMap.add(netBrain.Map.CompPathNew.getVarCategory(),netBrain.Map.CompPathNew.getMapTemplate(shapTemplateOption.templateOption,map,scope));_linkTemplateMap.add(netBrain.Map.CategoryMgr.HighlightNeighborLink,netBrain.Map.CompHighlightNeighborLink.getMapTemplate(map));_linkTemplateMap.add(netBrain.Map.CategoryMgr.HopLink,netBrain.Map.CompHopLink.getMapTemplate(map));_linkTemplateMap.add(netBrain.Map.CategoryMgr.NormalLink,netBrain.Map.CompNormalLink.getMapTemplate(map));netBrain.Map.mapTemplateEventsProvider(scope,shapTemplateOption.templateOption,linkTemplateOption);return{nodeTemplateMap:function(){return _nodeTemplateMap},linkTemplateMap:function(){return _linkTemplateMap},anonymTreeLinkTemplate:function(){return _mapAnonymTreeLinkTemplate},mapTopoLinkTemplate:function(){return netBrain.Map.CompTopolink.getMapTemplate(linkTemplateOption,map,!1,scope)},groupTemplateMap:function(){return _groupTemplateMap}}}}(NetBrain);!function(netBrain){function CMediaTypeMgr(){}CMediaTypeMgr.prototype={constructor:CMediaTypeMgr,initMediaTypes:function(httpSrv){},isMediaType:function(mediaType){return!!this._mediaList.filter((function(m){return mediaType&&m.typeName.toLowerCase()===mediaType.toString().toLowerCase()}))[0]},isMuteLanType:function(mediaType){return"MuteLan"===mediaType},getIconNameByType:function(mediaType){var matchedMedia=this._mediaList.filter((function(m){return m.typeName.toLowerCase()===mediaType.toString().toLowerCase()}))[0];return matchedMedia?matchedMedia.icon+".png"||matchedMedia.typeName+".png":"lan.png"},setMediaList:function(mediaList){this._mediaList=mediaList},getMediaList:function(mediaList){return this._mediaList},getStrSizeByType:function(mediaType){return _.contains(["wan","dmvpn","l2 overlay"],mediaType.toLowerCase())?"360 249":"wlan"==mediaType.toLowerCase()?"100 100":"102 62"},getCategoryByType:function(mediaType){return"mutelan"===mediaType.toLowerCase()?netBrain.Map.CategoryMgr.MuteLan:netBrain.Map.CategoryMgr.NetworkDevice}};var gMediaTypeMgr=new CMediaTypeMgr;netBrain.Map=netBrain.Map||{};netBrain.Map.gMediaTypeMgr=gMediaTypeMgr}(NetBrain);!function(NetBrain){var CMapViewOption=function(){this.optionsList=angular.copy(NetBrain.Map.Const.MapViewOptionSetting)};CMapViewOption.prototype={constructor:CMapViewOption,toJson:function(){var temp=JSON.stringify(this.optionsList);this.optionsList=JSON.parse(temp);return this.optionsList},fromJson:function(mapViewOptionJson){if(null!=mapViewOptionJson){var temp=JSON.stringify(mapViewOptionJson);this.optionsList=JSON.parse(temp)}},initOptions:function(httpSrv){},getOptionNameArray:function(){var retArray=[];for(var index=0;index<this.optionsList.options.length;index++)retArray.push(this.optionsList.options[index].displayName);return retArray},getOptionScaleThresHoldByPosName:function(strPosName){for(var index=0;index<this.optionsList.options.length;index++)if(strPosName===this.optionsList.options[index].posName)return this.optionsList.options[index].scaleThreshold;return null},isOneOptionDisplayByPosName:function(strPosName){for(var index=0;index<this.optionsList.options.length;index++)if(strPosName===this.optionsList.options[index].posName)return this.optionsList.options[index].display;return null},getOptionScaleThresHoldByName:function(strDisplayName){for(var index=0;index<this.optionsList.options.length;index++)if(strDisplayName===this.optionsList.options[index].displayName)return this.optionsList.options[index].scaleThreshold;return null},setOptionScaleThresHoldByName:function(strDisplayName,dScaleThreshold){for(var index=0;index<this.optionsList.options.length;index++)strDisplayName===this.optionsList.options[index].displayName&&(this.optionsList.options[index].scaleThreshold=dScaleThreshold)},isOneOptionDisplay:function(strDisplayName){for(var index=0;index<this.optionsList.options.length;index++)if(strDisplayName===this.optionsList.options[index].displayName)return this.optionsList.options[index].display;return null},SetOneOptionDisplay:function(strDisplayName,bDisplay){for(var index=0;index<this.optionsList.options.length;index++)strDisplayName===this.optionsList.options[index].displayName&&(this.optionsList.options[index].display=bDisplay)},getZoomStep:function(){return this.optionsList.step},setZoomStep:function(dStep){this.optionsList.step=dStep},setOptionScaleThresHolds:function(dScaleThreshold){for(var index=0;index<this.optionsList.options.length;index++)this.optionsList.options[index].scaleThreshold=dScaleThreshold}};CMapViewOption.convertDoubleToDisplayString=function(dValue){var retStr="100%";null!==dValue&&(retStr=100*dValue+"%");return retStr};CMapViewOption.convertDisplayStringToDouble=function(strDisplayValue){if("number"==typeof strDisplayValue)return strDisplayValue;if(null==strDisplayValue)return 1;var strTempDisplayValue=null;var pos=strDisplayValue.indexOf("%");strTempDisplayValue=-1!==pos?strDisplayValue.slice(0,pos):strDisplayValue;var value=Number(strTempDisplayValue);return null==value?1:value/100};NetBrain.Map=NetBrain.Map||{};NetBrain.Map.CMapViewOption=CMapViewOption}(NetBrain);function CNetMapObjsSelectionMgr(diagram){this.diagram=diagram;this.diagramObjsSelection=[]}CNetMapObjsSelectionMgr.prototype={constructor:CNetMapObjsSelectionMgr,insertPageObj:function(graphicObject){this.diagramObjsSelection.push(graphicObject)},clearPageObjsSelection:function(){var diagram=this.diagram;var oldEnable=diagram.undoManager.isEnabled;diagram.undoManager.isEnabled=!1;diagram.startTransaction("Clear Page Selected Objs");var diagramObjsSelection=this.diagramObjsSelection;for(var i=0;i<diagramObjsSelection.length;i++){var devLabelFrame=diagramObjsSelection[i].panel.findObject("devPosLabelFrame");devLabelFrame&&(devLabelFrame.stroke=null);var linkLabelFrame=diagramObjsSelection[i].panel.findObject("linkLabelFrame");linkLabelFrame&&(linkLabelFrame.stroke=null)}diagramObjsSelection.length=0;diagram.commitTransaction("Clear Page Selected Objs");diagram.undoManager.isEnabled=oldEnable},removePageObj:function(graphicObject){this.diagram.startTransaction("Remove Page Selected Objs");var index=this.diagramObjsSelection.map((function(e){return e.__gohashid})).indexOf(graphicObject.__gohashid);-1!==index?this.diagramObjsSelection.splice(index,1):console.warn("Object can't be founded in selection!");this.diagram.commitTransaction("Remove Page Selected Objs")},getPageObjByGohashid:function(gohashid){var index=this.diagramObjsSelection.map((function(e){return e.__gohashid})).indexOf(gohashid);if(-1!==index)return this.diagramObjsSelection[index];console.warn("Object can't be founded in selection!")},getAllPageObjs:function(){return this.diagramObjsSelection},devPosLabelToggle:function(event,target){var diagram=this.diagram;var node=diagram.findNodeForData(target.part.data);var panel=node.findObject("devPosLabelPanel");if(panel){node.isSelected=!1;!1===event.event.ctrlKey&&this.clearPageObjsSelection();var oldEnable=diagram.undoManager.isEnabled;diagram.undoManager.isEnabled=!1;for(var i=panel.elements;i.next();){var ele=i.value;if(ele instanceof go.Panel&&ele.data.posName===target.panel.data.posName){diagram.startTransaction("toggle frame");var outFrame=ele.findObject("devPosLabelFrame");if(null==outFrame.stroke){this.insertPageObj(ele.findObject("devPosLabel"));outFrame.stroke="rgb(0, 124, 249)"}else{this.removePageObj(ele.findObject("devPosLabel"));outFrame.stroke=null}diagram.commitTransaction("toggle frame")}}diagram.undoManager.isEnabled=oldEnable}},selLinkLabel:function(event,graphObj){if(null!=graphObj&&null!=event){var diagram=this.diagram;var link=graphObj.part;if(link.findObject("linkLabelFrame")){link.isSelected=!1;!1===event.event.ctrlKey&&this.clearPageObjsSelection();var oldEnable=diagram.undoManager.isEnabled;diagram.undoManager.isEnabled=!1;diagram.startTransaction("toggle frame");var outFrame=graphObj.panel.findObject("linkLabelFrame");if(null==outFrame.stroke){this.insertPageObj(graphObj);outFrame.stroke="rgb(0, 124, 249)"}else{this.removePageObj(graphObj);outFrame.stroke=null}diagram.commitTransaction("toggle frame");diagram.undoManager.isEnabled=oldEnable}}}};!function(netBrain){function CompSiteNode(){go.Node.apply(this,arguments)}go.Diagram.inherit(CompSiteNode,go.Node);CompSiteNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var picObj=this.findObject("IMAGE");var picInfo=visioTools.getPictureInfo(picObj,!0);visioInfos.push(picInfo);if(this.findObject("plusIcon").visible){var plusObj=this.findObject(CompSite.plusRedIcon);var plusInfo=visioTools.getShapeInfo(plusObj);visioInfos.push(plusInfo)}var displayClassInfo=visioTools.getTextVisioInfo(this,CompSite.displayClass);visioInfos.push(displayClassInfo);var hostNameInfo=visioTools.getTextVisioInfo(this,CompSite.displayName);visioInfos.push(hostNameInfo);return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};function CompOverViewSiteNode(){go.Node.apply(this,arguments)}go.Diagram.inherit(CompOverViewSiteNode,go.Node);CompOverViewSiteNode.prototype.getVisioInfo=function(){var visioInfos=[];var visioTools=netBrain.Map.visioTools;var picObj=this.findObject("IMAGE");var picInfo=visioTools.getPictureInfo(picObj,!0);visioInfos.push(picInfo);var expendedIconObj=this.findObject(CompSite.expendedIcon);if(expendedIconObj.visible){var expendedIconInfo=visioTools.getPictureInfo(expendedIconObj);visioInfos.push(expendedIconInfo)}var displayClassInfo=visioTools.getTextVisioInfo(this,CompSite.displayClass);visioInfos.push(displayClassInfo);var hostNameInfo=visioTools.getTextVisioInfo(this,CompSite.displayName);visioInfos.push(hostNameInfo);return visioTools.buildNodeVisioInfo(visioInfos,this.data,this)};var CompSite=function(){netBrain.Map.CompBase.call(this);this.category=netBrain.Map.CategoryMgr.Site};CompSite.prototype=new netBrain.Map.CompBase;CompSite.displayName="hostName";CompSite.displayClass="displayClass";CompSite.plusRedIcon="plusRedIcon";CompSite.expendedIcon="expendedIcon";CompSite.EVENT_NAMES={MAIN_CLICK:"COMP_SITE_MAIN_CLICK",MAIN_MOUSE_ENTER:"COMP_SITE_MAIN_MOUSE_ENTER",MAIN_MOUSE_LEAVE:"COMP_SITE_MAIN_MOUSE_LEAVE",MAIN_DOUBLE_CLICK:"COMP_SITE_MAIN_DOUBLE_CLICK",PLUS_ICON_CLICK:"COMP_SITE_PLUS_ICON_CLICK",TEXT_CLICK:"COMP_SITE_TEXT_CLICK",OVERVIEW_MAIN_CLICK:"COMP_SITE_OVERVIEW_MAIN_CLICK",OVERVIEW_MAIN_MOUSE_ENTER:"COMP_SITE_OVERVIEW_MAIN_MOUSE_ENTER",OVERVIEW_MAIN_MOUSE_LEAVE:"COMP_SITE_OVERVIEW_MAIN_MOUSE_LEAVE",OVERVIEW_MAIN_DOUBLE_CLICK:"COMP_SITE_OVERVIEW_MAIN_DOUBLE_CLICK",OVERVIEW_EXPANDED_PIC_CLICK:"COMP_SITE_OVERVIEW_EXPANDED_PIC_CLICK",OVERVIEW_SITE_NAME_CLICK:"COMP_SITE_OVERVIEW_SITE_NAME_CLICK"};CompSite.getMapTemplate=function(map,scope){var $=go.GraphObject.make;return $(CompSiteNode,"Vertical",{selectionObjectName:"IMAGE",locationSpot:go.Spot.Center,copyable:!1,layerName:GlobalContext.DeviceLayerName,selectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate()},new go.Binding("layerName").makeTwoWay(),new go.Binding("location","location",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)})).makeTwoWay((function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)})),$(go.Panel,go.Panel.Spot,{name:"MAIN",portId:"",cursor:"pointer",minSize:new go.Size(20,20),click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.MAIN_CLICK,event,target)},mouseEnter:function(event,target){event.event&&scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.MAIN_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.MAIN_MOUSE_LEAVE,event,target)},doubleClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.MAIN_DOUBLE_CLICK,event,target)}},$(go.Picture,{name:"IMAGE",isPanelMain:!0},new go.Binding("source","siteGraphicInfo",(function(siteGraphicInfo,node){var compData=node.part.data;return compData.isRoot()?netBrain.NG.Const.iconImagePath+siteGraphicInfo.image.name+"_Src.png":compData.isContainer()?netBrain.NG.Const.iconImagePath+siteGraphicInfo.image.name+"_Dst.png":netBrain.NG.Const.iconImagePath+siteGraphicInfo.image.name+".png"})),new go.Binding("desiredSize","siteGraphicInfo",(function(siteGraphicInfo){var size=go.Size.parse(siteGraphicInfo.image.size);size.width*=siteGraphicInfo.image.scale;size.height*=siteGraphicInfo.image.scale;return size}))),$(go.TextBlock,{name:CompSite.displayClass,editable:!1,textAlign:"center",height:15,text:"Site",isMultiline:!1,stroke:"black",background:"transparent",font:BindHelper.defaultHostNameFont,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.TEXT_CLICK,event,target)}}),$(go.Panel,go.Panel.Auto,{name:"plusIcon",alignment:new go.Spot(1,0,-8,8),alignmentFocus:go.Spot.Center,visible:!1,click:function(s,e){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.PLUS_ICON_CLICK,s,e)}},new go.Binding("visible","devCategory",(function(devCategory){var bVisible=!1;if(null!=showPlusFlag&&!showPlusFlag)return!1;null!=devCategory&&(bVisible=!NetBrain.Map.gMediaTypeMgr.isMediaType(devCategory));return bVisible})),new go.Binding("visible","",(function(){return!scope.isEditMode()})),$(go.Shape,{fill:"transparent",desiredSize:new go.Size(16,16),stroke:null}),$(go.Shape,{fill:"#ffffff",figure:"Circle",desiredSize:new go.Size(16,16),stroke:null}),$(go.Shape,{name:CompSite.plusRedIcon,fill:"#CC3333",desiredSize:new go.Size(14,14),stroke:null,geometry:netBrain.Map.CCompLabel.getRedplusIcon()}))),$(go.TextBlock,"Horizontal",{margin:new go.Margin(0,0,3,0),name:CompSite.displayName,editable:!1,textAlign:"center",height:15,isMultiline:!1,stroke:"black",background:"white",font:BindHelper.defaultHostNameFont,click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.TEXT_CLICK,event,target)}},new go.Binding("text","displayName")))};CompSite.getOverViewMapTemplate=function(map,scope){var $=go.GraphObject.make;return $(CompOverViewSiteNode,"Vertical",{selectionObjectName:"MAIN",locationObjectName:"IMAGE",locationSpot:go.Spot.Center,layerName:GlobalContext.DeviceLayerName,resizable:!0,resizeObjectName:"MAIN",treeExpandedChanged:function(node){node.wasTreeExpanded=!1;if(node.inited&&node.isTreeExpanded&&node.data.removeChildren){var dia=node.diagram;dia&&setTimeout((function(){_.each(node.data.removeChildren,(function(subSite){subSite.defaultExpand=dia.isExpandAll||!1}));if(dia.isExpandAll){dia.addBacknodes=dia.addBacknodes.concat(node.data.removeChildren);dia.addLinks=dia.addLinks.concat(node.data.removeLinks)}else{dia.model.addNodeDataCollection(node.data.removeChildren);dia.model.addLinkDataCollection(node.data.removeLinks)}node.data.removeChildren=node.data.removeLinks=null}))}node.inited=!0},isTreeExpanded:!0,selectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate()},new go.Binding("isTreeExpanded","defaultExpand",(function(v,node){return v})).makeTwoWay(),new go.Binding("layerName").makeTwoWay(),new go.Binding("location","location",(function(data,node){return netBrain.Map.GoDiagramPositionUtil.zoomPositionParse(map,data)})).makeTwoWay((function(pt,data){return netBrain.Map.GoDiagramPositionUtil.zoomPositionStringify(map,pt,data)})),$(go.Panel,go.Panel.Auto,{name:"MAIN",portId:"",cursor:"pointer",minSize:new go.Size(20,20),click:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.OVERVIEW_MAIN_CLICK,event,target)},mouseEnter:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.OVERVIEW_MAIN_MOUSE_ENTER,event,target)},mouseLeave:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.OVERVIEW_MAIN_MOUSE_LEAVE,event,target)},doubleClick:function(event,target){scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.OVERVIEW_MAIN_DOUBLE_CLICK,event,target)}},new go.Binding("desiredSize","size",(function(size){return size?new go.Size(size.width,size.height):null})).makeTwoWay(),$(go.Panel,go.Panel.Spot,$(go.Picture,{name:"IMAGE",isPanelMain:!0},new go.Binding("source","siteGraphicInfo",(function(siteGraphicInfo,node){var compData=node.part.data;return compData.isRoot()?netBrain.NG.Const.iconImagePath+siteGraphicInfo.image.name+"_Src.png":compData.isContainer()?netBrain.NG.Const.iconImagePath+siteGraphicInfo.image.name+"_Dst.png":netBrain.NG.Const.iconImagePath+siteGraphicInfo.image.name+".png"})),new go.Binding("desiredSize","siteGraphicInfo",(function(siteGraphicInfo){var size=go.Size.parse(siteGraphicInfo.image.size);var scale=siteGraphicInfo.image.scale;size.width*=scale;size.height*=scale;return size})),new go.Binding("desiredSize","size",(function(size){return size?new go.Size(size.width,size.height):null}))),$(go.Picture,{name:CompSite.expendedIcon,width:16,height:16,alignmentFocus:go.Spot.TopRight,alignment:new go.Spot(.9,.05),cursor:"pointer",click:function(event,target){var node=target.part;var cmd=event.diagram.commandHandler;node.isTreeExpanded?cmd.collapseTree(node):cmd.expandTree(node);scope&&_.isFunction(scope.$emit)&&scope.$emit(CompSite.EVENT_NAMES.OVERVIEW_EXPANDED_PIC_CLICK,event,target)}},new go.Binding("source","isTreeExpanded",(function(exp,node){return exp?"img/Expanded.png":"img/Collapsed.png"})).ofObject(),new go.Binding("visible","siteCategory",(function(siteCategory,node){return!node.part.data.isLeaf()})))),$(go.TextBlock,{name:CompSite.displayClass,editable:!1,textAlign:"center",height:15,isMultiline:!1,stroke:"black",background:"transparent",font:BindHelper.defaultHostNameFont},new go.Binding("text","deviceCount",(function(v){return"Site("+v+")"})))),$(go.TextBlock,{name:CompSite.displayName,margin:new go.Margin(0,0,3,0),editable:!1,textAlign:"center",height:15,isMultiline:!1,stroke:"black",background:"white",font:BindHelper.defaultHostNameFont},new go.Binding("text","displayName")))};CompSite.getJson=function(siteCategory){var defaultSize="360 249";siteCategory&&(defaultSize=_getSiteSize(siteCategory));return{key:"0",category:netBrain.Map.CategoryMgr.Site,displayName:"site1",siteCategory:2,location:"100 100",deviceCount:"",state:0,siteGraphicInfo:{image:{name:"site",size:defaultSize,scale:NetBrain.Map.Const.iconOnMapScale},font:{faceName:BindHelper.defaultHostNameFont,fontSize:"9"}},parentId:"",parentPath:[]}};CompSite.getLevelRate=function(){return.9};CompSite.prototype.getJsData=function(){return this};CompSite.prototype.getHostname=function(){return this.displayName};CompSite.prototype.getDisplayName=function(){return this.displayName};CompSite.prototype.setDisplayName=function(obj){this.displayName=obj};CompSite.prototype.getKey=function(){return this.key};CompSite.prototype.setKey=function(obj){this.key=obj};CompSite.prototype.getParentKey=function(){return this.parent};CompSite.prototype.setParentKey=function(obj){this.parent=obj};CompSite.prototype.getScale=function(){return this.siteGraphicInfo.image.scale},CompSite.prototype.setScale=function(obj){this.siteGraphicInfo.image.scale=obj};CompSite.prototype.getDevType=function(){return this.devType};CompSite.prototype.setDevType=function(obj){this.devType=obj};CompSite.prototype.getDevCategory=function(){return this.category};CompSite.prototype.setDevCategory=function(obj){this.category=obj};CompSite.prototype.getLocation=function(){return this.location};CompSite.prototype.setLocation=function(obj){this.location=obj};CompSite.prototype.getSiteCategory=function(){return this.siteCategory};CompSite.prototype.setSiteCategory=function(obj){this.siteCategory=obj};CompSite.prototype.getDeviceCount=function(){return this.deviceCount};CompSite.prototype.setDeviceCount=function(obj){this.deviceCount=obj};CompSite.prototype.isExpanded=function(){return 0!=(16384&this.state)};CompSite.prototype.isCollapsed=function(){return 0!=(32768&this.state)};CompSite.prototype.setExpanded=function(expand){var oldState=this.state;if(this.isExpanded()||this.isCollapsed())if(expand){this.state=32768^this.state;this.state=16384|this.state}else{this.state=16384^this.state;this.state=32768|this.state}return oldState};CompSite.prototype.setParentId=function(parentId){this.parentId=parentId};CompSite.prototype.getParentId=function(){return this.parentId};CompSite.prototype.setParentPath=function(arr){this.parentPath=arr};CompSite.prototype.getParentPath=function(){return this.parentPath};CompSite.prototype.isRoot=function(){return 0===this.siteCategory};CompSite.prototype.isContainer=function(){return 1===this.siteCategory};CompSite.prototype.isLeaf=function(){return 2===this.siteCategory};CompSite.prototype.setImgSize=function(siteCategory){this.siteGraphicInfo.image.size=_getSiteSize(siteCategory)};function _getSiteSize(siteCategory){var csize;0===siteCategory?csize="436 302":1===siteCategory?csize="396 274":2===siteCategory&&(csize="360 249");return csize}netBrain.Map=netBrain.Map||{};netBrain.Map.CompSite=CompSite}(NetBrain);var GoJsEventCenter=function(){};GoJsEventCenter.prototype={constructor:GoJsEventCenter,redPlusClick:function(s,e){},deviceRightClicked:function(s,e){},siteRightClicked:function(s,e){},initialLayoutCompleted:function(diagram){},layOutCompleted:function(diagram){},viewPortBoundsChanged:function(diagram,s){},backgroundDoubleClicked:function(){},modelChanged:function(changeEvent){},diagramChanged:function(changeEvent){},bgRightClicked:function(s,e){},bgSingleClicked:function(s){},layoutCompleted:function(s){},mouseOver:function(event){}};!function(netBrain){var Map=netBrain.Map||{};var CompPrototypeFactory=function(){};CompPrototypeFactory.getPrototypeByCategory=function(category){if(category===Map.CategoryMgr.NetworkDevice)return new netBrain.Map.CompDevice;if(category===Map.CategoryMgr.L2Device)return new netBrain.Map.CompL2Device;if(category===Map.CategoryMgr.L2Port)return null;if(category===Map.CategoryMgr.CompCallOutLink)return new netBrain.Map.CompCallOutLink;if(category===Map.CategoryMgr.Media)return new netBrain.Map.CompMedia;if(category===Map.CategoryMgr.Terminal)return null;if(category===Map.CategoryMgr.UnknownIp)return new netBrain.Map.CompUnknownIp;if(category===Map.CategoryMgr.MuteLan)return new netBrain.Map.CompMedia;if(category===Map.CategoryMgr.Note)return new netBrain.Map.CompDeviceNote;if(category===Map.CategoryMgr.Site)return new netBrain.Map.CompSite;if(category===Map.CategoryMgr.CallOut)return new netBrain.Map.CompCallOut;if(category===Map.CategoryMgr.Cluter)return new netBrain.Map.CompDeviceGroup;if(category===Map.CategoryMgr.DeviceNote)return new netBrain.Map.CompDeviceNote;if(category===Map.CategoryMgr.Rect)return new netBrain.Map.CompRectangle;if(category===Map.CategoryMgr.Textbox)return new netBrain.Map.CompTextbox;if(category===Map.CategoryMgr.Ellipse)return new netBrain.Map.CompEllipse;if(category===Map.CategoryMgr.Circle)return new netBrain.Map.CompCircle;if(category===Map.CategoryMgr.Polygon)return new netBrain.Map.CompPolygon;if(category==Map.CategoryMgr.VirtualNode)return new netBrain.Map.CompVirtualNode;if(category===Map.CategoryMgr.Line)return new netBrain.Map.CompLine;if(category===Map.CategoryMgr.Arrow)return null;if(category===Map.CategoryMgr.CloseArea)return new netBrain.Map.CompCloseArea;if(category===Map.CategoryMgr.CloseCloud)return new netBrain.Map.CompCloud;if(category===Map.CategoryMgr.Curve)return new netBrain.Map.CompCurve;if(category===Map.CategoryMgr.Table)return new netBrain.Map.CompTable;if(category===Map.CategoryMgr.Text)return new netBrain.Map.CompText;if(category===Map.CategoryMgr.TopoLink)return new netBrain.Map.CompTopolink;if(category===Map.CategoryMgr.L2TopoLink)return new netBrain.Map.CompL2TopoLink;if(category===Map.CategoryMgr.Path);else{if(category===Map.CategoryMgr.PathNew)return new netBrain.Map.CompPathNew;if(category===Map.CategoryMgr.TracePath)return new netBrain.Map.CompPathNewBase;if(category===Map.CategoryMgr.HyperLink)return new netBrain.Map.DrawObject;if(category===Map.CategoryMgr.DeviceNoteLink)return null;if(category===Map.CategoryMgr.Stencil)return new netBrain.Map.CompStencil;if(category===Map.CategoryMgr.StencilExt)return new netBrain.Map.ComStencilExt;if(category===Map.CategoryMgr.HighlightNeighborLink)return new netBrain.Map.CompHighlightNeighborLink;if(category===Map.CategoryMgr.HopLink)return new netBrain.Map.CompHopLink;if(category===Map.CategoryMgr.NormalLink)return new netBrain.Map.CompNormalLink;if(category==Map.CategoryMgr.VirtualTopoLink)return new netBrain.Map.CompVirtualLink;if(category==Map.CategoryMgr.VirtualGroupNode)return new netBrain.Map.CompVirtualGroupNode}return null};CompPrototypeFactory.buildCompPrototype=function(compData){var realCategory=compData&&compData.devNodeData&&compData.devNodeData.category&&compData.devNodeData.category.length>0?compData.devNodeData.category:compData.category;var tempPrototype=CompPrototypeFactory.getPrototypeByCategory(realCategory);null==tempPrototype&&(tempPrototype=compData.devNodeData&&compData.devNodeData.isGroup?new netBrain.Map.CompGenericGroupNode:"from"in compData&&"to"in compData&&"isP2P"in compData?new netBrain.Map.CompGenericVirtualLink:new netBrain.Map.CompGenericVirtualNode);if(null==tempPrototype){console.log("prototype is null");return!1}Object.setPrototypeOf(compData,tempPrototype);compData.init();return!0};Map.CompPrototypeFactory=CompPrototypeFactory}(NetBrain);function DataViewHelper(){}DataViewHelper.getDevDataViewByKey=function(jsDataViews,nodeKey){for(var i=0;i<jsDataViews.length;i++){var devDataView=jsDataViews[i];if(devDataView.key===nodeKey)return devDataView}return null};DataViewHelper.getEdgeByEdgeId=function(jsDataView,fromDevId,fromEdgeId){if(null==jsDataView)return null;var viewList=jsDataView.viewList;if(null==viewList)return null;for(var i=0;i<viewList.length;i++){var oneDevDataView=viewList[i];var dataViewInfo=oneDevDataView.viewInfo;if(null!=dataViewInfo){var edgeList=oneDevDataView.edgeList;if(null!=edgeList)for(var j=0;j<edgeList.length;j++){var oneEdgeInfo=edgeList[j];if(null!=oneEdgeInfo){var srcEdge=JSON.parse(oneEdgeInfo.srcEdge.edgeValue);if(null!=srcEdge&&srcEdge._id===fromDevId&&(null==srcEdge.intfs||srcEdge.intfs[0]._id===fromEdgeId))return{EdgeInfo:srcEdge,dataViewInfo:dataViewInfo}}}}}return null};DataViewHelper.formatNote=function(noteItem){var note={};note.time=noteItem.timeStamp;note.noteType=noteItem.type;note.noteFromType=NetBrain.Map.Const.NoteFromType.DataView;note.content="";if(note.noteType===NetBrain.Map.Const.NoteType.Append)_.each(noteItem.noteContent,(function(contentItem){note.content+=contentItem.content+"\n"}));else if(note.noteType===NetBrain.Map.Const.NoteType.Overwrite)note.content=noteItem.noteContent[noteItem.noteContent.length-1].content;else if(note.noteType===NetBrain.Map.Const.NoteType.RecordHistory){var contentArray=[];_.each(noteItem.noteContent,(function(contentItem){contentArray.unshift(StringUtil.format("[{time}] {content}",{time:TimeUtil.formatDateTime(new Date(contentItem.timeStamp)),content:contentItem.content}))}));note.content=contentArray.join("\n")}note.expand=noteItem.isExpand||!1;note.forecolor=noteItem.fontColor;note.backgroundColor=noteItem.backgroundColor;note.fontSize=(noteItem.fontSize||"9")+"px";note.align=noteItem.fontAlign;note.title=noteItem.title;note.time=new Date(noteItem.timeStamp);note.isCompound=!!noteItem.isCompound;noteItem.refVariables&&(note.refVariables=noteItem.refVariables);return note};DataViewHelper.buildDataViewNoteData=function(noteInfo){var title=noteInfo.title;var content=noteInfo.content;var defaultData=NetBrain.Map.CompDeviceNote.getDefaultJsonData(!0);var fontObj=new FontParser;fontObj.fromString(defaultData.font);var modifyTime=TimeUtil.toISOString(new Date);var note={noteContent:[{content:content,fontColor:defaultData.stroke,timeStamp:modifyTime}],title:title,fontSize:parseInt(fontObj.fontSize),fontAlign:defaultData.textAlign,fontColor:defaultData.stroke,backgroundColor:defaultData.bgColor,timeStamp:modifyTime,type:NetBrain.Map.Const.NoteFromType.DataView,isCompound:!!noteInfo.isCompound};noteInfo.refVariables&&(note.refVariables=noteInfo.refVariables);return note};var Rgn=function(topLeft,topRight,bottomRight,bottomLeft){this.points=new go.List;this.points.add(topLeft);this.points.add(topRight);this.points.add(bottomRight);this.points.add(bottomLeft);this.rect=this.calcRect(this.points)};Rgn.prototype.topLeft=function(){return this.points.elt(0)};Rgn.prototype.topRight=function(){return this.points.elt(1)};Rgn.prototype.bottomRight=function(){return this.points.elt(2)};Rgn.prototype.bottomLeft=function(){return this.points.elt(3)};Rgn.prototype.getCrossPoint=function(ptStart1,ptEnd1,ptStart2,ptEnd2){var bIntersect=!1;var ua=(ptEnd2.x-ptStart2.x)*(ptStart1.y-ptStart2.y)-(ptEnd2.y-ptStart2.y)*(ptStart1.x-ptStart2.x);(ua/=(ptEnd2.y-ptStart2.y)*(ptEnd1.x-ptStart1.x)-(ptEnd2.x-ptStart2.x)*(ptEnd1.y-ptStart1.y))>=0&&ua<=1&&(bIntersect=!0);if(bIntersect){var ub=(ptEnd1.x-ptStart1.x)*(ptStart1.y-ptStart2.y)-(ptEnd1.y-ptStart1.y)*(ptStart1.x-ptStart2.x);bIntersect=(ub/=(ptEnd2.y-ptStart2.y)*(ptEnd1.x-ptStart1.x)-(ptEnd2.x-ptStart2.x)*(ptEnd1.y-ptStart1.y))>=0&&ub<=1;var fX=ptStart1.x+ua*(ptEnd1.x-ptStart1.x);var fY=ptStart1.y+ua*(ptEnd1.y-ptStart1.y);Math.abs(fX)<1e-6&&Math.abs(fY)<1e-6&&0==ub&&0==ua&&(bIntersect=!1)}return bIntersect?new go.Point(fX,fY):null};Rgn.prototype.offset=function(offsetX,offsetY){this.points.each((function(point){point.offset(offsetX,offsetY)}));this.rect.offset(offsetX,offsetY)};Rgn.prototype.getIntersectionRect=function(rgn){if(!this.rect.intersectsRect(rgn.rect))return null;var points=new go.List;for(var i=0;i<this.points.length;i++)for(var j=0;j<rgn.points.length;j++){var point=this.getCrossPoint(this.points.elt(i),this.points.elt((i+1)%this.points.length),rgn.points.elt(j),rgn.points.elt((j+1)%rgn.points.length));null!=point&&points.add(point)}return this.calcRect(points)};Rgn.prototype.calcRect=function(points){if(null==points||0===points.count)return new go.Rect;var point=points.elt(0);var maxX=point.x;var minX=point.x;var maxY=point.y;var minY=point.y;points.each((function(point){minX=Math.min(minX,point.x);maxX=Math.max(maxX,point.x);minY=Math.min(minY,point.y);maxY=Math.max(maxY,point.y)}));return new go.Rect(minX,minY,maxX-minX,maxY-minY)};!function(netBrain){var setImmediate=function(){var browserGlobal=("undefined"!=typeof window?window:void 0)||{};var isNode="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process);var BrowserMutationObserver=browserGlobal.MutationObserver||browserGlobal.WebKitMutationObserver;var hasPromise=function(){var promiseToString=void 0;if(browserGlobal.Promise)try{promiseToString=Object.prototype.toString.call(browserGlobal.Promise.resolve())}catch(e){}return"[object Promise]"===promiseToString}();var fnQueue=[];function run(){if(fnQueue.length>0){var oldFnQueue=fnQueue;fnQueue=[];for(var i=0;i<oldFnQueue.length;++i){var fn=oldFnQueue[i];fn&&fn.fn&&fn.fn.apply(fn.args||[])}}}var doSetImmediate=null;doSetImmediate=isNode?(fn=run,function(){return process.nextTick(fn)}):hasPromise?function(fn){return function(){return Promise.resolve().then(fn)}}(run):BrowserMutationObserver?function(fn){var iterations=0;var observer=new BrowserMutationObserver(fn);var node=document.createTextNode("");observer.observe(node,{characterData:!0});return function(){node.data=iterations=++iterations%2}}(run):function(fn){var globalSetTimeout=setTimeout;return function(){return globalSetTimeout(fn,1)}}(run);var fn;return function(fn){fnQueue.push({fn:fn,args:Array.prototype.slice.call(arguments,1)});1==fnQueue.length&&doSetImmediate()}}();var Label=function(obj,linkLabel){this.obj=obj;this.linkLabel=linkLabel;this.nowPoint=null;this.rgn=null;this.cosa=null;this.sina=null;this.fromPoint=null;this.toPoint=null;this.localFromPoint=null;this.localToPoint=null;this.group=null;this.groupIdx=null;this.modify=!1;this.segmentIndex=0};var CompLableData=function(jsData){this._data=jsData};CompLableData.TypeInfo=[{Type:1,Weight:1e3,Name:"Device Name"},{Type:5,Weight:700,Name:"Interface IP"},{Type:6,Weight:800,Name:"Interface Name"},{Type:18,Weight:1e3,Name:"LAN/WAN Name"},{Type:21,Weight:200,Name:"Description"},{Type:22,Weight:600,Name:"Routing protocol"},{Type:23,Weight:500,Name:"Inbound ACL"},{Type:24,Weight:500,Name:"Outbound ACL"},{Type:25,Weight:400,Name:"MPLS VRF"},{Type:26,Weight:300,Name:"Multicasting Mode"},{Type:27,Weight:750,Name:"Interface BGP neighbor IP"},{Type:32,Weight:1e3,Name:"MANAGED IP"},{Type:33,Weight:1e3,Name:"DEVICE TYPE"},{Type:34,Weight:1e3,Name:"VENDOR MODEL"},{Type:35,Weight:1e3,Name:"IOS VERSION"},{Type:36,Weight:1e3,Name:"SERIAL NUM"}];var keyValue={IosVersion:"IOS VERSION",MgmtIP:"MANAGED IP",SN:"SERIAL NUM",VendorModel:"VENDOR MODEL",Description:"Description",IP:"Interface IP",IfName:"Interface Name",InAcl:"Inbound ACL",OutAcl:"Outbound ACL",Pim:"Interface BGP neighbor IP",Protocol:"Routing protocol",Vrf:"MPLS VRF",DevName:"Device Name",MediaName:"LAN/WAN Name"};CompLableData.GetType=function(key){var arr=CompLableData.TypeInfo;var one=Utils.findOne(arr,{Name:keyValue[key]});return one?one.Type:null};CompLableData.getTypeInfo=function(type){if(null==type)return null;var array=CompLableData.TypeInfo;for(var i=0,len=array.length;i<len;i++){var typeInfo=array[i];if(typeInfo.Type===type)return typeInfo}return null};CompLableData.prototype={constructor:CompLableData,getJsonData:function(){return this._data},getTypeInfo:function(){return null==this._data?null:CompLableData.getTypeInfo(this._data.comType)}};var LinkLableLayoutTool=function(diagram){this.EQS=1e-6};var delayLayout={};LinkLableLayoutTool.prototype.LayOut=function(diagram,isAll){if(null!=diagram)if(isAll)this.doLayout(diagram,isAll);else{var key=diagram.__gohashid.toString();delayLayout.hasOwnProperty(key)||(delayLayout[key]=0);delayLayout[key]++;var self=this;1==delayLayout[key]&&setImmediate((function(){delete delayLayout[key];self.doLayout(diagram,isAll)}),0)}};LinkLableLayoutTool.prototype.doLayout=function(diagram,isAll){var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;diagram.startTransaction("LinkLableLayout");var oldModified=diagram.isModified;diagram.computeBounds();var labels=this.getAllLabels(diagram,isAll);if(null!=labels){this.layoutCore(labels);this.moveLabel(labels);var nodes=this.getNodesInViewportBounds(diagram,isAll);this.checkLableIntersectsNodes(labels,nodes);diagram.links.each((function(l){null!=l.data&&l.data instanceof netBrain.Map.CompNormalLink&&l.invalidateRoute()}));diagram.isModified=oldModified;diagram.commitTransaction("LinkLableLayout");diagram.skipsUndoManager=oldskip}};LinkLableLayoutTool.prototype.getNodesInViewportBounds=function(diagram,isAll){var nodes=diagram.nodes;var result=new go.List;var viewportBounds=diagram.viewportBounds;nodes.each((function(node){if(node.visible&&function(node){return!0===isAll||node.actualBounds.intersectsRect(viewportBounds)}(node)&&node.elements){var deviceNode=node.findObject("DEVICE");if(deviceNode){var topLeft=deviceNode.getDocumentPoint(go.Spot.TopLeft);var topRight=deviceNode.getDocumentPoint(go.Spot.TopRight);var bottomRight=deviceNode.getDocumentPoint(go.Spot.BottomRight);var bottomLeft=deviceNode.getDocumentPoint(go.Spot.BottomLeft);result.add({obj:deviceNode,rgn:new Rgn(topLeft,topRight,bottomRight,bottomLeft)})}node.elements.each((function(obj){if(obj.visible&&obj.opacity>.1&&obj instanceof go.Panel){var hostName=obj.findObject(netBrain.Map.CompDevice.hostNameLable);var devPosLabelPanel=obj.findObject(netBrain.Map.CompDevice.devPosInfoLabelPanel);if(hostName||devPosLabelPanel)return;var topLeft=obj.getDocumentPoint(go.Spot.TopLeft);var topRight=obj.getDocumentPoint(go.Spot.TopRight);var bottomRight=obj.getDocumentPoint(go.Spot.BottomRight);var bottomLeft=obj.getDocumentPoint(go.Spot.BottomLeft);result.add({obj:obj,rgn:new Rgn(topLeft,topRight,bottomRight,bottomLeft)})}}))}}));return result};LinkLableLayoutTool.prototype.getAllLabels=function(diagram,isAll){var viewportBounds=diagram.viewportBounds;var isInBounds=function(elt){return!0===isAll||viewportBounds.intersectsRect(elt.actualBounds)};var panels1=new go.List;diagram.links.each((function(elt){if(elt instanceof netBrain.Map.TopoCustomizeLink||elt instanceof netBrain.Map.CompL2TopoLink){if(!elt.actualBounds.isReal())return;if(!isInBounds(elt))return;panels1.add(elt)}}));diagram.nodes.each((function(elt){if(elt.actualBounds.isReal()&&isInBounds(elt)){var hostName=elt.findObject(netBrain.Map.CompDevice.hostNameLable);null!=hostName&&panels1.add(hostName);var devPosLabelPanel=elt.findObject(netBrain.Map.CompDevice.devPosInfoLabelPanel);if(null!=devPosLabelPanel)for(var i=0;i<devPosLabelPanel.elements.count;i++){var devPosLabel=devPosLabelPanel.elt(i).findObject(netBrain.Map.CompDevice.devPosInfoLabel);null!=devPosLabel&&panels1.add(devPosLabel)}}}));var panels=panels1;var labels=new go.List;var deviceLabels=new go.List;labels.linkLabelGroups=new go.List;panels.each((function(obj){if(obj instanceof go.Link){if(obj.pointsCount<2)return;obj.elements.each((function(elt){if(elt instanceof go.Panel){var offset=new go.Point;var linkLabelGroup=new go.List;var index=elt.segmentIndex;if(!isFinite(index)||isNaN(index))return;var i;var fromPoint,toPoint,direction,tmpPt,itElt;if(index>=0){fromPoint=obj.getPoint(index);toPoint=obj.getPoint(index+1);direction=fromPoint.directionPoint(toPoint);for(i=index+2;i<obj.pointsCount;++i){tmpPt=obj.getPoint(i);if(direction!==fromPoint.directionPoint(tmpPt))break;toPoint=tmpPt}var backwardList=new go.List;elt.elements.each((function(elt){backwardList.add(elt)}));itElt=backwardList.iteratorBackwards}else{fromPoint=obj.getPoint(obj.pointsCount+index-1);direction=(toPoint=obj.getPoint(obj.pointsCount+index)).directionPoint(fromPoint);for(i=obj.pointsCount+index-2;i>=0;--i){tmpPt=obj.getPoint(i);if(direction!==toPoint.directionPoint(tmpPt))break;fromPoint=tmpPt}itElt=elt.elements.iterator}for(;itElt.next();){var panel=itElt.value;if(panel instanceof go.Panel){var it=panel.elements.iterator;for(;it.next();){var label=it.value;if(null!=label&&label instanceof go.Panel&&label.panel.visible){var topLeft=label.getDocumentPoint(go.Spot.TopLeft);var topRight=label.getDocumentPoint(go.Spot.TopRight);var bottomRight=label.getDocumentPoint(go.Spot.BottomRight);var bottomLeft=label.getDocumentPoint(go.Spot.BottomLeft);if(topLeft.isReal()&&topRight.isReal()&&bottomRight.isReal()&&bottomLeft.isReal()){var to=label.getDocumentPoint(go.Spot.Center);var from=panel.getDocumentPoint(go.Spot.Center);offset.offset(2*(from.x-to.x),2*(from.y-to.y));label.opacity=1;label.pickable=!0;var lab=new Label(label,!0);lab.nowPoint=new go.Point(topLeft.x,topLeft.y);lab.rgn=new Rgn(topLeft.offset(offset.x,offset.y),topRight.offset(offset.x,offset.y),bottomRight.offset(offset.x,offset.y),bottomLeft.offset(offset.x,offset.y));lab.cosa=Math.cos(Math.PI*elt.angle/180);lab.sina=Math.sin(Math.PI*elt.angle/180);lab.fromPoint=fromPoint;lab.toPoint=toPoint;lab.localFromPoint=lab.obj.getLocalPoint(fromPoint);lab.localToPoint=lab.obj.getLocalPoint(toPoint);lab.group=linkLabelGroup;lab.groupIdx=linkLabelGroup.count;lab.offset=new go.Point;lab.text=lab.obj.elt(0).elt(1).text;lab.segmentIndex=elt.segmentIndex;labels.add(lab);linkLabelGroup.add(lab)}}}}}linkLabelGroup.count>0&&labels.linkLabelGroups.add(linkLabelGroup)}}))}else{var rgnObj=obj;obj.name!==netBrain.Map.CompDevice.hostNameLable&&(rgnObj=obj.panel);if(rgnObj.visible){var topLeft=rgnObj.getDocumentPoint(go.Spot.TopLeft);var topRight=rgnObj.getDocumentPoint(go.Spot.TopRight);var bottomRight=rgnObj.getDocumentPoint(go.Spot.BottomRight);var bottomLeft=rgnObj.getDocumentPoint(go.Spot.BottomLeft);if(topLeft.isReal()&&topRight.isReal()&&bottomRight.isReal()&&bottomLeft.isReal()){var lab=new Label(obj,!1);lab.rgn=new Rgn(topLeft,topRight,bottomRight,bottomLeft);lab.obj instanceof go.TextBlock&&(lab.text=lab.obj.text);deviceLabels.add(lab)}}}}));deviceLabels.each((function(deviceLabel){labels.add(deviceLabel)}));labels.sort((function(x,y){if(!x.linkLabel)return 1;if(!y.linkLabel)return-1;if(x.text.length<=0&&y.text.length>0)return-1;if(y.text.length<=0&&x.text.length>0)return 1;var weightX=x.obj.panel.panel.alignmentFocus.offsetX;x.obj.panel.panel.segmentIndex<0&&(weightX*=-1);var weightY=y.obj.panel.panel.alignmentFocus.offsetX;y.obj.panel.panel.segmentIndex<0&&(weightY*=-1);return weightX<weightY?-1:1}));return labels};LinkLableLayoutTool.prototype.resetLabelSegment=function(index,elt,resetFocus){var sign,start,focus;if(elt.name!==netBrain.Map.CompTopolink.srcInftNameLabel&&elt.name!==netBrain.Map.CompTopolink.destInftNameLabel)if(resetFocus){sign=elt.segmentIndex>=0?-1:1;var data=elt.segmentIndex>=0?elt.part.data.intfSrc:elt.part.data.intfDest;var width=elt.segmentIndex>=0?elt.part._tmpSrcIntfWidth:elt.part._tmpDestIntfWidth;var defaultDataView=data.dataViewInfo.dataViewType===DataViewType.dvDefault;start=netBrain.Map.CompTopolink.getLinkLabelPosition(parseInt(elt.name.slice(-1)),defaultDataView);(focus=elt.alignmentFocus.copy()).offsetX=(start+width)*sign;elt.alignmentFocus=focus}else{sign=elt.segmentIndex>=0?-1:1;start=netBrain.Map.CompTopolink.getLinkLabelPosition(parseInt(elt.name.slice(-1)),!0);(focus=elt.alignmentFocus.copy()).offsetX=start*sign;elt.alignmentFocus=focus}elt.segmentIndex=index;console.time("ensureBounds");elt.part.ensureBounds();console.timeEnd("ensureBounds");console.time("computeBounds");elt.part.diagram.computeBounds();console.timeEnd("computeBounds")};LinkLableLayoutTool.prototype.rebuildLabelObj=function(lab){var label=lab.obj;var link=label.part;var elt=label.panel.panel;var fromPoint,toPoint,direction,tmpPt;var index=elt.segmentIndex;if(index>=0){fromPoint=link.getPoint(index);toPoint=link.getPoint(index+1);direction=fromPoint.directionPoint(toPoint);for(var i=index+2;i<link.pointsCount;++i){tmpPt=link.getPoint(i);if(direction!==fromPoint.directionPoint(tmpPt))break;toPoint=tmpPt}}else{fromPoint=link.getPoint(link.pointsCount+index-1);direction=(toPoint=link.getPoint(link.pointsCount+index)).directionPoint(fromPoint);for(var i1=link.pointsCount+index-2;i1>=0;--i1){tmpPt=link.getPoint(i1);if(direction!==toPoint.directionPoint(tmpPt))break;fromPoint=tmpPt}}var topLeft=label.getDocumentPoint(go.Spot.TopLeft);var topRight=label.getDocumentPoint(go.Spot.TopRight);var bottomRight=label.getDocumentPoint(go.Spot.BottomRight);var bottomLeft=label.getDocumentPoint(go.Spot.BottomLeft);if(topLeft.isReal()&&topRight.isReal()&&bottomRight.isReal()&&bottomLeft.isReal()){var offset=new go.Point;var to=label.getDocumentPoint(go.Spot.Center);var from=label.panel.getDocumentPoint(go.Spot.Center);offset.offset(2*(from.x-to.x),2*(from.y-to.y));label.opacity=1;label.pickable=!0;var newLab=lab;newLab.nowPoint=new go.Point(topLeft.x,topLeft.y);newLab.rgn=new Rgn(topLeft.offset(offset.x,offset.y),topRight.offset(offset.x,offset.y),bottomRight.offset(offset.x,offset.y),bottomLeft.offset(offset.x,offset.y));newLab.cosa=Math.cos(Math.PI*elt.angle/180);newLab.sina=Math.sin(Math.PI*elt.angle/180);newLab.fromPoint=fromPoint;newLab.toPoint=toPoint;newLab.localFromPoint=newLab.obj.getLocalPoint(fromPoint);newLab.localToPoint=newLab.obj.getLocalPoint(toPoint);newLab.offset=new go.Point;newLab.segmentIndex=elt.segmentIndex}};LinkLableLayoutTool.prototype.checkLableOut=function(idx,groupIdx,label,intersect){for(var i=idx;i>=groupIdx;--i){var lab=label.group.elt(i);var topLeft=lab.obj.getLocalPoint(lab.rgn.topLeft());var topRight=lab.obj.getLocalPoint(lab.rgn.topRight());var fromEdgePoint=lab.localFromPoint.copy();var toEdgePoint=lab.localToPoint.copy();if(Math.min(topLeft.x,topRight.x)<Math.min(fromEdgePoint.x,toEdgePoint.x)||Math.max(topLeft.x,topRight.x)>Math.max(fromEdgePoint.x,toEdgePoint.x)){lab.obj.opacity=0;lab.obj.pickable=!1}if(label.obj.panel.panel.name!==netBrain.Map.CompTopolink.srcInftNameLabel&&label.obj.panel.panel.name!==netBrain.Map.CompTopolink.destInftNameLabel){var blank;if(lab.obj.opacity>.1&&0===label.obj.panel.panel.segmentIndex&&null!=label.obj.part._tmpDestIntfWidth){blank=20+label.obj.part._tmpDestIntfWidth;if(Math.min(topLeft.x,topRight.x)<Math.min(fromEdgePoint.x,toEdgePoint.x+blank)||Math.max(topLeft.x,topRight.x)>Math.max(fromEdgePoint.x,toEdgePoint.x+blank)){lab.obj.opacity=0;lab.obj.pickable=!1}}if(lab.obj.opacity>.1&&-1===label.obj.panel.panel.segmentIndex&&null!=label.obj.part._tmpSrcIntfWidth){blank=20+label.obj.part._tmpSrcIntfWidth;if(Math.min(topLeft.x,topRight.x)<Math.min(fromEdgePoint.x-blank,toEdgePoint.x)||Math.max(topLeft.x,topRight.x)>Math.max(fromEdgePoint.x-blank,toEdgePoint.x)){lab.obj.opacity=0;lab.obj.pickable=!1}}}}};LinkLableLayoutTool.prototype.layoutCore=function(labels){var outerIdx=labels.count;for(;--outerIdx>=0;){var label=labels.elt(outerIdx);if(label.linkLabel&&!(label.obj.opacity<.1)&&null!=label.text){this.checkLableOut(label.groupIdx,label.groupIdx,label,!1);var testCount=10;var innerIdx=labels.count;for(;--innerIdx>outerIdx&&testCount>0;){var otherLabel=labels.elt(innerIdx);if(!(otherLabel.obj.opacity<.1||null==otherLabel.text)){var intersect=!1;for(;;){var rect=label.rgn.getIntersectionRect(otherLabel.rgn);if(null==rect)break;var length=Math.max(rect.width,rect.height);if(!(length>0))break;if(label.obj.part===otherLabel.obj.part&&(label.obj.panel.panel.segmentIndex>=0&&otherLabel.obj.panel.panel.segmentIndex<0||label.obj.panel.panel.segmentIndex<0&&otherLabel.obj.panel.panel.segmentIndex>=0)){intersect=!0;testCount=0;break}length<10&&(length=10);var offsetX=length*label.cosa;var offsetY=length*label.sina;if(label.obj.panel.panel.segmentIndex>=0){offsetX=-offsetX;offsetY=-offsetY}label.rgn.offset(offsetX,offsetY);label.offset.offset(offsetX,offsetY);for(var i=label.groupIdx+1;i<label.group.count;++i){var elt=label.group.elt(i);var eltPre=label.group.elt(i-1);var x=elt.offset.x-eltPre.offset.x;if(x*offsetX>0)break;offsetX=-x;offsetY=0;elt.rgn.offset(offsetX,offsetY);elt.offset.offset(offsetX,offsetY)}otherLabel.linkLabel||(otherLabel.modify=!0);intersect=!0}if(intersect){--testCount;innerIdx=labels.count;var idx=label.group.count-1;this.checkLableOut(idx,label.groupIdx,label,!0)}if(label.obj.opacity<.1)break}}if(testCount<=0){label.obj.opacity=0;label.obj.pickable=!1}}}};LinkLableLayoutTool.prototype.moveLabel=function(labels){var pos,posTmp;var it=labels.linkLabelGroups.iterator;for(;it.next();){var itGroup=it.value.iterator;for(;itGroup.next();){var label=itGroup.value;var labelBorder=label.obj.panel.findObject("linkLabelFrame");if(null!=labelBorder){pos=label.obj.position.copy();(posTmp=labelBorder.position.copy()).x=pos.x-2.5;posTmp.y=pos.y-2.5;labelBorder.position=posTmp;var sizeTmp=labelBorder.desiredSize.copy();sizeTmp.width=label.obj.actualBounds.width+4;sizeTmp.height=label.obj.actualBounds.height+4;labelBorder.desiredSize=sizeTmp;labelBorder.opacity=label.obj.opacity}var target=label.rgn.topLeft();if(Math.abs(label.nowPoint.x-target.x)>this.EQS||Math.abs(label.nowPoint.y-target.y)>this.EQS){var newPoint=label.obj.getLocalPoint(label.rgn.topLeft());var oldPoint=label.obj.getLocalPoint(label.nowPoint);var offsetone=newPoint.x-oldPoint.x;(pos=label.obj.position.copy()).x>=0&&pos.x+offsetone<-this.EQS?pos.x-=label.obj.actualBounds.width:pos.x<0&&pos.x+offsetone+label.obj.actualBounds.width>-this.EQS&&(pos.x+=label.obj.actualBounds.width);pos.x+=offsetone;Math.abs(pos.x)<this.EQS&&(pos.x=0);label.obj.position=pos;if(null!=labelBorder){(posTmp=labelBorder.position.copy()).x=pos.x-2.5;posTmp.y=pos.y-2.5;labelBorder.position=posTmp;labelBorder.desiredSize=new go.Size(label.obj.actualBounds.width+4,label.obj.actualBounds.height+4)}label.modify=!0}if(label.toPoint.x>label.fromPoint.x){if(0===label.obj.elt(0).angle){label.obj.elt(0).angle=180;label.modify=!0}}else if(180===label.obj.elt(0).angle){label.obj.elt(0).angle=0;label.modify=!0}if(label.obj.part instanceof netBrain.Map.CompL2TopoLink&&label.segmentIndex>=0){var angle=label.fromPoint.directionPoint(label.toPoint);label.obj.elt(0).angle=270===angle||0===angle||90===angle?180:0}}}};LinkLableLayoutTool.prototype.checkLableIntersectsNodes=function(labels,nodes){labels.each((function(label){label.linkLabel&&label.text&&label.obj.opacity>.1&&nodes.each((function(node){var rect=label.rgn.getIntersectionRect(node.rgn);if(rect){var length=Math.max(rect.width,rect.height);if(node.obj.visible&&node.obj.opacity>.1&&length>0){label.obj.opacity=0;label.obj.pickable=!1}}}))}))};netBrain.Map=netBrain.Map||{};netBrain.Map.LinkLableLayoutTool=LinkLableLayoutTool}(NetBrain);!function(netBrain){var CompL2TopoLink=netBrain.Map.CompL2TopoLink;function zoomLinkHandler(commandHandler,callback){var diagram=commandHandler.diagram;if(diagram){var oldL2TopoLinks=filterL2TopoLink(diagram.links);var oldLinksPoints=[];_.each(oldL2TopoLinks,(function(link){var data=link.data.pointsL2;oldLinksPoints.push(JSON.parse(JSON.stringify(data)))}));window.zoomLinkFlag=!0;callback.apply(commandHandler);window.zoomLinkFlag=!1;if(0!==oldLinksPoints.length){var l2TopoLinks=filterL2TopoLink(diagram.links);l2TopoLinks.length===oldL2TopoLinks.length&&function(diagram,l2TopoLinks,oldLinksPoints){var model=diagram.model;_.each(l2TopoLinks,(function(link,i){var oldPoints=oldLinksPoints[i];var points=getSimilarPoints(link.data.pointsL2,oldPoints);model.setDataProperty(link.data,"pointsL2",points)}))}(diagram,l2TopoLinks,oldLinksPoints)}}}zoomLinkHandler.zoomType=1;function getSimilarPoints(newPoints,oldPoints){var points=[];newPoints=pointsToObj(newPoints);var oldFromX=(oldPoints=pointsToObj(oldPoints))[0].x;var oldFromY=oldPoints[0].y;var diffOldFromToX=oldPoints[oldPoints.length-1].x-oldFromX||1e-9;var diffOldFromToY=oldPoints[oldPoints.length-1].y-oldFromY||1e-9;var newFromX=newPoints[0].x;var newFromY=newPoints[0].y;var newToX=newPoints[newPoints.length-1].x;var newToY=newPoints[newPoints.length-1].y;var diffNewFromToX=newToX-newFromX||1e-9;var diffNewFromToY=newToY-newFromY||1e-9;points.push(createPoint(newFromX,newFromY));for(var i=1,len=oldPoints.length-1;i<len;i++){var oPt=oldPoints[i];var ratioX=(oPt.x-oldFromX)/diffOldFromToX;var ratioY=(oPt.y-oldFromY)/diffOldFromToY;if(ratioX<=2&&ratioX>=-2&&0!==ratioX)var x=newFromX+diffNewFromToX*ratioX;else x=newFromX+oPt.x-oldFromX;if(ratioY<=2&&ratioY>=-2&&0!==ratioY)var y=newFromY+diffNewFromToY*ratioY;else y=newFromY+oPt.y-oldFromY;points.push(createPoint(x,y))}points.push(createPoint(newToX,newToY));points=function(points,oldPoints){var isVertical=1===_.uniq(_.pluck(oldPoints,"x")).length;var isHorizontal=1===_.uniq(_.pluck(oldPoints,"y")).length;isVertical?points=fixLineByProp(points,"x","y"):isHorizontal&&(points=fixLineByProp(points,"y","x"));return points}(points,oldPoints);if(1===zoomLinkHandler.zoomType&&oldFromY===oldPoints[1].y){var oldDir=oldPoints[1].x-oldFromX>0?1:-1;var diff=points[1].x-points[0].x;var dir=diff>0?1:-1;var oTmpX=points[1].x;if(oldDir!==dir){var nTmpX=points[0].x+-1*diff;points[1].x=nTmpX;for(i=2,len=points.length;i<len;i++){var p=points[i];if(p.x!==oTmpX)break;p.x=nTmpX}}}return points=pointsToString(points)}function fixLineByProp(points,propName,otherPropName){var pointsLen=points.length;if(points[0][propName]!==points[1][propName]||points[pointsLen-1][propName]!==points[pointsLen-2][propName]){var firstPoint=points[0];var lastPoint=points[pointsLen-1];var midIndex=pointsLen/2;for(var i=1;i<pointsLen-1;i++)points[i][propName]=i<midIndex?firstPoint[propName]:lastPoint[propName];var afterMid=Math.ceil(midIndex);var beforePt=points[afterMid-1];var afterPt=points[afterMid];beforePt[otherPropName]!==afterPt[otherPropName]&&(afterPt[otherPropName]=beforePt[otherPropName])}return points}function filterL2TopoLink(links){var result=[];links.each((function(link){(function(link){return link instanceof CompL2TopoLink})(link)&&result.push(link)}));return result}function pointsToString(pts){return pts=_.map(pts,(function(pt){return[pt.x,pt.y].join(" ")}))}function pointsToObj(pts){return pts=_.map(pts,(function(pt){var ptArr=pt.split(" ");return createPoint(ptArr[0],ptArr[1])}))}function createPoint(x,y){return{x:1*x,y:1*y}}zoomLinkHandler.forTest={getSimilarPoints:getSimilarPoints,getMinMaxValue:function(points,property){var arr=_.pluck(points,property);return{min:_.min(arr),max:_.max(arr)}},pointsToString:pointsToString,pointsToObj:pointsToObj,createPoint:createPoint};netBrain.Map=netBrain.Map||{};netBrain.Map.zoomLinkHandler=zoomLinkHandler}(NetBrain);function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}!function(netBrain){netBrain.L2Improvements.l2ImprovementsHelper.layoutPorts;var CompL2Device=netBrain.Map.CompL2Device;function L2PortsLayoutTool(diagram,netmap){this.diagram=diagram;this.netmap=netmap;this.allLayoutPorts=null}L2PortsLayoutTool.prototype.layout=function(devicePortsInfo){var diagram=this.diagram;var netmap=this.netmap;if(!diagram||!netmap||!netmap.isL2MapStyle())return;var _this=this;diagram.startTransaction("start l2ports layout");var nodes=this.getLayoutNodes(devicePortsInfo);this.buildLayoutPorts(devicePortsInfo);nodes.each((function(node){_this.layoutNode(node)}));diagram.commitTransaction("start l2ports layout")};L2PortsLayoutTool.prototype.getLayoutNodes=function(devicePortsInfo){var nodes;var diagram=this.diagram;if(_.isArray(devicePortsInfo)&&devicePortsInfo.length>0){nodes=new go.List;_.each(devicePortsInfo,(function(device){var node=diagram.findNodeForKey(device.key);node&&node.visible&&node instanceof netBrain.Map.CompL2Device&&nodes.add(node)}))}else nodes=this.getNodesInViewportBounds(diagram);return nodes};L2PortsLayoutTool.prototype.getNodesInViewportBounds=function(diagram){var nodes=diagram.nodes;var result=new go.List;diagram.viewportBounds;nodes.each((function(node){node.visible&&node instanceof netBrain.Map.CompL2Device&&result.add(node)}));return result};L2PortsLayoutTool.prototype.buildLayoutPorts=function(devicePortsInfo){var obj={};_.each(devicePortsInfo,(function(device){_.isArray(device.layoutPorts)&&device.layoutPorts.length>0&&(obj[device.key]=device.layoutPorts)}));this.allLayoutPorts=obj};L2PortsLayoutTool.prototype.layoutNode=function(node){var zoom=this.diagram.commandHandler.space;var links=function(node){var result=new go.List;node.findLinksConnected().each((function(link){if(link instanceof netBrain.Map.CompL2TopoLink){(link.fromNode===node?link.fromPort:link.toPort)instanceof netBrain.Map.CompL2Port&&result.add(link)}}));return result}(node);var relatedNodes=function(links){var set=new go.Set;links.each((function(link){var fromNode=link.fromNode;var toNode=link.toNode;fromNode&&set.add(fromNode);toNode&&set.add(toNode)}));return set}(links);relatedNodes.remove(node);relatedNodes=relatedNodes.toList();var portInfoList=new go.List;relatedNodes.each((function(rn){var info=function(oriA,otherB,zoom){var row=function(oriA,otherB){var angle=function(oriA,otherB){var aLoc=getNodeCenter(oriA);var bLoc=getNodeCenter(otherB);return calcAnglePointBRelativeToPointA(aLoc,bLoc)}(oriA,otherB);var br=oriA.findObject("DEVICE").getDocumentPoint(go.Spot.BottomRight);var aRight=br.x;var aBottom=br.y;var aAngle=calcAnglePointBRelativeToPointA(getNodeCenter(oriA),{x:aRight,y:aBottom});var row=0;angle>=aAngle&&angle<180-aAngle?row=1:angle>=0&&angle<aAngle||angle>=360-aAngle?row=2:angle>=180-aAngle&&angle<180+aAngle&&(row=3);return row}(oriA,otherB);var point=function(oriA,otherB,row){var aBounds=oriA.actualBounds;var aLeft=aBounds.left;var aTop=aBounds.top;var aRight=aBounds.right;var aBottom=aBounds.bottom;var edge=[{x:aLeft,y:aTop},{x:aRight,y:aTop}];switch(row){case 1:edge=[{x:aLeft,y:aBottom},{x:aRight,y:aBottom}];break;case 2:edge=[{x:aRight,y:aTop},{x:aRight,y:aBottom}];break;case 3:edge=[{x:aLeft,y:aTop},{x:aLeft,y:aBottom}]}return function(seg1,seg2){var a=seg1[0];var b=seg1[1];var c=seg2[0];var d=seg2[1];var denominator=(b.y-a.y)*(d.x-c.x)-(a.x-b.x)*(c.y-d.y);if(0==denominator)return!1;var x=((b.x-a.x)*(d.x-c.x)*(c.y-a.y)+(b.y-a.y)*(d.x-c.x)*a.x-(d.y-c.y)*(b.x-a.x)*c.x)/denominator;var y=-((b.y-a.y)*(d.y-c.y)*(c.x-a.x)+(b.x-a.x)*(d.y-c.y)*a.y-(d.x-c.x)*(b.y-a.y)*c.y)/denominator;if((x-a.x)*(x-b.x)<=0&&(y-a.y)*(y-b.y)<=0&&(x-c.x)*(x-d.x)<=0&&(y-c.y)*(y-d.y)<=0)return new go.Point(x,y);return new go.Point(x,y)}([getNodeCenter(oriA),getNodeCenter(otherB)],edge)||new go.Point(0,0)}(oriA,otherB,row);var col=function(oriA,row,point,zoom){var tl=oriA.findObject("DEVICE").getDocumentPoint(go.Spot.TopLeft);var left=tl.x;var top=tl.y;var CompL2Port=netBrain.Map.CompL2Port;var hSpace=CompL2Port.getHSpace(zoom);var vSpace=CompL2Port.getVSpace(zoom);var portW=CompL2Port.getWidth(zoom)+hSpace;var portH=CompL2Port.getHeight(zoom)+vSpace;var vMargin=CompL2Port.getVSideMargin();var column=0;var maxColCount=oriA.getColCount(row);column=0===row||1===row?Math.min(Math.max(Math.round((point.x-left)/portW),0),maxColCount):Math.min(Math.max(Math.round((point.y-top-2*vMargin)/portH),0),maxColCount);return column}(oriA,row,point,zoom||1);return{row:row,col:col,otherNode:otherB}}(node,rn,zoom);var count=function(links,node1,node2){var count=0;links.each((function(link){var fromNode=link.fromNode;var toNode=link.toNode;(fromNode===node1&&toNode===node2||fromNode===node2&&toNode===node1)&&count++}));return count}(links,node,rn);for(var i=0;i<count;i++)portInfoList.add(_.clone(info))}));this.applyPortsInfo(node,links,portInfoList)};L2PortsLayoutTool.prototype.applyPortsInfo=function(node,links,portInfoList){var hColCount=node.getColCount(0);var vColCount=node.getColCount(2);portInfoList.sort((function(p1,p2){return getIndexFromRowCol(p1.row,p1.col,hColCount,vColCount)-getIndexFromRowCol(p2.row,p2.col,hColCount,vColCount)}));var pos=function(portInfoList,hColCount,vColCount){var rowColArr=function(hCount,vCount){var rowColArr=[];for(var i=0,len=2*(hCount+vCount);i<len;i++)rowColArr.push(0);return rowColArr}(hColCount,vColCount);var rowColArrLen=rowColArr.length;var notSet=new go.List;var diffIndex=0;portInfoList.each((function(pi){var currIndex=getIndexFromRowCol(pi.row,pi.col,hColCount,vColCount);if(0!==rowColArr[currIndex+=diffIndex]){diffIndex++;currIndex+=1}currIndex>=rowColArrLen?notSet.add(pi):rowColArr[currIndex]=pi}));var i;var len;if(notSet.count>0){var voidArr=[];for(i=0,len=rowColArr.length;i<len;i++)0===rowColArr[i]&&voidArr.push(i);if(voidArr.length>0){var canSetCount=Math.min(voidArr.length,notSet.count);var startIndex=voidArr[voidArr.length-canSetCount];for(i=startIndex,len=rowColArr.length;i<len;i++)0===rowColArr[i]&&rowColArr.splice(i,1);for(i=0;i<canSetCount;i++)rowColArr.push(notSet.elt(i))}}for(i=0,len=rowColArr.length;i<len;i++){var info=rowColArr[i];if(0!==rowColArr[i]){var rowCol=getRowColFromIndex(i,hColCount,vColCount);info.row=rowCol[0];info.col=rowCol[1]}}return rowColArr}(portInfoList,hColCount,vColCount);var allLayoutPorts=this.allLayoutPorts;var notSet=new go.List;links.each((function(link){var fromNode=link.fromNode;var toNode=link.toNode;if(fromNode&&toNode){var otherNode=fromNode===node?toNode:fromNode;var port=fromNode===node?link.fromPort:link.toPort;if(port&&port instanceof netBrain.Map.CompL2Port&&!isPortLocked(port,allLayoutPorts)){var piInfo=function(rowColArr,node){var result;for(var i=0,len=rowColArr.length;i<len;i++){var piInfo=rowColArr[i];if("object"===_typeof(piInfo)&&piInfo.otherNode===node){result=piInfo;rowColArr[i]=1;break}}return result}(pos,otherNode);if(!piInfo)return;var portList=node.getPort(piInfo.row,piInfo.col);var hasLocked=!1;portList.each((function(curr){curr!==port&&(hasLocked=isPortLocked(curr,allLayoutPorts)||hasLocked)}));if(portList.size>0&&hasLocked)notSet.add({port:port,info:piInfo});else{port.setPortPos(piInfo.row,piInfo.col);portList.each((function(curr){if(curr!==port){var pos=function(port,row){var list=[0,2,1,3];var part=port.part;var pos=part.getNextNotUsedPos(row);if(!pos){list=_.filter(list,(function(curr){return curr!==row}));for(var i=0,len=list.length;i<len&&!(pos=part.getNextNotUsedPos(list[i]));i++);}return pos}(port,piInfo.row);pos&&curr.setPortPos(pos.row,pos.col)}}))}}}}));notSet.each((function(obj){var port=obj.port;var piInfo=obj.info;var row=piInfo.row;var col=piInfo.col;var curPort=node.getPort(row,col-1);if(curPort&&curPort!==port){var pos=node.getNextNotUsedPos(row);pos&&port.setPortPos(pos.row,pos.col)}else port.setPortPos(row,col-1)}))};function getStartIndexes(hColCount,vColCount){return{0:0,1:2*hColCount+vColCount-1,2:hColCount,3:2*hColCount+2*vColCount-1}}function getIndexFromRowCol(row,col,hColCount,vColCount){var startIndex=getStartIndexes(hColCount,vColCount)[row];return 1===row||3===row?startIndex-col:startIndex+col}function getRowColFromIndex(index,hColCount,vColCount){var startIndexes=getStartIndexes(hColCount,vColCount);var row0=startIndexes[0];var row1=startIndexes[1];var row2=startIndexes[2];var row3=startIndexes[3];var row=0;var col=0;if(index>=row0&&index<row2){row=0;col=index}else if(index>=row2&&index<row2+vColCount){row=2;col=index-row2}else if(index>row1-hColCount&&index<=row1){row=1;col=row1-index}else if(index>row3-vColCount&&index<=row3){row=3;col=row3-index}return[row,col]}function calcAnglePointBRelativeToPointA(pA,pB){var diffX=pB.x-pA.x;var diffY=pB.y-pA.y;var dis=Math.sqrt(diffX*diffX+diffY*diffY);var angle=0;if(0!==dis){angle=180*Math.acos(diffX/dis)/Math.PI;diffY<0&&(angle=360-angle)}return angle}function getNodeCenter(node){var loc=node.location;node instanceof netBrain.Map.CompL2Device&&(loc=node.findObject("DEVICE").getDocumentPoint(go.Spot.Center));return loc}function isPortLocked(port,allLayoutPorts){var flag=!1;if(!allLayoutPorts||!port)return flag;var layoutPorts=allLayoutPorts[port.part.data.key];layoutPorts&&_.isArray(layoutPorts)&&(flag=!_.some(layoutPorts,(function(tmpValue){return tmpValue===port.portId})));return flag}L2PortsLayoutTool.getAllRelatedPortsInfo=function(nodes){var nbrInfos=L2PortsLayoutTool.getNeighborPortsInfo(nodes);var currInfos=L2PortsLayoutTool.getPortsInfo(nodes);return L2PortsLayoutTool.megerPortsInfo(nbrInfos,currInfos)};L2PortsLayoutTool.getNeighborPortsInfo=function(nodes){var obj={};var isTopolink=netBrain.Map.CategoryMgr.isTopolink;nodes.iteratorValues.each((function(node){var key=node.data.key;node.linksConnected.each((function(link){if(isTopolink(link.data.category)){var from=link.data.from;var to=link.data.to;if(from!==key||nodes.contains(to)){if(to===key&&!nodes.contains(from)&&link.fromPortId){obj[from]||(obj[from]=[]);obj[from].push(link.fromPortId)}}else if(link.toPortId){obj[to]||(obj[to]=[]);obj[to].push(link.toPortId)}}}))}));return portsInfoObjToArray(obj)};L2PortsLayoutTool.getPortsInfo=function(nodes){var obj={};nodes.iteratorValues.each((function(node){if(node instanceof CompL2Device){var ports=node.getPorts(CompL2Device.VisiblePort);var portIdArray=_.pluck(ports,"portId");obj[node.data.key]=portIdArray}}));return portsInfoObjToArray(obj)};L2PortsLayoutTool.getAllPortsInfoByDeviceKeysAndLinkInfos=function(deviceKeys,linkInfos,diagram){if(!diagram)return[];var infos1=L2PortsLayoutTool.getPortsInfoByDeviceKeys(deviceKeys,diagram);var infos2=L2PortsLayoutTool.getPortsInfoByLinkInfos(linkInfos,diagram);return L2PortsLayoutTool.megerPortsInfo(infos1,infos2)};L2PortsLayoutTool.getPortsInfoByDeviceKeys=function(deviceKeys,diagram){if(!diagram)return[];var nodeMap=new go.Map;_.each(deviceKeys,(function(key){var node=diagram.findNodeForKey(key);node&&nodeMap.set(key,node)}));return L2PortsLayoutTool.getPortsInfo(nodeMap)};L2PortsLayoutTool.getPortsInfoByLinkInfos=function(linkInfos,diagram){var obj={};var isTopolink=netBrain.Map.CategoryMgr.isTopolink;_.each(linkInfos,(function(linkData){if(isTopolink(linkData.category)){var from=linkData.from;var to=linkData.to;if(from&&diagram.findNodeForKey(from)&&linkData.fromPort){obj[from]||(obj[from]=[]);obj[from].push(linkData.fromPort)}if(to&&diagram.findNodeForKey(to)&&linkData.toPort){obj[to]||(obj[to]=[]);obj[to].push(linkData.toPort)}}}));return portsInfoObjToArray(obj)};L2PortsLayoutTool.getPortsInfoByDragNodes=function(draggingNodes){var portInfos=[];var layoutablePorts=netBrain.L2Improvements.l2ImprovementsHelper.getLayoutablePortsByNodes(draggingNodes);layoutablePorts.length>0&&_.each(layoutablePorts,(function(obj){portInfos.push({key:obj.nodeId,layoutPorts:obj.portIds})}));return portInfos};L2PortsLayoutTool.megerPortsInfo=function(info1,info2){var obj=function(arr){var obj={};arr.forEach((function(info){obj[info.key]=_.clone(info.layoutPorts)}));return obj}(info1);info2.forEach((function(info){var key=info.key;obj[key]?obj[key]=_.union(obj[key],info.layoutPorts):obj[key]=_.clone(info.layoutPorts)}));return portsInfoObjToArray(obj)};function portsInfoObjToArray(obj){var result=[];for(var key in obj)result.push({key:key,layoutPorts:obj[key]});return result}netBrain.Map=netBrain.Map||{};netBrain.Map.L2PortsLayoutTool=L2PortsLayoutTool}(NetBrain);!function(netBrain){var QMapTreeLayout=function(zoom,path){go.TreeLayout.call(this);this.arrangement=go.TreeLayout.ArrangementHorizontal;this.angle=90;this.setsChildPortSpot=!1;this.setsPortSpot=!1;this.alternateSetsChildPortSpot=!1;this.alternateSetsPortSpot=!1;this.layerSpacing=50*zoom;this.nodeSpacing=80*zoom;path&&(this.path=go.TreeLayout.PathDestination)};go.Diagram.inherit(QMapTreeLayout,go.TreeLayout);QMapTreeLayout.prototype.arrangeTrees=function(){var roots=this.roots.toList();roots.sort((function(x,y){return x.maxGenerationCount<y.maxGenerationCount?1:x.maxGenerationCount>y.maxGenerationCount?-1:x.maxChildrenCount<y.maxChildrenCount?1:x.maxChildrenCount>y.maxChildrenCount?-1:x.descendantCount<y.descendantCount?1:-1}));this.roots=roots.toSet();go.TreeLayout.prototype.arrangeTrees.call(this)};netBrain.Map=netBrain.Map||{};netBrain.Map.QMapTreeLayout=QMapTreeLayout}(NetBrain);ConstValue.Pi=3.1415926;function MathFunc(){}MathFunc.getMiddlePoint=function(pt1,pt2){if(null==pt1||null==pt2)return null;var x=(pt1.x+pt2.x)/2;var y=(pt1.y+pt2.y)/2;return new go.Point(x,y)};MathFunc.getAngle=function(pt1,pt2){if(null==pt1||null==pt2)return null;var Point1=new go.Point(pt1.x,pt1.y);var Point2=new go.Point(pt2.x,pt2.y);return Point1.directionPoint(Point2)};MathFunc.ConvertAngleToRadian=function(nAngle){return nAngle/180*ConstValue.Pi};MathFunc.LineIntersect=function(p10,p20,p30,p40){var InRect=function(p1,p2,p3){var result=!1;Math.min(p1.x,p2.x)<=p3.x&&p3.x<=Math.max(p1.x,p2.x)&&Math.min(p1.y,p2.y)<=p3.y&&p3.y<=Math.max(p1.y,p2.y)&&(result=!0);return result};var MultiplyForMap=function(p1,p2,p3){return(p3.x-p1.x)*(p2.y-p1.y)-(p2.x-p1.x)*(p3.y-p1.y)};var d1=MultiplyForMap(p30,p40,p10);var d2=MultiplyForMap(p30,p40,p20);var d3=MultiplyForMap(p10,p20,p30);var d4=MultiplyForMap(p10,p20,p40);return d1*d2<0&&d3*d4<0||(!(0!==d1||!InRect(p30,p40,p10))||(!(0!==d2||!InRect(p30,p40,p20))||(!(0!==d3||!InRect(p10,p20,p30))||!(0!==d4||!InRect(p10,p20,p40)))))};MathFunc.VerticalAngle=function(p1,p2){var angleLine=MathFunc.getAngle(p1,p2);var verticalAngle=(angleLine%=360)+90;return verticalAngle%=360};MathFunc.getMiddleVerticalPoint=function(p1,p2,distance){null==distance&&(distance=0);var verticalAngle=MathFunc.VerticalAngle(p1,p2);var radian=MathFunc.ConvertAngleToRadian(verticalAngle);var ptMiddle=new go.Point((p1.x+p2.x)/2,(p1.y+p2.y)/2);var offsetX=distance*Math.cos(radian);var offsetY=distance*Math.sin(radian);ptMiddle.offset(offsetX,offsetY);return ptMiddle};MathFunc.getDistance=function(p1,p2){var x=Math.abs(p1.x-p2.x);var y=Math.abs(p1.y-p2.y);return Math.sqrt(x*x+y*y)};!function(netBrain){var GoDiagramPositionUtil=function(){};GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc=function(ptZoomDoc,diagram){if(null==diagram)return ptZoomDoc;var zoomCommand=diagram.commandHandler;if(null==zoomCommand)return ptZoomDoc;var ptZoomDocCopy=ptZoomDoc.copy();ptZoomDocCopy.x+=zoomCommand.fixX;ptZoomDocCopy.y+=zoomCommand.fixY;if(zoomCommand.space<1.02)return ptZoomDocCopy;var retPt=new go.Point(0,0);retPt.x=(ptZoomDocCopy.x-zoomCommand.spaceCenter.x)/zoomCommand.space+zoomCommand.spaceCenter.x;retPt.y=(ptZoomDocCopy.y-zoomCommand.spaceCenter.y)/zoomCommand.space+zoomCommand.spaceCenter.y;return retPt};GoDiagramPositionUtil.getZoomDocLocFromOriginDocLoc=function(ptOriginDoc,diagram){if(null==diagram)return ptOriginDoc;var zoomCommand=diagram.commandHandler;if(null==zoomCommand)return ptOriginDoc;if(zoomCommand.space<1.02){var retPt=ptOriginDoc.copy();retPt.x-=zoomCommand.fixX;retPt.y-=zoomCommand.fixY;return retPt}var retPt1=new go.Point(0,0);retPt1.x=(ptOriginDoc.x-zoomCommand.spaceCenter.x)*zoomCommand.space+zoomCommand.spaceCenter.x;retPt1.y=(ptOriginDoc.y-zoomCommand.spaceCenter.y)*zoomCommand.space+zoomCommand.spaceCenter.y;retPt1.x-=zoomCommand.fixX;retPt1.y-=zoomCommand.fixY;return retPt1};GoDiagramPositionUtil.docPtOffset=function(ptDoc,offsetX,offsetY,diagram){if(null==diagram)return null;var ptPoint=new go.Point(ptDoc.x,ptDoc.y);var cmd=diagram.commandHandler;var tmpOffsetX=offsetX*cmd.space;var tmpOffsetY=offsetY*cmd.space;ptPoint.x+=tmpOffsetX;ptPoint.y+=tmpOffsetY;return ptPoint};GoDiagramPositionUtil.transformViewToDoc=function(point,diagram){if(null==diagram||null==point)return null;var pt=diagram.transformViewToDoc(point);return pt=GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(pt,diagram)};GoDiagramPositionUtil.transformClientToDoc=function(ptClient,diagram){if(null==diagram||null==ptClient)return null;var ptPoint=new go.Point(0,0);var rectClient=diagram.div.getBoundingClientRect();ptPoint.x=ptClient.x-rectClient.left;ptPoint.y=ptClient.y-rectClient.top;return GoDiagramPositionUtil.transformViewToDoc(ptPoint,diagram)};GoDiagramPositionUtil.transformDocToClient=function(ptDoc,diagram){if(null==diagram||null==ptDoc)return null;var viewPos=diagram.transformDocToView(ptDoc);var diagramClientRect=diagram.div.getBoundingClientRect();var x=viewPos.x+diagramClientRect.left;var y=viewPos.y+diagramClientRect.top;return new go.Point(x,y)};GoDiagramPositionUtil.transformZoomDocToClient=function(ptZoomDoc,diagram){if(null==diagram||null==ptZoomDoc)return null;var ptDocOrg=GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(ptZoomDoc,diagram);null==ptDocOrg&&(ptDocOrg=new go.Point(0,0));return GoDiagramPositionUtil.transformDocToClient(ptDocOrg)};GoDiagramPositionUtil.getDropPtLocation=function(diagram,event){event=event||window.event;if(null==diagram)return null;var wx=event.clientX;var wy=event.clientY;var ptLast=new go.Point(wx,wy);return GoDiagramPositionUtil.transformClientToDoc(ptLast,diagram)};GoDiagramPositionUtil.getPosRet=function(diagram){var x=diagram.div.clientWidth/2;var y=diagram.div.clientHeight/2;var ptPos=diagram.transformViewToDoc(new go.Point(x,y));ptPos=GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(ptPos,diagram);var nu=diagram.nodes.count>0?200:0;var ptPosRet=GoDiagramPositionUtil.findProperZoomPosByTargetOriginPos(diagram,ptPos,150,nu);(ptPosRet=GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(ptPosRet,diagram)).x+=Math.random();ptPosRet.y+=Math.random();return ptPosRet};var Direction={};Direction.bottomRight=0;Direction.Right=1;Direction.topRight=2;Direction.top=3;Direction.topLeft=4;Direction.left=5;Direction.bottomLeft=6;Direction.bottom=7;GoDiagramPositionUtil.findProperZoomPosByTargetOriginPos=GoDiagramPositionUtil.findProperZoomPosByTargetOriginPos=function(diagram,ptTargetOrigin,distance,offsetDistance,nDirection){if(null==diagram)return null;var ptPosRet=null;null==offsetDistance&&(offsetDistance=200);var tuneOffsetForCircle=30;var tuneOffsetForCircle2=50;if(null==ptTargetOrigin)return new go.Point(0,0);var zoomCommand=diagram.commandHandler;if(null!=zoomCommand&&null!=zoomCommand.space){offsetDistance*=zoomCommand.space;tuneOffsetForCircle*=zoomCommand.space;tuneOffsetForCircle2*=zoomCommand.space}var ptZoomTarget=GoDiagramPositionUtil.getZoomDocLocFromOriginDocLoc(ptTargetOrigin,diagram);var defaultRet=new go.Point(ptZoomTarget.x,ptZoomTarget.y);defaultRet.offset(offsetDistance,offsetDistance);if(null==diagram)return defaultRet;var offsetArrary=[{x:offsetDistance-tuneOffsetForCircle,y:offsetDistance-tuneOffsetForCircle},{x:offsetDistance,y:0},{x:offsetDistance-tuneOffsetForCircle,y:-offsetDistance+tuneOffsetForCircle},{x:0,y:-offsetDistance},{x:-offsetDistance+tuneOffsetForCircle,y:-offsetDistance+tuneOffsetForCircle},{x:-offsetDistance,y:0},{x:-offsetDistance+tuneOffsetForCircle,y:offsetDistance-tuneOffsetForCircle},{x:0,y:offsetDistance}];var startDirection=nDirection;null==startDirection&&(startDirection=Direction.bottomRight);for(var levelCount=1;levelCount<26;levelCount++){var bFindProperPosition=!1;for(var count=0;count<offsetArrary.length;count++){var index=(startDirection+count)%offsetArrary.length;var offsetXY=offsetArrary[index];var tempPt=new go.Point(ptZoomTarget.x,ptZoomTarget.y);tempPt.offset(offsetXY.x*levelCount,offsetXY.y*levelCount);if(levelCount%2==0){0===index||7===index||6===index||5===index?tempPt.x+=tuneOffsetForCircle2:tempPt.x-=tuneOffsetForCircle2;3===index||4===index||5===index||6===index?tempPt.y+=tuneOffsetForCircle2:tempPt.y-=tuneOffsetForCircle2}ptPosRet=tempPt;var findObjs=GoDiagramPositionUtil.getObjsByPositionRange(diagram,tempPt,distance);if(null==findObjs||findObjs.length<=0){bFindProperPosition=!0;break}}if(bFindProperPosition)break}null==ptPosRet&&(ptPosRet=defaultRet);return ptPosRet};GoDiagramPositionUtil.getObjsByPositionRange=GoDiagramPositionUtil.getObjsByPositionRange=function(diagram,ptPosition,distance){var retObjs=[];if(null==diagram)return retObjs;var tempDistance=0;_.isNumber(distance)&&(tempDistance=distance);for(var selPartIter=diagram.findObjectsNear(ptPosition,tempDistance).iterator;selPartIter.next();){var selPart=selPartIter.value;null==selPart||selPart instanceof go.Link||isPath(selPart)||retObjs.push(selPart)}return retObjs};function isPath(node){try{return node.part.data.getCategory()===netBrain.Map.CategoryMgr.PathNew}catch(ex){return!1}}GoDiagramPositionUtil.zoomPositionArrayParse=GoDiagramPositionUtil.zoomPositionArrayParse=function(diagram,points,node){var newPoints=[];if(null!=points)for(var n=0;n<points.length;n++){var pt=go.Point.parse(points[n]);pt=GoDiagramPositionUtil.getZoomDocLocFromOriginDocLoc(pt,diagram);newPoints.push(pt.x);newPoints.push(pt.y)}if(null!=node.points&&2*node.points.length===newPoints.length){for(var i=0;i<newPoints.length;i+=2)if(newPoints[i].toFixed(2)!==node.getPoint(i/2).x.toFixed(2)||newPoints[i+1].toFixed(2)!==node.getPoint(i/2).y.toFixed(2))return newPoints;return node.points}return newPoints};GoDiagramPositionUtil.zoomPositionArrayStringify=GoDiagramPositionUtil.zoomPositionArrayStringify=function(diagram,points,data){var newPoints=[];if(null!=points)for(var n=0;n<points.length;n++){var pt=points.elt(n);pt=pt.copy();var retPt=GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(pt,diagram);newPoints.push(go.Point.stringify(retPt))}if(null!=data.points&&data.points.length===newPoints.length){for(var i=0;i<newPoints.length;i++){var oldPoint=go.Point.parse(data.points[i]);var newPoint=go.Point.parse(newPoints[i]);if(oldPoint.x.toFixed(2)!==newPoint.x.toFixed(2)||oldPoint.y.toFixed(2)!==newPoint.y.toFixed(2))return newPoints}return data.points}return newPoints};GoDiagramPositionUtil.zoomPositionParse=GoDiagramPositionUtil.zoomPositionParse=function(diagram,data){var retPt=new go.Point(0,0);if(null==diagram||null==data)return retPt;var strlocation;if("string"!=typeof(strlocation=data))return retPt;retPt=go.Point.parse(strlocation);return retPt=GoDiagramPositionUtil.getZoomDocLocFromOriginDocLoc(retPt,diagram)};GoDiagramPositionUtil.zoomPositionStringify=GoDiagramPositionUtil.zoomPositionStringify=function(diagram,ptLocation,data){var strLocation="0 0";if(null==diagram||null==ptLocation||null==data)return strLocation;var retPt=GoDiagramPositionUtil.getOriginDocLocFromZoomDocLoc(ptLocation,diagram);null==retPt&&(retPt=new go.Point(0,0));return strLocation=go.Point.stringify(retPt)};netBrain.Map=netBrain.Map||{};netBrain.Map.GoDiagramPositionUtil=GoDiagramPositionUtil;netBrain.Map.Direction=Direction}(NetBrain);!function(context,go){if(context&&go){context.GoDiagramEventRobot=function(dia){void 0===dia&&(dia=null);this.diagram=dia};context.GoDiagramEventRobot.prototype.mouseDown=function(x,y,time){if("number"!=typeof x||"number"!=typeof y)throw new Error("GoDiagramEventRobot.mouseDown first two args must be X,Y numbers");void 0===time&&(time=0);var diagram=this.diagram;if(diagram.isEnabled){var n=new go.InputEvent;n.diagram=diagram;n.documentPoint=new go.Point(x,y);n.viewPoint=diagram.transformDocToView(n.documentPoint);n.timestamp=time;n.down=!0;diagram.lastInput=n;diagram.firstInput=n.copy();diagram.currentTool.doMouseDown()}};context.GoDiagramEventRobot.prototype.mouseMove=function(x,y,time){if("number"!=typeof x||"number"!=typeof y)throw new Error("GoDiagramEventRobot.mouseMove first two args must be X,Y numbers");void 0===time&&(time=0);var diagram=this.diagram;if(diagram.isEnabled){var n=new go.InputEvent;n.diagram=diagram;n.documentPoint=new go.Point(x,y);n.viewPoint=diagram.transformDocToView(n.documentPoint);n.timestamp=time;diagram.lastInput=n;diagram.simulatedMouseMove(null,n.documentPoint,n.targetDiagram)||diagram.currentTool.doMouseMove()}};context.GoDiagramEventRobot.prototype.mouseUp=function(x,y,time){if("number"!=typeof x||"number"!=typeof y)throw new Error("GoDiagramEventRobot.mouseUp first two args must be X,Y numbers");void 0===time&&(time=0);var diagram=this.diagram;if(diagram.isEnabled){var n=new go.InputEvent;n.diagram=diagram;n.documentPoint=new go.Point(x,y);n.viewPoint=diagram.transformDocToView(n.documentPoint);n.timestamp=time;n.up=!0;diagram.firstInput.documentPoint.equals(n.documentPoint)&&(n.clickCount=1);diagram.lastInput=n;diagram.simulatedMouseUp(null,null,n.documentPoint,n.targetDiagram)||diagram.currentTool.doMouseUp()}}}}(window,window.go);var NgUtil=function(utils){function Bezier(ptStart,ptCtrl1,ptCtrl2,ptEnd){this.ptStart=ptStart;this.ptCtrl1=ptCtrl1;this.ptCtrl2=ptCtrl2;this.ptEnd=ptEnd;this.length=0;this.result=[];this.segmentTemplate=null}Bezier.prototype.segment=function(segmentTemplate,offset){var needCompute=!0;if(this.segmentTemplate){if(!(segmentTemplate=this._buildSegmentTemplate(segmentTemplate))||0===segmentTemplate.length)return this.result;if(segmentTemplate.length===this.segmentTemplate.length){needCompute=!1;for(var i=0;i<segmentTemplate.length;++i)if(segmentTemplate[i]!==this.segmentTemplate[i]){needCompute=!0;break}}}if(needCompute){this.segmentTemplate=null;var result=[[this.ptStart.x,this.ptStart.y]];Bezier._computePoint(this.ptStart.x,this.ptStart.y,this.ptCtrl1.x,this.ptCtrl1.y,this.ptCtrl2.x,this.ptCtrl2.y,this.ptEnd.x,this.ptEnd.y,.5,result);this._segment(result,segmentTemplate,offset);if(this.result.length>0){var lastSeg=this.result[this.result.length-1];lastSeg.length>0&&(lastSeg[lastSeg.length-1]={x:this.ptEnd.x,y:this.ptEnd.y})}}return this.result};Bezier.prototype._segment=function(arr,segmentTemplate,offset){var len=arr.length;if(!(len<2)){var x,y,x2,y2;x=arr[0][0];y=arr[0][1];var dx,dy,slope,dist,distRemaining;var distRemainingTotal=0;var segData=[];for(var i=1;i<len;i++){var p=arr[i];0===(dx=(x2=p[0])-x)&&(dx=1e-6);slope=(dy=(y2=p[1])-y)/dx;distRemaining=Math.sqrt(dx*dx+dy*dy);segData.push([dx,slope,distRemaining]);distRemainingTotal+=distRemaining;x=x2;y=y2}this.length=distRemainingTotal;if(!this.segmentTemplate){this.segmentTemplate=this._buildSegmentTemplate(segmentTemplate);if(!this.segmentTemplate)return}this.result=[];x=arr[0][0];y=arr[0][1];var dashCount=this.segmentTemplate.length;var dashIndex=0;var dashLength=this.segmentTemplate[dashIndex%dashCount];var first=0!==offset;var currSegNum=0;var currSeg=segData[currSegNum];dx=currSeg[0];slope=currSeg[1];dist=currSeg[2];var remainder=0;for(;distRemainingTotal>0;){if(0===remainder){0===this.result.length?this.result.push([this.ptStart]):this.result.push([]);dashLength=this.segmentTemplate[dashIndex%dashCount];dashIndex++;if(first){dashLength-=offset%=dashLength;first=!1}}dashLength>distRemainingTotal&&(dashLength=distRemainingTotal);if(dashLength>dist){remainder=dashLength-dist;dashLength=dist}else remainder=0;var xStep=Math.sqrt(dashLength*dashLength/(1+slope*slope));dx<0&&(xStep=-xStep);x+=xStep;y+=slope*xStep;this.result[this.result.length-1].push({x:x,y:y});distRemainingTotal-=dashLength;dist-=dashLength;if(0!==remainder){if(++currSegNum===segData.length)return;dx=(currSeg=segData[currSegNum])[0];slope=currSeg[1];dist=currSeg[2];dashLength=remainder}}}};Bezier.prototype._buildSegmentTemplate=function(segmentTemplate){return"number"==typeof segmentTemplate&&this.length>0?[this.length/segmentTemplate]:segmentTemplate instanceof Array?segmentTemplate:null};Bezier.prototype.getBounds=function(){var bounds=new go.Rect(this.ptStart.x,this.ptStart.y,0,0);for(var i=0;i<this.result.length;++i){var arr=this.result[i];for(var j=0;j<arr.length;++j){var pt=arr[j];bounds.union(pt.x,pt.y,0,0)}}return bounds};Bezier.prototype.constructor._computePoint=function(sx,sy,c1x,c1y,c2x,c2y,ex,ey,epsilon,result){if(Bezier._isNearLine(sx,sy,ex,ey,epsilon,c1x,c1y)&&Bezier._isNearLine(sx,sy,ex,ey,epsilon,c2x,c2y)){0===result.length&&result.push([sx,sy]);result.push([ex,ey])}else{var a1x=(sx+c1x)/2;var a1y=(sy+c1y)/2;var a2x=(c1x+c2x)/2;var a2y=(c1y+c2y)/2;var a3x=(c2x+ex)/2;var a3y=(c2y+ey)/2;var vx=(a1x+a2x)/2;var vy=(a1y+a2y)/2;var wx=(a2x+a3x)/2;var wy=(a2y+a3y)/2;var mx=(vx+wx)/2;var my=(vy+wy)/2;Bezier._computePoint(sx,sy,a1x,a1y,vx,vy,mx,my,epsilon,result);Bezier._computePoint(mx,my,wx,wy,a3x,a3y,ex,ey,epsilon,result)}return result};Bezier.prototype.constructor._isNearLine=function(ax,ay,bx,by,fuzz,px,py){fuzz<=0&&(fuzz=1e-6);var maxx,minx,maxy,miny;if(ax<bx){minx=ax;maxx=bx}else{minx=bx;maxx=ax}if(ay<by){miny=ay;maxy=by}else{miny=by;maxy=ay}if(ax===bx)return miny<=py&&py<=maxy&&ax-fuzz<=px&&px<=ax+fuzz;if(ay===by)return minx<=px&&px<=maxx&&ay-fuzz<=py&&py<=ay+fuzz;var xrangeHigh=maxx+fuzz;var xrangeLow=minx-fuzz;if(xrangeLow<=px&&px<=xrangeHigh){var yrangeHigh=maxy+fuzz;var yrangeLow=miny-fuzz;if(yrangeLow<=py&&py<=yrangeHigh)if(xrangeHigh-xrangeLow>yrangeHigh-yrangeLow){if(!(ax-bx>fuzz||bx-ax>fuzz))return!0;var guessY=(by-ay)/(bx-ax)*(px-ax)+ay;if(guessY-fuzz<=py&&py<=guessY+fuzz)return!0}else{if(!(ay-by>fuzz||by-ay>fuzz))return!0;var guessX=(bx-ax)/(by-ay)*(py-ay)+ax;if(guessX-fuzz<=px&&px<=guessX+fuzz)return!0}}return!1};utils.Bezier=Bezier;utils.bezierMidPoint=function(sx,sy,c1x,c1y,c2x,c2y,ex,ey,midp){var m2x=(c1x+c2x)/2;var m2y=(c1y+c2y)/2;var vx=((sx+c1x)/2+m2x)/2;var vy=((sy+c1y)/2+m2y)/2;var wx=(m2x+(c2x+ex)/2)/2;var wy=(m2y+(c2y+ey)/2)/2;midp.x=(vx+wx)/2;midp.y=(vy+wy)/2;return midp};Bezier.computeMidPoint=function(points){var refPoint=new go.Point,pointsCount=points.length;if(pointsCount<3)return refPoint;if(3===pointsCount)return points[1];var numsegs=(pointsCount-1)/3|0;var idx=3*(numsegs/2|0);if(numsegs%2==1){var a=points[idx];var b=points[idx+1];var c=points[idx+2];var d=points[idx+3];utils.bezierMidPoint(a.x,a.y,b.x,b.y,c.x,c.y,d.x,d.y,refPoint);return refPoint}refPoint.assign(points[idx]);return refPoint};utils.splitTwoBezierByPoint=function(start,control1,control2,end){return utils.splitTwoBezier(start.x,start.y,control1.x,control1.y,control2.x,control2.y,end.x,end.y)};utils.splitTwoBezier=function(sx,sy,c1x,c1y,c2x,c2y,ex,ey){var ret=[{startX:null,startY:null,ctrlPt1X:null,ctrlPt1Y:null,ctrlPt2X:null,ctrlPt2Y:null,endX:null,endY:null},{startX:null,startY:null,ctrlPt1X:null,ctrlPt1Y:null,ctrlPt2X:null,ctrlPt2Y:null,endX:null,endY:null}];var tmpMidPt_x=(c1x+c2x)/2,tmpMidPt_y=(c1y+c2y)/2;var midp={};utils.bezierMidPoint(sx,sy,c1x,c1y,c2x,c2y,ex,ey,midp);ret[0].startX=sx;ret[0].startY=sy;ret[0].ctrlPt1X=(sx+c1x)/2;ret[0].ctrlPt1Y=(sy+c1y)/2;ret[0].ctrlPt2X=(tmpMidPt_x+ret[0].ctrlPt1X)/2;ret[0].ctrlPt2Y=(tmpMidPt_y+ret[0].ctrlPt1Y)/2;ret[0].endX=midp.x;ret[0].endY=midp.y;ret[1].startX=midp.x;ret[1].startY=midp.y;ret[1].ctrlPt2X=(c2x+ex)/2;ret[1].ctrlPt2Y=(c2y+ey)/2;ret[1].ctrlPt1X=(ret[1].ctrlPt2X+tmpMidPt_x)/2;ret[1].ctrlPt1Y=(ret[1].ctrlPt2Y+tmpMidPt_y)/2;ret[1].endX=ex;ret[1].endY=ey;return ret};utils.lineContainsPoint=function(ax,ay,bx,by,fuzz,px,py){fuzz<=0&&(fuzz=1e-6);var maxx,minx,maxy,miny;if(ax<bx){minx=ax;maxx=bx}else{minx=bx;maxx=ax}if(ay<by){miny=ay;maxy=by}else{miny=by;maxy=ay}if(ax===bx)return miny<=py&&py<=maxy&&ax-fuzz<=px&&px<=ax+fuzz;if(ay===by)return minx<=px&&px<=maxx&&ay-fuzz<=py&&py<=ay+fuzz;var xrangeHigh=maxx+fuzz;var xrangeLow=minx-fuzz;if(xrangeLow<=px&&px<=xrangeHigh){var yrangeHigh=maxy+fuzz;var yrangeLow=miny-fuzz;if(yrangeLow<=py&&py<=yrangeHigh)if(xrangeHigh-xrangeLow>yrangeHigh-yrangeLow){if(!(ax-bx>fuzz||bx-ax>fuzz))return!0;var guessY=(by-ay)/(bx-ax)*(px-ax)+ay;if(guessY-fuzz<=py&&py<=guessY+fuzz)return!0}else{if(!(ay-by>fuzz||by-ay>fuzz))return!0;var guessX=(bx-ax)/(by-ay)*(py-ay)+ax;if(guessX-fuzz<=px&&px<=guessX+fuzz)return!0}}return!1};utils.bezierContainsPoint=function(sx,sy,c1x,c1y,c2x,c2y,ex,ey,epsilon,px,py,thickness){if(!utils.lineContainsPoint(sx,sy,ex,ey,thickness,c1x,c1y)||!utils.lineContainsPoint(sx,sy,ex,ey,thickness,c2x,c2y)){var a1x=(sx+c1x)/2;var a1y=(sy+c1y)/2;var a2x=(c1x+c2x)/2;var a2y=(c1y+c2y)/2;var a3x=(c2x+ex)/2;var a3y=(c2y+ey)/2;var vx=(a1x+a2x)/2;var vy=(a1y+a2y)/2;var wx=(a2x+a3x)/2;var wy=(a2y+a3y)/2;var mx=(vx+wx)/2;var my=(vy+wy)/2;return utils.bezierContainsPoint(sx,sy,a1x,a1y,vx,vy,mx,my,epsilon,px,py,thickness)||utils.bezierContainsPoint(mx,my,wx,wy,a3x,a3y,ex,ey,epsilon,px,py,thickness)}return utils.lineContainsPoint(sx,sy,ex,ey,thickness,px,py)};return utils}(NgUtil||{});function FontParser(){this.fontStyle="";this.fontVariant="";this.fontWeight="";this.fontSize="";this.fontHeight="";this.fontFamily=""}FontParser.prototype={construct:FontParser,fromString:function(fontString){if(null==fontString)return null;var fontParser=$("<span/>");fontParser.css("font",fontString);this.fontWeight=fontParser.css("fontWeight");this.fontStyle=fontParser.css("fontStyle");this.fontVariant=fontParser.css("fontVariant");this.fontSize=fontParser.css("fontSize");this.fontHeight=fontParser.css("lineHeight");this.fontFamily=fontParser.css("fontFamily");fontParser.remove();return null},toString:function(){var retFontString="";null!=this.fontStyle&&(retFontString+=this.fontStyle+" ");null!=this.fontVariant&&(retFontString+=this.fontVariant+" ");null!=this.fontWeight&&(retFontString+=this.fontWeight+" ");null!=this.fontSize?retFontString+=this.fontSize+" ":null!=this.fontHeight?retFontString+=this.fontHeight+" ":retFontString+="1em ";null!=this.fontFamily&&(retFontString+=this.fontFamily);return retFontString},setFontStyle:function(strFontStyle){null!=strFontStyle&&(this.fontStyle=strFontStyle)},getFontStyle:function(){return this.fontStyle},setFontVariant:function(strFontVariant){null!=strFontVariant&&(this.fontVariant=strFontVariant)},getFontVariant:function(){return this.fontVariant},setFontWeight:function(strFontWeight){null!=strFontWeight&&(this.fontWeight=strFontWeight)},getFontWeight:function(){return null==this.fontWeight?"normal":parseInt(this.fontWeight)<=550?"normal":"bold"},setFontSize:function(strFonotSize){null!=strFonotSize&&(this.fontSize=strFonotSize)},getFontSize:function(){return this.fontSize},setFontHeight:function(strFontHeight){null!=strFontHeight&&(this.fontHeight=strFontHeight)},getFontHeight:function(){return this.fontHeight},setFontFamily:function(strFonotFamily){null!=strFonotFamily&&(this.fontFamily=strFonotFamily)},getFontFamily:function(){return this.fontFamily}};NetBrain,angular.module("nb.qmap").factory("nb.qmap.StencilSrvc",["$http","$q","$timeout","$log","nb.ng.utilitySrvc","$location","nb.ng.nbHttp",function($http,$q,$timeout,$log,utilitySrvc,$location,nbHttp){return{getAllStencilImage:function(data){return nbHttp.get("Admin/StencilImages/getAllStencilImages",data,{cache:!0,cacheLevel:"Tenant"})},getAllCustomStencil:function(){return nbHttp.get("map/customized/stencils")},addCustomStencil:function(data){return nbHttp.post("map/customized/stencils",data)},deleteCustomStencil:function(id){return nbHttp.delete("map/customized/stencils/"+id)},renameCustomStencil:function(id,newName){return nbHttp.patch("map/customized/stencils/"+id,newName)}}}]);!function(netBrain){function CStencilImgManager(){this.allImageInfo=[]}CStencilImgManager.prototype.getAllImageInfo=function(){return this.allImageInfo};CStencilImgManager.prototype.synImgFromServer=function(StencilSrvc,successCallBack,failCallBack){var thisStencilImgManager=this;StencilSrvc.getAllStencilImage().then((function(data){var findLagMedia=_.find(data,{displayName:"LAG"});if(findLagMedia){findLagMedia.width=102;findLagMedia.height=62}var findBPEMedia=_.find(data,{displayName:"BPE Port"});if(findBPEMedia){findBPEMedia.width=102;findBPEMedia.height=62}thisStencilImgManager.allImageInfo=_.sortBy(data,"order");null!=successCallBack&&successCallBack();thisStencilImgManager.constructImagePath()}),(function(reason){null!=failCallBack&&failCallBack(reason)}))};CStencilImgManager.prototype.constructImagePath=function(){if(this.allImageInfo){var imgpath=[];for(var i=0;i<this.allImageInfo.length;i++){var oneImageInfo=this.allImageInfo[i];if(null!=oneImageInfo){oneImageInfo.imagePath=NetBrain.deviceIcon.getIconStreamURIById(oneImageInfo.ID+oneImageInfo.extension);imgpath.push("<img type='image' style='display:none' src='"+oneImageInfo.imagePath+"'>")}}window.setTimeout((function(){var imgpathhtml=imgpath.join("");angular.element("body").append(imgpathhtml)}),200)}};CStencilImgManager.DragTypeString="dragStencil";CStencilImgManager.decorateDragType=function(stencilItem){null!=stencilItem&&(stencilItem.dragType=CStencilImgManager.DragTypeString)};CStencilImgManager.isStencilDragData=function(stencilItem){return null!=stencilItem&&null!=stencilItem.dragType&&stencilItem.dragType===CStencilImgManager.DragTypeString};var StencilImgManager=new CStencilImgManager;netBrain.Map=netBrain.Map||{};netBrain.Map.StencilImgManager=StencilImgManager}(NetBrain);!function(netBrain){angular.module("nb.qmap").factory("nb.qmap.httpMapSrvc",httpMapSrvc);httpMapSrvc.$inject=["$rootScope","$http","$q","$timeout","nb.ng.httpAuthSrvc","nb.ng.nbHttp","$upload","nb.ng.utilitySrvc","nb.ng.httpDownloadingSrvc"];function httpMapSrvc($rootScope,$http,$q,$timeout,httpAuthSrvc,nbHttp,$upload,utilitySrvc,httpDownloadingSrvc){function ajax(url,method,request,options){return nbHttp[method.toLowerCase()](url,request,options)}function get(url,request,options){return ajax(url,"GET",request,options)}function post(url,request){return ajax(url,"POST",request)}var isPostBlob=!0;function postBlob(url,requestData){var _deferred=$q.defer();url=NetBrain.NG.ConfigSettings.API_ROOT+url;$http({url:url,method:"POST",responseType:"arraybuffer",data:requestData,headers:{"Content-type":"application/json",Accept:"application/x-vsd",Authorization:"Bearer "+httpAuthSrvc.getAccessToken("mainUi"),TenantGuid:$rootScope.selectedTenantId,DomainGuid:$rootScope.selectedDomainIds}}).success((function(data,status,headers,config){if(200===status){if(isPostBlob){var blob=new Blob([data],{type:"application/x-vsd"});var header=headers();var fileName=config.data.map.title.replace(/\r\n/g,"");/filename=(.*)/.test(header["content-disposition"])&&(fileName=headers()["content-disposition"].match(/filename=(.*)/)[1]);fileName=fileName.replace(/"/g,"");saveAs(blob,fileName)}_deferred.resolve("OK")}})).error((function(){_deferred.reject("there is an error")}));return _deferred.promise}return{updateMapPageImages:function(mapImageObj){return post("map/updateMapThumbnails",mapImageObj)},importMap:function(importObj){var defer=$q.defer();var modifiedDate=new Date(importObj.file.lastModified).toJSON();var data={folderId:importObj.folderId,file:importObj.file,no:importObj.no,name:importObj.name,autoRename:importObj.autoRename,fileCreateDateTime:modifiedDate};var dataSrc=httpAuthSrvc.getDataSrc(utilitySrvc);var headers={TenantGuid:dataSrc.TenantGuid,DomainGuid:dataSrc.DomainGuid};$upload.upload({url:NetBrain.NG.ConfigSettings.API_ROOT+"map/importMap/"+data.folderId+"/"+data.autoRename,method:"POST",file:data.file,fileName:data.name,autoRename:data.autoRename,headers:headers,fileCreateDateTime:data.fileCreateDateTime}).success((function(result){defer.resolve(result)})).error((function(result){defer.reject(result)}));return defer.promise},checkMapNameExist:function(checkObj){return post("map/checkMapNameExist",{CheckMapNameList:checkObj.checkMapNameList,FolderId:checkObj.folderId})},getMapByKey:function(guid,isWidget){var mapUrl="map/getMapByKey/"+guid;var args=[];isWidget&&args.push("isWidget="+isWidget);args.length>0&&(mapUrl+="?"+args.join("&"));return post(mapUrl)},getTopoLinkPolicyInfo:function(){return get("TopoLinkStylePolicy/getOneEffective")},getDefaultIconsByDevTypes:function(devTypes){return post("DeviceIcon/getIconListByTypes",devTypes)},getUpdatedMapByKey:function(guid,mapType){return post("map/getUpdatedMapByKey/"+guid+"/"+mapType)},getHasUpdatedInfoByKey:function(guid,mapType){return post("map/getHasUpdatedInfoByKey/"+guid+"/"+mapType)},getMapInfoByKey:function(guid){return post("map/getMapInfoByKey/"+guid)},updateMapByKey:function(map){return post("map/updateMapByKey",{map:map})},exportMapToViso:function(map,isNew){isPostBlob=!0;return window.navigator.userAgent.indexOf("Safari")>0&&window.navigator.userAgent.indexOf("Mac OS")>0?this.updateMapByKey(map).then((function(){var _deferred=$q.defer();var dataSrc=httpAuthSrvc.getDataSrc();var url=netBrain.NG.ConfigSettings.API_ROOT+"map/exportMapToVisoByMapId?mapId="+map.ID;url+="&tenantGuid="+dataSrc.TenantGuid+"&domainGuid="+dataSrc.DomainGuid;httpDownloadingSrvc.getTicket().then((function(ticketData){url+="&dl_ticket="+ticketData;location.href=url;_deferred.resolve("OK")}),(function(err){_deferred.reject("failed to get downloading ticket...")})).finally((function(){return _deferred.promise}))})):postBlob(isNew?"map/exportMapToVisoNew":"map/exportMapToViso",{map:map})},cancelExportMapToViso:function(){return isPostBlob=!1},cancelExportMapById:function(cid){isPostBlob=!1;return post("map/cancelExportMapTask/"+cid)},startExportMapTask:function(mapSimpleObj,canceler){var gmtValue=-(new Date).getTimezoneOffset()/60;var mapId=mapSimpleObj.mapId;mapSimpleObj.mapName;var cid=mapSimpleObj.cid;isPostBlob=!0;httpAuthSrvc.getDataSrc();var url="map/startExportMapTask?mapId="+mapId;url+="&gmtValue="+gmtValue;url+="&requestTaskId="+cid;url+="&f="+(new Date).getTime();mapSimpleObj.runbookId&&(url+="&runbookId="+mapSimpleObj.runbookId);return get(url,{},{responseType:"arraybuffer",headers:{"Content-type":"application/x-zip-compressed",Accept:"application/x-zip-compressed",Authorization:"Bearer "+httpAuthSrvc.getAccessToken("mainUi")},timeout:canceler.promise})},getExportMapTaskIsFinish:function(cid){return get("map/getExportMapTaskIsFinish/"+cid)},getMapZipByTaskId:function(cid,mapSimpleObj,canceler){var defer=$q.defer();get("map/getMapZipByTaskId/"+cid,{},{responseType:"arraybuffer",headers:{"Content-type":"application/x-zip-compressed",Accept:"application/x-zip-compressed",Authorization:"Bearer "+httpAuthSrvc.getAccessToken("mainUi")},timeout:canceler.promise}).then((function(data){if(isPostBlob){var blob=new Blob([data],{type:"application/x-zip-compressed"});var fileName=mapSimpleObj.mapName+".xmap";fileName.length<=5&&(fileName="Map"+utilitySrvc.format(new Date,"yyyyMMddhhmmssiii")+".xmap");saveAs(blob,fileName);isPostBlob=!1;defer.resolve("OK")}else defer.resolve("CANCEL")}),(function(err,statusCode){defer.resolve({code:"ERROR",error:{status:statusCode,data:err}})}));return defer.promise},startExportMapToImageTask:function(mapImageObj,breakHandle){httpAuthSrvc.getAccessToken("mainUi"),breakHandle&&breakHandle.promise;return post("map/uploadMapPic",mapImageObj)},cancelExportMapToImageTask:function(taskId){return get("map/cancelGetMapPicZip/"+{taskId:taskId})},exportMapToImage:function(taskId,mapName,breakHandle){isPostBlob=!0;var defer=$q.defer();var options={responseType:"arraybuffer",headers:{"Content-type":"application/x-zip-compressed",Accept:"application/x-zip-compressed",Authorization:"Bearer "+httpAuthSrvc.getAccessToken("mainUi")},timeout:breakHandle?breakHandle.promise:null};get("map/getMapPicZip",{taskId:taskId,fileName:mapName},options).then((function(data){if(isPostBlob){var blob=new Blob([data],{type:"application/x-zip-compressed"});var fileName=mapName+".zip";fileName.length<=4&&(fileName="Map"+utilitySrvc.format(new Date,"yyyyMMddhhmmssiii")+".zip");saveAs(blob,fileName);isPostBlob=!1;defer.resolve("OK")}else defer.resolve("CANCEL")}),(function(err,statusCode){defer.resolve({code:"ERROR",error:{status:statusCode,data:err}})}));return defer.promise},saveMapAs:function(map,folderId){$timeout((function(){$rootScope.$broadcast(netBrain.NetworkOS.Events.MY_FILES_REFRESH_FILE_LIST,{folder:{id:folderId}})}));return post("map/saveAsMap",{map:map,parentTreeId:folderId})},addMapFileToTree:function(mapFileReq){return post("map/addMapFileToTree",mapFileReq)},isMapExist:function(guid){return post("map/isMapExist/"+guid)},getSystemMapByKey:function(guid,systemMapType,isWidget){return post("map/getSystemMapByKey/"+guid+"/"+systemMapType+"/"+(isWidget||!1))},getMapUpdateHistory:function(filterKey){return post("map/mapupdatehistory/getall",filterKey)},getEditingRight:function(mapId){return post("mapcollaboration/getEditingRight/"+mapId)},getTempEditingRight:function(mapId,windowName){return post("mapcollaboration/getTempEditingRight",{mapId:mapId,tabId:windowName})},releaseEditingRight:function(mapId){return post("mapcollaboration/releaseEditingRight/"+mapId)},transferEditingRight:function(filter){return post("mapcollaboration/TransferEditingRight",filter)},denyEditingRight:function(filter){return post("mapcollaboration/DenyEditingRight",filter)},requestEditingRight:function(filter){return post("mapcollaboration/RequestEditingRight",filter)},forceGetEditingRight:function(filter){return post("mapcollaboration/forceGetEditingRight",filter)},noticeHasForceequestEditingRight:function(filter){return post("map/noticeHasForceequestEditingRight",filter)},shareFileToUsers:function(data){return post("mapcollaboration/shareFileToUsers",data)},sendEmail:function(data){return post("user/sendemail",data)},listScheduleUpdateMap:function(pageNumber,pageSize,mapType,filter,benchmarkTaskIds){var data={pageNumber:pageNumber,pageSize:pageSize,mapTypeList:mapType,filter:filter};benchmarkTaskIds&&benchmarkTaskIds.length>0&&(data.benchmarkTaskIds=benchmarkTaskIds);return post("updatemapmgr/listScheduleUpdateMap",data)},listScheduleUpdateMapBenchmark:function(){return get("updatemapmgr/listScheduleUpdateMapBenchmark")},checkRestoreMapIsEnable:function(benchmarkId,mapIds,mapTypeList){return post("updatemapmgr/checkRestoreMapIsEnable",{benchmarkId:benchmarkId,mapIds:mapIds||[],mapTypeList:mapTypeList})},getTimeListForRestore:function(benchmarkId,mapIds,pageIndex,pageSize,mapTypeList){return post("updatemapmgr/getTimeListForRestore",{benchmarkId:benchmarkId,mapIds:mapIds||[],mapTypeList:mapTypeList,pageIndex:pageIndex,pageSize:pageSize})},addRestoreMapTask:function(benchmarkId,mapIds,benchmarkRunTime,mapTypeList){return post("updatemapmgr/addRestoreMapTask",{benchmarkId:benchmarkId,mapIds:mapIds||[],benchmarkRunTime:benchmarkRunTime,mapTypeList:mapTypeList})},getRunningRestoreMapTask:function(){return get("updatemapmgr/getRunningRestoreMapTask")},getSiteMapCountByBechmarkId:function(siteMapArray){return post("updatemapmgr/getSiteMapCountByBechmarkId",siteMapArray)},getChildrenSiteByParentId:function(mapId,selectedSiteIds){return post("updatemapmgr/getChildernSiteByparentId",{parentId:mapId,childernSiteIds:selectedSiteIds})},getNotExistSiteIds:function(data){return post("updatemapmgr/getNotExistSiteIds",data)},getFirstChildrenBySiteIds:function(data){return post("updatemapmgr/getFirstChildrenBySiteIds",data)},addMapAction:function(data){return post("map/addMapAction",data)},getMapAction:function(id){return get("map/getMapAction/"+id)},deleteMapAction:function(id){return nbHttp.delete("map/map-action-data/"+id)},getMapPropertyByKey:function(mapId){return get("map/property/"+mapId)},getMapThumbnails:function(mapId){var defer=$q.defer();get("map/getMapThumbnails",{mapId:mapId}).then((function(result){defer.resolve(result)}),(function(){defer.resolve(null)}));return defer.promise},getMapThumbnailsArray:function(mapIds){var defer=$q.defer();if(_.isArray(mapIds)){var qList=[];for(var i=0;i<mapIds.length;i++)qList.push(this.getMapThumbnails(mapIds[i]));$q.all(qList).then((function(result){defer.resolve(result)}),(function(err){defer.reject(err)}))}else _.isString(mapIds)?get("map/getMapThumbnails",{mapId:mapIds}).then((function(result){defer.resolve([result])}),(function(err){defer.reject(err)})):defer.resolve([]);return defer.promise},closeMap:function(mapId){var api="map/closeMap/"+mapId;if(navigator&&navigator.sendBeacon){var url=NetBrain.NG.ConfigSettings.API_ROOT+api+"?bearer_token="+httpAuthSrvc.getAccessToken("mainUi")+"&TenantGuid="+$rootScope.selectedTenantId+"&DomainGuid="+$rootScope.selectedDomainIds;navigator.sendBeacon(url)}else nbHttp.post(api)}}}}(NetBrain);!function(){angular.module("nb.qmap").factory("nb.qmap.httpMapLayoutSrvc",httpMapLayoutSrvc);httpMapLayoutSrvc.$inject=["$rootScope","$http","$q","$timeout","nb.ng.httpAuthSrvc","nb.ng.nbHttp","$upload","nb.ng.utilitySrvc"];function httpMapLayoutSrvc($rootScope,$http,$q,$timeout,httpAuthSrvc,nbHttp,$upload,utilitySrvc){function ajax(url,method,request){return nbHttp[method.toLowerCase()](url,request)}function post(url,request){return ajax(url,"POST",request)}function get(url,request){return ajax(url,"GET",request)}return{uploadTags:function(data,handler){return this.uploadFile(data,"",handler)},uploadFile:function(data,urlPath,handler){var defer=$q.defer();var dataSrc=httpAuthSrvc.getDataSrc(utilitySrvc);var headers={TenantGuid:dataSrc.TenantGuid,DomainGuid:dataSrc.DomainGuid};$upload.upload({url:NetBrain.NG.ConfigSettings.API_ROOT+"api/Common/readExcel",method:"POST",file:data.file,headers:headers,data:{fileName:data.fileName},timeout:handler.promise}).success((function(result){defer.resolve(result)})).error((function(result){defer.reject(result)}));return defer.promise},downloadTemplate:function(data){return post("layout/mapAssociation/exportTemplate",data)},addLayoutStyle:function(data){return post("layout/template/addLayoutStyle",data)},getAllLayoutStyleByPage:function(data){return post("layout/template/getAllLayoutStyleByPage",data=data||{pageNumber:0,pageSize:5e3})},getLayoutStyleById:function(id){return get("layout/template/getLayoutStyleById/"+id)},getLayoutStyleByType:function(){return get("layout/template/getLayoutStyleByType/1")},updateLayoutStyle:function(data){return post("layout/template/updateLayoutStyle",data)},deleteLayoutStyleByIds:function(idList){return post("layout/template/deleteLayoutStyleByIds",idList)},getLayoutStyleTypeCount:function(){return get("layout/template/getLayoutStyleTypeCount")},rename:function(layoutId,name){return post("layout/template/rename",{id:layoutId,newName:name})},layoutMoveTo:function(fileIds,toFolderId){return post("layout/template/move",{ids:fileIds,toFolderId:toFolderId})},hasDuplicateName:function(data){return post("layout/template/hasDuplicateName",data)},insert:function(data){return post("layout/sampleMap/insert",data)},deleteByIds:function(idList){return post("layout/sampleMap/deleteByIds",idList)},getById:function(id){return get("layout/sampleMap/getById/"+id)},getAllSampleMap:function(data){return post("layout/sampleMap/getAll",data=data||{pageNumber:0,pageSize:5e3})},getByCreateStrategy:function(strategy){return get("layout/sampleMap/getByCreateStrategy/"+strategy)},renameById:function(sampleMapId,name,strategy){return post("layout/sampleMap/renameById",{id:sampleMapId,newName:name,duplicateStrategy:strategy})},sampleMapHasDuplicateName:function(data){return post("layout/sampleMap/hasDuplicateName",data)},openMapById:function(id){return get("layout/sampleMap/openMapById/"+id)},sampleMapMoveTo:function(folderIds,toFolderId){return post("layout/sampleMap/move",{ids:folderIds,toFolderId:toFolderId})},addTagsToCache:function(tags){return post("layout/tag/addTagsToCache",tags)},getDomainTagNames:function(){return get("layout/tag/getDomainTagNames")},deleteLayoutTagsInCache:function(tags){return post("layout/tag/deleteLayoutTagsInCache",tags)},getTagFromCacheByName:function(tagName){return get("layout/tag/getTagFromCacheByName/"+tagName)},deleteLayoutTagsInDevs:function(tagNames,devIds){return post("layout/tag/deleteLayoutTagsInDevs",{tagNames:tagNames,devIds:devIds})},updateLayoutTagForDevs:function(data){return post("layout/tag/updateLayoutTagForDevs",data)},saveLayoutTagsToDevs:function(data){return post("layout/tag/saveLayoutTagsToDevs",data)},importLayoutTagForDevs:function(data){return post("layout/tag/importLayoutTagForDevs",data)},getDeviceTagByGuids:function(ids){return post("layout/tag/getDeviceTagByGuids",ids)},GetNodesTags:function(devIds,nodes){return post("layout/tag/GetNodesTags",{devIds:devIds,nodes:nodes})},getLayoutTagsByDeviceNames:function(data){return post("layout/tag/getLayoutTagsByDeviceNames",data)},getAllDeviceTagsByPaging:function(pageNumber,pageSize,sortField,sortOrder,filterContent){return post("layout/tag/getAllDeviceTagsByPaging",{pageSize:pageSize&&pageSize>0?pageSize:1e3,pageNumber:pageNumber&&pageNumber>=0?pageNumber:0,sortField:sortField,sortOrder:sortOrder,filterContent:filterContent})},getAllDevicesTagsByDeviceGroupIds:function(dgIds,pageNumber,pageSize){return post("layout/tag/getAllDevicesTagsByDeviceGroupIds",{dgIds:dgIds,pageNumber:pageNumber,pageSize:pageSize})},getRootFolderList:function(){return get("layout/folder/getRootFolderList")},renameFolder:function(folderId,newName){return post("layout/folder/rename",{id:folderId,newName:newName})},deleteFolderByIds:function(folderIdList){return post("layout/folder/deleteFolderByIds",folderIdList)},addSubFolder:function(layout){return post("layout/folder/addSubFloder",layout)},getSubFoldersAndLayoutsByParentId:function(parentId,folderType){return post("layout/folder/getSubFoldersAndLayoutsByParentId",{parentId:parentId,folderType:folderType})},getAllSubFoldersAndLayoutsByParentId:function(){return post("layout/folder/getAllSubFoldersAndLayoutsByParentId",{parentInfoVms:[{parentId:"aaaaaaaa-6b69-417d-ad03-2cc447100166",folderType:1},{parentId:"bbbbbbbb-6b69-417d-ad03-2cc447100166",folderType:2}]})},folderMoveTo:function(folderIds,toFolderId){return post("layout/folder/moveTo",{ids:folderIds,toFolderId:toFolderId})},folderHasDuplicateName:function(data){return post("layout/folder/hasDuplicateName",data)},addAssocations:function(data){return post("layout/mapAssociation/addAssocations",data)},deleteRelationBySystemMapIds:function(data){return post("layout/mapAssociation/deleteRelationBySystemMapIds",data||["94df6806-2a37-422e-9a32-e1ab713a2427"])},deleteRelationByLayoutStyleIds:function(data){return post("layout/mapAssociation/deleteRelationByLayoutStyleIds",data||["cd63c9cf-e3d5-497d-9366-bcaf3a6c3eaa"])},deleteRelationByIds:function(data){return post("layout/mapAssociation/deleteByIds",data||["f9c9191f-15a8-40a0-a4ff-8ebd5f415f3a"])},updateRelationBySystemMapIds:function(data){return post("layout/mapAssociation/updateRelationBySystemMapIds",data||{mapIds:["1"],layoutStyleBriefInfo:{id:"update",layOutStyleType:7}})},getAllRelation:function(data){return post("layout/mapAssociation/getAllRelation",data||[3])},exportTemplate:function(data){return function(url,requestData,csvFileName){var _deferred=$q.defer();url=NetBrain.NG.ConfigSettings.API_ROOT+url;var dataSrc=httpAuthSrvc.getDataSrc();$http({url:url,method:"POST",responseType:"arraybuffer",data:requestData,headers:{TenantGuid:dataSrc.TenantGuid,DomainGuid:dataSrc.DomainGuid,"Content-type":"application/json",Accept:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}}).success((function(data,status,headers,config){if(200===status){var blob=new Blob([data],{type:"text/csv;"});saveAs(blob,csvFileName);_deferred.resolve("OK")}})).error((function(data,status,headers,config){_deferred.reject("there is an error",data,status,headers,config)}));return _deferred.promise}("layout/mapAssociation/exportTemplate",(data||{fileName:"template"}).fileName+".csv")}}}}(NetBrain);!function(netBrain){angular.module("nb.qmap").factory("nb.qmap.netMapCmdTarget",srvcFun);srvcFun.$inject=["$q","$timeout","$uibModal","$rootScope","nb.qmap.updateMapSrvc","nb.qmap.randomColorSrvc","nb.dataview.applyDataViewSrvc","nb.qmap.autoLinkOptionSrvc","nb.topo.httpExternNbrSrvc"];function srvcFun($q,$uibModal,$modal,$rootScope,updateMapSrvc,randomColorSrvc,applyDataViewSrvc,autoLinkOptionSrvc,httpExternNbrSrvc){function CNetMapCmdTarget(netmapOperator,scope){this._netmapOperator=netmapOperator;this._scope=scope;var netmap=this._netmapOperator.getNetMap();null!=netmap&&netmap.setCmdTarget(this);this.graphicStyle=null;this.computePathManager=new netBrain.Map.ComputePathManager(netmap,this._netmapOperator);this.currentDrawTool=null;this.drawTools=[{name:"DrawRectangle",tool:function(){return new netBrain.Map.DrawRectangleTool}},{name:"DrawEllipse",tool:function(){return new netBrain.Map.DrawEllipseTool}},{name:"DrawCloud",tool:function(){return new netBrain.Map.DrawCloseCloudTool}},{name:"DrawLine",tool:function(){return new netBrain.Map.DrawLineTool}},{name:"DrawArrow",tool:function(){return new netBrain.Map.DrawArrowLineTool}},{name:"DrawPolygenArea",tool:function(){return new netBrain.Map.DrawPolygonTool}},{name:"DrawPolyLine",tool:function(){return new netBrain.Map.DrawPolygonLineTool}},{name:"DrawCloseArea",tool:function(){return new netBrain.Map.DrawCloseAreaTool}},{name:"DrawCallOut",tool:function(){return new netBrain.Map.DrawCallOutTool}},{name:"DrawCurve",tool:function(){return new netBrain.Map.DrawCurveTool}},{name:"DrawText",tool:function(){return new netBrain.Map.DrawTextTool}},{name:"DrawTextbox",tool:function(){return new netBrain.Map.DrawTextboxTool}},{name:"DrawPath",tool:function(){return new netBrain.Map.DrawSelectPath}},{name:"DrawTable",tool:null,state:!1}]}CNetMapCmdTarget.prototype={constructor:CNetMapCmdTarget,getCurNetmap:function(){return this._netmapOperator.getNetMap()},setGraphicStyle:function(graphicStyle){this.graphicStyle=graphicStyle},getGraphicStyle:function(){return this.graphicStyle},onClearDataView:function(){this._netmapOperator.clearDataView()},selectAllLinkByTopoType:function(topoTypeID){if(null!=this._netmapOperator){return this._netmapOperator.selectAllLinkByTopoType(topoTypeID)}},unlinkAllByTopoType:function(topoTypeID){if(null!=this._netmapOperator){return this._netmapOperator.unlinkAllByTopoType(topoTypeID)}},onAutoLink:function(httpExternNbrSrvc,topoTypeId,nbAlertSrvc,dataViewCacheSrvc,_applyDataViewSrvc){if(null!=this._netmapOperator){if(null!=this._netmapOperator.getNetMap()&&this._netmapOperator.getNetMap().isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.autoLink(httpExternNbrSrvc,topoTypeId,nbAlertSrvc,dataViewCacheSrvc,_applyDataViewSrvc)}))}try{return this._netmapOperator.autoLink(httpExternNbrSrvc,topoTypeId,nbAlertSrvc,_applyDataViewSrvc)}catch(ex){console.error("onAutoLink get error: "+ex.toString());return}}},onAutoLinkBetweenDevices:function(httpExternNbrSrvc,lsCompDev,topoTypeId,nbAlertSrvc){if(null!=this._netmapOperator){if(null!=this._netmapOperator.getNetMap()&&this._netmapOperator.getNetMap().isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.autoLinkBetweenDevices(httpExternNbrSrvc,lsCompDev,topoTypeId,nbAlertSrvc)}))}try{return this._netmapOperator.autoLinkBetweenDevices(httpExternNbrSrvc,lsCompDev,topoTypeId,nbAlertSrvc)}catch(ex){console.error("onAutoLink get error: "+ex.toString());return}}},onAutoLinkForFloatMeau:function(httpExternNbrSrvc,mediaId,topoTypeId,nbAlertSrvc,_applyDataViewSrvc){if(null!=this._netmapOperator){if(null!=this._netmapOperator.getNetMap()&&this._netmapOperator.getNetMap().isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.flaotMeauAutoLink(httpExternNbrSrvc,mediaId,topoTypeId,nbAlertSrvc,_applyDataViewSrvc)}))}try{return this._netmapOperator.flaotMeauAutoLink(httpExternNbrSrvc,mediaId,topoTypeId,nbAlertSrvc,_applyDataViewSrvc)}catch(ex){console.error("flaotMeauAutoLink get error: "+ex.toString());return}}},onSwitchDataView:function(dataViewCacheSrvc,dvObj,bAutoLink){if(null!=this._netmapOperator&&null!=dvObj)try{this._netmapOperator.switchDataView(dataViewCacheSrvc,dvObj,bAutoLink)}catch(ex){console.error("onSwitchDataView get error: "+ex.toString())}},onTreeLayout:function(){var netmap=this._netmapOperator.getNetMap();if(null!=netmap&&netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.treeLayout()}))}try{this._netmapOperator.treeLayout()}catch(ex){console.warn("onTreeLayout get error: "+ex.toString())}},onTreeLayoutNew:function(direction){var netmap=this._netmapOperator.getNetMap();if(null!=netmap&&netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.treeLayoutNew(direction)}))}try{this._netmapOperator.treeLayoutNew(direction)}catch(ex){console.warn("onTreeLayoutNew get error: "+ex.toString())}},onForceDirected:function(){var netmap=this._netmapOperator.getNetMap();if(null!=netmap&&netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.forceDirectedLayout()}))}try{this._netmapOperator.forceDirectedLayout()}catch(ex){console.warn("onForceDirected get error: "+ex.toString())}},onForceDirectedNew:function(){var netmap=this._netmapOperator.getNetMap();if(null!=netmap&&netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.forceDirectedLayoutNew()}))}try{this._netmapOperator.forceDirectedLayoutNew()}catch(ex){console.warn("onForceDirected get error: "+ex.toString())}},onCircularLayout:function(){var netmap=this._netmapOperator.getNetMap();if(null!=netmap&&netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.circularLayout()}))}try{this._netmapOperator.circularLayout()}catch(ex){console.warn("onCircularLayout get error: "+ex.toString())}},onGridLayout:function(){var netmap=this._netmapOperator.getNetMap();if(null!=netmap&&netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.gridLayout()}))}try{this._netmapOperator.gridLayout()}catch(ex){console.warn("onCircularLayout get error: "+ex.toString())}},onLayeredDigraphLayout:function(){var netmap=this._netmapOperator.getNetMap();if(null!=netmap&&netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that._netmapOperator.layeredDigraphLayout()}))}try{this._netmapOperator.layeredDigraphLayout()}catch(ex){console.warn("onCircularLayout get error: "+ex.toString())}},sendBeginPath:function(data){console.warn(data)},sendEndPath:function(data){console.warn(data)},onTestPath:function(httpPathSrvc,dataViewCacheSrvc){var promise=httpPathSrvc.getPathHopsByGuid(null,"f4740013-7d6b-25ff-3013-e49e7d1def5b");promise.context=this;promise.then((function(hopList){null!=hopList&&hopList.length>0&&promise.context.sendHopListChange(dataViewCacheSrvc,hopList,promise.context)}))},showAllPortChannels:function(actionObj){var netmapOperator=this._netmapOperator;null!=netmapOperator&&netmapOperator.showAllPortChannels(actionObj)},showAllPhysicalPorts:function(actionObj){var netmapOperator=this._netmapOperator;null!=netmapOperator&&netmapOperator.showAllPhysicalPorts(actionObj)},showPortChannel:function(actionObj){var netmapOperator=this._netmapOperator;null!=netmapOperator&&netmapOperator.showPortChannel(actionObj)},showPhysicalPorts:function(actionObj){var netmapOperator=this._netmapOperator;null!=netmapOperator&&netmapOperator.showPhysicalPorts(actionObj)},displayL2MapStyle:function(){var netmapOperator=this._netmapOperator;null!=netmapOperator&&netmapOperator.displayL2MapStyle()},displayL3MapStyle:function(){var netmapOperator=this._netmapOperator;null!=netmapOperator&&netmapOperator.displayL3MapStyle()},beginMapPathTransaction:function(option){this.computePathManager.beginMapPathTransaction(option)},sendHopListChange:function(dataViewCacheSrvc,data){var hopList=data;"string"==typeof data&&(hopList=JSON.parse(data));return this.computePathManager.receiveHopListNew(dataViewCacheSrvc,hopList,randomColorSrvc,applyDataViewSrvc,autoLinkOptionSrvc,httpExternNbrSrvc)},endMapPathTransaction:function(option){return this.computePathManager.endMapPathTransaction(option)},onTestTracePath:function(dataViewCacheSrvc){this.onDrawTrace(dataViewCacheSrvc,'{"pathId":"926bf49e-4786-c445-ac21-b495455887ab","orientation":0,"source":"10.10.10.16","dest":"172.24.32.6","hoplist":[{"hops":[{"hopId":"e64b4258-d1f3-b607-325f-48cc5e48b3a8","fromDev":{"ID":"7c5afa7e-4afe-4e59-8af6-aace2eca8b40","devName":"GW2Lab","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"f0/0.1 10.10.10.16/19","schema":"ipIntfs.name"},"intfKeyObj":{"value":"c937bac4-19a7-4e6b-8dc4-581e6f170471","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"b97bb348-b4e5-442e-ab5d-20364a01e8ee","mediaName":"10.10.0.0/19","mediaType":"Lan","neat":true},"mediaId":"b97bb348-b4e5-442e-ab5d-20364a01e8ee","isP2P":false,"toDev":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"a8fb18e4-b578-f79d-acee-0520a6eafa27","fromDev":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"e0/1 172.24.30.2/24","schema":"ipIntfs.name"},"intfKeyObj":{"value":"0ee8e4b9-093d-47c9-bf36-d7625cd1fa06","schema":"ipIntfs._id"}},"mediaInfo":{},"isP2P":true,"toDev":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"c81f60c8-a369-43c8-16d3-c8d4e5725f0d","fromDev":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"s1 172.24.31.2/26","schema":"ipIntfs.name"},"intfKeyObj":{"value":"f2fc5d96-1821-4fce-9816-17bda0fec4e7","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"0d50c867-8929-479c-94e4-3c6d59ba27e0","mediaName":"172.24.31.0/26","mediaType":"Lan","neat":true},"mediaId":"0d50c867-8929-479c-94e4-3c6d59ba27e0","isP2P":false,"toDev":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"942b48e9-9855-23c0-7882-97c8544488dd","fromDev":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"s1 172.24.32.2/30","schema":"ipIntfs.name"},"intfKeyObj":{"value":"c5481d4f-f152-438a-a942-f51194c36a4d","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"02904f1f-e886-4eb0-a642-2b14b770157b","mediaName":"172.24.32.0/30","mediaType":"Lan","neat":true},"mediaId":"02904f1f-e886-4eb0-a642-2b14b770157b","isP2P":false,"toDev":{"ID":"c7193d51-3280-446a-b04c-4372f1bca883","devName":"LA_POP","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"c7193d51-3280-446a-b04c-4372f1bca883","devName":"LA_POP","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology}]},{"hops":[{"hopId":"e64b4258-d1f3-b607-325f-48cc5e48b3a8","fromDev":{"ID":"7c5afa7e-4afe-4e59-8af6-aace2eca8b40","devName":"GW2Lab","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"f0/0.1 10.10.10.16/19","schema":"ipIntfs.name"},"intfKeyObj":{"value":"c937bac4-19a7-4e6b-8dc4-581e6f170471","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"b97bb348-b4e5-442e-ab5d-20364a01e8ee","mediaName":"10.10.0.0/19","mediaType":"Lan","neat":true},"mediaId":"b97bb348-b4e5-442e-ab5d-20364a01e8ee","isP2P":false,"toDev":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"a8fb18e4-b578-f79d-acee-0520a6eafa27","fromDev":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"e0/1 172.24.30.2/24","schema":"ipIntfs.name"},"intfKeyObj":{"value":"0ee8e4b9-093d-47c9-bf36-d7625cd1fa06","schema":"ipIntfs._id"}},"mediaInfo":{},"isP2P":true,"toDev":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"c81f60c8-a369-43c8-16d3-c8d4e5725f0d","fromDev":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"s1 172.24.31.2/26","schema":"ipIntfs.name"},"intfKeyObj":{"value":"f2fc5d96-1821-4fce-9816-17bda0fec4e7","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"0d50c867-8929-479c-94e4-3c6d59ba27e0","mediaName":"172.24.31.0/26","mediaType":"Lan","neat":true},"mediaId":"0d50c867-8929-479c-94e4-3c6d59ba27e0","isP2P":false,"toDev":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"942b48e9-9855-23c0-7882-97c8544488dd","fromDev":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"s1 172.24.32.2/30","schema":"ipIntfs.name"},"intfKeyObj":{"value":"c5481d4f-f152-438a-a942-f51194c36a4d","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"02904f1f-e886-4eb0-a642-2b14b770157b","mediaName":"172.24.32.0/30","mediaType":"Lan","neat":true},"mediaId":"02904f1f-e886-4eb0-a642-2b14b770157b","isP2P":false,"toDev":{"ID":"c7193d51-3280-446a-b04c-4372f1bca883","devName":"LA_POP","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"c7193d51-3280-446a-b04c-4372f1bca883","devName":"LA_POP","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology}]},{"hops":[{"hopId":"e64b4258-d1f3-b607-325f-48cc5e48b3a8","fromDev":{"ID":"7c5afa7e-4afe-4e59-8af6-aace2eca8b40","devName":"GW2Lab","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"f0/0.1 10.10.10.16/19","schema":"ipIntfs.name"},"intfKeyObj":{"value":"c937bac4-19a7-4e6b-8dc4-581e6f170471","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"b97bb348-b4e5-442e-ab5d-20364a01e8ee","mediaName":"10.10.0.0/19","mediaType":"Lan","neat":true},"mediaId":"b97bb348-b4e5-442e-ab5d-20364a01e8ee","isP2P":false,"toDev":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"a8fb18e4-b578-f79d-acee-0520a6eafa27","fromDev":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"e0/1 172.24.30.2/24","schema":"ipIntfs.name"},"intfKeyObj":{"value":"0ee8e4b9-093d-47c9-bf36-d7625cd1fa06","schema":"ipIntfs._id"}},"mediaInfo":{},"isP2P":true,"toDev":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"c81f60c8-a369-43c8-16d3-c8d4e5725f0d","fromDev":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"s1 172.24.31.2/26","schema":"ipIntfs.name"},"intfKeyObj":{"value":"f2fc5d96-1821-4fce-9816-17bda0fec4e7","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"0d50c867-8929-479c-94e4-3c6d59ba27e0","mediaName":"172.24.31.0/26","mediaType":"Lan","neat":true},"mediaId":"0d50c867-8929-479c-94e4-3c6d59ba27e0","isP2P":false,"toDev":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"942b48e9-9855-23c0-7882-97c8544488dd","fromDev":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"s1 172.24.32.2/30","schema":"ipIntfs.name"},"intfKeyObj":{"value":"c5481d4f-f152-438a-a942-f51194c36a4d","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"02904f1f-e886-4eb0-a642-2b14b770157b","mediaName":"172.24.32.0/30","mediaType":"Lan","neat":true},"mediaId":"02904f1f-e886-4eb0-a642-2b14b770157b","isP2P":false,"toDev":{"ID":"c7193d51-3280-446a-b04c-4372f1bca883","devName":"LA_POP","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"c7193d51-3280-446a-b04c-4372f1bca883","devName":"LA_POP","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology}]},{"hops":[{"hopId":"e64b4258-d1f3-b607-325f-48cc5e48b3a8","fromDev":{"ID":"7c5afa7e-4afe-4e59-8af6-aace2eca8b40","devName":"GW2Lab","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"f0/0.1 10.10.10.16/19","schema":"ipIntfs.name"},"intfKeyObj":{"value":"c937bac4-19a7-4e6b-8dc4-581e6f170471","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"b97bb348-b4e5-442e-ab5d-20364a01e8ee","mediaName":"10.10.0.0/19","mediaType":"Lan","neat":true},"mediaId":"b97bb348-b4e5-442e-ab5d-20364a01e8ee","isP2P":false,"toDev":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"a8fb18e4-b578-f79d-acee-0520a6eafa27","fromDev":{"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"e0/1 172.24.30.2/24","schema":"ipIntfs.name"},"intfKeyObj":{"value":"0ee8e4b9-093d-47c9-bf36-d7625cd1fa06","schema":"ipIntfs._id"}},"mediaInfo":{},"isP2P":true,"toDev":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"c81f60c8-a369-43c8-16d3-c8d4e5725f0d","fromDev":{"ID":"9c32c974-f5da-48d7-a4e1-007252c4198a","devName":"NY_Core","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"s1 172.24.31.2/26","schema":"ipIntfs.name"},"intfKeyObj":{"value":"f2fc5d96-1821-4fce-9816-17bda0fec4e7","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"0d50c867-8929-479c-94e4-3c6d59ba27e0","mediaName":"172.24.31.0/26","mediaType":"Lan","neat":true},"mediaId":"0d50c867-8929-479c-94e4-3c6d59ba27e0","isP2P":false,"toDev":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology},{"hopId":"942b48e9-9855-23c0-7882-97c8544488dd","fromDev":{"ID":"8bb6cd75-94cb-4220-8542-480c028435fe","devName":"BST,POP1","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"fromIntf":{"intfDisplaySchemaObj":{"value":"s1 172.24.32.2/30","schema":"ipIntfs.name"},"intfKeyObj":{"value":"c5481d4f-f152-438a-a942-f51194c36a4d","schema":"ipIntfs._id"}},"mediaInfo":{"mediaId":"02904f1f-e886-4eb0-a642-2b14b770157b","mediaName":"172.24.32.0/30","mediaType":"Lan","neat":true},"mediaId":"02904f1f-e886-4eb0-a642-2b14b770157b","isP2P":false,"toDev":{"ID":"c7193d51-3280-446a-b04c-4372f1bca883","devName":"LA_POP","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toIntf":{"ID":"c7193d51-3280-446a-b04c-4372f1bca883","devName":"LA_POP","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"topoType":NetBrain.Map.Const.TopoLinkType.IPv4L3Topology}]}],"fromDev":{"ID":"7c5afa7e-4afe-4e59-8af6-aace2eca8b40","devName":"GW2Lab","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"},"toDev":{"ID":"c7193d51-3280-446a-b04c-4372f1bca883","devName":"LA_POP","devType":2,"domainId":"3bee7a7c-6486-4a50-9181-7c00d7ba61a8"}}')},onDrawTrace:function(dataViewCacheSrvc,data,autoLinkOptionSrvc,httpExternNbrSrvc){var hopList=data;"string"==typeof data&&(hopList=JSON.parse(data));this.computePathManager.receiveTraceHopListNew(dataViewCacheSrvc,hopList,randomColorSrvc,applyDataViewSrvc,autoLinkOptionSrvc,httpExternNbrSrvc)},getDrawingTool:function(strDrawName){var netmapOperator=this._netmapOperator;var callBack=function(from,to){netmapOperator.addNormalLink(from,to)};for(var index=0;index<this.drawTools.length;index++){var tool;strDrawName===this.drawTools[index].name&&(tool=this.drawTools[index].tool());if(null!=tool){"DrawLine"===strDrawName&&null!=netmapOperator&&(tool.addLinkCallBack=callBack);return tool}}return null},OnDrawTool:function(strDrawToolName,unRegCallBack){var netmap=this._netmapOperator.getNetMap();if(null!=netmap){null!=this.currentDrawTool&&(this.currentDrawTool.drawToolName===strDrawToolName?this.currentDrawTool.UnRegister(netmap._diagram,!1):this.currentDrawTool.UnRegister(netmap._diagram));var drawTool=this.getDrawingTool(strDrawToolName);if(null!=drawTool){drawTool.drawToolName=strDrawToolName;this.currentDrawTool=drawTool;drawTool.setUnRegisterCallBack(unRegCallBack);null!=drawTool.setGraphicStyle&&drawTool.setGraphicStyle(this.graphicStyle);drawTool instanceof netBrain.Map.DrawShapeToolBase&&drawTool.Register(netmap._diagram)}}},OnDrawTable:function(){var netmap=this.getCurNetmap();if(null!=netmap)if(null!=netmap&&netmap.isReadOnly())console.warn("The map is readonly!");else{var tableObject=new netBrain.Map.CompTable;var tableView=new CTableDefineView(tableObject);tableView.okCallBack=function(){this.constructTableFromViewData();netmap._diagram.model.addNodeData(this.getTableData().getNodeDataJsonObj())};tableView.openTableDlg()}},OnDrawCallout:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawCallOut",unRegCallBack)}))}try{this.OnDrawTool("DrawCallOut",unRegCallBack)}catch(ex){console.warn("OnDrawCallout get error: "+ex.toString())}}},OnDrawCloseArea:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawCloseArea",unRegCallBack)}))}try{this.OnDrawTool("DrawCloseArea",unRegCallBack)}catch(ex){console.warn("OnDrawCloseArea get error: "+ex.toString())}}},OnDrawArrow:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawArrow",unRegCallBack)}))}try{this.OnDrawTool("DrawArrow",unRegCallBack)}catch(ex){console.warn("OnDrawArrow get error: "+ex.toString())}}},OnDrawCurve:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawCurve",unRegCallBack)}))}try{this.OnDrawTool("DrawCurve",unRegCallBack)}catch(ex){console.warn("OnDrawCurve get error: "+ex.toString())}}},OnDrawPath:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawPath",unRegCallBack)}))}try{this.OnDrawTool("DrawPath",unRegCallBack)}catch(ex){console.warn("OnDrawPath get error: "+ex.toString())}}},OnDrawCloud:function(unRegCallBack){var netmap=this._netmapOperator.getNetMap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawCloud",unRegCallBack)}))}try{this.OnDrawTool("DrawCloud",unRegCallBack)}catch(ex){console.warn("OnDrawCloud get error: "+ex.toString())}}},OnDrawRectangle:function(unRegCallBack){var netmap=this._netmapOperator.getNetMap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawRectangle",unRegCallBack)}))}try{this.OnDrawTool("DrawRectangle",unRegCallBack)}catch(ex){console.warn("OnDrawRectangle get error: "+ex.toString())}}},OnDrawLine:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawLine",unRegCallBack)}))}try{this.OnDrawTool("DrawLine",unRegCallBack)}catch(ex){console.warn("OnDrawTool get error: "+ex.toString())}}},OnDrawEllipse:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawEllipse",unRegCallBack)}))}try{this.OnDrawTool("DrawEllipse",unRegCallBack)}catch(ex){console.warn("DrawEllipse get error: "+ex.toString())}}},OnDrawPolygon:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawPolygenArea",unRegCallBack)}))}try{this.OnDrawTool("DrawPolygenArea",unRegCallBack)}catch(ex){console.warn("OnDrawPolygon get error: "+ex.toString())}}},OnDrawText:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawText",unRegCallBack)}))}try{this.OnDrawTool("DrawText",unRegCallBack)}catch(ex){console.warn("OnDrawText get error: "+ex.toString())}}},OnDrawTextbox:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawTextbox",unRegCallBack)}))}try{this.OnDrawTool("DrawTextbox",unRegCallBack)}catch(ex){console.warn("OnDrawTextbox get error: "+ex.toString())}}},OnDrawPolygonLine:function(unRegCallBack){var netmap=this.getCurNetmap();if(null!=netmap){if(netmap.isReadOnly()){var that=this;updateMapSrvc.canUpdateCurrentMap().then((function(){return that.OnDrawTool("DrawPolyLine",unRegCallBack)}))}try{this.OnDrawTool("DrawPolyLine",unRegCallBack)}catch(ex){console.warn("OnDrawPolygonLine get error: "+ex.toString())}}},OnLockOrUnlockMap:function(){var netmap=this.getCurNetmap();if(null!=netmap){var bIsReadOnly=netmap.isReadOnly();netmap.setReadOnly(!bIsReadOnly)}},onAlignLeft:function(){null!=this._netmapOperator&&this._netmapOperator.alignLeft()},onAlignRight:function(){null!=this._netmapOperator&&this._netmapOperator.alignRight()},onAlignTop:function(){null!=this._netmapOperator&&this._netmapOperator.alignTop()},onAlignBottom:function(){null!=this._netmapOperator&&this._netmapOperator.alignBottom()},onAlignCenterX:function(){null!=this._netmapOperator&&this._netmapOperator.alignCenterX()},onAlignCenterY:function(){null!=this._netmapOperator&&this._netmapOperator.alignCenterY()},mergeToOneNote:function(selectedNotes){null!=this._netmapOperator&&this._netmapOperator.mergeToOneNote(selectedNotes)}};return{init:function(netmapOperator,scope){var cNetMapCmdTarget=new CNetMapCmdTarget(netmapOperator,scope);$rootScope.$on("changeViewOption",(function(event,option){var netmap=cNetMapCmdTarget.getCurNetmap();if(option.mapPage.getDocId()===netmap.getDocId()){scope.diagram.commandHandler.setCusZoomSetp(option.step);netmap.setMapViewOptionJson(option.mapViewOption);scope.netmap.refreshMapViewOptionVisible()}}));return cNetMapCmdTarget}}}}(NetBrain);!function(){angular.module("nb.qmap").factory("nb.qmap.updateMapSrvc",updateMapSrvc);updateMapSrvc.$inject=["$q","$timeout","$log","nb.qmap.mapManagerSrvc","$rootScope","nb.common.nbAlertSrvc","nb.uiframework.mainUISrvc"];function updateMapSrvc($q,$timeout,$log,mapManagerSrvc,$rootScope,nbAlertSrvc,mainUISrvc){var ums={};ums.canUpdateCurrentMap=function(){var derferred=$q.defer();if(mainUISrvc.isDashboard())return $q.resolve();var map=mapManagerSrvc.getActiveMap();if(!map){return $q.reject("Can't find map!")}map.isLock()?nbAlertSrvc.confirm("The current map has been locked. Do you want to unlock it and continue?").then((function(){map.setLock(!1);map.getDocId()===mapManagerSrvc.getActiveMap().getDocId()&&$rootScope.$emit("mapLockStatusChanged");return derferred.resolve()}),(function(reason){return derferred.reject(reason)})):$timeout((function(){return derferred.resolve()}));return derferred.promise};return ums}}(NetBrain);!function(){angular.module("nb.qmap").factory("nb.qmap.autoLinkOptionSrvc",autoLinkOptionSrvc);autoLinkOptionSrvc.$inject=["$q","$uibModal","$rootScope","$timeout","$log","nb.qmap.mapManagerSrvc","nb.ng.utilitySrvc","nb.qmap.updateMapSrvc","nb.netbrain.httpMapViewOptionSrvc","nb.topo.httpExternNbrSrvc"];function autoLinkOptionSrvc($q,$uibModal,$rootScope,$timeout,$log,mapManagerSrvc,utilitySrvc,updateMapSrvc,httpMapViewOptionSrvc,httpExternNbrSrvc){var vm={};vm.isShowAutolinkTip=!1;vm.getTopoTypesList=function(lsCurrTopoTypes_optionalArg){var topoTypesList=[];NetBrain.AllTopoLinkType.forEach((function(item){if(!(lsCurrTopoTypes_optionalArg&&lsCurrTopoTypes_optionalArg.indexOf(item.ID)<0)){var object={id:item.ID,name:item.name,checked:!1};switch(item.ID){case NetBrain.Map.Const.TopoLinkType.L2Topology:object.image="icon_nb_run_qapp";object.name="L2 Topology";break;case NetBrain.Map.Const.TopoLinkType.IPv4L3Topology:object.image="icon_nb_run_qapp";object.name="IPv4 L3 Topology";break;case NetBrain.Map.Const.TopoLinkType.IPv6L3Topology:object.image="icon_nb_run_qapp";object.name="IPv6 L3 Topology"}topoTypesList.push(object)}}));return topoTypesList};vm.getCurPageTopoTypesList=function(CurTopoTypeListObject){var info=mapManagerSrvc.getActivePage().getVisualSpaceInfo();var vsId=info&&info.visualSpaceInstanceId&&info.visualSpaceInstanceId.length>0?info.visualSpaceInstanceId:VisualSpaceConstant.defaultVisualSpaceInstanceId;for(var index=0;index<CurTopoTypeListObject.allTopoTypeLinkList.length;index++)CurTopoTypeListObject.allTopoTypeLinkList[index].checked=!1;var curAutoTopoTypesList=NetBrain.CurAutolinkType[vsId];if(null==curAutoTopoTypesList){CurTopoTypeListObject.bVsInfoIsNull=!0;return CurTopoTypeListObject.allTopoTypeLinkList}for(index=0;index<CurTopoTypeListObject.allTopoTypeLinkList.length;index++){if(-1==curAutoTopoTypesList.indexOf(CurTopoTypeListObject.allTopoTypeLinkList[index].id)){CurTopoTypeListObject.allTopoTypeLinkList.splice(index,1);index--}}return CurTopoTypeListObject.allTopoTypeLinkList};vm.getVisualSpaceTemplatesList=function(){var visualSpaceTemplatesList=[];NetBrain.AllVisualSpaceTemplate.forEach((function(item){var object={id:item._id,name:item.name,checked:!1};visualSpaceTemplatesList.push(object)}));return visualSpaceTemplatesList};vm.setAsDefault=function(vsId,topoLinkGuids){var deffered=$q.defer();httpMapViewOptionSrvc.setMapAutoLinkTopotypeIds(vsId,topoLinkGuids).then((function(data){deffered.resolve(data)}),(function(){deffered.reject("set mapAutoLinkTopoType failed!")}));return deffered.promise};vm.setAsDefaultIsExcluedeMip=function(vsId,isExcluedeMip){var deffered=$q.defer();httpMapViewOptionSrvc.setMapAutoLinkOptionExcluedeMip(vsId,isExcluedeMip).then((function(data){deffered.resolve(isExcluedeMip)}),(function(){deffered.reject("set setAsDefaultIsExcluedeMip failed!")}));return deffered.promise};vm.autolinkOption=function(){var deffered=$q.defer();var activePage=mapManagerSrvc.getActivePage();var vspaceId=null;if(activePage=mapManagerSrvc.getActivePage()){var info=activePage.getVisualSpaceInfo();info&&(vspaceId=info.visualSpaceInstanceId)}var array=activePage.getMapAutoLinkOptionList(vspaceId);array?deffered.resolve(array):httpExternNbrSrvc.getAutoLinkTypeByVisualSpaceId(vspaceId).then((function(result){array=!result||!result.topoLinkList||result.topoLinkList.indexOf(NetBrain.Map.Const.TopoLinkType.IPv4L3Topology)>=0?[NetBrain.Map.Const.TopoLinkType.IPv4L3Topology]:result.topoLinkList;deffered.resolve(array)}),(function(reason){array=[NetBrain.Map.Const.TopoLinkType.IPv4L3Topology];deffered.resolve(array)}));return deffered.promise};return vm}}(NetBrain);!function(root,factory){"function"==typeof define&&define.amd?define("MapTip",["jquery"],factory):root.MapTip=factory(root.$||root.JQuery)}(window,(function($){function MapTip(options){this.options=$.extend(!0,{},{mask:!1,type:"",message:"",delay:2e3,posStyle:{}},options);var wrapperSelector=options&&options.wrapper||"#map-main-container .mapview-body-pos .mapMainFrameContent";this.wrapper=$(wrapperSelector);this.timer=null}var fn=MapTip.prototype;fn.show=function(options){this.options=$.extend({},this.options,options);this.tip=$('<div class="map-tip"/>').css({display:"none"}).css(this.options.posStyle).addClass(this.options.type).html(Utility.htmlEncodeByRegExp(this.options.message));if(0===this.wrapper.length){this.wrapper=$("body");this.tip.css({top:"120px"})}this.wrapper.prepend(this.tip);var screenWidth=$(document).width();var tipWidth=this.tip.width();if(!this.options.isCustomPosition){var left=(screenWidth-tipWidth)/2;this.tip.css({left:left+"px",display:"block"})}this.tip.css({display:"block"});this.options.delay&&(this.timer=setTimeout(function(){this.tip.fadeTo(3e3,0,function(){this.destroy()}.bind(this))}.bind(this),this.options.delay))};fn.destroy=function(){this.tip&&this.tip.remove();this.options.mask&&this.topMasking&&this.topMasking.remove();if(this.timer){clearTimeout(this.timer);this.timer=null}return null};return MapTip}));!function(netBrain){angular.module("nb.qmap").factory("nb.qmap.mapManagerSrvc",mapManagerSrvc);mapManagerSrvc.$inject=["$rootScope","nb.ng.nbHttp","$q","$log","$uibModal","$location","nb.networkos.myFilesSrvc","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.uiframework.urlStateMgr","nb.ng.httpAuthSrvc","nb.ng.utilitySrvc","nb.ng.sessionSrvc","nb.uiframework.mainUISrvc","nb.networkos.fileSrvc","nb.runbook.httpRunBookSrvc","nb.common.nbTipSrvc","nb.datamodel.httpSiteSrvc","nb.miniTask.targetDeviceSrvc","nb.admin.httpChangeAnalysisSettingSrvc","$filter"];function mapManagerSrvc($rootScope,nbHttp,$q,$log,$uibModal,$location,myFilesSrvc,userSrvc,nbAlertSrvc,httpMapSrvc,urlStateMgr,httpAuthSrvc,utilitySrvc,sessionSrvc,mainUISrvc,fileSrvc,runbookMgr,nbTipSrvc,httpSiteSrvc,targetDeviceSrvc,httpChangeAnalysisSettingSrvc,$filter){var _restoreMap=function(map,oldMap){oldMap};var deleteMapToBrowseTree=function(file){var deleteModel={fileId:file.Id,fileType:11};fileSrvc.markDelete(deleteModel)};var addMapToBrowseTree=function addMapToBrowseTree(targetFolder,map,ischeck){if(null!=map){var confirmOption={message:'This folder already contains a map named "'+map.getTitle()+'". Do you want to save the map with an auto-assigned name? '};if(targetFolder){var mapId=map.getDocId();var mapName=map.getTitle();return httpMapSrvc.addMapFileToTree({mapId:mapId,mapName:mapName,parentTreeId:targetFolder.id,isCheck:ischeck}).then((function(data){var deferred=$q.defer();setTimeout((function(){if("hasDuplicateName"===data.result)nbAlertSrvc.confirm(confirmOption).then((function(){if(data.newName){map.setTitle(data.newName);addMapToBrowseTree(targetFolder,map,ischeck).then((function(d){if(d&&"hasDuplicateName"===d.result){$log.error("has duplicateName");deferred.reject("has duplicateName")}else{$rootScope.$emit(docMgrEvent.newDocSave,map);deferred.resolve(d)}}))}}),(function(){deferred.reject("Map with the same name already exists!")}));else{$rootScope.$emit(docMgrEvent.newDocSave,map);deferred.resolve(data)}}),100);return deferred.promise}))}}};var _renameMap=function(newName){netBrain.Map.currentActiveMap.setTitle(newName);if(!mainUISrvc.isDesktop()){var documentTitle=StringUtil.format(netBrain.NetworkOS.Const.UIFramework.DocumentTitleTemplate.Map,{mapName:newName});document.title=documentTitle}var pageSession=sessionSrvc.getPageSession();pageSession.Name=newName;sessionSrvc.setPageSession(pageSession.Identity,pageSession.Name,pageSession.Type,pageSession.Options)};var _saveDocById=function(map,targetFolder,isHiddenSave){var deferred=$q.defer();if(!map.isModify()&&!map.realNew)return $q.reject("doc is not modify");!function(map){_.each(map.getAllPage(),(function(page){page.setIsFirstView(!1)}))}(map);map.doSave();var jsData=map.toJson();httpMapSrvc.updateMapByKey(jsData).then((function(result){if(!0!==result){map.setModify(!0);isHiddenSave||nbAlertSrvc.error(NetBrain.Map.Message.SaveMapFailed);return deferred.reject(NetBrain.Map.Message.SaveMapFailed)}deferred.resolve();map.setRealNew(!1);_renameMap(map.getTitle());targetFolder&&$rootScope.$emit("MyFiles::CreateEmptyFileSuccess",{folder:targetFolder});var options={tipInfo:NetBrain.Map.Message.SaveMapSuccess,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip"};isHiddenSave||nbTipSrvc.open(options)}));return deferred.promise};var _browsePopup=function(excludeFolders,title,doc){var modalInstance=$uibModal.open({templateUrl:"modules/nbQmap/views/browseTree.html",controller:"nb.qmap.browseTreeCtrl",backdrop:"static",windowClass:"tree-dialog",size:"sm",resolve:{settings:function(){return{title:title,includeFolderTypes:includeFolderTypes,excludeFolders:excludeFolders,doc:doc}}}});var includeFolderTypes=[NetBrain.NetworkOS.Const.FolderType.PUBLIC,NetBrain.NetworkOS.Const.FolderType.DESKTOP,NetBrain.NetworkOS.Const.FolderType.PRIVATE];return modalInstance};var _checkMapSaved=function(msg){var deferred=$q.defer();var activeMap=netBrain.Map.currentActiveMap;if(null==activeMap)return $q.reject("active Map is null");if(!activeMap.realNew&&!activeMap.isModify())return $q.resolve();var option={message:msg};nbAlertSrvc.confirm(option).then((function(){_saveDocById(activeMap).then((function(){setTimeout((function(){deferred.resolve()}),500)}),(function(error){deferred.reject(error)}))}),(function(result){deferred.reject(result)}));return deferred.promise};var _transferEditRight=function(deferred,requestOption){httpMapSrvc.transferEditingRight(requestOption).then((function(result){netBrain.Map.currentActiveMap.isTempEditRight=!1;netBrain.Map.currentActiveMap.setEditRight(requestOption.ReceiveUserName,requestOption.ReceiveUserId);$rootScope.$emit("releaseTempEditRight");deferred.resolve(result)}),(function(data){deferred.reject(data.ResultDesc)}))};var _saveMapCheck=function(map,isHiddenSave){var deferred=$q.defer();var editor=map.getEditRight();var editorName=editor.editorName;var editorId=editor.editorId;var currentUserNmae=userSrvc.getUserName();var currentUserId=userSrvc.getUserID();if(isHiddenSave)deferred.resolve();else if(map.getMapType()==netBrain.Map.Const.MapType.visualSpaceOverViewMap)deferred.resolve();else if(editorName!==currentUserNmae&&editorId!==currentUserId){deferred.reject("Do not have permission!");nbAlertSrvc.alert(NetBrain.Map.Message.HaveNoEditRight)}else deferred.resolve();return deferred.promise};var isSiteExist=function(siteId){var deferred=$q.defer();httpSiteSrvc.getSitesByIds([siteId]).then((function(data){data.length>0?deferred.resolve(!0):deferred.resolve(!1)}),(function(reason){deferred.resolve(!0)}));return deferred.promise};function getMapPaneHelper($scope){return $scope&&$scope.mapPaneHelper||$scope.$parent&&getMapPaneHelper($scope.$parent)}return{getMapPaneHelper:getMapPaneHelper,resizablePane:function($element,$scope){var mapPaneHelper=getMapPaneHelper($scope);$element.resizable({handles:"e",maxWidth:mapPaneHelper.maxWidth,minWidth:mapPaneHelper.minWidth})},resizablePaneSharedWidth:function($element,$scope){getMapPaneHelper($scope).resizablePaneSharedWidth($element,$scope)},getMapRBAs:function(){return runbookMgr.getRunbookList(netBrain.Map.currentActiveMap.getDocId())},getActiveMap:function(){return netBrain.Map.currentActiveMap},getActivePage:function(){return netBrain.Map.currentActiveMapPage},removeActiveMap:function(){netBrain.Map.currentActiveMap=null},removeActivePage:function(){netBrain.Map.currentActiveMapPage=null},refreshMap:function(newMap,activePageId){!function(newMap,activePageId){netBrain.Map.currentActiveMap=newMap;var activePage=newMap.getNetmapById(activePageId);netBrain.Map.currentActiveMapPage=activePage||newMap.getActiveNetmap()}(newMap,activePageId)},renameMap:function(newName){_renameMap(newName)},saveMapCheck:_saveMapCheck,innerSaveMap:function(isHiddenSave){var map=this.getActiveMap();var mapName=map.getTitle();var deferred=$q.defer();try{var popTreeSave=function(){_browsePopup([],"Save Map",map).result.then((function(targetFolder){addMapToBrowseTree(targetFolder,map).then((function(d){_saveDocById(map,targetFolder,isHiddenSave).then((function(){utilitySrvc.removeLocalStorage("CreateMap"+map.getDocId());deferred.resolve()}),(function(reason){deleteMapToBrowseTree(d);deferred.reject(reason)}))}),(function(errorMsg){"has duplicateName"!==errorMsg&&"Map with the same name already exists!"!==errorMsg||map.setTitle(mapName);deferred.reject(errorMsg)}))}),(function(cancel){deferred.reject(cancel)}))};if(map.getMapType()!==netBrain.Map.Const.MapType.general||isHiddenSave)if(map.getMapType()===netBrain.Map.Const.MapType.siteMap||map.getMapType()===netBrain.Map.Const.MapType.deviceGroupMap){var cid=map.getDocId();var isExistFunctionHandle=httpMapSrvc.isMapExist;map.getMapType()===netBrain.Map.Const.MapType.siteMap&&(isExistFunctionHandle=isSiteExist);_saveMapCheck(map,isHiddenSave).then((function(){isExistFunctionHandle(cid).then((function(isLimitedMapExist){if(isLimitedMapExist)_saveDocById(map,null,isHiddenSave).then((function(){deferred.resolve()}),(function(reason){deferred.reject(reason)}));else{map.setMapType(netBrain.Map.Const.MapType.general);map.setRealNew(!0);popTreeSave()}}))}))}else _saveMapCheck(map,isHiddenSave).then((function(){_saveDocById(map,null,isHiddenSave).then((function(){deferred.resolve()}),(function(reason){deferred.reject(reason)}))}));else fileSrvc.existsFile(map.getDocId(),netBrain.Map.Const.FileTypes.Map).then((function(ret){if(ret)_saveMapCheck(map,isHiddenSave).then((function(){_saveDocById(map,null,isHiddenSave).then((function(){deferred.resolve()}),(function(reason){deferred.reject(reason)}))}));else{map.setRealNew(!0);popTreeSave()}}));return deferred.promise}catch(ex){var errmsg="saveDoc get error: "+ex.toString();nbAlertSrvc.alert(errmsg);deferred.reject(errmsg);return deferred.promise}},getIfNeedShowAlert:function(map){var pages=map.getAllPage();return _.some(pages,(function(page){var changedToDefault=page.getChangedToDefaultDataview();var deviceRemovedNote=page.getDeviceRemovedNote();var devices=page.getNetmapOperator().getAllDevcies(!0,!0);return _.some(devices,(function(device){return NgUtil.getValueFromObjAndPath(device,"dataViewData.dataViewInfo.dataViewType")!==DataViewType.dvDefault?_.indexOf(changedToDefault,device.key)>=0:!!(deviceRemovedNote&&deviceRemovedNote.length>0)&&_.indexOf(deviceRemovedNote,device.key)>=0}))}))},saveMap:function(isHiddenSave){var that=this;var deferred=$q.defer();var map=that.getActiveMap();if(that.getIfNeedShowAlert(map)&&map.isModify()){var obj={title:"Confirmation",iconType:NB_ICON_QUESTION,message:"Because you are not privileged to view the network data of some devices on the map, the applied data views on these devices have been overwritten by their default data views and their device notes have also been removed. <br/><br/>Are you sure you want to save the map?"};nbAlertSrvc.confirm(obj).then((function(){that.innerSaveMap(isHiddenSave).then((function(){deferred.resolve()}),(function(rejectMsg){deferred.reject(rejectMsg)}))}),(function(){deferred.reject()}))}else that.innerSaveMap(isHiddenSave).then((function(){deferred.resolve()}),(function(rejectMsg){deferred.reject(rejectMsg)}));return deferred.promise},saveMapAs:function(aMap){var map=aMap||this.getActiveMap();var mapName=map.getTitle();var oldMap=_.clone(map);var oldMapId=oldMap.getDocId();var deferred=$q.defer();try{_browsePopup([],"Save Map As",map).result.then((function(targetFolder){var newId=utilitySrvc.getGUID();map.setDocId(newId);addMapToBrowseTree(targetFolder,map,"checkonly").then((function(d){!function(map,oldMapId){map.setMapType(NetBrain.Map.Const.MapType.general);map.isTempEditRight=!1;map.setEditRight(userSrvc.getUserName(),userSrvc.getUserID());map.getRealNew()||map.setFromMapId(oldMapId);_.each(map.getAllPage(),(function(page){var newPageId=utilitySrvc.getGUID();page.setDocId(newPageId);page.setTopologyType(netBrain.Map.Const.NetmapTopoLogy.general);page.setIsFrom6X(!1)}))}(map,oldMapId);(function(map,targetFolder){var deferred=$q.defer();map.doSave();try{var jsData=map.toJson();httpMapSrvc.saveMapAs(jsData,targetFolder.id).then((function(result){if(!result){nbAlertSrvc.error("Failed to save the map.");return deferred.reject("mapObj is null")}map.setRealNew(!1);var op={id:map.getDocId(),target:"_self"};utilitySrvc.removeLocalStorage("CreateMap"+op.id);if(mainUISrvc.isDesktop())$rootScope.$emit("SaveAsMapForDesktop",map);else{var tenantId=httpAuthSrvc.getSelectedTenantId();var domainId=httpAuthSrvc.getSelectedDomainIds()[0];var url=StringUtil.format(NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.Map,{tenantId:tenantId,domainId:domainId,id:op.id});$rootScope.$emit("OPEN_NEW_TAB",url,op.target)}}),(function(data){return deferred.reject(data)}));return deferred.promise}catch(ex){$log.error("_saveDoc get error: "+ex.toString());return $q.reject(ex.toString())}})(map,targetFolder).then((function(){return deferred.resolve()}),(function(){oldMap.setDocId(oldMapId);_restoreMap(0,oldMap);deleteMapToBrowseTree(d);return deferred.reject("save as map got error")}))}),(function(errorMsg){oldMap.setDocId(oldMapId);_restoreMap(0,oldMap);"has duplicateName"!==errorMsg&&"Map with the same name already exists!"!==errorMsg||map.setTitle(mapName)}))}));return deferred.promise}catch(ex){_restoreMap(0,oldMap);$log.error("saveMapAs got error: "+ex.toString())}},checkMapSaved:function(msg,detail){try{return _checkMapSaved(msg)}catch(ex){$log.error("checkMapSaved get error: "+ex.toString());$q.reject(ex.toString())}},isNewDoc:function(){try{var activeMap=this.getActiveMap();for(var i=0;i<activeMap._docList.length;i++){if(activeMap._docList[i].getRealNew())return!0}}catch(ex){$log.info("_isNewDoc get error: "+ex.toString())}return!1},isModifyDoc:function(){try{var activeMap=this.getActiveMap();for(var i=0;i<activeMap._docList.length;i++){if(activeMap._docList[i].isModify())return!0}}catch(ex){$log.info("_isModifyDoc get error: "+ex.toString())}},transferMapEditRight:function(requestOption,msg,detail){var deferred=$q.defer();_checkMapSaved(msg).then((function(){_transferEditRight(deferred,requestOption)}),(function(){_transferEditRight(deferred,requestOption)}));return deferred.promise},denyMapEditRight:function(requestOption){var deferred=$q.defer();httpMapSrvc.denyEditingRight(requestOption).then((function(result){deferred.resolve(result)}),(function(data){$log.error("Deny got error: "+data.ResultDesc);deferred.reject(data.ResultDesc)}));return deferred.promise},getDTMenusOnMap:function(){return nbHttp.get("DTMenu")},exportMapToVisio:function(mapObj,isNew){return function(mapObj,isNew){return httpMapSrvc.exportMapToViso(mapObj,isNew)}(mapObj,isNew)},cancelExportMapToViso:function(){return httpMapSrvc.cancelExportMapToViso()},cancelExportMapById:function(cid){return function(cid){return httpMapSrvc.cancelExportMapById(cid)}(cid)},startExportMapTask:function(mapSimpleObj,canceler){return function(mapSimpleObj,canceler){return httpMapSrvc.startExportMapTask(mapSimpleObj,canceler)}(mapSimpleObj,canceler)},startExportMapToImageTask:function(mapImageObj,breakHandle){return function(mapImageObj,breakHandle){return httpMapSrvc.startExportMapToImageTask(mapImageObj,breakHandle)}(mapImageObj,breakHandle)},cancelExportMapToImageTask:function(taskId){return id=taskId,httpMapSrvc.cancelExportMapToImageTask(id);var id},exportMapToImage:function(taskId,mapName,breakHandle){return function(taskId,mapName,breakHandle){return httpMapSrvc.exportMapToImage(taskId,mapName,breakHandle)}(taskId,mapName,breakHandle)},getExportMapTaskIsFinish:function(cid){return function(cid){return httpMapSrvc.getExportMapTaskIsFinish(cid)}(cid)},getMapZipByTaskId:function(cid,mapSimpleObj,canceler){return function(cid,mapSimpleObj,canceler){return httpMapSrvc.getMapZipByTaskId(cid,mapSimpleObj,canceler)}(cid,mapSimpleObj,canceler)},deleteMap:function(mapId,mapType){return myFilesSrvc.deleteFileByOriginalId(mapId,mapType)},switchMapPage:function(pageId){if(pageId!==netBrain.Map.currentActiveMapPage.getDocId()){var netMap=netBrain.Map.currentActiveMap.getNetmapById(pageId);if(null!=netMap){netBrain.Map.currentActiveMap.deactiveAllPage();netMap.setActive(!0);netBrain.Map.currentActiveMapPage=netMap;var diagramPage=netMap._diagram;if(null!=diagramPage){var viewportBounds=diagramPage.viewportBounds;(viewportBounds.width<=1||viewportBounds.height<=1)&&diagramPage.delayInitialization((function(){diagramPage.requestUpdate()}))}$rootScope.$emit(NetBrain.Map.Event.ActivePageChanged)}}},setMediaNeatUp:function(isNeatUp){return function(isNeatUp){return httpMapSrvc.setMediaNeatUp(isNeatUp)}(isNeatUp)},getMediaNeatUp:function(){return httpMapSrvc.getMediaNeatUp()},convertToNormalMap:function(map,newMapId){return function(map,newMapId){newMapId&&map.setDocId(newMapId);map.setMapType(NetBrain.Map.Const.MapType.general);map.setEditRight(userSrvc.getUserName(),userSrvc.getUserID());_.each(map.getAllPage(),(function(page){var newPageId=utilitySrvc.getGUID();page.setDocId(newPageId);page.setTopologyType(netBrain.Map.Const.NetmapTopoLogy.general)}))}(map,newMapId)},changeDomainForCheckMapSaved:function(activeMap,checkEventType){var self=this;activeMap=netBrain.Map.currentActiveMap;var consts=netBrain.NetworkOS.Const;var defer=$q.defer();if("onFinish"===checkEventType)defer.resolve(consts.CheckAppResultBeforeChangeDomain.Continue);else if(activeMap)if(activeMap.isModify()){var mapName=activeMap.getTitle();var op={message:StringUtil.format(NetBrain.Map.Message.LeaveMapUnSaved,{mapname:mapName}),title:"Warning",iconType:NB_ICON_WARNING,buttons:[{id:NB_CONFIRM_YES,label:"Save"},{id:NB_CONFIRM_NO,label:"Don't Save"}]};nbAlertSrvc.confirm(op).then((function(){self.mapManagerSrvc.saveMap().then((function(){$rootScope.$emit("closeMapOndesktop",!0);defer.resolve(consts.CheckAppResultBeforeChangeDomain.Continue)}))}),(function(btn){if(btn){$rootScope.$emit("closeMapOndesktop",!0);defer.resolve(consts.CheckAppResultBeforeChangeDomain.Continue)}else defer.resolve(consts.CheckAppResultBeforeChangeDomain.Return)}))}else{$rootScope.$emit("closeMapOndesktop",!0);defer.resolve(consts.CheckAppResultBeforeChangeDomain.Continue)}else defer.resolve(consts.CheckAppResultBeforeChangeDomain.Continue);return defer.promise},setMapPanelTabShow:function(isShow){netBrain.Map.currentActiveMapPage.setMapPanelTabShow(isShow)},getMapPanelTabShow:function(){return netBrain.Map.currentActiveMapPage.getMapPanelTabShow()},hasEditingRights:function(map){var activeMap=map||mapManagerSrvc.getActiveMap();if(null==activeMap)return!1;if(activeMap.getMapType===NetBrain.Map.Const.MapType.overViewMap)return!1;var editor=activeMap.getEditRight();var result=!1;(""!==editor.editorId.trim()&&userSrvc.getUserID()===editor.editorId||""===editor.editorId.trim()&&userSrvc.getUserName()===editor.editorName)&&(result=!0);return result},getNotInPageDevice:function(devIds){var netMapPage=this.getActivePage();var allOnMapDevs=_.pluck(netMapPage._getAllDevices(),"key");return _.difference(devIds||[],allOnMapDevs)},setMapToCache:function(actionType,drawData){var defer=$q.defer();if(drawData){if((serialized=JSON.stringify(drawData)).length>1945600){var clobId=NgUtil.getGUID();utilitySrvc.setLocalStorage(actionType,{clobId:clobId});var serialized=JSON.stringify(drawData);httpMapSrvc.addMapAction({id:clobId,content:serialized}).then((function(){defer.resolve(!0)}),(function(){defer.resolve(!0)}))}else{utilitySrvc.setLocalStorage(actionType,drawData);defer.resolve(!0)}}else{utilitySrvc.setLocalStorage(actionType,drawData);defer.resolve(!0)}return defer.promise},getMapFromCache:function(actionType){var defer=$q.defer();var extAction=utilitySrvc.getLocalStorage(actionType);if(extAction){utilitySrvc.removeLocalStorage(actionType);extAction.clobId?httpMapSrvc.getMapAction(extAction.clobId).then((function(raw){try{if(raw){var parsed=JSON.parse(raw);defer.resolve(parsed)}else defer.resolve(null)}catch(ex){defer.resolve(null)}}),(function(){defer.resolve(null)})):defer.resolve(extAction)}else defer.resolve(extAction);return defer.promise},checkRealImageFormat:function(realImage){if(realImage&&0===realImage.indexOf("data:"))return'<img src="'+realImage+'">';if(!realImage||0!==realImage.indexOf("<img "))return'<img src="'+(realImage||"")+'">';try{angular.element(realImage);return realImage}catch(e){return'<img src="data:,">'}},jumpToCAWithMapDevices:function(){httpChangeAnalysisSettingSrvc.getChangeAnalysisSetting().then((function(data){if(angular.isUndefined(data)||0==data.length)nbAlertSrvc.error("There is no Change Analysis Setting.");else{var enabled=data.caEnabled;var operateInfo=data.operateInfo;if(enabled){var key=utilitySrvc.getGUID();var mapObj=targetDeviceSrvc.getTargetDeviceOnMap({objPage:netBrain.Map.currentActiveMapPage});if(0==mapObj.devices.length)return nbAlertSrvc.error("There are currently no individual devices on the map. Please drag some devices to the map and try again.");utilitySrvc.setLocalStorage(key,mapObj.devices);urlStateMgr.switchTabOrOpenNewTab(NetBrain.NG.Const.PageType.ChangeAnalysisReport,NetBrain.NG.Const.PageType.ChangeAnalysisReport,(function(){var url=NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.ChangeAnalysisReport+"?id="+key;urlStateMgr.openNewTab(url,"_blank")}))}else nbAlertSrvc.error("The Change Analysis function was disabled by "+operateInfo.opUser+" on "+new Date(operateInfo.opTime).toLocaleString())}}),(function(){}))},getAppliedDataViewInfo:function(currentPage){var dvIconObj_default="default-dataview-14",dvIconObj_dynamic="action_node_dynamic_dataview_14",dvIconObj_static="action_node_static_dataview_14",dvIconObj_map="action-node-map-dataview-14";var info={dvIcon:"",dvName:"",isDefaultDv:!1,lastUpdateTime:"",originExtendData:{}};var extendData=(currentPage||this.getActivePage()).getExtendData();var dvIcon;var dvName;var isDefaultDv;var lastUpdateTime;var flagSDV=function(extendData){return!(!extendData||!extendData.extendDataViewData)&&extendData.extendDataViewData.dataViewGroupScope===DataViewGroupScope.dvgScopeGlobal}(extendData);if(flagSDV||function(extendData){return!(!extendData||!extendData.extendDataViewData)&&extendData.extendDataViewData.dataViewGroupScope===DataViewGroupScope.dvgScopeMap}(extendData)){var extendDataViewData1=extendData.extendDataViewData;dvName=extendDataViewData1.dataViewName;lastUpdateTime=new Date(extendDataViewData1.lastUpdateTime);dvIcon=flagSDV?dvIconObj_static:dvIconObj_map}else if(function(extendData){var flag=!1;extendData&&extendData.extendRunbookData&&extendData.extendRunbookData.runbookNodeId&&(flag=!0);extendData&&extendData.extendDataViewData.dataViewGroupScope===DataViewGroupScope.dvgScopeALog&&(flag=!0);return flag}(extendData)){var extendDataViewData2=extendData.extendDataViewData;if(extendDataViewData2&&extendDataViewData2.dataViewName){dvName=extendDataViewData2.dataViewName;lastUpdateTime=extendDataViewData2.lastUpdateTime}var extendRunbookData=extendData.extendRunbookData;extendRunbookData&&extendRunbookData.runbookNodeName&&(dvName=extendRunbookData.runbookNodeName);extendRunbookData&&extendRunbookData.runbookNodeResultName&&(dvName+=" - "+extendRunbookData.runbookNodeResultName);extendRunbookData&&extendRunbookData.lastUpdateTime&&(lastUpdateTime=extendRunbookData.lastUpdateTime);dvIcon=extendData.extendDataViewTemplateData&&extendData.extendDataViewTemplateData.dataViewTemplateId?dvIconObj_dynamic:dvIconObj_static}else{dvName="Default Data View";isDefaultDv=!0;dvIcon=dvIconObj_default}info.dvIcon=dvIcon;info.dvName=dvName;info.isDefaultDv=isDefaultDv;info.lastUpdateTime=lastUpdateTime;info.originExtendData=extendData;return info},getInterfaceNoteList:function(devKey,intfId){var getIntfInfo=function(linkLine,deviceId){return linkLine.from===deviceId&&linkLine.intfSrc?linkLine.intfSrc.intfInfo:linkLine.to===deviceId&&linkLine.intfDest?linkLine.intfDest.intfInfo:null};var noteList=null;var intfInfoList=function(deviceId,netMapOperator){var intfInfoList=[];var linkLines=netMapOperator._netmap.getConnectedLinkDatasByDeviceId(deviceId);if(linkLines)for(var i=0;i<linkLines.length;i++){var linkLine=linkLines[i];if(_.isFunction(linkLine.getCategory)&&netBrain.Map.CategoryMgr.isTopolink(linkLine.getCategory())){var intfInfo=getIntfInfo(linkLine,deviceId);intfInfo&&intfInfoList.push(intfInfo)}}return intfInfoList}(devKey,this.getActivePage().getNetmapOperator());for(var i=0;i<intfInfoList.length>0;i++){var intfInfo=intfInfoList[i];var intf=intfInfo.intf;if(intf&&intf.intfKeyObj&&intf.intfKeyObj.value===intfId){noteList=intfInfo.intfNotes;break}}return noteList},setCurrentMapPageSubPaneBackground:function(ident,color){var htmlPageId="#realPage-"+this.getActivePage().getDocId()+"-container";var mapTitleDiv=angular.element(htmlPageId).find(".map-dv-title-inner-box");mapTitleDiv.length>0&&mapTitleDiv.css("background",color);var identDiv=$(ident);identDiv.length>0&&identDiv.css("background",color)},getCurrentMapPageDiv:function(){var htmlPageId="#realPage-"+this.getActivePage().getDocId()+"-container";return angular.element(htmlPageId)}}}}(NetBrain);!function(){angular.module("nb.qmap").factory("nb.qmap.monitorDataviewSrvc",monitorDataviewSrvc);monitorDataviewSrvc.$inject=["$q","$rootScope","$log","$timeout","nb.qmap.mapManagerSrvc","nb.dataview.applyDataViewSrvc","nb.dataview.httpDataViewSrvc","nb.ng.sessionSrvc","nb.runbook.httpActionLogSrvc"];function monitorDataviewSrvc($q,$rootScope,$log,$timeout,mapManagerSrvc,applyDataViewSrvc,httpDataViewSrvc,sessionSrvc,httpActionLogSrvc){var timeSpan=6e4;var reApplyDataviewTimeSpan=3e3;var lastMonitorTime=new Date;function doActionAppDataview(){var netMap=mapManagerSrvc.getActivePage();netMap&&$timeout((function(){netMap.getBackColor()===NetBrain.Map.Const.nbMonitorColor&&function(){var curtTime=new Date;if(curtTime-lastMonitorTime<=timeSpan)return;var netMap=mapManagerSrvc.getActivePage();if(netMap){lastMonitorTime=new Date;if(window.windowIsHidden){console.warn("monitorDataviewSrvc-------------------doAppDataview->null:"+curtTime);sessionSrvc.keepSession();doActionAppDataview()}else{console.warn("monitorDataviewSrvc-------------------doAppDataview->applyDataViewSrvc.applyDataviewsOnDevices:"+curtTime);var netMapOpertor=netMap.getNetmapOperator();var devids=_.pluck(netMapOpertor.getAllDevcies(),"key");var appliedDataviewGroupId=netMapOpertor.getExtendDataViewData().dataViewId;appliedDataviewGroupId&&applyDataViewSrvc.applyDataviewsOnDevices(devids,appliedDataviewGroupId,netMap).then((function(){$rootScope.$emit("refreshDataViewDetailPanel");doActionAppDataview()}),(function(){doActionAppDataview()}))}}}()}),timeSpan)}function reApplyDataviewForPage(netMap){$timeout((function(){console.warn("monitorDataviewSrvc-------------------reApplyDataviewForPage:"+new Date);var netMapOpertor=netMap.getNetmapOperator();if(netMapOpertor){var devids=_.pluck(netMapOpertor.getAllDevcies(),"key");applyDataViewSrvc.applyDataviewsOnDevices(devids,null,netMap).then((function(){$rootScope.$emit("refreshDataViewList");$rootScope.$emit("refreshDataViewDetailPanel")}))}}),reApplyDataviewTimeSpan)}function checkNetMapMonitor(netMap){$rootScope.$emit(NetBrain.Map.Event.QAppStatusChanged,!0);$timeout((function(){netMap||(netMap=mapManagerSrvc.getActivePage());if(netMap){var appliedDataviewGroupId=netMap.getExtendDataViewData().dataViewId;if(_.isEmpty(appliedDataviewGroupId)){if(netMap.getBackColor()&&"#F0FFF0"===netMap.getBackColor().toUpperCase()){netMap.setBackColor(NetBrain.Map.Const.nbDefaultPageColor);$rootScope.$emit(NetBrain.Map.Event.QAppStatusChanged,!1)}}else{var extendRunbookData=netMap.getExtendRunbookData();(extendRunbookData&&extendRunbookData.runbookNodeResultId?httpActionLogSrvc.getActionLog(extendRunbookData.runbookNodeResultId).then((function(data){return!(!data||!data.sourceTaskInfo)&&3!==data.sourceTaskInfo.currentStatus})):httpDataViewSrvc.isRunningTaskByDataViewGroupId(appliedDataviewGroupId)).then((function(isRunning){if(isRunning){netMap.setBackColor(NetBrain.Map.Const.nbMonitorColor);doActionAppDataview()}else netMap.setBackColor(NetBrain.Map.Const.nbDefaultPageColor);$rootScope.$emit(NetBrain.Map.Event.QAppStatusChanged,isRunning)}))}}}),1e3)}var watchDataViewChanged=$rootScope.$on(NetBrain.Map.Event.DataViewChanged,(function(){checkNetMapMonitor()}));$rootScope.$on(NetBrain.Map.Event.CloseMap,(function(){}));var watchActivePageChanged=$rootScope.$on(NetBrain.Map.Event.ActivePageChanged,(function(){checkNetMapMonitor()}));!function(){if(!0===window.isInIframe){watchDataViewChanged();watchActivePageChanged()}}();return{addMonitorGroup:function(data){var netMap=mapManagerSrvc.getActivePage();reApplyDataviewForPage(netMap);netMap.getDocId()===data.mapPageId&&data.dataviewGroupId&&doActionAppDataview();console.warn("monitorDataviewSrvc-------------------addMonitorGroup:"+new Date)},removeMonitorGroup:function(data){reApplyDataviewForPage(mapManagerSrvc.getActivePage());console.warn("monitorDataviewSrvc-------------------removeMonitorGroup:"+new Date+"data:"+data)},checkNetMapMonitor:checkNetMapMonitor,reApplyDataviewForPage:reApplyDataviewForPage}}}(NetBrain);!function(netBrain){var randomColor={};var legendColor={deviceLegend:{},interfaceLegend:{},linkLegend:{}};var randomColorSrvc={parseColor:function(intColor,randomKey,hightLegendType,legendName,excludeColor){if(function(color){var colorDom=document.createElement("span");colorDom.style.color=color;return!!colorDom.style.color}(intColor))return intColor;var color;if("-1"===intColor.toString()){void 0===randomKey&&(randomKey="defaultKey");if(void 0!==hightLegendType){if(hightLegendType===netBrain.Map.Const.HightLegendType.deviceLegend&&legendColor.deviceLegend[legendName])return legendColor.deviceLegend[legendName];if(hightLegendType===netBrain.Map.Const.HightLegendType.interfaceLegend&&legendColor.interfaceLegend[legendName])return legendColor.interfaceLegend[legendName];if(hightLegendType===netBrain.Map.Const.HightLegendType.linkLegend&&legendColor.linkLegend[legendName])return legendColor.linkLegend[legendName]}randomColor[randomKey]||(randomColor[randomKey]=0);var colorLength=netBrain.Map.Const.ColorLibrary.length;randomColor[randomKey]<colorLength-1?randomColor[randomKey]=randomColor[randomKey]+1:randomColor[randomKey]=1;color=netBrain.Map.Const.ColorLibrary[randomColor[randomKey]];if(excludeColor)for(;excludeColor.indexOf(color)>-1;){randomColor[randomKey]=randomColor[randomKey]+1;color=netBrain.Map.Const.ColorLibrary[randomColor[randomKey]]}if(void 0!==hightLegendType)switch(hightLegendType){case netBrain.Map.Const.HightLegendType.deviceLegend:legendColor.deviceLegend[legendName]=color;break;case netBrain.Map.Const.HightLegendType.interfaceLegend:legendColor.interfaceLegend[legendName]=color;break;case netBrain.Map.Const.HightLegendType.linkLegend:legendColor.linkLegend[legendName]=color}}else color=function(decimalColor){"string"==typeof decimalColor&&(decimalColor=parseInt(decimalColor));var hexColor=decimalColor.toString(16);for(;hexColor.length<6;)hexColor="0"+hexColor;return"#"+hexColor}(intColor);return color},resetColor:function(){randomColor={};legendColor={deviceLegend:{},interfaceLegend:{},linkLegend:{}}},getIntColor:function(color){return _.isString(color)?color.indexOf("#")>=0?parseInt(color.substring(1),16):color.toLowerCase().indexOf("rgb")>=0?parseInt(function(color){if(/^(rgb|RGB)/.test(color)){var aColor=color.replace(/(?:||rgb|RGB|\(|\))*/g,"").split(",");var strHex="#";for(var i=0;i<aColor.length;i++){var hex=Number(aColor[i]).toString(16);"0"===hex&&(hex+=hex);strHex+=hex}7!==strHex.length&&(strHex=color);return strHex}if(!/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(color))return color;var aNum=color.replace(/#/,"").split("");if(6===aNum.length)return color;if(3===aNum.length){var numHex="#";for(var j=0;j<aNum.length;j+=1)numHex+=aNum[j]+aNum[j];return numHex}}(color).substring(1),16):color:color}};netBrain.Map=netBrain.Map||{};netBrain.Map.randomColorSrvc=randomColorSrvc;angular.module("nb.qmap").factory("nb.qmap.randomColorSrvc",["$log",function(){return randomColorSrvc}])}(NetBrain);!function(netBrain){angular.module("nb.qmap").factory("nb.qmap.drawMapAPISrvc",drawMapAPISrvc);drawMapAPISrvc.$inject=["$q","$log","nb.netbrain.httpDeviceSrvc","nb.topo.httpExternNbrSrvc","nb.ng.userSrvc","nb.netbrain.dataViewCacheSrvc","nb.dataview.httpDataViewSrvc","nb.qmap.autoLinkOptionSrvc","nb.qmap.mapManagerSrvc","nb.common.nbAlertSrvc","nb.qmap.randomColorSrvc","nb.dataview.applyDataViewSrvc","nb.qmap.monitorDataviewSrvc","nb.runbook.pingTraceSrvc"];function drawMapAPISrvc($q,$log,httpDeviceSrvc,httpExternNbrSrvc,userSrvc,dataViewCacheSrvc,httpDataViewSrvc,autoLinkOptionSrvc,mapManagerSrvc,nbAlertSrvc,randomColorSrvc,applyDataViewSrvc,monitorDataviewSrvc,pingTraceSrvc){var _l3TopoId=NetBrain.Map.Const.TopoLinkType.IPv4L3Topology;function DrawInterface(promise,netmapOperator,deviceName,interfaceNames,interfaceType,topologyTypeId){var hasDevice=netmapOperator.getDeviceByHostName(deviceName);var currentDevice=null;var addInterface=function(currentDeviceId){currentDevice=netmapOperator.getDeviceByHostName(deviceName)[0];httpExternNbrSrvc.getDeviceInterfaces(currentDeviceId,topologyTypeId,interfaceType,interfaceNames).then((function(interfaces){if(interfaces){var ids=[];var interfaceSegments=[];_.each(interfaces,(function(intf){var findLink=netmapOperator.getLinksByDeviceIdAndInftId(currentDeviceId,intf.intfKeyObj.value);if(findLink&&findLink.length>0)return!0;_.each(intf.belongToTopoType,(function(belongToTopoType){ids.push({intf:intf,topoTypeId:belongToTopoType});interfaceSegments.push({devId:currentDeviceId,intfKey:intf.intfKeyObj,intfNodeData:intf.intfNodeData,topoTypeId:belongToTopoType})}))}));0!==interfaceSegments.length?function(currentDevice,interfaceSegments,netmapOperator){var deferred=$q.defer();var dataViewsSegmentIn=new DataViewsSegment;_.each(interfaceSegments,(function(interfaceSegment){var findIntfInList=_.find(currentDevice.dataViewData.intfInfoList,(function(item){return item.intf.intfKeyObj.value==interfaceSegment.intfKey.value}));if(findIntfInList&&findIntfInList.length>0)return!0;dataViewsSegmentIn.addIntf(interfaceSegment.devId,interfaceSegment.intfKey,interfaceSegment.topoTypeId,interfaceSegment.intfNodeData)}));dataViewsSegmentIn.length>0?httpDataViewSrvc.getDataViewsSegment(null,dataViewsSegmentIn).then((function(dataViewsSegmentOut){var model=netmapOperator.getNetMap()._diagram.model;_.each(dataViewsSegmentOut.intfDataViewSegmentList,(function(dataViewsSegmentOutItem){var intfInfoItem={autoLocked:!1,intfHighLightList:null,intfPosList:dataViewsSegmentOutItem.intfDataView.intfInfo.intfPosList,intf:dataViewsSegmentOutItem.intfDataView.intfInfo.intf};model.addArrayItem(currentDevice.dataViewData.intfInfoList,intfInfoItem)}));deferred.resolve(!0)})):deferred.resolve(!0);return deferred.promise}(currentDevice,interfaceSegments,netmapOperator).then((function(){httpExternNbrSrvc.getNbrIntfsByIntfId(ids).then((function(nbrLinkList){try{var nbrInfoList=[];_.each(ids,(function(item){var findNbrIntfsItem=_.find(nbrLinkList.nbrIntfs,(function(findItem){return findItem.intf.intfKeyObj.value==item.intf.intfKeyObj.value}));if(findNbrIntfsItem){if((item=findNbrIntfsItem).nbrs.length>0){var nbrInfo=item.nbrs[0];nbrInfo.id=currentDeviceId;nbrInfo.devId=currentDeviceId;nbrInfo.name=deviceName;nbrInfo.intf=item.intf;nbrInfoList.push(nbrInfo)}else if(item.speNbrs.length>0){(tmpNbrInfo={id:currentDeviceId,devId:currentDeviceId,name:deviceName,intf:item.intf,nbrId:null,nbrDevId:null,nbrName:null,nbrIntf:null,topoTypeId:item.speNbrs[0].topoTypeId}).mediaId=item.speNbrs[0].mediaId;tmpNbrInfo.mediaInfo=item.speNbrs[0].mediaInfo;tmpNbrInfo.nbrDevId=item.speNbrs[0].mediaId;tmpNbrInfo.isP2P=item.speNbrs[0].isP2P;if(item.speNbrs[0].topoTypeId===NetBrain.Map.Const.TopoLinkType.L2Topology){tmpNbrInfo.mediaId=null;tmpNbrInfo.mediaInfo=null}nbrInfoList.push(tmpNbrInfo)}}else{var tmpNbrInfo;(tmpNbrInfo={id:currentDeviceId,devId:currentDeviceId,name:deviceName,intf:item.intf,nbrId:null,nbrDevId:null,nbrName:null,nbrIntf:null,topoTypeId:item.topoTypeId}).mediaId=currentDeviceId+item.intf.intfKeyObj.value+"MuteLAN";tmpNbrInfo.mediaInfo={mediaName:"",mediaType:"MuteLan"};if(item.topoTypeId===NetBrain.Map.Const.TopoLinkType.L2Topology){tmpNbrInfo.mediaId=null;tmpNbrInfo.mediaInfo=null}nbrInfoList.push(tmpNbrInfo)}}));netmapOperator.extendNeighbors(nbrInfoList,!0,!0).then((function(){resolveResult(promise)}),(function(){resolveResult(promise)}))}catch(e){resolveResult(promise)}}),(function(){resolveResult(promise)}))})):resolveResult(promise)}else resolveResult(promise)}))};hasDevice.length>0?addInterface(hasDevice[0].key):httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,[deviceName]).then((function(devices){(currentDevice=devices[0])?netmapOperator.addDevices(httpExternNbrSrvc,[{id:currentDevice.ID,isSite:!1}],topologyTypeId,!1,null,null,httpDataViewSrvc).then((function(){addInterface(currentDevice.ID)})):resolveResult(promise)}),(function(){resolveResult(promise)}))}function getNoteFromType(note){var noteFromType=netBrain.Map.Const.NoteFromType;return note.pathId?noteFromType.Path:noteFromType.Normal}function _processDrawMap(item,netmapOperator,netmapCmdTarget,promise,netMap){item.parameters.topology_type&&(item.parameters.topology_type=_getTopoTypeId(item.parameters.topology_type));if("MapAutoLayout"===item.function_name){!function(promise,netmapCmdTarget,layoutStyle){switch(layoutStyle){case netBrain.Map.Const.LayoutStyle.Symmetric:netmapCmdTarget.onForceDirected();break;case netBrain.Map.Const.LayoutStyle.Circular:netmapCmdTarget.onCircularLayout();break;case netBrain.Map.Const.LayoutStyle.Hierarchical:case netBrain.Map.Const.LayoutStyle.Orthogonal:break;case netBrain.Map.Const.LayoutStyle.Tree:netmapCmdTarget.onTreeLayoutNew();break;default:netmapCmdTarget.onForceDirected()}resolveResult(promise)}(promise,netmapCmdTarget,item.parameters.layout_style)}else if("MapAutoLink"===item.function_name)!function(promise,netmapCmdTarget,topologyTypeId){try{netmapCmdTarget.onAutoLink(httpExternNbrSrvc,topologyTypeId,null,null,applyDataViewSrvc).then((function(){resolveResult(promise)}),(function(){resolveResult(promise)}))}catch(e){console.error(e)}finally{resolveResult(promise)}}(promise,netmapCmdTarget,item.parameters.topology_type);else if("DrawDevice"===item.function_name){!function(promise,netmapOperator,deviceNameArray,autoLink,topologyTypeId){var newDeviceNameArray=[];_.each(deviceNameArray,(function(devName){0!=netmapOperator.getDeviceByHostName(devName).length||newDeviceNameArray.push(devName)}));0!=newDeviceNameArray.length?httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,newDeviceNameArray).then((function(data){if(data){var deviceReq=_.map(data,(function(m){return{id:m.ID,isSite:!1}}));netmapOperator.addDevices(httpExternNbrSrvc,deviceReq,topologyTypeId,!1,null,null,applyDataViewSrvc,!1,!autoLink).then((function(){resolveResult(promise)}),(function(){resolveResult(promise)}))}else resolveResult(promise)}),(function(){resolveResult(promise)})):resolveResult(promise)}(promise,netmapOperator,item.parameters.device_name,item.parameters.auto_link,item.parameters.topology_type)}else if("DrawInterface"===item.function_name)DrawInterface(promise,netmapOperator,item.parameters.device_name,item.parameters.interface_name,item.parameters.interface_type,item.parameters.topology_type);else if("DrawInterfaceNeighbor"===item.function_name){!function(promise,netmapOperator,deviceName,interfaceName,interfaceType,topologyTypeId,neighborDeviceName){httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,[deviceName,neighborDeviceName]).then((function(devices){var currentDevice=_.find(devices,(function(obj){return obj.name===deviceName}));var neighborDevice=_.find(devices,(function(obj){return obj.name===neighborDeviceName}));currentDevice&&neighborDevice?netmapOperator.addDevices(httpExternNbrSrvc,[{id:currentDevice.ID,isSite:!1}],topologyTypeId,!1,null,null,httpDataViewSrvc).then((function(){httpExternNbrSrvc.getDeviceInterfaces(currentDevice.ID,topologyTypeId,interfaceType,[interfaceName]).then((function(interfaces){if(0!==interfaces.length){var ids=[];_.each(interfaces,(function(intf){_.each(intf.belongToTopoType,(function(belongToTopoType){ids.push({intf:intf,topoTypeId:belongToTopoType})}))}));httpExternNbrSrvc.getNbrIntfsByIntfId(ids).then((function(nbrLinkList){var nbrInfoList=[];try{_.each(nbrLinkList.nbrIntfs,(function(item){item.nbrs.length>0&&_.each(item.nbrs,(function(nbrInfo){if(nbrInfo.nbrDevId===neighborDevice.ID){nbrInfo.id=currentDevice.ID;nbrInfo.devId=currentDevice.ID;nbrInfo.name=deviceName;nbrInfo.intf=item.intf;nbrInfo.topoTypeName=topologyTypeId;nbrInfoList.push(nbrInfo)}}))}));netmapOperator.extendNeighbors(nbrInfoList,!1,!0).then((function(){resolveResult(promise)}),(function(){resolveResult(promise)}))}catch(e){resolveResult(promise)}}),(function(){resolveResult(promise)}))}else resolveResult(promise)}),(function(){resolveResult(promise)}))}),(function(){resolveResult(promise)})):resolveResult(promise)}),(function(){resolveResult(promise)}))}(promise,netmapOperator,item.parameters.device_name,item.parameters.interface_name,item.parameters.interface_type,item.parameters.topology_type,item.parameters.neighbor_device_name)}else if("DrawEndSystem"===item.function_name){!function(promise,netmapOperator,address,connectedDeviceName,connectedInterfaceName,interfaceType,topologyTypeId){if(address)if(netmapOperator.getNetMap()._isExistDeviceByHostname(address))resolveResult(promise);else{var endSystem=netBrain.Map.CompDevice.getDefaultJsonData();netBrain.Map.CompPrototypeFactory.buildCompPrototype(endSystem);endSystem.setDevCategory("1004");endSystem.setDevType("1004");endSystem.setHostname(address);var tempPos=990*Math.random()+10;var tempPos2=990*Math.random()+10;endSystem.setLocation(tempPos+" "+tempPos2);endSystem.dataViewData.devGraphicInfo.imageList[0].name="00000000-0000-0000-0000-000000000058.png";var devsName=[address];connectedDeviceName&&devsName.push(connectedDeviceName);httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,devsName).then((function(devices){var endSystemDevice=_.find(devices,(function(obj){return obj.name===address}));if(endSystemDevice){endSystem.setKey(endSystemDevice.ID);netmapOperator.addDevice(endSystem)}else netmapOperator.addDevice(endSystem);var connectedDevice=_.find(devices,(function(obj){return obj.name===connectedDeviceName}));connectedDevice?netmapOperator.addDevices(httpExternNbrSrvc,[{id:connectedDevice.ID,isSite:!1}],topologyTypeId,!1,null,null,httpDataViewSrvc).then((function(){if(endSystemDevice)DrawInterface(promise,netmapOperator,connectedDeviceName,connectedInterfaceName,interfaceType,topologyTypeId);else if(endSystem){var compLink=netBrain.Map.CompBase.buildCompTopolink();compLink.setFromKey(endSystem.key);compLink.setToKey(connectedDevice.ID);netmapOperator.addLinkLine(compLink)}else resolveResult(promise)})):resolveResult(promise)}),(function(){netmapOperator.addDevice(endSystem);resolveResult(promise)}))}else resolveResult(promise)}(promise,netmapOperator,item.parameters.address,item.parameters.connected_device_name,item.parameters.connected_interface_name,item.parameters.interface_type,item.parameters.topology_type)}else if("DrawMapNote"===item.function_name)!function(promise,netmapOperator,note){var existedNote=netmapOperator.getMapNote(note.title,note.noteType)[0];if(existedNote)_handlerExistedNote(existedNote,note,netmapOperator);else{note.category=netBrain.Map.CategoryMgr.Note;var diagram=netmapOperator.getNetMap()._diagram;var viewport=diagram.viewportBounds;var documentBounds=diagram.documentBounds;var x=Math.max(viewport.x,documentBounds.x);var y=Math.max(viewport.y,documentBounds.y);var width=Math.max(Math.min(viewport.width,documentBounds.width),800);var height=Math.max(Math.min(viewport.height,documentBounds.height),600);var pointX=x+175+Math.random()*(width-350);var pointY=y+80+Math.random()*(height-160);netmapOperator.addDeviceNote(note,{x:pointX,y:pointY})}resolveResult(promise)}(promise,netmapOperator,_handlerNoteParams(item.parameters));else if("DrawDeviceNote"===item.function_name){!function(promise,netmapOperator,deviceName,note,autoDrawDevice){note.noteFromType=getNoteFromType(note);var currentDevice=null;var hasDevices=netmapOperator.getDeviceByHostName(deviceName);hasDevices.length>0&&(currentDevice=hasDevices[0]);if(null==currentDevice)autoDrawDevice?httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,[deviceName]).then((function(devices){(currentDevice=devices[0])?netmapOperator.addDevices(httpExternNbrSrvc,[{id:currentDevice.ID,isSite:!1}],_l3TopoId,!1,null,null,httpDataViewSrvc).then((function(){var existedNote2=netmapOperator.getDeviceNote(currentDevice.ID,note.title,note.noteType,note.pathId)[0];existedNote2?_handlerExistedNote(existedNote2,note,netmapOperator):netmapOperator.addDeviceNoteRefDevice(currentDevice.ID,note);resolveResult(promise)})):resolveResult(promise)}),(function(){resolveResult(promise)})):resolveResult(promise);else{var existedNote=netmapOperator.getDeviceNote(currentDevice.key,note.title,note.noteType,note.pathId)[0];existedNote?_handlerExistedNote(existedNote,note,netmapOperator):netmapOperator.addDeviceNoteRefDevice(currentDevice.key,note);resolveResult(promise)}}(promise,netmapOperator,item.parameters.device_name,_handlerNoteParams(item.parameters),item.parameters.auto_draw_device)}else if("DrawInterfaceNote"===item.function_name){!function(promise,netmapOperator,deviceName,interfaceName,interfaceType,topologyTypeId,note,autoDrawInterface){note.noteFromType=getNoteFromType(note);httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,[deviceName]).then((function(devices){var currentDevice=devices[0];currentDevice?httpExternNbrSrvc.getDeviceInterfaces(currentDevice.ID,topologyTypeId,interfaceType,[interfaceName]).then((function(interfaces){if("true"===autoDrawInterface){var deferred=$q.defer();DrawInterface(deferred,netmapOperator,deviceName,[interfaceName],interfaceType,topologyTypeId);deferred.promise.then((function(){_.each(interfaces,(function(intf){if(netmapOperator.checkDeviceIntfLink(currentDevice.ID,intf)){var existedNote=netmapOperator.getDeviceIntfNote(currentDevice.ID,intf,note.title,note.noteType)[0];existedNote?_handlerExistedNote(existedNote,note,netmapOperator):netmapOperator.addIntfNoteRefDevice(currentDevice.ID,intf,note)}}));resolveResult(promise)}))}else{_.each(interfaces,(function(intf){if(netmapOperator.checkDeviceIntfLink(currentDevice.ID,intf)){var existedNote=netmapOperator.getDeviceIntfNote(currentDevice.ID,intf,note.title,note.noteType)[0];existedNote?_handlerExistedNote(existedNote,note,netmapOperator):netmapOperator.addIntfNoteRefDevice(currentDevice.ID,intf,note)}}));resolveResult(promise)}})):resolveResult(promise)}),(function(){resolveResult(promise)}))}(promise,netmapOperator,item.parameters.device_name,item.parameters.interface_name,item.parameters.interface_type,item.parameters.topology_type,_handlerNoteParams(item.parameters),item.parameters.auto_draw_interface)}else if("DrawHyperLink"===item.function_name){!function(promise,netmapOperator,text,url){netmapOperator.addHyperLink(text,url);resolveResult(promise)}(promise,netmapOperator,item.parameters.text,item.parameters.url)}else"HighlightDevice"===item.function_name?function(promise,netmapOperator,item){var deviceName=item.parameters.device_name;httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,[deviceName]).then((function(devices){try{var currentDevice=devices[0];if(!currentDevice){resolveResult(promise);return}var deviceObj={devId:currentDevice.ID,color:item.parameters.color,append:item.parameters.append,legend:item.parameters.legend};netmapOperator.drawDeviceHighlight(deviceObj);netmapOperator._netmap._getGraphDeviceByKey(currentDevice.ID)&&netmapOperator._netmap.getCurrentScope().$broadcast("HighlightDevice",deviceObj,netmapOperator._netmap)}catch(e){console.warn(e)}finally{resolveResult(promise)}}),(function(){resolveResult(promise)}))}(promise,netmapOperator,item):"HighlightInterface"===item.function_name?function(promise,netmapOperator,item){var deviceName=item.parameters.device_name;var interfaceName=item.parameters.interface_name;var interfaceType=item.parameters.interface_type;var topologyTypeId=_getTopoTypeId(item.parameters.topology_type);httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,[deviceName]).then((function(devices){var currentDevice=devices[0];currentDevice?httpExternNbrSrvc.getDeviceInterfaces(currentDevice.ID,topologyTypeId,interfaceType,[interfaceName]).then((function(interfaces){if(interfaces){_.each(interfaces,(function(intf){_.each(intf.belongToTopoType,(function(belongToTopoType){var intfObj={devId:currentDevice.ID,intf:intf,topoType:belongToTopoType,legend:item.parameters.legend,color:item.parameters.color,width:item.parameters.thickness,type:item.parameters.line_type,append:item.parameters.append};if(netmapOperator.checkDeviceIntfLink(currentDevice.ID,intf)){netmapOperator.drawLinkHighlight(intfObj);var intfObjForHight=angular.copy(intfObj);intfObjForHight.type=item.parameters.line_type;netmapOperator._netmap.getCurrentScope().$broadcast("HighlightInterface",intfObjForHight,netmapOperator._netmap)}}))}));resolveResult(promise)}else resolveResult(promise)})):resolveResult(promise)}),(function(){resolveResult(promise)}))}(promise,netmapOperator,item):"HighlightL2Link"===item.function_name?resolveResult(promise):"HighlightNeighbor"===item.function_name?function(promise,netmapOperator,item,netMap){var deviceName1=item.parameters.device_name1;var deviceName2=item.parameters.device_name2;httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,[deviceName1,deviceName2]).then((function(devices){var currentDevice=_.find(devices,(function(obj){return obj.name===deviceName1}));var neighborDevice=_.find(devices,(function(obj){return obj.name===deviceName2}));if(currentDevice&&neighborDevice){netmapOperator.drawHighlightNeighborLink({from:currentDevice.ID,to:neighborDevice.ID,color:item.parameters.color,width:item.parameters.thickness,legend:item.parameters.legend,type:item.parameters.line_type,fromText:item.parameters.text1,toText:item.parameters.text2,twoWay:item.parameters.two_way,category:netBrain.Map.CategoryMgr.HighlightNeighborLink});netMap.setNetMapLegend();resolveResult(promise)}else resolveResult(promise)}),(function(){resolveResult(promise)}))}(promise,netmapOperator,item,netMap):"DrawHop"===item.function_name?function(promise,netmapOperator,item){var deviceName1=item.parameters.device_name1;var deviceName2=item.parameters.device_name2;httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,[deviceName1,deviceName2]).then((function(devices){var currentDevice=_.find(devices,(function(obj){return obj.name===deviceName1}));var neighborDevice=_.find(devices,(function(obj){return obj.name===deviceName2}));if(currentDevice&&neighborDevice){netmapOperator.drawHopLink({from:currentDevice.ID,to:neighborDevice.ID,color:item.parameters.color,width:item.parameters.thickness,legend:item.parameters.legend,type:item.parameters.line_type,text:item.parameters.text});resolveResult(promise)}else resolveResult(promise)}),(function(){resolveResult(promise)}))}(promise,netmapOperator,item):"DrawTraceRouteHops"===item.function_name&&function(promise,netmapOperator,item){var ips=item.parameters.hops;pingTraceSrvc.mapPathByHopIds(ips).then((function(){resolveResult(promise)}),(function(){resolveResult(promise)}))}(promise,0,item)}function _handlerExistedNote(existedNote,note,netmapOperator){var newContent="";if(existedNote.noteType===netBrain.Map.Const.NoteType.Append)newContent=existedNote.noteContent+"\n"+note.content;else if(existedNote.noteType===netBrain.Map.Const.NoteType.Overwrite)newContent=note.content;else if(existedNote.noteType===netBrain.Map.Const.NoteType.RecordHistory){var contentArray=existedNote.noteContent.split("\n");if(contentArray.length>1){var existedCount=0;var lastIndex=0;for(var i=0;i<contentArray.length;i++){if(contentArray[i].split("] ")[1]===note.content.split("] ")[1]){if(++existedCount>1){contentArray.splice(lastIndex,1);break}lastIndex=i}}}contentArray.unshift(note.content);newContent=contentArray.join("\n")}existedNote.setNoteContent(newContent,netmapOperator.getNetMap()._diagram);existedNote.setModifyTime(note.time,netmapOperator.getNetMap()._diagram);existedNote.setLastModifyUser(window.gUserName,netmapOperator.getNetMap()._diagram);existedNote.setFontColor(note.forecolor,netmapOperator.getNetMap()._diagram)}function _handlerNoteParams(params){var note={};null!=params.note_type&&(note.noteType=params.note_type);note.expand=params.expand||!1;note.forecolor=params.forecolor;note.fontSize=(params.font_size||"9")+"px";note.align=params.font_align;note.backgroundColor=params.background_color;params.border_color&&(note.borderColor=params.border_color);note.title=params.title;note.noteType===netBrain.Map.Const.NoteType.RecordHistory&&(params.content=StringUtil.format("[{time}] {content}",{time:TimeUtil.formatDateTime(new Date),content:params.content}));note.content=params.content;note.user=userSrvc.getUserName();note.time=new Date;note.hopId=params.hop_id;note.pathId=params.path_id;return note}function _getTopoTypeId(topologyTypeName){for(var i=0;i<NetBrain.AllTopoLinkType.length;i++)if(NetBrain.AllTopoLinkType[i].name===topologyTypeName)return NetBrain.AllTopoLinkType[i].ID;return topologyTypeName}function resolveResult(promise){promise&&promise.resolve()}return{updateDrawMap:function(drawMapFunctions,netMap){console.warn("drawMapFunctions start");console.warn(drawMapFunctions);drawMapFunctions=function(drawMapFunctions){var newDrawMapFunctions=[];var cacheKeys=[];_.each(drawMapFunctions,(function(item){if("DrawInterface"==item.function_name)if(_.contains(cacheKeys,item.function_name+item.parameters.device_name+item.parameters.interface_type+item.parameters.topology_type)){var findfunc=_.find(newDrawMapFunctions,(function(subfunction){return subfunction.function_name==item.function_name&&subfunction.parameters.device_name==item.parameters.device_name&&subfunction.parameters.interface_type==item.parameters.interface_type&&subfunction.parameters.topology_type==item.parameters.topology_type}));_.contains(findfunc.parameters.interface_name,item.parameters.interface_name)||findfunc.parameters.interface_name.push(item.parameters.interface_name)}else{var newItem={function_name:"DrawInterface",parameters:{device_name:item.parameters.device_name,interface_name:[item.parameters.interface_name],interface_type:item.parameters.interface_type,topology_type:item.parameters.topology_type}};newDrawMapFunctions.push(newItem);cacheKeys.push(item.function_name+item.parameters.device_name+item.parameters.interface_type+item.parameters.topology_type)}else if("DrawDevice"==item.function_name)if(_.contains(cacheKeys,item.function_name+item.parameters.auto_link+item.parameters.topology_type)){findfunc=_.find(newDrawMapFunctions,(function(subfunction){return subfunction.function_name==item.function_name&&subfunction.parameters.auto_link==item.parameters.auto_link&&subfunction.parameters.topology_type==item.parameters.topology_type}));_.contains(findfunc.parameters.device_name,item.parameters.device_name)||findfunc.parameters.device_name.push(item.parameters.device_name)}else{newItem={function_name:"DrawDevice",parameters:{device_name:[item.parameters.device_name],auto_link:item.parameters.auto_link,topology_type:item.parameters.topology_type}};newDrawMapFunctions.push(newItem);cacheKeys.push(item.function_name+item.parameters.auto_link+item.parameters.topology_type)}else newDrawMapFunctions.push(item)}));return newDrawMapFunctions}(drawMapFunctions);randomColorSrvc.resetColor();_.find(drawMapFunctions,(function(item){return item.function_name.indexOf("Highlight")>-1}))&&netMap.getNetmapOperator().clearDrawHighlight();var netmapCmdTarget=netMap.getCmdTarget();var netmapOperator=netMap.getNetmapOperator();var transName=NgUtil.getUniqueStr("DrawInterfacePort");netmapOperator.startTransaction(transName);var promiseList=[$q.defer()];_.each(drawMapFunctions,(function(item,index){promiseList.push($q.defer());promiseList[index].promise.index=index+1;promiseList[index].promise.then((function(){_processDrawMap(item,netmapOperator,netmapCmdTarget,promiseList[index+1],netMap);index+1===drawMapFunctions.length&&promiseList[index+1].promise.then((function(){monitorDataviewSrvc.reApplyDataviewForPage(netMap);netmapOperator.commitTransaction(transName)}))}))}));promiseList[0].resolve()}}}}(NetBrain);NetBrain,angular.module("nb.qmap").factory("nb.qmap.deviceTableSrvc",["nb.netbrain.httpObjectGroupSrvc","$uibModal","$log","$q","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.sdn.httpSdnSrvc","nb.deviceDetail.httpDeviceDetailSrvc","nb.deviceDetail.deviceDataNonModelDialogSrvc",function(httpObjectGroupSrvc,$uibModal,$log,$q,utilitySrvc,httpAuthSrvc,deviceTypeMgrSrvc,httpSdnSrvc,httpDeviceDetailSrvc,deviceDataNonModelDialogSrvc){var _httpObjectGroupSrvc=httpObjectGroupSrvc;var _technologyActions={};httpSdnSrvc.getAllTechnologySpecs().then((function(data){data.hasOwnProperty("result")&&data.result.forEach((function(tech){tech.hasOwnProperty("actions")&&tech.actions.forEach((function(action){_technologyActions[action.schema]=action.dataTables}))}))}));function action_popout_configExt(device,displayedTableType,filter){var dialogId=utilitySrvc.getGUID();deviceDataNonModelDialogSrvc.showNonModalDialog({dialogId:dialogId,templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",resolve:{args:function(){var args={};args.deviceId=device.getKey();args.deviceType=device.getDevType();args.deviceHostname=device.getHostname();var deviceTenantDomain={TenantGuid:httpAuthSrvc.getDataSrc(utilitySrvc).TenantGuid,DomainGuid:[]};if("Config"===displayedTableType){args.currTenantDomain=deviceTenantDomain;args.isConfigFile=!0;args.dataType=DeviceDataType.Config}else{args.currTenantDomain=deviceTenantDomain;args.isDataTable=!0;args.vrf="";switch(displayedTableType){case"Route":args.isRouteTable=!0;args.dataType=DeviceDataType.RouteTable;break;case"ARP":args.isArpTable=!0;args.dataType=DeviceDataType.ArpTable;break;case"MAC":args.dataType=DeviceDataType.MacTable;break;case"NDP":args.dataType=DeviceDataType.CdpTable;break;case"STP":args.dataType=DeviceDataType.StpTable;break;case"NCT":args.isNctTable=!0;args.dataType=DeviceDataType.NctTable;if(filter instanceof Array){args.displayedTableType="NCT";args.dataName=filter[0];args.lsApiNctTableNames=filter}else{args.displayedTableType="NCT";args.dataName=filter||""}break;case"bgpNbrTable":args.dataType=DeviceDataType.BgpNbrTable}}return args}}})}return{action_popout_config:function(scope,displayedTableType,filter){$uibModal.open({templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",backdrop:"static",resolve:{args:function(){var args={};if(scope.currentNode){args.deviceId=scope.currentNode.key;args.deviceType=scope.currentNode.devType;args.deviceHostname=scope.currentNode.hostName}else if(scope.Node){args.deviceId=scope.Node.data.key;args.deviceType=scope.Node.data.deviceType;args.deviceHostname=scope.Node.data.hostName}if("Config"===displayedTableType){args.currTenantDomain=scope.deviceTenantDomain;args.isConfigFile=!0;args.dataType=DeviceDataType.Config}else{args.currTenantDomain=scope.deviceTenantDomain;args.isDataTable=!0;args.vrf="";switch(displayedTableType){case"Route":args.isRouteTable=!0;args.dataType=DeviceDataType.RouteTable;break;case"ARP":args.isArpTable=!0;args.dataType=DeviceDataType.ArpTable;break;case"MAC":args.dataType=DeviceDataType.MacTable;break;case"NDP":args.dataType=DeviceDataType.CdpTable;break;case"STP":args.dataType=DeviceDataType.StpTable;break;case"NCT":args.isNctTable=!0;args.dataType=DeviceDataType.NctTable;args.displayedTableType=filter;args.dataName=filter}}return args}}})},getTableSourceExt:function(device){var deviceType=device.devType;var data={subMenus:[]};if(device.devNodeData&&device.devNodeData.nodeIdentify&&device.devNodeData.nodeIdentify.nbPathSchema!=NetBrain.Common.Const.LegacySchema.Legacy&&_technologyActions.hasOwnProperty(device.devNodeData.nodeIdentify.nbPathSchema)){var lsNctTableNames=[];_technologyActions[device.devNodeData.nodeIdentify.nbPathSchema].forEach((function(dataTable){dataTable.isSystem||dataTable.isNct&&lsNctTableNames.push(dataTable.displayedTableType)}))}deviceTypeMgrSrvc.isSupportRoutingTable(deviceType)&&data.subMenus.push({title:"Route Table",action:function(){action_popout_configExt(device,"Route",null)}});deviceTypeMgrSrvc.isSupportArpTable(deviceType)&&data.subMenus.push({title:"ARP Table",action:function(){action_popout_configExt(device,"ARP",null)}});deviceTypeMgrSrvc.isSupportMacTable(deviceType)&&data.subMenus.push({title:"MAC Table",action:function(){action_popout_configExt(device,"MAC",null)}});deviceTypeMgrSrvc.isSupportCdpTable(deviceType)&&data.subMenus.push({title:"NDP Table",action:function(){action_popout_configExt(device,"NDP",null)}});deviceTypeMgrSrvc.isSupportStpTable(deviceType)&&data.subMenus.push({title:"STP Table",action:function(){action_popout_configExt(device,"STP",null)}});var guid=device.getKey();(deviceId=guid,_httpObjectGroupSrvc.NCTCategoriesByDeviceId(deviceId).then((function(lsNcts){return lsNcts||[]}),(function(){return[]}))).then((function(lsNcts){if(lsNcts&&lsNcts.length>0){var nctTable={title:"NCT Table",action:function(){action_popout_configExt(device,"NCT",lsNcts[0])}};data.subMenus.push(nctTable)}}),(function(reason){$log.error(reason)}));var deviceId;(function(deviceId){return httpDeviceDetailSrvc.getDataTableDataList({devId:deviceId,sourceType:0,tableType:16,withData:!1}).then((function(data){return data&&data.summary&&data.summary.length>0}))})(guid).then((function(isSupported){if(isSupported){var bgpAdver={title:"BGP Advertised-route Table",action:function(){action_popout_configExt(device,"bgpNbrTable",[])}};data.subMenus.push(bgpAdver)}}));return data},action_popout_configExt:action_popout_configExt}}]);!function(){angular.module("nb.qmap").factory("nb.qmap.newMapIndexSrvc",newMapIndexSrvc);newMapIndexSrvc.$inject=["nb.ng.utilitySrvc"];function newMapIndexSrvc(utilitySrvc){return{getNewMapIndex:function(){var newMapIndex=utilitySrvc.getLocalStorage("NewMapIndex")||1;utilitySrvc.setLocalStorage("NewMapIndex",newMapIndex+1);return newMapIndex},resetNewMapIndex:function(){utilitySrvc.setLocalStorage("NewMapIndex",1)}}}}();!function(NetBrain){angular.module("nb.qmap").controller("nb.qmap.mapContainerCtrl",mapPageCtrl);mapPageCtrl.$inject=["$scope","nb.uiframework.urlStateMgr","nb.ng.licenseSrvc","nb.embedMap.agentSrvc"];function mapPageCtrl($scope,urlStateMgr,licenseSrvc,agentSrvc){NetBrain.Page.IsDomainCheck=!0;$scope.mainUiSettings={customizeNavigations:[{key:"site",hide:!1},{key:"pathBrowser",hide:!1},{key:"runbook",hide:!1},{key:"change-mgnt",hide:!1},{key:"sdn",hide:!1}]};$scope.initCtrl=function(){};$scope.getAgentSrvc=function(){agentSrvc.init($scope);return agentSrvc};$scope.initCtrl()}}(NetBrain);!function(){angular.module("nb.qmap").controller("nb.qmap.mapToolsCtrl",mapToolsCtrl);mapToolsCtrl.$inject=["$scope","$log","$rootScope","$timeout","nb.qmap.mapManagerSrvc"];function mapToolsCtrl($scope,$log,$rootScope,$timeout,mapManagerSrvc){$scope.resizeActive=!1;var unRegisterZoomStepCallback=$rootScope.$on(netMapEvent.setZoomStep,(function(event,args){var dZoomStep=.25;null!=args&&args.length>0&&(dZoomStep=args[0]);$scope.dZoomStep=100*dZoomStep}));$scope.initParams=function(){var activePage=mapManagerSrvc.getActivePage();$scope.zoomValue=100*activePage.getSpace();$scope.zoomValueConvert=500-$scope.zoomValue;var currMapOption=activePage.getMapViewOptionJson();currMapOption&&!0!==activePage.realNew||(currMapOption=activePage._mapViewOption.optionsList);$scope.dZoomStep=100*currMapOption.step;activePage.getGoJsDiagram().commandHandler.setCusZoomSetp($scope.dZoomStep/100)};$scope.initParams(!1);$scope.resizeSelected=function(){$log.info("resizeSelected() is fired");var curNetMap=mapManagerSrvc.getActivePage();if(null!=curNetMap){var diagram=curNetMap.getGoJsDiagram();if(null!=diagram){diagram.commandHandler.setSpace(1);diagram.zoomToFit();diagram.commandHandler.setSpace(diagram.scale);diagram.commandHandler.zoomCallBack(diagram.scale);deactivateTextblock(diagram)}}};function deactivateTextblock(diagram){diagram.currentTool.isActive&&diagram.currentTool.doDeactivate()}var inEditMode=$rootScope.$on(netMapEvent.enterDataViewEdit,(function(){$scope.isInEditMode=!0}));var outEditMode=$rootScope.$on(netMapEvent.leaveDataViewEdit,(function(){$scope.isInEditMode=!1}));$scope.zoomOut=function(event){$log.info("$scope.zoomOut() is fired");var curNetMap=mapManagerSrvc.getActivePage();if(null!=curNetMap){var diagram=curNetMap.getGoJsDiagram();if(null!=diagram){diagram.commandHandler.centerZoomPoint();diagram.commandHandler.setCusZoomSetp($scope.dZoomStep/100);diagram.commandHandler.decreaseZoom();deactivateTextblock(diagram);event.stopPropagation()}}};$scope.zoomIn=function(event){$log.info("$scope.zoomIn() is fired");var curNetMap=mapManagerSrvc.getActivePage();if(null!=curNetMap){var diagram=curNetMap.getGoJsDiagram();if(null!=diagram){diagram.commandHandler.centerZoomPoint();diagram.commandHandler.setCusZoomSetp($scope.dZoomStep/100);diagram.commandHandler.increaseZoom();deactivateTextblock(diagram);event.stopPropagation()}}};$scope.slider={options:{stop:function(event,ui){$scope.zoomChanged(event,ui)},orientation:"vertical"}};$scope.zoomChanged=function(event,ui){var curNetMap=mapManagerSrvc.getActivePage();if(null!=curNetMap){var diagram=curNetMap.getGoJsDiagram();if(null!=diagram){var zoomValue=500-ui.value;$scope.zoomValue=zoomValue;diagram.commandHandler.setSpace(zoomValue/100);diagram.commandHandler.zoomCallBack(zoomValue/100);diagram.commandHandler.centerZoomPoint();deactivateTextblock(diagram);event.stopPropagation()}}};$scope.$on("$destroy",(function(){unRegisterZoomStepCallback();inEditMode();outEditMode()}))}}();!function(netBrain){function ViewOption(){this.optionsList=angular.copy(netBrain.Map.Const.MapViewOptionSetting)}ViewOption.prototype={toJson:function(){return angular.fromJson(angular.toJson(this.optionsList))},fromJson:function(mapViewOptionJson){if(null==mapViewOptionJson)return this;var optionsList=this.optionsList;optionsList.isNeatUp=mapViewOptionJson.isNeatUp;optionsList.step=mapViewOptionJson.step;_.each(mapViewOptionJson.options,(function(item){var temp=_.find(optionsList.options,(function(t){return t.posName===item.posName}));if(temp){temp.scaleThreshold=item.scaleThreshold;temp.display=item.display}}));return this},initOptions:function(){},getOptionNameArray:function(){var retArray=[];for(var index=0;index<this.optionsList.options.length;index++)retArray.push(this.optionsList.options[index].displayName);return retArray},getOptionScaleThresHoldByPosName:function(strPosName){for(var index=0;index<this.optionsList.options.length;index++)if(strPosName===this.optionsList.options[index].posName)return this.optionsList.options[index].scaleThreshold;return null},isOneOptionDisplayByPosName:function(strPosName){for(var index=0;index<this.optionsList.options.length;index++)if(strPosName===this.optionsList.options[index].posName)return this.optionsList.options[index].display;return null},getOptionScaleThresHoldByName:function(strDisplayName){for(var index=0;index<this.optionsList.options.length;index++)if(strDisplayName===this.optionsList.options[index].displayName)return this.optionsList.options[index].scaleThreshold;return null},setOptionScaleThresHoldByName:function(strDisplayName,dScaleThreshold){for(var index=0;index<this.optionsList.options.length;index++)strDisplayName===this.optionsList.options[index].displayName&&(this.optionsList.options[index].scaleThreshold=dScaleThreshold)},isOneOptionDisplay:function(strDisplayName){for(var index=0;index<this.optionsList.options.length;index++)if(strDisplayName===this.optionsList.options[index].displayName)return this.optionsList.options[index].display;return null},SetOneOptionDisplay:function(strDisplayName,bDisplay){for(var index=0;index<this.optionsList.options.length;index++)strDisplayName===this.optionsList.options[index].displayName&&(this.optionsList.options[index].display=bDisplay)},getZoomStep:function(){return this.optionsList.step},setZoomStep:function(dStep){this.optionsList.step=dStep},getIsNeatUp:function(){return this.optionsList.isNeatUp},setIsNeatUp:function(isNeatUp){this.optionList.isNeatUp=isNeatUp},setOptionScaleThresHolds:function(dScaleThreshold){for(var index=0;index<this.optionsList.options.length;index++)this.optionsList.options[index].scaleThreshold=dScaleThreshold},convertDoubleToDisplayString:function(dValue){var retStr="100%";null!==dValue&&(retStr=100*dValue+"%");return retStr},convertDisplayStringToDouble:function(strDisplayValue){if("number"==typeof strDisplayValue)return strDisplayValue;if(null==strDisplayValue)return 1;var strTempDisplayValue=null;var pos=strDisplayValue.indexOf("%");strTempDisplayValue=-1!==pos?strDisplayValue.slice(0,pos):strDisplayValue;var value=Number(strTempDisplayValue);return null==value?1:value/100}};angular.module("nb.qmap").service("nb.qmap.mapViewOptionSrvc",ViewOption);angular.module("nb.qmap").filter("mapZoomValue",(function(){return function(input){return input?100*parseFloat(input)+"%":""}}))}(NetBrain);!function(NetBrain){angular.module("nb.qmap").controller("nb.qmap.mapSettingCtrl",mapSettingCtrl);mapSettingCtrl.$inject=["$scope","$rootScope","$timeout","nb.qmap.autoLinkOptionSrvc","nb.qmap.mapManagerSrvc","nb.netbrain.httpMapViewOptionSrvc","nb.qmap.mapViewOptionSrvc","nb.ng.userSrvc","nb.topo.httpExternNbrSrvc","nb.qmap.updateMapSrvc","nb.common.nbTipSrvc","nb.systemmodel.deviceTypeMainMgrSrvc"];function mapSettingCtrl($scope,$rootScope,$timeout,autoLinkOptionSrvc,mapManagerSrvc,httpMapViewOptionSrvc,mapViewOptionSrvc,userSrvc,httpExternNbrSrvc,updateMapSrvc,nbTipSrvc,deviceTypeMainMgrSrvc){var activePage=mapManagerSrvc.getActivePage();var activeMap=mapManagerSrvc.getActiveMap();var _index=0;var load=!0;var rowChangedTrigger=!1;function initCtrl(newActivePage){var ViewOption={};var currMapOption=newActivePage.getMapViewOptionJson();if(currMapOption)currMapOption=mapViewOptionSrvc.fromJson(currMapOption);else{var opJson=userSrvc.getUserConf().getJsWrapper().getMapViewOption();currMapOption=opJson?mapViewOptionSrvc.fromJson(opJson):mapViewOptionSrvc}var columnNames=[{field:"displayName",fieldDisplayName:"Data Unit"},{field:"scaleThreshold",fieldDisplayName:"Display Ratio"}];ViewOption.stepValue=currMapOption.convertDoubleToDisplayString(currMapOption.getZoomStep());ViewOption.zoomStepOption=NetBrain.Map.Const.MapViewOptionZoomStepOption;ViewOption.isNeatUp=currMapOption.getIsNeatUp();var displayNameKey=columnNames[0].field;var valueNameKey=columnNames[1].field;var dataToBeDisplay=currMapOption.getOptionNameArray();var rowInitSelState=[];var dataItemShowZoom={};for(var index=0;index<dataToBeDisplay.length;index++){var strItemName=dataToBeDisplay[index];dataItemShowZoom[strItemName]=currMapOption.getOptionScaleThresHoldByName(strItemName);rowInitSelState.push(currMapOption.isOneOptionDisplay(strItemName))}ViewOption.gridOptions={data:currMapOption.optionsList.options,enableCellEdit:!0,enableCellEditOnFocus:!0,enableRowSelection:!0,enableFullRowSelection:!1,enableSelectAll:!0,enableRowHeaderSelection:!0,selectionRowHeaderWidth:30,rowHeight:30,multiSelect:!0,modifierKeysToMultiSelect:!1,enableColumnMenus:!1,enableSorting:!1,enableHorizontalScrollbar:0,enableVerticalScrollbar:0,columnDefs:[{field:displayNameKey,displayName:columnNames[0].fieldDisplayName,enableCellEdit:!1,width:125},{field:valueNameKey,displayName:columnNames[1].fieldDisplayName,editableCellTemplate:"ui-grid/dropdownEditor",cellFilter:"mapZoomValue",editDropdownOptionsArray:NetBrain.Map.Const.MapViewOptionZoomRange,editDropdownIdLabel:"value",editDropdownValueLabel:"displayValue",width:100}]};$scope.initViewOptionData=function(scope,param){var setViewOption=function(selectedRows,flag){var length=selectedRows.length;for(var i=0;i<length;i++){var row=selectedRows[i];var strItemName1=row.entity[displayNameKey];if(flag)currMapOption.SetOneOptionDisplay(strItemName1,row.isSelected);else{currMapOption.SetOneOptionDisplay(strItemName1,!row.isSelected);row.setSelected(!row.isSelected)}}ViewOption.gridApi.selection.getSelectedGridRows().length===currMapOption.getOptionNameArray().length?ViewOption.gridApi.grid.selection.selectAll=!0:ViewOption.gridApi.grid.selection.selectAll=!1;ViewOption.OnOK();_index=0};var rows=param[0];if(_index===param[1])if(load){load=!1;setViewOption(rows,!0)}else updateMapSrvc.canUpdateCurrentMap().then((function(){setViewOption(rows,!0)}),(function(){setViewOption(rows)}))};var isLoading=!1;ViewOption.gridOptions.onRegisterApi=function(gridApi){ViewOption.gridApi=gridApi;gridApi.selection.on.rowSelectionChanged($scope,(function(row){rowChangedTrigger=!0;var rows=[row];isLoading||$scope.$evalAsync($scope.initViewOptionData,[rows,++_index])}));gridApi.selection.on.rowSelectionChangedBatch($scope,(function(rows){rowChangedTrigger=!0;isLoading||$scope.$evalAsync($scope.initViewOptionData,[rows,++_index])}));gridApi.edit.on.afterCellEdit($scope,(function(rowEntity,colDef,newValue,oldValue){if("scaleThreshold"===colDef.name&&newValue!==oldValue){var strItemName2=rowEntity[displayNameKey];updateMapSrvc.canUpdateCurrentMap().then((function(){currMapOption.setOptionScaleThresHoldByName(strItemName2,newValue);ViewOption.OnOK()}),(function(){currMapOption.setOptionScaleThresHoldByName(strItemName2,oldValue)}))}}))};$timeout((function(){isLoading=!0;for(var i=0;i<rowInitSelState.length;i++)rowInitSelState[i]&&isLoading&&$scope.ViewOption.gridApi.selection.selectRow($scope.ViewOption.gridOptions.data[i]);ViewOption.gridApi.selection.getSelectedGridRows().length===currMapOption.getOptionNameArray().length?ViewOption.gridApi.grid.selection.selectAll=!0:ViewOption.gridApi.grid.selection.selectAll=!1;$scope.ViewOption.finishGrid=!0;isLoading=!1}));$scope.checkNeatUp=function(){updateMapSrvc.canUpdateCurrentMap().then((function(){currMapOption.optionsList.isNeatUp=ViewOption.isNeatUp;activePage.setMapViewOptionJson(currMapOption.optionsList);activePage.getNetmapOperator().makeNeatMap(httpExternNbrSrvc,ViewOption.isNeatUp)}),(function(){ViewOption.isNeatUp=!ViewOption.isNeatUp}))};ViewOption.OnSetDefault=function(){updateMapSrvc.canUpdateCurrentMap().then((function(){!function(){if(null!=currMapOption||!ViewOption.isNeatUp){currMapOption.optionsList.isNeatUp=ViewOption.isNeatUp;httpMapViewOptionSrvc.upInsertMapViewOption(currMapOption.optionsList).then((function(){showSetAsDefaultSettingsSuccessTip();userSrvc.getUserConf().getJsWrapper().setMapViewOption(JSON.parse(JSON.stringify(currMapOption.optionsList)));ViewOption.OnOK()}))}}()}),(function(){}))};function showSetAsDefaultSettingsSuccessTip(){var options={tipInfo:NetBrain.Map.Message.SetAsDefaultSettingsSuccess,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip"};nbTipSrvc.open(options)}ViewOption.OnOK=function(){if(null!=currMapOption){activePage._diagram.commandHandler.setCusZoomSetp(currMapOption.getZoomStep());var mapOption=JSON.stringify(currMapOption.toJson());var mapOptionObj=JSON.parse(mapOption);activePage.setMapViewOptionJson(mapOptionObj);activePage.refreshMapViewOptionVisible();activePage.setModify(!0)}};ViewOption.OnChangeZoomStep=function(){if(null!=currMapOption&&!(null==$scope.ViewOption.stepValue||$scope.ViewOption.stepValue.length<=0)){var setZoomStep=function(newStepValue){var dZoomStep=currMapOption.convertDisplayStringToDouble(newStepValue);if(currMapOption.getZoomStep()!=dZoomStep){currMapOption.setZoomStep(dZoomStep);ViewOption.OnOK();$rootScope.$broadcast(netMapEvent.setZoomStep,[dZoomStep])}};if(activeMap.isLock()&&!load)updateMapSrvc.canUpdateCurrentMap().then((function(){var viewStepValue=$scope.ViewOption.stepValue;setZoomStep(viewStepValue)}),(function(){var oldStepValue=$scope.oldObj.oldStepValue;$scope.ViewOption.stepValue=oldStepValue;setZoomStep(oldStepValue)}));else{var stepValue=$scope.ViewOption.stepValue;setZoomStep(stepValue)}}};$scope.ViewOption=ViewOption;var CurTopoTypeListObject={};CurTopoTypeListObject.allTopoTypeLinkList=[];angular.copy(autoLinkOptionSrvc.getTopoTypesList(),CurTopoTypeListObject.allTopoTypeLinkList);var AutoLinkOption={};AutoLinkOption.topoTypesList=autoLinkOptionSrvc.getCurPageTopoTypesList(CurTopoTypeListObject);var lsUserDefaultTopoTypes=userSrvc.getUserConf().getJsWrapper().getMapAutoLinkOptionList(getVspaceIdByPage(activePage));var lsCurrPageAutoLinkTopoTypes=activePage.getMapAutoLinkOptionList(getVspaceIdByPage(activePage));var lsTopoLinkTypesToCheck=lsCurrPageAutoLinkTopoTypes||lsUserDefaultTopoTypes;if(lsTopoLinkTypesToCheck)for(var z=0;z<AutoLinkOption.topoTypesList.length;z++){var tpType=AutoLinkOption.topoTypesList[z];_.indexOf(lsTopoLinkTypesToCheck,tpType.id)>=0&&(AutoLinkOption.topoTypesList[z].checked=!0)}AutoLinkOption.OnSetDefault=function(){updateMapSrvc.canUpdateCurrentMap().then((function(){!function(){var topoLinkGuids=[];angular.forEach($scope.AutoLinkOption.topoTypesList,(function(item){item.checked&&topoLinkGuids.push(item.id)}));autoLinkOptionSrvc.setAsDefaultIsExcluedeMip(getVspaceIdByPage(activePage),AutoLinkOption.isExcluedeMip).then((function(ret){if(null!=ret){activePage.setMapAutoLinkOptionExcluedeMip(AutoLinkOption.isExcluedeMip);userSrvc.getUserConf().getJsWrapper().setMapAutoLinkOptionExcluedeMip(getVspaceIdByPage(activePage),AutoLinkOption.isExcluedeMip);autoLinkOptionSrvc.setAsDefault(getVspaceIdByPage(activePage),topoLinkGuids).then((function(data){if(data){showSetAsDefaultSettingsSuccessTip();activePage.setMapAutoLinkOptionList(topoLinkGuids,getVspaceIdByPage(activePage));userSrvc.getUserConf().getJsWrapper().setMapAutoLinkOptionList(topoLinkGuids||[])}}))}}))}()}))};AutoLinkOption.OnOK=function(){function setMapAutoLinkOptionList(topoTypesList){var topoLinkGuids=[];angular.forEach(topoTypesList,(function(item){item.checked&&topoLinkGuids.push(item.id)}));activePage.setMapAutoLinkOptionList(topoLinkGuids,getVspaceIdByPage(activePage))}updateMapSrvc.canUpdateCurrentMap().then((function(){setMapAutoLinkOptionList($scope.AutoLinkOption.topoTypesList);activePage.setModify(!0)}),(function(){if(!_.isEmpty($scope.oldObj.oldTopoTypeList)){$scope.AutoLinkOption.topoTypesList=angular.copy($scope.oldObj.oldTopoTypeList);setMapAutoLinkOptionList($scope.AutoLinkOption.topoTypesList)}}))};AutoLinkOption.isExcluedeMip=activePage.getMapAutoLinkOptionExcluedeMip();if(activePage.getNew()){var defMapAutoLinkOptionExcluedeMip=userSrvc.getUserConf().getJsWrapper().getMapAutoLinkOptionExcluedeMip();if(defMapAutoLinkOptionExcluedeMip){var vsId=getVspaceIdByPage(activePage);AutoLinkOption.isExcluedeMip=defMapAutoLinkOptionExcluedeMip[vsId]}}AutoLinkOption.ExcluedeMipOK=function(){updateMapSrvc.canUpdateCurrentMap().then((function(){activePage.setMapAutoLinkOptionExcluedeMip(AutoLinkOption.isExcluedeMip);activePage.setModify(!0)}))};var rootScopeonmapLockStatusChanged=$rootScope.$on("mapLockStatusChanged",(function(){$scope.oldObj.oldTopoTypeList=angular.copy($scope.AutoLinkOption.topoTypesList);$scope.oldObj.oldZoomStep=currMapOption.getZoomStep();$scope.oldObj.oldViewOption=activePage.getMapViewOptionJson();$scope.oldObj.oldStepValue=angular.copy($scope.ViewOption.stepValue)}));$scope.oldObj={oldTopoTypeList:angular.copy(AutoLinkOption.topoTypesList),oldZoomStep:currMapOption.getZoomStep(),oldViewOption:activePage.getMapViewOptionJson(),oldStepValue:angular.copy(ViewOption.stepValue)};$timeout((function(){rowChangedTrigger||(load=!1)}));$scope.AutoLinkOption=AutoLinkOption;httpExternNbrSrvc.getAutoLinkTypeByVisualSpaceId(getVspaceIdByPage(activePage)).then((function(result){if(null==result)return null;$rootScope.$emit(mapEvent.mapVisualSpaceChanged,result.topoLinkList)}));var DeviceBorderOption={};DeviceBorderOption.deviceTypeList=[];var needCategorys=NetBrain.Map.Const.NeedShowDeviceBorders;var allDeviceTypes=deviceTypeMainMgrSrvc.getDeviceMainTypeObjList();var deviceTypes=_.filter(needCategorys,(function(item){var pluckAllDeviceTypes=_.pluck(allDeviceTypes,"data");var hasId=_.contains(_.pluck(pluckAllDeviceTypes,"ID"),item.id);var hasName=_.contains(_.pluck(pluckAllDeviceTypes,"name"),item.name);return hasId&&hasName}));var l3StyleInExpandedStyle=userSrvc.getUserConf().getJsWrapper().getUserL3StyleInExpandedStyle();var currDbOption=null;var currMapDbOption=newActivePage.getL3StyleInExpandedStyle();var currUserDbOption=null;l3StyleInExpandedStyle&&_.isArray(l3StyleInExpandedStyle)&&(currUserDbOption=l3StyleInExpandedStyle);currDbOption=currMapDbOption||(currUserDbOption||NetBrain.Map.Const.getL3StyleInExpandedStyle());var deviceTypeList=[];for(var i=0;i<deviceTypes.length;i++){var item=deviceTypes[i];var deviceType={id:item.id,name:item.name,isCheck:!0};for(var j=0;j<currDbOption.length;j++)if(currDbOption[j].toString()===deviceType.id.toString()){deviceType.isCheck=!1;break}deviceTypeList.push(deviceType)}DeviceBorderOption.deviceTypeList=deviceTypeList;DeviceBorderOption.OnClickCheckBox=function(event,clickDeviceType){var checkIdList=[];for(var k=0;k<DeviceBorderOption.deviceTypeList.length;k++){var dTypeItem=DeviceBorderOption.deviceTypeList[k];!1===dTypeItem.isCheck&&checkIdList.push(dTypeItem.id.toString())}newActivePage.setL3StyleInExpandedStyle(checkIdList);newActivePage.isL2MapStyle()&&newActivePage.refreshMapWithViewStyle(clickDeviceType.id);newActivePage.setModify(!0)};var currIntfHighlightMode=newActivePage.getInterfaceHighlightMode();_.isNumber(currIntfHighlightMode)||(currIntfHighlightMode=userSrvc.getUserConf().getJsWrapper().getUserInterfaceHighlightMode());var interfaceHighlightModeList=_.map(NetBrain.Map.Const.InterfaceHighlightModeList,(function(item){return{id:item.id,name:item.name}}));DeviceBorderOption.currIntfHighlightMode=currIntfHighlightMode;DeviceBorderOption.interfaceHighlightModeList=interfaceHighlightModeList;DeviceBorderOption.OnChangeIntfHighlightMode=function(event,mode){newActivePage.changeIntfHighlightMode(mode.id)};DeviceBorderOption.OnSetDefault=function(event){var checkIdList=[];for(var k=0;k<DeviceBorderOption.deviceTypeList.length;k++){var dTypeItem=DeviceBorderOption.deviceTypeList[k];!1===dTypeItem.isCheck&&checkIdList.push(dTypeItem.id.toString())}var highlightMode=DeviceBorderOption.currIntfHighlightMode;updateMapSrvc.canUpdateCurrentMap().then((function(){httpMapViewOptionSrvc.upInsertL3StyleInExpandedStyle({l3StyleInExpandedStyle:checkIdList,highlightMode:highlightMode}).then((function(result){if(result){userSrvc.getUserConf().getJsWrapper().setUserL3StyleInExpandedStyle(checkIdList);userSrvc.getUserConf().getJsWrapper().setUserInterfaceHighlightMode(highlightMode);showSetAsDefaultSettingsSuccessTip()}}))}),(function(){}))};$scope.DeviceBorderOption=DeviceBorderOption;$scope.$on("$destroy",(function(){rootScopeonmapLockStatusChanged()}))}function getVspaceIdByPage(Page){if(null==Page)return null;var info=Page.getVisualSpaceInfo();return null==info?VisualSpaceConstant.defaultVisualSpaceInstanceId:info.visualSpaceInstanceId}initCtrl(activePage);$scope.onClose=function(){$rootScope.$emit("closeMapSettings")};$rootScope.$on(mapEvent.mapVisualSpaceChanged,(function(event,lsTopoTypes){$scope.AutoLinkOption.topoTypesList=autoLinkOptionSrvc.getTopoTypesList(lsTopoTypes);var vsId=getVspaceIdByPage(activePage);var lsVsSelectTopoTypes=null;if(vsId){lsVsSelectTopoTypes=activePage.getMapAutoLinkOptionList(vsId);if(vsId&&lsVsSelectTopoTypes)for(var z=0;z<$scope.AutoLinkOption.topoTypesList.length;z++){var tpType=$scope.AutoLinkOption.topoTypesList[z];_.indexOf(lsVsSelectTopoTypes,tpType.id)>=0&&($scope.AutoLinkOption.topoTypesList[z].checked=!0)}}}))}}(NetBrain);!function(netBrain){angular.module("nb.qmap").controller("nb.qmap.mapHighlightLegendCtrl",mapHighlightLegendCtrl);mapHighlightLegendCtrl.$inject=["$scope","$element","$timeout","nb.qmap.randomColorSrvc"];function mapHighlightLegendCtrl($scope,$element,$timeout,randomColorSrvc){$scope.legendClickShow=!0;$scope.randomColorSrvc=randomColorSrvc;$scope.linkType=_.union(_.map(_.values(netBrain.Map.Const.LinkType),(function(num){return num.toString()})),[null]);var defaultNetMapLegend={devHighlightLegend:{name:"device",list:[]},linkHighlightLegend:{name:"link",list:[]},interfaceHighlightLegend:{name:"interface",list:[]},intfMonitorLegend:[],devMonitorLegend:[],dataUnitMonitorLegend:[]};function resizeBox(isShow){!1===isShow&&$timeout((function(){$element.parent().css("background-color","#fefefe");$element.parent().parent().css("background-color","#fefefe");$timeout((function(){$element.parent().css("background-color","");$element.parent().parent().css("background-color","")}),500)}),0)}$scope.closeOperContent=function(){$scope.legendClickShow=!$scope.legendClickShow;resizeBox($scope.legendClickShow)};$scope.$on("netMapHighlightChanged",(function(event){event.preventDefault()}));$scope.generalColorPickOptions={preferredFormat:"hex",color:"black",showPaletteOnly:!0,togglePaletteOnly:!0,cancelText:"Cancel",chooseText:"Choose",togglePaletteMoreText:"More",togglePaletteLessText:"Less",hideAfterPaletteSelect:!0,showInput:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]]};$scope.isClosing=!1;$scope.$on("$destroy",(function(){$scope.isClosing=!0}));$scope.fontColorChanged=function(acolor,legendName,categoryName){var newColor=randomColorSrvc.getIntColor(acolor);"device"===categoryName&&$scope.netMapLegend.devHighlightLegend.list.forEach((function(item){if(legendName===getLegendName(item)){$scope.netmap.getNetmapOperator().setDeviceHighlightColor(legendName,newColor);item.color=acolor}}));"link"===categoryName&&$scope.netMapLegend.linkHighlightLegend.list.forEach((function(item){if(legendName===getLegendName(item)){$scope.netmap.getNetmapOperator().setNeighborHighlightColor(legendName,newColor);item.color=acolor}}));"interface"===categoryName&&$scope.netMapLegend.interfaceHighlightLegend.list.forEach((function(item){if(!item.unchangeable&&legendName===getLegendName(item)){$scope.netmap.getNetmapOperator().setLinkHighlightColor(legendName,newColor);$scope.netmap.getNetmapOperator().setPortHighlightColor(legendName,newColor);item.color=acolor}}))};$scope.clearAllLegend=function(){$scope.netMapLegend=angular.copy(defaultNetMapLegend);$scope.l2TopoLinkLegend={name:"l2TopoLink",list:[]};resizeBox(!1)};$scope.getLegendName=getLegendName;var setNetMapLegendEvent=null;$scope.$on("setNetMapLegend",(function(){$timeout.cancel(setNetMapLegendEvent);setNetMapLegendEvent=$timeout(setNetMapLegend,1e3)}));!function(){$scope.l2TopoLinkLegend={name:"l2TopoLink",list:[]};$scope.netmap.getMapLegend()||$scope.netmap.setMapLegend(defaultNetMapLegend);$scope.netMapLegend=$scope.netmap.getMapLegend();!function(){if(!$scope.netMapLegend)return;$scope.netMapLegend.interfaceHighlightLegend&&$scope.netMapLegend.interfaceHighlightLegend.list.forEach((function(item){void 0===item.unchangeable&&(item.unchangeable=!1);void 0===item.checked&&(item.checked=!0)}));$scope.netMapLegend.devHighlightLegend&&$scope.netMapLegend.devHighlightLegend.list.forEach((function(item){void 0===item.checked&&(item.checked=!0)}))}();refreshCheckbox()}();function getLegendName(obj){return obj?obj.legendName||obj.legend:""}function addToLegendList(legendObj,newlegendObj,option){if(legendObj&&newlegendObj){var arr=legendObj.list;(function(arr,legendName){return!!Array.isArray(arr)&&_.any(arr,(function(item){return getLegendName(legendName)===getLegendName(item)}))})(arr,newlegendObj)||(option&&option.TwoNodeExisted,Array.isArray(arr)&&arr.push(newlegendObj))}}function setHighlightDevice(node){if(netBrain.Map.CategoryMgr.isNetworkDevice(node.getCategory())){var list=node.getHighlightDataList();if(!list)return;var listLength=list.length;for(var j=0;j<listLength;j++){var newData={legendName:getLegendName(highLightData=list[j]),color:BindHelper.colorToStringForDevice(highLightData),checked:!0};addToLegendList($scope.netMapLegend.devHighlightLegend,newData)}}var highLightData}function setHighlightInterfaceFromNode(node){if(netBrain.Map.CategoryMgr.isNetworkDevice(node.getCategory())){var nodeLegendList=node.getIntfInfoHighlightList();nodeLegendList&&0!==nodeLegendList.length&&setHighlightInterface(nodeLegendList)}}function setHighlightInterfaceFromLink(oneLink){if(netBrain.Map.CategoryMgr.isTopolink(oneLink.category)){var srcList=oneLink.getHighlightDataListSrc();var destList=oneLink.getHighlightDataListDest();var linkLegendList=[];if(srcList&&destList)linkLegendList=srcList.concat(destList);else if(srcList)linkLegendList=srcList;else{if(!destList)return;linkLegendList=destList}setHighlightInterface(linkLegendList)}}function setHighlightInterface(mapLegendList){!function(nodeList){var length=nodeList.length;for(var j=0;j<length;j++){var newData=(node=nodeList[j],{color:BindHelper.colorToStringForInterface(node),width:node.thickness,type:node.lineType,legendName:getLegendName(node),checked:!0,unchangeable:!1});addToLegendList($scope.netMapLegend.interfaceHighlightLegend,newData)}var node}(mapLegendList)}function setLinkPolicyLegend(topoLink){if(topoLink&&netBrain.Map.CategoryMgr.isTopolink(topoLink.category)){addIntfLegend(NgUtil.getValueFromObjAndPath(topoLink,"policyStyle.src.line"));addIntfLegend(NgUtil.getValueFromObjAndPath(topoLink,"policyStyle.dest.line"))}function addIntfLegend(style){if(style&&style.isCreateLegend&&$scope.l2TopoLinkLegend){var strokeDashArray=style.strokeDashArray;_.isArray(strokeDashArray)&&(strokeDashArray=strokeDashArray.toString());var legendObj={strokeDashArray:strokeDashArray,type:strokeDashArray.replace(/\,/g,""),legendName:style.name,color:style.stroke,width:8,isCustomStyle:!0,unchangeable:!0,checked:!1};addToLegendList($scope.l2TopoLinkLegend,legendObj)}}}function setHighlightNeighbor(oneLink,nodeList,nodeListLength){if(!(nodeListLength<=1)&&oneLink){var fromNode=_.find(nodeList,(function(node){return node.key===oneLink.from}));var toNode=_.find(nodeList,(function(node){return node.key===oneLink.to}));if(netBrain.Map.CategoryMgr.isHighlightNeighborLink(oneLink.category)){var newData=(link=oneLink,{color:BindHelper.colorToStringForhigHightNeighbor(link),width:link.width,type:link.type,legendName:getLegendName(link)});var link;addToLegendList($scope.netMapLegend.linkHighlightLegend,newData,{TwoNodeExisted:fromNode&&toNode})}}}function convertPosListToArray(devPosList){var posList=_.filter(devPosList,(function(pos){return"overflowPos"!==pos.posName}));var overflowPos=_.findWhere(devPosList,{posName:"overflowPos"});var overflowList=[];overflowPos&&(overflowList=overflowPos.extraData.overflowList);return _.union(posList,overflowList)}function setdevMonitorLegend(node){$scope.netMapLegend.devMonitorLegend.length>0||node.dataViewData&&node.dataViewData.devColorSchema&&node.dataViewData.devColorSchema.status&&($scope.netMapLegend.devMonitorLegend=[{id:1,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Error),legend:"Error",icon:"Error-monitor-legend-color-icon"},{id:2,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Warning),legend:"Warning",icon:"Warning-monitor-legend-color-icon"},{id:3,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Normal),legend:"No Alerts",icon:"No-monitor-legend-color-icon"}])}function setintfMonitorLegend(link){$scope.netMapLegend.intfMonitorLegend.length>0||link.intfSrc&&link.intfSrc.intfInfo&&link.intfSrc.intfInfo.intfColorSchema&&link.intfSrc.intfInfo.intfColorSchema.status&&($scope.netMapLegend.intfMonitorLegend=[{id:1,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Error),legend:"Error"},{id:2,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Warning),legend:"Warning"},{id:3,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Normal),legend:"No Alerts"}])}function setdataUnitMonitorLegendForLink(link,requrieEmitDataUnitLegend){try{if($scope.netMapLegend.dataUnitMonitorLegend.length>0)return!1;if(requrieEmitDataUnitLegend)return!0;if(!netBrain.Map.CategoryMgr.isTopolink(link.category))return!1;var linkSrc=link.getIntfSrc();var linkDeviceKey="";if(linkSrc&&linkSrc.intfInfo&&linkSrc.intfInfo.intfPosList){if(_.some(convertPosListToArray(linkSrc.intfInfo.intfPosList),(function(item){return void 0!==item.posInfo&&item.posInfo.displayInfo&&item.posInfo.dataUnitList&&void 0!==item.posInfo.dataUnitList[0]&&item.posInfo.dataUnitList[0].alarm>0}))){requrieEmitDataUnitLegend=!0;linkDeviceKey=link.getDevIdSrc()}}var linkDest=link.getIntfDest();if(!requrieEmitDataUnitLegend&&linkDest&&linkDest.intfInfo&&linkDest.intfInfo.intfPosList){if(_.some(convertPosListToArray(linkDest.intfInfo.intfPosList),(function(item){return void 0!==item.posInfo&&item.posInfo.displayInfo&&item.posInfo.dataUnitList&&void 0!==item.posInfo.dataUnitList[0]&&item.posInfo.dataUnitList[0].alarm>0}))){requrieEmitDataUnitLegend=!0;linkDeviceKey=link.getDevIdSrc()}}if(requrieEmitDataUnitLegend){var node=NetBrain.Map.currentActiveMapPage.getNetmapOperator().getCompDeviceByKey(linkDeviceKey);node.dataViewData&&node.dataViewData.templateId?$scope.netMapLegend.dataUnitMonitorLegend=[{id:1,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Error),legend:"Golden Baseline Alert"}]:$scope.netMapLegend.dataUnitMonitorLegend=[{id:1,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Error),legend:"Error"},{id:2,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Warning),legend:"Warning"}];return!0}}catch(err){console.warn(err)}}function setdataUnitMonitorLegend(node,requrieEmitDataUnitLegend){if($scope.netMapLegend.dataUnitMonitorLegend.length>0)return!1;if(requrieEmitDataUnitLegend)return!0;if(node.getIntfInfoList){var intfInfoList=node.getIntfInfoList();var intfInfoListLength=intfInfoList.length;for(var i=0;i<intfInfoListLength;i++){var intfInfo=intfInfoList[i];if(intfInfo.intfPosList){if(_.some(convertPosListToArray(intfInfo.intfPosList),(function(item){return void 0!==item.posInfo&&item.posInfo.displayInfo&&item.posInfo.dataUnitList&&void 0!==item.posInfo.dataUnitList[0]&&item.posInfo.dataUnitList[0].alarm>0}))){requrieEmitDataUnitLegend=!0;break}}}}if(!requrieEmitDataUnitLegend){if(!node.getPosList)return!1;var posList=convertPosListToArray(node.getPosList());if(!posList)return!1;var posListLength=posList.length;for(var j=0;j<posListLength;j++){var pos=posList[j];if(void 0!==pos.posInfo&&pos.posInfo.displayInfo&&pos.posInfo.dataUnitList&&void 0!==pos.posInfo.dataUnitList[0]&&pos.posInfo.dataUnitList[0].alarm>0){requrieEmitDataUnitLegend=!0;break}}}if(requrieEmitDataUnitLegend){node.dataViewData&&node.dataViewData.templateId?$scope.netMapLegend.dataUnitMonitorLegend=[{id:1,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Error),legend:"Golden Baseline Alert"}]:$scope.netMapLegend.dataUnitMonitorLegend=[{id:1,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Error),legend:"Error"},{id:2,color:randomColorSrvc.parseColor(NetBrain.Map.Const.Color.Warning),legend:"Warning"}];return!0}return!1}function setNetMapLegend(netmap){if(!$scope.isClosing){$scope.clearAllLegend();netmap||(netmap=$scope.netmap);var nodeList=netmap._getAllDevices();var nodeListLength=nodeList.length;var requrieEmitDataUnitLegend=!1;for(var i=0;i<nodeListLength;i++){var node=nodeList[i];setHighlightDevice(node);setHighlightInterfaceFromNode(node);setdevMonitorLegend(node);requrieEmitDataUnitLegend||(requrieEmitDataUnitLegend=setdataUnitMonitorLegend(node,requrieEmitDataUnitLegend))}var linkList=netmap._model.linkDataArray;var linkLength=linkList.length;for(var j=0;j<linkLength;j++){var link=_.clone(linkList[j]);setintfMonitorLegend(link);setHighlightInterfaceFromLink(link);requrieEmitDataUnitLegend||(requrieEmitDataUnitLegend=setdataUnitMonitorLegendForLink(link,requrieEmitDataUnitLegend));setLinkPolicyLegend(link);setHighlightNeighbor(link,nodeList,nodeListLength)}$scope.netMapLegend.interfaceHighlightLegend&&$scope.l2TopoLinkLegend&&($scope.netMapLegend.interfaceHighlightLegend.list=_.union($scope.netMapLegend.interfaceHighlightLegend.list,$scope.l2TopoLinkLegend.list));netmap.setMapLegend($scope.netMapLegend);refreshCheckbox()}}$scope.onShowOrHideDeviceLegend=function(lsItems){if(lsItems&&0!==lsItems.length){var diagram=$scope.netmap._diagram;var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("onShowOrHideDeviceLegend");diagram.startTransaction(transactionName);var isChecked=lsItems[0].checked;var lsNames=lsItems.map((function(item){return item.legendName}));$scope.netmap._getAllDevices().forEach((function(node){var lsNodeHighlights=node.getHighlightDataList();lsNodeHighlights&&0!==lsNodeHighlights.length&&lsNodeHighlights.forEach((function(item){lsNames.includes(item.legendName)&&(item.isHide=!isChecked)}))}));diagram.updateAllTargetBindings();$scope.netmap.refreshMapViewOptionVisible();diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;$scope.netmap.setModify(!0);$scope.netmap.setMapLegend($scope.netMapLegend);refreshCheckbox();$scope.netmap.removeAllLinkHighlightFlag();$scope.netmap.refreshMapViewOptionVisible()}};$scope.onShowOrHideInterfaceLegend=function(lsItems){if(lsItems&&0!==lsItems.length){var diagram=$scope.netmap._diagram;var oldskip=diagram.skipsUndoManager;diagram.skipsUndoManager=!0;var transactionName=NgUtil.getUniqueStr("onShowOrHideInterfaceLegend");diagram.startTransaction(transactionName);var highLegends=_.filter(lsItems,(function(item){return!item.unchangeable}));if(0!==highLegends.length){var isChecked=highLegends[0].checked;var lsNames=lsItems.map((function(item){return item.legendName}));$scope.netmap._getAllTopoLink().forEach((function(oneLink){var srcList=oneLink.getHighlightDataListSrc();!srcList||srcList.length;srcList.forEach((function(item){lsNames.includes(item.legendName)&&(item.isHide=!isChecked)}));var destList=oneLink.getHighlightDataListDest();!destList||destList.length;destList.forEach((function(item){lsNames.includes(item.legendName)&&(item.isHide=!isChecked)}))}));$scope.netmap._getAllDevices().forEach((function(nodeData){if(netBrain.Map.CategoryMgr.isNetworkDevice(nodeData.category)){var highlightList=nodeData.getIntfInfoHighlightList();_.each(highlightList,(function(hl){lsNames.includes(hl.legendName)&&(hl.isHide=!isChecked)}))}}));$scope.netmap.removeAllLinkHighlightFlag();$scope.netmap.refreshMapViewOptionVisible();diagram.updateAllTargetBindings();(new netBrain.Map.LinkLableLayoutTool).LayOut(diagram);diagram.commitTransaction(transactionName);diagram.skipsUndoManager=oldskip;$scope.netmap.setModify(!0);$scope.netmap.setMapLegend($scope.netMapLegend);refreshCheckbox()}}};$scope.onShowOrHideAllDeviceLegend=function(){if($scope.netMapLegend.devHighlightLegend&&$scope.netMapLegend.devHighlightLegend.list){$scope.netMapLegend.devHighlightLegend.list.forEach((function(item){item.isHide=!$scope.isShowAllDeviceLegend;item.checked=$scope.isShowAllDeviceLegend}));$scope.onShowOrHideDeviceLegend($scope.netMapLegend.devHighlightLegend.list)}};$scope.onShowOrHideAllInterfaceLegend=function(){if($scope.netMapLegend.interfaceHighlightLegend&&$scope.netMapLegend.interfaceHighlightLegend.list){$scope.netMapLegend.interfaceHighlightLegend.list.forEach((function(item){if(!item.unchangeable){item.isHide=!$scope.isShowAllInterfaceLegend;item.checked=$scope.isShowAllInterfaceLegend}}));$scope.onShowOrHideInterfaceLegend($scope.netMapLegend.interfaceHighlightLegend.list)}};function refreshCheckbox(){!function(){var devHighlightLegend=$scope.netMapLegend.devHighlightLegend;if(devHighlightLegend){var list=devHighlightLegend.list;if(list&&0===list.length)setDevValue(!1,!1);else{setDevValue(!_.some(devHighlightLegend.list,(function(item){return!item.checked})),!0)}}else setDevValue(!1,!1);function setDevValue(show,showCheckbox){$scope.isShowAllDeviceLegend=show;$scope.isShowAllDevCheckbox=showCheckbox}}();!function(){var interfaceHighlightLegend=$scope.netMapLegend.interfaceHighlightLegend;if(interfaceHighlightLegend){var list=interfaceHighlightLegend.list;if(list&&0===list.length)setIntfValue(!1,!1);else{if(_.every(interfaceHighlightLegend.list,(function(item){return item.unchangeable})))setIntfValue(!1,!1);else{setIntfValue(!_.some(interfaceHighlightLegend.list,(function(item){if(!item.unchangeable)return!item.checked})),!0)}}}else setIntfValue(!1,!1);function setIntfValue(show,showCheckBox){$scope.isShowAllInterfaceLegend=show;$scope.isShowAllIntfCheckbox=showCheckBox}}()}}}(NetBrain);!function(netbrain){angular.module("nb.qmap").service("nb.qmap.drillDownLabelSrvc",drillDownLabelSrvc);drillDownLabelSrvc.$inject=["$document","$rootScope","$uibModal","nb.ng.httpAuthSrvc","nb.systemmodel.httpDeviceSchemaSrvc","nb.qapp.qappResultSrvc","nb.qmap.nbBubbleSrvc","nb.ng.httpDownloadingSrvc","nb.ng.utilitySrvc","$q","nb.dataview.httpDataViewSrvc","nb.netbrain.httpDeviceSrvc"];function drillDownLabelSrvc($document,$rootScope,$uibModal,httpAuthSrvc,httpDeviceSchemaSrvc,qappResultSrvc,nbBubbleSrvc,httpDownloadingSrvc,utilitySrvc,$q,httpDataViewSrvc,httpDeviceSrvc){var myScope;var dic={uSrcGDR:calByUnitType_Others,uSrcQapp:function(){ValueTypeCalCulator(myScope.dataUnitObj.valueType);if(myScope.posObj.posInfo&&myScope.otherInfoForTimeLine){if(!_.contains(netbrain.Map.Const.SuportChartValueType,myScope.dataUnitObj.valueType))return!1;var info={mapPageId:myScope.mapScope.netmap.getDocId(),dataViewInfo:myScope.otherInfoForTimeLine.dataViewInfo,deviceId:myScope.otherInfoForTimeLine.deviceId,titleName:myScope.otherInfoForTimeLine.titleName,interfaceId:myScope.otherInfoForTimeLine.interfaceId,unitList:_.filter(myScope.otherInfoForTimeLine.dataUnitList,(function(unitObj){var valueType=unitObj.valueType;return _.contains(netbrain.Map.Const.SuportChartValueType,valueType)})),currentUnit:myScope.dataUnitObj};info.onlyKey=info.interfaceId?info.deviceId+"-"+info.interfaceId:info.deviceId;info.titleType=info.interfaceId?"Interface":"Device";return!0}if(myScope.posObj.posInfo)return!0},uSrcCustomized:calByUnitType_Others,uSrcParserLibrary:calByUnitType_USrcParserLibrary,uSrcDeviceData:calByUnitType_Others,uSrcAPI:calByUnitType_USrcParserLibrary};var valueTypeSolveDic={uString:calByDataUnitValueType_uString,string:calByDataUnitValueType_uString,uFloat:calByDataUnitValueType_uNumber,uBool:calByDataUnitValueType_uNumber,uInt:calByDataUnitValueType_uNumber,uParagraph:function(){$uibModal.open({templateUrl:"modules/nbDataView/views/EditDataView/formatNotePopup.html",controller:"nb.dataview.formatNotePopupCtrl",windowClass:"formatNotePopup formatNotePopupForText",backdrop:"static",resolve:{args:function(){var vEJ=myScope.dataUnitObj.valueExpr;if(vEJ){var title=vEJ.getTitle?vEJ.getTitle():vEJ.title;var devName=myScope.relatedNode?myScope.relatedNode.hostName:"";title&&devName&&(title=title+" of "+devName);return{isEditMode:!1,title:title,titleOrigText:vEJ.getTitleOrigText?vEJ.getTitleOrigText():vEJ.titleOrigText,content:vEJ.getContent?vEJ.getContent():vEJ.content,contentOrigText:vEJ.getContentOrigText?vEJ.getContentOrigText():vEJ.contentOrigText}}return null}}});return!0},uConfigLet:function(){return!0},uTable:function(){myScope.dataUnitObj.type===DataUnitSourceType.uSrcQapp?myScope.dataUnitObj.valueExpr&&qappResultSrvc.openQappMonitorDataTableDialog({id:myScope.dataUnitObj.valueExpr.content,name:myScope.dataUnitObj.displayName,deviceName:myScope.target.hostName}):myScope.dataUnitObj.type===DataUnitSourceType.uSrcGDR&&myScope.dataUnitObj.valueType===DataUnitType.uList?ValueTypeCalCulator(DataUnitType.uList):ValueTypeCalCulator(DataUnitType.uConfigFile)},uObject:function(){$uibModal.open({templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",backdrop:"static",resolve:{args:function(){var args={};args.isSideBySideList=!0;args.schemaDisplayName=myScope.dataUnitObj.displayName;args.deviceData={uploadDate:myScope.dataUnitObj.deviceMetadata.time,name:myScope.dataUnitObj.deviceMetadata.name,subName:myScope.dataUnitObj.valueExpr};args.sourceType=myScope.dataUnitObj.deviceMetadata.sourceType;args.isDeviceProperty=myScope.isDeviceLabel;args.isLinkProperty=myScope.isLinkLabel;var valueExpr1=myScope.dataUnitObj.valueExpr;args.deviceId=valueExpr1.deviceId;args.schemaId=valueExpr1.schemaId;if(myScope.isLinkLabel){args.intfKeySchema=valueExpr1.intfKeySchema;args.intfKeySchemaValue=valueExpr1.intfKeySchemaValue}return args}}});return!0},uList_primitive_subtype:calByDataUnitValueType_uList_object_subtype_uList_primitive_subtype,uList_object_subtype:calByDataUnitValueType_uList_object_subtype_uList_primitive_subtype,uConfigFile:function(){$uibModal.open({templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",backdrop:"static",resolve:{args:function(){var args={};args.currTenantDomain=httpAuthSrvc.getDataSrc();args.deviceHostname=myScope.target.hostName;args.deviceType=myScope.target.devType;args.isDataTable=myScope.dataUnitObj.valueType===DataUnitType.uTable;args.isConfigFile=myScope.dataUnitObj.valueType===DataUnitType.uConfigFile;args.deviceData={uploadDate:myScope.dataUnitObj.deviceMetadata?myScope.dataUnitObj.deviceMetadata.time:"",name:myScope.dataUnitObj.deviceMetadata?myScope.dataUnitObj.deviceMetadata.name:"",subName:myScope.dataUnitObj.valueExpr};args.sourceType=myScope.dataUnitObj.deviceMetadata?myScope.dataUnitObj.deviceMetadata.sourceType:"";var valueExpr=myScope.dataUnitObj.valueExpr;args.deviceId=valueExpr.deviceId;args.dataType=valueExpr.dataType;args.dataName=valueExpr.dataName;args.vrf=valueExpr.vrf;switch(args.dataType){case DeviceDataType.RouteTable:args.isRouteTable=!0;break;case DeviceDataType.ArpTable:args.isArpTable=!0;break;case DeviceDataType.NctTable:args.isNctTable=!0}return args}}});return!0},uHyperLink:function(){var hyperLinkValueExpr=myScope.dataUnitObj.valueExpr;hyperLinkValueExpr.getLink?window.open(hyperLinkValueExpr.getLink(),"_blank"):window.open(hyperLinkValueExpr.hyperlink,"_blank");return!0},uDoc:function(){var valueExpr=myScope.dataUnitObj.valueExpr;if(valueExpr){var fileGuid=valueExpr.getFileGuid?valueExpr.getFileGuid:valueExpr.guid;var fileName=valueExpr.getFileName?valueExpr.getFileName():valueExpr.name;var dataSrc=httpAuthSrvc.getDataSrc();var tenantGuid=dataSrc.TenantGuid;var domainGuid=dataSrc.DomainGuid[0];var downloadUrl=netbrain.NG.ConfigSettings.API_ROOT+"dataview/attchment/"+fileGuid;httpDownloadingSrvc.getTicket().then((function(ticketData){downloadUrl+="?dl_ticket="+ticketData+"&TenantGuid="+tenantGuid+"&DomainGuid="+domainGuid+"&FileName="+fileName;httpDownloadingSrvc.downloadFile(downloadUrl);return!0}))}},uCompoundVar:function(){},uPercent:calByDataUnitValueType_uNumber,uParserTable:function(){if(myScope.dataUnitObj.type===DataUnitSourceType.uSrcAPI&&myScope.dataUnitObj.valueType!==DataUnitType.uParserTable)return!1;$uibModal.open({templateUrl:"modules/nbDataView/views/parserLibraryDataTable.html",controller:"nb.dataview.parserLibraryDataTableCtrl",backdrop:"static",size:"sm",windowClass:"parser-library-datatable",resolve:{args:function(){return{dataUnitObj:myScope.dataUnitObj,device:myScope.target,dataViewId:myScope.posObj.dataViewId}}}})},uList:function(){var tableProperty={Key:myScope.dataUnitObj.displayName,field:myScope.dataUnitObj.uId,realType:"list",type:"tree",Value:{columnDef:[{displayName:"Value(s)",field:"item_value",type:"string"}],rowData:[]}};myScope.dataUnitObj.value&&(tableProperty.Value.rowData=_.map(JSON.parse(myScope.dataUnitObj.value),(function(m){return{item_value:m}})));$uibModal.open({templateUrl:"modules/nbDeviceDetail/views/propertyPopupModal.html",controller:"nb.deviceDetail.nbPropertyPopupModalCtrl",windowClass:"device-compound-property-display-modal",backdrop:"static",keyboard:!1,resolve:{args:function(){return{deviceProperty:tableProperty,filterTarget:"",enableEditMode:!1,deviceHostName:myScope.target.hostName}}}})},null:function(){return!1}};function ValueTypeCalCulator(dataUnitValueType){return valueTypeSolveDic[dataUnitValueType]?valueTypeSolveDic[dataUnitValueType]():valueTypeSolveDic.null()}function jumpIfNeed(option){var deferred=$q.defer();if(!option.posObj.posInfo.dataUnitList[0].link)return $q.resolve();var devId=option.deviceId;var interfaceId=option.interfaceId;devId||interfaceId?httpDataViewSrvc.getParseredLink(option.posObj.posInfo.dataUnitList[0].link,devId,interfaceId).then((function(data){deferred.reject();data&&window.open(data)}),(function(){deferred.resolve()})):deferred.resolve();return deferred.promise}function calByUnitType_USrcParserLibrary(){ValueTypeCalCulator(myScope.dataUnitObj.valueType)}function calByUnitType_Others(){ValueTypeCalCulator(myScope.dataUnitObj.valueType)}function calByDataUnitValueType_uList_object_subtype_uList_primitive_subtype(){var valueExpr2=myScope.dataUnitObj.valueExpr;schemaId=valueExpr2.schemaId,deviceId=valueExpr2.deviceId,callBack=function(){myScope.mapScope.deviceTablePropery&&$uibModal.open({templateUrl:"modules/nbDeviceDetail/views/propertyPopupModal.html",controller:"nb.deviceDetail.nbPropertyPopupModalCtrl",windowClass:"device-compound-property-display-modal",backdrop:"static",resolve:{args:function(){return{deviceProperty:myScope.mapScope.deviceTablePropery,filterTarget:"",enableEditMode:!1,deviceHostName:myScope.target.hostName}}}})},httpDeviceSchemaSrvc.getAllDeviceProperties().then((function(schemaList){httpDeviceSrvc.getDevicesJsonByGuids([deviceId]).then((function(devices){var schema=_.find(schemaList,(function(s){return s.ID===schemaId}));if(devices&&devices.length>0){var device=devices[0];var property={field:schema.ID,displayOrder:schema.displayOrder,Key:schema.displayname};var propertyValue=device[property.field];property.type="table";property.isCompoundDataType=!0;property.Value={columnDef:[],rowData:[]};var child=_.filter(schema.child,(function(item){return item.isDisplayInDataview}));_.each(child,(function(item){var currColObj={field:item.ID,displayName:item.displayname,type:item.subtype,usercanmodify:item.usercanmodify};property.Value.columnDef.push(currColObj)}));property.Value.rowData=angular.isUndefined(propertyValue)?[]:propertyValue;myScope.mapScope.deviceTablePropery=property;"function"==typeof callBack&&callBack()}}))}));var schemaId,deviceId,callBack;return!0}function calByDataUnitValueType_uString(){return!1}function calByDataUnitValueType_uNumber(){if(NgUtil.getValueFromObjAndPath(myScope,"posObj.posInfo.dataUnitList").length>0&&myScope.posObj.posInfo.dataUnitList[0].type===DataUnitSourceType.uSrcGDR)return!1;if(myScope.posObj&&myScope.posObj.posInfo&&myScope.otherInfoForTimeLine&&myScope.posObj.posInfo.displayInfo){if(!_.contains(netbrain.Map.Const.SuportChartValueType,myScope.dataUnitObj.valueType))return!1;var info={mapPageId:myScope.mapScope.netmap.getDocId(),dataViewInfo:myScope.otherInfoForTimeLine.dataViewInfo,deviceId:myScope.otherInfoForTimeLine.deviceId,titleName:myScope.otherInfoForTimeLine.titleName,interfaceId:myScope.otherInfoForTimeLine.interfaceId,unitList:_.filter(myScope.otherInfoForTimeLine.dataUnitList,(function(unitObj){var valueType=unitObj.valueType;var isSupport=_.contains(netbrain.Map.Const.SuportChartValueType,valueType);var isGdr=unitObj.type===DataUnitSourceType.uSrcGDR;return isSupport&&!isGdr})),currentUnit:myScope.dataUnitObj};info.onlyKey=info.interfaceId?info.deviceId+"-"+info.interfaceId:info.deviceId;info.titleType=info.interfaceId?"Interface":"Device";$rootScope.$broadcast("changeHistoryChartPanelEvent",info);return!0}}this.DrillDownLabel=function(option){!function(option){myScope={posObj:option.posObj,event:option.event,isDeviceLabel:option.isDeviceLabel,isLinkLabel:option.isLinkLabel,target:option.target,mapScope:option.mapScope,bubblePosition:option.bubblePosition,otherInfoForTimeLine:option.otherInfoForTimeLine};if(option.deviceId){var netmap=myScope.mapScope.netmap;if(netmap){var device=netmap._getCompDeviceByKey(option.deviceId);device&&(myScope.relatedNode=device)}}}(option);if(!function(){if(null==myScope.posObj)return!1;if(null==myScope.posObj.posName)return!1;if(myScope.posObj.posName===DataViewPosName.overflowPos){myScope.mapScope.$broadcast(netMapEvent.displayOverflowData,myScope.posObj,myScope.event,myScope.target,myScope.mapScope.netmap);return!1}if(null==myScope.posObj.posInfo)return!1;if(null==myScope.posObj.posInfo.dataUnitList)return!1;if(myScope.posObj.posInfo.dataUnitList.length<=0)return!1;var dataUnitObj=myScope.posObj.posInfo.dataUnitList[0];if(null==dataUnitObj)return!1;myScope.dataUnitObj=dataUnitObj;return!0}(myScope.posObj))return!1;jumpIfNeed(option).then((function(){dataUnitType=myScope.dataUnitObj.type,dic[dataUnitType]&&dic[dataUnitType]();var dataUnitType}))};this.jumpIfNeed=jumpIfNeed;this.isDataUnitTypeFunction=function(dataUnitType){return!!dic[dataUnitType]}}}(NetBrain);!function(netBrain){angular.module("nb.qmap").service("nb.qmap.nbBubbleSrvc",nbBubbleSrvc);nbBubbleSrvc.$inject=["$document","$compile","$rootScope","$timeout"];function nbBubbleSrvc($document,$compile,$rootScope,$timeout){var me=this;var defaultOptions={position:{right:"6px",top:"105px"},autoClose:!1,autoCloseDelay:3e3,hasCloseBtn:!1,customClass:"mapCusTip",appendTo:"Map"};var scope;me.open=function(options){me.closeAllTip();options=_.extend({},defaultOptions,options);var id="nb-bubble-"+(new Date).getTime();scope=$rootScope.$new();options.scope&&(scope=options.scope);scope.isShow=!1;scope.callBack=options.callBack;scope.tipID=id;scope.tipInfo=options.tipInfo;scope.customClass=options.customClass;scope.position=options.position;scope.textMode=!0;scope.closeTip=me.close;var element=angular.element('<div ng-if="isShow" id="{{tipID}}"  class="nb-bubble" nb-click-outside-directive click-outside-hide="true"></div>');if(options.hasCloseBtn){element.addClass("has-close-btn");element.prepend("<span class='icon_nb_close' ng-click=\"closeTip('"+id+"')\"></span>")}var sub=angular.element('<div class="nb-bubble" ng-class="customClass" ng-style="position" ><p class="nb-bubble-text" ng-if="textMode">Time: {{tipInfo| date : "M/d/yyyy hh:mm:ss a"}}</p></div>');element.append(sub);if(options.template){scope.textMode=!1;var content=angular.element(options.template);element.append(content)}(element=$compile(element)(scope)).css("display","none");options.defaultHide&&element.hide();("Map"===options.appendTo?angular.element(".mapMainFrameContent"):angular.element("body")).append(element);$timeout((function(){scope.isShow=!0;element.css("display","")}),100);if(!1!==options.autoClose){var delay=options.autoCloseDelay;var canceler=timeoutClose(delay,id);var hasLeaveHandler=!1;element.mouseenter((function(){$timeout.cancel(canceler);if(!hasLeaveHandler){hasLeaveHandler=!0;element.mouseleave((function(){2===canceler.$$state.status&&(canceler=timeoutClose(delay,id))}))}}))}return id};function timeoutClose(delay,id){return $timeout((function(){me.close(id)}),delay)}me.close=function(tipID){var element=$document.find("#"+tipID);element&&element.remove();if(scope){scope.isShow=!1;scope.$destroy()}};me.closeAllTip=function(){var element=$document.find(".nb-bubble");element&&element.remove()};me.hide=function(tipId){getEl(tipId).hide()};me.show=function(tipId){getEl(tipId).show()};function getEl(id){return $document.find("#"+id)}}}(NetBrain);!function(NetBrain){angular.module("nb.qmap").controller("nb.qmap.netMapCtrl",netMapCtrl);netMapCtrl.$inject=["$scope","$element","$rootScope","$compile","$q","$log","$timeout","$document","nb.dataview.httpDataViewSrvc","nb.ng.utilitySrvc","dialogService","nb.ng.httpAuthSrvc","nb.netbrain.httpMapViewOptionSrvc","nb.netbrain.dataViewCacheSrvc","md5","nb.dataview.dataViewInfoMgr","nb.dataview.dataViewEditMgr","nb.common.nbAlertSrvc","nb.ng.userSrvc","nb.qmap.netMapCmdTarget","nb.qmap.autoLinkOptionSrvc","nb.topo.httpExternNbrSrvc","nb.qmap.updateMapSrvc","nb.netbrain.httpDeviceSrvc","nb.dataview.httpDataViewManagerSrvc","nb.runbook.actionTaskForDataViewSrvc","nb.miniTask.httpMiniTaskSrvc","nb.qmap.editorToolbarOptions","nb.common.nbDragDropSrvc","nb.qmap.mapContextMenuSrvc","nb.common.nbTipSrvc","nb.dataview.applyDataViewSrvc","nb.common.cacheConfigSrvc","nb.common.cacheSiteInfoSrvc","nb.common.cacheInterfaceInfoSrvc","nb.qmap.drillDownLabelSrvc","nb.runbook.mapTargetDeviceSrvc","nb.qmap.mapManagerSrvc","nb.dataview.editDataViewSrvc"];function netMapCtrl($scope,$element,$rootScope,$compile,$q,$log,$timeout,$document,httpDataViewSrvc,utilitySrvc,dialogService,httpAuthSrvc,httpMapViewOptionSrvc,dataViewCacheSrvc,md5,dataViewInfoMgr,dataViewEditMgr,nbAlertSrvc,userSrvc,netMapCmdTarget,autoLinkOptionSrvc,httpExternNbrSrvc,updateMapSrvc,httpDeviceSrvc,httpDataViewManagerSrvc,actionTaskForDataViewSrvc,httpMiniTaskSrvc,editorToolbarOptions,nbDragDropSrvc,mapContextMenuSrvc,nbTipSrvc,applyDataViewSrvc,cacheConfigSrvc,cacheSiteInfoSrvc,cacheInterfaceInfoSrvc,drillDownLabelSrvc,mapTargetDeviceSrvc,mapManagerSrvc,editDataViewSrvc){$scope.showFloatButton=!0;$scope.isMapPanelTabShow=!1;$scope.showMapPanelTab=function(){$scope.isMapPanelTabShow=!0};$scope.hideMapPanelTab=function(){$scope.isMapPanelTabShow=!1;$scope.runbookOpenWidth={}};$scope.isShowMapLayoutPane=!1;$scope.showMapLayoutPane=function(width){$scope.isShowMapLayoutPane=!0;$scope.pinMapLayoutPaneCss={width:width||"420px"}};$scope.hideMapLayoutPane=function(){$scope.isShowMapLayoutPane=!1;$scope.pinMapLayoutPaneCss={}};$scope.nbQappInstanceOption={isShow:!1,fnMap:{},bIsMax:!1};$scope.showQappInstancePane=function(){if(!$scope.nbQappInstanceOption.isShow){var bIsMax=!1;var mapPageId=$scope.mapPageObj.getDocId();var fnIsMax=$scope.nbQappInstanceOption.fnMap[mapPageId];fnIsMax&&(bIsMax=fnIsMax());$rootScope.$broadcast(MapTabEvent.Min_TAB_OUTSIDE);$scope.nbQappInstanceOption.isShow=!0;$scope.nbQappInstanceOption.bIsMax=bIsMax}};$scope.hideQappInstancePane=function(){$scope.nbQappInstanceOption.isShow=!1;$scope.nbQappInstanceOption.bIsMax&&$rootScope.$broadcast(MapTabEvent.Max_TAB_OUTSIDE)};$scope.$watch((function(){var runbookWraper=$(".map-top-runbook-tab-wraper");var taskPanelW=runbookWraper.find(".action-task-panel").is(":hidden")?0:runbookWraper.find(".action-task-panel").width()||0;return runbookWraper.width()+taskPanelW}),(function(nv){nv&&$scope.isMapPanelTabShow&&NetBrain.Map.currentActiveMap.getRBAOpend()?$scope.runbookOpenWidth={width:nv+"px",iWidth:nv}:$scope.runbookOpenWidth={}}));$scope.$watch((function(){return NetBrain.Map.currentActiveMap.getRBAOpend()}),(function(nv){if(nv){var runbookWraper=$(".map-top-runbook-tab-wraper");var taskPanelW=runbookWraper.find(".action-task-panel").is(":hidden")?0:runbookWraper.find(".action-task-panel").width()||0;var realW=runbookWraper.width()+taskPanelW;$scope.runbookOpenWidth={width:realW+"px",iWidth:realW}}else $scope.runbookOpenWidth={}}));this.haveShowExtendNbrDialogId="";var hubBusinessId="";$scope.buildHubBusinessId=function(){hubBusinessId||(hubBusinessId=userSrvc.getUserID()+"_"+$scope.mapPageObj.getDocId());return hubBusinessId};$scope.httpDeviceSrvc=httpDeviceSrvc;var rootScopeontoggleTopPanel=$rootScope.$on(viewFrameEvent.toggleTopPanel,(function(){updateDiagram()}));var rootScopemapbasedsearchresultpaneopen=$rootScope.$on("map-based-search-resultpane-open",(function(){updateDiagram()}));function updateDiagram(){$timeout((function(){$scope.diagram.requestUpdate()}),0)}$scope.setCtrlNetMapTopologyType=function(netMapTopologyType){$scope.netMapTopologyType=netMapTopologyType};$scope.editLinkShow=!1;$scope.editDeviceShow=!1;$scope.editDataviewShow=!1;$scope.showDataViewList=!1;$scope.isMultiSelected=function(){return $scope.diagram.selection.size>1};$scope.closeOverflowDialog=function(){$scope.$broadcast(netMapEvent.closeOverflowDialog)};var openEditDataViewFromContext=$rootScope.$on("open-edit-data-view-from-context",(function(event,data){if($scope.mapPageObj&&$scope.mapPageObj.getDocId()===data.pageId){var lastInput=dataViewEditMgr.prepareEditDataviewParams(data.diagram);$scope.openEditDevice(lastInput,data.target)}}));$scope.openEditLink=function(lastInput,target,activeEditDU){$scope.editDataviewShow=!1;$scope.editLinkShow=!1;$scope.CloseExtendNbrghbor();$scope.closeSwitchVisualSpaceSelect();$timeout((function(){if(target.editingNode){$("#"+$scope.netmap.getDocId()+"-container").find(".edit-data-view").eq(0)&&$scope.$digest();dataViewEditMgr.editingDataViewLink=target.part.data;dataViewEditMgr.editingDataViewDevice=target.editingNode;$scope.editLinkShow=!0;$scope.editDeviceShow=!1;$scope.editDataviewShow=!0;$scope.editLinkTop=lastInput.y;$scope.editLinkLeft=lastInput.x;activeEditDU&&$timeout((function(){$scope.$broadcast("edit-link-data-unit",target.data)}),100)}}),1)};var editLinkClose=$scope.$on("editLinkClose",(function(event){event.stopPropagation();$scope.editLinkShow=!1}));$scope.CloseExtendNbrghbor=function(){$scope.dlgExtendNeighbor.closeExtendNbrDialog()};$scope.openEditDevice=function(lastInput,target,activeEditDU){$scope.editDeviceShow=!1;$scope.editDataviewShow=!1;$scope.closeSwitchVisualSpaceSelect();$timeout((function(){$("#"+$scope.netmap.getDocId()+"-container").find(".edit-data-view").eq(0)&&$scope.$digest();dataViewEditMgr.editingDataViewDevice=target.part.data;$scope.editDeviceShow=!0;$scope.editLinkShow=!1;$scope.editDataviewShow=!0;$scope.editDeviceTop=lastInput.y;$scope.editDeviceLeft=lastInput.x;activeEditDU&&$timeout((function(){$scope.$broadcast("edit-device-data-unit",target.data)}),100)}),1)};var editDeviceClose=$scope.$on("editDeviceClose",(function(event){event.stopPropagation();$scope.editDeviceShow=!1}));var editDataViewClose=$scope.$on("editDataViewClose",(function(event){event.stopPropagation();$scope.editDataviewShow=!1}));var gInitZoomBarFlag=!1;$scope.tryInitZoomBar=function(){if(!gInitZoomBarFlag){$scope.adjustZoomBar();gInitZoomBarFlag=!0}};$scope.adjustZoomBar=function(){if(null!=$scope.diagram&&null!=$scope.diagram.model.modelData.space){$scope.diagram.commandHandler.space=$scope.diagram.model.modelData.space;var args=[];args.push($scope.diagram.commandHandler.space);NetBrain.Map.currentActiveMapPage.getDocId()===$scope.mapPageObj.getDocId()&&$rootScope.$emit(netMapEvent.changeZoomBar,args)}};$scope.noteEditorTools={id:$scope.mapPageObj.getDocId()+"-noteEditorTools",isShow:!1,x:0,y:0};$scope.$on("ReInitNetMapCtrl",$scope.initCtrl);$scope.initCtrl=function(){var mapJsData=$scope.getNetMapJsData($scope.mapPageObj.getDocId());$scope.netmap=$scope.mapPageObj;$scope.netmap.setCurrentScope($scope);$scope.diagram.model.modelData.space=1;$scope.diagram.model.linkFromPortIdProperty=NetBrain.Map.CompL2Device.getLinkFromPortIdProperty();$scope.diagram.model.linkToPortIdProperty=NetBrain.Map.CompL2Device.getLinkToPortIdProperty();$scope.netmap.setGoJsContext($scope.diagram,$scope.diagram.model);var diagram=$scope.netmap.getGoJsDiagram();if(null!=diagram){diagram.commandHandler.beforeZoomApply=function(dZoomValue){$scope.refreshMapViewOption(!0,dZoomValue)};diagram.commandHandler.zoomCallBack=function(dZoomValue){var args=[];args.push(dZoomValue);$rootScope.$emit(netMapEvent.changeZoomBar,args);$scope.refreshMapViewOption(!0,dZoomValue);$scope.netmap.setSpace(dZoomValue)}}$scope.origscale=$scope.oldscale=$scope.diagram.scale;$scope.netmapOperator=new NetBrain.Map.CNetMapOperator($scope.netmap,dataViewCacheSrvc,$rootScope,$q,nbAlertSrvc,applyDataViewSrvc,$log);$scope.netmapCmdTarget=netMapCmdTarget.init($scope.netmapOperator,$scope);$scope.netmapCmdTarget.computePathManager.setMD5Service(md5);$scope.netmap.doOpen(mapJsData);$scope.dlgExtendNeighbor=new CDlgExtendNeighbors($scope,$compile,$q,dialogService,$document);GlobalContext.EventDispatch.registerSubscribeFunc(pagePaneEvent.hideTip,(function(){$scope.CloseExtendNbrghbor()}));$scope.netMapObjsSelection=new CNetMapObjsSelectionMgr($scope.diagram);$scope.checkAutoLinkWhenSwitchDataView=!1;$scope.setCtrlNetMapTopologyType($scope.netmap.getTopologyType());var vsInfo=$scope.netmap.getVisualSpaceInfo();var vsId=vsInfo&&vsInfo.visualSpaceInstanceId&&vsInfo.visualSpaceInstanceId.length>0?vsInfo.visualSpaceInstanceId:VisualSpaceConstant.defaultVisualSpaceInstanceId;NetBrain.CurAutolinkType||(NetBrain.CurAutolinkType={});NetBrain.CurAutolinkType[vsId]||$rootScope.$emit("getAutoLinkTypeByVisualSpaceId",vsId);angular.element($document[0].querySelectorAll(".goDiagramFrame canvas")).bind("keydown",(function(e){46===e.keyCode&&updateMapSrvc.canUpdateCurrentMap().then((function(){$scope.$broadcast("UpdateSeachBoxDataView",!1);if($scope.netmap){$scope.netmap.setNetMapLegend();$scope.netmap.delete()}}))}));var vspaceId=$scope.netmap.getVisualSpaceInfo()?$scope.netmap.getVisualSpaceInfo().visualSpaceInstanceId:null;var defaultMapAutoLinkOptionList=userSrvc.getUserConf().getJsWrapper().getMapAutoLinkOptionList(vspaceId);null==defaultMapAutoLinkOptionList?$scope.netmap.isMapAutoLinkOptionListEmpty()&&httpMapViewOptionSrvc.getAllMapAutoLinkTopotypeIds().then((function(data){if(data){var autoLinkResult=data.autoLinkResult;for(var index=0;index<autoLinkResult.length;index++){var autolinkChild=autoLinkResult[index];userSrvc.getUserConf().getJsWrapper().setMapAutoLinkOptionList(autolinkChild.autoLinkTypeList,autolinkChild.vspaceId);$scope.netmap.setMapAutoLinkOptionList(autolinkChild.autoLinkTypeList,autolinkChild.vspaceId)}}else;}),(function(){})):$scope.netmap.isMapAutoLinkOptionListEmpty()&&$scope.netmap.setMapAutoLinkOptionList(defaultMapAutoLinkOptionList);$scope.netmap._netmapJsWrapper.getMapViewOption()||$scope.netmap._netmapJsWrapper.setMapViewOption(userSrvc.getUserConf().getJsWrapper().getMapViewOption());$timeout((function(){if(!window.isInIframe){ngHub.getInstance().subBusinessId("UpdateMapView",$scope.buildHubBusinessId());ngHub.getInstance().subBusinessId("UpdateMapView_QappFirstPeriod",$scope.buildHubBusinessId());ngHub.getInstance().subBusinessId("UpdateMapView_QappEnd",$scope.buildHubBusinessId())}$scope.netmap.moveMapToVisibleNode();$scope.netmap.layoutLinkLabels(!0);var isModify=$scope.netmap.isLinkFixed||!1;$scope.netmap.setModify(isModify);(NetBrain.Map.MapArgs&&NetBrain.Map.MapArgs.openDataElementDetailPane&&NetBrain.Map.MapArgs.selectAlogId||utilitySrvc.getQueryString("openDataElementDetailPane")&&utilitySrvc.getQueryString("activePageId")===$scope.mapPageObj.getDocId()&&utilitySrvc.getQueryString("selectAlogId"))&&$rootScope.$broadcast("openResultFromOnDemmandDvtMap",utilitySrvc.getQueryString("rbNodeId"),NetBrain.Map.MapArgs.selectAlogId||utilitySrvc.getQueryString("selectAlogId"));!function(){var transfAlertData;if("ScheduleDVT"===utilitySrvc.getQueryString("alertType")&&utilitySrvc.getQueryString("activePageId")&&$scope.qmapObj.getAllPage()[0].getDocId()===$scope.mapPageObj.getDocId()||!utilitySrvc.getQueryString("activePageId")){transfAlertData=utilitySrvc.getLocalStorage(utilitySrvc.getQueryString("alertKey"));utilitySrvc.removeLocalStorage(utilitySrvc.getQueryString("alertKey"));transfAlertData&&nbDragDropSrvc.drawDeviceAndAlertNote(transfAlertData)}}()}))};$scope.getDefaultMapViewOption=function(){var deferred=$q.defer();var defaultMapViewOption=userSrvc.getUserConf().getJsWrapper().getMapViewOption();defaultMapViewOption&&defaultMapViewOption.options&&defaultMapViewOption.options.length>0&&deferred.resolve(defaultMapViewOption);return deferred.promise};$scope.clickMultiLink=function(event,graphObj){if(null!=graphObj&&null!=event&&(graphObj instanceof NetBrain.Map.PathLink||graphObj instanceof NetBrain.Map.BasePathLink)){var selectHopInfo={selectHops:null,selectHopId:null,isFrom:!0};var diagramPathManager=$scope.netmapOperator.getDiagramPathManager();null!=diagramPathManager&&diagramPathManager.onPathClicked(graphObj,selectHopInfo);selectHopInfo.selectHops&&NetBrain.Map.CategoryMgr.PathNew===graphObj.data.category&&$rootScope.$broadcast("updateHopListEvent",graphObj.data,selectHopInfo)}};$scope.contextClickMultiLink=function(event,graphObj){if(graphObj&&event&&NetBrain.Map.CategoryMgr.isPath(graphObj.category)){var diagramPathManager=$scope.netmapOperator.getDiagramPathManager();null!=diagramPathManager&&diagramPathManager.onPathContextClicked(graphObj,{selectHops:null,selectHopId:null,isFrom:!0})}};$scope.$on("switchPathLogDevice",(function(event,pathInfoObj,isShowTip){var deviceNode=$scope.diagram.findNodeForKey(pathInfoObj.deviceId);if(null!=deviceNode){var strTipContent=pathInfoObj.srcIp+" => "+pathInfoObj.destIp;var path=$scope.netmapOperator.getLinkByKey(pathInfoObj.pathId);null!=path&&$scope.diagram.select(path);var diagramPathManager=$scope.netmapOperator.getDiagramPathManager();if(null!=diagramPathManager){diagramPathManager.showPathAB($scope.diagram,path);$scope.netmapOperator.centerPathDevice(deviceNode)}isShowTip&&diagramPathManager.openPathTip($scope.diagram,path,deviceNode,path&&path.data||strTipContent)}}));$scope.initialLayoutCompleted=function(map){$scope.origscale=$scope.oldscale=map.scale;$timeout((function(){var withoutL2PortLayout=!0;$scope.qmapObj.getMapType()!==NetBrain.Map.Const.MapType.general&&(withoutL2PortLayout=!1);$scope.netmap.refreshMapViewOptionVisible(void 0,withoutL2PortLayout);$scope.netmap.enableUndoManager()}))};$scope.layOutCompleted=function(){};$scope.refreshMapViewOption=function(withoutPortLayout,zoomSpace){$scope.netmap.refreshMapViewOptionVisible(void 0,withoutPortLayout,zoomSpace)};$scope.viewPortBoundsChanged=function(map){$scope.netmap.layoutLinkLabels();var newscale=map.commandHandler.space;newscale!==$scope.oldscale&&($scope.oldscale=newscale)};var applyDataViewGroupCache=null;$scope.onDiagramModelChanged=function(changeEvent){if(changeEvent.isTransactionFinished){null==changeEvent.object||"Initial Layout"===changeEvent.object.name||"LinkLableLayout"===changeEvent.object.name||$scope.netmap.isModify()||$scope.netmap.setModify($scope.diagram.isModified);null!=$scope.diagram&&null!=$scope.diagram.model&&null!=$scope.diagram.model.modelData&&null!=$scope.diagram.model.modelData.space&&$scope.tryInitZoomBar()}if("FinishedUndo"===changeEvent.propertyName||"FinishedRedo"===changeEvent.propertyName)try{$scope.adjustZoomBar();$rootScope.$emit("refreshDataViewList",!0);$rootScope.$broadcast("setNetMapLegend",!0)}finally{}changeEvent.isTransactionFinished&&"FinishedUndo"===changeEvent.propertyName&&$scope.netmap.refreshMapViewOptionVisible();changeEvent.isTransactionFinished&&"FinishedRedo"===changeEvent.propertyName&&$scope.netmap.refreshMapViewOptionVisible();if(changeEvent.object===$scope.diagram.model){if(changeEvent.change==go.ChangedEvent.Insert&&"nodeDataArray"==changeEvent.propertyName){if(changeEvent.newValue&&changeEvent.newValue.devNodeData){var visualSpaceInfo=changeEvent.newValue.devNodeData.visualSpaceInfo;$scope.netmap.setVisualSpaceInfo(visualSpaceInfo);if(!applyDataViewGroupCache){var netMapJsWrapper=$scope.netmap.getNetMapJsWrapper();if(netMapJsWrapper&&visualSpaceInfo&&visualSpaceInfo.visualSpaceInstanceId&&!netMapJsWrapper.isAppliedDataViewsContains(visualSpaceInfo.visualSpaceInstanceId)){applyDataViewGroupCache=visualSpaceInfo.visualSpaceInstanceId;$timeout((function(){applyDataViewGroupCache=null;$scope.$emit(applyDataViewEvent.applyDataViewGroup,visualSpaceInfo.visualSpaceInstanceId)}))}}}}else if(changeEvent.change==go.ChangedEvent.Remove&&("nodeDataArray"==changeEvent.propertyName||"linkDataArray"==changeEvent.propertyName)){0==_.filter($scope.diagram.model.nodeDataArray,(function(node){return NetBrain.Map.CategoryMgr.isNetworkDevice(node.category)})).length&&0==$scope.diagram.model.linkDataArray.length&&$scope.netmap.setVisualSpaceInfo(null,!0)}!function(changeEvent,netmap){changeEvent.change===go.ChangedEvent.Remove&&"linkDataArray"===changeEvent.propertyName&&(linkData=changeEvent.oldValue,linkData&&NetBrain.Map.CategoryMgr.isPath(linkData.category))&&netmap.getNetmapOperator().removePathNotes(changeEvent.oldValue);var linkData}(changeEvent,$scope.netmap)}};$scope.onModelDataArrayChanged=function(changeEvent){"nodeDataArray"!==changeEvent.propertyName&&"linkDataArray"!==changeEvent.propertyName||(changeEvent.change===go.ChangedEvent.Insert||changeEvent.change===go.ChangedEvent.Remove||_.isArray(changeEvent.oldValue)&&_.isArray(changeEvent.newValue))&&function(changeEvent){var category="";changeEvent.newValue&&changeEvent.newValue.category&&(category=changeEvent.newValue.category);changeEvent.oldValue&&changeEvent.oldValue.category&&(category=changeEvent.oldValue.category);var categoryMgr=NetBrain.Map.CategoryMgr;if(categoryMgr.isDeviceCategory(category)||categoryMgr.isMedia(category))return!0;return!1}(changeEvent)&&$rootScope.$emit(NetBrain.Map.Event.ModelDataArrayChanged)};$scope.onTextEdited=function(){$scope.netmap.layoutLinkLabels()};$scope.GetLastSelectedNode=function(diagramRef){var selOneNode=null;var selNodes=[];for(var it=diagramRef.selection.iterator;it.next();){var part=it.value;selNodes[selNodes.length]=part}selNodes.length>0&&(selOneNode=selNodes[selNodes.length-1]);return selOneNode};$scope.tableDoubleClick=function(e,obj){var tableObject=new NetBrain.Map.CompTable;tableObject.CreateFromJson(obj.data);var tableView=new CTableDefineView(tableObject);tableView.okCallBack=function(){this.constructTableFromViewData();$scope.netmap._diagram.startTransaction("modify table");if(null!=obj){obj.data=this.getTableData().getNodeDataJsonObj();$scope.diagram.model.updateTargetBindings(obj.data)}$scope.netmap._diagram.commitTransaction("modify table")};tableView.openTableDlg()};$scope.ShapeDoubleClk=function(){};this.haveShowExtendNbrDialogId;$scope.redPlusClick=function(s,e){if(!(e.part.data.opacity<1)){$scope.editLinkShow=!1;$scope.editDeviceShow=!1;$scope.editDataviewShow=!1;this.netmap.isReadOnly()?updateMapSrvc.canUpdateCurrentMap().then((function(){$scope.dlgExtendNeighbor.showExtendNbrDialog(s,e)})):$scope.dlgExtendNeighbor.showExtendNbrDialog(s,e)}};$scope.selectLinkLable=function(event,graphObj){$scope.netMapObjsSelection.selLinkLabel(event,graphObj)};$scope.drillDownLabel=function(pos,event,isDeviceLabel,isLinkLabel,target,deviceId,interfaceId,otherInfoForTimeLine,deviceCom,needShowDetailPane){var diagramEvent=event;event&&event.event&&(diagramEvent=event.event);var bubblePos=function(left,top,target){var newLeft=left;var newTop=top;var wh=angular.element(window).height();left+200>angular.element(window).width()&&(newLeft=left-200);top+32>wh&&(newTop=top-32);return{left:newLeft,top:newTop}}(diagramEvent.clientX,diagramEvent.clientY);var option={posObj:pos,event:diagramEvent,isDeviceLabel:isDeviceLabel,isLinkLabel:isLinkLabel,target:target,mapScope:$scope,bubblePosition:bubblePos,deviceId:deviceId,interfaceId:interfaceId,otherInfoForTimeLine:null};if(!function(pos,deviceId,otherInfoForTimeLine,deviceCom,option,needShowDetailPane){var isShow=!1;if(pos&&pos.posInfo&&pos.posInfo.dataUnitList&&pos.posInfo.dataUnitList[0]||needShowDetailPane){var dataUnit=pos.posInfo.dataUnitList[0];if(function(type,valueType,dataViewData,needShowDetailPane){var allowShow=!1;(dataViewData&&dataViewData.templateId||needShowDetailPane)&&(allowShow=!0);return allowShow}(dataUnit.type,dataUnit.valueType,otherInfoForTimeLine.dataViewData,needShowDetailPane)){var devKey=deviceId;var devType=deviceCom?deviceCom.getDevType():null;var hostName=deviceCom?deviceCom.getHostname():null;var intfKey=otherInfoForTimeLine?otherInfoForTimeLine.intfKey:null;var dataViewInfo=otherInfoForTimeLine?otherInfoForTimeLine.dataViewInfo:null;drillDownLabelSrvc.jumpIfNeed(option).then((function(){showDataElementDetailPane(devKey,devType,hostName,intfKey,dataUnit,dataViewInfo,pos.posName,pos.posInfo)}));isShow=!0}}return isShow}(pos,deviceId,otherInfoForTimeLine,deviceCom,option,needShowDetailPane)){if(pos&&deviceCom){deviceCom.getDataViewType(pos.dataViewId)===DataViewType.dvDynamic&&(option.otherInfoForTimeLine=otherInfoForTimeLine)}!function(option,intfKey){if(intfKey&&option.posObj&&option.posObj.posInfo&&option.posObj.posInfo.dataUnitList&&option.posObj.posInfo.dataUnitList.length>0){var posObj=_.extend({},option.posObj);posObj.posInfo.dataUnitList[0].intfKey=intfKey;option.posObj=posObj}}(option,otherInfoForTimeLine?otherInfoForTimeLine.intfKey:null);drillDownLabelSrvc.DrillDownLabel(option)}};$scope.devPosLabelClicked=function(event,target,hostNameLable){var dev=target.part.data;var pos=target.data;if(hostNameLable!==NetBrain.Map.CompDevice.hostNameLable){if(null!=target&&null!=dev&&null!=pos&&dev.getDataViewGroupId()!==DefaultDataViewInfo.defaultDevDVGId){var otherInfoForTimeLine=null;if(pos.posInfo&&pos.posInfo.dataUnitList&&pos.posInfo.dataUnitList[0]){var dataUnitList=dev.getDataUnitList();var dataViewInfo=dev.getDataViewInfo(pos.dataViewId);var dataViewData=dev.getDataViewData();otherInfoForTimeLine={dataUnitList:dataUnitList,dataUnitBelongTo:DataUnitBelongTo.devLevel,dataViewData:dataViewData,dataViewInfo:dataViewInfo,deviceId:dev.key,titleName:dev.hostName}}$scope.drillDownLabel(pos,event,!0,!1,dev,dev.key,"",otherInfoForTimeLine,dev,!1)}}else $rootScope.$emit("DeviceChangedDataElementDetailPane",dev)};$scope.noteViewDetailClicked=function(event,target,data){var devCom=data.deviceData;var noteData=data.noteData;var intfData=data.intf;var noteUnit=function(noteContentText,noteTitle,timeText){var generateTime=moment.utc(new Date).format(moment.defaultFormatUtc);timeText&&(generateTime=moment.utc(new Date(timeText)).format(moment.defaultFormatUtc));return{alarm:0,displayName:"",displayTemplate:"",generateTime:generateTime,intfKey:null,prefix:noteTitle,type:DataUnitSourceType.uSrcCustomized,uId:noteTitle,value:noteContentText,valueType:"uTempNote"}}(noteData.noteContent,noteData.noteTitle,noteData.modifyTime);var index=function(devCom,noteTitle,noteContent){var index=0;if(devCom&&devCom.dataViewData&&devCom.dataViewData.deviceNotes)for(var i=0;i<devCom.dataViewData.deviceNotes.length;i++){var note=devCom.dataViewData.deviceNotes[i];if(note.title===noteTitle&&note.noteContent&&note.noteContent.length>0&&note.noteContent[0].content===noteContent){index=i;break}}return index}(devCom,noteData.noteTitle,noteData.noteContent);var pos={posInfo:{dataUnitList:[noteUnit]},posName:"f"+index};var dataViewData=devCom.getDataViewData();var dataViewInfo=devCom.getDataViewInfo();var intfKey=null;if(intfData){intfKey=intfData.intfKeyObj;index=function(devCom,intfData,noteTitle,noteContent){var index=0;var intfNoteList=mapManagerSrvc.getInterfaceNoteList(devCom.key,intfData.intfKeyObj.value,noteTitle,noteContent);for(var i=0;i<intfNoteList.length;i++){var note=intfNoteList[i];if(note.title===noteTitle&&note.noteContent&&note.noteContent.length>0&&note.noteContent[0].content===noteContent){index=i;break}}return index}(devCom,intfData,noteData.noteTitle,noteData.noteContent);pos.posName="f"+index}var otherInfoForTimeLine={dataViewData:dataViewData,dataViewInfo:dataViewInfo,intfKey:intfKey};$scope.drillDownLabel(pos,event,!0,!1,target,devCom.key,"",otherInfoForTimeLine,devCom,!1)};$scope.devIntfDrillDownIconClicked=function(event,target,posInfo,info){var targetData=target.part.data;try{var drillDownActionSrvc=angular.element(document).injector().get("nb.dataviewtemplate.drillDownActionSrvc");var devKey="";var intfKey="";if(info&&info.deviceId){devKey=info.deviceId;intfKey=info.intfKey}else devKey=targetData.key;drillDownActionSrvc.openVarActionRunningPanel(posInfo,devKey,devKey,{mapPageObj:$scope.$parent.mapPageObj,dataViewGroupId:posInfo.dataViewId,targetData:targetData,targetInfo:{devKey:devKey,intfKey:intfKey},posInfo:posInfo},event)}catch(ex){console.warn(ex)}};$scope.linkLabelClick=function(event,target){var linkline=target.part.data;if(null!=target&&null!=linkline){$scope.selectLinkLable(event,target);var clickUnit=target.panel.panel.panel.findObject(NetBrain.Map.CompTopolink.linkPosInfoLabel);var pos;clickUnit&&(pos=clickUnit.panel.panel.panel.data);if(pos&&pos.posName===DataViewPosName.overflowPos)$scope.drillDownLabel(pos,event,!1,!0,linkline);else{var dataUnitListSrc=linkline.getDataUnitListSrc();var dataUnitListDest=linkline.getDataUnitListDest();var linkLabelObjIsFrom=null!=(linkGraphicObj=target.panel.panel.panel)&&(linkGraphicObj.panel.segmentIndex>=0||(linkGraphicObj.panel.segmentIndex,!1));var linkGraphicObj;var dataUnitList=linkLabelObjIsFrom?dataUnitListSrc:dataUnitListDest;var titleName=linkLabelObjIsFrom?linkline.intfSrc.intfInfo.intf.intfDisplaySchemaObj.value:linkline.intfDest.intfInfo.intf.intfDisplaySchemaObj.value;var deviceId=linkLabelObjIsFrom?linkline.devIdSrc||linkline.from:linkline.devIdDest||linkline.to;var interfaceId=linkLabelObjIsFrom?linkline.intfSrc.intfInfo.intf.intfKeyObj.value:linkline.intfDest.intfInfo.intf.intfKeyObj.value;var dataViewInfo=linkLabelObjIsFrom?linkline.getViewInfoSrc(pos&&pos.dataViewId):linkline.getViewInfoDest(pos&&pos.dataViewId);if(dataViewInfo.dataViewType!==DataViewType.dvDefault){var intfKey=function(linkLabelObjIsFrom,linkline){return linkLabelObjIsFrom?{schema:linkline.intfSrc.intfInfo.intf.intfKeyObj.schema,value:linkline.intfSrc.intfInfo.intf.intfKeyObj.value,name:linkline.intfSrc.intfInfo.intf.intfDisplaySchemaObj.value}:{schema:linkline.intfDest.intfInfo.intf.intfKeyObj.schema,value:linkline.intfDest.intfInfo.intf.intfKeyObj.value,name:linkline.intfDest.intfInfo.intf.intfDisplaySchemaObj.value}}(linkLabelObjIsFrom,linkline);var otherInfoForTimeLine=null;var deviceCom=$scope.diagram.findNodeForKey(deviceId).data;var dataViewData=deviceCom.getDataViewData();pos&&pos.posInfo&&pos.posInfo.dataUnitList&&pos.posInfo.dataUnitList[0]&&(otherInfoForTimeLine={dataUnitList:dataUnitList,dataUnitBelongTo:DataUnitBelongTo.intfLevel,dataViewData:dataViewData,dataViewInfo:dataViewInfo,deviceId:deviceId,interfaceId:interfaceId,intfKey:intfKey,titleName:deviceCom.getHostname()+" . "+titleName});$scope.drillDownLabel(pos,event,!1,!0,linkline,deviceId,interfaceId,otherInfoForTimeLine,deviceCom,!1)}}}};function showDataElementDetailPane(devKey,devType,hostName,intfKey,currentDataUnit,dataViewInfo,posName,posInfo){var options={dataUnit:_.extend({displayTemplate:posInfo.displayTemplate,displayInfo:posInfo.displayInfo},currentDataUnit,{intfKey:intfKey}),dataViewInfo:dataViewInfo,devKey:devKey,devType:devType,handle:{onClose:function(){}},hostName:hostName,mode:1,posName:posName};var EventType=NetBrain.DataView.ElementConst.EventType;$scope.$emit(EventType.SHOW_DATA_ELEMENT_PANE,options,!1)}$scope.clickDevice=function(event,target){var dev=target.part.data;if(NetBrain.Map.CategoryMgr.isDeviceCategory(dev.category)&&!$scope.isEditMode()){$rootScope.$emit("nb.mapfoldermanager.autoSwitch",dev);$rootScope.$emit("DeviceChangedDataElementDetailPane",dev)}};$scope.doubleClickDevice=function(event,target){var dev=target.part.data;if(NetBrain.Map.CategoryMgr.isDeviceCategory(dev.category)&&!$scope.isEditMode()){var deviceTenantDomain={TenantGuid:httpAuthSrvc.getDataSrc(utilitySrvc).TenantGuid,DomainGuid:[]};var detailEventData={deviceGuid:dev.getKey(),deviceHostName:dev.getHostname(),deviceType:dev.getDevType(),deviceTenantDomain:deviceTenantDomain,argIsOpenFromMap:!0,bActiveTab:!1,isSubView:!1};var deviceDetailEventData=new DeviceDetailEventData(detailEventData);$rootScope.$emit(viewFrameEvent.toggleTopPanel,"deviceDetail",deviceDetailEventData)}};$scope.ObjectContextClicked=function(event){$rootScope.$emit(NetBrain.Map.Event.CloseAllTip);var allSelectedNodes=$scope.netmapOperator.getSelectedNodes();allSelectedNodes.forEach((function(selNode){!selNode.id&&selNode.key&&(selNode.id=selNode.key)}));var activePage=$scope.netmap;var options={};options.event=event;options.allSelectedNodes=allSelectedNodes;options.selectedLinks=$scope.netmapOperator.getSelectedLinks();options.activePage=activePage;$scope.$apply((function(){mapContextMenuSrvc.open(options)}))};$scope.BackgroundContextClicked=function(event){$rootScope.$emit(NetBrain.Map.Event.CloseAllTip);var activePage=$scope.netmap;var options={};options.isBackgroundContextClicked=!0;options.activePage=activePage;options.position=event.diagram.lastInput.documentPoint;$scope.$apply((function(){$rootScope.$emit("mapBarMidddleMenuDrapDownClose");editorToolbarOptions.changeShowState(!1);mapContextMenuSrvc.open(options)}))};$scope.linkLabelMouseEnter=function(event,target){$scope.$emit("linkLabelMouseEnter",event,target)};$scope.linkLabelMouseLeave=function(event,target){$scope.$emit("linkLabelMouseLeave",event,target)};$scope.ChangedSelection=function(event,target){$scope.$emit("ChangedSelection",event,target);editorToolbarOptions.changeShowState(!1);$scope.netmapOperator&&$scope.netmapOperator.refreshSelectionStyle()};$scope.selectionMoved=function(event){$scope.hideEditorToolbar(!1);$scope.$apply((function(){mapContextMenuSrvc.close()}))};function _getViewRect(obj,diagram){if(!obj)return null;var points=[];points.push(obj.getDocumentPoint(go.Spot.TopLeft));points.push(obj.getDocumentPoint(go.Spot.TopRight));points.push(obj.getDocumentPoint(go.Spot.BottomLeft));points.push(obj.getDocumentPoint(go.Spot.BottomRight));var minX=_min(points,"x");var minY=_min(points,"y");var maxX=_max(points,"x");var maxY=_max(points,"y");var vTopLeftPoint=diagram.transformDocToView(new go.Point(minX,minY));var vBottomRightPoint=diagram.transformDocToView(new go.Point(maxX,maxY));var mapScope=mapManagerSrvc.getActivePage().currentScopeRef.$parent;var addWidth=0;mapScope&&_.isFunction(mapScope.getAddWidth)&&(addWidth=mapScope.getAddWidth());return{top:vTopLeftPoint.y,left:vTopLeftPoint.x+addWidth,bottom:vBottomRightPoint.y,right:vBottomRightPoint.x+addWidth};function _max(arr,property){if(!arr||!arr.length){console.warn("utils.max arr is null");throw new Error("utils.max fcuntion arr param is null")}var fn;fn=property?function(o){return o[property]}:function(o){return o};var numArr=[];for(var i=0,len=arr.length;i<len;i++){var value=fn(arr[i]);isNaN(value)||numArr.push(value)}return Math.max.apply(null,numArr)}function _min(arr,property){if(!arr||!arr.length){console.warn("utils.min arr is null");throw new Error("utils.min fcuntion arr param is null")}var fn;fn=property?function(o){return o[property]}:function(o){return o};var numArr=[];for(var i=0,len=arr.length;i<len;i++){var value=fn(arr[i]);isNaN(value)||numArr.push(value)}return Math.min.apply(null,numArr)}}$scope.onLayoutCompleted=function(){$scope.diagram.layout.isOngoing=!1};$scope.onAnimationFinished=function(){$scope.refreshMapViewOption()};var DrawingState;var rootScopeonchangeDrawingState=$rootScope.$on("changeDrawingState",(function(event,state,pageId){pageId===$scope.netmap.getDocId()&&(DrawingState=state)}));var offApplyDataviewByAlertResult=$rootScope.$on("tellMapToOpenDataElementPane",(function(event,options){offApplyDataviewByAlertResult();!function(){if(NetBrain.Map.MapArgs&&NetBrain.Map.MapArgs.openDataElementDetailPane&&NetBrain.Map.MapArgs.activePageId===$scope.mapPageObj.getDocId())showDataElementDetailPaneFromAlert(NetBrain.Map.MapArgs);else if(utilitySrvc.getQueryString("openDataElementDetailPane")&&utilitySrvc.getQueryString("activePageId")===$scope.mapPageObj.getDocId()){showDataElementDetailPaneFromAlert({activePageId:utilitySrvc.getQueryString("activePageId"),devId:utilitySrvc.getQueryString("devId"),uId:utilitySrvc.getQueryString("uId")})}}()}));var AreaSelectState;var rootScopeonchangeAreaSelectState=$rootScope.$on("changeAreaSelectState",(function(event,state,pageId){pageId===$scope.netmap.getDocId()&&(AreaSelectState=state)}));var rootScopeGEventOpenDetailPanelFormDrillDownPanel=$rootScope.$on("GEventOpenDetailPanelFormDrillDownPanel",(function(event,data,option){data&&data.pageId===$scope.netmap.getDocId()&&showDataElementDetailPane(data.devKey,data.devType,data.hostName,data.intfKey,data.dataUnit,data.dataViewInfo,data.posName,data.posInfo)}));var rootScopeGEventOpenDetailPanelFormAlert=$rootScope.$on("GEventOpenDetailPanelFormAlert",(function(event,data,option){data&&data.activePageId===$scope.netmap.getDocId()&&showDataElementDetailPaneFromAlert(data)}));function showDataElementDetailPaneFromAlert(data){(function(data){try{var mapJsData=$scope.getNetMapJsData(data.activePageId);var nodeData=_.find(mapJsData.nodeDataArray,{key:data.devId});var pos=_.find(nodeData.dataViewData.devPosList,(function(pos){if(pos.posInfo)return _.find(pos.posInfo.dataUnitList,{uId:data.uId})}));var dataUnit=_.find(pos.posInfo.dataUnitList,{uId:data.uId});_.extend(data,{devKey:nodeData.key,devType:nodeData.devType,hostName:nodeData.hostName,intfKey:null,dataUnit:dataUnit,dataViewInfo:nodeData.dataViewData.dataViewInfo,posName:pos.posName,posInfo:pos.posInfo});return!0}catch(e){nbAlertSrvc.error("The data view no longer exists.");return!1}})(data)&&showDataElementDetailPane(data.devKey,data.devType,data.hostName,data.intfKey,data.dataUnit,data.dataViewInfo,data.posName,data.posInfo)}$scope.OnMouseOver=function(){$scope.diagram.currentCursor=DrawingState?cursorHelper.crosshair:AreaSelectState?cursorHelper.auto:cursorHelper.grab};$scope.bgSingleClicked=function(){$timeout((function(){if($scope.netmapOperator){var diagramPathManager=$scope.netmapOperator.getDiagramPathManager();null!=diagramPathManager&&diagramPathManager.closePathTip($scope.diagram);$scope.netMapObjsSelection.clearPageObjsSelection();$scope.CloseExtendNbrghbor();$scope.closeSwitchVisualSpaceSelect();if(!$scope.isEditMode()){$scope.editDeviceShow=!1;$scope.editLinkShow=!1;$scope.editDataviewShow=!1}$scope.editTopoPopupShow=!1;$scope.closeOverflowDialog();$scope.hideEditorToolbar()}}))};$scope.isEditMode=function(){return dataViewEditMgr.isInEditMode};$scope.getEditDataView=function(){return dataViewEditMgr.editingDataView};var outEditMode=$rootScope.$on(netMapEvent.leaveDataViewEdit,(function(){$scope.editLinkShow=!1;$scope.editDeviceShow=!1;$scope.editDataviewShow=!1;$scope.netmap.setBackColor("");$rootScope.$emit(NetBrain.Map.Event.ShowDataViewTitle);$rootScope.$emit(NetBrain.Map.Event.MapDataViewListChanged)}));var enterEditMode=$rootScope.$on(netMapEvent.enterDataViewEdit,(function(){$rootScope.$emit(NetBrain.Map.Event.HideDataViewTitle);$scope.$broadcast("close-output-console-pane");$rootScope.$emit(NetBrain.Map.Event.CloseAllFloatDialog)}));$scope.$on("dataViewNoteValueChanged",(function(event,note,noteLinkedInfos,oldTitle){$scope.isEditMode()&&editDataViewSrvc.updateDataViewNote(note,noteLinkedInfos,oldTitle)}));$scope.notifyHighlightChanged=function(){$scope.$broadcast("netMapHighlightChanged")};$scope.notifyEnterEditMode=function(){$scope.$broadcast("netMapEnterEditMode")};$scope.checkBeforeEnterDataViewEditMode=function(currentDataView){var deferred=$q.defer();var netmap=mapManagerSrvc.getActivePage();netmap||$log.error("Can NOT get active map in netMapCtrl!");netmap._getAllDevices().forEach((function(device){device._netmap&&delete device._netmap}));if(!netmap.getExtendData()){deferred.resolve({});return deferred.promise}httpDataViewSrvc.doesDataViewGroupExist(null,currentDataView.ID).then((function(ret){if(!ret){nbAlertSrvc.alert({title:"Warning",message:"The data view does not exist, which might have been deleted by someone."}).then((function(){deferred.resolve({isContinue:!1,isDeleted:!0})}),(function(){deferred.resolve({isContinue:!1,isDeleted:!0})}))}else deferred.resolve({isContinue:!0,isUpdated:!1,enabledDevIdList:[currentDataView.ID]})}),(function(reason){deferred.reject(reason);$log.error(reason)}));return deferred.promise};$rootScope.$on(NetBrain.Map.Event.EditDataViewFromDataViewTitleBar,(function(event){var netmap=mapManagerSrvc.getActivePage();if(netmap===$scope.netmap){var extendData=netmap.getExtendData();var dataView={ID:extendData.extendDataViewData.dataViewId,name:extendData.extendDataViewData.dataViewName};var enabledDevList=[];_.each(netmap._getAllDevices(!0),(function(device){device.isContainsDataViewId(dataView.ID)&&enabledDevList.push(device.getKey())}));$scope.enterDataViewEditMode(dataView,enabledDevList)}}));var escKeyDownHandler=function(e){var evt=window.event||e;if(27===evt.keyCode){evt.stopPropagation();evt.cancelBubble=!0}};function disableEscKey(editMode){editMode?document.addEventListener("keydown",escKeyDownHandler,!0):document.removeEventListener("keydown",escKeyDownHandler,!0)}$scope.enterDataViewEditMode=function(currentDataView,devIdList){var isContinue=null;var canOnlySaveAsNew=null;var isUpdated=null;var updatedDevIdList=null;disableEscKey(!0);dataViewEditMgr.canOnlySaveAsNew=!1;$scope.checkBeforeEnterDataViewEditMode(currentDataView).then((function(result){isContinue=result.isContinue;isUpdated=result.isUpdated;canOnlySaveAsNew=result.isDeleted;updatedDevIdList=result.enabledDevIdList;dataViewEditMgr.canOnlySaveAsNew=canOnlySaveAsNew}),(function(reason){$log.error(reason)})).then((function(){if(isContinue){if(isUpdated){var promise=dataViewInfoMgr.applyDataViewInfo($scope.netmap,"single",currentDataView.ID,updatedDevIdList,null,!0,!1);promise&&promise.then((function(){dataViewEditMgr.doSaveOnEditMode($scope.netmap)}))}$rootScope.$emit(viewFrameEvent.toggleTopPanel,"editDataView");dataViewEditMgr.isInEditMode=!0;dataViewEditMgr.editingDataView=currentDataView;dataViewEditMgr.editingDeviceList=devIdList;$scope.editingDataView=currentDataView;var netmap=mapManagerSrvc.getActivePage();try{dataViewEditMgr.doSaveOnEditMode(netmap);dataViewEditMgr.enableDataViewEditMode($scope,netmap,$element);$rootScope.$emit(netMapEvent.enterDataViewEdit,currentDataView);$scope.netmap.setBackColor("#F5FBFF")}finally{}}}))};$scope.leaveDataViewEditMode=function(isSaved){disableEscKey(!1);dataViewEditMgr.isInEditMode=!1;dataViewEditMgr.maximizeMainUI();var netmap=$scope.$parent.mapPageObj;netmap._diagram.startTransaction("leaveDataViewEditMode");netmap._updateAllTargetBindings();dataViewEditMgr.disableDataViewEditMode($element);$rootScope.$emit(netMapEvent.leaveDataViewEdit);dataViewEditMgr.clearUpdatedPosLists();$scope.showSaveAs=!1;$scope.isSavedNew=!1;netmap.refreshMapViewOptionVisible();netmap.removeAllLinkHighlightFlag();netmap._diagram.commitTransaction("leaveDataViewEditMode")};$scope.exitEditMode=function(){$scope.isSavedNew?$scope.leaveDataViewEditMode(!0):$scope.leaveDataViewEditMode(!1)};var runDataCount=0;var lastProcessTime=new Date;var isAlreadySetDefault=!1;var isAlreadySetDefaultFinish=!1;var isAlreadyApplyDevice=[];var oldPageExtendData=null;var newDataViewForMiniTask=$scope.$on("newDataViewForMiniTask",(function(){$scope.netmap.runingDataViewGroupId="";runDataCount=0;oldPageExtendData=null;isAlreadySetDefault=!1;isAlreadySetDefaultFinish=!1;isAlreadyApplyDevice=[];lastProcessTime=new Date}));var curUpdateDataViewCallbackInfo=null;function updateMapDataView(filterCallbackInfo){null==curUpdateDataViewCallbackInfo&&(curUpdateDataViewCallbackInfo=filterCallbackInfo);if(filterCallbackInfo.dataUnitStorageList[0]){if(curUpdateDataViewCallbackInfo.dataUnitStorageList.length>0&&curUpdateDataViewCallbackInfo.dataUnitStorageList[0].dataViewTaskInfoId===filterCallbackInfo.dataUnitStorageList[0].dataViewTaskInfoId){0===_.filter(curUpdateDataViewCallbackInfo.dataUnitStorageList,(function(item){return item.devId===filterCallbackInfo.dataUnitStorageList[0].devId})).length&&curUpdateDataViewCallbackInfo.dataUnitStorageList.push(filterCallbackInfo.dataUnitStorageList[0])}else curUpdateDataViewCallbackInfo=filterCallbackInfo;if(isAlreadySetDefault){if(null!=curUpdateDataViewCallbackInfo)if(new Date-lastProcessTime>2e3&&isAlreadySetDefaultFinish)updateMapDataViewProcess(curUpdateDataViewCallbackInfo);else{$scope.updateMapDataViewTimer&&$timeout.cancel($scope.updateMapDataViewTimer);$scope.updateMapDataViewTimer=$timeout((function(){updateMapDataView(filterCallbackInfo)}),1e3)}}else{oldPageExtendData={extendRunbookData:{runbookId:(extendData=$scope.netmap.getExtendData()).extendRunbookData.runbookId,runbookNodeName:extendData.extendRunbookData.runbookNodeName,runbookNodeId:extendData.extendRunbookData.runbookNodeId,runbookNodeResultName:extendData.extendRunbookData.runbookNodeResultName,runbookNodeResultId:extendData.extendRunbookData.runbookNodeResultId,lastUpdateTime:extendData.extendRunbookData.lastUpdateTime},extendDataViewTemplateData:{dataViewTemplatePath:extendData.extendDataViewTemplateData.dataViewTemplatePath,dataViewTemplateId:extendData.extendDataViewTemplateData.dataViewTemplateId},extendDataViewData:{dataViewName:extendData.extendDataViewTemplateData.dataViewName,dataViewId:extendData.extendDataViewTemplateData.dataViewId,dataViewGroupScope:extendData.extendDataViewTemplateData.dataViewGroupScope,lastUpdateTime:extendData.extendDataViewTemplateData.lastUpdateTime}};var promise=$scope.netmapOperator.resetDefaultDataView(dataViewCacheSrvc,!1);null!=promise&&promise.then((function(){updateMapDataViewProcess(curUpdateDataViewCallbackInfo);isAlreadySetDefaultFinish=!0}),(function(){updateMapDataViewProcess(curUpdateDataViewCallbackInfo);isAlreadySetDefaultFinish=!0}));isAlreadySetDefault=!0}var extendData}}function updateMapDataViewProcess(callbackInfo){lastProcessTime=new Date;curUpdateDataViewCallbackInfo=null;var willRemoveItems=[];_.each(callbackInfo.dataUnitStorageList,(function(item){isAlreadyApplyDevice.indexOf(item.devId)>-1?willRemoveItems.push(item):isAlreadyApplyDevice.push(item.devId)}));_.each(willRemoveItems,(function(removeItem){!function(arr,val){for(var i=0;i<arr.length;i++)if(arr[i]===val){arr.splice(i,1);break}}(callbackInfo.dataUnitStorageList,removeItem)}));if(callbackInfo&&(!callbackInfo.dataUnitStorageList||0!==callbackInfo.dataUnitStorageList.length)){var pageExtendData=oldPageExtendData;if(0===runDataCount){var dataViewInfoMgr1=angular.element(document).injector().get("nb.dataview.dataViewInfoMgr");null!=dataViewInfoMgr1&&dataViewInfoMgr1.notifyApplyDataViewListener($scope.netmap,!0)}httpMiniTaskSrvc.activity.getUpdateDataViewInfo(callbackInfo).then((function(data){var devObj=data.devDataViewList[0];if(devObj){if(0===runDataCount){$rootScope.$emit("refreshDataViewList");if(devObj&&devObj.dataViewData&&devObj.dataViewData.dataViewInfo){if($scope.netmap.runingDataViewGroupId!=devObj.dataViewData.dataViewInfo.dataViewGroupId)return;devObj.dataViewData.dataViewInfo.dataViewType===DataViewType.dvDynamic&&$scope.netmap.setBackColor(NetBrain.Map.Const.nbMonitorColor);pageExtendData.extendDataViewData.dataViewId=devObj.dataViewData.dataViewInfo.dataViewGroupId;pageExtendData.extendDataViewData.dataViewName=devObj.dataViewData.dataViewInfo.name;pageExtendData.extendDataViewData.dataViewGroupScope=devObj.dataViewData.dataViewInfo.dataViewType;pageExtendData.extendDataViewData.lastUpdateTime=devObj.dataViewData.dataViewInfo.time;$scope.netmap.setExtendData(pageExtendData)}}if($scope.netmap&&$scope.netmap.isDisplaySwitchMode&&$scope.netmap.isDisplaySwitchMode()){if(pageExtendData&&pageExtendData.extendDataViewData&&pageExtendData.extendDataViewData.dataViewId&&pageExtendData.extendDataViewData.dataViewId===devObj.dataViewData.dataViewInfo.dataViewGroupId){devDataViewList=data.devDataViewList,null!=(dataViewApplyOp=$scope.netmapOperator.getDataViewApplyOp())&&dataViewApplyOp.doApplyDataViewGroup(null,devDataViewList,null,!0);return}}else{var devices=_.map(data.devDataViewList,(function(dv){return dv.key}));applyDataViewSrvc.applyDataviewsOnDevices(devices,pageExtendData.extendDataViewData.dataViewId,$scope.netmap).then((function(){}),(function(){}))}var devDataViewList,dataViewApplyOp;runDataCount++}}),(function(e){$log.error(e)}))}}var onUpdateMapDataView=$scope.$on("updateMapDataView",(function(event,data){if($scope.netmap.getDocId()===data.taskInfo.mapPageId&&data&&data.dataUnitStorageList&&data.dataUnitStorageList.length>0)if($scope.netmap.isDisplaySwitchMode()){var dataViewGroupId=data.dataUnitStorageList[0].dataViewGroupId;try{actionTaskForDataViewSrvc.getLastDataViewGroup($scope.netmap.getDocId()).then((function(d){console.warn("getLastDataViewGroupId:"+d.id);dataViewGroupId===$scope.netmap.runingDataViewGroupId&&updateMapDataView(data)}),(function(){$log.error("error getLastDataViewGroup,pageId:"+$scope.netmap.getDocId())}))}catch(e){$log.error("error updateMapDataView,pageId:"+$scope.netmap.getDocId()+"message:"+e.toString())}}else $scope.netmap.isDisplayPinMode()&&updateMapDataView(data)}));$scope.showEditorToolbar=function(part,textblock){var category=part.data.category;if("stencil"===category||"NetworkDevice"===category||"TopoLink"===category)editorToolbarOptions.changeShowState(!1);else{var data={textblock:textblock,textEditor:textblock.textEditor,position:_getViewRect(textblock,part.diagram)};$scope.$apply((function(){editorToolbarOptions.setOptions(data,!0)}))}};$scope.hideEditorToolbar=function(){editorToolbarOptions.changeShowState(!1)};$scope.showShapToolbar=function(target){var data={part:target,shape:target.data,position:_getViewRect(target,target.part.diagram)};$scope.netmap.getMapPanelTabShow()&&(data.isMapPanelShow=!0);editorToolbarOptions.setOptions(data,!0)};$scope.showArrangeToolbar=function(target){target.part.diagram.selection.count>1&&$scope.showShapToolbar(target)};$scope.showCompoundNoteLinks=function(target){var netmap=$scope.netmap;netmap&&netmap.showCompoundNoteLinks(target)};$scope.hideCompoundNoteLinks=function(target){var netmap=$scope.netmap;netmap&&netmap.hideCompoundNoteLinks(target)};var tracerouteMap=$scope.$on("tracerouteMap",(function(event,data){$scope.netmap.getDocId()===data.mapPageId&&$scope.netmapCmdTarget.onDrawTrace(dataViewCacheSrvc,data.pathJsonData,autoLinkOptionSrvc,httpExternNbrSrvc)}));var onApplyTemporaryDataView=$scope.$on("applyTemporaryDataView",(function(event,dvList){applyDataViewSrvc.applyTemporaryView(dvList,$scope.netmap)}));var clearTemporaryDataView=$scope.$on("clearTemporaryDataView",(function(){applyDataViewSrvc.clearTemporaryView($scope.netmap)}));$scope.showHostnameInvalidTip=function(){nbAlertSrvc.warning({message:NetBrain.Map.Message.HostnameInvalidTipMsg})};var multiTabEventSrvcSwitchTab=$rootScope.$on("multiTabEventSrvcSwitchTab",(function(){!function(){var runQappActionParam=utilitySrvc.getLocalStorage("actionKeyForRunQapp");runQappActionParam&&runQappActionParam.pageId!==NetBrain.Map.currentActiveMapPage.getDocId()&&mapManagerSrvc.switchMapPage(runQappActionParam.pageId);qappEditorRunQapp(runQappActionParam);utilitySrvc.removeLocalStorage("actionKeyForRunQapp")}()}));var getAutoLinkTypeByVisualSpaceId=$rootScope.$on("getAutoLinkTypeByVisualSpaceId",(function(event,vsId){return httpExternNbrSrvc.getAutoLinkTypeByVisualSpaceId(vsId).then((function(result){if(null==result)return null;$rootScope.$emit(mapEvent.mapVisualSpaceChanged,result.topoLinkList);null==NetBrain.CurAutolinkType&&(NetBrain.CurAutolinkType=new Object);NetBrain.CurAutolinkType[result.vsId]=result.topoLinkList;return result}))}));function qappEditorRunQapp(param){if(param){var qapps=[{qappId:param.qappId,qappName:param.qappName,qappPath:param.qappPath}];$rootScope.$broadcast("MiniTask.Qapp.onAddQapps",{mapPageObj:$scope.mapPageObj,qapps:qapps});var qappAction={_id:"1cff8a8f-4272-4177-b5ef-b0bfc1a45411",type:1,bgColor:"#feefd6",border:"#f9ae1f",icon:"action_node_qapp_24",name:param.qappName,actionType:1,defaultInput:JSON.stringify({qappList:qapps}),operateInfo:{opUser:"NetBrain",opTime:"2017-12-20T08:27:38.772+08:00"},contextMenuIcon:"run-qapp-16"};mapTargetDeviceSrvc.transferData(qappAction);qappAction.action(qappAction)}}$scope.closeSwitchVisualSpaceSelect=function(){$rootScope.$emit("closeSwitchVisualSpaceSelect")};var handleApiActions=function(){var apiPath=utilitySrvc.getQueryString("path");var apiSearch=utilitySrvc.getQueryString("q");var apiDataViewId=utilitySrvc.getQueryString("dataViewId");apiPath&&$rootScope.$emit(netMapEvent.openPathPane,apiPath);apiSearch&&(apiPath?$rootScope.$emit(netMapEvent.doSearch,apiSearch,!1):$rootScope.$emit(netMapEvent.doSearch,apiSearch,!0));apiDataViewId&&(dataViewId=apiDataViewId,activePage=mapManagerSrvc.getActivePage(),devList=_.map(activePage._getAllDevices(),(function(item){return item.getKey()})),httpDataViewManagerSrvc.getDataViewGroupsById(null,dataViewId).then((function(dataViewGroupInfo){var netmapOperator=activePage.getNetmapOperator();netmapOperator.resetDefaultDataView(dataViewCacheSrvc,!1,"",!0).then((function(){var extendData=netmapOperator.getExtendData();extendData.extendDataViewData.dataViewGroupScope=dataViewGroupInfo.scopeInfo.type;extendData.extendDataViewData.dataViewId=dataViewGroupInfo.ID;extendData.extendDataViewData.dataViewName=dataViewGroupInfo.name;extendData.extendDataViewData.lastUpdateTime=dataViewGroupInfo.lastUpdateTime;extendData.extendRunbookData.lastUpdateTime="";netmapOperator.setExtendData(extendData);applyDataViewSrvc.applyDataviewsOnDevices(devList,dataViewId).then((function(){$rootScope.$emit(NetBrain.Map.Event.DataViewChanged);$rootScope.$emit(NetBrain.Map.Event.QAppStatusChanged,!1)}))}))})));var dataViewId,activePage,devList};function doAction(){var actionDic={DrawMedia:nbDragDropSrvc.drawMedia,DrawDevice:nbDragDropSrvc.drawDevice,DrawDeviceAndAlertNote:nbDragDropSrvc.drawDeviceAndAlertNote,DrawDeviceAndIntfs:nbDragDropSrvc.drawDeviceAndIntfs,DrawDeviceGroup:nbDragDropSrvc.drawDeviceGroup,DrawSite:nbDragDropSrvc.drawSite,DrawStencilItem:nbDragDropSrvc.drawStencilItem,DrawPath:nbDragDropSrvc.drawPath,DrawNeighbour:nbDragDropSrvc.drawNeighbor,DrawJson:nbDragDropSrvc.drawJson,DrawNodeByTopoLinks:nbDragDropSrvc.drawNodeByTopoLinks,OpenPanel:nbDragDropSrvc.openPanel,QappEditorRunQapp:qappEditorRunQapp,DrawNode:nbDragDropSrvc.drawNode,DrawMapWithOneIp:nbDragDropSrvc.drawDeviceAndIntfs};if($scope.netmap.extAction){var extAction=$scope.netmap.extAction;actionDic[extAction.actionType]&&actionDic[extAction.actionType](extAction)}handleApiActions()}$timeout((function(){doAction()}),200);var rootScopeOnDoAction=$rootScope.$on(netMapEvent.netMapDoAction,(function(){doAction()}));$scope.showBigOverviewTip=function(message,defaultHide){isFirstOpen("BigOverviewTip")&&showMapPageTip(message,defaultHide)};$scope.showBigTopologyViewTip=function(message,defaultHide){isFirstOpen("BigTopologyViewTip")&&showMapPageTip(message,defaultHide)};$scope.$watch((function(){return $scope.netmap.getVisualSpaceInfo()}),(function(newValue,oldValue){if(newValue!==oldValue||null!=newValue&&null!=newValue.visualSpaceInstanceId&&!NetBrain.CurAutolinkType.hasOwnProperty(newValue.visualSpaceInstanceId)){var vsInfo=newValue;null!=vsInfo&&$rootScope.$emit("getAutoLinkTypeByVisualSpaceId",vsInfo.visualSpaceInstanceId)}}),!0);function showMapPageTip(message,defaultHide){var tipId=function(message,defaultHide){return nbTipSrvc.open({tipInfo:message,autoClose:!1,hasCloseBtn:!0,defaultHide:!!defaultHide})}(message,defaultHide);var unwatchMapPageActive=function(tipId){return $scope.$watch((function(){return $scope.mapPageObj.realActive}),(function(newValue,oldValue){newValue!==oldValue&&(newValue?nbTipSrvc.show(tipId):nbTipSrvc.hide(tipId))}))}(tipId);var unwachCloseMapEvent=$rootScope.$on("CloseMapOndesktop",(function(){unwatchMapPageActive();unwachCloseMapEvent();nbTipSrvc.close(tipId)}))}function isFirstOpen(tipKey){return!function(tipKey){var key=userSrvc.getUserName()+"_OVERVIEWMAP_FIRST_OPEN";var data=utilitySrvc.getSessionStorage(key)||{};var subKey=tipKey+"_"+httpAuthSrvc.getDataSrc(utilitySrvc).DomainGuid[0];var hasOpened=data[subKey];if(!hasOpened){data[subKey]=!0;utilitySrvc.setSessionStorage(key,data)}return hasOpened}(tipKey)}$scope.mapLayoutMiniPaneOption={isShow:!0,showOption:{isRealShow:!0}};var rootScopeOnOpenMapLayoutMiniPane=$rootScope.$on(NetBrain.MapLayout.Const.MapLayoutEvent.OpenMapLayoutMiniPane,(function(){var currentPageId=NetBrain.Map.currentActiveMapPage.getDocId();var pageId=$scope.mapPageObj.getDocId();if(currentPageId===pageId){var elementIdBuilder=NetBrain.MapLayout.Const.elementIdBuilder;if(angular.element(elementIdBuilder.getFirstPaneId(pageId)).length>0||angular.element(elementIdBuilder.getMiniPaneId(pageId)).length>0)return;if(angular.element(elementIdBuilder.getMiniPaneId(pageId)).length>0)$scope.mapLayoutMiniPaneOption.showOption={isRealShow:!0};else{$scope.mapLayoutMiniPaneOption.mapPageId=pageId;var containerId="#realPage-"+pageId+"-container";var $newElement=$compile('<nb-map-layout-mini-pane-directive netmap-operator="netmapOperator" options-out="mapLayoutMiniPaneOption" show-option="mapLayoutMiniPaneOption.showOption" ></nb-map-layout-mini-pane-directive>')($scope);angular.element(containerId).append($newElement)}}}));$scope.$on("$destroy",(function(){if(!window.isInIframe){ngHub.getInstance().unsubBusinessId("UpdateMapView",$scope.buildHubBusinessId());ngHub.getInstance().unsubBusinessId("UpdateMapView_QappFirstPeriod",$scope.buildHubBusinessId());ngHub.getInstance().unsubBusinessId("UpdateMapView_QappEnd",$scope.buildHubBusinessId())}var mapId=$scope.mapPageObj.getDocId();dataViewInfoMgr.unRegisterMapDataViewInfos(mapId);outEditMode();enterEditMode();tracerouteMap();onUpdateMapDataView();newDataViewForMiniTask();onApplyTemporaryDataView();rootScopeonchangeAreaSelectState();rootScopeGEventOpenDetailPanelFormDrillDownPanel();rootScopeGEventOpenDetailPanelFormAlert();clearTemporaryDataView();editLinkClose();openEditDataViewFromContext();editDeviceClose();editDataViewClose();rootScopeontoggleTopPanel();rootScopemapbasedsearchresultpaneopen();rootScopeonchangeDrawingState();multiTabEventSrvcSwitchTab();getAutoLinkTypeByVisualSpaceId();rootScopeOnOpenMapLayoutMiniPane();offApplyDataviewByAlertResult();rootScopeOnDoAction();$scope.CloseExtendNbrghbor();$scope.updateMapDataViewTimer&&$timeout.cancel($scope.updateMapDataViewTimer);$scope.netmap._diagram=null;$scope.netmap._model=null;$scope.netmap._netmapJsWrapper.pageData=null;$scope.netmap._netmapJsWrapper=null;$scope.netmap._cmdTarget.computePathManager=null;$scope.netmap._cmdTarget=null;$scope.netmap.realImage=null;$scope.netmap._netmapOperator=null;$scope.netmap._mapViewOption=null;$scope.netmap.dataViewInfo=null;$scope.netmap.newLinkList=null;$scope.netmap.newNodeList=null;$scope.mapPageObj=null;$scope.netmap=null;$scope.httpDeviceSrvc=null;$scope.origscale=null;$scope.netmapOperator.diagramPathManager=null;$scope.netmapOperator.netmapModeBase=null;$scope.netmapOperator.pathTip=null;$scope.netmapOperator._netmap=null;$scope.netmapOperator=null;$scope.netmapCmdTarget.drawTools=null;$scope.netmapCmdTarget=null;$scope.netMapObjsSelection=null;$scope.editingDataView=null}));!function(){if(!0===window.isInIframe){$scope.redPlusClick=function(){};$scope.ObjectContextClicked=function(){};$scope.BackgroundContextClicked=function(){};$scope.doubleClickDevice=function(){};$scope.linkLabelMouseEnter=function(){};$scope.linkLabelMouseLeave=function(){};$scope.showShapToolbar=function(){};$scope.showEditorToolbar=function(){};$scope.showFloatButton=!1}}()}}(NetBrain);!function(netBrain){angular.module("nb.qmap").controller("nb.qmap.nbMapDataViewTitleCtrl",nbMapDataViewTitleCtrl);nbMapDataViewTitleCtrl.$inject=["$rootScope","$scope","$element","$timeout","nb.qmap.updateMapSrvc","nb.qmap.mapManagerSrvc","nb.dataview.httpDataViewSrvc","nb.netbrain.dataViewCacheSrvc","nb.dataview.applyDataViewSrvc","nb.dataview.httpDataViewManagerSrvc","nb.common.nbAlertSrvc","nb.dataview.detailPaneSrvc","nb.uiframework.urlStateMgr"];function nbMapDataViewTitleCtrl($rootScope,$scope,$element,$timeout,updateMapSrvc,mapManagerSrvc,httpDataViewSrvc,dataViewCacheSrvc,applyDataViewSrvc,httpDataViewManagerSrvc,nbAlertSrvc,detailPaneSrvc,urlStateMgr){var dvIconObj={default:"default-dataview-14",dynamic:"action_node_dynamic_dataview_14",static:"action_node_static_dataview_14",map:"action-node-map-dataview-14"};var defaultDataViewInfo={icon:dvIconObj.default,title:"Default Data View",time:""};$scope.dataViewInfo=defaultDataViewInfo;$scope.currentStyle={left:""};$scope.isShowMenu=!0;$scope.viewModel={isShow:!0};$scope.mapDVList=[];var menuConfig={edit:{name:"Edit",action:function(){updateMapSrvc.canUpdateCurrentMap().then((function(){$rootScope.$emit(NetBrain.Map.Event.EditDataViewFromDataViewTitleBar)}))}},saveAs:{name:"Save As",action:function(){$rootScope.$emit("saveAsDataView")}},delete:{name:"Delete",action:function(){var dvId=mapManagerSrvc.getActivePage().getExtendData().extendDataViewData.dataViewId;dvId&&updateMapSrvc.canUpdateCurrentMap().then((function(){return nbAlertSrvc.confirm({message:"Are you sure you want to delete the Data View?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]})})).then((function(){return httpDataViewManagerSrvc.deleteDataViewGroup(dvId)})).then((function(obj){$rootScope.$emit("clearAllDataViews");!function(){var page=mapManagerSrvc.getActivePage();var extendData=page.getDefaultExtendData();extendData.extendDataViewData;page.setExtendData(extendData);setContent()}()}))}}};$scope.onOpenDataViewManager=function(){var activeMap=mapManagerSrvc.getActivePage();if(null!=activeMap){var url="dataviewMgr.html#/GlobalDataView?dataViewTreeType="+DataViewTreeType.MapDataView+"&mapId="+activeMap.getDocId();urlStateMgr.switchTabOrOpenNewTab(url,DataViewTreeType.MapDataView,(function(){urlStateMgr.openNewTab(url)}))}};$scope.selectMapDV=function(dv){var page=mapManagerSrvc.getActivePage();var netmapOperator=page.getNetmapOperator();updateMapSrvc.canUpdateCurrentMap().then((function(){return netmapOperator.resetDefaultDataView(dataViewCacheSrvc,!1)})).then((function(){var diagram=page._diagram;var devIds=_.pluck(diagram.model.nodeDataArray,"key");!function(mapDv){var page=mapManagerSrvc.getActivePage();var extendData=page.getDefaultExtendData();var extendDataViewData=extendData.extendDataViewData;extendDataViewData.dataViewName=mapDv.name;extendDataViewData.dataViewId=mapDv.ID;extendDataViewData.dataViewGroupScope=DataViewGroupScope.dvgScopeMap;extendDataViewData.lastUpdateTime=mapDv.lastUpdateTime;page.setExtendData(extendData)}(dv);return applyDataViewSrvc.applyDataviewsOnDevices(devIds,dv.ID)})).then((function(){$rootScope.$emit(NetBrain.Map.Event.DataViewChanged);$rootScope.$emit("closeCacheLiveRunBox");detailPaneSrvc.closeDetailPane()})).then(setContent)};$scope.onDVTitleClick=function(){var extendData=mapManagerSrvc.getActivePage().getExtendData();if(isDVTOrQappNode(extendData)){var extendRunbookData=extendData.extendRunbookData;$rootScope.$emit(RunBookEvent.SelectedRunbookNodeAndResult,{runbookId:extendRunbookData.runbookId,runbookNodeId:extendRunbookData.runbookNodeId,alogId:extendRunbookData.runbookNodeResultId})}};$scope.formatTime=function(time){var nTime=new Date(time);return time=moment.utc(nTime).local().format("MM/DD/YYYY hh:mm:ss A")};function setContent(){var appliedDvInfo=mapManagerSrvc.getAppliedDataViewInfo();!function(title,icon,time){time&&(time=$scope.formatTime(time));$scope.dataViewInfo={title:title,icon:icon,time:time}}(appliedDvInfo.dvName,appliedDvInfo.dvIcon,appliedDvInfo.lastUpdateTime);!function(){var extendData=mapManagerSrvc.getActivePage().getExtendData();var menuList=[];if(function(extendData){return extendData.extendDataViewData.dataViewGroupScope===DataViewGroupScope.dvgScopeGlobal}(extendData))menuList.push(menuConfig.edit);else if(function(extendData){return extendData.extendDataViewData.dataViewGroupScope===DataViewGroupScope.dvgScopeMap}(extendData)){menuList.push(menuConfig.edit);menuList.push(menuConfig.delete)}else(function(extendData){var flag=isDVTOrQappNode(extendData);flag&&(flag=!NgUtil.getValueFromObjAndPath(extendData,"extendDataViewTemplateData.dataViewTemplateId"));return flag})(extendData)&&menuList.push(menuConfig.edit);menuList.push(menuConfig.saveAs);$scope.menuList=menuList}()}function refresh(){var currentPageId=mapManagerSrvc.getActivePage().getDocId();$element.parent().attr("pageId")===currentPageId&&init()}function init(){setContent();(currentPageId=mapManagerSrvc.getActivePage().getDocId(),httpDataViewSrvc.getMapDataViewList(currentPageId).then((function(result){var icon=dvIconObj.map;_.each(result,(function(item){item.icon=icon}));var list=_.sortBy(result,"lastUpdateTime");$scope.mapDVList=list}),(function(){}))).then((function(){}));var currentPageId}function isDVTOrQappNode(extendData){var flag=!1;extendData&&extendData.extendRunbookData&&extendData.extendRunbookData.runbookNodeId&&(flag=!0);return flag}init();mapManagerSrvc.setCurrentMapPageSubPaneBackground(".switch-cache-to-live",mapManagerSrvc.getActivePage().getBackColor());var watchBackgroundColorChange=$rootScope.$on("BackgroundColorChange",(function(ev,color){mapManagerSrvc.setCurrentMapPageSubPaneBackground(".switch-cache-to-live",color)}));var watchDataViewChanged=$rootScope.$on(NetBrain.Map.Event.DataViewChanged,(function(){refresh()}));var watchActivePageChanged=$rootScope.$on(NetBrain.Map.Event.ActivePageChanged,(function(){refresh()}));var watchHideDataViewTitle=$rootScope.$on(NetBrain.Map.Event.HideDataViewTitle,(function(){$scope.viewModel.isShow=!1}));var watchShowDataViewTitle=$rootScope.$on(NetBrain.Map.Event.ShowDataViewTitle,(function(){$scope.viewModel.isShow=!0}));var watchAppliedDataView=$rootScope.$on(NetBrain.Map.Event.AppliedDataView,(function(event){setContent()}));var watchQAppStatusChanged=$rootScope.$on(NetBrain.Map.Event.QAppStatusChanged,(function(event,isRunning){$scope.isShowMenu=!isRunning}));var watchMapDataViewListChanged=$rootScope.$on(NetBrain.Map.Event.MapDataViewListChanged,(function(){refresh()}));var watchUpdateMapDataViewTitle=$rootScope.$on(NetBrain.Map.Event.UpdateMapDataViewTitle,(function(event){setContent()}));$scope.$watch((function(){return mapManagerSrvc.getActivePage().getExtendData()}),(function(){setContent()}),!0);$scope.$on("$destroy",(function(){watchBackgroundColorChange();watchActivePageChanged();watchDataViewChanged();watchHideDataViewTitle();watchShowDataViewTitle();watchAppliedDataView();watchQAppStatusChanged();watchMapDataViewListChanged();watchUpdateMapDataViewTitle()}));!function(){if(!0===window.isInIframe){$scope.onDVTitleClick=function(){console.log("onDVTitleClick clicked")};$scope.isShowMenu=!1;watchQAppStatusChanged()}}()}}(NetBrain);!function(){angular.module("nb.qmap").controller("nb.qmap.nbQappInstancePaneCtrl",nbQappInstancePaneCtrl);nbQappInstancePaneCtrl.$inject=["$scope","$rootScope","$element","$timeout","nb.ng.utilitySrvc","nb.ng.featureSrvc","$q","nb.dataview.dataViewPanelSrvc","nb.qmap.mapManagerSrvc"];function nbQappInstancePaneCtrl($scope,$rootScope,$element,$timeout,utilitySrvc,featureSrvc,$q,dataViewPanelSrvc,mapManagerSrvc){$scope.dataModel={curTab:null,DataViewStatus:dataViewPanelSrvc.Const.DataViewStatus};!1;$scope.onMainPaneCloseClick=function(){mapManagerSrvc.getActivePage().currentScopeRef.hideQappInstancePane()};var watchCloseMainPane=$rootScope.$on(MapLeftPaneEvent.CLOSE_QAPP_INSTANCE_PANE,(function(){$scope.onMainPaneCloseClick()}));$scope.$on("$destroy",(function(){watchCloseMainPane()}))}}();!function(netBrain){angular.module("nb.qmap").controller("nb.qmap.qMapCtrl",qMapCtrl);qMapCtrl.$inject=["$scope","$rootScope","$q","$timeout","$location","$compile","osApp","nb.qmap.httpMapSrvc","nb.networkos.osMsgSrvc","nb.qmap.StencilSrvc","nb.ng.utilitySrvc","nb.common.nbAlertSrvc","nb.uiframework.urlStateMgr","nb.datamodel.httpSiteSrvc","nb.topo.httpTopoSrvc","nb.qmap.mapContextMenuSrvc","nb.netbrain.dataViewCacheSrvc","nb.qmap.mapManagerSrvc","nb.ng.userSrvc","nb.qmap.drawMapAPISrvc","nb.uiframework.mainUISrvc","nb.netbrain.httpDeviceSrvc","nb.qmap.editorToolbarOptions","nb.runbook.runbookMgr","domainSwitch","nb.common.nbTipSrvc","$http","$log","nb.ng.httpAuthSrvc","nb.topo.httpMediaTypesSrvc","nb.collaboration.collaborationGridSrvc","nb.qmap.monitorDataviewSrvc","nb.qmap.mapContextMenuAction","nb.netbrain.httpMapViewOptionSrvc","nb.common.cacheSiteInfoSrvc","nb.common.cacheInterfaceInfoSrvc","nb.common.nbCalculationTipSrvc","nb.qmap.randomColorSrvc","nb.qmap.updateMapSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.qmap.mapLayoutSrvc","md5","nb.qmap.newMapIndexSrvc","nb.runbook.httpRunBookSrvc","nb.ng.deviceAccessCacheSrvc","nb.ticket.consts","nb.dataview.detailPaneSrvc"];function qMapCtrl($scope,$rootScope,$q,$timeout,$location,$compile,osAppProvider,httpMapSrvc,osMsgSrvc,StencilSrvc,utilitySrvc,nbAlertSrvc,urlStateMgr,httpSiteSrvc,httpTopoSrvc,mapContextMenuSrvc,dataViewCacheSrvc,mapManagerSrvc,userSrvc,drawMapAPISrvc,mainUISrvc,httpDeviceSrvc,editorToolbarOptions,runbookMgr,domainSwitchProvider,nbTipSrvc,$http,$log,httpAuthSrvc,httpMediaTypesSrvc,collaborationGridSrvc,monitorDataviewSrvc,mapContextMenuAction,httpMapViewOptionSrvc,cacheSiteInfoSrvc,cacheInterfaceInfoSrvc,nbCalculationTipSrvc,randomColorSrvc,updateMapSrvc,httpDeviceGroupSrvc,mapLayoutSrvc,md5,newMapIndexSrvc,httpRunBookSrvc,deviceAccessCacheSrvc,ticketConsts,detailPaneSrvc){$scope.mapPaneHelper={mapScope:$scope,minWidth:306,fullViewWidth:565,width:306,resizablePaneSharedWidth:function($element,$scope){var mapPaneHelper=this;$element.resizable({handles:"e",maxWidth:mapPaneHelper.maxWidth,minWidth:mapPaneHelper.minWidth,stop:function(event,ui){mapPaneHelper.setPaneWidth(ui.size.width)}});$scope.$on("$destroy",$scope.$watch((function(){return mapPaneHelper.width}),(function(newValue){$element.width(newValue)})))},setPaneWidth:function(width){var mapPaneHelper=this;$timeout((function(){mapPaneHelper.width=width}))}};$scope.initMapDataFinished=!1;$scope.doUpdateMaping={updating:!1};$scope.ticketConsts=ticketConsts;$scope.showSwitchCacheStyle={};function getQueryString(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=window.location.search.substr(1).match(reg);return null!=r?unescape(r[2]):null}netBrain.Map.MapArgs=netBrain.Map.MapArgs||{};var mapType=netBrain.Map.MapArgs.mapType;getQueryString("mapType")&&(mapType=parseInt(getQueryString("mapType")));$scope.isSystemDeviceGroupMapType=!1;var mapId=getQueryString("id")||netBrain.Map.MapArgs.id;var actionKey=getQueryString("actionKey")||netBrain.Map.MapArgs.actionKey;var activePageId=getQueryString("activePageId")||netBrain.Map.MapArgs.activePageId;var fromMapId=getQueryString("fromMapId")||netBrain.Map.MapArgs.fromMapId;var fromMapType=getQueryString("fromMapType")||netBrain.Map.MapArgs.fromMapType;var runbookId=getQueryString("rba")||netBrain.Map.MapArgs.rba;var havLoadMapObj=null;var initCtrl=function(){randomColorSrvc.resetColor();var deferred1=$q.defer();if(mapId){var loadQmapFromServer=function(isClone,newMapId,newMapType,sysMapAlreadyExist){var title="Opening Map...";!1===sysMapAlreadyExist&&(title="Creating Map...");nbCalculationTipSrvc.showCalculationTip({title:title});var promise=null;if(null!=newMapType&&newMapType!==netBrain.Map.Const.MapType.general)promise=newMapType===netBrain.Map.Const.MapType.mapLayoutSampleMap?mapLayoutSrvc.getSampleMapDataObj(newMapId):httpMapSrvc.getSystemMapByKey(newMapId,newMapType);else if("isWidget"===utilitySrvc.getLocalStorage(newMapId)){utilitySrvc.removeLocalStorage(newMapId);promise=httpMapSrvc.getMapByKey(newMapId,!0)}else promise=httpMapSrvc.getMapByKey(newMapId);promise.then((function(jsData){if(void 0===jsData){$scope.initMapDataFinished=!1;nbCalculationTipSrvc.closeCalculationTip();null==runbookId?(mainUISrvc.isDesktop(),nbAlertSrvc.alert(netBrain.Map.Message.NoFoudMapMsg).then((function(){urlStateMgr.redirectToDesktop()}))):openRunbookInEmptyMap();deferred1.reject()}else{var map=new netBrain.Map.CQMap(0);httpMapSrvc.getTopoLinkPolicyInfo().then((function(policyData){map.setTopoLinkPolicyInfo(policyData)}),(function(){})).then((function(){return httpMapSrvc.getDefaultIconsByDevTypes([1004,1036])})).then((function(iconList){map.setDefaultIconList(iconList)}),(function(){})).then((function(){map.fromJson(jsData);if(isClone){mapManagerSrvc.convertToNormalMap(map,mapId);map.setRealNew(!0);map.setModify(!0)}map.getMapType()===netBrain.Map.Const.MapType.deviceGroupMap&&httpDeviceGroupSrvc.getDeviceGroupByGuid_no_devices(map.getDocId()).then((function(res){2===res.Type&&($scope.isSystemDeviceGroupMapType=!0)}));var pageType=mainUISrvc.isDesktop()?netBrain.NG.Const.PageType.Desktop:netBrain.NG.Const.PageType.Map;urlStateMgr.setPageSession(netBrain.NG.Const.PageType.Map+mapId,map.getTitle(),pageType,{subType:netBrain.NG.Const.PageType.Map});if(!map.getEditRight().editorName){map.setEditRight(userSrvc.getUserName(),userSrvc.getUserID());map.isTempEditRight=!0;httpMapSrvc.getTempEditingRight(map.getDocId(),window.name).then((function(){urlStateMgr.setPageSession(netBrain.NG.Const.PageType.Map+mapId,$scope.activeMap.getTitle(),pageType,{subType:netBrain.NG.Const.PageType.Map,keepalived:!0})}),(function(){urlStateMgr.setPageSession(netBrain.NG.Const.PageType.Map+mapId,$scope.activeMap.getTitle(),pageType,{subType:netBrain.NG.Const.PageType.Map,keepalived:!0})}))}$scope.activeMap=map;newMapType!==netBrain.Map.Const.MapType.siteMap&&newMapType!==netBrain.Map.Const.MapType.deviceGroupMap||httpMapSrvc.getHasUpdatedInfoByKey(newMapId,newMapType).then((function(ret){ret&&function(newMapType){var mes="";var isShowTip=!0;if(newMapType===netBrain.Map.Const.MapType.siteMap)mes="<span>"+StringUtil.format(netBrain.Map.Message.SiteMapIsTimeExpire,{updatemap:'<a style="cursor:pointer" ng-click="callBack()">update map</a>'})+"</span>";else if(newMapType===netBrain.Map.Const.MapType.deviceGroupMap){mes="<span>"+StringUtil.format(netBrain.Map.Message.DeviceGroupMapIsTimeExpire,{updatemap:'<a style="cursor:pointer" ng-click="callBack()">update map</a>'})+"</span>";var activeMap=mapManagerSrvc.getActiveMap();mapManagerSrvc.hasEditingRights(activeMap)||(isShowTip=!1)}var options={tipInfo:"",autoClose:!1,hasCloseBtn:!0,template:mes,callBack:function(){$scope.$broadcast(netBrain.Map.Event.StartUpdateMap)}};isShowTip&&nbTipSrvc.open(options)}(newMapType)}));if(newMapType==NetBrain.Map.Const.MapType.visualSpaceOverViewMap){var bNeedSavePageThumbnail=!1;$scope.activeMap._docList.forEach((function(page){""==page._netmapJsWrapper.pageData.pageExtraData.image&&(bNeedSavePageThumbnail=!0)}));bNeedSavePageThumbnail&&$timeout((function(){$scope.activeMap.setRealNew(!0);mapManagerSrvc.saveMap().then((function(){$scope.activeMap.setRealNew(!1)}))}),3e3)}!function(){if($scope.activeMap.getFromMapId()){var options={tipInfo:"",hasCloseBtn:!0,autoClose:!1,template:'<div style="text-align:left;">'+StringUtil.format(netBrain.Map.Message.IsCopyMapTipMsg,{originalmap:'<a style="cursor:pointer" ng-click="callBack()">original map</a>'})+"</div>",callBack:function(){var ops={id:$scope.activeMap.getFromMapId()};urlStateMgr.openMap(ops)}};nbTipSrvc.open(options)}}();deferred1.resolve()}))}}),(function(data){nbCalculationTipSrvc.closeCalculationTip();mainUISrvc.isDesktop(),nbAlertSrvc.alert(netBrain.Map.Message.NoFoudMapMsg).then((function(){urlStateMgr.redirectToDesktop()}));$scope.initMapDataFinished=!1;deferred1.reject()}))};var newMapOption=utilitySrvc.getLocalStorage("CreateMap"+mapId);if(newMapOption){utilitySrvc.removeLocalStorage("CreateMap"+mapId);if(fromMapId)loadQmapFromServer(!0,fromMapId,fromMapType);else{nbCalculationTipSrvc.showCalculationTip({title:"Creating Map..."});$timeout((function(){var newIndex=newMapIndexSrvc.getNewMapIndex();var map=new netBrain.Map.CQMap(newIndex);httpMapSrvc.getTopoLinkPolicyInfo().then((function(policyData){map.setTopoLinkPolicyInfo(policyData)}),(function(){})).then((function(){return httpMapSrvc.getDefaultIconsByDevTypes([1004,1036])})).then((function(iconList){map.setDefaultIconList(iconList)}),(function(){})).then((function(){map.createSubDoc(!0);map.setDocId(mapId);$scope.activeMap=map;$scope.initMapDataFinished=!0;newMapOption.title&&$scope.activeMap.setTitle(newMapOption.title);deferred1.resolve()}))}))}}else{var constSiteMap=netBrain.Map.Const.MapType.siteMap;var constDeviceGroupMap=netBrain.Map.Const.MapType.deviceGroupMap;mapType===constSiteMap||mapType===constDeviceGroupMap?httpMapSrvc.isMapExist(mapId).then((function(isLimitedMapExist){loadQmapFromServer(!1,mapId,mapType,isLimitedMapExist)}),(function(){loadQmapFromServer(!1,mapId,mapType)})):loadQmapFromServer(!1,mapId,mapType)}$rootScope.$emit(viewFrameEvent.Minimize,"map")}else if(havLoadMapObj){$scope.activeMap=havLoadMapObj;$scope.initMapDataFinished=!0;deferred1.resolve()}return deferred1.promise.then((function(){if(void 0===$scope.activeMap){nbCalculationTipSrvc.closeCalculationTip();nbAlertSrvc.alert(netBrain.Map.Message.NoFoudMapMsg).then((function(){urlStateMgr.redirectToDesktop()}))}if(activePageId){$scope.activeMap.deactiveAllPage();var findPage=$scope.activeMap.getDocById(activePageId);findPage&&findPage.setActive(!0)}$scope.activePage=$scope.activeMap.getActiveNetmap();mapManagerSrvc.getMapFromCache(actionKey).then((function(extAction){$scope.activePage.extAction=extAction;$rootScope.$emit(netMapEvent.netMapDoAction,"Do extAction")}));netBrain.Map.currentActiveMap=$scope.activeMap;netBrain.Map.currentActiveMapPage=$scope.activePage;$scope.initMapDataFinished=!0;$scope.qmapObj=$scope.activeMap;if(mainUISrvc.isDesktop())$rootScope.$emit(netBrain.NetworkOS.Const.UIFramework.Events.ShowMainContentArea,"floating-map",$scope.qmapObj);else{var documentTitle=StringUtil.format(netBrain.NetworkOS.Const.UIFramework.DocumentTitleTemplate.Map,{mapName:$scope.activeMap.getTitle()});document.title=documentTitle;$scope.activeMap.isTempEditRight,urlStateMgr.setPageSession(netBrain.NG.Const.PageType.Map+mapId,$scope.activeMap.getTitle(),netBrain.NG.Const.PageType.Map,{subType:netBrain.NG.Const.PageType.Map,keepalived:!0})}_registerChangeDomainApp();netBrain.Map.MapArgs.callBack&&"function"==typeof netBrain.Map.MapArgs.callBack&&netBrain.Map.MapArgs.callBack();nbCalculationTipSrvc.closeCalculationTip();monitorDataviewSrvc.checkNetMapMonitor($scope.activePage,!0);var pages=$scope.activeMap.getAllPage();_.each(pages,(function(page){page.getMapViewOptionJson()||(userSrvc.getUserConf().getJsWrapper().getMapViewOption()?page.setMapViewOptionJson(userSrvc.getUserConf().getJsWrapper().getMapViewOption()):page.setMapViewOptionJson(netBrain.Map.Const.MapViewOptionSetting));if(!page.getL3StyleInExpandedStyle()){var userL3=userSrvc.getUserConf().getJsWrapper().getUserL3StyleInExpandedStyle();var sysL3=netBrain.Map.Const.getL3StyleInExpandedStyle();userL3?page.setL3StyleInExpandedStyle(userL3):page.setL3StyleInExpandedStyle(sysL3)}if(-1===page.getInterfaceHighlightMode()){var highlightModeUC=userSrvc.getUserConf().getJsWrapper().getUserInterfaceHighlightMode();highlightModeUC?page.setInterfaceHighlightMode(highlightModeUC):page.setInterfaceHighlightMode(netBrain.Map.Const.DefaultInterfaceHighlightMode)}var vsId=getVspaceIdByPage(page);var userDefaultTopoTypes=userSrvc.getUserConf().getJsWrapper().getMapAutoLinkOptionList(vsId);page.getMapAutoLinkOptionList(vsId)||(userDefaultTopoTypes?page.setMapAutoLinkOptionList(userDefaultTopoTypes,vsId):page.setMapAutoLinkOptionList(["L3_Topo_Type"],vsId))}));_.some($scope.activeMap.getAllPage(),(function(m){return m.getIsFirstView()}))&&function(netmap){var deferred=$q.defer();!function eachGet(){var netmapOperator=netmap.getNetmapOperator();null==netmapOperator?$timeout(eachGet,400):deferred.resolve(netmapOperator)}();return deferred.promise}($scope.activePage).then((function(){$scope.activeMap.setModify(!0);_.each($scope.activeMap.getAllPage(),(function(m){m.setIsFirstView(!1)}));mapManagerSrvc.saveMap(!0)}))}))};function getVspaceIdByPage(mapPage){if(null==mapPage)return VisualSpaceConstant.defaultVisualSpaceInstanceId;var info=mapPage.getVisualSpaceInfo();return null==info?VisualSpaceConstant.defaultVisualSpaceInstanceId:info.visualSpaceInstanceId}function openRunbookInEmptyMap(){httpRunBookSrvc.getRunbookById(runbookId).then((function(rb){if(rb)if(2!==rb.rbType)nbAlertSrvc.alert(netBrain.Map.Message.NoFoudMapMsg).then((function(){urlStateMgr.redirectToDesktop()}));else if(rb.mapId!==mapId)if(mainUISrvc.isDesktop()){mapId=rb.mapId;initCtrl()}else urlStateMgr.redirectTo(utilitySrvc.replaceParameter("id",rb.mapId));else{var emptyMapId=NgUtil.getGUID();httpRunBookSrvc.resetRunbookMapId(runbookId,emptyMapId).then((function(d){mapId=emptyMapId;utilitySrvc.setLocalStorage("CreateMap"+mapId,{});initCtrl()}))}else nbAlertSrvc.alert(netBrain.Map.Message.NoFoudMapMsg).then((function(){urlStateMgr.redirectToDesktop()}))}),(function(error){error&&329013===error.ResultCode&&nbAlertSrvc.warning("You don't have the privilege to view Network Change. Please contact your NetBrain administrator for details.").then((function(){urlStateMgr.redirectToDesktop()}))}))}setTimeout((function(){(function(){var deferred=$q.defer();var vsId=getVspaceIdByPage(null);var mapViewOptionCache=userSrvc.getUserConf().getJsWrapper().getMapViewOption();if(mapViewOptionCache){deferred.resolve(mapViewOptionCache);return deferred.promise}var qList=[httpMapViewOptionSrvc.getMapViewOptionByUserId(),httpMapViewOptionSrvc.getL3StyleInExpandedStyle(),httpMapViewOptionSrvc.getMapAutoLinkTopotypeIds(vsId),httpMapViewOptionSrvc.getMapAutoLinkOptionExcluedeMip(vsId)];$q.all(qList).then((function(result){var data=result[0];var l2Settings=result[1];var userL3StyleInExpandedStyle;var interfaceHighlightMode;if(l2Settings){userL3StyleInExpandedStyle=l2Settings.l3StyleInExpandedStyle;interfaceHighlightMode=l2Settings.highlightMode}var userDefaultTopoTypes=result[2];if(data)if(_.isArray(data)){var obj=JSON.parse(data[0]);obj.options&&obj.options.length>0&&userSrvc.getUserConf().getJsWrapper().setMapViewOption(obj)}else userSrvc.getUserConf().getJsWrapper().setMapViewOption(data);else userSrvc.getUserConf().getJsWrapper().setMapViewOption(netBrain.Map.Const.MapViewOptionSetting);userL3StyleInExpandedStyle?userSrvc.getUserConf().getJsWrapper().setUserL3StyleInExpandedStyle(userL3StyleInExpandedStyle):userSrvc.getUserConf().getJsWrapper().setUserL3StyleInExpandedStyle(netBrain.Map.Const.getL3StyleInExpandedStyle());_.isNumber(interfaceHighlightMode)?userSrvc.getUserConf().getJsWrapper().setUserInterfaceHighlightMode(interfaceHighlightMode):userSrvc.getUserConf().getJsWrapper().setUserInterfaceHighlightMode(netBrain.Map.Const.DefaultInterfaceHighlightMode);userDefaultTopoTypes&&userSrvc.getUserConf().getJsWrapper().setMapAutoLinkOptionList(userDefaultTopoTypes,vsId);var autoLinkOptionExcluedeMip=result[3];null!=autoLinkOptionExcluedeMip&&userSrvc.getUserConf().getJsWrapper().setMapAutoLinkOptionExcluedeMip(vsId,autoLinkOptionExcluedeMip);deferred.resolve()}),(function(){userSrvc.getUserConf().getJsWrapper().setMapViewOption(netBrain.Map.Const.MapViewOptionSetting);userSrvc.getUserConf().getJsWrapper().setUserL3StyleInExpandedStyle(netBrain.Map.Const.getL3StyleInExpandedStyle());userSrvc.getUserConf().getJsWrapper().setUserInterfaceHighlightMode(netBrain.Map.Const.DefaultInterfaceHighlightMode)}));return deferred.promise})().then((function(){initCtrl()}))}),0);var rootScopeonReInitMapCtrl=$rootScope.$on("ReInitMapCtrl",(function(event,mapArgs){mapType=mapArgs.mapType;mapId=mapArgs.id;fromMapId=mapArgs.fromMapId;fromMapType=mapArgs.fromMapType;actionKey=mapArgs.actionKey;activePageId=mapArgs.activePageId;havLoadMapObj=mapArgs.havLoadMapObj;var rba=mapArgs.rba;initCtrl().then((function(){$rootScope.$emit("ReInitNetMapCtrl");mainUISrvc.isDesktop()&&rba&&$timeout((function(){$rootScope.newRBA=rba;runbookMgr.switchRBA(rba)}),300);mapArgs.callBack&&"function"==typeof mapArgs.callBack&&mapArgs.callBack();$timeout((function(){$rootScope.$emit(netBrain.Map.Event.ActivePageChanged)}),200)}))}));$scope.getNetMapJsData=function(pageId){var tempMapPage=$scope.qmapObj.getDocById(pageId);return null==tempMapPage?null:tempMapPage.toJson()};$scope.initRequestUpdate=function(){if(null!=$scope.activePage&&null!=$scope.activePage.diagram){var diagramPage=$scope.activePage.diagram;null!=diagramPage&&diagramPage.delayInitialization((function(){diagramPage.requestUpdate()}))}};$scope.getAddWidth=function(){var mapPageScope=mapManagerSrvc.getActivePage().currentScopeRef;var addWidth=0;if(mapPageScope.isMapPanelTabShow){addWidth=0;mapPageScope.runbookOpenWidth.width&&(addWidth=parseInt(mapPageScope.runbookOpenWidth.width));if(0===addWidth){var idName="realPage-"+mapManagerSrvc.getActivePage().getDocId()+"-container";var mapPanelTab=angular.element("#"+idName+" .map-panel-tab");var parentDiv=mapPanelTab.closest(".data-view-run-book-pane");var parentDivVisible=parentDiv.is(":visible");mapPanelTab.length>0&&parentDivVisible&&0===(addWidth=parentDiv.width())&&(addWidth=mapPanelTab.width())}}else mapPageScope.isShowMapLayoutPane&&(addWidth=parseInt(mapPageScope.pinMapLayoutPaneCss.width));return addWidth};$scope.initRequestUpdate();$scope.closeSiteInfoTimer=null;$scope.startSiteInfoTimer=null;var siteInfoMousEnterHandler=$scope.$on("siteInfoMousEnter",(function(event,e,target){$scope.closeSiteInfoTimer&&$timeout.cancel($scope.closeSiteInfoTimer);var site=target.part.data;$scope.startSiteInfoTimer=$timeout((function(){if(!mapContextMenuSrvc.isShowStatus()||mapContextMenuSrvc.getLastClickNodeKey()!==site.key){var siteInfoTip={};siteInfoTip.show=!0;siteInfoTip.shouldHide=!1;siteInfoTip.title=site.displayName;siteInfoTip.position={left:e.event.layerX+"px",top:e.event.layerY+"px"};cacheSiteInfoSrvc.getData(site.key).then((function(data){var propertyInfo=[];var arrDisplayedItems=[{displayName:"Name",value:data.name},{displayName:"Region",value:data.region},{displayName:"Location",value:data.location},{displayName:"Employee Number",value:data.employeeNumber},{displayName:"Device Count",value:data.deviceCount},{displayName:"Contact Name",value:data.contactName},{displayName:"Phone Number",value:data.phoneNumber},{displayName:"Email",value:data.email},{displayName:"Description",value:data.description}];angular.forEach(arrDisplayedItems,(function(item){item.value||(item.value="");var currQuickViewObj={title:item.displayName,value:item.value};propertyInfo.push(currQuickViewObj)}));siteInfoTip.data=propertyInfo;$scope.siteInfoTip=siteInfoTip;var addWidth=$scope.getAddWidth();$scope.siteInfoTip.position.left=parseInt($scope.siteInfoTip.position.left)+addWidth+"px"}))}}),1500)}));var inEditMode=$rootScope.$on(netMapEvent.enterDataViewEdit,(function(){$scope.isInEditMode=!0}));var outEditMode=$rootScope.$on(netMapEvent.leaveDataViewEdit,(function(){$scope.isInEditMode=!1}));$scope.$on("siteInfoMouseLeave",(function(event){$scope.startSiteInfoTimer&&$timeout.cancel($scope.startSiteInfoTimer)}));$scope.$on("doubleClickSite",(function(event){mapContextMenuAction.openSiteMap()}));$scope.$on("doubleClickDeviceGroup",(function(event){mapContextMenuAction.openDeviceGroupMap()}));$scope.closeSiteInfoTip=function(timeSpan){$scope.closeSiteInfoTimer=$timeout((function(){$scope.siteInfoTip&&($scope.siteInfoTip.show=!1)}),timeSpan)};$scope.closeL2PortTimer=null;$scope.startL2PortTimer=null;var l2PortMousEnterHander=$scope.$on("l2PortMousEnter",(function(event,e,target){var currScope=mapManagerSrvc.getActivePage().getCurrentScope();if(!(currScope&&_.isFunction(currScope.isEditMode)&&currScope.isEditMode())){$scope.closeL2PortTimer&&$timeout.cancel($scope.closeL2PortTimer);$scope.startL2PortTimer=$timeout((function(){var intf=target.data.intf;intf||(intf=target.data.intfDataView.intfInfo.intf);var portType=0;var link;target.part.linksConnected.each((function(a){if(netBrain.Map.CategoryMgr.isTopolink(a.data.category)&&(a.data.fromPort===intf.intfKeyObj.value||a.data.toPort===intf.intfKeyObj.value)){link=a.data;return!1}}));link?portType=link.topoType===netBrain.Map.Const.TopoLinkType.L2Topology?1:link.topoType===netBrain.Map.Const.TopoLinkType.IPv4L3Topology&&"ipIntfs"===intf.intfKeyObj.schema.split(".")[0]?2:link.topoType===netBrain.Map.Const.TopoLinkType.IPv4L3Topology&&"intfs"===intf.intfKeyObj.schema.split(".")[0]?3:link.topoType===netBrain.Map.Const.TopoLinkType.IPv6L3Topology&&"ip6Intfs"===intf.intfKeyObj.schema.split(".")[0]?4:link.topoType===netBrain.Map.Const.TopoLinkType.VPNTopology?6:5:"ipIntfs"===intf.intfKeyObj.schema.split(".")[0]?portType=2:"intfs"===intf.intfKeyObj.schema.split(".")[0]?portType=1:"ip6Intfs"===intf.intfKeyObj.schema.split(".")[0]?portType=4:"vpnIntfs"===intf.intfKeyObj.schema.split(".")[0]&&(portType=6);var tipInfo={};tipInfo.show=!0;tipInfo.shouldHide=!1;tipInfo.title=intf.intfDisplaySchemaObj.value;tipInfo.position={left:e.event.layerX+"px",top:e.event.layerY+"px"};var linkline=target.part.data;cacheInterfaceInfoSrvc.getData(intf).then((function(data){var jsonObj=data.JsonObj;tipInfo.data=function(jsonObj,portType){if(1===portType){var portTypeSource1=[{title:"Switch Mode",value:jsonObj.mode||""},{title:"Trunk Encap",value:jsonObj.trunkEncapsulation||""},{title:"Speed",value:jsonObj.speed||""},{title:"Duplex",value:jsonObj.duplex||""},{title:"Access Vlan",value:jsonObj.accessVLAN||""},{title:"Native Vlan",value:jsonObj.trunkNativeVlan||""},{title:"Description",value:jsonObj.descr||""}];if(jsonObj.ips&&jsonObj.ips.length>0){portTypeSource1=[{title:"Interface IP",value:_.map(jsonObj.ips,(function(item){return item.ipLoc})).join(",")},{title:"Bandwidth",value:jsonObj.bandwidth||""},{title:"Description",value:jsonObj.descr||""}]}else if("access"===jsonObj.mode){portTypeSource1=[{title:"Switch Mode",value:jsonObj.mode||""},{title:"Speed",value:jsonObj.speed||""},{title:"Duplex",value:jsonObj.duplex||""},{title:"Access Vlan",value:jsonObj.accessVLAN||""},{title:"Native Vlan",value:jsonObj.trunkNativeVlan||""},{title:"Description",value:jsonObj.descr||""}];if(jsonObj.channelList){var channelList={title:"In Port-Chanel",value:jsonObj.channelList.toString()||""};portTypeSource1.unshift(channelList)}}else if("trunk"===jsonObj.mode){portTypeSource1=[{title:"Switch Mode",value:jsonObj.mode||""},{title:"Trunk Encap",value:jsonObj.trunkEncapsulation||""},{title:"Speed",value:jsonObj.speed||""},{title:"Duplex",value:jsonObj.duplex||""},{title:"Native Vlan",value:jsonObj.trunkNativeVlan||""},{title:"Permit Vlan",value:jsonObj.permitVLAN||""},{title:"Description",value:jsonObj.descr||""}];if(jsonObj.channelList){var channelList1={title:"In Port-Chanel",value:jsonObj.channelList.toString()||""};portTypeSource1.unshift(channelList1)}}else if("fabricpath"===jsonObj.mode){portTypeSource1=[{title:"Switch Mode",value:jsonObj.mode||""},{title:"Speed",value:jsonObj.speed||""},{title:"Duplex",value:jsonObj.duplex||""},{title:"Description",value:jsonObj.descr||""}];if(jsonObj.channelList){var channelList2={title:"In Port-Chanel",value:jsonObj.channelList.toString()||""};portTypeSource1.unshift(channelList2)}}return portTypeSource1}if(2===portType){return[{title:"Routing Protocol",value:jsonObj.routingProtocol||""},{title:"Multicasting Mode",value:jsonObj.multicastMode||""},{title:"MPLS VRF",value:jsonObj.mplsVrf||""},{title:"Inbound ACL",value:jsonObj.inAclName||""},{title:"Outbound ACL",value:jsonObj.outAclName||""},{title:"Description",value:jsonObj.descr||""}]}if(3===portType){return[{title:"Unnumbered IP",value:jsonObj.ipUnnumberedIp||""},{title:"Routing Protocol",value:jsonObj.routingProtocol||""},{title:"Multicasting Mode",value:jsonObj.multicastMode||""},{title:"MPLS VRF",value:jsonObj.mplsVrf||""},{title:"Inbound ACL",value:jsonObj.inAclName||""},{title:"Outbound ACL",value:jsonObj.outAclName||""},{title:"Description",value:jsonObj.descr||""}]}if(4===portType){return[{title:"Link-local Address",value:jsonObj.ipv6LinkLocalAddress||""},{title:"IPV6 Routing Protocol",value:jsonObj.ipv6RoutingProtocol||""},{title:"Multicasting Mode",value:jsonObj.multicastMode||""},{title:"MPLS VRF",value:jsonObj.mplsVrf||""},{title:"Inbound ACL",value:jsonObj.inAclName||""},{title:"Outbound ACL",value:jsonObj.outAclName||""},{title:"Description",value:jsonObj.descr||""}]}if(5===portType){return[{title:"Link-local Address",value:""},{title:"IPV6 Routing Protocol",value:""},{title:"Multicasting Mode",value:""},{title:"MPLS VRF",value:""},{title:"Inbound ACL",value:""},{title:"Outbound ACL",value:""},{title:"Description",value:jsonObj.descr||""}]}if(6===portType){return[{title:"Interface Name",value:jsonObj.name||""},{title:"IPSec Crypto Map",value:jsonObj.ipsecCryptoMap||""},{title:"Local Crypto Endpoint",value:jsonObj.cryptoEndpt||""},{title:"Local Ident Traffic",value:jsonObj.localIdent||""},{title:"Peer IP Address",value:jsonObj.peerIP||""}]}}(jsonObj,portType);tipInfo.devId=linkline.key;jsonObj&&jsonObj.devId&&(tipInfo.devId=jsonObj.devId);tipInfo.intf=intf;$scope.tipInfo=tipInfo;var addWidth=$scope.getAddWidth();$scope.tipInfo.position.left=parseInt($scope.tipInfo.position.left)+addWidth+"px"}))}),1500)}}));$scope.$on("l2PortMouseLeave",(function(event,e,target){$scope.startL2PortTimer&&$timeout.cancel($scope.startL2PortTimer)}));$scope.closeL2PortTip=function(timeSpan){$scope.closeL2PortTimer=$timeout((function(){$scope.tipInfo&&($scope.tipInfo.show=!1)}),timeSpan)};var showTopoLinkTipHandler=$scope.$on("showTopoLinkTip",(function(event,e,topoLinkTip){if(topoLinkTip){topoLinkTip.position={left:e.event.layerX,top:e.event.layerY};$scope.topoLinkTip=topoLinkTip;$timeout((function(){var addWidth=$scope.getAddWidth();$scope.topoLinkTip.position.left=parseInt($scope.topoLinkTip.position.left)+addWidth;$scope.topoLinkTip.show=!0}),100)}}));$scope.closeTopoLinkTip=function(force){hideTopoLinkTip()};$scope.$on("hideTopoLinkTip",(function(event){hideTopoLinkTip()}));function hideTopoLinkTip(){$scope.topoLinkTip&&($scope.topoLinkTip.show=!1)}$scope.startDesignReaderTimer=null;$scope.linkLabelStroke=null;$scope.tempLinkLabelTarget=null;$scope.resetLinkLabelColor=function(){if(null!=$scope.tempLinkLabelTarget){if(null!=$scope.linkLabelStroke){var oldskips=mapManagerSrvc.getActivePage()._diagram.skipsUndoManager;mapManagerSrvc.getActivePage()._diagram.skipsUndoManager=!0;$scope.tempLinkLabelTarget.stroke=$scope.linkLabelStroke;$scope.tempLinkLabelTarget.panel.findObject("editLabelIcon")&&($scope.tempLinkLabelTarget.panel.findObject("editLabelIcon").opacity=0);mapManagerSrvc.getActivePage()._diagram.skipsUndoManager=oldskips}$scope.tempLinkLabelTarget=null}};$scope.designReaderOptions={};$scope.designReaderOptions.isShow={};$scope.$on("linkLabelMouseEnter",(function(event,e,target){$scope.startDesignReaderTimer=$timeout((function(){var linkline=target.part.data;if(null!=target&&null!=linkline){var clickUnit=target.panel.panel.panel.findObject(netBrain.Map.CompTopolink.linkPosInfoLabel);var pos;if(clickUnit&&(!(pos=clickUnit.panel.panel.panel.data)||!pos.posInfo||!pos.posInfo.displayInfo||pos.posName===DataViewPosName.overflowPos))return!1;var linkLabelObjIsFrom=null!=(linkGraphicObj=target.panel.panel.panel)&&(linkGraphicObj.panel.segmentIndex>=0||(linkGraphicObj.panel.segmentIndex,!1));var linkGraphicObj;var deviceId=linkLabelObjIsFrom?linkline.devIdSrc:linkline.devIdDest;var siteID=null;var devType=null;var devMainType=null;var hostname=null;var intf=linkLabelObjIsFrom?linkline.intfSrc.intfInfo.intf:linkline.intfDest.intfInfo.intf;if((linkLabelObjIsFrom?linkline.getViewInfoSrc(pos&&pos.dataViewId):linkline.getViewInfoDest(pos&&pos.dataViewId)).dataViewType===DataViewType.dvDefault||null==clickUnit){var deviceCom=mapManagerSrvc.getActivePage()._diagram.findNodeForKey(deviceId);var continueShowTip=function(){linkLabelObjIsFrom&&linkline.devIdSrc!==linkline.from?siteID=linkline.from:linkLabelObjIsFrom||linkline.devIdDest===linkline.to||(siteID=linkline.to);var hasDR=!0;1024===devType&&(hasDR=!1);linkline.topoType===netBrain.Map.Const.TopoLinkType.IPv6L3Topology?pos&&"intfs.ipv6LinkLocalAddress"===pos.posInfo.dataUnitList[0].uId&&(hasDR=!1):linkline.topoType===netBrain.Map.Const.TopoLinkType.L2Topology&&pos&&("intfs.speed"!==pos.posInfo.dataUnitList[0].uId&&"intfs.duplex"!==pos.posInfo.dataUnitList[0].uId||(hasDR=!1));if(hasDR){var isShowNormal=!0;mapManagerSrvc.getActivePage().getApplyDataViewInfo()?target instanceof go.TextBlock&&(target.name!==netBrain.Map.CompTopolink.srcLinkIntfInfoLabel&&target.name!==netBrain.Map.CompTopolink.destLinkIntfInfoLabel||(isShowNormal=!1)):target instanceof go.TextBlock&&(isShowNormal=!1);if(isShowNormal)$scope.linkLabelStroke=null;else{var oldskips=mapManagerSrvc.getActivePage()._diagram.skipsUndoManager;mapManagerSrvc.getActivePage()._diagram.skipsUndoManager=!0;$scope.tempLinkLabelTarget=target;$scope.linkLabelStroke=target.stroke;target.stroke="#1b7cb4";mapManagerSrvc.getActivePage()._diagram.skipsUndoManager=oldskips}}if(hasDR){var lineId=md5.createHash(deviceId+"_"+intf.intfKeyObj.value+"_"+(pos?pos.posName:""));if($(document).find("[lineId="+lineId+"]").length>0){$scope.designReaderOptions.isShow={isRealShow:!0,data:null};return}$timeout((function(){var position={x:e.event.pageX,y:e.event.pageY};$scope.designReaderOptions.isShow={isRealShow:!0,data:null};$scope.designReaderOptions.position=position;siteID&&(hostname=(hostname=intf.intfDisplaySchemaObj.value).substr(0,hostname.indexOf("(")));var drData={deviceId:deviceId,siteID:siteID,devType:devType,devMainType:devMainType,hostname:hostname,intf:intf,clickUnit:pos?pos.posInfo.dataUnitList[0]:null};drData.labelString=pos?pos.posInfo.displayInfo:drData.intf.intfDisplaySchemaObj.value;if(siteID&&!clickUnit){var labelString=intf.intfDisplaySchemaObj.value;var start=labelString.indexOf("(")+1;var len=labelString.indexOf(")")-start;drData.labelString=labelString.substr(start,len)}$scope.designReaderOptions.drData=drData;$scope.designReaderOptions.lineId=lineId;var $newElement=$compile('<nb-design-reader options-out="designReaderOptions" is-show="designReaderOptions.isShow" ></nb-design-reader>')($scope);$(document).find(".pageContent").append($newElement)}))}};if(deviceCom){devType=deviceCom.data.getDevType();devMainType=deviceCom.data.getDevCategory();hostname=deviceCom.data.getHostname();continueShowTip()}else{httpDeviceSrvc.getSimpleDevicesByGuidsSync(null,[deviceId]).then((function(result){!function(result){if(result&&result.length>0&&result[0].subType){devType=result[0].subType;devMainType=result[0].mainType;hostname=result[0].name;continueShowTip()}}(result)}))}}}}),1500)}));$scope.$on("linkLabelMouseLeave",(function(event,e,target){$timeout((function(){if(null!=$scope.linkLabelStroke){var oldskips=mapManagerSrvc.getActivePage()._diagram.skipsUndoManager;mapManagerSrvc.getActivePage()._diagram.skipsUndoManager=!0;if($scope.linkLabelStroke){target.stroke=$scope.linkLabelStroke;$scope.designReaderOptions.isShow={isRealShow:!1,data:{linkLabelMouseLeave:!0}}}$scope.linkLabelStroke=null;$scope.tempLinkLabelTarget=null;mapManagerSrvc.getActivePage()._diagram.skipsUndoManager=oldskips}else $scope.designReaderOptions.isShow={isRealShow:!1,data:{linkLabelMouseLeave:!0}}}),0);$scope.startDesignReaderTimer&&$timeout.cancel($scope.startDesignReaderTimer)}));$scope.$on("ChangedSelection",(function(event){$scope.closeSiteInfoTip(0)}));$scope.$on(netBrain.Map.Event.CloseAllTip,(function(event,params){$scope.closeL2PortTip(0);$scope.closeSiteInfoTip(0);$scope.designReaderOptions.isShow={isRealShow:!1,data:params};$scope.startL2PortTimer&&$timeout.cancel($scope.startL2PortTimer);$scope.startSiteInfoTimer&&$timeout.cancel($scope.startSiteInfoTimer);$scope.startDesignReaderTimer&&$timeout.cancel($scope.startDesignReaderTimer);editorToolbarOptions.changeShowState(!1);mapContextMenuSrvc.close()}));$scope.isShowSetting=!1;var rootScopeoncloseMapSettings=$rootScope.$on("closeMapSettings",(function(event){$scope.isShowSetting=!1}));var rootScopeonopenMapSettings=$rootScope.$on("openMapSettings",(function(event){$scope.isShowSetting=!0}));var rootScopeonActivePageChanged=$rootScope.$on(netBrain.Map.Event.ActivePageChanged,(function(event){$scope.isShowSetting=!1;$scope.designReaderOptions.isShow={isRealShow:!1,data:null};hideTopoLinkTip()}));var rootScopeonCloseAllFloadDialog=$rootScope.$on(netBrain.Map.Event.CloseAllFloatDialog,(function(event){$scope.isShowSetting=!1;$scope.designReaderOptions.isShow={isRealShow:!1,data:null};hideTopoLinkTip()}));var beginPathCalc=$scope.$on("beginPathCalc",(function(event,data){var pageId=mapManagerSrvc.getActivePage().getDocId();data&&data.mapPageId&&(pageId=data.mapPageId);mapManagerSrvc.getActiveMap().getNetmapById(pageId).getCmdTarget().sendBeginPath(data);$rootScope.$broadcast("beginMapPathTransaction",data)}));var beginMapPathTransaction=$scope.$on("beginMapPathTransaction",(function(event,data){var pageId=mapManagerSrvc.getActivePage().getDocId();data&&data.mapPageId&&(pageId=data.mapPageId);mapManagerSrvc.getActiveMap().getNetmapById(pageId).getCmdTarget().beginMapPathTransaction(data)}));var hopListChange=$scope.$on("hopListChangeFromPathResultPanel",(function(event,data){execHopListChange((function(){var pageId=mapManagerSrvc.getActivePage().getDocId();data&&data.mapPageId&&(pageId=data.mapPageId);var cmdTarget=mapManagerSrvc.getActiveMap().getNetmapById(pageId).getCmdTarget();return cmdTarget.sendHopListChange(dataViewCacheSrvc,data,cmdTarget)}))}));var endMapPathTransaction=$scope.$on("endMapPathTransaction",(function(event,data,callback){execHopListChange((function(){var pageId=mapManagerSrvc.getActivePage().getDocId();data&&data.mapPageId&&(pageId=data.mapPageId);var promise=mapManagerSrvc.getActiveMap().getNetmapById(pageId).getCmdTarget().endMapPathTransaction(data);callback&&_.isFunction(callback)&&callback();return promise}))}));var endPathCalc=$scope.$on("endPathCalc",(function(event,data){var pageId=mapManagerSrvc.getActivePage().getDocId();data&&data.mapPageId&&(pageId=data.mapPageId);mapManagerSrvc.getActiveMap().getNetmapById(pageId).getCmdTarget().sendEndPath(data);$rootScope.$broadcast("endMapPathTransaction",data)}));var currMapPathPromise=null;function execHopListChange(fn){fn&&_.isFunction(fn)&&(currMapPathPromise=currMapPathPromise&&0===currMapPathPromise.$$state.status?currMapPathPromise.then((function(){return fn()})):fn())}var executeUpdateMapView=function(data){console.warn("executeUpdateMapView");console.warn(data);try{if(data.dataUnitStorageList){var qmap=mapManagerSrvc.getActiveMap();if(qmap){var netmap=null;data.taskInfo.mapPageId&&(netmap=qmap.getDocById(data.taskInfo.mapPageId));netmap&&netmap.getCurrentScope().$broadcast("updateMapDataView",data)}}if(data.drawMapFunctions){var qmap1=mapManagerSrvc.getActiveMap();if(qmap1){var netmap1=null;(netmap1=data.mapInfo&&data.mapInfo.mapPageId?qmap1.getDocById(data.mapInfo.mapPageId):mapManagerSrvc.getActivePage())&&(drawMapFunctions=data.drawMapFunctions,allDevices=mapManagerSrvc.getActivePage().getNetmapOperator().getAllDevcies(),dic={},dmfBoxArr=_.map(drawMapFunctions,(function(dmf){return{dmf:dmf,draw:"DrawDeviceNote"!==dmf.function_name}})),ids=_.chain(dmfBoxArr).each((function(dmfBox){if(!dmfBox.draw){var devName=dmfBox.dmf.parameters.device_name;var findIndex=_.findIndex(allDevices,{hostName:devName});if(findIndex>=0){var id=allDevices[findIndex].key;dmfBox.id=id;dic[id]?dic[id].push(dmfBox):dic[id]=[dmfBox]}else dmfBox.draw=!0}})).filter((function(f){return!f.draw})).pluck("id").uniq().value(),deviceAccessCacheSrvc.getDAPArray(ids,1).then((function(res){_.each(res,(function(r,index){r&&_.each(dic[ids[index]],(function(f){f.draw=!0}))}));return _.chain(dmfBoxArr).filter((function(dmfBox){return dmfBox.draw})).pluck("dmf").value()}))).then((function(allDrawMapFunctions){drawMapAPISrvc.updateDrawMap(allDrawMapFunctions,netmap1)}))}}}catch(e){}var drawMapFunctions,allDevices,dic,dmfBoxArr,ids};var updateMapViewFunc,updateMapView,updateMapViewQappFirstPeriod,updateMapViewQappEnd;if(!window.isInIframe){updateMapViewFunc=$scope.$on("updateMapViewFunc",(function(event,data){executeUpdateMapView(data)}));updateMapView=ngHub.getInstance().registerEvent("UpdateMapView",executeUpdateMapView);updateMapViewQappFirstPeriod=ngHub.getInstance().registerEvent("UpdateMapView_QappFirstPeriod",(function(data){var newData={mapPageId:data.taskInfo.mapPageId,dataviewGroupId:data.dataViewGroupId};monitorDataviewSrvc.addMonitorGroup(newData)}));updateMapViewQappEnd=ngHub.getInstance().registerEvent("UpdateMapView_QappEnd",(function(data){if(data.taskInfo&&data.taskInfo.mapInfo&&data.taskInfo.mapInfo.mapPageId){var newData={mapPageId:data.taskInfo.mapInfo.mapPageId,dataViewGroupIds:data.dataViewGroupIds};monitorDataviewSrvc.removeMonitorGroup(newData);monitorDataviewSrvc.checkNetMapMonitor()}}))}$scope.canRedClose=!1;var rootScopeoncanRedClose=$rootScope.$on("canRedClose",(function(event,canClose){$scope.canRedClose=canClose}));netBrain.Page.LeaveCallback=function(){var deferred=$q.defer();if(!isRunAlertMsg){var curMap=mapManagerSrvc.getActiveMap();if(curMap&&curMap.isModify()){var mapName=netBrain.Map.currentActiveMap.getTitle();var op={message:StringUtil.format(netBrain.Map.Message.LeaveMapUnSaved,{mapname:mapName}),title:"Warning",iconType:NB_ICON_WARNING,buttons:[{id:NB_CONFIRM_YES,label:"Save"},{id:NB_CONFIRM_NO,label:"Don't Save"}]};nbAlertSrvc.confirm(op).then((function(){mapManagerSrvc.saveMap().then((function(){releaseTempEditRight();$scope.canRedClose=!0;deferred.resolve(!0)}))}),(function(btn){if(btn){releaseTempEditRight();$scope.canRedClose=!0;deferred.resolve(!0)}else deferred.reject(!1);curMap.getRealNew()&&httpMapSrvc.closeMap(mapId)}))}else{releaseTempEditRight();deferred.resolve(!0)}return deferred.promise}deferred.reject(!1)};var isRunAlertMsg=!1;netBrain.Page.F5Callback=function(){var deferred=$q.defer();if(isRunAlertMsg)deferred.reject(!1);else{var curMap=mapManagerSrvc.getActiveMap();if(curMap&&curMap.isModify()){isRunAlertMsg=!0;var mapName=netBrain.Map.currentActiveMap.getTitle();var op={message:StringUtil.format(netBrain.Map.Message.LeaveMapUnSaved,{mapname:mapName}),title:"Warning",iconType:NB_ICON_WARNING,buttons:[{id:NB_CONFIRM_YES,label:"Save"},{id:NB_CONFIRM_NO,label:"Don't Save"}]};nbAlertSrvc.confirm(op).then((function(){mapManagerSrvc.saveMap().then((function(){isRunAlertMsg=!1;$scope.canRedClose=!0;deferred.resolve(!0);releaseTempEditRight()}),(function(cancel){isRunAlertMsg=!1}))}),(function(btn){if(btn){if(mainUISrvc.isDesktop()||!0!==curMap.getRealNew()){deferred.resolve(!0);releaseTempEditRight()}else;curMap.getRealNew()&&httpMapSrvc.closeMap(mapId);isRunAlertMsg=!1;$scope.canRedClose=!0}else{isRunAlertMsg=!1;$scope.canRedClose=!1;deferred.reject(!1)}}))}else if(!0!==curMap.getRealNew()||mainUISrvc.isDesktop())if(!0===curMap.getRealNew()&&mainUISrvc.isDesktop()){isRunAlertMsg=!1;$scope.canRedClose=!1;deferred.resolve(!0)}else{isRunAlertMsg=!1;releaseTempEditRight();deferred.resolve(!0)}else{isRunAlertMsg=!1;$scope.canRedClose=!1;deferred.reject(!1)}}return deferred.promise};$scope.closeflags=function(){if(!$scope.isLogined())return!0;if($scope.canRedClose)return!0;var curMap=mapManagerSrvc.getActiveMap();return!curMap||!curMap.isModify()};$scope.closeMap=function(){httpMapSrvc.closeMap(mapId);releaseTempEditRight(!0)};$scope.isLogined=function(){return null!=userSrvc.getUserID()&&""!==userSrvc.getUserID()};$scope.$on("$destroy",(function(){$scope.$broadcast("closeMap");beginPathCalc();hopListChange();endPathCalc();inEditMode();outEditMode();beginMapPathTransaction();endMapPathTransaction();if(!window.isInIframe){updateMapViewFunc();ngHub.getInstance().unRegisterEvent("UpdateMapView",updateMapView);ngHub.getInstance().unRegisterEvent("UpdateMapView_QappFirstPeriod",updateMapViewQappFirstPeriod);ngHub.getInstance().unRegisterEvent("UpdateMapView_QappEnd",updateMapViewQappEnd)}rootScopeonReInitMapCtrl();rootScopeonActivePageChanged();rootScopeoncloseMapSettings();rootScopeonCloseAllFloadDialog();rootScopeonopenMapSettings();rootScopeoncanRedClose();siteInfoMousEnterHandler();$scope.startSiteInfoTimer&&$timeout.cancel($scope.startSiteInfoTimer);$scope.startSiteInfoTimer=null;$scope.closeSiteInfoTimer&&$timeout.cancel($scope.closeSiteInfoTimer);$scope.closeSiteInfoTimer=null;$scope.startL2PortTimer&&$timeout.cancel($scope.startL2PortTimer);$scope.startL2PortTimer=null;$scope.closeL2PortTimer&&$timeout.cancel($scope.closeL2PortTimer);$scope.closeL2PortTimer=null;$scope.startDesignReaderTimer&&$timeout.cancel($scope.startDesignReaderTimer);$scope.startDesignReaderTimer=null;showTopoLinkTipHandler();l2PortMousEnterHander();$scope.designReaderOptions=null;$scope.tipInfo=null;$scope.topoLinkTip=null;$scope.qmapObj._type=null;$scope.qmapObj.qmapJsWrapper=null;$scope.qmapObj.refreshWindowCallBack=null;$scope.qmapObj._docList=null;$scope.activePage.extAction=null;netBrain.Map.currentActiveMap=null;netBrain.Map.currentActiveMapPage=null;$scope.siteInfoTip=null;$timeout((function(){$scope.activeMap=null}),1e3);$scope.activePage=null;$scope.qmapObj=null;mapType=null;havLoadMapObj=null}));function releaseTempEditRight(isSync){if($scope.activeMap&&($scope.activeMap.isTempEditRight||$scope.isSystemDeviceGroupMapType||$scope.activeMap.getMapType()===netBrain.Map.Const.MapType.siteMap)){$rootScope.$emit("ignoreViewOnlyShowed",!0);$scope.activeMap.setEditRight("","");$scope.activeMap.isTempEditRight=!1;if(isSync){var defaultRequest={useWebApi:!0,method:"POST",url:"mapcollaboration/releaseEditingRight/"+$scope.activeMap.getDocId()};if(httpAuthSrvc.getAccessToken()){return new NgXHRSrvc($http,$q,$log,$location,utilitySrvc,httpAuthSrvc).sendSyncRequest(defaultRequest,angular.noop)}return null}httpMapSrvc.releaseEditingRight($scope.activeMap.getDocId());collaborationGridSrvc.getCollaborationHistory().then((function(res){var currentMapId=$scope.activeMap.getDocId();_.each(res.requestsAndTransfers,(function(item){var mapIds=_.pluck(item.mapList,"mapId");if(_.contains(mapIds,currentMapId)&&!item.haveProcessed&&2===item.type){item.receiveUserName=item.fromUserName;item.receiveUserId=item.fromUserId;mapManagerSrvc.denyMapEditRight(item).then((function(){}))}}))}));$rootScope.$emit("releaseTempEditRight")}}var _registerChangeDomainApp=function(){var mapApp={id:$scope.activeMap.getDocId(),data:$scope.activeMap,checkCallBack:mapManagerSrvc.changeDomainForCheckMapSaved,mapManagerSrvc:mapManagerSrvc};domainSwitchProvider.registerApp(mapApp)};$scope.dataElementPaneObj={};var EventType=NetBrain.DataView.ElementConst.EventType;$scope.$on(EventType.SHOW_DATA_ELEMENT_PANE,(function(event,options,isRefresh){var pageId=NetBrain.Map.currentActiveMapPage.getDocId();$scope.outputConsolePaneMap[pageId]&&($scope.outputConsolePaneMap[pageId].isShow=!1);if(isRefresh||$scope.dataElementPaneObj[pageId])!function(pageId,options){var pagePaneOption=$scope.dataElementPaneObj[pageId];if(pagePaneOption&&pagePaneOption.isShow)$timeout((function(){$rootScope.$emit(EventType.REFRESH_DATA_ELEMENT_PANE,pageId,options)}),50);else{var paneOption=$scope.dataElementPaneObj[pageId];paneOption.dataUnit=options.dataUnit;paneOption.dataViewInfo=options.dataViewInfo;paneOption.devKey=options.devKey;paneOption.devType=options.devType;paneOption.handle=options.handle;paneOption.hostName=options.hostName;paneOption.mode=options.mode;paneOption.posName=options.posName;paneOption.queryParams=options.queryParams;paneOption.variableList=options.variableList;paneOption.title=options.title;$scope.dataElementPaneObj[pageId].isShow=!0}}(pageId,options);else{var paneOption=_.extend({isShow:!0},options);$scope.dataElementPaneObj[pageId]=paneOption}}));var consoleTypeEnum=netBrain.Runbook.AlertMes.ConsoleType;var consolePaneEvent=netBrain.Runbook.AlertMes.ConsolePaneEvent;var outputConsolePaneEvent=netBrain.Runbook.AlertMes.outputConsolePaneEvent;var consolePaneTabs=[{show:!0,info:{},key:consoleTypeEnum.RunBookAlertMessage},{show:!0,info:{},key:consoleTypeEnum.DataViewConsoleMessage}];$scope.consolePaneObj={tabShowObjs:{},currentTab:consoleTypeEnum.UnknownConsole,needClose:{key:"",value:!1}};$scope.tabShowObjs=$scope.consolePaneObj.tabShowObjs;$scope.$on(consolePaneEvent.onShowAlertMessage,(function(event,options){if(options.consoleType!==consoleTypeEnum.AllConsole||options.show){var mapPageId=NetBrain.Map.currentActiveMapPage.getDocId();var tabIndex="k_"+mapPageId;var tabShowObj=$scope.tabShowObjs[tabIndex];if(!tabShowObj){(tabShowObj={key:mapPageId,show:!1,consolePaneTabs:angular.copy(consolePaneTabs)}).consolePaneTabs[0].mapPageId=mapPageId;tabShowObj.consolePaneTabs[1].mapPageId=mapPageId;$scope.tabShowObjs[tabIndex]=tabShowObj}var paneShow=$scope.tabShowObjs[tabIndex].show;var tabs=tabShowObj.consolePaneTabs;var tab=_.find(tabs,(function(item){return item.key===options.consoleType}));if(tab){var isShow=options.show;tab.info=options;tab.mapPageId=mapPageId;"switch"!==isShow||$scope.consolePaneObj.currentTab!==options.consoleType&&$scope.consolePaneObj.currentTab!==consoleTypeEnum.UnknownConsole||!0!==paneShow?"switch"===isShow&&(isShow=!0):isShow=!1;if(!0===isShow){tab.show=isShow;$scope.consolePaneObj.needClose={key:"",value:!1};$timeout((function(){$scope.consolePaneObj.currentTab=options.consoleType}))}$timeout((function(){!0===isShow&&($scope.tabShowObjs[tabIndex].show=!0);!1===isShow&&($scope.consolePaneObj.needClose={key:options.consoleType,value:!0})}),100)}}else $scope.consolePaneObj.needClose={key:consoleTypeEnum.AllConsole,value:!0}}));$scope.$on(consolePaneEvent.onCloseAllAlertMessage,(function(){$scope.$emit(consolePaneEvent.onShowAlertMessage,{show:!1,consoleType:consoleTypeEnum.RunBookAlertMessage});$scope.$emit(consolePaneEvent.onShowAlertMessage,{show:!1,consoleType:consoleTypeEnum.DataViewConsoleMessage})}));$scope.outputConsolePaneMap={};$scope.$on(outputConsolePaneEvent.onShowOutputConsoleMessage,(function(event,actionTask,isRefresh){var actionLog=actionTask.actionLog||"";var consolePaneTitle=actionTask.actionTaskTitle;var mapPageId=NetBrain.Map.currentActiveMapPage.getDocId();detailPaneSrvc.closeDetailPane();if(actionTask.onlyShowDataview){$scope.outputConsolePaneMap[mapPageId]&&($scope.outputConsolePaneMap[mapPageId].isShow=!1);$timeout((function(){$scope.outputConsolePaneMap[mapPageId]={isShow:!0,actionLog:actionLog,dataviewTabs:actionTask.dataviewTabs,consolePaneTitle:consolePaneTitle,isOnlyShowDataview:!0}}))}else{$scope.outputConsolePaneMap[mapPageId]&&$scope.outputConsolePaneMap[mapPageId].isOnlyShowDataview&&delete $scope.outputConsolePaneMap[mapPageId].isOnlyShowDataview;isRefresh?$scope.outputConsolePaneMap[mapPageId]&&actionLog.id!=$scope.outputConsolePaneMap[mapPageId].actionLog.id&&refreshOutputConsolePane(actionTask):$scope.outputConsolePaneMap[mapPageId]&&actionLog.id!=$scope.outputConsolePaneMap[mapPageId].actionLog.id?refreshOutputConsolePane(actionTask):$scope.outputConsolePaneMap[mapPageId]={isShow:!0,actionLog:actionLog,consolePaneTitle:consolePaneTitle}}}));function refreshOutputConsolePane(actionTask){var mapPageId=NetBrain.Map.currentActiveMapPage.getDocId();$scope.outputConsolePaneMap[mapPageId].isShow=!1;$scope.outputConsolePaneMap[mapPageId].consolePaneTitle=actionTask.actionTaskTitle;$scope.outputConsolePaneMap[mapPageId].actionLog=actionTask.actionLog;$timeout((function(){$scope.outputConsolePaneMap[mapPageId].isShow=!0}))}$scope.$on(outputConsolePaneEvent.onCloseOutputConsoleMessage,(function(event){var mapPageId=NetBrain.Map.currentActiveMapPage.getDocId();$scope.outputConsolePaneMap[mapPageId].isShow=!1}));function setAlignMent(keyType){updateMapSrvc.canUpdateCurrentMap().then((function(){switch(keyType){case"L":mapManagerSrvc.getActivePage().getCmdTarget().onAlignLeft();break;case"R":mapManagerSrvc.getActivePage().getCmdTarget().onAlignRight();break;case"C":mapManagerSrvc.getActivePage().getCmdTarget().onAlignCenterX();break;case"T":mapManagerSrvc.getActivePage().getCmdTarget().onAlignTop();break;case"B":mapManagerSrvc.getActivePage().getCmdTarget().onAlignBottom();break;case"M":mapManagerSrvc.getActivePage().getCmdTarget().onAlignCenterY();break;default:mapManagerSrvc.getActivePage().getCmdTarget().onAlignLeft()}}))}netBrain.Page.AltL=function(){setAlignMent("L")};netBrain.Page.AltR=function(){setAlignMent("R")};netBrain.Page.AltC=function(){setAlignMent("C")};netBrain.Page.AltT=function(){setAlignMent("T")};netBrain.Page.AltB=function(){setAlignMent("B")};netBrain.Page.AltM=function(){setAlignMent("M")};!function(){if(!0===window.isInIframe){netBrain.Page.F5Callback=function(){console.log("F5Callback")};netBrain.Page.LeaveCallback=function(){console.log("LeaveCallback")};$scope.closeflags=function(){return!0};nbCalculationTipSrvc.showCalculationTip=function(){console.log("showCalculationTip")};siteInfoMousEnterHandler&&siteInfoMousEnterHandler();l2PortMousEnterHander&&l2PortMousEnterHander();showTopoLinkTipHandler&&showTopoLinkTipHandler();$scope.showSwitchCacheStyle={display:"none"}}}()}}(NetBrain);!function(netBrain){var extendNbrHelper=function(){this.defer=null;this.netmapOperator=null;this.httpExternNbrSrvc=null;this.dataViewCacheSrvc=null;this.autoLinkOptionSrvc=null;this.applyDataViewSrvc=null;this.dlgExtendNeighbor=null;this.currentNode=null;this.nbrListCache=[];this.intfListCache=[];this.extendTypeList=[]};extendNbrHelper.isGroupLink=function(nbrInfo){return nbrInfo&&"group"===nbrInfo.linkStyle};extendNbrHelper.topoTypeDef="TopoLinkType";extendNbrHelper.siteTypeDef="Site";extendNbrHelper.intfTypeDef="Intf";extendNbrHelper.isTopoTypeMode=function(extendType){return!!extendType&&extendType.type===extendNbrHelper.topoTypeDef};extendNbrHelper.isSiteMode=function(extendType){return!!extendType&&extendType.type===extendNbrHelper.siteTypeDef};extendNbrHelper.isIntfMode=function(extendType){return!!extendType&&extendType.type===extendNbrHelper.intfTypeDef};extendNbrHelper.isLegacyNode=function(nidEx){return!(nidEx&&nidEx.nodeIdentify&&nidEx.nodeIdentify.nbPathSchema)||VisualSpaceConstant.legacySchema===nidEx.nodeIdentify.nbPathSchema};extendNbrHelper.intfAllNbr={intfKeyObj:{schema:"",value:"default_key_all_neighbor"},intfDisplaySchemaObj:{schema:"",value:"All Neighbors"}};extendNbrHelper.siteExtendType=function(){return{id:"Site_extend_type_id",type:extendNbrHelper.siteTypeDef,name:"Site"}};extendNbrHelper.intfExtendType=function(){return{id:"Intf_extend_type_id",type:extendNbrHelper.intfTypeDef,name:"Interface"}};extendNbrHelper.isParentSite=function(site,siteId){if(!site)return!1;var parentPath=site.parentPath;return _.contains(parentPath,siteId)};extendNbrHelper.createInstance=function(extendType){return extendNbrHelper.isSiteMode(extendType)?new netBrain.Map.ExtendNbrHelperForSite:new extendNbrHelper};extendNbrHelper.convertToExtendTypeList=function(topoTypeList,typeName){var extendTypeList=[];if(_.isEmpty(topoTypeList))return extendTypeList;topoTypeList.forEach((function(topoType){var extendType=topoType;extendType.type=typeName;extendTypeList.push(extendType)}));return extendTypeList};extendNbrHelper.getTopoTypeName=function(extendTypeList,topoTypeId){var index=extendNbrHelper.indexOfExtendType(extendTypeList,topoTypeId);return-1===index?topoTypeId:extendTypeList[index].name};extendNbrHelper.indexOfExtendType=function(extendTypeList,extendTypeId){var retIndex=-1;if(_.isEmpty(extendTypeList))return retIndex;for(var i=0;i<extendTypeList.length;i++)if(extendTypeList[i].id===extendTypeId){retIndex=i;break}return retIndex};extendNbrHelper.hasExtendType=function(extendTypeList,extendTypeId){return-1!==extendNbrHelper.indexOfExtendType(extendTypeList,extendTypeId)};extendNbrHelper.indexOfIntf=function(intfList,intfKeyValue){var retIndex=-1;for(var i=0;i<intfList.length;i++){var intfItem=intfList[i];if(extendNbrHelper.getIntfKey(intfItem)===intfKeyValue){retIndex=i;break}}return retIndex};extendNbrHelper.hasAllNbrIntfItem=function(intfList){return-1!==extendNbrHelper.indexOfIntf(intfList,"default_key_all_neighbor")};extendNbrHelper.getIntfKey=function(intfItem){return intfItem&&intfItem.intfKeyObj?intfItem.intfKeyObj.value:null};extendNbrHelper.getLinkCount=function(nbrList){var nCount=0;nbrList.forEach((function(nbrInfo){nbrInfo.existed&&nCount++}));return nCount};extendNbrHelper.isMplsvrfNbr=function(nbrInfo){return!!(nbrInfo&&nbrInfo.nbrIntf&&nbrInfo.nbrIntf.mplsVrf)&&""!==nbrInfo.nbrIntf.mplsVrf};extendNbrHelper.isHasMplsvrf=function(nbrList){var bRet=!1;_.each(nbrList,(function(nbrInfo){if(extendNbrHelper.isMplsvrfNbr(nbrInfo)){bRet=!0;return!1}return!0}));return bRet};extendNbrHelper.isTheNbrOfIntf=function(intfItem,nbrInfo){return nbrInfo.intf&&extendNbrHelper.getIntfKey(intfItem)===extendNbrHelper.getIntfKey(nbrInfo.intf)};extendNbrHelper.filterIntfs=function(intfs,extendType){if(!extendType||_.isEmpty(intfs))return[];if(extendNbrHelper.isIntfMode(extendType))return intfs;var topoType=null;if(!extendNbrHelper.isTopoTypeMode(extendType))return[];topoType=extendType;var retIntfList=[];intfs.forEach((function(intfItem){intfItem&&!_.isEmpty(intfItem.belongToTopoType)&&-1!==intfItem.belongToTopoType.indexOf(topoType.id)&&retIntfList.push(intfItem)}));return retIntfList};extendNbrHelper.filterNbrs=function(nbrs,intfList,extendType){if(_.isEmpty(nbrs))return nbrs;if(_.isEmpty(intfList))return[];var retNbrList=[];var bCheckIntf=!0;extendNbrHelper.hasAllNbrIntfItem(intfList)&&(bCheckIntf=!1);var topoType=null;extendNbrHelper.isTopoTypeMode(extendType)&&(topoType=extendType);nbrs.forEach((function(nbrInfo){var isValidNbr=!0;if(bCheckIntf){_.find(intfList,(function(intfItem){return extendNbrHelper.isTheNbrOfIntf(intfItem,nbrInfo)}))||(isValidNbr=!1)}topoType&&isValidNbr&&(isValidNbr=topoType.id===nbrInfo.topoTypeId);isValidNbr&&retNbrList.push(nbrInfo)}));return retNbrList};extendNbrHelper.filterNbrsAndPorts=function(result,extendType){return{intfs:extendNbrHelper.filterIntfs(result.intfs,extendType),nbrs:extendNbrHelper.filterNbrs(result.nbrs,[extendNbrHelper.intfAllNbr],extendType)}};extendNbrHelper.findMeidaNbrInfo=function(nbrList,mediaNbrTemp){if(_.isEmpty(nbrList)||!mediaNbrTemp)return null;for(var i=0;i<nbrList.length;++i){var nbrTemp=nbrList[i];if(nbrTemp.id===mediaNbrTemp.id&&nbrTemp.nbrId===mediaNbrTemp.nbrId&&nbrTemp.nbrDevId===mediaNbrTemp.nbrDevId&&nbrTemp.topoTypeId===mediaNbrTemp.topoTypeId&&nbrTemp.mediaId===mediaNbrTemp.mediaId){if(!nbrTemp.intf&&!mediaNbrTemp.intf)return nbrTemp;if(nbrTemp.intf&&mediaNbrTemp.intf&&extendNbrHelper.getIntfKey(nbrTemp.intf)===extendNbrHelper.getIntfKey(mediaNbrTemp.intf))return nbrTemp}}return null};extendNbrHelper.findP2pNbrInfo=function(nbrList,p2pNbr){if(_.isEmpty(nbrList)||!p2pNbr)return null;for(var i=0;i<nbrList.length;++i){var nbrTemp=nbrList[i];if(nbrTemp.id===p2pNbr.id&&nbrTemp.nbrId===p2pNbr.nbrId&&nbrTemp.nbrDevId===p2pNbr.nbrDevId&&nbrTemp.topoTypeId===p2pNbr.topoTypeId&&!(nbrTemp.intf&&p2pNbr.intf&&extendNbrHelper.getIntfKey(nbrTemp.intf)!==extendNbrHelper.getIntfKey(p2pNbr.intf)||nbrTemp.nbrIntf&&p2pNbr.nbrIntf&&extendNbrHelper.getIntfKey(nbrTemp.nbrIntf)!==extendNbrHelper.getIntfKey(p2pNbr.nbrIntf)))return nbrTemp}return null};extendNbrHelper.sortIntfList=function(intfList,bDesc){(new Utility.CompareName).sort(intfList,bDesc,(function(temp){return temp.name}))};extendNbrHelper.sortNbrList=function(nbrList,bDesc){(new Utility.CompareName).sort(nbrList,bDesc,(function(temp){return temp.nbrName}))};extendNbrHelper.prototype.deferredLoadData=function(nodeIdentify){var deferred=this.defer();this.httpExternNbrSrvc.getNeighborsAndPorts(this.currentNode.key,nodeIdentify).then((function(result){deferred.resolve(result)}));return deferred.promise};extendNbrHelper.prototype.deferredLoadIntfs=function(nodeIdentify){};extendNbrHelper.prototype.deferredLoadNbrs=function(intfList,nodeIdentify){};extendNbrHelper.prototype.filterNbrs=function(intfList,topoType){var nbrList=this.ungroupNbrs(this.nbrListCache);var validNbrList=extendNbrHelper.filterNbrs(nbrList,intfList,topoType);var groupNbrList=this.groupNbrs(validNbrList);this.calculateIfExist(groupNbrList);return groupNbrList};extendNbrHelper.prototype.getMuteLanNbr=function(intf){return{intf:intf,id:this.currentNode.key,devId:this.currentNode.key,name:this.currentNode.hostName,topoTypeId:"L3_Topo_Type",mediaId:this.currentNode.key+extendNbrHelper.getIntfKey(intf)+"MuteLAN",mediaInfo:{mediaName:"",mediaType:"MuteLan"}}};extendNbrHelper.prototype.convertToExtendNbrs=function(nbrList,doDistinct){if(_.isEmpty(nbrList))return null;!1!==doDistinct&&(doDistinct=!0);var nbrsForExtend=[];for(var i=0;i<nbrList.length;++i){var nbrTemp=nbrList[i];nbrTemp.mediaInfo&&nbrTemp.mediaInfo.mediaType==NetBrain.Map.Const.MediaType.Serial&&(nbrTemp.isP2P=!0);var isMediaNeat=this.netmapOperator._netmap.getIsNeatUp()&&nbrTemp.mediaInfo&&nbrTemp.mediaInfo.neat;if(nbrTemp.mediaInfo&&!isMediaNeat&&!nbrTemp.isP2P){if(nbrTemp.devId){var local2Media={intf:nbrTemp.intf,devNodeData:nbrTemp.devNodeData,id:nbrTemp.id,devId:nbrTemp.devId,name:nbrTemp.name,topoTypeId:nbrTemp.topoTypeId,category:nbrTemp.category,isP2P:nbrTemp.isP2P,mediaId:nbrTemp.mediaId,mediaInfo:nbrTemp.mediaInfo};nbrsForExtend.push(local2Media)}if(nbrTemp.nbrDevId){var nbr2Media={intf:nbrTemp.nbrIntf,devNodeData:nbrTemp.nbrDevNodeData,id:nbrTemp.nbrId,devId:nbrTemp.nbrDevId,name:nbrTemp.nbrName,topoTypeId:nbrTemp.topoTypeId,category:nbrTemp.category,isP2P:nbrTemp.isP2P,mediaId:nbrTemp.mediaId,mediaInfo:nbrTemp.mediaInfo};nbrsForExtend.push(nbr2Media)}}else nbrsForExtend.push(nbrTemp);if(!_.isEmpty(nbrTemp.otherNbrs)){var otherNbrsForExtend=this.convertToExtendNbrs(nbrTemp.otherNbrs,!1);_.isEmpty(otherNbrsForExtend)||(nbrsForExtend=nbrsForExtend.concat(otherNbrsForExtend))}}return this.distinctExtendNbr(nbrsForExtend)};extendNbrHelper.prototype.distinctExtendNbr=function(nbrsForExtend){var retList=[];nbrsForExtend.forEach((function(temp){temp.mediaInfo?extendNbrHelper.findMeidaNbrInfo(retList,temp)||retList.push(temp):extendNbrHelper.findP2pNbrInfo(retList,temp)||retList.push(temp)}));return retList};extendNbrHelper.prototype.extendNbrs=function(nbrsForExtend){if(!_.isEmpty(nbrsForExtend)){this.netmapOperator.extendNeighbors(nbrsForExtend,!1,!0,!0);var groupNbrList=this.groupNbrs(nbrsForExtend);this.removelogicLinkExisted(groupNbrList)}};extendNbrHelper.prototype.setNbrInfoFromCurNode=function(nbrInfo){nbrInfo.id=this.currentNode.key;nbrInfo.devId=this.currentNode.key;nbrInfo.nbrId=nbrInfo.nbrDevId};extendNbrHelper.prototype.filterValidIntfList=function(nbrInfo,intfList){var retIntfList=[];if(extendNbrHelper.getIntfKey(nbrInfo.intf)){var validIntf=_.find(intfList,(function(intfTemp){return extendNbrHelper.getIntfKey(intfTemp)===extendNbrHelper.getIntfKey(nbrInfo.intf)}));retIntfList.push(validIntf)}else retIntfList=_.filter(intfList,(function(intfTemp){return intfTemp.nbrDevId===nbrInfo.mediaId}));return retIntfList};extendNbrHelper.prototype.isNbrExistOnMap=function(nbrInfo){if(extendNbrHelper.isGroupLink(nbrInfo))return this.dlgExtendNeighbor.checkNodeExist(nbrInfo.nbrDevId);var tempNbrInfo=new CNeighborInfo(nbrInfo.nbrId,nbrInfo.id,nbrInfo.nbrIntf,nbrInfo.intf,nbrInfo.topoTypeId,nbrInfo.isP2P,nbrInfo.mediaId,nbrInfo.mediaInfo);return this.dlgExtendNeighbor.checkExisting(tempNbrInfo)};extendNbrHelper.prototype.genNbrsForDisplay=function(result){var srcIntfList=result.intfs;var srcNbrList=result.nbrs;var retNbrList=[];if(_.isEmpty(srcNbrList))return retNbrList;var self=this;srcNbrList.forEach((function(nbrInfo){self.setNbrInfoFromCurNode(nbrInfo);nbrInfo.topoTypeName=extendNbrHelper.getTopoTypeName(self.extendTypeList,nbrInfo.topoTypeId);if(!extendNbrHelper.isGroupLink(nbrInfo)){var validIntfs=self.filterValidIntfList(nbrInfo,srcIntfList);if(!_.isEmpty(validIntfs))if(1===validIntfs.length)nbrInfo.intf=validIntfs[0];else if(validIntfs.length>1){nbrInfo.intfs=validIntfs;nbrInfo.intf=validIntfs[validIntfs.length-1]}}retNbrList.push(nbrInfo)}));extendNbrHelper.sortNbrList(retNbrList);var groupNbrList=self.groupNbrs(retNbrList);self.calculateIfExist(groupNbrList);return groupNbrList};extendNbrHelper.prototype.removelogicLinkExisted=function(groupNbrList){if(!_.isEmpty(groupNbrList)){var self=this;groupNbrList.forEach((function(nbrInfo){var tempNbrInfo=new CNeighborInfo(nbrInfo.nbrId,nbrInfo.id,nbrInfo.nbrIntf,nbrInfo.intf,nbrInfo.topoTypeId,nbrInfo.isP2P,nbrInfo.mediaId,nbrInfo.mediaInfo);self.dlgExtendNeighbor.removelogicLinkExisted(tempNbrInfo)}))}};extendNbrHelper.prototype.calculateIfExist=function(groupNbrList){if(!_.isEmpty(groupNbrList)){var self=this;groupNbrList.forEach((function(nbrInfo){if(nbrInfo){nbrInfo.existed=self.isNbrExistOnMap(nbrInfo);if(!nbrInfo.existed&&!_.isEmpty(nbrInfo.otherNbrs))for(var i=0;i<nbrInfo.otherNbrs.length;++i){nbrInfo.existed=self.isNbrExistOnMap(nbrInfo.otherNbrs[i]);if(nbrInfo.existed)return}}}))}};extendNbrHelper.prototype.groupNbrs=function(nbrList){var dictNbrs={};null!=nbrList&&nbrList.length>0&&nbrList.forEach((function(nbrInfo){if(nbrInfo){var nbrKey=nbrInfo.nbrDevId;nbrInfo.nbrIntf&&(nbrInfo.nbrIntf.name?nbrKey+=nbrInfo.nbrIntf.name:nbrInfo.nbrIntf.intfDisplaySchemaObj&&nbrInfo.nbrIntf.intfDisplaySchemaObj.value&&(nbrKey+=nbrInfo.nbrIntf.intfDisplaySchemaObj.value));nbrInfo.topoTypeId&&(nbrKey+=nbrInfo.topoTypeId);nbrInfo.nbrSiteName&&(nbrKey+=nbrInfo.nbrSiteName);if(dictNbrs[nbrKey])nbrInfo.nbrDevId&&dictNbrs[nbrKey].otherNbrs.push(nbrInfo);else{dictNbrs[nbrKey]=nbrInfo;dictNbrs[nbrKey].otherNbrs=[]}}}));var retNbrList=[];for(var prop in dictNbrs)retNbrList.push(dictNbrs[prop]);return retNbrList};extendNbrHelper.prototype.ungroupNbrs=function(nbrList){var retNbrList=[];nbrList.forEach((function(nbrInfo){if(nbrInfo){var nbrTemp=angular.copy(nbrInfo);retNbrList.push(nbrTemp);_.isEmpty(nbrInfo.otherNbrs)||nbrInfo.otherNbrs.forEach((function(otherNbrInfo){var otherNbrTemp=angular.copy(otherNbrInfo);retNbrList.push(otherNbrTemp)}))}}));return retNbrList};netBrain.Map.ExtendNbrHelper=extendNbrHelper}(NetBrain);!function(netBrain){var classExtendNbrHelper=netBrain.Map.ExtendNbrHelper;var extendNbrHelperForSite=function(){classExtendNbrHelper.call(this);this.curSiteCache=null;this.siteCacheList=[];this.dataViewsSegmentOutCache=null};(extendNbrHelperForSite.prototype=new netBrain.Map.ExtendNbrHelper).deferredLoadIntfs=function(nodeIdentify){var deferred=this.defer();this.httpExternNbrSrvc.getBorderInterfaceOfDevice(this.currentNode.key).then((function(result){var intfList=[];result&&(intfList=result.borderIntfs);deferred.resolve(intfList)}));return deferred.promise};extendNbrHelperForSite.prototype.deferredLoadNbrs=function(intfList,nodeIdentify){var deferred=this.defer();var self=this;this.httpExternNbrSrvc.getNbrSiteAndDeviceIntfsOfDevice(intfList,this.currentNode.key).then((function(result){if(result){self.siteCacheList=result.siteList;self.curSiteCache=result.currentSite}deferred.resolve(result)}));return deferred.promise};extendNbrHelperForSite.prototype.treeDisplayNbrs=function(parentPathList,nbrTmpIn,filterFunc,displayParent){var self=this;var temp=0;var ret={space:0,nbrs:[]};if(!parentPathList)return ret;parentPathList.forEach((function(newsiteId){if("732e8ab6-6b69-417d-ad03-2cc447100166"!==newsiteId){var tempSite=self.findSite(newsiteId);if(tempSite){if(!displayParent&&classExtendNbrHelper.isParentSite(self.curSiteCache,tempSite.ID))return;var tempNbr=angular.copy(nbrTmpIn);tempNbr.nbrId=tempSite.ID;tempNbr.nbrSiteName=tempSite.name;tempNbr.existed=!1;temp=0;if(0===ret.nbrs.filter(filterFunc(tempNbr)).length){ret.nbrs.push(tempNbr);temp=ret.space++}tempNbr.space=temp}}}));return ret};extendNbrHelperForSite.prototype.convertCurSiteToDisplayNbrs=function(){var retNbrs=[];var self=this;var curSite=this.curSiteCache;var curNode=this.currentNode;var treeDisplay=self.treeDisplayNbrs(curSite.parentPath,{},(function(tempNbr){return function(hItem){return hItem.nbrSiteName===tempNbr.nbrSiteName}}),!0);var currentSite={space:treeDisplay.space,nbrId:curSite.ID,nbrSiteName:curSite.name,isCurrentSite:!0,isP2P:!1,existed:!1};(retNbrs=retNbrs.concat(treeDisplay.nbrs)).push(currentSite);retNbrs.forEach((function(halfTemp){halfTemp.id=curNode.key;halfTemp.name=curNode.hostName;halfTemp.devId=curNode.key;halfTemp.intf=curNode.intf;halfTemp.vsNodeIdentify=curNode.getVSNodeIdentify();var nbrSiteTemp=self.findSite(halfTemp.nbrId);nbrSiteTemp&&(halfTemp.nbrSiteName=nbrSiteTemp.name)}));return retNbrs};extendNbrHelperForSite.prototype.convertResultNbrToDisplayNbrs=function(nbrTmp){if(!nbrTmp||_.isEmpty(nbrTmp.nbrs))return null;var self=this;var curNode=this.currentNode;var retNbrs=[];nbrTmp.nbrs.forEach((function(nbrTmpIn){var nbrSite=self.findSite(nbrTmpIn.nbrId);if(nbrSite){var treeDisplay=self.treeDisplayNbrs(nbrSite.parentPath,nbrTmpIn,(function(tempNbr){return function(hItem){return hItem.nbrSiteName===tempNbr.nbrSiteName&&hItem.nbrName===tempNbr.nbrName&&hItem.nbrIntf===tempNbr.nbrIntf}}),!1);nbrTmpIn.space=treeDisplay.space;(retNbrs=retNbrs.concat(treeDisplay.nbrs)).push(nbrTmpIn);retNbrs.forEach((function(halfTemp){halfTemp.id=curNode.key;halfTemp.name=curNode.hostName;halfTemp.devId=curNode.key;halfTemp.intf=nbrTmp.intf;halfTemp.vsNodeIdentify=curNode.getVSNodeIdentify();var nbrSiteTemp=self.findSite(halfTemp.nbrId);nbrSiteTemp&&(halfTemp.nbrSiteName=nbrSiteTemp.name)}))}}));return retNbrs};extendNbrHelperForSite.prototype.isNbrExistOnMap=function(nbr){if(this.isParentNbrSite(nbr)){var data={from:nbr.nbrId,to:this.currentNode.key};return this.dlgExtendNeighbor.checkBorderLinkExisting(data)}var tempNbrInfo=new CNeighborInfo(nbr.id,nbr.nbrId,nbr.intf,nbr.nbrIntf,nbr.topoTypeId,null==nbr.mediaId,nbr.mediaId,nbr.mediaInfo);return this.dlgExtendNeighbor.checkExisting1(tempNbrInfo,nbr,this.dataViewsSegmentOutCache,this.siteProperties())};extendNbrHelperForSite.prototype.genNbrsForDisplay=function(result){if(!result)return null;var nbrInfoList=[];var self=this;_.isEmpty(result.nbrIntfs)||result.nbrIntfs.forEach((function(nbrInfoTmp){var nbrListTmp=self.convertResultNbrToDisplayNbrs(nbrInfoTmp);nbrListTmp&&(nbrInfoList=nbrInfoList.concat(nbrListTmp))}));if(this.curSiteCache){var nbrListTmp=this.convertCurSiteToDisplayNbrs();nbrListTmp&&(nbrInfoList=nbrInfoList.concat(nbrListTmp))}return nbrInfoList};extendNbrHelperForSite.prototype.calculateNbrsExisted=function(nbrInfoList){var self=this;nbrInfoList.forEach((function(nbrTemp){nbrTemp.existed=self.isNbrExistOnMap(nbrTemp)}))};extendNbrHelperForSite.prototype.deferredGetDataViewsSegment=function(nbrInfoList){var dataViewsSegment=new DataViewsSegment;for(var i=0;i<nbrInfoList.length;++i){var info=nbrInfoList[i];dataViewsSegment.addDev(info.devId);dataViewsSegment.addDev(info.nbrDevId);null!=info.intf&&null!=info.intf.intfKeyObj&&dataViewsSegment.addIntf(info.devId,info.intf.intfKeyObj,info.topoTypeId);null!=info.nbrIntf&&null!=info.nbrIntf.intfKeyObj&&dataViewsSegment.addIntf(info.nbrDevId,info.nbrIntf.intfKeyObj,info.topoTypeId);dataViewsSegment.addDev(info.MediaId)}var deferred=this.defer();this.dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment).then((function(dataViewsSegmentOut){if(null!=dataViewsSegmentOut){Object.setPrototypeOf(dataViewsSegmentOut,new DataViewsSegment);deferred.resolve(dataViewsSegmentOut)}}));return deferred.promise};extendNbrHelperForSite.prototype.convertToExtendNbrs=function(nbrList){return nbrList.slice(0)};extendNbrHelperForSite.prototype.extendNbrs=function(nbrsForExtend){if(!_.isEmpty(nbrsForExtend)){var lstOtherNbrSite=[];var lstParentNbrSite=[];var self=this;nbrsForExtend.forEach((function(nbrInfo){self.isParentNbrSite(nbrInfo)?lstParentNbrSite.push(nbrInfo):lstOtherNbrSite.push(nbrInfo)}));self.doExtendOtherNbrSite(lstOtherNbrSite);self.doExtendParenNbrtSite(lstParentNbrSite)}};extendNbrHelperForSite.prototype.isParentNbrSite=function(nbrInfo){return!!this.curSiteCache&&(nbrInfo.nbrId===this.curSiteCache.ID||this.curSiteCache.parentPath.indexOf(nbrInfo.nbrId)>-1)};extendNbrHelperForSite.prototype.siteProperties=function(){return this.netmapOperator._getSitePropertie(this.siteCacheList)};extendNbrHelperForSite.prototype.getText=function(siteId){var text="Inner";var nbrList=this.nbrListCache;for(var i=0;i<nbrList.length;i++){var nbr=nbrList[i];if(!nbr.isCurrentSite){var nbrSiteId=nbr.nbrId;if(!classExtendNbrHelper.isParentSite(this.curSiteCache,nbrSiteId)){text="Border";break}}}return text};extendNbrHelperForSite.prototype.findSite=function(siteId){return _.find(this.siteCacheList,(function(siteTemp){return!!siteTemp&&siteTemp.ID===siteId}))};extendNbrHelperForSite.prototype.doExtendParenNbrtSite=function(siteNbrList){if(!_.isEmpty(siteNbrList)){var siteProperties=this.siteProperties();if(siteProperties){var deviceList=[{id:this.currentNode.key,name:this.currentNode.hostName}];for(var j=0;j<siteNbrList.length;j++){var currentSite=siteProperties.getSitePropertieById(siteNbrList[j].nbrId);var text=this.getText(siteNbrList[j].nbrId);this.netmapOperator.doAddBoardlink(this.dataViewCacheSrvc,currentSite,deviceList,text)}}}};extendNbrHelperForSite.prototype.doExtendOtherNbrSite=function(siteNbrList){var siteProperties=this.siteProperties();this.netmapOperator.getAddDevicesOp().doAddDevices([],siteNbrList,this.dataViewsSegmentOutCache,siteProperties,this.applyDataViewSrvc)};netBrain.Map.ExtendNbrHelperForSite=extendNbrHelperForSite}(NetBrain);!function(netBrain){angular.module("nb.qmap").controller("nb.qmap.extendNbrVspaceCtrl",extendNbrVspaceCtrl);extendNbrVspaceCtrl.$inject=["$scope","$q","$element","uiGridConstants","nb.dataview.httpDataViewSrvc","nb.netbrain.dataViewCacheSrvc","nb.topo.httpExternNbrSrvc","nb.qmap.autoLinkOptionSrvc","nb.dataview.applyDataViewSrvc","$timeout","nb.common.nbAlertSrvc"];function extendNbrVspaceCtrl($scope,$q,$element,uiGridConstants,httpDataViewSrvc,dataViewCacheSrvc,httpExternNbrSrvc,autoLinkOptionSrvc,applyDataViewSrvc,$timeout,nbAlertSrvc){!function(){var initStateVar=function(){$scope.nbrsCache=[];$scope.allSelected=!1;$scope.partialSelected=!1;$scope.noSelected=!1;$scope.allOnMapSelected=!1;$scope.hasMplsvrf=!1};var nbrDataCache=null;var extendNbrHelper=new netBrain.Map.ExtendNbrHelper;var initHelperProperties=function(extendNbrHelperTemp){extendNbrHelperTemp.currentNode=$scope.currentNode;extendNbrHelperTemp.defer=$q.defer;extendNbrHelperTemp.netmapOperator=$scope.parentScope.netmapOperator;extendNbrHelperTemp.httpExternNbrSrvc=httpExternNbrSrvc;extendNbrHelperTemp.dataViewCacheSrvc=dataViewCacheSrvc;extendNbrHelperTemp.autoLinkOptionSrvc=autoLinkOptionSrvc;extendNbrHelperTemp.applyDataViewSrvc=applyDataViewSrvc;extendNbrHelperTemp.dlgExtendNeighbor=$scope.parentScope.dlgExtendNeighbor};var classExtendNbrHelper=netBrain.Map.ExtendNbrHelper;var intfAllNbr=classExtendNbrHelper.intfAllNbr;var indexQuery=0;function getTotalLinkCount(){return $scope.totalLinkCount}function cacheLastSelExtendType(){$scope.selectedTopoType&&($scope.parentScope.currentMapPageTopogyType=$scope.selectedTopoType)}function getSelectedExtendType(){return $scope.selectedTopoType}function cacheIntfList(intfList){extendNbrHelper.intfListCache=[];_.isEmpty(intfList)||(extendNbrHelper.intfListCache=intfList.slice(0))}function cacheNbrList(nbrList){extendNbrHelper.nbrListCache=[];_.isEmpty(nbrList)||(extendNbrHelper.nbrListCache=nbrList.slice(0))}var displayExtendType=function(extendTypeList){!function(extendTypeList){$scope.topoTypesList=[];var hardcodeExtendTypeList=[];extendTypeList&&extendTypeList.forEach((function(extendType){$scope.topoTypesList.push(extendType);var nIndex=classExtendNbrHelper.indexOfExtendType(hardcodeExtendTypeList,extendType.id);-1!==nIndex&&hardcodeExtendTypeList.splice(nIndex,1)}));hardcodeExtendTypeList.forEach((function(extendType){$scope.topoTypesList.push(extendType)}))}(extendTypeList);var needSelectDefault=!0;$scope.topoTypesList&&$scope.topoTypesList.length>0&&(needSelectDefault=!function(extendType){if(!extendType)return!1;if(classExtendNbrHelper.hasExtendType($scope.topoTypesList,extendType.id)){$scope.selectedTopoType=extendType;return!0}return!1}($scope.parentScope.currentMapPageTopogyType));needSelectDefault&&(_.isEmpty($scope.topoTypesList)?$scope.topoTypeChanged():$scope.selectedTopoType=$scope.topoTypesList[0])};var encodefilterText=function(filterText){filterText=filterText.replace("\\","\\\\");["$","(",")","*","+",".","[","]","?","^","{","}","|"].forEach((function(item){filterText=filterText.replace(item,"\\"+item)}));return filterText};var doFilterGrid=function(renderableRows,columns,matcher,filterText){var retRenderRows=[];var length=renderableRows.length;for(var i=0;i<length;i++){var row=renderableRows[i];""!==filterText&&row.entity.intfKeyObj&&"All Neighbors"===row.entity.intfKeyObj.value||retRenderRows.push(row);var match=!1;columns.forEach((function(field){var parts=field.split(/\./g);var content=row.entity[parts.shift()];angular.forEach(parts,(function(part){content&&(content=content[part])}));content&&content.match(matcher)&&(match=!0)}));match||(row.visible=!1)}return retRenderRows};var displayIntfs=function(intfs){$scope.interfaceList=[];$scope.selectedNbrs=[];_.isEmpty(intfs)||($scope.interfaceList=intfs.slice(0));classExtendNbrHelper.sortIntfList($scope.interfaceList);$scope.interfaceList.unshift(intfAllNbr)};var deviceGridCellTemplateWithFilter='<div class="ui-grid-cell-contents" title="TOOLTIP" ng-mouseleave="grid.appScope.mouserLeave()" ng-mouseover="grid.appScope.mouserOver(row,$event)" ng-dblclick="grid.appScope.deviceGridRowDblClick(row);"  ng-bind-html="COL_FIELD|nbHighlight:grid.appScope.nbrFilterText"></div>';var initNbrGrid=function(){!function(){$scope.deviceGridOption.columnDefs=[{field:"existed",displayName:"",width:30,headerCellTemplate:"<div class=\"ui-grid-cell-contents select-all\" ng-class=\"{'checked-02':(grid.appScope.allSelected&&(!grid.appScope.allOnMapSelected)),'no-checked-02':grid.appScope.noSelected,'partial-checked-02':grid.appScope.partialSelected,'on-map':grid.appScope.allOnMapSelected}\" ng-click=\"grid.appScope.selectAllClick(row);\"></div>",cellTemplate:'<div class="ui-grid-cell-contents" title="This neighbor already exists on the map" ng-show="row.entity.existed"><i class="existed on-map"></i></div><div class="ui-grid-cell-contents"  ng-mouseleave="grid.appScope.mouserLeave()" ng-mouseover="grid.appScope.mouserOver(row,$event)" ng-show="!row.entity.existed"><i ng-class="{true:\'checked-02\',false:\'\'}[row.entity.checked]"></i></div>',enableSorting:!1}];if(classExtendNbrHelper.isSiteMode($scope.selectedTopoType)){$scope.deviceGridOption.columnDefs.push({field:"nbrSiteName",displayName:"Neighbor Site",width:"*",minWidth:120,headerTooltip:!0,cellTooltip:!0,cellTemplate:'<div class="ui-grid-cell-contents" title="TOOLTIP" ng-mouseleave="grid.appScope.mouserLeave()" ng-mouseover="grid.appScope.mouserOver(row,$event)"  ng-dblclick="grid.appScope.deviceGridRowDblClick(row);" style="margin-left:{{row.entity.space}}em"  ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.deviceFilterText"></div>'},{field:"nbrName",displayName:"Neighbor Device",width:"*",minWidth:120,headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"nbrIntf.intfDisplaySchemaObj.value",displayName:"Interface",width:"*",minWidth:185,headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"nbrIntf.mplsVrf",displayName:"VRF",width:"*",headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter})}else classExtendNbrHelper.isIntfMode($scope.selectedTopoType)?$scope.deviceGridOption.columnDefs.push({field:"nbrDevName",displayName:"Neighbor",width:"*",minWidth:120,headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"nbrIntf.intfDisplaySchemaObj.value",displayName:"Interface",width:"*",minWidth:185,headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"nbrIntf.mplsVrf",displayName:"VRF",width:"*",headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"topoTypeName",displayName:"Type",width:"*",visible:!0,headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter}):$scope.selectedTopoType.id===NetBrain.Map.Const.TopoLinkType.L2Topology?$scope.deviceGridOption.columnDefs.push({field:"nbrDevName",displayName:"Neighbor",width:"*",headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"nbrIntf.intfDisplaySchemaObj.value",displayName:"Interface",width:"*",minWidth:185,headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter}):$scope.deviceGridOption.columnDefs.push({field:"nbrDevName",displayName:"Neighbor",width:"*",headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"nbrIntf.intfDisplaySchemaObj.value",displayName:"Interface",width:"*",minWidth:185,headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"nbrIntf.mplsVrf",displayName:"VRF",width:"*",headerTooltip:!0,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter})}();!function(){$scope.deviceGridApi.selection.clearSelectedRows();$scope.nbrList=void 0}()};function getCheckedNbrRowCount(){var visibleRows=$scope.deviceGridApi.core.getVisibleRows();return _.filter(visibleRows,(function(item){return!0===item.entity.checked})).length}function countNbrsInfo(nbrList){var nbrsStatisticsInfo={mapLinkCount:0,nbrLinkCount:0};_.isEmpty(nbrList)||nbrList.forEach((function(nbrInfo){nbrInfo.existed&&nbrsStatisticsInfo.mapLinkCount++;nbrInfo.nbrId&&nbrsStatisticsInfo.nbrLinkCount++}));return nbrsStatisticsInfo}var isAllNbrSelected=function(){var nCountNbrChecked=getCheckedNbrRowCount();var nCountTotalLink=getTotalLinkCount();var bMatch1=nCountNbrChecked+$scope.parentSiteOnMapCount+$scope.mapLinkCount===nCountTotalLink+$scope.parentTotalSiteCount;var bMatch2=$scope.parentTotalSiteCount+getTotalLinkCount()!==0;return!(!bMatch1||!bMatch2)};var isAllNbrExtended=function(){return!(!$scope.allSelected||$scope.parentSiteOnMapCount+$scope.mapLinkCount!==getTotalLinkCount()+$scope.parentTotalSiteCount)};var isPartialNbrSelected=function(){return getCheckedNbrRowCount()>0&&getCheckedNbrRowCount()+$scope.parentSiteOnMapCount+$scope.mapLinkCount<getTotalLinkCount()+$scope.parentTotalSiteCount};var isNoneNbrSelected=function(){return 0===getCheckedNbrRowCount()&&!$scope.allOnMapSelected};function updateAllSelected(){$scope.allSelected=isAllNbrSelected();$scope.allOnMapSelected=isAllNbrExtended();$scope.partialSelected=isPartialNbrSelected();$scope.noSelected=isNoneNbrSelected()}var displayNbrs=function(argNbrList){$scope.deviceGridApi.selection.clearSelectedRows();$scope.nbrList=[];if(!argNbrList)return!0;argNbrList.forEach((function(nbrInfo){nbrInfo.devId&&nbrInfo.nbrDevId?$scope.nbrList.push(nbrInfo):nbrInfo.nbrId&&nbrInfo.nbrSiteName&&$scope.nbrList.push(nbrInfo)}));$scope.hasMplsvrf||($scope.hasMplsvrf=classExtendNbrHelper.isHasMplsvrf(argNbrList));!function(tempList){if("block"===$(".dataViewEditorMode").css("display")){var allDevices=$scope.parentScope.netmap._getAllDevices(!0);var ids=_.pluck(allDevices,"key");var applyDataViewId=null;if(!$scope.parentScope.netmap._netmapJsWrapper.pageData.applyDataViewInfo)return;if($scope.parentScope.netmap._netmapJsWrapper.pageData.applyDataViewInfo.compoundDataViewInfo){var selected=_.find($scope.parentScope.netmap._netmapJsWrapper.pageData.applyDataViewInfo.compoundDataViewInfo.dataViewGroupList,{isSelected:!0});applyDataViewId=selected?selected.dataViewGroupId:$scope.parentScope.netmap._netmapJsWrapper.pageData.applyDataViewInfo.compoundDataViewInfo.dataViewGroupList[0].dataViewGroupId}else applyDataViewId=$scope.parentScope.netmap._netmapJsWrapper.pageData.applyDataViewInfo.dataViewInfo.dataViewGroupId;$scope.cachedDataViewGroupDevicesData[applyDataViewId]?$scope.nbrList=_.filter(tempList,(function(v,k){return _.find($scope.cachedDataViewGroupDevicesData[applyDataViewId],(function(id){return id===v.nbrId}))})):httpDataViewSrvc.getDeviceDataViewsByDataViewGroupIdAndDevIds(null,applyDataViewId,ids,null).then((function(devices){var includes=_.pluck(devices,"key");$scope.cachedDataViewGroupDevicesData[applyDataViewId]=includes;$scope.nbrList=_.filter(tempList,(function(v,k){return _.find(includes,(function(id){return id===v.nbrId}))}))}))}else $scope.nbrList=tempList}($scope.nbrList);!function(){var filterMapLinkCount=0;_.each($scope.nbrList,(function(item){item.existed&&(filterMapLinkCount+=1)}));$scope.filterMapLinkCount=filterMapLinkCount}();$timeout((function(){var canv=angular.element(".extendNeighbourRightPanel .extendNerghbourDiv .deviceGridStyle .ui-grid-contents-wrapper .ui-grid-render-container .ui-grid-viewport .ui-grid-canvas");var width=canv.width();canv.css("width",width+1+"px");$timeout((function(){canv.css("width","")}),50)}),10);return!0};$scope.closeExtendNbrDialog=function(){$scope.parentScope.dlgExtendNeighbor.closeExtendNbrDialog()};$scope.getNbrDataCache=function(){var nbrDataTemp={};for(var key in nbrDataCache)nbrDataTemp[key]="nbrs"===key?JSON.parse(JSON.stringify(nbrDataCache.nbrs)):nbrDataCache[key];return nbrDataTemp};$scope.topoTypeChanged=function(){if($scope.selectedTopoType){$scope.interfaceList&&($scope.interfaceList=[]);initStateVar();initNbrGrid();extendNbrHelper=classExtendNbrHelper.createInstance($scope.selectedTopoType);initHelperProperties(extendNbrHelper);!function(extendTypeList){extendNbrHelper.extendTypeList=[];_.isEmpty(extendTypeList)||(extendNbrHelper.extendTypeList=extendTypeList.slice(0))}($scope.topoTypesList);if(classExtendNbrHelper.isSiteMode($scope.selectedTopoType))extendNbrHelper.deferredLoadIntfs(null).then((function(intfList){displayIntfs(intfList);$scope.$applyAsync((function(){$scope.deviceGridApi.selection.clearSelectedRows();$scope.interfaceGridApi.selection.selectRow(intfAllNbr);indexQuery++}));cacheIntfList(intfList);var intfListForGetNbrs=[];_.isEmpty(intfList)||intfList.forEach((function(intf){intfListForGetNbrs.push({intf:intf,topoTypeId:""})}));return extendNbrHelper.deferredLoadNbrs(intfListForGetNbrs,null)})).then((function(result){$scope.mapLinkCount=0;$scope.totalLinkCount=0;var nbrList=extendNbrHelper.genNbrsForDisplay(result);extendNbrHelper.deferredGetDataViewsSegment(nbrList).then((function(dataViewsSegmentOut){extendNbrHelper.dataViewsSegmentOutCache=dataViewsSegmentOut;extendNbrHelper.calculateNbrsExisted(nbrList);displayNbrs(nbrList);cacheNbrList(nbrList);var nbrsStatisticsInfo=countNbrsInfo(nbrList);$scope.mapLinkCount=nbrsStatisticsInfo.mapLinkCount;$scope.totalLinkCount=nbrsStatisticsInfo.nbrLinkCount;$scope.filterMapLinkCount=nbrsStatisticsInfo.mapLinkCount;updateAllSelected()}))}));else{var nbrDataTemp=$scope.getNbrDataCache();var curResut=classExtendNbrHelper.filterNbrsAndPorts(nbrDataTemp,getSelectedExtendType());if(curResut){displayIntfs(curResut.intfs);$scope.$applyAsync((function(){$scope.deviceGridApi.selection.clearSelectedRows();$scope.interfaceGridApi.selection.clearSelectedRows();$scope.interfaceGridApi.selection.selectRow(intfAllNbr);indexQuery++}));cacheIntfList(curResut.intfs);$scope.mapLinkCount=0;$scope.totalLinkCount=0;var nbrList=extendNbrHelper.genNbrsForDisplay(curResut);displayNbrs(nbrList);cacheNbrList(curResut.nbrs);var nbrsStatisticsInfo=countNbrsInfo(nbrList);$scope.mapLinkCount=nbrsStatisticsInfo.mapLinkCount;$scope.totalLinkCount=nbrsStatisticsInfo.nbrLinkCount;$scope.filterMapLinkCount=nbrsStatisticsInfo.mapLinkCount;updateAllSelected()}}}};$scope.getModelTitle=function(){var nidEx=$scope.currentNode.getVSNodeIdentify();var vspaceName;nidEx&&nidEx.visualSpaceInfo&&(vspaceName=nidEx.visualSpaceInfo.visualSpaceName);return vspaceName?"Neighbors of "+$scope.currentNode.hostName+"("+vspaceName+")":"Neighbors of "+$scope.currentNode.hostName};$scope.filterInterfaces=function(event){13===event.keyCode&&$scope.interfaceGridApi.grid.refresh()};$scope.clearFilter=function(){$scope.interfaceFilterText="";$scope.searchKey="";$scope.interfaceGridApi.grid.refresh()};$scope.interfaceFilter=function(renderableRows){$scope.interfaceFilterText=$scope.searchKey;var filterText=encodefilterText($scope.interfaceFilterText);var matcher=new RegExp(filterText,"i");return doFilterGrid(renderableRows,["intfDisplaySchemaObj.value"],matcher,filterText)};$scope.registerApiInterfaceGrid=function(gridApi){$scope.interfaceGridApi=gridApi;gridApi.selection.on.rowSelectionChanged($scope,(function(row){$scope.$evalAsync($scope.displayNbrsByIntfsSelection,++indexQuery)}));gridApi.selection.on.rowSelectionChangedBatch($scope,(function(rows){$scope.$evalAsync($scope.displayNbrsByIntfsSelection,++indexQuery)}));gridApi.grid.registerRowsProcessor($scope.interfaceFilter,200)};$scope.interfaceGridOption={onRegisterApi:$scope.registerApiInterfaceGrid,data:"interfaceList",columnDefs:[{field:"intfDisplaySchemaObj.value",displayName:"name",width:"*",cellTooltip:!0,cellTemplate:'<div class="ui-grid-cell-contents" ng-class="{\'cellContentpadding\':grid.appScope.interfaceList.length>7}" title="TOOLTIP" ng-dblclick="grid.appScope.interfaceGridRowDblClick(row);" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.interfaceFilterText"></div>'}],showHeader:!1,multiSelect:!0,enableRowSelection:!0,enableRowHeaderSelection:!1,modifierKeysToMultiSelect:!0,noUnselect:!0,excessRows:13,enableColumnMenus:!1};$scope.interfaceGridRowDblClick=function(row){if(row){cacheLastSelExtendType();var curSelIntf=row.entity;if(!classExtendNbrHelper.isSiteMode($scope.selectedTopoType)||!classExtendNbrHelper.hasAllNbrIntfItem([curSelIntf])){var nbrList=extendNbrHelper.filterNbrs([curSelIntf],getSelectedExtendType());var nbrsForExtend=extendNbrHelper.convertToExtendNbrs(nbrList);"L2_Topo_Type"===$scope.selectedTopoType.id||!_.isEmpty(nbrsForExtend)||(intf=curSelIntf)&&intf.belongToTopoType&&1===intf.belongToTopoType.length&&"L2_Topo_Type"===intf.belongToTopoType[0]||classExtendNbrHelper.hasAllNbrIntfItem([curSelIntf])||(nbrsForExtend=[extendNbrHelper.getMuteLanNbr(curSelIntf)]);var intf;if(!exceedFifty(nbrsForExtend)){extendNbrHelper.extendNbrs(nbrsForExtend);$scope.parentScope.dlgExtendNeighbor.closeExtendNbrDialog()}}}};$scope.displayNbrsByIntfsSelection=function(intf,index){if(function(index){return indexQuery===index}(index)){var curIntfsSelected=$scope.interfaceGridApi.selection.getSelectedRows();intfList=curIntfsSelected,nbrList=extendNbrHelper.filterNbrs(intfList,getSelectedExtendType()),displayNbrs(nbrList);var intfList,nbrList;indexQuery=0}};$scope.neighborFilter=function(event){13===event.keyCode&&$scope.deviceGridApi.grid.refresh()};$scope.clearNbrFilter=function(){$scope.nbrSearchKey="";$scope.nbrFilterText="";$scope.deviceGridApi.grid.refresh()};$scope.nbrFilter=function(renderableRows){$scope.nbrFilterText=$scope.nbrSearchKey;var filterText=encodefilterText($scope.nbrFilterText);var matcher=new RegExp(filterText,"i");var columns=["nbrName","nbrIntf.intfDisplaySchemaObj.value","nbrIntf.mplsVrf"];classExtendNbrHelper.isSiteMode($scope.selectedTopoType)?columns.push("nbrSiteName"):columns.indexOf("nbrSiteName")>-1&&columns.remove("nbrSiteName");classExtendNbrHelper.isIntfMode($scope.selectedTopoType)&&columns.push("topoTypeName");return doFilterGrid(renderableRows,columns,matcher,filterText)};$scope.registerApiDeviceGrid=function(gridApi){$scope.deviceGridApi=gridApi;gridApi.selection.on.rowSelectionChanged($scope,(function(row){if(0==row.entity.existed&&row.isSelected){row.entity.checked=!0;$(".ui-grid-cell-contents> i").removeClass("no-checked-02")}else row.entity.checked=!1;!function(){var filterMapLinkSelectedCount=0;var selectedGridRows=$scope.deviceGridApi.selection.getSelectedGridRows();_.each(selectedGridRows,(function(item){item.isSelected&&!item.entity.existed&&(filterMapLinkSelectedCount+=1)}));$scope.filterMapLinkSelectedCount=filterMapLinkSelectedCount}();updateAllSelected()}));gridApi.grid.registerRowsProcessor($scope.nbrFilter,200)};$scope.deviceGridOption={onRegisterApi:$scope.registerApiDeviceGrid,data:"nbrList",columnDefs:null,multiSelect:!0,enableRowSelection:!0,modifierKeysToMultiSelect:!1,enableHeaderBar:!0,excessRows:13,enableColumnMenus:!1};$scope.selectAllClick=function(){if($scope.mapLinkCount+$scope.parentSiteOnMapCount!=getTotalLinkCount()+$scope.parentTotalSiteCount||$scope.parentTotalSiteCount+getTotalLinkCount()==0){$scope.allSelected=!$scope.allSelected;if($scope.allSelected)$scope.deviceGridApi.selection.selectAllRows();else{$scope.noSelected=!0;$scope.deviceGridApi.selection.clearSelectedRows()}}};$scope.mouserOver=function(row,event){if(!row.entity.existed){var tags=event.target.parentNode.parentNode.getElementsByTagName("i");row.entity.checked?$(tags[1]).removeClass().removeClass("no-checked-02").addClass("checked-02"):$(tags[1]).removeClass().removeClass("checked-02").addClass("no-checked-02")}};$scope.mouserLeave=function(row){$(".ui-grid-cell-contents> i").removeClass("no-checked-02")};$scope.setFocus=function(el){$(el.currentTarget).find("input").focus()};function exceedFifty(nbrsForExtend){var result=!1;if($scope.deviceGridApi.selection.getSelectedGridRows().length>50||nbrsForExtend&&nbrsForExtend.length>50){nbAlertSrvc.warning({message:"Failed to extend neighbors. The neighbor count cannot exceed 50. Please check and try again."}).then((function(){$scope.deviceGridApi.selection.clearSelectedRows()}));result=!0}return result}$scope.deviceGridRowDblClick=function(row){if(!exceedFifty()){cacheLastSelExtendType();var selectedNbrs="";selectedNbrs=row?[row.entity]:function(rows){if(rows){var list=_.filter(rows,(function(row){return row.visible}));return _.pluck(list,"entity")}}(selectedNbrs=$scope.deviceGridApi.selection.getSelectedGridRows());var nbrsForExtend=extendNbrHelper.convertToExtendNbrs(selectedNbrs);extendNbrHelper.extendNbrs(nbrsForExtend);$scope.parentScope.dlgExtendNeighbor.closeExtendNbrDialog()}};!function(){$scope.currentNode=$scope.model.data;$scope.devType=$scope.model.devType;$scope.parentScope=$scope.model.scope;$scope.interfaceFilterText="";$scope.searchKey="";$scope.nbrSearchKey="";$scope.nbrFilterText="";$scope.selectedInterfaces=[];$scope.interfaceList=[];$scope.topoTypesList=[];$scope.selectedTopoType=null;$scope.parentSiteOnMapCount=0;$scope.parentTotalSiteCount=0;$scope.mapLinkCount=0;$scope.filterMapLinkCount=0;$scope.filterMapLinkSelectedCount=0;$scope.totalLinkCount=0;$scope.allSelected=!1;$scope.partialSelected=!1;$scope.noSelected=!1;$scope.allOnMapSelected=!1}();initStateVar();initHelperProperties(extendNbrHelper);extendNbrHelper.deferredLoadData($scope.currentNode.getVSNodeIdentify()).then((function(result){nbrDataCache=result;var extendTypeList=[];result&&(extendTypeList=classExtendNbrHelper.convertToExtendTypeList(result.topoTypes,classExtendNbrHelper.topoTypeDef));extendTypeList.push(classExtendNbrHelper.intfExtendType());classExtendNbrHelper.isLegacyNode($scope.currentNode.getVSNodeIdentify())&&extendTypeList.push(classExtendNbrHelper.siteExtendType());displayExtendType(extendTypeList)}))}()}}(NetBrain);!function(){angular.module("nb.qmap").controller("nb.qmap.hostnameInvalidTipCtrl",hostnameInvalidTipCtrl);hostnameInvalidTipCtrl.$inject=["$scope","dialogService"];function hostnameInvalidTipCtrl($scope,dialogService){$scope.closeHostNameInvalidTip=function(){var id=$scope.model.id;dialogService.close(id)}}}();!function(){angular.module("nb.qmap").controller("nb.qmap.extendNeighbourSiteCtrl",extendNeighbourSiteCtrl);extendNeighbourSiteCtrl.$inject=["$scope","$document","$element","$sce","uiGridConstants","nb.dataview.httpDataViewSrvc","nb.topo.editTopoManager","nb.netbrain.dataViewCacheSrvc","nb.ng.utilitySrvc","nb.topo.httpExternNbrSrvc","nb.dataview.applyDataViewSrvc","nb.common.nbAlertSrvc"];function extendNeighbourSiteCtrl($scope,$document,$element,$sce,uiGridConstants,httpDataViewSrvc,editTopoManager,dataViewCacheSrvc,utilitySrvc,httpExternNbrSrvc,applyDataViewSrvc,nbAlertSrvc){var _queryIndex=0;!function(){$scope.currentNode=$scope.model.data;$scope.devType=$scope.model.devType;$scope.parentScope=$scope.model.scope;$scope.InterfaceListCache=[];$scope.deviceFilterText="";$scope.nbrSearchKey="";$scope.nbrList=void 0;$scope.allSelected=!1;$scope.interfaceFilterText="";$scope.searchKey="";$scope.selectedInterfaces=[];$scope.interfaceList=[];$scope.categoryList=[];$scope.selectedNodeCategory=null;$scope.mapLinkCount=0;$scope.totalLinkCount=0;$scope.filterMapLinkCount=0;$scope.filterMapLinkSelectedCount=0;$scope.currentNode.displayName.length>45?$scope.displayName=$scope.currentNode.displayName.substr(0,40)+"...":$scope.displayName=$scope.currentNode.displayName;var tempAllNeighbor={intfKeyObj:{schema:"",value:"All Neighbors"},intfDisplaySchemaObj:{schema:"",value:"All Neighbors"},disPlayName:"All Neighbors",isAllNeighbor:function(entity){return!!entity&&(entity.intfKeyObj&&entity.intfKeyObj.value===this.disPlayName)}};var nodeCategory={Site:"Site",Device:"Device"};!function(){$scope.categoryList.push(nodeCategory.Site);$scope.categoryList.push(nodeCategory.Device);$scope.selectedNodeCategory=null!=$scope.parentScope.currentMapPageCatorgyType?$scope.parentScope.currentMapPageCatorgyType:$scope.categoryList[0]}();$scope.initVarState=function(){$scope.allSelected=!1;$scope.partialSelected=!1;$scope.noSelected=!1;$scope.allOnMapSelected=!1;$scope.dataViewsSegmentOutCache={};$scope.sitesCache={};$scope.nbrsCache={};$scope.speNbrsCache={};$scope.nbrList=void 0;$scope.gridApi.selection.clearSelectedRows()};$scope.categoryChanged=function(){if(null!=$scope.selectedNodeCategory){$scope.initVarState();$scope.selectedNodeCategory===nodeCategory.Site?toggleSiteNameColVisible(1,!0):$scope.selectedNodeCategory===nodeCategory.Device&&toggleSiteNameColVisible(1,!1);$scope.parentScope.currentMapPageCatorgyType=$scope.selectedNodeCategory;!function(siteId){$scope.interfaceGridApi.selection.clearSelectedRows();if(_.isEmpty($scope.InterfaceListCache))httpExternNbrSrvc.getBorderInterfaceOfSite(siteId).then((function(result){$scope.selectedNodeCategory===nodeCategory.Site&&setInterfaceList(result,!0);$scope.selectedNodeCategory===nodeCategory.Device&&setInterfaceList(result);$scope.$applyAsync((function(){$scope.interfaceGridApi.selection.selectRow(tempAllNeighbor)}));loadNbrSiteAndDeviceIntfs(createIds(!0))}));else{loadNbrSiteAndDeviceIntfs(createIds(!0));$scope.$applyAsync((function(){$scope.interfaceGridApi.selection.selectRow(tempAllNeighbor)}))}}($scope.currentNode.key)}};$scope.getDeviceData=function(scope,params){if(_queryIndex===params){!function(ids){$scope.deviceGridApi.selection.clearSelectedRows();if(Array.isArray(ids)&&!_.isEmpty($scope.nbrsCache))for(var i=0;i<ids.length;i++){var idObj=ids[i];createNbrList($scope.nbrsCache[idObj.intf.intfKeyObj.value])}!function(){var filterMapLinkCount=0;_.each($scope.nbrList,(function(item){item.existed&&(filterMapLinkCount+=1)}));$scope.filterMapLinkCount=filterMapLinkCount}();updateAllSelected()}(createIds());_queryIndex=0}};$scope.filterInterfaces=function(event){13===event.keyCode&&$scope.interfaceGridApi.grid.refresh()};$scope.clearFilter=function(){$scope.interfaceFilterText="";$scope.searchKey="";$scope.interfaceGridApi.grid.refresh()};$scope.encodefilterText=function(filterText){filterText=filterText.replace("\\","\\\\");["$","(",")","*","+",".","[","]","?","^","{","}","|"].forEach((function(item){filterText=filterText.replace(item,"\\"+item)}));return filterText};$scope.interfaceFilter=function(renderableRows){$scope.interfaceFilterText=$scope.searchKey;var filterText=$scope.encodefilterText($scope.interfaceFilterText);var matcher=new RegExp(filterText,"i");return $scope.filter(renderableRows,["borderDeviceName","intfDisplaySchemaObj.value"],matcher,filterText)};$scope.filter=function(renderableRows,columns,matcher,filterText){var renderRows=[];renderableRows.forEach((function(row){""!==filterText&&tempAllNeighbor.isAllNeighbor(row.entity)||renderRows.push(row);var match=!1;columns.forEach((function(field){var parts=field.split(/\./g);var content=row.entity[parts.shift()];angular.forEach(parts,(function(part){content&&(content=content[part])}));content&&content.match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderRows};$scope.interfaceGridOption={onRegisterApi:function(gridApi){$scope.interfaceGridApi=gridApi;gridApi.selection.on.rowSelectionChanged($scope,(function(){$scope.$evalAsync($scope.getDeviceData,++_queryIndex)}));gridApi.selection.on.rowSelectionChangedBatch($scope,(function(){$scope.$evalAsync($scope.getDeviceData,++_queryIndex)}));gridApi.grid.registerRowsProcessor($scope.interfaceFilter,200)},data:"interfaceList",columnDefs:[{field:"disPlayName",displayName:"name",width:"*",cellTooltip:!0,cellTemplate:'<div class="ui-grid-cell-contents" ng-class="{\'cellContentpadding\':grid.appScope.interfaceList.length>7}"  title="TOOLTIP" ng-dblclick="grid.appScope.interfaceGridRowDblClick(row);" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.interfaceFilterText"></div>'}],showHeader:!1,multiSelect:!0,enableRowSelection:!0,enableRowHeaderSelection:!1,modifierKeysToMultiSelect:!0,noUnselect:!0,enableSelectionBatchEvent:!0,excessRows:13,enableColumnMenus:!1};var deviceGridCellTemplateWithFilter='<div class="ui-grid-cell-contents" title="TOOLTIP" ng-mouseleave="grid.appScope.mouserLeave()" ng-mouseover="grid.appScope.mouserOver(row,$event)"  ng-dblclick="grid.appScope.deviceGridRowDblClick(row);"  ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.deviceFilterText"></div>';$scope.mouserOver=function(row,event){if(!row.entity.existed){var tags=event.target.parentNode.parentNode.getElementsByTagName("i");row.entity.checked?$(tags[1]).removeClass().removeClass("no-checked-02").addClass("checked-02"):$(tags[1]).removeClass().removeClass("checked-02").addClass("no-checked-02")}};$scope.mouserLeave=function(){$(".ui-grid-cell-contents> i").removeClass("no-checked-02")};$scope.deviceGridOption={onRegisterApi:function(gridApi){$scope.deviceGridApi=gridApi;gridApi.selection.on.rowSelectionChanged($scope,(function(row){if(!1===row.entity.existed){row.entity.checked=!row.entity.checked;$(".ui-grid-cell-contents> i").removeClass("no-checked-02")}!function(){var filterMapLinkSelectedCount=0;var selectedGridRows=$scope.deviceGridApi.selection.getSelectedGridRows();_.each(selectedGridRows,(function(item){item.isSelected&&!item.entity.existed&&(filterMapLinkSelectedCount+=1)}));$scope.filterMapLinkSelectedCount=filterMapLinkSelectedCount}();updateAllSelected()}));gridApi.grid.registerRowsProcessor($scope.deviceFilter,200)},data:"nbrList",columnDefs:[{field:"existed",displayName:"",width:30,headerCellTemplate:"<div class=\"ui-grid-cell-contents select-all\" ng-class=\"{'checked-02':(grid.appScope.allSelected&&(!grid.appScope.allOnMapSelected)),'no-checked-02':grid.appScope.noSelected,'partial-checked-02':grid.appScope.partialSelected,'on-map':grid.appScope.allOnMapSelected}\" ng-click=\"grid.appScope.selectAllClick(row);\" atag=\"map:extendNeighbourSiteCtrl:header\"></div>",cellTemplate:'<div class="ui-grid-cell-contents" title="This neighbor already exists on the map" ng-show="row.entity.existed"><i class="on-map"></i></div><div class="ui-grid-cell-contents" ng-mouseleave="grid.appScope.mouserLeave()" ng-mouseover="grid.appScope.mouserOver(row,$event)" ng-show="!row.entity.existed"><i ng-class="{true:\'checked-02\',false:\'\'}[row.entity.checked]"></i></div>',enableSorting:!1},{field:"nbrSiteName",displayName:"Neighbor Site",width:"*",minWidth:120,cellTooltip:!0,cellTemplate:'<div class="ui-grid-cell-contents" title="TOOLTIP" ng-mouseleave="grid.appScope.mouserLeave()" ng-mouseover="grid.appScope.mouserOver(row,$event)"  ng-dblclick="grid.appScope.deviceGridRowDblClick(row);" style="margin-left:{{row.entity.space}}em"  ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.deviceFilterText"></div>'},{field:"nbrName",displayName:"Neighbor Device",width:"*",minWidth:120,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"nbrIntf.intfDisplaySchemaObj.value",displayName:"Interface",width:"*",minWidth:185,cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter},{field:"nbrIntf.mplsVrf",displayName:"VRF",width:"*",cellTooltip:!0,cellTemplate:deviceGridCellTemplateWithFilter}],multiSelect:!0,enableRowSelection:!0,enableRowHeaderSelection:!1,modifierKeysToMultiSelect:!1,excessRows:13,enableColumnMenus:!1};$scope.selectedNodeCategory===nodeCategory.Site?toggleSiteNameColVisible(1,!0):$scope.selectedNodeCategory===nodeCategory.Device&&toggleSiteNameColVisible(1,!1);$scope.clearNbrFilter=function(event){$scope.deviceFilterText="";$scope.nbrSearchKey="";$scope.deviceGridApi.grid.refresh()};$scope.neighborFilter=function(event){13===event.keyCode&&$scope.deviceGridApi.grid.refresh()};$scope.deviceFilter=function(renderableRows){$scope.deviceFilterText=$scope.nbrSearchKey;var filterText=$scope.encodefilterText($scope.deviceFilterText);var matcher=new RegExp(filterText,"i");var columns=["nbrSiteName","nbrName","nbrIntf.intfDisplaySchemaObj.value","nbrIntf.mplsVrf"];$scope.filter(renderableRows,columns,matcher);renderableRows.forEach((function(row){var match=!1;columns.forEach((function(field){var parts=field.split(/\./g);var content=row.entity[parts.shift()];angular.forEach(parts,(function(part){content&&(content=content[part])}));content&&content.match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderableRows};$scope.selectAllClick=function(){if($scope.mapLinkCount!==$scope.totalLinkCount||0===$scope.totalLinkCount){$scope.allSelected=!$scope.allSelected;if($scope.allSelected)$scope.deviceGridApi.selection.selectAllRows();else{$scope.noSelected=!0;$scope.gridApi.selection.clearSelectedRows()}}};$scope.applyExtendNbr=function(nbrAllInfoList){$scope.parentScope.netmapOperator.extendNeighbors(nbrAllInfoList)};$scope.interfaceGridRowDblClick=function(row){var selectedInterface=row.entity;if(!tempAllNeighbor.isAllNeighbor(selectedInterface)){var device=$scope.borderDevicesCache[selectedInterface.intfKeyObj.value];var deviceList=[{id:device.borderDeviceId,name:device.borderDeviceName,intfInfo:device.interfaceName}];!function(site,deviceList,text){$scope.parentScope.netmapOperator.doAddBoardlink(dataViewCacheSrvc,site,deviceList,text)}(getSitePropertie($scope.sitesCache).getSitePropertieById($scope.currentNode.key),deviceList,"Border");$scope.closeExtendNbrDialog()}};$scope.closeExtendNbrDialog=function(){$scope.parentScope.dlgExtendNeighbor.closeExtendNbrDialog()};$scope.deviceGridRowDblClick=function(row){if(!function(nbrsForExtend){var result=!1;if($scope.deviceGridApi.selection.getSelectedGridRows().length>50||nbrsForExtend&&nbrsForExtend.length>50){nbAlertSrvc.warning({message:"Failed to extend neighbors. The neighbor count cannot exceed 50. Please check and try again."}).then((function(){$scope.deviceGridApi.selection.clearSelectedRows()}));result=!0}return result}()){!function(nbrAllInfoList,callback){if(0===nbrAllInfoList||!nbrAllInfoList)return;var addDevicesOp=$scope.parentScope.netmapOperator.getAddDevicesOp();var devInfoList=callback(nbrAllInfoList);if(_.isEmpty($scope.dataViewsSegmentOutCache)){var dataViewsSegment=setDataViewsSegment(nbrAllInfoList);dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment).then((function(dataViewsSegmentOut){if(null!=dataViewsSegmentOut){Object.setPrototypeOf(dataViewsSegmentOut,new DataViewsSegment);addDevicesOp.doAddDevices(devInfoList,nbrAllInfoList,dataViewsSegmentOut,getSitePropertie($scope.sitesCache),applyDataViewSrvc)}}))}else addDevicesOp.doAddDevices(devInfoList,nbrAllInfoList,$scope.dataViewsSegmentOutCache,getSitePropertie($scope.sitesCache),applyDataViewSrvc)}(row?[row.entity]:function(rows){if(rows){var list=_.filter(rows,(function(row){return row.visible}));return _.pluck(list,"entity")}}($scope.deviceGridApi.selection.getSelectedGridRows()),createDevInfoList);$scope.closeExtendNbrDialog()}};function createIds(isLoad){$scope.selectedInterfaces=$scope.interfaceGridApi.selection.getSelectedRows();var ids=[];if(isLoad)$scope.InterfaceListCache.forEach((function(intf){ids.push({intf:intf,topoTypeId:""})}));else if($scope.selectedInterfaces.length>0&&tempAllNeighbor.isAllNeighbor($scope.selectedInterfaces[0])){$scope.isAllNeighborsSelect=!0;$scope.interfaceList.slice(1,$scope.interfaceList.length).forEach((function(intf){ids.push({intf:intf,topoTypeId:""})}))}else{$scope.isAllNeighborsSelect=!1;$scope.selectedInterfaces.forEach((function(intf){ids.push({intf:intf,topoTypeId:""})}))}return ids}function createDevInfoList(nbrAllInfoList){var devInfoList=[];$scope.selectedNodeCategory===nodeCategory.Site?nbrAllInfoList.forEach((function(item){devInfoList.push({id:item.nbrId,isMedia:!1,isSite:!0});item.isSite=!0})):nbrAllInfoList.forEach((function(item){devInfoList.push({id:item.nbrDevId,isSite:!1,isMedia:!1})}));return devInfoList}function updateAllSelected(){var notExistedOnMapLength=function(){var notExistedOnMapLength=getSelectedRow().length;getSelectedRow().forEach((function(item){void 0!==item.existed&&item.existed&&notExistedOnMapLength>0&&notExistedOnMapLength--}));return notExistedOnMapLength}();if(notExistedOnMapLength+$scope.mapLinkCount===gettotalLinkCount()&&0!==$scope.totalLinkCount){$scope.allSelected=!0;$scope.mapLinkCount===gettotalLinkCount()&&($scope.allOnMapSelected=!0)}else $scope.allSelected=!1;notExistedOnMapLength>0&&notExistedOnMapLength+$scope.mapLinkCount<gettotalLinkCount()?$scope.partialSelected=!0:$scope.partialSelected=!1;0!==notExistedOnMapLength||$scope.allOnMapSelected?$scope.noSelected=!1:$scope.noSelected=!0}function getSelectedRow(){return $scope.deviceGridApi.selection.getSelectedRows()}function gettotalLinkCount(){return $scope.totalLinkCount}function toggleSiteNameColVisible(col,visible){$scope.deviceGridOption.columnDefs[col].visible=visible}function getSitePropertie(arrSite){return $scope.parentScope.dlgExtendNeighbor.getSitePropertie(arrSite)}function setInterfaceList(borderInterfaceList,isSite){$scope.borderDevicesCache={};$scope.interfaceList=[];$scope.InterfaceListCache=[];$scope.interfaceList.push(tempAllNeighbor);borderInterfaceList.forEach((function(item){var obj={};obj.borderDeviceId=item.borderDeviceId;obj.disPlayName=item.borderDeviceName+"("+item.interfaceName.intfDisplaySchemaObj.value+")";obj.borderDeviceName=item.borderDeviceName;obj.intfKeyObj=item.interfaceName.intfKeyObj;obj.intfDisplaySchemaObj=item.interfaceName.intfDisplaySchemaObj;$scope.InterfaceListCache.push(obj);$scope.borderDevicesCache[item.interfaceId]=item;item.isNbrMplsCould&&isSite||$scope.interfaceList.push(obj)}))}function loadNbrSiteAndDeviceIntfs(ids){0!==ids.length?httpExternNbrSrvc.getNbrSiteAndDeviceIntfs(ids,$scope.currentNode.key).then((function(result){$scope.sitesCache={};$scope.nbrsCache={};$scope.speNbrsCache={};$scope.nbrList=[];$scope.totalLinkCount=0;result.siteList.forEach((function(site){$scope.sitesCache[site.ID]=site}));result.nbrIntfs.forEach((function(nbrIntf){var buildNbrIntf=function(nbrs,nbrIntf){nbrIntf.nbrs.forEach((function(intf){intf.id=$scope.currentNode.key;intf.name=$scope.sitesCache[intf.id].name;intf.devId=$scope.borderDevicesCache[nbrIntf.intf.intfKeyObj.value].borderDeviceId;intf.borderDeviceName=$scope.borderDevicesCache[nbrIntf.intf.intfKeyObj.value].borderDeviceName;intf.intf=$scope.borderDevicesCache[nbrIntf.intf.intfKeyObj.value].interfaceName;intf.nbrId=$scope.selectedNodeCategory===nodeCategory.Site?intf.nbrId:intf.nbrDevId;intf.nbrSiteName=$scope.selectedNodeCategory===nodeCategory.Site&&"-1"!==intf.nbrId?$scope.sitesCache[intf.nbrId].name:""}));return nbrIntf}(nbrIntf.nbrs,nbrIntf);$scope.selectedNodeCategory===nodeCategory.Site&&(buildNbrIntf.nbrs=function(nbrList,sites){var currentSite=sites[$scope.currentNode.key];var tempNbrList=[];nbrList.forEach((function(nbr){var nbrSite=sites[nbr.nbrId];var preName=0;nbrSite&&nbrSite.parentPath.forEach((function(siteId){if(currentSite.parentPath.indexOf(siteId)<=-1){var tempSite=sites[siteId];var tempNbr=angular.copy(nbr);tempNbr.nbrId=tempSite.ID;tempNbr.nbrSiteName=tempSite.name;var temp=0;if(0===tempNbrList.filter((function(hItem){return hItem.nbrSiteName===tempNbr.nbrSiteName&&hItem.nbrName===tempNbr.nbrName&&hItem.nbrIntf===tempNbr.nbrIntf})).length){tempNbrList.push(tempNbr);temp=preName++}tempNbr.space=temp}}));nbr.space=preName;tempNbrList.push(nbr)}));return tempNbrList}(buildNbrIntf.nbrs,$scope.sitesCache));$scope.speNbrsCache[nbrIntf.intf.intfKeyObj.value]=buildNbrIntf.speNbrs;$scope.nbrsCache[nbrIntf.intf.intfKeyObj.value]=buildNbrIntf.nbrs;buildNbrIntf.nbrs.forEach((function(nbr){$scope.selectedNodeCategory===nodeCategory.Site?"-1"!==nbr.nbrId&&$scope.nbrList.push(nbr):$scope.nbrList.push(nbr)}))}));var dataViewsSegment=setDataViewsSegment($scope.nbrList);nbrListlength=$scope.nbrList.length,$scope.totalLinkCount+=nbrListlength;var nbrListlength;dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegment).then((function(dataViewsSegmentOut){if(null!=dataViewsSegmentOut){$scope.mapLinkCount=0;$scope.dataViewsSegmentOutCache={};$scope.dataViewsSegmentOutCache=dataViewsSegmentOut;Object.setPrototypeOf(dataViewsSegmentOut,new DataViewsSegment);$scope.nbrList.forEach((function(nbr){var tempNbrInfo=new CNeighborInfo(nbr.id,nbr.nbrId,nbr.intf,nbr.nbrIntf,nbr.topoTypeId,null==nbr.mediaId,nbr.mediaId,nbr.mediaInfo);nbr.existed=$scope.parentScope.dlgExtendNeighbor.checkExisting1(tempNbrInfo,nbr,dataViewsSegmentOut,getSitePropertie($scope.sitesCache));nbr.existed&&$scope.mapLinkCount++}));updateAllSelected();$scope.nbrList=$scope.parentScope.dlgExtendNeighbor.unique($scope.nbrList)}}))})):$scope.nbrList=[]}function setDataViewsSegment(nbrList){var dataViewsSegment=new DataViewsSegment;if(Array.isArray(nbrList))for(var i=0;i<nbrList.length;i++){var info=nbrList[i];dataViewsSegment.addDev(info.devId);dataViewsSegment.addDev(info.nbrDevId);null!=info.intf&&null!=info.intf.intfKeyObj&&dataViewsSegment.addIntf(info.devId,info.intf.intfKeyObj,info.topoTypeId);null!=info.nbrIntf&&null!=info.nbrIntf.intfKeyObj&&dataViewsSegment.addIntf(info.nbrDevId,info.nbrIntf.intfKeyObj,info.topoTypeId);dataViewsSegment.addDev(info.MediaId)}return dataViewsSegment}function createNbrList(nbrList){if(nbrList&&0!==nbrList.length){$scope.isAllNeighborsSelect||($scope.nbrList=[]);nbrList.forEach((function(nbr){$scope.selectedNodeCategory===nodeCategory.Site?"-1"!==nbr.nbrId&&$scope.nbrList.push(nbr):$scope.nbrList.push(nbr)}));$scope.nbrList=$scope.parentScope.dlgExtendNeighbor.unique($scope.nbrList)}}}()}}();!function(netBrain){angular.module("nb.qmap").controller("nb.qmap.nbStencilPanelCtrl",nbStencilPanelCtrl);nbStencilPanelCtrl.$inject=["$scope","$rootScope","$q","nb.ng.utilitySrvc","nb.ng.inputFileSrvc","nb.common.nbAlertSrvc","nb.qmap.StencilSrvc","nb.ng.fileHeadSrvc","nb.qmap.mapManagerSrvc"];function nbStencilPanelCtrl($scope,$rootScope,$q,UtilitySrvc,inputFileSrvc,nbAlertSrvc,StencilSrvc,FileHeadSrvc,mapManagerSrvc){$scope.showStencilPanel=!1;$scope.isTableSelected=!1;$scope.isAngularjsUpdating=function(){return $rootScope.$$phase||$scope.$$phase};$scope.graphicStyle=new GraphicStyle;$scope.textStyle=new DrawTextStyle;$scope.textboxStyle=new DrawTextboxStyle;var togglePanelWatcher=$rootScope.$on(viewFrameEvent.toggleTopPanel,(function(event,type){if("stencil"===type){netBrain.Map.StencilImgManager.synImgFromServer(StencilSrvc,(function(){$scope.showStencilPanel=!0;$scope.graphicStyle=new GraphicStyle;$scope.textStyle=new DrawTextStyle;$scope.textboxStyle=new DrawTextboxStyle;$scope.stencils=netBrain.Map.StencilImgManager.getAllImageInfo();event.stopPropagation()}));getAllCustomStencil()}}));function getAllCustomStencil(){return StencilSrvc.getAllCustomStencil().then((function(stencils){void 0!==stencils&&stencils.length>0&&stencils.forEach((function(stencil){stencil.imagePath=NetBrain.deviceIcon.getIconStreamURIById(stencil.ID+stencil.extension)}));$scope.customStencils=stencils;return $q.resolve()}))}$scope.setStyle=function(item){return{width:.2*item.width+"px",height:.2*item.height+"px"}};$scope.setActive=function(item,tableType){cancelSelected($scope.drawToolList);cancelSelected($scope.stencils);cancelSelected($scope.customStencils);if("table"===tableType)$scope.isTableSelected=!0;else{$scope.isTableSelected=!1;item.active=!0}};$scope.showContextMenu=function(item,index){$scope.customStencils[index].isDropdownOpen=!$scope.customStencils[index].isDropdownOpen};$scope.renameCustomIcon=function(item,index){$scope.customStencils[index].editable=!0};function resetName(element,index){element.value=$scope.customStencils[index].displayName;$scope.customStencils[index].editable=!1;return $q.resolve()}$scope.onEdited=function(item,index){return function(e){var newValue=e.target.value;if(hasDuplication(newValue,index))nbAlertSrvc.error("Upload Failed. At least one icon name exists.").then(resetName(e.target,index));else if(isInvalidName(newValue))alertInvalidCharacters().then(resetName(e.target,index));else if(isNameExceedsMaxLength(newValue))alertMaxLength().then(resetName(e.target,index));else{StencilSrvc.renameCustomStencil(item.ID,newValue).then(getAllCustomStencil);$scope.customStencils[index].editable=!1}}};function isInvalidName(name){return netBrain.NG.Const.valiteFileNameReg.test(name)}function isNameExceedsMaxLength(name){return name.length>32}function hasDuplication(name,index){var stencils=$scope.customStencils||[];index>=0&&(stencils=$scope.customStencils.filter((function(_item,i){return i!==index})));return stencils.map((function(item){return item.displayName})).indexOf(name)>=0}$scope.deleteCustomIcon=function(item){nbAlertSrvc.confirm("Are you sure you want to delete the selected item?").then((function(){StencilSrvc.deleteCustomStencil(item.ID).then(getAllCustomStencil)}))};$scope.AddCustomStencilToMap=function(item){var curPage=mapManagerSrvc.getActivePage();if(null!=curPage){curPage.getNetmapOperator().addOneStencil(item)}};$scope.drawToolList=[{name:"Note",imageSrc:"icon_nb_Text",action:function(item){$scope.OnDrawText(item);$scope.setActive(item)},active:!1},{name:"Text",imageSrc:"stencil-text",action:function(item){$scope.OnDrawTextbox(item);$scope.setActive(item)},active:!1},{name:"Rectangle",imageSrc:"icon_nb_Rectangle",action:function(item){$scope.OnDrawRectangle(item);$scope.setActive(item)},active:!1},{name:"Line",imageSrc:"icon_nb_Line",action:function(item){$scope.OnDrawLine(item);$scope.setActive(item)},active:!1},{name:"Ellipse",imageSrc:"icon_nb_Ellipse",action:function(item){$scope.OnDrawEllipse(item);$scope.setActive(item)},active:!1},{name:"Cloud",imageSrc:"icon_nb_Cloud",action:function(item){$scope.OnDrawCloud(item);$scope.setActive(item)},active:!1},{name:"Curve",imageSrc:"icon_nb_Curve",action:function(item){$scope.OnDrawCurve(item);$scope.setActive(item)},active:!1},{name:"Polygon",imageSrc:"icon_nb_Polygon",action:function(item){$scope.OnDrawPolygenArea(item);$scope.setActive(item)},active:!1},{name:"Closed Region",imageSrc:"icon_nb_ClosedRegion",action:function(item){$scope.OnDrawCloseArea(item);$scope.setActive(item)},active:!1},{name:"Define Path",imageSrc:"icon_nb_DefinePath",action:function(item){$scope.OnDrawPath(item);$scope.setActive(item)},active:!1}];$scope.setAllDrawingState=function(bState){for(var i=0;i<$scope.drawToolList.length;i++){var drawToolItem=$scope.drawToolList[i];null!=drawToolItem&&(drawToolItem.active=bState)}};$scope.setDrawingState=function(strDrawName,bState){var scopeState=!1;for(var i=0;i<$scope.drawToolList.length;i++){var drawToolItem=$scope.drawToolList[i];drawToolItem.name===strDrawName&&(drawToolItem.active=bState);drawToolItem.active&&(scopeState=!0)}var curPage=mapManagerSrvc.getActivePage();$scope.$emit("changeDrawingState",scopeState,curPage.getDocId())};$scope.OnDrawRectangle=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.graphicStyle);curPage.getCmdTarget().OnDrawRectangle(callBack)};$scope.OnDrawEllipse=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.graphicStyle);curPage.getCmdTarget().OnDrawEllipse(callBack)};$scope.OnDrawLine=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.graphicStyle);curPage.getCmdTarget().OnDrawLine(callBack)};$scope.OnDrawCloud=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.graphicStyle);curPage.getCmdTarget().OnDrawCloud(callBack)};$scope.OnDrawCurve=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.graphicStyle);curPage.getCmdTarget().OnDrawCurve(callBack)};$scope.OnDrawPolygenArea=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.graphicStyle);curPage.getCmdTarget().OnDrawPolygon(callBack)};$scope.OnDrawCloseArea=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.graphicStyle);curPage.getCmdTarget().OnDrawCloseArea(callBack)};$scope.OnDrawPath=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.graphicStyle);curPage.getCmdTarget().OnDrawPath(callBack)};$scope.OnDrawText=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.textStyle);curPage.getCmdTarget().OnDrawText(callBack)};$scope.OnDrawTextbox=function(item){var callBack=getDrawToolCallBackFun(item);$scope.setAllDrawingState(!1);$scope.setDrawingState(item.name,!0);var curPage=mapManagerSrvc.getActivePage();curPage.getCmdTarget().setGraphicStyle($scope.textboxStyle);curPage.getCmdTarget().OnDrawTextbox(callBack)};$rootScope.$on(NetBrain.Map.Event.ActiveStencilItem,(function(event,name){var drawTool=_.find($scope.drawToolList,(function(item){return item.name===name}));drawTool&&drawTool.action(drawTool)}));function getDrawToolCallBackFun(item){return function(){$scope.setDrawingState(item.name,!1);$scope.isAngularjsUpdating()||$scope.$digest();$rootScope.$emit(NetBrain.Map.Event.DeactiveStencilItem,item.name)}}$scope.tableSelOptions={tableSelClick:function(rowCount,columnCount){$scope.tableSelUiShow=!1;var curPage=mapManagerSrvc.getActivePage();if(null!=curPage){var netmapOperator=curPage.getNetmapOperator();null!=netmapOperator&&netmapOperator.addOneTable(rowCount,columnCount)}}};$scope.setStencilActive=function(item){$scope.isTableSelected=!1;cancelSelected($scope.stencils);cancelSelected($scope.customStencils);cancelSelected($scope.drawToolList);item.active=!0};$scope.onIconUpload=function(){inputFileSrvc.createInputFile({scope:$scope,fileAccept:".png",fileChange:"onIconsSelected",isMultiple:!0,maxFileCount:10,maxSize:1048576})};function alertInvalidCharacters(){return nbAlertSrvc.error("A file name can't contain any of the following characters:</br> "+netBrain.NG.Const.valiteFileNameRegTip)}function alertMaxLength(){return nbAlertSrvc.error("Upload Failed. Display name can't exceed 32 characters!")}$scope.onIconsSelected=function(files){var alert={hasAlert:!1};var payloads=[];for(var i=0;i<files.length;i++){var reader=new FileReader;reader.readAsDataURL(files[i]);reader.onload=getIconOnloadFunc(files,i,alert,payloads)}};function getIconOnloadFunc(files,index,alert,payloads){return function(event){var tmpImg=new Image;tmpImg.src=event.target.result;tmpImg.onload=function(){var file=files[index];if(!alert.hasAlert){var fileName=FileHeadSrvc.getFileNameWithoutExtension(file.name);if((img=tmpImg).width>=500||img.height>=500){nbAlertSrvc.error("Upload Failed. At least one icon dimensions exceeds 500x500 pixels.");alert.hasAlert=!0}else if(isInvalidName(fileName)){alertInvalidCharacters();alert.hasAlert=!0}else if(isNameExceedsMaxLength(fileName)){alertMaxLength();alert.hasAlert=!0}else if(hasDuplication(fileName))if(isNameExceedsMaxLength(fileName=UtilitySrvc.getUniqueName($scope.customStencils.map((function(item){return item.displayName})),fileName))){alertMaxLength();alert.hasAlert=!0}else pushFileUploadPayload(payloads,file,tmpImg,fileName);else pushFileUploadPayload(payloads,file,tmpImg);files.length===payloads.length&&StencilSrvc.addCustomStencil(payloads).then(getAllCustomStencil).then((function(){return function(payloads){var allNames=$scope.customStencils.map((function(item){return item.displayName}));payloads.forEach((function(newItem){var index=allNames.indexOf(newItem.displayName);var item=$scope.customStencils.splice(index,1)[0];$scope.customStencils.push(item)}));return $q.resolve()}(payloads)}))}var img}}}function pushFileUploadPayload(payloads,file,tmpImg,fileName){void 0===fileName&&(fileName=FileHeadSrvc.getFileNameWithoutExtension(file.name));payloads.push({displayName:fileName,extension:FileHeadSrvc.getFileExtensionName(file.name),width:tmpImg.width,height:tmpImg.height,image:tmpImg.src.replace("data:image/png;base64,","")})}function cancelSelected(list){angular.forEach(list,(function(obj){obj.active=!1}),null)}$scope.dragstart=function(scope,event){if(scope.item.filename&&"Link"===scope.item.filename)console.warn("dragstart in if code phase.");else{var stencilItem=jQuery.extend(!0,{},scope.item);stencilItem.actionType=NetBrain.Common.Const.ActionType.DrawStencilItem;var paramString=JSON.stringify(stencilItem);event.dataTransfer.setData("text",paramString)}};$scope.$on("$destroy",(function(){togglePanelWatcher()}))}}(NetBrain);!function(){angular.module("nb.qmap").controller("nb.qmap.shareFileURLPopupCtrl",ShareFileURLPopupCtrl);ShareFileURLPopupCtrl.$inject=["$timeout","$document","$rootScope","$scope","$uibModalInstance","$log","$sce","nb.admin.httpSystemAdminSrvc","nb.ng.userSrvc","initList","$filter","nb.qmap.httpMapSrvc","nb.common.nbAlertSrvc","nb.ng.httpAuthSrvc","nb.qmap.mapManagerSrvc"];function ShareFileURLPopupCtrl($timeout,$document,$rootScope,$scope,$uibModalInstance,$log,$sce,httpSystemAdminSrvc,userSrvc,initList,$filter,httpMapSrvc,nbAlertSrvc,httpAuthSrvc,mapManagerSrvc){$scope.isITEVersion=NetBrain.NG.ConfigSettings.IS_ITE_VERSION;$scope.placeholderText=$scope.isITEVersion?"Type in email.":"Select user or input email.";$scope.mapName="";$scope.imgobject="";$scope.localHref="";$scope.invalidUser=!1;$scope.imgobjectList=[];$scope.imgSizeList=[];$scope.imageShow=0;$scope.leftScroll=!1;$scope.rightScroll=!1;$scope.selectedList=[];$scope.selectedCCList=[];var body=angular.element(window.document.body);$("body").click((function(){$("#share_map_to_user_list").removeClass("open");$("#share_map_to_user_cc_list").removeClass("open")}));$scope.leftScrollClick=function($event){$event.stopPropagation();$scope.rightScroll=!0;$scope.imageShow>0&&($scope.imageShow-=1);$scope.imageShow<=0&&($scope.leftScroll=!1);$($event.target).blur()};$scope.rightScrollClick=function($event){$event.stopPropagation();$scope.leftScroll=!0;$scope.imageShow<$scope.imgobjectList.length-1&&($scope.imageShow+=1);$scope.imageShow>=$scope.imgobjectList.length-1&&($scope.rightScroll=!1);$timeout((function(){$($event.target).blur()}),0)};var mapIdArry=[];$scope.personList=[];$scope.renderHtml=function(htmlcode,size){if(htmlcode){var $img=angular.element(htmlcode);if(size&&!isNaN(size.width)){var isHeightAuto=size.width/size.height>2;var width=isHeightAuto?200:"auto";var height=isHeightAuto?"auto":100;$img.css({width:width,height:height})}htmlcode=$img.prop("outerHTML")}return $sce.trustAsHtml(htmlcode)};function getType(obj){return obj.getMapType&&_.isFunction(obj.getMapType)?obj.getMapType():obj.type||""}$scope.onShare=function(){var collaborationHistory=[];var haveExternalEmail=_.findIndex($scope.selectedList,(function(d){return""===d.id&&d.email}))>-1;var haveLocalUser=_.findIndex($scope.selectedList,(function(d){return""!==d.id}))>-1;var isAllExternalEmail=_.all($scope.selectedList,(function(d){return""===d.id&&d.email}));_.map($scope.selectedList,(function(d){return d.name}));if($scope.selectedList.length>0){var mapArray=[];if(initList instanceof Array)for(var i=0;i<initList.length;i++)mapArray.push({mapId:initList[i].id,mapName:initList[i].name,imageStr:$scope.imgobjectList[i],type:getType(initList[i])});else mapArray.push({mapId:initList.getDocId(),mapName:initList.getTitle(),imageStr:$scope.imgobjectList[0],type:getType(initList)});for(var j=0;j<$scope.selectedList.length;j++){var ccList=$scope.selectedCCList;var shareCollaboration={mapList:mapArray,message:$scope.textEmail,receiveUserId:null,receiveUserName:null,receiveUserEmail:null,filteType:NetBrain.Map.Const.CollaborationFilterType.Map,type:NetBrain.Map.Const.CollaborationType.Share,userID:userSrvc.getUserID(),userName:userSrvc.getUserName(),url:$scope.localHref,ccList:ccList};shareCollaboration.receiveUserId=$scope.selectedList[j].id;shareCollaboration.receiveUserName=$scope.selectedList[j].name;shareCollaboration.receiveUserEmail=$scope.selectedList[j].email;collaborationHistory.push(shareCollaboration)}}if(!(collaborationHistory.length>0)){$scope.invalidUser=!0;return nbAlertSrvc.warning("Please specify at least one email address to share the map.")}httpMapSrvc.shareFileToUsers(collaborationHistory).then((function(objs){if(objs>0){var userNameList=_.chain($scope.selectedList).filter((function(d){return""!==d.id})).map((function(d){return d.name})).value();var emailList=_.chain($scope.selectedList).filter((function(d){return""===d.id})).map((function(d){return d.email})).value();var str=_.reduce(userNameList,(function(r,c){return r+" and "+c}));var emailAndUserStr=_.chain(userNameList.concat(emailList)).reduce((function(r,c){return r+" and "+c})).value();var msg=StringUtil.format(NetBrain.Map.Message.ShareMapSuccess,{user:str});if(3===objs){var errorMsg="But failed to send email, please contact your NetBrain administrator to double check email setting.";if(!haveExternalEmail&&haveLocalUser)errorMsg="But failed to send email, please contact your NetBrain administrator to double check email setting.";else if(haveExternalEmail&&!haveLocalUser)errorMsg="Please contact your NetBrain administrator to double check email setting.";else if(haveExternalEmail&&haveLocalUser){msg=StringUtil.format(NetBrain.Map.Message.ShareMapSuccess,{user:str});errorMsg="But failed to send email, please contact your NetBrain administrator to double check email setting."}if(isAllExternalEmail){msg="You cant share the map because failed to send email address.";errorMsg="Please contact your NetBrain administrator to double check email setting."}nbAlertSrvc.warning(msg+"<br/>"+errorMsg)}else{msg=StringUtil.format(NetBrain.Map.Message.ShareMapSuccess,{user:emailAndUserStr});new MapTip({wrapper:"body"}).show({message:msg})}$uibModalInstance.close($scope)}else nbAlertSrvc.error("error!")}),(function(){$uibModalInstance.close($scope)}));return!0};$scope.onCancel=function(){$uibModalInstance.dismiss("Cancel Button Clicked!")};$scope.onTransfer=function(){$rootScope.$broadcast("openTransferEditRightDialog")};$scope.eventShareMapStopPropagation=function($event){$event.stopPropagation()};$scope.shareUserClick=function($event,person){selectUser(person);body.find("#inputShareEmail").focus();$event.stopPropagation()};$scope.shareCcUserClick=function($event,person){selectCcUser(person);body.find("#inputShareCCEmail").focus();$event.stopPropagation()};var textarea=angular.element("<textarea/>");textarea.css({position:"fixed",opacity:"0"});$scope.copyLinkToClipboard=function(link){textarea.val(link);body.append(textarea);textarea[0].select();try{document.execCommand("copy")?new MapTip({wrapper:"body"}).show({message:NetBrain.Map.Message.ShareMapCopyUrlSuccess}):nbAlertSrvc.error("Failed to copy the map link to clipboard. Please try to proceed with the latest version of Chrome, Safari or Firefox.")}catch(err){console.error("failed to copy",link)}textarea.remove()};$scope.isUserShow=function(person,searchText,shareUserStr){var searchResult=""===searchText.trim()||person.name.toLocaleLowerCase().indexOf(searchText)>=0||person.email&&person.email.toLocaleLowerCase().indexOf(searchText)>=0;if(!shareUserStr)return searchResult;var selectedUserNameList=shareUserStr.split(";");selectedUserNameList.length-=1;if(0===selectedUserNameList.length)return searchResult;var existSelected=_.some(selectedUserNameList,(function(ne){return ne.trim().toLowerCase()===person.name.trim().toLowerCase()||person.email&&ne.trim().toLowerCase()===person.email.trim().toLowerCase()}));return searchResult&&!existSelected};$timeout((function(){!function(){var href=/^http.*\//.exec(document.location.href)[0];var tenandId=httpAuthSrvc.getSelectedTenantId();var domainId=httpAuthSrvc.getSelectedDomainIds()[0];if(initList instanceof Array){for(var i=0;i<initList.length;i++)mapIdArry.push(initList[i].id);httpMapSrvc.getMapThumbnailsArray(mapIdArry).then((function(data){for(var j=0;j<data.length;j++){var img=mapManagerSrvc.checkRealImageFormat(data[j].docPngList[0].image);$scope.imgobjectList.push(img);$scope.imgSizeList.push(NgUtil.getValueFromObjAndPath(data[j],"docPngList.0.imageSize",{}))}data.length>1&&($scope.rightScroll=!0)}));$scope.mapName="";for(var k=0;k<initList.length;k++)initList[k].rba?$scope.localHref+=StringUtil.format(href+NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.MapRBA,{tenantId:tenandId,domainId:domainId,id:initList[k].id,rba:initList[k].rba})+"    \n":$scope.localHref+=StringUtil.format(href+NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.Map,{tenantId:tenandId,domainId:domainId,id:initList[k].id})+"    \n"}else{var rba=initList.getCurrentRunbook();var rbaId=initList.getCurrentRBA()||rba?rba._id:"";$scope.localHref=StringUtil.format(href+NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.Map,{tenantId:tenandId,domainId:domainId,id:initList.getDocId()});rbaId&&($scope.localHref=StringUtil.format(href+NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.MapRBA,{tenantId:tenandId,domainId:domainId,id:initList.getDocId(),rba:rbaId}));$scope.mapName=initList.getTitle();var activeNetMap=initList.getActiveNetmap();var activeIndex=0;activeNetMap&&(activeIndex=initList.getDocIndex(activeNetMap));httpMapSrvc.getMapThumbnails(initList.getDocId()).then((function(data){var index=_.findIndex(data.docPngList,{pageID:activeNetMap.getDocId()});if(index>=0){var img=data.docPngList[index].image;var imgHtmlStr=mapManagerSrvc.checkRealImageFormat(img);$scope.imgobjectList.push(imgHtmlStr);var imgSize=initList.getImageSizeList()[activeIndex];$scope.imgSizeList.push(imgSize);$scope.leftScroll=!1;$scope.rightScroll=!1}}))}$scope.isITEVersion||httpSystemAdminSrvc.getAllUsers().then((function(objList){httpSystemAdminSrvc.getAllDisplayUsersOnDomain().then((function(obAllUser){if(obAllUser&&_.isArray(obAllUser))for(var l=0;l<objList.length;l++)for(var m=0;m<obAllUser.length;m++)objList[l].ID===obAllUser[m].userId&&$scope.personList.push({id:objList[l].ID,name:objList[l].name,email:objList[l].email})}))}))}()}),100)}}(NetBrain);!function(netBrain){var consts=NetBrain.NetworkOS.Const;var nsName=consts.NS_NAME;angular.module("nb.qmap").controller("nb.qmap.browseTreeCtrl",BrowseTreeCtrl);BrowseTreeCtrl.$inject=["$scope","$uibModalInstance","$log","$parse","$q","$window","ivhTreeviewMgr","nb.ng.callbackSrvc","nb.ng.utilitySrvc","nb.ng.userSrvc",nsName+".utilsSrvc",nsName+".folderSrvc","settings","nb.common.nbAlertSrvc"];function BrowseTreeCtrl($scope,$uibModalInstance,$log,$parse,$q,$window,ivhTreeviewMgr,callbackSrvc,utilitySrvc,userSrvc,utilsSrvc,folderSrvc,settings,nbAlertSrvc){var scope=$scope;$scope.doc=settings.doc;var ctrl=scope.ctrl=this;ctrl.title=settings.title;ctrl.mapname=settings.doc.getTitle();var folderTypes=consts.FolderType;var includeFolderTypes=[folderTypes.PUBLIC,folderTypes.DESKTOP,folderTypes.PRIVATE];!function(){ctrl.options={selectedFolder:null,clickSelectedFolder:function(folder){ctrl.options.selectedFolder=folder},includeFolderTypes:includeFolderTypes,excludeFolders:settings.excludeFolders};!function(){ctrl.onOK=okHandler;ctrl.onCancel=cancelHandler}()}();function okHandler(){var folder=ctrl.options.selectedFolder;if(""!==ctrl.mapname.trim())if(ctrl.mapname.length>128)nbAlertSrvc.warnning("The length of a map name cannot exceed 128 characters!");else if(NetBrain.NG.Const.valiteFileNameReg.test(ctrl.mapname))nbAlertSrvc.warnning("A file name can't contain any of the following characters:</br> "+NetBrain.NG.Const.valiteFileNameRegTip);else{if(folder){name=ctrl.mapname,settings.doc.setTitle(name);$uibModalInstance.close(folder)}else nbAlertSrvc.warnning({message:"Please select a folder to save the map."});var name}else nbAlertSrvc.warnning({message:"Please enter a map name before saving it."})}function cancelHandler(event){event&&event.preventDefault();$uibModalInstance.dismiss("Cancel Button Clicked!")}}}();!function(){var scopeList={};angular.module("nb.qmap").controller("nb.qmap.mapPanelTabCtrl",mapPanelTabCtrl);mapPanelTabCtrl.$inject=["$scope","$rootScope","$element","$timeout","nb.ng.utilitySrvc","nb.ng.featureSrvc","$q","nb.dataview.dataViewPanelSrvc","nb.qmap.mapManagerSrvc"];function mapPanelTabCtrl($scope,$rootScope,$element,$timeout,utilitySrvc,featureSrvc,$q,dataViewPanelSrvc,mapManagerSrvc){$scope.dataModel={curTab:null,DataViewStatus:dataViewPanelSrvc.Const.DataViewStatus};var panelStatus,tabStatus,tabs,scope=$scope;if(scope.netmap.extAction&&scope.netmap.extAction.defaultSelectedDataViewGroupId)scope.defaultSelectedDataViewGroupId=scope.netmap.extAction.defaultSelectedDataViewGroupId;else if(NetBrain.Map.MapArgs){scope.defaultSelectedDataViewGroupId=NetBrain.Map.MapArgs.defaultSelectedDataViewGroupId;scope.defaultSelectedDataViewTemplateId=NetBrain.Map.MapArgs.defaultSelectedDataViewTemplateId}scope.defaultSelectedDataViewGroupId||(scope.defaultSelectedDataViewGroupId=utilitySrvc.getQueryString("dsdvg"));scope.defaultSelectedDataViewTemplateId||(scope.defaultSelectedDataViewTemplateId=utilitySrvc.getQueryString("dsdvt"));!function(){mapManagerSrvc.resizablePaneSharedWidth($element.find(".tab-body>.tab-contents"),$scope);scopeList[scope.$id]||(scopeList[scope.$id]=scope);panelStatus=scope.panelStatus={null:0,max:1,min:2};scope.currentPanelStatus=panelStatus.null;tabStatus=scope.tabStatus={null:0,show:1,hide:2};tabs=scope.tabs=function(){var tabConfig={};tabConfig["Data View"]={key:"Data View",status:tabStatus.show,class:"action-node-dynamic-dataview-16",hoverClass:"action-node-dynamic-dataview-16"};featureSrvc.isFeatureValid(NetBrain.NG.Const.nbFeatures.Runbook.name)&&(tabConfig.Runbook={key:"Runbook",status:tabStatus.hide,class:"icon-nb-runbook-16",hoverClass:"icon-nb-runbook-16"});return tabConfig}();scope.isMaxPanel=isMaxPanel;!function(){if(utilitySrvc.getQueryString("rba")){if("true"===utilitySrvc.getQueryString("createRunbook"))initSelectDefaultDataview(scope,$timeout).then((function(){$timeout((function(){$rootScope.newRBA=null;onOpenMapTab(null,"runbook")}))}));else{(scope.defaultSelectedDataViewGroupId||scope.defaultSelectedDataViewTemplateId)&&initSelectDefaultDataview(scope,$timeout).then((function(){}));toggleTabHandler("Runbook")}}else if($rootScope.newRBA||null!=NetBrain.Map.MapArgs.rba)initSelectDefaultDataview(scope,$timeout).then((function(){$timeout((function(){$rootScope.newRBA=null;onOpenMapTab(null,"runbook")}))}));else if(scope.defaultSelectedDataViewGroupId||scope.defaultSelectedDataViewTemplateId){var dataViewTab=scope.tabs["Data View"];scope.initSelected=!0;$timeout((function(){onOpenMapTab(null,dataViewTab.key)}))}}();scope.$on("$destroy",$rootScope.$on(MapTabEvent.OPEN_FROM_OUTSIDE,onOpenMapTab));scope.$on("$destroy",$rootScope.$on(MapTabEvent.Min_TAB_OUTSIDE,minPanelHandler));scope.$on("$destroy",$rootScope.$on(MapTabEvent.Max_TAB_OUTSIDE,maxPanelHandler));scope.$on("$destroy",$rootScope.$on(NetBrain.Map.Event.ActivePageChanged,handleTabHighlight));scope.$on("$destroy",(function(){delete scopeList[scope.$id]}));scope.hasRBAs=$rootScope.mapHasRBAs}();!function(){scope.toggleTab=toggleTabHandler;scope.minPanel=minPanelHandler;scope.maxPanel=maxPanelHandler}();$scope.onToggleTab=function(){var dm=$scope.dataModel;scope.currentTab&&(dm.curTab=scope.currentTab);toggleTabHandler(dm.curTab&&dm.curTab.key||"Data View")};$scope.onOpenTab=function(key){scope.currentTab&&scope.currentTab.key===key?hideOtherTabs():openTab(key)};function handleTabHighlight(){if(scope.currentTab);else{var curTab;_.each(scopeList,(function(_scope){_scope.currentTab&&(curTab=_scope.currentTab)}));if(curTab){scope.currentTab=curTab;maxPanelHandler(!1)}}}function isMaxPanel(){return!_.isEmpty(scope.currentTab)}function minPanelHandler(){scope.currentTab&&"Runbook"===scope.currentTab.key&&NetBrain.Map.currentActiveMap.setRBAOpend(!1);var dm=$scope.dataModel;scope.currentTab&&(dm.curTab=nbPLM.Common.clone(scope.currentTab));scope.currentTab&&emitTabEvent({key:scope.currentTab.key},MapTabEvent.MIN_PANEL);scope.currentPanelStatus=panelStatus.min;_.each(scopeList,(function(_scope){_scope.hideMapPanelTab();_scope.currentTab=null}))}function maxPanelHandler(showOnly){var dm=scope.dataModel;angular.isUndefined(showOnly)&&(showOnly=!0);scope.currentPanelStatus=panelStatus.max;scope.currentTab?dm.curTab=scope.currentTab:scope.currentTab=dm.curTab||{key:"Data View"};emitTabEvent({key:scope.currentTab.key,showOnly:showOnly},MapTabEvent.MAX_PANEL);_.each(scopeList,(function(_scope){_scope.showMapPanelTab()}));$rootScope.$broadcast(MapLayoutEvent.CLOSE_MAP_LAYOUT)}function toggleTabHandler(key){if(scope.currentTab&&scope.currentTab.key===key){hideOtherTabs();minPanelHandler()}else openTab(key)}function openTab(key){if("Runbook"!==key||featureSrvc.isFeatureValid(NetBrain.NG.Const.nbFeatures.Runbook.name)){hideOtherTabs();var tab=tabs[key];var needInitial=!1;tab.status=tabStatus.show;if(!tab.isOpend){needInitial=!0;tab.isOpend=!0}!function(tab){_.each(scopeList,(function(_scope){_scope.currentTab=tab}))}(tab);maxPanelHandler(!needInitial)}}function hideOtherTabs(){tabs["Data View"]&&(tabs["Data View"].status=tabStatus.hide);tabs.Runbook&&(tabs.Runbook.status=tabStatus.hide);tabs["Instant Qapp"]&&(tabs["Instant Qapp"].status=tabStatus.hide);var tabEntries=_.pairs(tabs);for(var tab in tabEntries)tab.hasOwnProperty("status")&&(tab.status=tabStatus.hide)}function emitTabEvent(options,eventName){$rootScope.$emit(eventName,options)}function initSelectDefaultDataview(scope,timeout){var deferred=$q.defer();scope.defaultSelectedDataViewGroupId||scope.defaultSelectedDataViewTemplateId?timeout((function(){scope.initSelected=!0;$rootScope.$emit(MapTabEvent.Init_Select_Default_DataView,{key:"Data View",defaultSelectedDataViewGroupId:scope.defaultSelectedDataViewGroupId,defaultSelectedDataViewTemplateId:scope.defaultSelectedDataViewTemplateId});deferred.resolve()})):deferred.resolve();return deferred.promise}function onOpenMapTab(event,key){var lk=key.toString().toLowerCase();if(scope.currentTab&&scope.currentTab.key.toLowerCase()===lk&&scope.currentTab.status===tabStatus.show){if(scope.currentPanelStatus!==panelStatus.max){scope.currentPanelStatus=panelStatus.max;maxPanelHandler(!0)}}else"runbook"===lk?openTab("Runbook"):"Action"===lk?openTab("Action"):"data view"===lk?openTab("Data View"):"instant qapp"===lk&&openTab("Instant Qapp")}if(scope.nbQappInstanceOption&&scope.nbQappInstanceOption.fnMap){var mapPageId=$scope.mapPageObj.getDocId();scope.nbQappInstanceOption.fnMap[mapPageId]=isMaxPanel}scope.$on("$destroy",(function(){if(scope.nbQappInstanceOption&&scope.nbQappInstanceOption.fnMap)try{var mapPageId=$scope.mapPageObj.getDocId();scope.nbQappInstanceOption.fnMap[mapPageId]=void 0}catch(ex){scope.nbQappInstanceOption.fnMap={}}}))}}();var GlobalContext=function(globalContext){null==globalContext&&(globalContext={});globalContext.DragLayerName="DragLayer";globalContext.DeviceLayerName="DeviceLayer";globalContext.DeviceNoteLayerName="DeviceNoteLayer";globalContext.LinkLayerName="LinkLayer";globalContext.NormalShapObjName="NormalShapeObjLayer";globalContext.NormalShapBelowObjName="NormalShapeBelowObjLayer";return globalContext}(GlobalContext);!function(netBrain){angular.module("nb.qmap").directive("nbGoDiagramDirective",["$timeout","$window","$log","nb.ng.utilitySrvc","nb.ng.callbackSrvc","nb.topo.editTopoManager","nb.qmap.updateMapSrvc",function($timeout,$window,$log,utilitySrvc,callbackSrvc,editTopoManager,updateMapSrvc){return{restrict:"E",template:'<div ng-style="netmapDiagramStyle" class="goDiagramFrame" nb-context-menu-directive data-target="{{mapPageObj.getDocId()+\'-contextMenu\'}}" nb-variable-droppable></div>',replace:!0,scope:!1,link:function(scope,element,attrs){scope.$on("$destroy",(function(){jQuery("body").off("click",scope.bodyClickInDiagram);scope.diagram.removeDiagramListener("InitialLayoutCompleted",scope.listenInitialLayoutCompleted);scope.diagram.removeDiagramListener("ObjectContextClicked",scope.listenObjectContextClicked);scope.diagram.removeDiagramListener("BackgroundContextClicked",scope.listenBackgroundContextClicked);scope.diagram.removeDiagramListener("SelectionMoved",scope.listenSelectionMoved);scope.diagram.removeDiagramListener("LayoutCompleted",scope.listenLayoutCompleted);scope.diagram.removeDiagramListener("ViewportBoundsChanged",scope.listenViewportBoundsChanged);scope.diagram.removeDiagramListener("DocumentBoundsChanged",scope.listenDocumentBoundsChanged);scope.diagram.removeModelChangedListener(scope.listenModelChangedListener);scope.diagram.removeChangedListener(scope.listenDiagramChangedListener);scope.diagram.removeDiagramListener("AnimationFinished",scope.listenAnimationFinished);scope.diagram.removeDiagramListener("SelectionDeleted",scope.listenSelectionDeleted);scope.diagram.removeDiagramListener("ClipboardPasted",scope.listenClipboardPasted);scope.diagram.removeDiagramListener("ChangedSelection",scope.listenChangedSelection);scope.diagram.removeDiagramListener("BackgroundSingleClicked",scope.listenBackgroundSingleClicked);scope.diagram.removeDiagramListener("TextEdited",scope.listenTextEdited);scope.diagram.toolManager.actionTool=null;scope.diagram.toolManager.relinkingTool=null;scope.diagram.toolManager.linkReshapingTool=null;scope.diagram.toolManager.resizingTool=null;scope.diagram.toolManager.rotatingTool=null;scope.diagram.toolManager.linkingTool=null;scope.diagram.toolManager.draggingTool=null;scope.diagram.toolManager.dragSelectingTool=null;scope.diagram.toolManager.panningTool=null;scope.diagram.toolManager.contextMenuTool=null;scope.diagram.toolManager.textEditingTool=null;scope.diagram.toolManager.clickCreatingTool=null;scope.diagram.toolManager.clickSelectingTool=null;scope.diagram.mouseOver=null;scope.diagram.skipsUndoManager=!0;scope.diagram.startTransaction("clearDia");var len=scope.diagram.model.nodeDataArray.length;for(var i=len-1;i>=0;i--)scope.diagram.model.removeNodeData(scope.diagram.model.nodeDataArray[i]);for(var j=(len=scope.diagram.model.linkDataArray.length)-1;j>=0;j--)scope.diagram.model.removeLinkData(scope.diagram.model.linkDataArray[j]);var it=scope.diagram.parts.iterator;scope.diagram.removeParts(it,!1);it=null;it=scope.diagram.layers.iterator;var array=[];for(;it.next();){var item=it.value;array.push(item)}for(var k=0;k<array.length;k++){var item1=array[k];scope.diagram.removeLayer(item1)}it=null;it=scope.diagram.linkTemplateMap.iterator;array=[];for(;it.next();)array.push(it.key);for(var m=array.length-1;m>=0;m--)scope.diagram.linkTemplateMap.remove(array[m]);it=null;it=scope.diagram.nodeTemplateMap.iterator;array=[];for(;it.next();)array.push(it.key);for(var n=array.length-1;n>=0;n--)scope.diagram.nodeTemplateMap.remove(array[n]);it=null;scope.diagram.commitTransaction("clearDia");scope.diagram.animationManager.stopAnimation();scope.diagram.animationManager.isEnabled=!1;array=[];array=null;element.children()[0]._diagram=null;element.children()[1]._diagram=null;element.children().remove();scope.diagram.model.clear();scope.diagram.model.linkDataArray=[];scope.diagram.model.nodeDataArray=[];scope.diagram.clearSelection();scope.diagram.clearHighlighteds();scope.diagram.clear();scope.diagram.div._diagram=null;scope.diagram.div=null;try{if("1.6.24"===go.version)if(scope.diagram.animationManager._objectsToAnimate){scope.diagram.animationManager._objectsToAnimate._dict=null;scope.diagram.animationManager._objectsToAnimate=null}else{scope.diagram.QA.fm.gd=null;scope.diagram.QA.fm=null}if("1.6.9"===go.version)if(scope.diagram.animationManager._objectsToAnimate){scope.diagram.animationManager._objectsToAnimate._dict=null;scope.diagram.animationManager._objectsToAnimate=null}else{scope.diagram.nB.Uk.ld=null;scope.diagram.nB.Uk=null}}catch(e){console.log("Go.js has been recompiled, so there will be an error. Please debug again to get the name of the _objectsToAnimate object in the new go.js distribution.")}scope.diagram.currentTool=null;scope.diagram=null}));scope.updateMapSrvc=updateMapSrvc;scope.onResizeGoJS=function(option){element.css({height:"100%",width:"100%"})};scope.onResizeGoJS();angular.element($window).bind("resize",(function(){scope.onResizeGoJS()}));scope.onUpdateView=function(option){void 0!==scope.diagram&&scope.diagram.requestUpdate()};callbackSrvc.registerCallback("nbGoDiagramDirective.onUpdateView",scope.onUpdateView);scope.netmapDiagramStyle={"background-color":"#FFFFFF",width:"100%"};scope.origscale=1;scope.oldscale=1;var $=go.GraphObject.make;var noteHight;go.GraphObject.defineBuilder("PanelExpanderButton",(function(){return $("Button",{"ButtonBorder.stroke":"black","ButtonBorder.strokeWidth":1,"ButtonBorder.figure":"Rectangle","ButtonBorder.desiredSize":new go.Size(12,12),"ButtonBorder.fill":"transparent",click:function(e,s){var el=s.part.findObject("noteContent");if(null!==el){var triangleObj=s.findObject("TRIANGLE");var note=s.part.findObject("Body");s.diagram.startTransaction("Collapse/Expand Panel");el.visible=!el.visible;var bottom=s.part.findObject("noteBottom");bottom.visible=!bottom.visible;if(el.visible){note.height=noteHight||160;triangleObj.figure="LineH";s.part.data.isExpand=!0;s.part.resizable=!0}else{noteHight=note.height;note.height=30;triangleObj.figure="PlusLine";s.part.data.isExpand=!1;s.part.resizable=!1}s.diagram.commitTransaction("Collapse/Expand Panel")}}},$(go.Shape,{desiredSize:new go.Size(6,6),scale:1,name:"TRIANGLE",figure:"LineH"},new go.Binding("figure","isExpand",(function(isExpand){return isExpand?"LineH":"PlusLine"}))))}));go.GraphObject.defineBuilder("tableExpanderButton",(function(){return $("Button",{"ButtonBorder.stroke":null,"ButtonBorder.fill":"transparent",click:function(e,s){}},$(go.Shape,"TriangleUp",{desiredSize:new go.Size(6,4)},new go.Binding("figure","visible",(function(vis){return vis?"TriangleUp":"TriangleDown"}))))}));!function(){scope.diagram=$(go.Diagram,element[0],{initialContentAlignment:go.Spot.Center,padding:new go.Margin(50,100,50,100),autoScrollRegion:new go.Margin(50,100,50,100),initialDocumentSpot:go.Spot.TopLeft,initialViewportSpot:go.Spot.TopLeft,contentAlignment:go.Spot.Default,"layout.isInitial":!1,"layout.isOngoing":!1,"layout.isValidLayout":!0,"undoManager.isEnabled":!1,commandHandler:$(netBrain.Map.CustomizedCommandHandler,{moveSelectionNodesCallback:function(moveNodes){var netmap=scope.netmapOperator.getNetMap();if(netmap.isL2MapStyle()&&_.isArray(moveNodes)){var portInfos=netBrain.Map.L2PortsLayoutTool.getPortsInfoByDragNodes(moveNodes);portInfos.length>0&&netmap.layoutL2Ports(portInfos)}netmap.refreshMapViewOptionVisible()},getAlignNodeBounds:function(node){var bounds;if(scope.mapPageObj.isL2MapStyle()&&node instanceof netBrain.Map.CompL2Device)bounds=node.actualBounds;else{var obj=node.locationObject;var tl=obj.getDocumentPoint(go.Spot.TopLeft);var br=obj.getDocumentPoint(go.Spot.BottomRight);bounds=new go.Rect(tl.x,tl.y,br.x-tl.x,br.y-tl.y)}return bounds}}),"toolManager.hoverDelay":600,"toolManager.clickSelectingTool":$(netBrain.Map.CustomizeClickSelectingTool,{selectOtherSameTypeNodes:function(part){scope.netmapOperator.selectOtherSameTypeNodes(part)}}),"toolManager.draggingTool":new netBrain.Map.CustomizedDraggingTool(scope),"toolManager.mouseWheelBehavior":go.ToolManager.WheelZoom,"toolManager.textEditingTool":new netBrain.Map.CustomizeTextEditingTool(scope),"toolManager.panningTool":new netBrain.Map.CustomizePanningTool(scope),"toolManager.linkReshapingTool":new netBrain.Map.CustomizeLinkReshapingTool,"toolManager.dragSelectingTool":new netBrain.Map.CustomizeDragSelectingTool,rotatingTool:$(netBrain.Map.TopRotatingTool),nodeSelectionAdornmentTemplate:NormalSelectAdormenTemplate.getNodeTemplate(),hasHorizontalScrollbar:!1,hasVerticalScrollbar:!1,allowHorizontalScroll:!0,allowVerticalScroll:!0});var diagram=scope.diagram;!function(element,diagram,angular){angular.element(element).parent().resize((function(){requestUpdateMapDebounce()}));var requestUpdateMapDebounce=_.debounce((function(){diagram.requestUpdate()}),280)}(element[0],diagram,angular);!1;scope.mapPageObj.addL2StyleProperty(diagram);scope.bodyClickInDiagram=function(e){var $target=jQuery(e.target);0===jQuery(element[0]).find($target).length&&0===jQuery(".noteEditor").find($target).length&&null!=diagram.toolManager.textEditingTool&&diagram.toolManager.textEditingTool.acceptText(go.TextEditingTool.MouseDown)};jQuery("body").on("click",scope.bodyClickInDiagram);var layerObj=diagram.findLayer("Adornment");diagram.addLayerBefore($(go.Layer,{name:GlobalContext.DragLayerName}),layerObj);layerObj=diagram.findLayer(GlobalContext.DragLayerName);diagram.addLayerBefore($(go.Layer,{name:GlobalContext.DeviceLayerName}),layerObj);layerObj=diagram.findLayer(GlobalContext.DeviceLayerName);diagram.addLayerBefore($(go.Layer,{name:GlobalContext.DeviceNoteLayerName}),layerObj);layerObj=diagram.findLayer(GlobalContext.DeviceNoteLayerName);diagram.addLayerBefore($(go.Layer,{name:GlobalContext.LinkLayerName}),layerObj);layerObj=diagram.findLayer(GlobalContext.LinkLayerName);diagram.addLayerBefore($(go.Layer,{name:GlobalContext.NormalShapObjName}),layerObj);layerObj=diagram.findLayer(GlobalContext.NormalShapObjName);diagram.addLayerBefore($(go.Layer,{name:GlobalContext.NormalShapBelowObjName}),layerObj);var overviewsite=scope.mapPageObj.getTopologyType()===netBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite||scope.mapPageObj.getTopologyType()===netBrain.Map.Const.NetmapTopoLogy.overViewTopologySite;var isL2Style=scope.mapPageObj.isL2MapStyle();var mapTemplateProvider=netBrain.Map.mapTemplateProvider(diagram,scope,overviewsite,isL2Style);diagram.linkTemplateMap=mapTemplateProvider.linkTemplateMap();diagram.nodeTemplateMap=mapTemplateProvider.nodeTemplateMap();diagram.groupTemplateMap=mapTemplateProvider.groupTemplateMap();var geoReshapingTool=new netBrain.Map.GeometryReshapingTool;geoReshapingTool.reshapeObjectName=netBrain.Map.DrawShapeCommonAttr.ObjName;diagram.toolManager.mouseDownTools.insertAt(3,geoReshapingTool);diagram.toolManager.mouseMoveTools.insertAt(0,new netBrain.Map.PortShiftingTool);scope.listenInitialLayoutCompleted=function(){scope.initialLayoutCompleted(diagram)};diagram.addDiagramListener("InitialLayoutCompleted",scope.listenInitialLayoutCompleted);scope.listenObjectContextClicked=function(event){scope.ObjectContextClicked(event)};diagram.addDiagramListener("ObjectContextClicked",scope.listenObjectContextClicked);scope.listenBackgroundContextClicked=function(event){scope.BackgroundContextClicked(event)};diagram.addDiagramListener("BackgroundContextClicked",scope.listenBackgroundContextClicked);scope.listenSelectionMoved=function(event){scope.selectionMoved(event)};diagram.addDiagramListener("SelectionMoved",scope.listenSelectionMoved);scope.listenLayoutCompleted=function(s){scope.layOutCompleted(diagram);if(scope.mapPageObj.getTopologyType()===netBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite){var rootSite=_.findWhere(diagram.model.nodeDataArray,{siteCategory:0});if(rootSite){var rootNode=diagram.findNodeForKey(rootSite.key);diagram.centerRect(rootNode.actualBounds)}}};diagram.addDiagramListener("LayoutCompleted",scope.listenLayoutCompleted);scope.listenViewportBoundsChanged=function(e){scope.viewPortBoundsChanged(diagram,e);if(null!=scope.netmapOperator){var diagramPathManager=scope.netmapOperator.getDiagramPathManager();null!=diagramPathManager&&diagramPathManager.onViewportBoundsChanged(e)}};diagram.addDiagramListener("ViewportBoundsChanged",scope.listenViewportBoundsChanged);scope.listenDocumentBoundsChanged=function(e){if(null!=scope.netmapOperator){var pathTip=scope.netmapOperator.getPathTip();null!=pathTip&&pathTip.hideTip();scope.netmapOperator.refreshHighlightBgFromCache()}};diagram.addDiagramListener("DocumentBoundsChanged",scope.listenDocumentBoundsChanged);scope.listenModelChangedListener=function(changeEvent){scope.onDiagramModelChanged(changeEvent);scope.onModelDataArrayChanged(changeEvent)};diagram.model.addChangedListener(scope.listenModelChangedListener);scope.listenDiagramChangedListener=function(changeEvent){scope.onDiagramModelChanged(changeEvent);if(null!=scope.netmapOperator){var diagramPathManager=scope.netmapOperator.getDiagramPathManager();null!=diagramPathManager&&diagramPathManager.onDiagramChanged(changeEvent)}};diagram.addChangedListener(scope.listenDiagramChangedListener);scope.listenAnimationFinished=function(event){scope.onAnimationFinished(event)};diagram.addDiagramListener("AnimationFinished",scope.listenAnimationFinished);diagram.mouseOver=scope.OnMouseOver;scope.initCtrl();scope.listenSelectionDeleted=function(e){if(null!=scope.netmapOperator){scope.netmapOperator.onSelectionDeleted(e);scope.netmapOperator.getNetMap().refreshMapViewOptionVisible();scope.notifyHighlightChanged()}scope.isEditMode()};diagram.addDiagramListener("SelectionDeleted",scope.listenSelectionDeleted);scope.listenClipboardPasted=function(e){null!=scope.netmapOperator&&scope.netmapOperator.onClipboardPasted(e)};diagram.addDiagramListener("ClipboardPasted",scope.listenClipboardPasted);scope.listenChangedSelection=function(e){scope.ChangedSelection(e);if(null!=scope.netmapOperator){var diagramPathManager=scope.netmapOperator.getDiagramPathManager();null!=diagramPathManager&&diagramPathManager.onChangedSelection(e)}};diagram.addDiagramListener("ChangedSelection",scope.listenChangedSelection);scope.listenBackgroundSingleClicked=function(e){if(scope.mapPageObj.getTopologyType()===netBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite&&!scope.overViewHierarchicalSiteFirstClick){scope.overViewHierarchicalSiteFirstClick=!0;diagram.isModified=!1}scope.bgSingleClicked(e);$timeout((function(){if(null!=scope.netmapOperator){var diagramPathManager=scope.netmapOperator.getDiagramPathManager();null!=diagramPathManager&&diagramPathManager.onBackgroundSingleClicked(e)}}))};diagram.addDiagramListener("BackgroundSingleClicked",scope.listenBackgroundSingleClicked);scope.listenTextEdited=function(e){scope.onTextEdited(e)};diagram.addDiagramListener("TextEdited",scope.listenTextEdited);!function(){if(!0===window.isInIframe){scope.diagram.allowDelete=!1;scope.diagram.allowTextEdit=!1}}()}()}}}])}(NetBrain);NetBrain,angular.module("nb.qmap").directive("nbMapDirective",[function(){return{restrict:"A",templateUrl:"modules/nbQmap/views/nbMapDirective.html",link:function(scope,el,attrs){scope.contentBaseId=attrs.tabsBaseId}}}]).directive("nbMapPageDirective",[function(){return{restrict:"A",link:function(scope,iElement){scope.self=iElement}}}]);function _typeof2(obj){return(_typeof2="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}!function(){var Quill=window.Quill;angular.module("nb.qmap").directive("nbSelectUserDirective",["$q","$log","$document","$rootScope","$uibModal","$timeout","nb.qmap.mapManagerSrvc","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.admin.httpSystemAdminSrvc","nb.collaboration.collaborationGridSrvc","nb.admin.domainAdminMgr",function($q,$log,$document,$rootScope,$uibModal,$timeout,mapManagerSrvc,userSrvc,nbAlertSrvc,httpMapSrvc,httpSystemAdminSrvc,collaborationGridSrvc,domainAdminMgr){return{restrict:"AE",templateUrl:"modules/nbQmap/views/nbSelectUserDirective.html",scope:{selectedList:"=",initList:"=",editorStatus:"=",editorState:"=",placeholder:"@"},link:function(scope,element,attrs){scope.richcontent="";scope.dropDownOpenFlag=!1;scope.searchObj={searchText:""};scope.quillObj={mentionCharPos:-1,currentCursorPos:0};scope.selectedIndex=0;scope.mentionPos=-1;scope.currentSelectedList=[];scope.editor=null;scope.originalList=scope.initList||[];scope.selectableList=getCopieOriginalList();scope.$watch("editorStatus",(function(o,n){scope.editor?scope.editor.enable(o):$timeout((function(){scope.editor.enable(o)}))}));scope.toggleBubbleDropDown=function(){scope.recalcSelectableList()};scope.eventStopPropagation=function(event){event.stopPropagation()};scope.hideDropDown=function(){scope.dropDownOpenFlag=!1;digest()};scope.showDropDown=function(){scope.dropDownOpenFlag=!0;digest()};function getCopieOriginalList(){var list=angular.copy(scope.originalList);return _.filter(list,(function(m){return!!m.id&&!(!m.name&&!m.email)}))}function changeSelect(isScrollTop){if(0!==scope.selectedIndex){!function(){_.each(scope.currentSelectedList,(function(p){$(p).removeClass("selected")}));scope.currentSelectedList=[]}();!function(ele){ele.addClass("selected");scope.currentSelectedList.push(ele)}($(".select-user-dropdown ul li:nth-child("+scope.selectedIndex+")"));$(".select-user-dropdown ul li:nth-child("+scope.selectedIndex+")")[0].scrollIntoViewIfNeeded(isScrollTop)}}scope.recalcSelectableList=function(){var richText=scope.editor.getContents();var selectedIdList=[];scope.selectedList.length=0;richText&&richText.ops&&_.each(richText.ops,(function(d){if(d.insert&&d.insert.mention&&(d.insert.mention.id||d.insert.mention.name)){selectedIdList.push(d.insert.mention.id);scope.selectedList.push({id:d.insert.mention.id,name:d.insert.mention.name,email:d.insert.mention.email})}}));var list=getCopieOriginalList();var searchText=scope.searchObj.searchText;scope.selectableList=_.filter(list,(function(d){return searchText?_.indexOf(selectedIdList,d.id)<0&&function(user,searchText){if(!searchText)return!0;var s=searchText.toLocaleLowerCase();if(user.name&&user.name.toLocaleLowerCase().indexOf(s)>-1)return!0;if(user.email&&user.email.toLocaleLowerCase().indexOf(s)>-1)return!0;return!1}(d,searchText):_.indexOf(selectedIdList,d.id)<0}));scope.selectableList.length>0&&searchText&&scope.showDropDown();digest()};function isComplateMatch(user,searchText){if(!searchText)return!0;var s=searchText.toLocaleLowerCase();return!(!user.name||user.name.toLocaleLowerCase()!==s)||!(!user.email||user.email.toLocaleLowerCase()!==s)}function digest(){$timeout((function(){}))}function selectUser(person){if(scope.quillObj.mentionCharPos>=0){scope.editor.deleteText(scope.quillObj.mentionCharPos,scope.quillObj.currentCursorPos-scope.quillObj.mentionCharPos,Quill.sources.API);scope.quillObj.currentCursorPos=scope.quillObj.mentionCharPos+1;scope.quillObj.mentionCharPos=-1}insertData(scope.quillObj.currentCursorPos,person);scope.currentSelectedList.push(person);removeFromSelectableList(person);scope.searchObj.searchText="";digest()}function removeFromSelectableList(person){scope.recalcSelectableList();scope.selectableList=_.filter(scope.selectableList,(function(d){return d.id!==person.id}))}function keyboardSupport(e){if($(getEditorElement()).parent().hasClass("open")){var filterList=scope.selectableList;var l=filterList.length;switch(e.keyCode){case 38:if(l>0){0===scope.selectedIndex||1===scope.selectedIndex?scope.selectedIndex=l:scope.selectedIndex--;changeSelect(!0)}break;case 40:if(l>0){scope.selectedIndex===l?scope.selectedIndex=1:scope.selectedIndex++;changeSelect(!1)}break;case 13:if(scope.selectedIndex>0){var p=filterList.splice(scope.selectedIndex-1,1)[0];$(getEditorElement()).parent().hasClass("open")&&p&&selectUser(p);scope.selectedIndex=0}}}}scope.selectDataClick=function($event,data){selectUser(data);$(getEditorElement()).focus();$event.stopPropagation()};function insertData(index,user,sourceType){sourceType||(sourceType=Quill.sources.API);user&&user.name&&function(data,sourceType){sourceType||(sourceType=Quill.sources.API);var quill=scope.editor;var range=quill.selection.savedRange;if(!range||0!=range.length)return;var position=range.index;quill.insertEmbed(position,"mention",data,sourceType);quill.clipboard.dangerouslyPasteHTML(position+1,"&nbsp;");quill.setSelection(position+2,sourceType);scope.quillObj.currentCursorPos=position+2}({name:user.name,id:user.id,email:user.email},sourceType)}function getEditorElement(){return element[0].getElementsByClassName("editor")[0]}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(obj){return _typeof2(obj)}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof2(obj)})(obj)}function _classCallCheck(instance,Constructor){if(!(left=instance,right=Constructor,null!=right&&"undefined"!=typeof Symbol&&right[Symbol.hasInstance]?right[Symbol.hasInstance](left):left instanceof right))throw new TypeError("Cannot call a class as a function");var left,right}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;"value"in descriptor&&(descriptor.writable=!0);Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){protoProps&&_defineProperties(Constructor.prototype,protoProps);staticProps&&_defineProperties(Constructor,staticProps);return Constructor}function _possibleConstructorReturn(self,call){return!call||"object"!==_typeof(call)&&"function"!=typeof call?function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self):call}function _get(target,property,receiver){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=function(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=_getPrototypeOf(object)););return object}(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(receiver):desc.value}})(target,property,receiver||target)}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function(o,p){o.__proto__=p;return o})(o,p)}Mention=function(){function Mention(quill,options){_classCallCheck(this,Mention);this.isOpen=!1;this.itemIndex=0;this.mentionCharPos=null;this.cursorPos=null;this.values=[];this.quill=quill;this.options={source:null,renderItem:function(item,searchTerm){return"".concat(item.value)},mentionDenotationChars:["@"],allowedChars:/^[a-zA-Z0-9_]*$/,minChars:0,maxChars:31,offsetTop:2,offsetLeft:0};Object.assign(this.options,options);quill.on("text-change",this.onTextChange.bind(this));quill.on("selection-change",this.onSelectionChange.bind(this));quill.keyboard.addBinding({key:38},this.upHandler.bind(this));quill.keyboard.addBinding({key:40},this.downHandler.bind(this))}_createClass(Mention,[{key:"filterUser",value:function(searchText){this.options.parentScope.searchObj.searchText=searchText}},{key:"hasValidChars",value:function(s){return!0}},{key:"onSomethingChange",value:function(){var range=this.quill.getSelection();if(null!=range){this.cursorPos=range.index;this.options.parentScope.quillObj.currentCursorPos=this.cursorPos;var startPos=Math.max(0,this.cursorPos-this.options.maxChars);var beforeCursorPos=this.quill.getText(startPos,this.cursorPos-startPos);var mentionCharIndex=-1;if(!_.isEmpty(beforeCursorPos.trim())){var index=_.findLastIndex(beforeCursorPos,(function(a){return/\s/.test(a)}));mentionCharIndex=index>=0?index+1:0}this.options.parentScope.quillObj.mentionCharPos=-1;this.options.parentScope.searchObj.searchText="";if(mentionCharIndex>-1){var mentionCharPos=this.cursorPos-(beforeCursorPos.length-mentionCharIndex);this.mentionCharPos=mentionCharPos;this.options.parentScope.quillObj.mentionCharPos=this.mentionCharPos;var textAfter=beforeCursorPos.substring(mentionCharIndex);if(textAfter.length>=this.options.minChars&&this.hasValidChars(textAfter)){beforeCursorPos[mentionCharIndex];this.filterUser(textAfter.trim())}}this.options.parentScope.recalcSelectableList()}}},{key:"onTextChange",value:function(delta,oldDelta,source){"user"===source&&this.onSomethingChange()}},{key:"onSelectionChange",value:function(range){range&&0===range.length&&this.onSomethingChange()}},{key:"upHandler",value:function(){return!1}},{key:"downHandler",value:function(){return!this.dropDownIsOpen()}},{key:"dropDownIsOpen",value:function(){return scope.dropDownOpenFlag}}]);return Mention}(),Quill.register("modules/mention",Mention);var Mention;!function(){var MentionBlot=function(_Base){!function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}});superClass&&_setPrototypeOf(subClass,superClass)}(MentionBlot,_Base);function MentionBlot(){_classCallCheck(this,MentionBlot);return _possibleConstructorReturn(this,_getPrototypeOf(MentionBlot).apply(this,arguments))}_createClass(MentionBlot,null,[{key:"create",value:function(data){var node=_get(_getPrototypeOf(MentionBlot),"create",this).call(this,data.name);node.setAttribute("data-name",data.name);node.setAttribute("data-id",data.id);node.setAttribute("data-email",data.email);var denotationChar=document.createElement("span");denotationChar.className="ql-mention-denotation-char";denotationChar.innerHTML+=data.name;denotationChar.setAttribute("contenteditable",!1);node.appendChild(denotationChar);return node}},{key:"setDataValues",value:function(element,data){var domNode=element;Object.keys(data).forEach((function(key){domNode.dataset[key]=data[key]}));return domNode}},{key:"value",value:function(domNode){return domNode.dataset}}]);return MentionBlot}(Quill.import("blots/embed"));MentionBlot.blotName="mention";MentionBlot.className="quill-mention";MentionBlot.tagName="span";Quill.register({"formats/mention":MentionBlot})}();!function(){$document[0].addEventListener("keydown",keyboardSupport,!1);$timeout((function(){var editorDom=getEditorElement();scope.editor=new Quill(editorDom,{theme:"snow",placeholder:scope.placeholder||"Select user or input email.",formats:["mention"],modules:{toolbar:!1,mention:{allowedChars:/^[a-zA-Z0-9_]*$/,mentionDenotationChars:["@"],parentScope:scope},keyboard:{bindings:{custom1:{key:13,handler:function(){return!1}},custom2:{key:13,shiftKey:!0,handler:function(){return!1}}}}}});scope.editor.clipboard.addMatcher("*",(function(node,delta){return{ops:[]}}));scope.editor.on("text-change",(function(delta,oldDelta,source){"user"===source&&delta.ops&&delta.ops.length>1&&/\s/.test(delta.ops[1].insert)&&function(){var richText=scope.editor.getContents();var text=scope.editor.getText().trim();getCopieOriginalList();text.split("&nbsp;");var pos=0;if(richText&&richText.ops)for(var index=0;index<richText.ops.length;index++){var element=richText.ops[index];if(element&&element.insert&&element.insert.mention)pos++;else if(element&&element.insert&&!element.insert.mention){if(!element.insert.trim()){pos+=element.insert.length;continue}if(text=element.insert.trim()){scope.recalcSelectableList();var i=_.findIndex(scope.selectableList,(function(u){return isComplateMatch(u,text)}));if(i>-1){var person=scope.selectableList[i];/\s/.test(element.insert[0])&&pos++;scope.editor.deleteText(pos,element.insert.length-1,Quill.sources.API);scope.editor.setSelection(pos);insertData(pos,person);scope.currentSelectedList.push(person);removeFromSelectableList(person);scope.editor.focus();digest();return}if(/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/.test(text)){/\s/.test(element.insert[0])&&pos++;scope.editor.deleteText(pos,element.insert.length-1,Quill.sources.API);scope.editor.setSelection(pos);var p={id:"",name:text,email:text};insertData(pos,p);scope.currentSelectedList.push(p);scope.editor.focus();digest();return}}}}}()}));$(element[0].getElementsByClassName("ql-editor")[0]).click((function(e){scope.editor.isEnabled()||e.stopPropagation()}));!function(){if(scope.selectedList&&scope.selectedList.length>0){var copiedList=angular.copy(scope.selectedList);_.each(copiedList,(function(d){insertData(0,d,"user")}))}}()}))}();scope.$watch("editorState",(function(newVal,oldVal){newVal!=oldVal&&(scope.originalList=scope.initList||[])}))}}}])}();!function(netBrain){angular.module("nb.qmap").directive("nbMapBarMiddleMenuDirective",nbMapBarMiddleMenuDirective);nbMapBarMiddleMenuDirective.$inject=[];function nbMapBarMiddleMenuDirective(){var directive={restrict:"EA",scope:{},templateUrl:"modules/nbQmap/views/nbMapBarMiddleMenuDirective.html",controller:controller,link:link};controller.$inject=["nb.qmap.httpMapSrvc","nb.ng.userSrvc","$compile","$scope","$q","$rootScope","$uibModal","$window","nb.ng.httpAuthSrvc","nb.qmap.mapManagerSrvc","nb.miniTask.miniTaskUtilSrvc","nb.qmap.updateMapSrvc","nb.common.nbAlertSrvc","nb.uiframework.urlStateMgr","$timeout","nb.common.nbTipSrvc","nb.runbook.runBookTemplateMgr","nb.runbook.runbookMgr","nb.common.nbCalculationTipSrvc","nb.qmap.mapContextMenuManager","nb.dashboard.baseSrvc","nb.uiframework.mainUISrvc","nb.ng.utilitySrvc","nb.runbook.mapTargetDeviceSrvc","nb.wordDoc.exportWordSrvc","nb.wordDoc.exportWordToolSrvc","nb.runbook.actionTaskSrvc"];function controller(httpMapSrvc,userSrvc,$compile,$scope,$q,$rootScope,$uibModal,$window,httpAuthSrvc,mapManagerSrvc,miniTaskUtilSrvc,updateMapSrvc,nbAlertSrvc,urlStateMgr,$timeout,nbTipSrvc,runbookTemplateMgr,runbookMgr,nbCalculationTipSrvc,mapContextMenuManager,dashboardBaseSrvc,mainUISrvc,utilitySrvc,mapTargetDeviceSrvc,exportWordSrvc,exportWordToolSrvc,actionTaskSrvc){var scope=$scope;var mapExportManager=$scope.mapExportManager=exportWordToolSrvc.mapExportManager;mapExportManager.exportListing=!1;$scope.isActive=!1;$scope.activePage=mapManagerSrvc.getActivePage();$scope.activeMap=mapManagerSrvc.getActiveMap();$scope.enableRunBookTooltip=!0;$scope.enableDashboardTooltip=!0;$scope.enableQappTooltip=!0;$scope.enableMapTooltip=!0;$scope.enableMoreTooltip=!0;$scope.allowShare=utilitySrvc.getLocalStorage("allowShare");$scope.exportingDialog=exportWordToolSrvc.exportingDialog;$scope.isShowMapStencil=!1;$scope.selectMode="free";$scope.isMapLocked=!1;$scope.canUndo=!1;$scope.canRedo=!1;$scope.$watch((function(){return mapManagerSrvc.getActivePage()&&mapManagerSrvc.getActivePage().getGoJsDiagram()&&mapManagerSrvc.getActivePage().getGoJsDiagram().commandHandler.canRedo()}),(function(res){$scope.canRedo=res}));$scope.$watch((function(){return mapManagerSrvc.getActivePage()&&mapManagerSrvc.getActivePage().getGoJsDiagram()&&mapManagerSrvc.getActivePage().getGoJsDiagram().commandHandler.canUndo()}),(function(res){$scope.canUndo=res}));$scope.stencilTools=[{type:"Text",title:"Text",iconClass:"map-top-bar-icon-nb-note",action:activeStencilTool,active:!1},{type:"Rectangle",title:"Rectangle",iconClass:"map-top-bar-icon-nb-rectangle",action:activeStencilTool,active:!1},{type:"Line",title:"Line",iconClass:"map-top-bar-icon-nb-line",action:activeStencilTool,active:!1},{type:"Define Path",title:"Define Path",iconClass:"map-top-bar-icon-nb-definepath",action:activeStencilTool,active:!1}];$scope.$parent&&$scope.$parent.$parent&&$scope.$parent.$parent.$parent&&$scope.$parent.$parent.$parent.$parent?$scope.doUpdateMaping=$scope.$parent.$parent.$parent.$parent.doUpdateMaping:$scope.doUpdateMaping={updating:!1};$scope.$on("is-starting-export-word-quene",(function(){mapExportManager.exportListing||startingMapExportWordQuene()}));$timeout((function(){startingMapExportWordQuene()}),1e3);function startingMapExportWordQuene(){mapExportManager.getExportingStatus({sourceType:2,sourceId:$scope.activeMap.getDocId()},(function(res,time){mapExportManager.exportListing=!0;!function(res,time,exportListManager){exportListManager.getExportManager()||exportListManager.setExportManager(res);var tips=exportListManager.matchExportManager(res);$rootScope.$broadcast("match-export-manager-message",{data:res,diffObj:tips,key:exportListManager.key});tips.diff.length&&exportWordSrvc.getFileInfo(_.pluck(tips.diff,"id")).then((function(result){_.each(result,(function(tip){exportWordToolSrvc.createTip(tip)}))}));if(res&&res.length)exportListManager.exportingLink=!0;else{clearTimeout(time);exportListManager.exportListing=!1;exportListManager.exportingLink=!1}}(res,time,mapExportManager)}),(function(){mapExportManager.exportingLink=!0}))}var initLayoutList=function(){$scope.layoutList=mapContextMenuManager.getLayoutMenu(mapManagerSrvc.getActivePage().getTopologyType())};initLayoutList();var rootScopeonActivePageChanged=$rootScope.$on(netBrain.Map.Event.ActivePageChanged,(function(){initLayoutList()}));var rootScopeonNewMap=$rootScope.$on("NewMap",(function(){$scope.activePage=mapManagerSrvc.getActivePage();$scope.activeMap=mapManagerSrvc.getActiveMap()}));function contextMenuAction(item,$event){$event.stopPropagation()}$scope.status={isopen:!1,isMoreOpen:!1,isDashboardOpen:!1,isRunbookOpen:!1,isActionsOpen:!1};var rootScopeonmapBarMidddleMenuDrapDownClose=$rootScope.$on("mapBarMidddleMenuDrapDownClose",(function(){$scope.status.isopen=!1;$scope.status.isMoreOpen=!1;$scope.status.isDashboardOpen=!1;$scope.status.isRunbookOpen=!1;$scope.status.isActionsOpen=!1}));$scope.setActive=function(item){var data={Dashboard:{active:status=!1},LiveTools:{active:status},RunQapp:{active:status},Compare:{active:status},AutoLayout:{active:status},Actions:{active:status}};var status;switch(item){case"Dashboard":data.Dashboard.active=!0;break;case"LiveTools":data.LiveTools.active=!0;break;case"RunQapp":data.RunQapp.active=!0;break;case"Compare":data.Compare.active=!0;break;case"AutoLayout":data.AutoLayout.active=!0;break;case"Actions":$q.all([mapTargetDeviceSrvc.buildForContext(),mapTargetDeviceSrvc.buildForContext("getFavoriteList")]).then((function(result){_.isEmpty(result[0])?result[0]=[{title:"Favorite Actions",image:"action_node_favorite_icon",action:contextMenuAction,disabled:_.isEmpty(result[1]),subMenus:_.isArray(result[1])&&result[1]}]:result[0].push({title:"Favorite Actions",image:"action_node_favorite_icon",disabled:_.isEmpty(result[1]),action:contextMenuAction,subMenus:_.isArray(result[1])&&result[1]});return $scope.actionBuiltInList=result[0]})).then((function(){data.Actions.active=!0}));break;default:console.warn("setActive in default.")}return data};var changeSelectStatus=function(item){$scope.obj=$scope.setActive(item)};var rootScopeonshowAutoLinkTip=$rootScope.$on("showAutoLinkTip",(function(){var defaultAutoLinkTopotype=netBrain.Map.Const.TopoLinkTypeShow.IPv4L3Topology;var currentPageAutoLinkOp=$scope.activePage.getMapAutoLinkOptionList(function(netmap){if(null==netmap||null==netmap.getActivePage())return null;var info=netmap.getActivePage().getVisualSpaceInfo();return null==info?null:info.visualSpaceInstanceId}($scope.activeMap));if(currentPageAutoLinkOp&&1===currentPageAutoLinkOp.length){var type=currentPageAutoLinkOp[0];type===netBrain.Map.Const.TopoLinkType.IPv6L3Topology?defaultAutoLinkTopotype=netBrain.Map.Const.TopoLinkTypeShow.IPv6L3Topology:type===netBrain.Map.Const.TopoLinkType.L2Topology&&(defaultAutoLinkTopotype=netBrain.Map.Const.TopoLinkTypeShow.L2Topology)}var options={tipInfo:"",hasCloseBtn:!0,autoClose:!1,template:'<div style="text-align:left;">'+StringUtil.format(netBrain.Map.Message.ShowAutoLinkTip,{defaultAutoLinkTopotype:defaultAutoLinkTopotype,mapsettings:'<a style="cursor:pointer" ng-click="callBack()" atag="map:nbMapBarMiddleMenuDirective:tip:mapSettings">Map Settings</a>'})+"</div>",callBack:$scope.onMapSettings};nbTipSrvc.open(options)}));$scope.toggerClass=function(order,item){changeSelectStatus(item);var orderIndex=parseInt(order);if($($(".map-top-bar-menu-item .dropdown-menu1")[orderIndex]).is(":visible")){$scope.enableRunBookTooltip=!1;$scope.enableDashboardTooltip=!1;$scope.enableQappTooltip=!1;$scope.enableMapTooltip=!1;$scope.enableMoreTooltip=!1;$scope.enableTooltip=!1}hideTooltip()};$scope.openMapStencilPanel=function(){var activeMap=mapManagerSrvc.getActivePage();if(null!=activeMap){!1===$scope.isShowMapStencil&&($scope.isShowMapStencil=!0);$rootScope.$emit(viewFrameEvent.toggleTopPanel,"stencil",activeMap)}};$rootScope.$on(NetBrain.Map.Event.DeactiveStencilItem,(function(event,type){clearStencilToolStatus(type)}));$scope.onInstantQappClick=function(){mapManagerSrvc.getActivePage().currentScopeRef.showQappInstancePane()};function hideTooltip(){var count=0;var setFive=setInterval((function(){++count>10&&clearInterval(setFive);var $toolTip=$(".map-top-bar-menu .open .tooltip");if($toolTip.length>0){$toolTip.css("display","none");$toolTip.remove();clearInterval(setFive)}}),200)}scope.onRunOverallHealthMonitorQapp=function(path,item){changeSelectStatus(item);var activtePage=mapManagerSrvc.getActivePage();miniTaskUtilSrvc.onRunQappForFullPath(path,activtePage)};scope.onRunQapp=function(item){changeSelectStatus(item);var option={miniTaskType:1,mapPageObj:mapManagerSrvc.getActivePage()};miniTaskUtilSrvc.showMiniTaskDialog(option)};scope.showEditRight=function(){$scope.$parent.$parent.showEditRight()};$scope.DashboardMenuList=null;$scope.onDashboardMenuClick=function(item){if(!item||0!==item.type){var activeDoc=mapManagerSrvc.getActiveMap();var activePage=mapManagerSrvc.getActivePage();if((activeDoc.isModify()||activeDoc.getNew())&&0==!item)if($scope.isEditor())nbAlertSrvc.confirm("A dashboard template cannot be applied to an unsaved map. Do you want to save the map and then run the dashboard template?").then((function(){mapManagerSrvc.saveMap().then((function(){dashboardMenuClickHandler(item,activeDoc,activePage)}))}));else{var op={message:"You don't have editing rights to save the changes. Apply the selected dashboard template on the original map instead? <br/><br/> (Or you can save the map as another map before applying the dashboard template.)",title:"Warning",iconType:NB_ICON_WARNING,buttons:[{id:NB_CONFIRM_YES,label:"Apply on Original Map"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(op).then((function(){dashboardMenuClickHandler(item,activeDoc,activePage)}))}else dashboardMenuClickHandler(item,activeDoc,activePage)}};$scope.openDashboardTemplatePanel=function(activeDoc,activePage){var newDashboardId=NgUtil.getGUID();dashboardBaseSrvc.templateDialog({handle:function(selectedTemplate){if(activeDoc.isModify()||activeDoc.getNew())nbAlertSrvc.confirm("A dashboard template cannot be applied to an unsaved map. Do you want to save the map and then run the dashboard template?").then((function(){mapManagerSrvc.saveMap().then((function(){utilitySrvc.setLocalStorage("dashboardFromOthers"+newDashboardId,{templateId:selectedTemplate.id,mapId:activeDoc.getDocId(),mapPageId:activePage.getDocId()});utilitySrvc.setLocalStorage("isNewDashboard",!0);urlStateMgr.openDashboard({id:newDashboardId,target:"_blank"})}))}));else{utilitySrvc.setLocalStorage("dashboardFromOthers"+newDashboardId,{templateId:selectedTemplate.id,mapId:activeDoc.getDocId(),mapPageId:activePage.getDocId()});utilitySrvc.setLocalStorage("isNewDashboard",!0);urlStateMgr.openDashboard({id:newDashboardId,target:"_blank"})}}})};$scope.openDashboardTemplateEditPanel=function(){dashboardBaseSrvc.templateFavoriteDialog().then((function(){mapManagerSrvc.getDTMenusOnMap().then((function(data){data&&data[0]&&data[0].child&&($scope.DashboardMenuList=data[0].child)}))}))};function dashboardMenuClickHandler(item,activeDoc,activePage){if(item){var newDashboardId=NgUtil.getGUID();utilitySrvc.setLocalStorage("dashboardFromOthers"+newDashboardId,{templateId:item.templateId,templatePath:encodeURI(item.templatePath),mapId:activeDoc.getDocId(),mapPageId:activePage.getDocId()});utilitySrvc.setLocalStorage("isNewDashboard",!0);urlStateMgr.openDashboard({id:newDashboardId,target:"_blank"})}else $scope.openDashboardTemplatePanel(activeDoc,activePage)}$scope.AutoLayoutMenuList=[{name:"Execute CLI Commands",action:function(){var option={miniTaskType:13,mapPageObj:mapManagerSrvc.getActivePage()};miniTaskUtilSrvc.showMiniTaskDialog(option)},image:"run-cli-command-16"},{name:"Retrieve Live Data",action:function(){var option={miniTaskType:7,mapPageObj:mapManagerSrvc.getActivePage(),innerUrl:"modules/nbMiniTask/retrieveLiveData/views/retrieveLiveData.html",miniTaskIcon:"icon_nb_png_retrieLive",minChangeIcon:"icon_nb_png_retrieLive_min",miniTaskName:"Retrieve Live Data"};miniTaskUtilSrvc.showMiniTaskDialog(option)},image:"retrieve-live-data-16"},{name:"Ping to",action:function(){var option={miniTaskType:4,mapBarTaskType:3,mapPageObj:mapManagerSrvc.getActivePage()};miniTaskUtilSrvc.showMiniTaskDialog(option)},image:"ping-to-16"},{name:"Ping from",action:function(){var option={miniTaskType:4,mapBarTaskType:4,mapPageObj:mapManagerSrvc.getActivePage()};miniTaskUtilSrvc.showMiniTaskDialog(option)},image:"ping-to-16"},{name:"Traceroute to",action:function(){var option={miniTaskType:5,mapBarTaskType:5,mapPageObj:mapManagerSrvc.getActivePage()};miniTaskUtilSrvc.showMiniTaskDialog(option)},image:"trace-route-to-16"},{name:"Traceroute from",action:function(){var option={miniTaskType:5,mapBarTaskType:6,mapPageObj:mapManagerSrvc.getActivePage()};miniTaskUtilSrvc.showMiniTaskDialog(option)},image:"trace-route-to-16"}];$scope.handler=function(item){updateMapSrvc.canUpdateCurrentMap().then((function(){item.action()}))};$scope.onExportViso=function(isNew){var map=mapManagerSrvc.getActiveMap();updateMapSrvc.canUpdateCurrentMap().then((function(){map.isModify()||map.realNew?mapManagerSrvc.saveMapCheck(map).then((function(){var op={message:netBrain.Map.Message.IsModifiedForExportMapMsg,buttons:[{id:NB_CONFIRM_CANCEL,label:"Cancel"},{id:NB_CONFIRM_YES,label:"Save and Continue"}]};nbAlertSrvc.confirm(op).then((function(){(map.isModify()||map.realNew)&&mapManagerSrvc.saveMap().then((function(){$rootScope.$emit("openExportViso",mapManagerSrvc.getActiveMap(),isNew,"visio")}))}))})):$rootScope.$emit("openExportViso",mapManagerSrvc.getActiveMap(),isNew,"visio")}))};$scope.onExportMap=function(){actionTaskSrvc.getGlobalDAPStatus().then((function(){var map=mapManagerSrvc.getActiveMap();updateMapSrvc.canUpdateCurrentMap().then((function(){map.isModify()?mapManagerSrvc.saveMapCheck(map).then((function(){var op={message:netBrain.Map.Message.IsModifiedForExportMapMsg,buttons:[{id:NB_CONFIRM_YES,label:"Save and Continue"},{id:NB_CONFIRM_NO,label:"Don't Save"}]};nbAlertSrvc.confirm(op).then((function(){map.isModify()&&mapManagerSrvc.saveMap().then((function(){$scope.runExport(map)}))}))})):(map.getMapType()===NetBrain.Map.Const.MapType.overViewMap||map.getMapType()===NetBrain.Map.Const.MapType.siteMap||(map.getMapType(),NetBrain.Map.Const.MapType.deviceGroupMap),$scope.runExport(map))}))}))};$scope.runExport=function(map){httpAuthSrvc.isValidSession().then((function(){var nbExportMap='<nb-export-map-directive map-id="'+map.getDocId()+'" map-name="'+encodeURIComponent(map.getTitle())+'"></nb-export-map-directive>';var $newElement=$compile(nbExportMap)($scope);$(document).find("body").append($newElement)}))};$scope.onExportWord=function(){var map=mapManagerSrvc.getActiveMap();updateMapSrvc.canUpdateCurrentMap().then((function(){if(map.isModify()||map.getRealNew()){var op={message:netBrain.Map.Message.IsModifiedForExportMapMsg,buttons:[{id:NB_CONFIRM_YES,label:"Save and Continue"},{id:NB_CONFIRM_NO,label:"Don't Save"}]};nbAlertSrvc.confirm(op).then((function(){mapManagerSrvc.saveMapCheck(map).then((function(){(map.isModify()||map.getRealNew())&&mapManagerSrvc.saveMap().then((function(){$scope.openExportWord(map)}))}))}))}else map.getMapType()===NetBrain.Map.Const.MapType.overViewMap||map.getMapType()===NetBrain.Map.Const.MapType.siteMap||(map.getMapType(),NetBrain.Map.Const.MapType.deviceGroupMap),$scope.openExportWord(map)}),(function(){$scope.openExportWord(map)}))};$scope.openExportWord=function(map){httpAuthSrvc.isValidSession().then((function(){$uibModal.open({templateUrl:"modules/nbWordDoc/views/nbExportMapBasicSettingsView.html",controller:"nb.wordDoc.nbExportMapBasicSettingsCtrl",windowClass:"export-word-outer-box",backdrop:"static",size:"sm",resolve:{dataHandler:function(){return{getData:function(){return map}}}}}).result.then((function(result){result.export}),(function(){}))}))};$scope.onExportImage=function(){var map=mapManagerSrvc.getActiveMap();updateMapSrvc.canUpdateCurrentMap().then((function(){map.isModify()||map.realNew?mapManagerSrvc.saveMapCheck(map).then((function(){var op={message:netBrain.Map.Message.IsModifiedForExportMapMsg,buttons:[{id:NB_CONFIRM_CANCEL,label:"Cancel"},{id:NB_CONFIRM_YES,label:"Save and Continue"}]};nbAlertSrvc.confirm(op).then((function(){(map.isModify()||map.realNew)&&mapManagerSrvc.saveMap().then((function(){$rootScope.$emit("openExportViso",mapManagerSrvc.getActiveMap(),!1,"image")}))}))})):$rootScope.$emit("openExportViso",mapManagerSrvc.getActiveMap(),!1,"image")}))};$scope.getMapType=function(){var activeMap=mapManagerSrvc.getActiveMap();return null==activeMap?0:activeMap.getMapType()};$scope.getTopologyType=function(){var activePage=mapManagerSrvc.getActivePage();return null==activePage?0:activePage.getTopologyType()};$scope.onOpenDataViewManager=function(){var activeMap=mapManagerSrvc.getActivePage();if(null!=activeMap){var url="dataviewMgr.html#/GlobalDataView?dataViewTreeType="+DataViewTreeType.MapDataView+"&mapId="+activeMap.getDocId();urlStateMgr.switchTabOrOpenNewTab(url,DataViewTreeType.MapDataView,(function(){urlStateMgr.openNewTab(url)}))}};$scope.onOpenCAReport=function(){mapManagerSrvc.jumpToCAWithMapDevices()};$scope.onMapSettings=function(){$rootScope.$emit("openMapSettings")};$scope.showPathLegend=function(){$rootScope.$emit("openPathLegend")};$scope.undo=function(){updateMapSrvc.canUpdateCurrentMap().then((function(){var curNetMap=mapManagerSrvc.getActivePage();if(null!=curNetMap){var diagram=curNetMap.getGoJsDiagram();null!=diagram&&diagram.undoManager.undo()}}))};$scope.redo=function(){updateMapSrvc.canUpdateCurrentMap().then((function(){var curNetMap=mapManagerSrvc.getActivePage();if(null!=curNetMap){var diagram=curNetMap.getGoJsDiagram();null!=diagram&&diagram.undoManager.redo()}}))};$scope.onPrint=function(){var activePage=mapManagerSrvc.getActivePage();if(null!=activePage){var img=document.createElement("img");img.src=activePage.getImageBase64();img.classList.add("printOnly");setTimeout((function(){$window.document.body.appendChild(img);$window.print();$window.document.body.removeChild(img)}),0)}};function hasDiagram(){var curNetMap=mapManagerSrvc.getActivePage();return null!=curNetMap&&null!=curNetMap.getGoJsDiagram()}$scope.onAreaSelect=function(){if("area"!==$scope.selectMode){$scope.selectMode="area";if(hasDiagram()){var diagram=mapManagerSrvc.getActivePage().getGoJsDiagram();diagram.toolManager.panningTool.isEnabled=!1;diagram.currentCursor="default";$scope.$emit("changeAreaSelectState",!0,mapManagerSrvc.getActivePage().getDocId())}}};$scope.onFreeHandSelect=function(){if("free"!==$scope.selectMode){$scope.selectMode="free";if(hasDiagram()){var diagram=mapManagerSrvc.getActivePage().getGoJsDiagram();diagram.toolManager.panningTool.isEnabled=!0;diagram.currentCursor=cursorHelper.pointer;$scope.$emit("changeAreaSelectState",!1,mapManagerSrvc.getActivePage().getDocId())}}};$scope.onLockMap=function(){if(!$scope.isMapLocked){var activeMap=mapManagerSrvc.getActiveMap();if(null!==activeMap){activeMap.setLock(!0);$rootScope.$emit("mapLockStatusChanged");$scope.isMapLocked=!0}}};$scope.onUnlockMap=function(){if($scope.isMapLocked){var activeMap=mapManagerSrvc.getActiveMap();if(null!==activeMap){activeMap.setLock(!1);$rootScope.$emit("mapLockStatusChanged");$scope.isMapLocked=!1}}};$scope.isEditor=function(){var activeMap=mapManagerSrvc.getActiveMap();if(null==activeMap)return!1;if(activeMap.getMapType()===NetBrain.Map.Const.MapType.overViewMap)return!1;var editor=activeMap.getEditRight();var result=!1;if(!editor||!editor.editorId)return!0;(""!==editor.editorId.trim()&&userSrvc.getUserID()===editor.editorId||""===editor.editorId.trim()&&userSrvc.getUserName()===editor.editorName)&&(result=!0);return result};$scope.isMapNew=function(){return!!mapManagerSrvc.getActiveMap()&&mapManagerSrvc.getActiveMap().realNew};$scope.$on(netBrain.Map.Event.StartUpdateMap,(function(){$scope.getUpdateMap()}));function closeDataViewConsolePane(){var options={mapPage:{},show:!1,consoleType:NetBrain.Runbook.AlertMes.ConsoleType.AllConsole};var activePage=mapManagerSrvc.getActivePage();var consolePaneEvent=netBrain.Runbook.AlertMes.ConsolePaneEvent;activePage.getCurrentScope().$emit(consolePaneEvent.onShowAlertMessage,options);$rootScope.$broadcast(MapTabEvent.Min_TAB_OUTSIDE)}$scope.getUpdateMap=function(){closeDataViewConsolePane();if($scope.isEditor()){var map=mapManagerSrvc.getActiveMap();var showTip=function(mes,className,isOk){nbTipSrvc.closeAllTip();var options={tipInfo:StringUtil.format(mes,{mapTitle:map.getTitle()}),autoClose:isOk,hasCloseBtn:!isOk,customClass:className};nbTipSrvc.open(options)};var doUpdateMap=function(){nbCalculationTipSrvc.showCalculationTip({title:"Updating Map ..."});httpMapSrvc.getUpdatedMapByKey(map.getDocId(),map.getMapType()).then((function(newmap){httpMapSrvc.getTopoLinkPolicyInfo().then((function(policyData){map.setTopoLinkPolicyInfo(policyData)}),(function(){})).then((function(){if(null!=newmap&&null!=newmap){map.fromJson(newmap);refreshMap(map);nbCalculationTipSrvc.closeCalculationTip();var appliedDataViewInfo=map.getActiveNetmap().getApplyDataViewInfo();appliedDataViewInfo&&appliedDataViewInfo.isPreview&&$rootScope.$emit("previewDataView",appliedDataViewInfo);showTip(netBrain.Map.Message.FinishUpdateMapSuccess,"updateMapSucessTip",!0);mapManagerSrvc.getActivePage().getNetmapOperator().getNetMap().getGoJsDiagram().model.undoManager.clear()}else{nbCalculationTipSrvc.closeCalculationTip();showTip(netBrain.Map.Message.FinishUpdateMapFail,"updateMapFailTip",!0)}}))}),(function(){nbCalculationTipSrvc.closeCalculationTip();showTip(netBrain.Map.Message.FinishUpdateMapFail,"updateMapFailTip",!0)}))};if(map.isModify()){var op={message:netBrain.Map.Message.IsModifiedForUpdateMapMsg,buttons:[{id:NB_CONFIRM_YES,label:"Save and Update"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(op).then((function(){mapManagerSrvc.saveMap().then((function(){doUpdateMap()}))}),(function(){map.setModify(!0)}))}else doUpdateMap()}else nbAlertSrvc.alert(netBrain.Map.Message.HaveNoEditRight)};$scope.refreshMapEditright=function(){closeDataViewConsolePane();if(!$scope.isMapNew()){var map=mapManagerSrvc.getActiveMap();var qList=[];map.getMapType()===netBrain.Map.Const.MapType.general?qList.push(httpMapSrvc.getMapByKey(map.getDocId(),!0)):qList.push(httpMapSrvc.getSystemMapByKey(map.getDocId(),map.getMapType(),!0));qList.push(httpMapSrvc.isMapExist(map.getDocId()));$q.all(qList).then((function(result){var doc=result[0];var mapIsExist=result[1];if(doc)if(map.isModify()){var dialogOptions={message:"The map was updated "+TimeUtil.getElapsedTimeStringUntilNow(doc.modifyTm)+" ago. Refreshing this map will discard all your changes and keep it up to date. Do you want to refresh it anyway?"};nbAlertSrvc.confirm(dialogOptions).then((function(){map.fromJson(doc);refreshMap(map)}))}else{map.fromJson(doc);refreshMap(map)}else if(!mapIsExist){var op={message:netBrain.Map.Message.IsExistedForRefreshMapMsg,buttons:[{id:NB_CONFIRM_YES,label:"Save and Refresh"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(op).then((function(){mapManagerSrvc.saveMap().then((function(){refreshMap(map)}))}),(function(){map.setModify(!0)}))}}))}};var finishRefreshMap=function(){$timeout((function(){$scope.doUpdateMaping.updating=!1;$rootScope.$emit("finishRefreshMap")}),0)};function refreshMap(map){var mapArgs={havLoadMapObj:map};$scope.doUpdateMaping.updating=!0;$rootScope.$emit("ReInitMapCtrl",mapArgs);if($scope.activePage)if(map.getEditRight().editorName)finishRefreshMap();else{map.setEditRight(userSrvc.getUserName(),userSrvc.getUserID());map.isTempEditRight=!0;var pageType=mainUISrvc.isDesktop()?netBrain.NG.Const.PageType.Desktop:netBrain.NG.Const.PageType.Map;var mapId=map.getDocId();httpMapSrvc.getTempEditingRight(map.getDocId(),window.name).then((function(){urlStateMgr.setPageSession(netBrain.NG.Const.PageType.Map+mapId,$scope.activeMap.getTitle(),pageType,{subType:netBrain.NG.Const.PageType.Map,keepalived:!0});finishRefreshMap()}),(function(){urlStateMgr.setPageSession(netBrain.NG.Const.PageType.Map+mapId,$scope.activeMap.getTitle(),pageType,{subType:netBrain.NG.Const.PageType.Map,keepalived:!0});finishRefreshMap()}))}}var rootScopeonrefreshMap=$rootScope.$on("refreshMap",(function(){emitOnRefreshMap()}));function emitOnRefreshMap(){var map=mapManagerSrvc.getActiveMap();httpMapSrvc.getMapByKey(map.getDocId(),!0).then((function(data){map.fromJson(data);refreshMap(map)}))}var iTime;var rootScopeonrefreshMapSmartTelEvent=$rootScope.$on("refreshMapForSmartTelEvent",(function(){clearTimeout(iTime);iTime=setTimeout(emitOnRefreshMap,500)}));$scope.refreshMap=function(){$scope.activePage=mapManagerSrvc.getActivePage();if($scope.activePage){var diagramPage=$scope.activePage._diagram;null!=diagramPage&&diagramPage.delayInitialization((function(){diagramPage.requestUpdate()}))}};$scope.onSaveAs=function(){mapManagerSrvc.saveMapAs()};var body=angular.element(window.document.body);var textarea=angular.element("<textarea/>");textarea.css({position:"fixed",opacity:"0"});$scope.onCopyMapURL=function(){var tenandId=httpAuthSrvc.getSelectedTenantId();var domainId=httpAuthSrvc.getSelectedDomainIds()[0];var href=/^http.*\//.exec(document.location.href)[0];var localHref=StringUtil.format(href+NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.Map,{tenantId:tenandId,domainId:domainId,id:mapManagerSrvc.getActiveMap().getDocId()});textarea.val(localHref);body.append(textarea);textarea[0].select();try{document.execCommand("copy")?new window.MapTip({wrapper:"body"}).show({message:"You have successfully copied the dashboard link to clipboard."}):nbAlertSrvc.error("Failed to copy the dashboard link to the clipboard. Please try to proceed with the latest version of Chrome, Safari or Firefox.")}catch(err){console.error("failed to copy",link)}textarea.remove()};$scope.onOpenRunBookSelectionModal=function(){runbookTemplateMgr.openSelectionModal().then((function(rbs){if(rbs&&rbs.length>0){if($scope.isMapNew()){nbAlertSrvc.notification("The action cannot be completed. Please make sure you have saved the map.");return}runbookTemplateMgr.run(rbs[0],!0)}}))};$scope.recentRBAList=[];$scope.onOpenRecentRBA=function(rba){runbookMgr.switchRunbook(rba.ID||rba._id)};$scope.refreshRecentRBAMenu=function(){runbookMgr.getRunbookList(mapManagerSrvc.getActiveMap().getDocId(),5).then((function(rbaList){$scope.recentRBAList=rbaList}))};$scope.toggled=function(open,ett){switch(ett){case"enableRunBookTooltip":$scope.enableRunBookTooltip=!open;break;case"enableDashboardTooltip":$scope.DashboardMenuList?$scope.enableDashboardTooltip=!open:mapManagerSrvc.getDTMenusOnMap().then((function(data){if(data&&data[0]&&data[0].child){$scope.DashboardMenuList=data[0].child;$scope.enableDashboardTooltip=!open}}));break;case"enableQappTooltip":$scope.enableQappTooltip=!open;break;case"enableMapTooltip":$scope.enableMapTooltip=!open;break;case"enableMoreTooltip":$scope.enableMoreTooltip=!open;break;default:console.warn("toggled in default")}};$scope.onMapMouseEnter=function(){hideTooltip()};$scope.$on("$destroy",(function(){mapExportManager.cancelTimeQuene();mapExportManager.resetExportManager();rootScopeonNewMap();rootScopeonActivePageChanged();rootScopeonmapBarMidddleMenuDrapDownClose();rootScopeonshowAutoLinkTip();rootScopeonrefreshMap();rootScopeonrefreshMapSmartTelEvent()}));$scope.onLayout=function(){var MapLayoutEvent=NetBrain.MapLayout.Const.MapLayoutEvent;$rootScope.$emit(MapLayoutEvent.OpenMapLayoutMiniPane,"Map Layout")};$scope.onSaveasSampleMapLayout=function(){$uibModal.open({templateUrl:"modules/nbQmap/views/maplayout/createSampleMapLayout.html",controller:"nb.qmap.createSampleMapCtrl",windowClass:"create-sample-map-ctrl",backdrop:"static",size:"sm",resolve:{createSampleMapHandle:function(){return{id:0}}}}).result.then((function(){}));$uibModal.open({templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutSettings.html",controller:"nb.qmap.nbMapLayoutSettings",windowClass:"map-layout-settings-ctrl",backdrop:"static",size:"sm",resolve:{mapLayoutSettingsHandle:function(){return{id:0}}}}).result.then((function(){}))};function activeStencilTool(item){clearStencilToolStatus();item.active=!0;$rootScope.$emit(NetBrain.Map.Event.ActiveStencilItem,item.type)}function clearStencilToolStatus(type){if(type){var st=_.find($scope.stencilTools,(function(item){return item.type===type}));st&&(st.active=!1)}else _.each($scope.stencilTools,(function(item){item.active=!1}))}!0===window.isInIframe&&rootScopeonshowAutoLinkTip&&rootScopeonshowAutoLinkTip()}function link($scope,$element){var resize={width:-1};var watchWidth=null;function changeMenuVisible(width){var toolWidth=resize.toolDivWidth;var otherWidth=resize.otherDivWidth;var stencilMenuWidth=resize.stencilMenuWidth;var stencilMoreWidth=resize.stencilMoreWidth;var baseWidth=toolWidth+(otherWidth>490?otherWidth:490)+40+80;if(width<baseWidth)if(width<baseWidth-stencilMenuWidth-stencilMoreWidth)resize.otherDiv.hide();else if(width<baseWidth-stencilMenuWidth){resize.stencilMenu.hide();resize.stencilMore.hide();resize.otherDiv.show()}else{resize.stencilMenu.hide();resize.stencilMore.show();resize.otherDiv.show()}else{resize.stencilMenu.show();resize.stencilMore.show();resize.otherDiv.show()}}function getWidth(){if(resize.barDiv&&resize.barDiv.length>0){var barWidth=resize.barDiv.width();var navWidth=resize.navDiv.width();barWidth&&navWidth&&(resize.width=barWidth-navWidth)}return resize.width}function onResize(){changeMenuVisible(getWidth())}var throttledOnResize=onResize;$scope.$on("stencilToolMenuFinish",(function(){!function(){var barDiv=$element.closest(".map-top-bar");resize.barDiv=barDiv;resize.navDiv=barDiv.find(".nav");resize.toolDiv=barDiv.find(".map-tool");resize.toolDivWidth=barDiv.find(".map-tool").width();resize.otherDiv=barDiv.find(".other-tool");resize.otherDivWidth=barDiv.find(".other-tool").width();var stencilMenuWidth=0;_.each(resize.otherDiv.find(".map-top-bar-stencil-menu"),(function(item){stencilMenuWidth+=angular.element(item).width()}));resize.stencilMenuWidth=stencilMenuWidth>0?stencilMenuWidth:108;resize.stencilMenu=resize.otherDiv.find(".map-top-bar-stencil-menu");var stencilMoreWidth=resize.otherDiv.find(".map-top-bar-stencil-more").width();resize.stencilMoreWidth=stencilMoreWidth>0?stencilMoreWidth:55;resize.stencilMore=resize.otherDiv.find(".map-top-bar-stencil-more");resize.mapId=$scope.activeMap.getDocId()}();var width=getWidth();-1!==width&&changeMenuVisible(width);resize.barDiv.resize(throttledOnResize);watchWidth=$scope.$watch((function(){return resize.barDiv.width()}),(function(){onResize()}))}));$scope.$on("$destroy",(function(){watchWidth&&watchWidth();resize.barDiv&&resize.barDiv.unbind("resize",throttledOnResize)}))}return directive}}(NetBrain);!function(netBrain){angular.module("nb.qmap").directive("nbMapZoomNewDirective",[function(){return{restrict:"E",templateUrl:"modules/nbQmap/views/nbMapZoomNew.html",scope:{},link:function(scope,element,attrs){},controller:["$scope","$rootScope","$element","$attrs","$timeout","nb.qmap.mapManagerSrvc",function($scope,$rootScope,element,attr,$timeout,mapManagerSrvc){$scope.zoom={zoomValue:100,zoomStep:10};$scope.activePage=mapManagerSrvc.getActivePage();$scope.zooming=!1;$scope.slider={options:{stop:function(event,ui){$scope.zoomChanged(event,ui)},start:function(event,ui){ui&&ui.value&&(ui.value=$scope.zoom.zoomValue)},orientation:"horizontal",min:0,max:500}};function deactivateTextblock(diagram){diagram.currentTool.isActive&&diagram.currentTool.doDeactivate()}$scope.resizeSelected=function(){var curNetMap=$scope.activePage;if(null!=curNetMap){var diagram=curNetMap.getGoJsDiagram();if(null!=diagram){diagram.commandHandler.zoomToFitScreen();deactivateTextblock(diagram);var zoomValue=Math.floor(100*diagram.scale);$scope.zoom.zoomValue=zoomValue}}};$scope.zoomOut=function(event){$scope.zooming=!0;var zoomValue=$scope.zoom.zoomValue/100;if(zoomValue>0){var curNetMap=$scope.activePage;if(null==curNetMap)return;var diagram=curNetMap.getGoJsDiagram();if(null==diagram)return;var currMapOption=$scope.activePage.getMapViewOptionJson();diagram.commandHandler.centerZoomPoint();diagram.commandHandler.setCusZoomSetp(currMapOption.step);diagram.commandHandler.decreaseZoom();deactivateTextblock(diagram);zoomValue-=currMapOption.step;(zoomValue*=100)<10&&(zoomValue=10);$scope.zoom.zoomValue=zoomValue;$scope.zoom.zoomStep=100*currMapOption.step;event.stopPropagation()}};$scope.zoomIn=function(event){$scope.zooming=!0;var zoomValue=$scope.zoom.zoomValue/100;if(Math.round(100*zoomValue)<500){var curNetMap=$scope.activePage;if(null==curNetMap)return;var diagram=curNetMap.getGoJsDiagram();if(null==diagram)return;var currMapOption=$scope.activePage.getMapViewOptionJson();diagram.commandHandler.centerZoomPoint();diagram.commandHandler.setCusZoomSetp(currMapOption.step);diagram.commandHandler.increaseZoom();deactivateTextblock(diagram);zoomValue+=currMapOption.step;(zoomValue*=100)>500&&(zoomValue=500);$scope.zoom.zoomValue=zoomValue;$scope.zoom.zoomStep=100*currMapOption.step;event.stopPropagation()}};$scope.zoomChanged=function(event,ui){var curNetMap=$scope.activePage;if(null!=curNetMap){var diagram=curNetMap.getGoJsDiagram();if(null!=diagram){var zoomValue=ui.value;zoomValue<10&&(zoomValue=10);$scope.zoom.zoomValue=zoomValue;diagram.commandHandler.centerZoomPoint();diagram.commandHandler.resetZoom(zoomValue/100);deactivateTextblock(diagram);event.stopPropagation()}}};var init=function(){$timeout((function(){$scope.activePage=mapManagerSrvc.getActivePage();var curPage=$scope.activePage;var zoomValue=100*curPage.getSpace();var dZoomStep=100*curPage.getMapViewOptionJson().step;var diagram=curPage.getGoJsDiagram();diagram&&diagram.commandHandler.setCusZoomSetp(dZoomStep/100);zoomValue>500&&(zoomValue=500);$scope.zoom.zoomValue=zoomValue;$scope.zoom.zoomStep=dZoomStep}),0)};init();var unRegisterZoomBarCallback=$rootScope.$on(netMapEvent.changeZoomBar,(function(event,args){init()}));var rootScopeonActivePageChanged=$rootScope.$on(netBrain.Map.Event.ActivePageChanged,(function(event,args){init()}));var unRegisterZoomStepCallback=$rootScope.$on(netMapEvent.setZoomStep,(function(event,args){var dZoomStep=.25;null!=args&&args.length>0&&(dZoomStep=args[0]);$scope.zoom.zoomStep=100*dZoomStep}));$scope.$on("$destroy",(function(){unRegisterZoomStepCallback();unRegisterZoomBarCallback();rootScopeonActivePageChanged()}))}]}}])}(NetBrain);NetBrain,angular.module("nb.qmap").directive("nbLinkLineFigureDirective",(function(){var directive={restrict:"E",replace:!0,controller:controller,scope:{linkLineType:"@",strokeColor:"@",width:"@",strokeDashArray:"@",isCustomStyle:"@",linkType:"@"},templateUrl:"modules/nbQmap/views/nbLinkLineFigureDirective.html",link:function(scope,element,arrt){}};controller.$inject=["$scope","$timeout","$rootScope","$q"];function controller($scope,$timeout,$rootScope,$q){$scope.linkTypeObj=JSON.parse($scope.linkType)}return directive}));!function(){angular.module("nb.qmap").directive("nbMapContextMenu2",nbMapContextMenu);nbMapContextMenu.$inject=["$document","$rootScope","nb.qmap.mapContextMenuSrvc"];function nbMapContextMenu($document,$rootScope,mapContextMenuSrvc){var directive={restrict:"EA",controller:controller,link:function(scope,element,arrt){}};controller.$inject=["$scope","$element","$attrs"];function controller($scope,$element,$attrs){$document.bind("contextmenu",(function(event){!function(event,menuElement){var doc=$document[0].documentElement;var docLeft=(window.pageXOffset||doc.scrollLeft)-(doc.clientLeft||0),docTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0),elementWidth=menuElement[0].scrollWidth,elementHeight=menuElement[0].scrollHeight;var docWidth=doc.clientWidth+docLeft,docHeight=doc.clientHeight+docTop,totalWidth=elementWidth+event.pageX,totalHeight=elementHeight+event.pageY,left=Math.max(event.pageX-docLeft,0),top=Math.max(event.pageY-docTop,0);totalWidth>docWidth&&(left-=totalWidth-docWidth);totalHeight>docHeight&&(top-=totalHeight-docHeight);menuElement.css("top",top+"px");menuElement.css("left",left+"px")}(event,mapContextMenuSrvc.element())}));var rootScopeonpageContextClicked=$rootScope.$on("pageContextClicked",(function(event,toptype){var options={};options.activeNode=null;options.isMultiSelected=!1;mapContextMenuSrvc.open(options)}));var rootScopeondeviceContextClicked=$rootScope.$on("deviceContextClicked",(function(event,activeNode,isMulti){var options={};options.activeNode=activeNode;options.isMultiSelected=isMulti;mapContextMenuSrvc.open(options)}));$scope.$on("$destroy",(function(){rootScopeonpageContextClicked();rootScopeondeviceContextClicked()}))}return directive}}(NetBrain);!function(netBrain){angular.module("nb.qmap").directive("nbDesignReader",nbDesignReader);nbDesignReader.$inject=["$rootScope","$uibModal","$document","$timeout","nb.dataview.aceEditInitSrvc","nb.netbrain.dataViewCacheSrvc","$q","nb.qmap.httpMapSrvc","nb.ng.userSrvc","nb.qmap.updateMapSrvc","nb.qmap.mapManagerSrvc","nb.common.cacheConfigSrvc","nb.nbfilesearch.designReaderSrvc","nb.common.cacheInterfaceInfoSrvc","nb.ng.deviceAccessCacheSrvc"];function nbDesignReader($rootScope,$uibModal1,$document,$timeout,aceEditInitSrvc,dataViewCacheSrvc,$q,httpMap,userSrvc,updateMapSrvc,mapManagerSrvc,cacheConfigSrvc,designReaderSrvc,cacheInterfaceInfoSrvc,deviceAccessCacheSrvc){var directive={restrict:"EA",scope:{optionsOut:"=",isShow:"="},transclude:!0,templateUrl:"modules/nbQmap/views/nbDesignReader.html",controller:controller,link:function(scope,element,attr){},replace:!0};g_DesignReaderTipRule.HasRefresh()||designReaderSrvc.GetDesignReaderOption().then((function(designReaderTipOption){if(designReaderTipOption){var designReaderTipTitleMap=designReaderTipOption.m_DesignReaderTipTitleMap;var unitMaxLinesMap=designReaderTipOption.m_unitMaxLinesMap;var unitPrefixMap=designReaderTipOption.m_unitPrefixMap;var devSubTypeParaStartSplitStringMap=designReaderTipOption.m_devSubTypeParaStartSplitString;var devSubTypeParaEndSplitStringMap=designReaderTipOption.m_devSubTypeParaEndSplitString;var devSubTypeInputFilterMap=designReaderTipOption.m_nDevSubTypeInputFilter;var devSubTypeOutputFilterMap=designReaderTipOption.m_nDevSubTypeOutputFilter;var miscOption=designReaderTipOption.m_MiscOption;designReaderTipTitleMap&&g_DesignReaderTipRule.SetDesignReaderTipRuleTitleMap(designReaderTipTitleMap);unitMaxLinesMap&&g_DesignReaderTipRule.SetDesignReaderTipRuleMaxLine(unitMaxLinesMap);unitPrefixMap&&g_DesignReaderTipRule.SetDesignReaderTipRulePrefixMap(unitPrefixMap);devSubTypeParaStartSplitStringMap&&g_DesignReaderTipRule.SetDesignReaderParaStartSplitMap(devSubTypeParaStartSplitStringMap);devSubTypeParaEndSplitStringMap&&g_DesignReaderTipRule.SetDesignReaderParaEndSplitMap(devSubTypeParaEndSplitStringMap);devSubTypeInputFilterMap&&g_DesignReaderTipRule.SetDesignReaderInputFilterMap(devSubTypeInputFilterMap);devSubTypeOutputFilterMap&&g_DesignReaderTipRule.SetDesignReaderOutputFilterMap(devSubTypeOutputFilterMap);miscOption&&g_DesignReaderTipRule.SetDesignReaderMiscOption(miscOption)}}));controller.$inject=["$scope","$element","$attrs","$uibModal","nb.netbrain.httpDeviceSrvc","nb.ng.httpAuthSrvc","nb.ng.utilitySrvc","nb.topo.httpTopoSrvc","nb.deviceDetail.httpDeviceDetailSrvc"];function controller($scope,element,attr,$uibModal,httpDeviceSrvc,httpAuthSrvc,utilitySrvc,httpTopoSrvc,httpDeviceDetailSrvc){$scope.options=angular.copy($scope.optionsOut);$scope.loading=!1;$scope.title="";$scope.configContentData="";$scope.oldDRContent="";$scope.oldDRTitle="";$scope.SelectText="";$scope.isShowDownload=!1;var closeTimer=null;$scope.settings=[];$scope.cancelClose=!1;$scope.aceOption_configFile={onLoad:function(_ace){$scope.aceEditor_configFile=_ace;aceEditInitSrvc.initAceEditor($scope.aceEditor_configFile);$scope.aceEditor_configFile.setTheme("ace/theme/kuroir");$scope.aceEditor_configFile.setReadOnly(!0)}};$scope.buttonDisabled=!1;$scope.deviceAccessCallback=function(hasRight,hasRightDevArr,noRightDevArr,element){$scope.buttonDisabled=!hasRight};var addSelectNoteMenu=element.find(".content").find(".selectnotecontainer");var divContent=element.find(".content");var divLoadmore=element.find(".m-loadmore");var btnNote=element.find(".header").find(".note");var canRun=!0;var hasPinned=!1;$scope.searchOption={searchText:"",isMatchWord:!1};$scope.aceSearchOption={filterText:function(){return $scope.searchOption.searchText},matchWholeWord:function(){return!1},highlightAllWhenNext:!0,editor:function(){return $scope.aceEditor_configFile},onFilterResult:function(result){console.warn(result)}};$scope.isFullConfig="";$scope.hasSummary=!0;$scope.userResize=!1;$scope.isFirstShow=!1;function _getDetailDataParams(devId){return{sourceType:netBrain.DeviceDetail.DataFolder.CurrentBaseline,devId:devId,widthData:!1}}var getConfigContentData=function(devId){return cacheConfigSrvc.getData(devId).then((function(objResult){$scope.configContentData=objResult.content;$scope.deviceId=objResult.devId;$scope.isShowDownload=!1===objResult.isAllLoaded}),(function(reason){$scope.configContentData=NetBrain.Map.Message.DesinReaderNoMatched;console.error(reason)}))};$scope.closeConfigExportTip=function(){divLoadmore.hide()};$scope.exportMoreConfigData=function(){var params=_getDetailDataParams($scope.deviceId?$scope.deviceId:$scope.options.drData.deviceId);httpDeviceDetailSrvc.getConfigFileDataList(params).then((function(data){data&&data.summary&&data.summary.length>0&&httpDeviceDetailSrvc.export(data.summary[0].location).then((function(){$scope.closeConfigExportTip()}))}))};$scope.closeWindow=function(){hasPinned=!1;canRun=!1;element.remove();$scope.$parent.closeL2PortTip(250);$scope.$destroy()};var hideAddNoteMenu=function(isAni,showSelectNote){$scope.SelectText="";isAni?addSelectNoteMenu.fadeOut("fast"):addSelectNoteMenu.hide();!0!==showSelectNote&&$scope.showSelectBtnInHeader(!1)};$scope.showSelectBtnInHeader=function(showSelectBtn){var noteBtn=element.find(".note");if(noteBtn.hasClass("note_02")&&!0===showSelectBtn){noteBtn.removeClass("note_02").addClass("icon_nb_map_add_device_note_16");noteBtn.attr("title","Create Note with Selected Content")}if(!1===showSelectBtn&&noteBtn.hasClass("icon_nb_map_add_device_note_16")){noteBtn.removeClass("icon_nb_map_add_device_note_16").addClass("note_02");noteBtn.attr("title","Create Note with All Content")}};function open(position,el){hideAddNoteMenu(!0,!1);$scope.oldDRContent="";$scope.oldDRTitle="";$scope.curShowFullConfig=!1;closeTimer&&$timeout.cancel(closeTimer);$scope.$parent.closeL2PortTip(250);$scope.hasNoData=!1;if(!$scope.loading){$scope.loading=!0;deviceAccessCacheSrvc.getDAPArray([$scope.options.drData.deviceId],1).then((function(res){if(!res||res&&res.length>0&&!res[0]){$scope.buttonDisabled=!0;$scope.options.resultCount=0;el.find(".popout-icon").hide();try{el.dialog("open")}catch(e){}setPos(position,el);showContent(element,!0,1);setContentHeight($scope.dzContent,element)}else getConfigContentData($scope.options.drData.deviceId).then((function(){if($scope.isShowDownload){el.find(".popout-icon").hide();el.dialog("open");setPos(position,el)}cacheInterfaceInfoSrvc.getData($scope.options.drData.intf).then((function(intfData){console.log("function, getConfigContentData, if intfData is empty, it will be not find anything.",$scope.options.drData.intf,intfData);var conf=$scope.configContentData;var bIsInfLabel=null==$scope.options.drData.clickUnit;var labelString=$scope.options.drData.labelString;if(!bIsInfLabel){var subPos=-1;$scope.options.drData.clickUnit.prefix&&(subPos=labelString.toLowerCase().indexOf($scope.options.drData.clickUnit.prefix.toLowerCase()));subPos>=0&&(""===(labelString=(labelString=labelString.substring(subPos+$scope.options.drData.clickUnit.prefix.length)).trim())?labelString=$scope.options.drData.clickUnit.value:":"===labelString[0]&&(labelString=labelString.substring(1,labelString.length)))}var deviceMainType=$scope.options.drData.devMainType;var deviceSubType=$scope.options.drData.devType;var infShortName=intfData.JsonObj.shortName||"";var infFullName=intfData.JsonObj.name||"";var labelSchemaObj=$scope.options.drData.clickUnit;try{designReaderSrvc.DoDesignSearch(conf,bIsInfLabel,labelString,deviceMainType,deviceSubType,infShortName,infFullName,labelSchemaObj,$scope.options.drData.intf,$scope.options.drData.hostname)}catch(e){console.warn(e)}var resultCount=designReaderSrvc.GetCountOfSearchResult();$scope.options.resultCount=resultCount;el.find(".popout-icon").hide();try{el.dialog("open")}catch(e){}setPos(position,el);showContent(element,!0,1);setContentHeight($scope.dzContent,element)}))}))}))}}function setPos(position,el){var doc=angular.element(".pageContent");var docOffset=doc.offset();var docLeft=doc.scrollLeft()-docOffset.left,docTop=doc.scrollTop()-docOffset.top,elementWidth=el.width(),elementHeight=el.height();var docWidth=doc.width()+doc.scrollLeft(),docHeight=doc.height()+doc.scrollTop(),left=position.x+docLeft,top=position.y+docTop,totalWidth=elementWidth+left,totalHeight=elementHeight+top;var rightWidth=doc.find(".right-pane").width();top-=25;left+=5;totalWidth>docWidth-rightWidth&&(left=left-(totalWidth-docWidth)-rightWidth);totalHeight>docHeight&&(top=top-(totalHeight-docHeight)-2);el.parent().css({top:top+"px",left:left+"px"})}$scope.upResult=function(){if(!$scope.loading){$scope.loading=!0;var c=$scope.options.current;var rc=$scope.options.resultCount;1===c?c=rc:c--;showContent(element,!1,c);!1===$scope.userResize&&setContentHeight($scope.dzContent,element)}};function showContent(ele,isOpen,index){$scope.options.current=index;var hasData=!1;var ret;try{ret=designReaderSrvc.GetSearchResultByIndex(index-1);hasData=!0}catch(e){hasData=!1}$scope.loading=!1;if(hasData&&ret&&ret.contentArr&&ret.contentArr.length>0){$scope.title=ret.title;$scope.options.drData&&$scope.options.drData.clickUnit&&$scope.options.drData.clickUnit.displayName&&($scope.title=$scope.options.drData.clickUnit.displayName);$scope.dzContent="";$scope.settings=[];var rows=0;var dzContent="";for(var posKey in ret.contentArr)if(ret.contentArr.hasOwnProperty(posKey)){var oneContentObj=ret.contentArr[posKey];dzContent+=oneContentObj.configLet;dzContent+="\r\n";for(var i=0;i<oneContentObj.wordPosPairArr.length;i++){var pos=oneContentObj.wordPosPairArr[i];pos.lineIndex+=rows;$scope.settings.push(pos)}rows+=oneContentObj.configLet.split("\n").length+1}var tempContent=dzContent.trimRight("\r\n");-1===_.indexOf(tempContent,"\n")&&(tempContent+="\n");$scope.dzContent=tempContent;$timeout((function(){var needSetH=!1;if(isOpen){element.find(".dr-summary").show();if($scope.options.resultCount<2){$scope.hasSummary=!1;hideSummary()}else needSetH=!0}else needSetH=!0;if(needSetH){var t=ele.find(".ace_scrollbar-v").position().top;var innerV=ele.find(".ace_scrollbar-v").find(".ace_scrollbar-inner");var h=innerV.height()+Math.abs(t)+"px";innerV.css({height:h})}}),0)}else{$scope.title="Design Reader";$scope.dzContent=NetBrain.Map.Message.DesinReaderNoMatched;$timeout((function(){$scope.hasSummary=!1;hideSummary()}),0)}}function hideSummary(){element.find(".dr-summary").hide();element.find(".content").css({height:"calc(100% - 0px)"});element.find(".textCon").css({"margin-top":"0px"});element.find(".ace_scrollbar-v").css({top:"0px"})}$scope.downResult=function(){if(!$scope.loading){$scope.loading=!0;var c=$scope.options.current;c===$scope.options.resultCount?c=1:c++;showContent(element,!1,c);!1===$scope.userResize&&setContentHeight($scope.dzContent,element)}};element.on("click",(function(){if(!hasPinned){!0===canRun&&doPinned();canRun=!0}}));function doPinned(){hasPinned=!0;element.parent().resizable({minHeight:90,minWidth:400,maxHeight:600,maxWidth:600,handles:"se, sw, nw",cancel:".close",stop:function(event,ui){event.preventDefault();event.stopPropagation();ui.element.find(".dr-summary").find(".dr-remark").css("max-width",ui.size.width-80+"px");canRun=!1},resize:function(event,ui){$scope.userResize=!0}});element.find(".dr-close").show()}function setContentHeight(content,el){var rowCount=content.split("\n").length;element.find(".header").height();var sh=0;!0===$scope.hasSummary&&(sh=element.find(".dr-summary").height());var height=18*rowCount+sh+22;rowCount>7&&(height=235);el.parent().css({height:height+2+"px"})}function close(timeSpan){closeTimer=$timeout((function(){if(!0!==hasPinned)if($scope.cancelClose)$scope.cancelClose=!1;else{element.remove();hideAddNoteMenu(!1,!1);$scope&&$scope.$parent&&_.isFunction($scope.$parent.closeL2PortTip)&&$scope.$parent.closeL2PortTip(timeSpan);try{$scope.$destroy()}catch(e){console.log("destroy drt err:",e)}}}),timeSpan)}var watchOptionsIsShow=$scope.$watch("options.isShow",(function(value){$scope.isFirstShow=!0;if(!0===value.isRealShow){open($scope.options.position,element);revisePos()}}));var watchIsShowFunction=$scope.$watch("isShow",(function(value){if(!0!==$scope.isFirstShow){if(!1===value.isRealShow){if(null!=value.data){if(!0===value.data.showExtendNbrDialog&&hasPinned)return;if(!0===value.data.linkLabelMouseLeave&&hasPinned)return}hasPinned=!1;close(1e3)}else if(!0===value.isRealShow){element.is(":hidden")&&open($scope.options.position,element);revisePos()}}else $scope.isFirstShow=!1}));function revisePos(){var doc=angular.element(".pageContent");var elPos=element.parent().position();(elPos.left>doc.width()||elPos.top>doc.Height)&&setPos($scope.options.position,element)}$scope.$on("$destroy",(function(){watchOptionsIsShow();watchIsShowFunction()}));element.on("mouseenter",(function(){$scope.$parent.resetLinkLabelColor();if(closeTimer){$scope.cancelClose=!0;$timeout.cancel(closeTimer)}}));element.on("mouseleave",(function(){if(!0!==hasPinned){$scope.cancelClose=!1;close(250)}}));divContent.on("mouseup",(function(arg){if(!$(arg.target).hasClass("ace_scrollbar")&&"A"!==arg.target.tagName&&1===arg.which){canRun=!1;$timeout((function(){var selectContent=$scope.aceEditor_configFile.selection.doc.getTextRange($scope.aceEditor_configFile.selection.getRange());if(selectContent){$scope.SelectText=selectContent;var pos=function(arg){var brother=element.find(".textCon");var ul=element.find(".selectnote");var pos={left:0,top:0};var top=0,left=0;top=brother.offset().top+brother.height()>arg.pageY+ul.height()+16?arg.pageY-brother.offset().top:arg.pageY-ul.height()-brother.offset().top;left=brother.offset().left+brother.width()>arg.pageX+ul.width()+16?arg.pageX-brother.offset().left:arg.pageX-brother.offset().left-ul.width();pos.left=left;pos.top=top;return pos}(arg);addSelectNoteMenu.css({left:pos.left,top:pos.top});addSelectNoteMenu.fadeIn("fast");$scope.showSelectBtnInHeader(!0)}else{$scope.SelectText="";hideAddNoteMenu(!1,!1);doPinned()}}),300)}}));!function(el){el.dialog({autoOpen:!1,appendTo:"#realPage-"+NetBrain.Map.currentActiveMapPage.getDocId()+"-container",resizable:!1,dialogClass:"design-reader-float-outer",draggable:!0,minHeight:96,minWidth:400,maxHeight:600,maxWidth:600,open:function(event){var tar=$(event.target);tar.css({height:"100%",width:""});tar.parent().css({"min-height":"98px",width:"","min-width":"402px"})},resizeStop:function(){$scope.userResize=!0},dragStop:function(event,ui){console.warn(event,ui)}});el.parent().draggable({cursor:"pointer",cancel:".content, .dr-summary",handle:".header",containment:".realActive .map-canvas-containter",scroll:!1,activate:function(event){event.preventDefault();event.stopPropagation();canRun=!1}})}(element);divContent.on("mousedown",(function(event){$(event.target).hasClass("selectnote")||hideAddNoteMenu(!0,!1)}));$scope.addNote=function(isSelectTextToNote,event){updateMapSrvc.canUpdateCurrentMap().then((function(){var netmapOperator=mapManagerSrvc.getActivePage().getNetmapOperator();var content="";var showSelectNote=!1;$scope.SelectText=$scope.aceEditor_configFile.selection.doc.getTextRange($scope.aceEditor_configFile.selection.getRange());if(isSelectTextToNote){content=$scope.SelectText;showSelectNote=!0}else if(btnNote.hasClass("icon_nb_map_add_device_note_16")>0){content=$scope.SelectText;showSelectNote=!0}else content=$scope.dzContent;var devId=$scope.options.drData.siteID||$scope.options.drData.deviceId;var noteObj={title:'Config Let of "'+$scope.options.drData.hostname+'"',content:content,user:userSrvc.getUserName(),time:new Date,noteFromType:netBrain.Map.Const.NoteFromType.Normal};netmapOperator.mergeDeviceNoteRefDevice(devId,noteObj);$scope.SelectText="";hideAddNoteMenu(!0,showSelectNote)}));event.stopPropagation()};$scope.curShowFullConfig=!1;$scope.viewFullConfig=function(event){event.preventDefault();event.stopPropagation();hideAddNoteMenu(!1,!1);if($scope.curShowFullConfig){divLoadmore.hide();element.find(".popout-icon").hide();$scope.curShowFullConfig=!1;$scope.dzContent=$scope.oldDRContent;$scope.title=$scope.oldDRTitle;!1===$scope.userResize&&setContentHeight($scope.dzContent,element);$scope.isFullConfig="";if(!0===$scope.hasSummary){element.find(".dr-summary").show();element.find(".content").css({height:""});element.find(".textCon").css({"margin-top":""});element.find(".ace_scrollbar-v").css({top:""})}}else{doPinned();hideSummary();getConfigContentData($scope.options.drData.deviceId).then((function(){$scope.isShowDownload&&divLoadmore.show();$scope.oldDRContent=$scope.dzContent;$scope.oldDRTitle=$scope.title;$scope.dzContent=$scope.configContentData.trimRight("\r\n");!1===$scope.userResize&&setContentHeight($scope.dzContent,element);$scope.title="Full Config";$scope.curShowFullConfig=!0;$scope.isFullConfig="active";element.find(".popout-icon").show()}),(function(reason){$scope.dzContent="Can't get data";console.error(reason)}))}};$scope.showConfigurationFile=function(event){event.preventDefault();event.stopPropagation();if($(event.target).hasClass("popout-icon")){var did=$scope.options.drData.deviceId;var dit=$scope.options.drData.devType;httpDeviceSrvc.getDomainListByDevIdList([did]).then((function(){$uibModal.open({templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",backdrop:"static",resolve:{args:function(){var args={};args.isConfigFile=!0;args.deviceId=did;args.deviceType=dit;args.dataType=DeviceDataType.Config;args.isOpenFromMap=!0;return args}}})}))}}}return directive}}(NetBrain);!function(){angular.module("nb.qmap").controller("nb.qmap.nbSwitchVisualSpaceSelect",nbSwitchVisualSpaceSelect);nbSwitchVisualSpaceSelect.$inject=["$scope","$q","$document","$element","nb.netbrain.dataViewCacheSrvc","dialogService","nb.qmap.updateMapSrvc","nb.qmap.mapManagerSrvc","nb.topo.httpExternNbrSrvc","nb.qmap.autoLinkOptionSrvc","nb.common.nbAlertSrvc","nb.dataview.applyDataViewSrvc","nb.sdn.httpSdnSrvc"];function nbSwitchVisualSpaceSelect($scope,$q,$document,$element,dataViewCacheSrvc,dialogService,updateMapSrvc,mapManagerSrvc,httpExternNbrSrvc,autoLinkOptionSrvc,nbAlertSrvc,applyDataViewSrvc,httpSdnSrvc){$scope.__dialogService=dialogService;$scope.__dialogId=$scope.model.dialogId;$scope.__openWay=$scope.model.openWay;$scope.__target=$scope.model.target;$scope.hostName=function(target){if(null==target||null==target.part||null==target.part.data||null==target.part.data.hostName)return"";return target.part.data.hostName}($scope.model.target);$scope.__listDataViewGroup=$scope.model.listDataViewGroup;$scope.relatedVisualSpaceInfos=null;$scope.curSwitchVisualSpaceInfo=null;$scope.getRelatedVisualSpaceInfo=function(){$scope.relatedVisualSpaceInfos=[];updateMapSrvc.canUpdateCurrentMap().then((function(){var visualSpaceOp=mapManagerSrvc.getActivePage().getNetmapOperator().getVisualSpaceOp();visualSpaceOp&&visualSpaceOp.getRelatedVisualSpaceInfo(httpSdnSrvc,$scope.__target).then((function(info){info.result=info.result||{};$scope.relatedVisualSpaceInfos=info.result.relatedVisualSpaceInfos||[]}))}))};$scope.closeDialog=function(){$scope.switchVisualSpaceInfo();$scope.__dialogService.close($scope.__dialogId)};$scope.switchVisualSpaceInfo=function(){var selectedSwitchVisualSpaces=$scope.getSelectSwitchs();selectedSwitchVisualSpaces.length<1||updateMapSrvc.canUpdateCurrentMap().then((function(){var visualSpaceOp=mapManagerSrvc.getActivePage().getNetmapOperator().getVisualSpaceOp();if(visualSpaceOp){var vsNodeIdentifies=$scope.buildVSNodeIdentify(selectedSwitchVisualSpaces);visualSpaceOp.switchVisualSpace({q:$q,httpSdnSrvc:httpSdnSrvc,autoLinkOptionSrvc:autoLinkOptionSrvc,nbAlertSrvc:nbAlertSrvc},{vsNodeIdentifies:vsNodeIdentifies,listDataViewGroup:$scope.__listDataViewGroup}).then((function(newNetMap){newNetMap&&mapManagerSrvc.switchMapPage(newNetMap.getDocId())}),(function(){}))}}))};$scope.getSelectSwitchs=function(){var selectedSwitchVisualSpaces=[];angular.forEach($scope.relatedVisualSpaceInfos,(function(template){template.selected&&selectedSwitchVisualSpaces.push(template)}));return selectedSwitchVisualSpaces};$scope.buildVSNodeIdentify=function(selectedSwitchVisualSpaces){var vsNodeIdentifies=[];var relatedVisualSpaceInfos=selectedSwitchVisualSpaces||$scope.getSelectSwitchs();if(relatedVisualSpaceInfos.length<1)return vsNodeIdentifies;_.forEach(relatedVisualSpaceInfos,(function(relatedVisualSpaceInfo){relatedVisualSpaceInfo.nodeItems&&_.forEach(relatedVisualSpaceInfo.nodeItems,(function(item){vsNodeIdentifies.push({id:item.id,nodeIdentify:item.nodeIdentify,visualSpaceInfo:relatedVisualSpaceInfo.visualSpaceInfo})}))}));return vsNodeIdentifies};$scope.OnSelectedItemChanged=function(template){var selectedVisualSpace=$scope.getSelectSwitchs()||[];_.each(selectedVisualSpace,(function(otherTemplate){template.visualSpaceInfo.visualSpaceInstanceId!=otherTemplate.visualSpaceInfo.visualSpaceInstanceId&&_.find(template.nodeItems||[],(function(nodeItem){return _.find(otherTemplate.nodeItems,(function(otherNodeItem){return otherNodeItem.id==nodeItem.id}))}))&&(otherTemplate.selected=!1)}))};$scope.OnDbClick=function(template){template.selected=!0;$scope.OnSelectedItemChanged(template);$scope.closeDialog()};$scope.relatedVisualSpaceInfos=$scope.getRelatedVisualSpaceInfo()}}(NetBrain);!function(){angular.module("nb.qmap").directive("nbDesktopMapPreviewDirective",nbDesktopMapPreview);nbDesktopMapPreview.$inject=[];function nbDesktopMapPreview(){var directive={restrict:"EA",scope:{file:"=",close:"&",options:"="},templateUrl:"modules/nbQmap/views/nbDesktopMapPreview.html",controller:controller,link:function(scope,element,attr){}};controller.$inject=["$scope","$q","nb.qmap.httpMapSrvc"];function controller($scope,$q,mapSrvc){$scope.$watch("file",(function(newVal){if(newVal){$scope.preview={originalId:(file=newVal).originalId,name:file.name,pageCount:0,type:file.type,icon:file.icon,editor:file.operateInfo.opUser,opTime:file.operateInfo.opTime,pathStr:file.path.join(" > ")};!function(preview){imageSrc=[];imageIndex=0;var promise=mapSrvc.getMapThumbnails(preview.originalId);var promise2=mapSrvc.getMapPropertyByKey(preview.originalId);$q.all([promise,promise2]).then((function(data){var images=[];if(data[0].docPngList&&data[0].docPngList.length>0){$scope.preview.pageCount=data[0].docCount;_.each(data[0].docPngList,(function(item){images.push(item.image)}));if(images.length>0){_.each(images,(function(img){var matched=img.match(/src=[\'\"]?([^\'\"]*)[\'\"]?/i)||[];matched.length>1?imageSrc.push(matched[1]):img&&0===img.indexOf("data:")&&imageSrc.push(img)}));preview.imgSrc=imageSrc[0]}data[1].editRight;var editor=data[1].editor;editor&&editor.opUserId?preview.editor=data[1].updatedBy:preview.editor="no one";preview.opTime=data[1].modifyTm;$scope.preview=preview;$scope.canNext=canNext();$scope.canPrev=canPrev()}}))}($scope.preview)}var file}));$scope.openMap=function(){$scope.$emit(NetBrain.NetworkOS.Events.OPEN_FILE);$scope.close()};$scope.prev=function(event){event.preventDefault();event.stopPropagation();if(!canPrev())return;imageIndex--;$scope.preview.imgSrc=imageSrc[imageIndex];$scope.canNext=canNext();$scope.canPrev=canPrev()};$scope.next=function(event){event.preventDefault();event.stopPropagation();if(!canNext())return;imageIndex++;$scope.preview.imgSrc=imageSrc[imageIndex];$scope.canNext=canNext();$scope.canPrev=canPrev()};$scope.canPrev=!1;$scope.canNext=!1;var imageSrc=[];var imageIndex=0;function canNext(){return imageSrc.length-1>imageIndex}function canPrev(){return imageIndex>0}}return directive}}();!function(NetBrain){angular.module("nb.qmap").directive("nbInsertTableDirective",insertTableDirective);insertTableDirective.$inject=["nb.qmap.updateMapSrvc"];function insertTableDirective(updateMapSrvc){return{restrict:"EA",templateUrl:"modules/nbQmap/views/insertTableDirective.html",scope:{testOption:"=tableSelOption"},link:function(scope,element,attr){scope.rowCount=0;scope.columnCount=0;scope.showCount=!1;scope.tableSel=function(rowNum,colNum){var arr=[];for(var i=1;i<=20;i++){var iArr=[];for(var j=0;j<10;j++)iArr.push({id:[i,j].join("-"),row:i,col:j,active:!1});arr.push(iArr)}return arr}();scope.tableClick=function(cellInfo,event){updateMapSrvc.canUpdateCurrentMap().then((function(){if(cellInfo){scope.rowCount=parseInt(cellInfo.row);scope.columnCount=parseInt(cellInfo.col)+1;null!=scope.testOption&&null!=scope.testOption.tableSelClick&&scope.testOption.tableSelClick(scope.rowCount,scope.columnCount,event)}}))};scope.OnMouseOver=function(cellInfo){for(var rowIndex=0;rowIndex<scope.tableSel.length;rowIndex++)for(var cellIndex=0;cellIndex<scope.tableSel[rowIndex].length;cellIndex++)if((cellInfo1=scope.tableSel[rowIndex][cellIndex],cellInfo2=cellInfo,r1=void 0,r2=void 0,c1=void 0,c2=void 0,r1=cellInfo1.row,r2=cellInfo2.row,c1=cellInfo1.col,c2=cellInfo2.col,r1<r2&&c1<=c2||r1<=r2&&c1<c2?-1:r1===r2&&c1===c2?0:1)<=0){scope.tableSel[rowIndex][cellIndex].active=!0;scope.rowCount=rowIndex+1;scope.columnCount=cellIndex+1}else scope.tableSel[rowIndex][cellIndex].active=!1;var cellInfo1,cellInfo2,r1,r2,c1,c2};scope.OnMouseLeave=function(){for(var rowIndex=0;rowIndex<scope.tableSel.length;rowIndex++)for(var cellIndex=0;cellIndex<scope.tableSel[rowIndex].length;cellIndex++){scope.tableSel[rowIndex][cellIndex].active=!1;scope.rowCount=0;scope.columnCount=0}}}}}}(NetBrain);!function(){angular.module("nb.qmap").directive("nbExportVisioMapDirective",nbExportVisioMapDirective);nbExportVisioMapDirective.$inject=["$document","$timeout","$window","nb.dataview.aceEditInitSrvc","nb.netbrain.dataViewCacheSrvc","$q","nb.ng.userSrvc","nb.qmap.updateMapSrvc","nb.ng.utilitySrvc","nb.common.nbAlignSrvc"];function nbExportVisioMapDirective($document,$timeout,$window,aceEditInitSrvc,dataViewCacheSrvc,$q,userSrvc,updateMapSrvc,utilitySrvc,nbAlignSrvc){var directive={restrict:"EA",scope:{options:"="},templateUrl:"modules/nbQmap/views/nbExportVisioMapDirective.html",controller:controller,link:function(scope,element,attr){},replace:!0};controller.$inject=["$scope","$rootScope","$element","$attrs","nb.qmap.mapManagerSrvc","$timeout","nb.ng.httpAuthSrvc"];function controller($scope,$rootScope,element,attr,mapManagerSrvc,$timeout,httpAuthSrvc){$scope.currentMap={};$scope.isRunning=!1;$scope.selectType=1;$scope.breakHandle=null;var exportToImageTaskId="";$scope.name="Visio";$scope.onClose=function(){$scope.isShowExportVisioMap=!1};$scope.onCancel=function(){if("visio"===$scope.exportMode)mapManagerSrvc.cancelExportMapToViso();else if("image"===$scope.exportMode){$scope.isRunning&&mapManagerSrvc.cancelExportMapToImageTask(exportToImageTaskId);$scope.breakHandle&&$scope.breakHandle.resolve()}$scope.isRunning=!1};$scope.changeselectType=function(selectType){$scope.selectType=selectType};$scope.isCustomSelected=function(){var result=!0;if(3===$scope.selectType){var selectedPage=[];$(".exportvisiomap .exportVisosSelPage").each((function(index,item){item.checked&&selectedPage.push(item.value)}));0===selectedPage.length&&(result=!1)}return result};$scope.onStart=function(){"visio"===$scope.exportMode?function(){$scope.isShowExportVisioMap=!1;$scope.currentMap.doSave();var newMap=_.clone($scope.currentMap.toJson());if(2===$scope.selectType){newMap.pageList=[];var newMapPage=_.clone($scope.currentMap.getActiveNetmap().toJson());newMap.pageList.push(newMapPage)}else if(3===$scope.selectType){var selectedPage=[];$(".exportvisiomap .exportVisosSelPage").each((function(index,item){item.checked&&selectedPage.push(item.value)}));newMap.pageList=[];_.each($scope.currentMap._docList,(function(item){if(selectedPage.indexOf(item.getDocId())>-1){var newMapPage=_.clone(item.toJson());newMap.pageList.push(newMapPage)}}))}httpAuthSrvc.isValidSession().then((function(){setDownloadingPosStyle();mapManagerSrvc.exportMapToVisio(newMap,$scope.isNew).then((function(){$scope.isRunning=!1}))}),(function(){$scope.isRunning=!1}))}():"image"===$scope.exportMode&&function(){$scope.breakHandle=$q.defer();$scope.isShowExportVisioMap=!1;var activeMap=$scope.currentMap;var mapImageObj={title:activeMap.getTitle(),pagePicList:[]};var page;var pageList=activeMap.getAllPage();if(1===$scope.selectType)for(var i=0;i<pageList.length;i++){page=pageList[i];mapImageObj.pagePicList.push({title:page.getTitle(),image:page.getImageHighDefinition()})}else if(2===$scope.selectType){page=$scope.currentMap.getActiveNetmap();mapImageObj.pagePicList.push({title:page.getTitle(),image:page.getImageHighDefinition()})}else if(3===$scope.selectType){var selectedPage=[];$(".exportvisiomap .exportVisosSelPage").each((function(index,item){item.checked&&selectedPage.push(item.value)}));for(var j=0;j<pageList.length;j++){var pageId=(page=pageList[j]).getDocId();_.indexOf(selectedPage,pageId)>=0&&mapImageObj.pagePicList.push({title:page.getTitle(),image:page.getImageHighDefinition()})}}httpAuthSrvc.isValidSession().then((function(){setDownloadingPosStyle();mapManagerSrvc.startExportMapToImageTask(mapImageObj,$scope.breakHandle).then((function(result){exportToImageTaskId=result;mapManagerSrvc.exportMapToImage(exportToImageTaskId,mapImageObj.title,$scope.breakHandle).then((function(){$scope.isRunning=!1}),(function(err){$scope.isRunning=!1;console.log(err)}))}),(function(err){$scope.isRunning=!1;console.log(err)}))}),(function(){$scope.isRunning=!1}))}()};function setDownloadingPosStyle(){$scope.isRunning=!0;$scope.isRunningVisibilityHidden=!0;nbAlignSrvc.align(".exportvisiomaploading",".realActive .map-canvas-containter",{spot:nbAlignSrvc.Spots.Center,rectify:{top:-23}}).then((function(){$scope.isRunningVisibilityHidden=!1}))}$scope.onResize=function(){nbAlignSrvc.align(".exportvisiomaploading",".realActive .map-canvas-containter",{spot:nbAlignSrvc.Spots.BottomLeft,rectify:{top:-13}}).then((function(){$scope.isRunningVisibilityHidden=!1}))};var rootScopeonopenExportViso=$rootScope.$on("openExportViso",(function(event,currentMap,isNew,exportMode){$scope.selectType=1;$scope.currentMap=currentMap;$scope.isNew=isNew;$scope.isShowExportVisioMap=!0;$scope.isExportVisioMapVisibilityHidden=!0;$scope.exportMode=exportMode;"visio"===exportMode&&($scope.name="Visio");"image"===exportMode&&($scope.name="Image");nbAlignSrvc.align(".exportvisiomap",".realActive .map-canvas-containter").then((function(){$scope.isExportVisioMapVisibilityHidden=!1}));angular.element($window).on("resize",$scope.onResize);angular.element(".realActive .map-canvas-containter").on("resize",$scope.onResize)}));var rootScopeonActivePageChanged=$rootScope.$on(NetBrain.Map.Event.ActivePageChanged,(function(event,currentMap){$scope.isShowExportVisioMap=!1}));$scope.$on("$destroy",(function(){rootScopeonopenExportViso();rootScopeonActivePageChanged();angular.element($window).off("resize",$scope.onResize);angular.element(".realActive .map-canvas-containter").off("resize",$scope.onResize)}))}return directive}}(NetBrain);!function(){angular.module("nb.qmap").filter("to_trusted",["$sce",function($sce){return function(text){return $sce.trustAsHtml(text)}}]);angular.module("nb.qmap").directive("nbExportMapDirective",nbExportMapDirective);nbExportMapDirective.$inject=["$document","$timeout","$q","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.common.nbAlignSrvc","nb.qmap.httpMapSrvc","nb.qmap.mapManagerSrvc","nb.runbook.actionTaskSrvc"];function nbExportMapDirective($document,$timeout1,$q,utilitySrvc,httpAuthSrvc,nbAlignSrvc,httpMapSrvc,mapManagerSrvc1,actionTaskSrvc){var directive={restrict:"E",scope:{options:"="},transclude:!0,templateUrl:"modules/nbQmap/views/nbExportMapDirective.html",controller:controller,link:function(scope,element,attr){},replace:!0};controller.$inject=["$scope","$rootScope","$element","$attrs","$timeout","nb.qmap.mapManagerSrvc"];function controller($scope,$rootScope,element,attr,$timeout,mapManagerSrvc){$scope.isShow=!1;$scope.isExporting=!1;$scope.clickCancel=!1;$scope.canceler=null;var setFive=null;!function(el){var container=$("body");el.dialog({autoOpen:!1,appendTo:"body",resizable:!1,dialogClass:"exportmap-box-pop",draggable:!0,position:{my:"center",at:"center",of:container},containment:container,handle:".modal-header",modal:!0,open:function(){el.parent().prev().css({background:"#000",opacity:"0.5","z-index":"999"});el.parent().css({background:"#000","z-index":"999"})},resizeStop:function(){},dragStop:function(){}});el.parent().draggable({cursor:"pointer",cancel:".modal-body, .icon-container, .close",handle:".modal-header",containment:container,scroll:!1,activate:function(event){event.preventDefault();event.stopPropagation()},start:function(event,ui){console.warn(event,ui)}});$scope.activeMap=mapManagerSrvc.getActiveMap();el.dialog("open");$scope.isShow=!0;el.find(".btn-cancel").blur()}(element);$scope.closeExportMapPop=function(){element.dialog("close");$scope.isShow=!1;element.remove();$scope.$destroy()};$scope.onClickTreeNode=function(node,trvw){console.warn(node,trvw);return!1};$scope.treeData=[];$scope.ivhTreeOptions={defaultSelectedState:!1,useCheckboxes:!1,validate:!0,expandToDepth:1e3,labelAttribute:"Name",idAttribute:"ID",childrenAttribute:"children",expandedAttribute:"expanded",selectedAttribute:"selected",enableMultipleSelect:!0,nodeClickCallback:$scope.onClickTreeNode};$scope.initData=function(){$scope.mapId=element.attr("map-id");$scope.mapName=decodeURIComponent(element.attr("map-name"));var root={ID:"all_map_pages_data",Name:"All Map Pages Data",isChecked:!0,selected:!1,children:[]};!function(node){var items=[{ID:"001",Name:"A",isChecked:!1,selected:!1},{ID:"002",Name:"B",isChecked:!1,selected:!1,children:[{ID:"002-001",Name:"002-A",isChecked:!1,selected:!1},{ID:"002-002",Name:"002-B",isChecked:!1,selected:!1}]},{ID:"003",Name:"CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDD",isChecked:!1,selected:!1}];node.push(items[0]);node.push(items[1]);node.push(items[2])}(root.children);$scope.treeData.push(root);$scope.isExporting=!0;element.parent().css({top:"40%",left:"calc(50% - 144px)"});$timeout((function(){$scope.exportNow()}),500)};$scope.exportNow=function(){var cid=NgUtil.getUniqueStr();$scope.canceler=$q.defer();$scope.exportNowCid=cid;var mapSimpleObj={mapId:$scope.mapId,mapName:$scope.mapName,cid:cid};mapManagerSrvc.startExportMapTask({mapId:$scope.mapId,mapName:$scope.mapName,cid:cid},$scope.canceler).then((function(result){if(result){var count=0;setFive=setInterval((function testFinish(){count++;if($scope.clickCancel)clearInterval(setFive);else if(count>300){console.log("Failed to export the Map, please try later.",count);clearInterval(setFive);$scope.closeExportMapPop()}else{clearInterval(setFive);mapManagerSrvc.getExportMapTaskIsFinish(cid).then((function(finish){if(finish){clearInterval(setFive);mapManagerSrvc.getMapZipByTaskId(cid,mapSimpleObj,$scope.canceler).then((function(result){if($scope.clickCancel)$scope.closeExportMapPop();else if("OK"===result)$scope.closeExportMapPop();else if("CANCEL"===result)$scope.closeExportMapPop();else if("ZERO"===result)console.warn("Failed to export the Map, the map file is ZERO length.");else if("ERROR"===result.code){console.warn("Failed to export the Map.",result.error);$scope.closeExportMapPop()}}),(function(){console.log("Failed to export the Map, please try later.","zip");clearInterval(setFive);$scope.closeExportMapPop()}))}else setFive=setInterval(testFinish,2e3)}),(function(){console.log("Failed to export the Map, please try later.","status");clearInterval(setFive);$scope.closeExportMapPop()}))}}),2e3)}}))};$scope.initData();$scope.closeExportMapPop=function(){if(element[0].ownerDocument.body.contains(element[0])&&!1===$scope.clickCancel){$scope.isShow=!1;$scope.isExporting=!1;clearInterval(setFive);element.dialog("close");element.dialog("destroy");element.remove();$scope.$destroy()}};$scope.onCancelExporting=function(){if(element[0].ownerDocument.body.contains(element[0])){$scope.canceler&&$scope.canceler.resolve();$scope.clickCancel=!0;clearInterval(setFive);mapManagerSrvc.cancelExportMapById($scope.exportNowCid);$scope.isShow=!1;$scope.isExporting=!1;element.dialog("close");element.dialog("destroy");element.remove();$scope.$destroy()}};$scope.onStart=function(){$scope.isExporting=!0;element.parent().css({top:"40%",left:"calc(50% - 144px)"})};$scope.$on("$destroy",(function(){}))}return directive}}(NetBrain);!function(netBrain){angular.module("nb.qmap").directive("nbImportMapDirective",[function(){return{restrict:"E",templateUrl:"modules/nbQmap/views/nbImportMapDirective.html",scope:{importMapOptions:"="},link:function(scope,element,attrs){},controller:Controller,replace:!0}}]);Controller.$inject=["$window","$upload","$uibModal","$scope","$element","$attrs","$timeout","$rootScope","$q","$sce","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.ng.httpAuthSrvc","nb.uiframework.urlStateMgr","nb.datamodel.httpSiteSrvc","nb.networkos.fileSrvc","fileSizeUnitFilter"];function Controller($window,$upload,$uibModal,$scope,element,attr,$timeout,$rootScope,$q,$sce,nbAlertSrvc,httpMapSrvc,httpAuthSrvc,urlStateMgr,httpSiteSrvc,fileSrvc,fileSizeUnit){$scope.isImporting=!1;$scope.needShowAlert=!1;$scope.magicStep=1;$scope.data=[{no:1,name:"",status:"",size:""}];$scope.autoRename=!0;$scope.activeDomain=httpAuthSrvc.getSelectedDomains()&&httpAuthSrvc.getSelectedDomains().length>0?httpAuthSrvc.getSelectedDomains()[0]:null;$scope.importMapMsgWarning=[];$scope.importMapMsgError=[];$scope.importMapMsgFailed=[];$scope.importMapMsgSkipped=[];$scope.finishedCount=0;$scope.warningCount=0;$scope.errorCount=0;$scope.failedCount=0;$scope.skippedCount=0;$scope.uploadFileMaxSize=104857600;fileSrvc.getServerUploadLimitSize().then((function(maxSize){$scope.uploadFileMaxSize=maxSize}));$scope.gridOptions={data:"data",columnDefs:[{field:"no",displayName:"No.",width:"80",cellClass:"no",cellTemplate:getNoCellTemplate()},{field:"name",displayName:"File Name",width:"230",cellClass:"name",cellTemplate:getNameCellTemplate()},{field:"status",displayName:"Status",width:"175",cellClass:"status",cellTemplate:'<div class="ui-grid-cell-contents"><span ng-show="row.entity.isExisted">Already in current directory</span><div>'},{field:"size",displayName:"Size",width:"115",cellClass:"size",cellTemplate:('<div class="ui-grid-cell-contents"><span class="import-map-size" title="{{row.entity.size|fileSizeUnit}}">{{row.entity.size|fileSizeUnit}}</span><span ng-if="row.entity.size > grid.appScope.uploadFileMaxSize" class="validation-has-error icon_nb_error_16" uib-tooltip="{{grid.appScope.maxSizeErrorMessage}}" tooltip-placement="right" tooltip-append-to-body="true" tooltip-class="validation-error-tooltip"></span><span class="icon_nb_delete_blue_12 import-map-delete" ng-click="grid.appScope.onDelete($event, row.entity.no)"></span></div>','<div class="ui-grid-cell-contents"><span class="import-map-size" title="{{row.entity.size|fileSizeUnit}}">{{row.entity.size|fileSizeUnit}}</span><span ng-if="row.entity.size > grid.appScope.uploadFileMaxSize" class="validation-has-error icon_nb_error_16" uib-tooltip="{{grid.appScope.maxSizeErrorMessage}}" tooltip-placement="right" tooltip-append-to-body="true" tooltip-class="validation-error-tooltip"></span><span class="icon_nb_delete_blue_12 import-map-delete" ng-click="grid.appScope.onDelete($event, row.entity.no)"></span></div>')}],enableColumnResizing:!1,enableSorting:!1};$scope.gridOptionsThird={data:"data",columnDefs:[{field:"no",displayName:"No.",width:"80",cellClass:"no",cellTemplate:getNoCellTemplate()},{field:"name",displayName:"File Name",width:"230",cellClass:"name",cellTemplate:getNameCellTemplate()},{field:"status",displayName:"Status",width:"175",cellClass:"status",cellTemplate:getStatusCellTemplateThird()},{field:"size",displayName:"Size",width:"115",cellClass:"size",cellTemplate:getSizeCellTemplateThird()}],enableColumnResizing:!1,enableSorting:!1};$scope.setAutoRename=function(value){$scope.autoRename=value.autoRename};function getNoCellTemplate(){return'<div class="ui-grid-cell-contents"><span>{{grid.appScope.getIndex($event, row.entity.no)}}</span></div>'}function getNameCellTemplate(){return'<div class="ui-grid-cell-contents" ng-attr-title="{{::row.entity.nameWithExt}}"><span>{{row.entity.nameWithExt}}</span></div>'}$scope.maxSizeErrorMessage=StringUtil.format("File size cannot exceed {maxSize}.",{maxSize:fileSizeUnit($scope.uploadFileMaxSize)});function getStatusCellTemplateThird(){return'<div class="ui-grid-cell-contents"><span class="import-status"><span ng-show="row.entity.status==grid.appScope.statusCode.pending"><i class="pending" />Pending</span><span ng-show="row.entity.status==grid.appScope.statusCode.processing"><i class="fa fa-spinner fa-spin fa-3x" />Running</span><span ng-show="row.entity.status==grid.appScope.statusCode.succeed"><i class="icon_nb_selected" />Finished</span><span ng-show="row.entity.status==grid.appScope.statusCode.failed"><i class="failed" />Failed</span><span ng-show="row.entity.status==grid.appScope.statusCode.skipped"><i class="icon_nb_skipped" />Skipped</span><span class="import-info"><i class="icon_nb_warning" ng-show="row.entity.warning==grid.appScope.infoCode.warning"></i><input class="input-summary-warning-hide" ng-show="row.entity.warning==grid.appScope.infoCode.warning && 1==0" popover-trigger="\'click\'" popover-placement="right" uib-popover-template="\'warningTpl.html\'" type="text" readonly unselectable="on" /><i class="icon_nb_error" ng-show="row.entity.error==grid.appScope.infoCode.error"></i><input class="input-summary-warning-hide" ng-show="row.entity.error==grid.appScope.infoCode.error && 1==0" popover-trigger="\'click\'" popover-placement="right" uib-popover-template="\'errorTpl.html\'" type="text" readonly unselectable="on" /></span></div>'}function getSizeCellTemplateThird(){return'<div class="ui-grid-cell-contents"><span>{{row.entity.size|fileSizeUnit}}</span></div>'}$scope.getIndex=function(event,no){return _.findIndex($scope.data,{no:no})+1};$scope.onChooseFiles=function(){document.getElementById("inputChooseFiles").click()};var fileAction_getFileType=function(file){return file.name.substr(file.name.lastIndexOf(".")).toLowerCase()},fileAction_getFileName=function(file){return file.name.substr(0,file.name.lastIndexOf("."))},fileAction_getFileNameWithExt=function(file){return file.name},fileAction_isMatchedFileType=function(acceptType,fileType){return acceptType.indexOf(fileType)>-1},fileAction_isMatchedFileSize=function(file){return file.size<$scope.uploadFileMaxSize};$scope.onFileSelect=function($files){var checkMapNameReq={};checkMapNameReq.folderId=$scope.importMapOptions.folderId;checkMapNameReq.checkMapNameList=[];var selectedData=[];var hasCount=$scope.data.length;var showAlert=!1;var showMaxSize=!1;for(var i=0;i<$files.length;i++){if(hasCount+i>=50){showAlert=!0;break}var file=$files[i];var isMatchedFileType=fileAction_isMatchedFileType($scope.importMapOptions.accept,fileAction_getFileType(file));var isMatchedFileSize=fileAction_isMatchedFileSize(file);var isAdded=_.findIndex($scope.data,{name:fileAction_getFileName(file)})>-1;if(isMatchedFileType&&isMatchedFileSize&&!isAdded){var item={no:NgUtil.getUniqueStr(),name:fileAction_getFileName(file),nameWithExt:fileAction_getFileNameWithExt(file),status:$scope.statusCode.pending,size:file.size,overwrite:!1,isExisted:!1,file:file,warning:$scope.infoCode.normal,WarningMessageList:[],error:$scope.infoCode.normal,ErrorMessageList:[]};selectedData.push(item);checkMapNameReq.checkMapNameList.push({mapName:item.name,mapId:item.no,isExisted:!1})}else isMatchedFileSize||(showMaxSize=!0)}httpMapSrvc.checkMapNameExist(checkMapNameReq).then((function(result){for(var j=0;j<result.checkMapNameList.length;j++){var obj=result.checkMapNameList[j];var index=_.findIndex(selectedData,{no:obj.mapId});selectedData[index].isExisted=obj.isExisted}if(1===$scope.magicStep){$scope.data=[];$scope.magicStep=2}selectedData.length>0&&($scope.data=$scope.data.concat(selectedData))}));showAlert?nbAlertSrvc.warning(NetBrain.Map.Message.ImportMapUpLimited):showMaxSize&&nbAlertSrvc.warning(StringUtil.format("File size cannot exceed {maxSize}.",{maxSize:fileSizeUnit($scope.uploadFileMaxSize)}))};$scope.onDelete=function(event,no){var index=_.findIndex($scope.data,{no:no});if(index>-1){$scope.data.splice(index,1);document.getElementById("inputChooseFiles").value=""}};$scope.onImport=function(){$scope.needShowAlert=!0;for(var i=0;i<$scope.data.length;i++){$scope.data[i].status=$scope.statusCode.pending}$scope.isImporting=!0;2===$scope.magicStep&&($scope.magicStep=3);$scope.regularWidth();$scope.startImport(0).then((function(){$scope.isImporting=!1;element.find("#btnImportMapFinish").focus()}),(function(failed,errItem){$scope.isImporting=!1;element.find("#btnImportMapFinish").focus();console.warn("import error",failed,errItem)}))};$scope.regularWidth=function(){$timeout((function(){var finW=element.find("span.summary-finished").width();element.find(".input-summary-finished").css("margin-right",30-finW+"px");var warW=element.find("span.summary-warning").width();element.find(".input-summary-warning").width(warW+"px");element.find(".input-summary-warning").css("margin-right",30-warW+"px");element.find("span.summary-warning-count").css("margin-right",30-warW+"px");var errW=element.find("span.summary-error").width();element.find(".input-summary-error").width(errW+"px");element.find(".input-summary-error").css("margin-right",30-errW+"px");element.find("span.summary-error-count").css("margin-right",30-errW+"px");var faiW=element.find("span.summary-failed").width();element.find(".input-summary-failed").width(faiW+"px");element.find(".input-summary-failed").css("margin-right",30-faiW+"px");element.find("span.summary-failed-count").css("margin-right",30-faiW+"px");var skiW=element.find("span.summary-skipped").width();element.find(".input-summary-skipped").width(skiW+"px");element.find(".input-summary-skipped").css("margin-right",30-skiW+"px");element.find("span.summary-skipped-count").css("margin-right",30-skiW+"px")}),10)};$scope.startImport=function(i){var defer=$q.defer();$scope.importMap(i++).then((function(){$scope.regularWidth();!1!==$scope.isImporting||"cancel"!==$scope.formAction?i<$scope.data.length?$timeout((function(){$scope.startImport(i).then((function(){defer.resolve()}),(function(failed,item){defer.reject(failed,item)}))}),1e3):defer.resolve():defer.resolve("userCanceled")}),(function(failed,item){defer.reject(failed,item)}));return defer.promise};$scope.importMap=function(index){var defer=$q.defer();var item=$scope.data[index];item.status=$scope.statusCode.processing;var importObj={folderId:$scope.importMapOptions.folderId,no:item.no,name:item.nameWithExt,file:item.file,autoRename:$scope.autoRename};httpMapSrvc.importMap(importObj).then((function(result){if(result.operationResult&&0!==result.operationResult.ResultCode){item.status=$scope.statusCode.failed;$scope.failedCount++;var failedItem={rowIndex:index+1,mapName:item.name,faileds:[result.operationResult.ResultDesc]};$scope.importMapMsgFailed.push(failedItem);defer.resolve(result)}if(0===parseInt(result.data.Status)){item.status=$scope.statusCode.succeed;$scope.finishedCount++}if(1===parseInt(result.data.Status)){item.status=$scope.statusCode.failed;$scope.failedCount++;var failedItem2={rowIndex:index+1,mapName:item.name,faileds:["import failed."]};$scope.importMapMsgFailed.push(failedItem2)}if(2===parseInt(result.data.Status)){item.status=$scope.statusCode.skipped;$scope.skippedCount++;var skippedItem={rowIndex:index+1,mapName:item.name,skippeds:["import skipped."]};$scope.importMapMsgSkipped.push(skippedItem)}if(result.data.WarningMessageList&&result.data.WarningMessageList.length>0){item.warning=$scope.infoCode.warning;item.WarningMessageList=result.data.WarningMessageList;$scope.warningCount++;var warningItem={rowIndex:index+1,mapName:item.name,warnings:result.data.WarningMessageList};$scope.importMapMsgWarning.push(warningItem)}if(result.data.ErrorMessageList&&result.data.ErrorMessageList.length>0){item.error=$scope.infoCode.error;item.ErrorMessageList=result.data.ErrorMessageList;$scope.errorCount++;var errorItem={rowIndex:index+1,mapName:item.name,errors:result.data.ErrorMessageList};$scope.importMapMsgError.push(errorItem)}defer.resolve()}),(function(failed){defer.reject(failed,item)}));return defer.promise};$scope.onDomainManagerClick=function(){httpAuthSrvc.setDomainMgtIds();var url=StringUtil.format(NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.DomainAdmin,{domainId:$scope.activeDomain.guid});urlStateMgr.switchTabOrOpenNewTab(url,NetBrain.NG.Const.PageType.DomainAdmin,(function(){urlStateMgr.openNewTab(url,"_blank")}))};function buildTopoAlert(){var url=StringUtil.format(NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.DomainAdmin,{domainId:$scope.activeDomain.guid});var tpl=StringUtil.format(NetBrain.Map.Message.ImportMapFinishMsg,{domainmanager:'<a style="cursor:pointer" target="_blank" href="'+url+'" ng-click="onDomainManagerClick()">Domain Management</a>'});nbAlertSrvc.notification(tpl)}$scope.onFinish=function(){$scope.isImporting=!1;$scope.formAction="ok";$scope.importMapOptions.modalInstance.dismiss($scope);if($scope.finishedCount>0){buildTopoAlert();finishImportMap()}};$scope.onClose=function(){if($scope.needShowAlert&&$scope.finishedCount>0){buildTopoAlert();finishImportMap()}$scope.isImporting=!1;$scope.formAction="cancel";$scope.importMapOptions.modalInstance.dismiss($scope)};$scope.onCancel=function(){if($scope.needShowAlert&&$scope.finishedCount>0){buildTopoAlert();finishImportMap()}$scope.isImporting=!1;$scope.formAction="cancel";$scope.importMapOptions.modalInstance.dismiss($scope)};function finishImportMap(){$rootScope.$emit(netBrain.NetworkOS.Events.FOLDER_BROWSER_REFRESH);$rootScope.$emit(netBrain.NetworkOS.Events.DESKTOP_REFRESH);$rootScope.$emit("nbMyFilesPanelDirective.refreshFiles")}var scrollFunc=function(e){(e=e||window.event).wheelDelta&&event.ctrlKey?event.returnValue=!1:e.detail&&(event.returnValue=!1)};$scope.statusCode={pending:"Pending",processing:"Processing",succeed:"Succeed",failed:"Failed",skipped:"Skipped"};$scope.infoCode={normal:"normal",warning:"warning",error:"error"};document.addEventListener&&document.addEventListener("DOMMouseScroll",scrollFunc,!1);window.onmousewheel=document.onmousewheel=scrollFunc}}(NetBrain);!function(){angular.module("nb.qmap").controller("nb.qmap.nbImportMapCtrl",nbImportMapCtrl);nbImportMapCtrl.$inject=["$scope","$uibModalInstance","$q","importMapDataHandle"];function nbImportMapCtrl($scope,$uibModalInstance,$q,importMapDataHandle){var toFolder=importMapDataHandle.getFolderInfo();$scope.importMapOptions={title:"Import Maps",accept:".xmap,.qmap,.l2map,.map",modalInstance:$uibModalInstance,folderId:toFolder.id}}}(NetBrain);!function(){angular.module("nb.qmap").controller("nb.qmap.nbDataViewDataSetDialogCtrl",nbDataViewDataSetDialogCtrl);nbDataViewDataSetDialogCtrl.$inject=["$scope","$uibModalInstance","nb.common.nbAlertSrvc","$timeout","ivhTreeviewMgr","$q","nb.ng.nbValidationSrvc","dataViewDataSetHandle"];function nbDataViewDataSetDialogCtrl($scope,$uibModalInstance,nbAlertSrvc,$timeout,ivhTreeviewMgr,$q,nbValidationSrvc,dataViewDataSetHandle){$scope.dataSetType=[{label:"Latest data",key:"latest"},{label:"Historical data:",key:"history"}];$scope.templateDataSet={key:"latest",value:""};var tempHistoricalDate="";$scope.onClickRadio=function(dataSetTypeKey){if(dataSetTypeKey===$scope.dataSetType[0].key){tempHistoricalDate=$scope.templateDataSet.value;$scope.templateDataSet.value=$scope.dataSetType[0].label}else dataSetTypeKey===$scope.dataSetType[1].key&&($scope.templateDataSet.value===$scope.dataSetType[0].label&&""!==tempHistoricalDate?$scope.templateDataSet.value=tempHistoricalDate:$scope.templateDataSet.value=DateUtil.format(new Date,"MM/DD/YYYY HH:mm tt"))};$scope.onOK=function(){var opts={templateDataSet:$scope.templateDataSet};$uibModalInstance.close(opts)};$scope.onClose=function(){$uibModalInstance.dismiss()};$scope.onCancel=function(){$uibModalInstance.dismiss()};!function(){$scope.templateDataSet.key=dataViewDataSetHandle.templateDataSet.key;$scope.templateDataSet.value=dataViewDataSetHandle.templateDataSet.value;console.log("dataViewDataSetHandle",dataViewDataSetHandle)}()}}(NetBrain);!function(NetBrain){var consts=NetBrain.ns("MapLayout.Const");consts.NS_Name="nb.qmap.mapLayout";consts.MapLayoutType={undefined:0,multiTier:1,pairing:2,pie:3,circle:4,sampleMap:5};consts.MapLayoutDirection={undefined:0,top:1,right:2,left:3,bottom:4};consts.SampleMapCreateStrategy={byHostName:1,byAssignTag:2};consts.DeviceIconSize={larger:1,normal:2,small:3};consts.DeviceGroupType={Root:-1,Shared:deviceGroupType.Shared,Private:deviceGroupType.Private,System:deviceGroupType.System,Policy:deviceGroupType.Policy};consts.FolderType={undefined:0,LayoutStyleFolder:1,SampleMapFolder:2};consts.ForbidWindowsAndMongoChars="The name cannot contain any of the following special characters: '\\ / : * ? \" < > | . $ ,'";consts.Wording={LayoutManager:{NoPermissionDialogTitle:"Remove Device Tags",NoPermissionDialogCancelButton:"Cancel",NoPermissionDialogOkButton:"OK",NoPermissionDialogMessage:"You are no permission to access Map Layout Manager."},AssignTags:{gridColumn1TitleByDeviceGroup:"Layout Tags",gridColumn2TitleByDeviceGroup:"Number of Devices",deleteTagByDeviceGroupDialogTitle:"Remove Device Tags",deleteTagByDeviceGroupDialogCancelButton:"Cancel",deleteTagByDeviceGroupDialogOkButton:"Remove",deleteTagByDeviceGroupDialogMessage:'Are you sure that you want to remove the tag "{tag}" from selected devices?',deleteTagByDeviceGroupSuccessTip:'The tag "{tag}" has been removed from selected devices.',deleteTagByDeviceGroupFailedTip:"Failed to delete the tag.",assignTagByDeviceGroupSuccessTip:'The tag "{tag}" has been assigned to {deviceCnt} devices.',assignTagByDeviceGroupFailedTip:"Failed to add the tag.",gridColumn1TitleBySearch:"Device Name",gridColumn2TitleBySearch:"Layout Tags",deleteTagBySearchDialogTitle:"Remove Device Tags",deleteTagBySearchAllDialogTitle:"Delete Device Tags",deleteTagBySearchDialogCancelButton:"Cancel",deleteTagBySearchAllDialogCancelButton:"Cancel",deleteTagBySearchDialogOkButton:"Remove",deleteTagBySearchAllDialogOkButton:"Delete",deleteTagBySearchDialogMessage:'Are you sure that you want to remove the tag "{tag}" from selected devices?',deleteTagBySearchAllDialogMessage:"Are you sure you want to delete all tags of the selected devices?",deleteTagBySearchSuccessTip:'The tag "{tag}" has been removed from selected devices.',deleteTagBySearchAllSuccessTip:"Successfully delete the tags.",deleteTagBySearchFailedTip:"Failed to delete the tag.",deleteTagBySearchAllFailedTip:"Failed to delete the tags.",assignTagBySearchSuccessTip:'The tag "{showTagName}" has been assigned to {deviceCnt} devices.',assignTagBySearchFailedTip:"Failed to add the tag.",assignTagInputValidateMessage:consts.ForbidWindowsAndMongoChars,assignTagByImportDialogTitle:"Assign Device Tags",assignTagByImportDialogCancelButton:"Cancel",assignTagByImportDialogOkButton:"Assign Tags",assignTagByImportDialogMessage:"Tags will be assigned to {deviceCnt} devices. Do you want to continue?",assignTagByImportSuccessTip:"The tags have been assigned to {deviceCnt} devices.",assignTagByImportFailedTip:"Failed to import the tag.",importTagExcelFormatErrorMessage:'Only Column A "Device Name" and Column B "Layout Tags" can be included in the imported file.',importTagExcelFileFormatErrorMessage:"Failed to import the selected excel file. The file format is invalid or not supported.",importTagExcelUserClickCancel:"The user cancel import tag.",importTagExcelProgressTitle:"Importing Device Tags",downloadTemplateFailed:"Failed to download template, for reason: {reason}."},LayoutStyle:{MenuNewLayoutStyle:"New Layout Style",MenuNewFolder:"New Folder",MenuRename:"Rename",MenuMoveTo:"Move to...",MenuDelete:"Delete",NoneSourceFolderId:"-99",DBRootFolderId:"0",EntityMoveToHasDuplicateNameMessage:"The destination already contains the file or folder with the same name. Do you want to rename it with an auto-assigned name?",EntityMoveToSelfDestinationErrorMessage:"There is no point to move to its own parent folder!",EntityMoveToHasDuplicateNameFailedTip:"Failed to move the Map Layout.",EntityDeleteMessage:"Do you want to delete this Layout Style?",EntityAddInitializeName:"New Layout Style",FolderAddInitializeName:"New Folder",FolderMoveToHasDuplicateNameMessage:"The destination already contains the file or folder with the same name. Do you want to rename it with an auto-assigned name?",FolderMoveToSelfDestinationErrorMessage:"There is no point to move to its own parent folder!",FolderMoveToHasDuplicateNameFailedTip:"Failed to move the folder.",FolderDeleteMessage:"Are you sure you want to delete this folder? All its sub-folders and Layout Styles included will be deleted.",EntityAddDuplicateMessage:"A Layout Style with the same name already exists in the folder.",EntityFolderAddRenameFailedMessage:"Failed to update tree Node",SampleEntityDeleteMessage:"Do you want to delete this sample based layout style?",IsNameValidEmpty:"The {label} name cannot be empty.",IsNameValidLargeThen128:"The length of a {label} name cannot exceed 128 characters.",IsNameValidGeneralForbidWindowsAndMongoChars:"The name cannot contain any of the following special characters: '\\ / : * ? \" < > | . $'",IsNameValidErrorMessage:"The {label} name already exists!",GridColumn1TitleInLayerList:"Layer",GridColumn2TitleInLayerList:"Associated Tags",GridColumn3TitleInLayerList:"Maximum Displayed Devices per Row",GridColumn4TitleInLayerList:"Device Icon Size",SaveLayoutStyleSuccessTip:"Successfully saved the layout style.",LayerDeviceCountErrorMessage:"The value must be between 1 and 99",LayerDeleteDialogMessage:"Do you want to delete this layer?",LeaveLayoutStyleUnsaved:'Do you want to save the changes made to this Layout Style "{layout}"? <br/><br/>If you don\'t save, your changes will be lost.'},LayoutTag:{RemoveTagDialogTitle:"Delete Tag",RemoveTagDialogCancelButton:"Cancel",RemoveTagDialogOkButton:"Delete",ForbidWindowsAndMongoChars:consts.ForbidWindowsAndMongoChars,RemoveTagDialogMessage:'Are you sure that you want to delete the tag "{str}"?',LayerTagHasDuplicateMessage:"The tag already exists in this layout style.",LayerTagCountLargeThen20:"The tags count in the layer can't more then 20."},MoveTo:{SaveAsLayoutNameEmptyErrorMessage:"Please enter a Layout Style name",SaveAsLayoutNameDBNameValidateErrorMessage:"The Layout Style name can't contain any of the following characters: "},LayoutAssociation:{},MapLayout:{MatchedGridColumn1Title:"Layout Tag",MatchedGridColumn2Title:"Device Name",UnassignedGridColumn1Title:"Layout Tag",UnassignedGridColumn2Title:"Device Name",SettingsDialogGridColumn1TitleInLayerList:"Layer",SettingsDialogGridColumn2TitleInLayerList:"Maximum Displayed Devices per Row",SettingsDialogGridColumn3TitleInLayerList:"Device Icon Size",LayerDeviceCountErrorMessage:"The value must be between 1 and 99",ApplyToMapSuccessMessage:"Successfully applied the layout style.",SaveTagsSuccessMessage:"Successfully assigned the tags to the devices.",SaveAsSampleMapLayoutNameEmptyMessage:"Please enter a Layout Style name",SaveAsSampleMapLayoutNameDBNameValidateErrorMessage:"The Layout Style name can't contain any of the following characters: ",SaveAsSampleMapHasDuplicateNameMessage:"The destination already contains the file or folder with the same name. Do you want to rename it with an auto-assigned name?",SaveAsSampleMapFailedMessage:"Failed to save as sample map.",SaveAsSampleMapSuccessTip:"The Map has been saved as a Sample Map layout Style.",SaveAsSampleByTagGridTitle1:"Layout Tag",SaveAsSampleByTagGridTitle2:"Tag Position Based Device"},Association:{SiteGridColumn1Title:"Site Map",SiteGridColumn2Title:"Associated Layout Style",DeviceGroupGridColumn1Title:"Device Group Map",DeviceGroupGridColumn2Title:"Associated Layout Style",DeleteDeviceGroupMapRowDialogTitle:"Delete the Association",DeleteDeviceGroupMapRowDialogCancelButton:"Cancel",DeleteDeviceGroupMapRowDialogOkButton:"Remove",DeleteDeviceGroupMapRowDialogMessage:"Are you sure you want to delete the association?",DeleteDeviceGroupMapRowInfoSuccess:"Succeessfully delete the association.",DeleteDeviceGroupMapRowInfoFailed:"Failed delete the association.",UpdateSiteMapAssociationInfoSuccess:"Successfully associate this layout style with the site maps.",ClearSiteMapAssociationInfoSuccess:"Successfully clear associate this layout style with the site maps.",ClearSiteMapAssociationInfoFailed:"Failed to clear associate this layout style with the site maps.",UpdateSiteMapAssociationInfoFailed:"Failed to associate this layout style with the site maps.",UpdateDeviceGroupMapAssociationInfoSuccess:"Successfully associate this layout style with the device group maps.",UpdateDeviceGroupMapAssociationInfoFailed:"Failed to associate this layout style with the device group maps.",Saving:"Saving",Saved:"All changes saved automatically."}};var templateTypeEnum=consts.TemplateTypeEnum={templateStyle:1,sampleMapByDevice:21,sampleMapByTag:22};consts.getTemplateType=function(node){var result;node.type<consts.MapLayoutType.sampleMap||node.nodeType===consts.NodeTypeEnum.publicTplEntity?result=consts.TemplateTypeEnum.templateStyle:node.type===consts.MapLayoutType.sampleMap&&(node.createStrategy===consts.SampleMapCreateStrategy.byHostName?result=consts.TemplateTypeEnum.sampleMapByDevice:node.createStrategy===consts.SampleMapCreateStrategy.byAssignTag&&(result=consts.TemplateTypeEnum.sampleMapByTag));return result};var templateIcons=consts.TemplateIcons={};templateIcons[templateTypeEnum.templateStyle]="icon_nb_map_layout_12";templateIcons[templateTypeEnum.sampleMapByDevice]="icon_nb_map_layout_12_devices";templateIcons[templateTypeEnum.sampleMapByTag]="icon_nb_map_layout_12_tag";consts.getTemplateIconByType=function(type){return consts.TemplateIcons[type]};consts.getTemplateIconByNode=function(node){var templateType=consts.getTemplateType(node);return consts.getTemplateIconByType(templateType)};consts.NodeTypeEnum={publicTplRoot:1,publicTplFolder:11,publicTplEntity:111,sampleTplRoot:2,sampleTplFolder:22,sampleTplEntity:222};consts.getNodeType=function(node){var nodeType="";node.nodeType&&(nodeType=node.nodeType);var layoutFolder=consts.FolderType.LayoutStyleFolder;var sampleFolder=consts.FolderType.SampleMapFolder;node.folderType===layoutFolder&&node.parent&&node.parent.id===consts.Wording.LayoutStyle.DBRootFolderId?nodeType=consts.NodeTypeEnum.publicTplRoot:node.folderType===layoutFolder&&node.parent.id!==consts.Wording.LayoutStyle.DBRootFolderId?nodeType=consts.NodeTypeEnum.publicTplFolder:node.type===consts.MapLayoutType.multiTier||node.type===consts.MapLayoutType.pairing||node.type===consts.MapLayoutType.pie||node.type===consts.MapLayoutType.circle?nodeType=consts.NodeTypeEnum.publicTplEntity:node.folderType===sampleFolder&&node.parent.id===consts.Wording.LayoutStyle.DBRootFolderId?nodeType=consts.NodeTypeEnum.sampleTplRoot:node.folderType===sampleFolder&&node.parent.id!==consts.Wording.LayoutStyle.DBRootFolderId?nodeType=consts.NodeTypeEnum.sampleTplFolder:node.type===consts.MapLayoutType.sampleMap&&(nodeType=consts.NodeTypeEnum.sampleTplEntity);return nodeType};consts.getServerFolderType=function(nodeType){var obj={};obj["key"+consts.NodeTypeEnum.publicTplFolder]=consts.FolderType.LayoutStyleFolder;obj["key"+consts.NodeTypeEnum.sampleTplFolder]=consts.FolderType.SampleMapFolder;return obj["key"+nodeType]};consts.MapLayoutEvent={OpenMapLayoutMiniPane:"OpenMapLayoutMiniPane"};consts.MapLayoutHighlightOption={getDeviceIdList:function(pageId){consts.MapLayoutHighlightOption.pages[pageId]||(consts.MapLayoutHighlightOption.pages[pageId]={deviceIdList:[],highlightDevice:!1});return consts.MapLayoutHighlightOption.pages[pageId].deviceIdList},getHighLightDevice:function(pageId){consts.MapLayoutHighlightOption.pages[pageId]||(consts.MapLayoutHighlightOption.pages[pageId]={deviceIdList:[],highlightDevice:!1});return consts.MapLayoutHighlightOption.pages[pageId]},pages:{}};consts.OrientationEnum={tt:"t",rr:"r",ll:"l",bb:"b"};consts.MapLayoutTypeIconList=["undefined",{t:{size137:"layout_by_tags_1_01",size355:"Layout_Style_1_1_big",size88:"Layout_Style_1_1",size70:"layout-1_01_small",size110:"layout_by_tags_1_110_01",size58:"layout-1_58_01_small",size306:"layout-1_306_01_big"},b:{size137:"layout_by_tags_1_04",size355:"Layout_Style_1_4_big",size88:"Layout_Style_1_4",size70:"layout-1_04_small",size110:"layout_by_tags_1_110_04",size58:"layout-1_58_04_small",size306:"layout-1_306_04_big"},l:{size137:"layout_by_tags_1_03",size355:"Layout_Style_1_3_big",size88:"Layout_Style_1_3",size70:"layout-1_03_small",size110:"layout_by_tags_1_110_03",size58:"layout-1_58_03_small",size306:"layout-1_306_03_big"},r:{size137:"layout_by_tags_1_02",size355:"Layout_Style_1_2_big",size88:"Layout_Style_1_2",size70:"layout-1_02_small",size110:"layout_by_tags_1_110_02",size58:"layout-1_58_02_small",size306:"layout-1_306_02_big"}},{t:{size137:"layout_by_tags_2_01",size355:"Layout_Style_2_1_big",size88:"Layout_Style_2_1",size70:"layout-2_01_small",size110:"layout_by_tags_2_110_01",size58:"layout-2_58_01_small",size306:"layout-2_306_01_big"},l:{size137:"layout_by_tags_2_02",size355:"Layout_Style_2_2_big",size88:"Layout_Style_2_2",size70:"layout-2_02_small",size110:"layout_by_tags_2_110_02",size58:"layout-2_58_02_small",size306:"layout-2_306_02_big"}},{t:{size137:"layout_by_tags_3",size355:"Layout_Style_3_big",size110:"layout_by_tags_3_110",size70:"layout-3_01_small",size58:"layout-3_58_01_small",size306:"layout-3_306_01_big"}},{t:{size137:"layout_by_tags_4",size355:"Layout_Style_4_big",size110:"layout_by_tags_4_110",size70:"layout-4_01_small",size58:"layout-4_58_01_small",size306:"layout-4_306_01_big"}},{}];consts.TemplateLayoutType={MapLayout:"1_mapLayout",SampleLayout:"2_sampleLayout",GeometryLayout:"3_geometryLayout"};consts.MapLayoutTypeDirection=["undefined",[consts.OrientationEnum.tt,consts.OrientationEnum.bb,consts.OrientationEnum.ll,consts.OrientationEnum.rr],[consts.OrientationEnum.tt,consts.OrientationEnum.ll],[consts.OrientationEnum.tt],[consts.OrientationEnum.tt],{}];consts.getRealScale=function(scale){var obj={};obj["scale_"+consts.DeviceIconSize.larger]=1.2;obj["scale_"+consts.DeviceIconSize.normal]=1;obj["scale_"+consts.DeviceIconSize.small]=.8;return obj["scale_"+scale]};consts.convertLayout=function(categoryMgr,mapLayoutList){var baseId=31;return _.chain(mapLayoutList).groupBy("type").map((function(items,type){return{type:parseInt(type),bigType:consts.TemplateLayoutType.MapLayout,currentStyleId:baseId++,layouts:items.map((function(layout){var unAssignedCount=0;for(var m=0;m<layout.unAssignedDevices.length;m++){var unAssignDev=layout.unAssignedDevices[m];categoryMgr.isNetworkDevice(unAssignDev.category)&&unAssignedCount++}var icon=consts.MapLayoutTypeIconList[layout.type];layout.unAssignedCount=unAssignedCount;layout.imgSize70={t:icon.t.size70,b:icon.b?icon.b.size70:"",l:icon.l?icon.l.size70:"",r:icon.r?icon.r.size70:""};layout.imgSize110={t:icon.t.size110,b:icon.b?icon.b.size110:"",l:icon.l?icon.l.size110:"",r:icon.r?icon.r.size110:""};return layout}))}})).map((function(item){var currentLayout={};item.layouts.length>0&&(currentLayout=item.layouts[0]);item.currentLayout=currentLayout;return item})).value()};consts.getCurrentMapStyle=function(){var l2=NetBrain.Map.currentActiveMapPage.isL2MapStyle();var l3=NetBrain.Map.currentActiveMapPage.isL3MapStyle();return{mapStyle:l2?"L2":l3?"L3":"",l2:l2,l3:l3}};consts.filterSimilarityFunctionHandler=function(item){var mapStyleObj=consts.getCurrentMapStyle();var l2=mapStyleObj.l2;var l3=mapStyleObj.l3;var mapStyle=mapStyleObj.mapStyle;var moreThanZero=item.originalLayout.similarityCoefficient>0;if(l2){if(item.bigType===consts.TemplateLayoutType.MapLayout){var isCircle=item.originalLayout.type!==consts.MapLayoutType.circle;return moreThanZero&&isCircle}if(item.bigType===consts.TemplateLayoutType.SampleLayout){var isL2=item.originalLayout.mapStyle===mapStyle;return moreThanZero&&isL2}if(item.bigType===consts.TemplateLayoutType.GeometryLayout){var isTree="Tree_Layout_Up"===item.originalLayout.id||"Tree_Layout_Down"===item.originalLayout.id||"Symmetric_Layout"===item.originalLayout.id;return moreThanZero&&isTree}}if(l3){if(item.bigType===consts.TemplateLayoutType.SampleLayout){var isL3=item.originalLayout.mapStyle===mapStyle;return moreThanZero&&isL3}return moreThanZero}return!1};consts.getGeometryIconName=function(type,size){var icoList={Symmetric_Layout:{s110:"layout_by_geometry_110_1",s70:"layout_by_geometry_70_1",sl110:"layout_by_geometry_110l_1"},Circular_Layout:{s110:"layout_by_geometry_110_2",s70:"layout_by_geometry_70_2",sl110:"layout_by_geometry_110l_2"},Hierarchical_Layout:{s110:"layout_by_geometry_110_4",s70:"layout_by_geometry_70_4",sl110:"layout_by_geometry_110l_4"},Orthogonal_Layout:{s110:"layout_by_geometry_110_3",s70:"layout_by_geometry_70_3",sl110:"layout_by_geometry_110l_3"},Tree_Layout_Up:{s110:"layout_by_geometry_110_5",s70:"layout_by_geometry_70_5",sl110:"layout_by_geometry_110l_5"},Tree_Layout_Down:{s110:"layout_by_geometry_110_6",s70:"layout_by_geometry_70_6",sl110:"layout_by_geometry_110l_6"}};return size?icoList[type]&&icoList[type][size]?icoList[type][size]:"":icoList[type]&&icoList[type].s110?icoList[type].s110:""};consts.getGeometryName=function(type){var nameList={Symmetric_Layout:{name:"Symmetric"},Circular_Layout:{name:"Circular"},Hierarchical_Layout:{name:"Hierarchical"},Orthogonal_Layout:{name:"Orthogonal"},Tree_Layout_Up:{name:"Upward Tree"},Tree_Layout_Down:{name:"Downward Tree"}};return nameList[type]?nameList[type].name:""};consts.innerChangedStatus={value:!1};consts.isAutoApply={value:!1};consts.openSampleMap=function(mapPageId,sampleLayoutId,bigType,urlStateMgr){if(bigType===consts.TemplateLayoutType.SampleLayout){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){var options={mapType:NetBrain.Map.Const.MapType.mapLayoutSampleMap,id:sampleLayoutId};return urlStateMgr.openMap(options)}}};consts.elementIdBuilder={getMiniPaneId:function(mapPageId){return"[mini-pane-map-page-id="+mapPageId+"]"},getFirstPaneId:function(mapPageId){return"[first-pane-map-page-id="+mapPageId+"]"},getDetailPaneId:function(mapPageId){return"[detail-pane-map-page-id="+mapPageId+"]"}};consts.convertToScale=function(changeToLayout){for(var x=0;x<changeToLayout.layers.length;x++){var currentLayer=changeToLayout.layers[x];var scale=currentLayer.scale;currentLayer.scale=consts.getRealScale(scale)}};consts.showSaving=function(nbTipSrvc){return this.showTip(this.Wording.Association.Saving,nbTipSrvc)};consts.showSaved=function(nbTipSrvc){return this.showTip(this.Wording.Association.Saved,nbTipSrvc)};consts.showTip=function(msg,nbTipSrvc){var options={tipInfo:msg,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options)};consts.showFailTip=function(msg,nbTipSrvc){var options={tipInfo:msg,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapFailTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options)}}(NetBrain);!function(netBrain){angular.module("nb.qmap").factory("nb.qmap.mapLayoutSrvc",mapLayoutSrvc);mapLayoutSrvc.$inject=["$rootScope","nb.ng.nbHttp","$q","$log","$uibModal","$location","nb.networkos.myFilesSrvc","nb.datamodel.httpSiteSrvc","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.uiframework.urlStateMgr","nb.ng.httpAuthSrvc","$timeout","nb.ng.utilitySrvc","nb.ng.sessionSrvc","nb.uiframework.mainUISrvc","nb.networkos.fileSrvc","nb.runbook.httpRunBookSrvc","nb.common.nbTipSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.qmap.httpMapLayoutSrvc","nb.qmap.mapContextMenuManager","nb.qmap.mapManagerSrvc"];function mapLayoutSrvc($rootScope,nbHttp,$q,$log,$uibModal,$location,myFilesSrvc,httpSiteSrvc,userSrvc,nbAlertSrvc,httpMapSrvc,urlStateMgr,httpAuthSrvc,$timeout,utilitySrvc,sessionSrvc,mainUISrvc,fileSrvc,runbookMgr,nbTipSrvc,httpDeviceGroupSrvc,httpMapLayoutSrvc,mapContextMenuManager,mapManagerSrvc){var consts=NetBrain.MapLayout.Const;!function(prototype){prototype.init=init;prototype.refreshCache=refreshCache;prototype.getAllLayouts=getAllLayouts;prototype.getMapLayouts=getMapLayouts;prototype.getSampleMaps=getSampleMaps;prototype.getGeometries=getGeometries;prototype.showOrHideHighlightBg=showOrHideHighlightBg;prototype.quickShowOrHideHighlightBg=quickShowOrHideHighlightBg;prototype._getSpecialLayouts=_getSpecialLayouts}(PageService.prototype);var TemplateLayoutType=NetBrain.MapLayout.Const.TemplateLayoutType;var MapLayoutDirectionEnum=NetBrain.MapLayout.Const.MapLayoutDirection;var OrientationEnum=NetBrain.MapLayout.Const.OrientationEnum;var MapLayoutTypeIconList=NetBrain.MapLayout.Const.MapLayoutTypeIconList;var SampleMapCreateStrategyEnum=NetBrain.MapLayout.Const.SampleMapCreateStrategy;var getGeometryIconName=NetBrain.MapLayout.Const.getGeometryIconName;var getGeometryName=NetBrain.MapLayout.Const.getGeometryName;var pageServiceCache={};var getNodeType=NetBrain.MapLayout.Const.getNodeType;var nodeTypeEnum=NetBrain.MapLayout.Const.NodeTypeEnum;var LayoutStyleWording=NetBrain.MapLayout.Const.Wording.LayoutStyle;var MapType=NetBrain.Map.Const.MapType;var MapLayoutType=NetBrain.MapLayout.Const.MapLayoutType;var SampleMapCreateStrategy=NetBrain.MapLayout.Const.SampleMapCreateStrategy;function fetchLayoutStyleChildNode(curNode){var defer=$q.defer();if(curNode.loaded){defer.resolve();return defer.promise}httpMapLayoutSrvc.getSubFoldersAndLayoutsByParentId(curNode.ID,curNode.folderType).then((function(result){var folderArray=result.layoutFolders;for(var i=0;i<folderArray.length;i++){var fNode=folderArray[i];fNode.ID=fNode.id;fNode.nodeType=getNodeType(fNode);fNode.children=[];fNode.editable=!1;fNode.selected=!1;fNode.expanded=!1;curNode.children.push(fNode)}var layoutArray=result.basedLayoutStyles;for(var j=0;j<layoutArray.length;j++){var lNode=layoutArray[j];lNode.ID=lNode.id;lNode.nodeType=getNodeType(lNode);lNode.templateType=consts.getTemplateType(lNode);lNode.children=[];lNode.editable=!1;lNode.selected=!1;curNode.children.push(lNode)}var sampleArray=result.sampleMapLayOutStyles;for(var k=0;k<sampleArray.length;k++){var sNode=sampleArray[k];sNode.ID=sNode.id;sNode.nodeType=getNodeType(sNode);sNode.templateType=consts.getTemplateType(sNode);sNode.children=[];sNode.editable=!1;sNode.selected=!1;curNode.children.push(sNode)}curNode.loaded=!0;defer.resolve(curNode)}));return defer.promise}function startFetchLayoutNode(node){var defer=$q.defer();httpMapLayoutSrvc.getSubFoldersAndLayoutsByParentId(node.ID,node.folderType).then((function(result){startFetchLayoutFirstChildNode(function(curNode,result){var childFolderList=[];var folderArray=result.layoutFolders;for(var i=0;i<folderArray.length;i++){var fNode=folderArray[i];fNode.ID=fNode.id;fNode.nodeType=getNodeType(fNode);fNode.children=[];fNode.editable=!1;fNode.selected=!1;fNode.expanded=!1;curNode.children.push(fNode);childFolderList.push(fNode)}var layoutArray=result.basedLayoutStyles;for(var j=0;j<layoutArray.length;j++){var lNode=layoutArray[j];lNode.ID=lNode.id;lNode.nodeType=getNodeType(lNode);lNode.templateType=consts.getTemplateType(lNode);lNode.children=[];lNode.editable=!1;lNode.selected=!1;curNode.children.push(lNode)}var sampleArray=result.sampleMapLayOutStyles;for(var k=0;k<sampleArray.length;k++){var sNode=sampleArray[k];sNode.ID=sNode.id;sNode.nodeType=getNodeType(sNode);sNode.templateType=consts.getTemplateType(sNode);sNode.children=[];sNode.editable=!1;sNode.selected=!1;curNode.children.push(sNode)}curNode.loaded=!0;return childFolderList}(node,result),0).then((function(nodes){defer.resolve(nodes)}))}));return defer.promise}function startFetchLayoutFirstChildNode(nodes,i){var defer=$q.defer();if(i<nodes.length){startFetchLayoutNode(nodes[i++]).then((function(){startFetchLayoutFirstChildNode(nodes,i).then((function(){defer.resolve(nodes)}))}))}else defer.resolve(nodes);return defer.promise}function loadNode(data,node){var nodes=function(data,id){var folderArray=_.filter(data.layoutFolders,(function(item){return item.parent.id===id}));var layoutArray=_.filter(data.basedLayoutStyles,(function(item){return item.parentFolder.id===id}));var sampleArray=_.filter(data.sampleMapLayOutStyles,(function(item){return item.parentFolder.id===id}));var result=[];for(var i=0;i<folderArray.length;i++){var fNode=folderArray[i];fNode.ID=fNode.id;fNode.nodeType=getNodeType(fNode);fNode.children=[];fNode.editable=!1;fNode.selected=!1;fNode.expanded=!1;result.push(fNode)}for(var j=0;j<layoutArray.length;j++){var lNode=layoutArray[j];lNode.ID=lNode.id;lNode.nodeType=getNodeType(lNode);lNode.templateType=consts.getTemplateType(lNode);lNode.children=[];lNode.editable=!1;lNode.selected=!1;result.push(lNode)}for(var k=0;k<sampleArray.length;k++){var sNode=sampleArray[k];if(sNode.createStrategy!==SampleMapCreateStrategy.byHostName){sNode.ID=sNode.id;sNode.nodeType=getNodeType(sNode);sNode.templateType=consts.getTemplateType(sNode);sNode.children=[];sNode.editable=!1;sNode.selected=!1;result.push(sNode)}}return result}(data,node.id);node.children=nodes;for(var i=0;i<node.children.length;i++){loadNode(data,node.children[i])}return node}function getSiteMapTree(siteId,node){var defer=$q.defer();var siteMapTreeDataCache=[];httpSiteSrvc.getSiteTree(siteId).then((function(data){var eachData=data;var parentNode=node;if(0===siteId){data.isLeaf=!1;data.siteIcon="container_site_icon";siteMapTreeDataCache.push(data);eachData=data.children;parentNode=data}parentNode.loaded=!0;eachData=_.compact(eachData);angular.forEach(eachData,(function(item){item.isLeaf=item.siteCategory>=2;item.siteIcon=2===item.siteCategory?"leaf_site_icon":"container_site_icon";item.loaded=!1;item.parent=parentNode;siteMapTreeDataCache.push(item)}));0!==siteId&&(node.children=data);defer.resolve({data:data,siteMapTreeDataCache:siteMapTreeDataCache})}));return defer.promise}function getFlatAssociation(result){return _.chain(result).map((function(item){return{id:item.id,layoutId:item.layoutBriefInfo.id,layoutType:item.layoutBriefInfo.layOutStyleType,layoutName:item.layoutBriefInfo.layoutName,mapId:item.mapBriefInfo.mapId,mapType:item.mapBriefInfo.mapType,rowId:item.mapBriefInfo.rowId,isCasscade:item.mapBriefInfo.isCasscade}})).value()}function getSiteMapAssociationList(){return httpMapLayoutSrvc.getAllRelation([MapType.siteMap]).then((function(result){var list=getFlatAssociation(result);return $q.resolve(list)}))}function getKeyValueLayoutNameList(result){var obj={};_.each(result,(function(item){(item.type<MapLayoutType.sampleMap||item.createStrategy===SampleMapCreateStrategy.byAssignTag)&&(obj[item.id]=item.name)}));return obj}return{initDeviceGroupTreeData:function(){var defer=$q.defer();var deviceGroupMapTreeData=[{ID:NetBrain.MapLayout.Const.DeviceGroupType.Root.toString(),Name:"Device Group",children:[],Type:NetBrain.MapLayout.Const.DeviceGroupType.Root}];deviceGroupMapTreeData[0].children=[];var privateData={ID:NetBrain.MapLayout.Const.DeviceGroupType.Private.toString(),Name:"My Device Groups",children:[],Type:NetBrain.MapLayout.Const.DeviceGroupType.Private};var sharedData={ID:NetBrain.MapLayout.Const.DeviceGroupType.Shared.toString(),Name:"Public",children:[],Type:NetBrain.MapLayout.Const.DeviceGroupType.Shared};var systemData={ID:NetBrain.MapLayout.Const.DeviceGroupType.System.toString(),Name:"System",children:[],Type:NetBrain.MapLayout.Const.DeviceGroupType.System};var policyData={ID:NetBrain.MapLayout.Const.DeviceGroupType.Policy.toString(),Name:"Policy Device Group",children:[],Type:NetBrain.MapLayout.Const.DeviceGroupType.Policy};var privateType=NetBrain.MapLayout.Const.DeviceGroupType.Private;var sharedType=NetBrain.MapLayout.Const.DeviceGroupType.Shared;var systemType=NetBrain.MapLayout.Const.DeviceGroupType.System;var policyType=NetBrain.MapLayout.Const.DeviceGroupType.Policy;var types=[privateType,sharedType,policyType,systemType];httpDeviceGroupSrvc.getAllDeviceGroupByTypes(types,null).then((function(result){privateData.children=_.where(result,{Type:privateType});sharedData.children=_.where(result,{Type:sharedType});systemData.children=_.where(result,{Type:systemType});policyData.children=_.where(result,{Type:policyType});privateData.children.length>0&&deviceGroupMapTreeData[0].children.push(privateData);sharedData.children.length>0&&deviceGroupMapTreeData[0].children.push(sharedData);policyData.children.length>0&&deviceGroupMapTreeData[0].children.push(policyData);systemData.children.length>0&&deviceGroupMapTreeData[0].children.push(systemData);defer.resolve(deviceGroupMapTreeData)}),(function(){defer.resolve(deviceGroupMapTreeData)}));return defer.promise},getSampleMapDataObj:function(sampleLayoutId){return httpMapLayoutSrvc.openMapById(sampleLayoutId).then((function(result){var mapObj=result.mapObj;var userId=userSrvc.getUserID();var userName=userSrvc.getUserName();mapObj.ID=NgUtil.getUniqueStr();var editRight=userName+":"+userId;mapObj.creator=userName;mapObj.updatedBy=userName;mapObj.editor={opUser:userName,opUserId:userId};mapObj.title="Map1";for(var i=0;i<mapObj.pageList.length;i++){var page=mapObj.pageList[i];page.ID=NgUtil.getUniqueStr();page.creator=editRight;page.updatedBy=userName}console.log("getSampleMapDataObj",result);return $q.resolve(mapObj)}))},loadLayoutStyleTreeData:function(){return httpMapLayoutSrvc.getRootFolderList().then((function(result){var qList=[];for(var i=0;i<result.length;i++){var node=result[i];node.ID=node.id;node.nodeType=getNodeType(node);node.templateType=consts.getTemplateType(node);node.children=[];node.editable=!1;node.selected=!1;node.expanded=!1;if(node.nodeType===nodeTypeEnum.publicTplRoot){node.expanded=!0;qList.push(fetchLayoutStyleChildNode(node,LayoutStyleWording.NoneSourceFolderId))}node.nodeType===nodeTypeEnum.sampleTplRoot&&qList.push(fetchLayoutStyleChildNode(node,LayoutStyleWording.NoneSourceFolderId))}return $q.all(qList).then((function(nodes){return $q.resolve(nodes)}))}))},fetchLayoutStyleChildNode:fetchLayoutStyleChildNode,loadSiteMapTree:function(userCancel){return getSiteMapTree(0,null)},getSubSiteTree:function(siteId,node,userCancel){return getSiteMapTree(siteId,node)},getSiteMapAssociationList:getSiteMapAssociationList,getDeviceGroupMapAssociationList:function(){return httpMapLayoutSrvc.getAllRelation([MapType.deviceGroupMap]).then((function(result){var list=getFlatAssociation(result);return $q.resolve(list)}))},getAssociationList:function(){return httpMapLayoutSrvc.getAllRelation([MapType.siteMap,MapType.deviceGroupMap]).then((function(result){var list=getFlatAssociation(result);var resultObj={};resultObj.siteMapAssociationList=_.where(list,{mapType:MapType.siteMap});resultObj.dgMapAssociationList=_.where(list,{mapType:MapType.deviceGroupMap});return $q.resolve(resultObj)}))},getAllLayoutStyleNameList:function(){var qList=[httpMapLayoutSrvc.getAllSampleMap({pageNumber:0,pageSize:5e4}),httpMapLayoutSrvc.getAllLayoutStyleByPage({pageNumber:0,pageSize:5e4})];return $q.all(qList).then((function(result){var list0=getKeyValueLayoutNameList(result[0]);var list1=getKeyValueLayoutNameList(result[1]);var obj=_.extend({},list0,list1);return $q.resolve(obj)}))},saveSiteMapAssociation:function(list){var insertList=[];for(var i=0;i<list.length;i++){var item=list[i];var insert={mapBriefInfo:{mapId:item.mapId,mapType:MapType.siteMap,isCasscade:item.isCasscade,rowId:""},layoutBriefInfo:{id:item.layoutId,layOutStyleType:item.layoutType}};insertList.push(insert)}return httpMapLayoutSrvc.addAssocations(insertList)},saveDeviceGroupMapAssociation:function(deviceGroupMapIdList,layoutId,layoutType,rowId,needDeleteMapIdList){var defer=$q.defer();var insertList=[];for(var i=0;i<deviceGroupMapIdList.length;i++){var insert={mapBriefInfo:{mapId:deviceGroupMapIdList[i],mapType:MapType.deviceGroupMap,isCasscade:!1,rowId:rowId},layoutBriefInfo:{id:layoutId,layOutStyleType:layoutType}};insertList.push(insert)}needDeleteMapIdList&&needDeleteMapIdList.length>0?httpMapLayoutSrvc.deleteRelationBySystemMapIds(needDeleteMapIdList).then((function(result0){result0&&deviceGroupMapIdList.length>0?httpMapLayoutSrvc.addAssocations(insertList).then((function(result1){defer.resolve(result1)})):result0&&0===deviceGroupMapIdList.length?defer.resolve(!0):defer.resolve(!1)}),(function(err){defer.reject(err)})):deviceGroupMapIdList.length>0&&httpMapLayoutSrvc.addAssocations(insertList).then((function(result2){defer.resolve(result2)}),(function(err){defer.reject(err)}));return defer.promise},filterSiteMapData:function(key){var defer=$q.defer();var searchCache=[];var qList=[httpSiteSrvc.getSitesByNameFilter(key),getSiteMapAssociationList()];$q.all(qList).then((function(data){angular.forEach(data[0].sites,(function(item){if(2===item.siteCategory){item.isLeaf=item.siteCategory>=2;item.siteIcon=2===item.siteCategory?"leaf_site_icon":"container_site_icon";1===item.siteCategory&&(item.chidren=[]);searchCache.push(item)}}));var siteMapAssociationList=data[1];defer.resolve({searchResult:searchCache,siteMapAssociationList:siteMapAssociationList})}));return defer.promise},deleteAssociationByDeviceGroupMapId:function(mapIdList){return httpMapLayoutSrvc.deleteRelationBySystemMapIds(mapIdList)},loadLayoutStyleAllTreeNode:function(){return httpMapLayoutSrvc.getRootFolderList().then((function(result){var nodes=[];for(var i=0;i<result.length;i++){var node=result[i];node.ID=node.id;node.nodeType=getNodeType(node);node.children=[];node.editable=!1;node.selected=!1;node.expanded=!0;nodes.push(node)}return startFetchLayoutFirstChildNode(nodes,0).then((function(treeNodes){return $q.resolve(treeNodes)}))}))},loadLayoutStyleAllTreeNode2:function(){var defer=$q.defer();httpMapLayoutSrvc.getAllSubFoldersAndLayoutsByParentId().then((function(data){var mapLayoutRoot={id:"aaaaaaaa-6b69-417d-ad03-2cc447100166",folderType:1,name:"Layout Styles",parent:{id:LayoutStyleWording.DBRootFolderId,folderType:1},editable:!1,selected:!1,expanded:!0,loaded:!0};var sampleMapRoot={id:"bbbbbbbb-6b69-417d-ad03-2cc447100166",folderType:2,name:"Sample Maps",parent:{id:LayoutStyleWording.DBRootFolderId,folderType:2},editable:!1,selected:!1,expanded:!0,loaded:!0};mapLayoutRoot.ID=mapLayoutRoot.id;mapLayoutRoot.nodeType=getNodeType(mapLayoutRoot);sampleMapRoot.ID=sampleMapRoot.id;sampleMapRoot.nodeType=getNodeType(sampleMapRoot);data.layoutFolders.push(mapLayoutRoot);data.layoutFolders.push(sampleMapRoot);var rootNodes=[loadNode(data,mapLayoutRoot),loadNode(data,sampleMapRoot)];console.log("$scope.siteMapLayoutTreeData",data);console.log("$scope.siteMapLayoutTreeData, rootNodes",rootNodes);defer.resolve(rootNodes)}));return defer.promise},initPageService:function(netmapOperator,httpDeviceSrvc,pageId){var layoutToolsHelper=new netBrain.Map.LayoutToolsHelper(netmapOperator,httpMapLayoutSrvc);var pageService=new PageService(layoutToolsHelper,netmapOperator);pageServiceCache[pageId]={pageService:pageService,layoutToolsHelper:layoutToolsHelper};return pageService.init().then((function(){return pageService}))},getPageService:function(pageId){return getHandler(pageId,"pageService","must init pageService befor get pageService")},getLayoutToolsHelper:function(pageId){return getHandler(pageId,"layoutToolsHelper","must init pageService befor get layoutToolsHelper")},destroyPageService:function(pageId){pageServiceCache[pageId]=null}};function getHandler(pageId,serviceKey,errorMessage){var result;var cache=pageServiceCache[pageId];if(cache)result=cache[serviceKey];else{console.warn("getHandler error. ",errorMessage);result=null}return result}function PageService(layoutToolsHelper,netmapOperator){this.inited=!1;this.layoutToolsHelper=layoutToolsHelper;this.netmapOperator=netmapOperator;this.dataCache={}}function init(){var result;if(this.inited)result=$q.resolve();else{this.inited=!0;result=this.refreshCache()}return result}function refreshCache(){var self=this;return this.layoutToolsHelper.refreshCachedTags().then((function(){self.dataCache={}}))}function getMapLayouts(filter){return this._getSpecialLayouts((function(layout){var isMapLayout=layout.bigType===TemplateLayoutType.MapLayout;var isNotZeroAndOkStyle=filter(layout);return isMapLayout&&isNotZeroAndOkStyle}))}function getSampleMaps(filter){return this._getSpecialLayouts((function(layout){var isSampleLayout=layout.bigType===TemplateLayoutType.SampleLayout;var isNotZeroAndOkStyle=filter(layout);return isSampleLayout&&isNotZeroAndOkStyle}))}function getGeometries(filter){return this._getSpecialLayouts((function(layout){var isGeometry=layout.bigType===TemplateLayoutType.GeometryLayout;var isNotZeroAndOkStyle=filter(layout);return isGeometry&&isNotZeroAndOkStyle}))}function getAllLayouts(condition){return(dataCache=this.dataCache,key="allLayout",dataGetter=doGetAllLayouts,layoutToolsHelper=this.layoutToolsHelper,cacheData=dataCache[key],cacheData?$q.resolve(cacheData):function(dataGetter,dataCache,key,layoutToolsHelper){return dataGetter(layoutToolsHelper).then((function(data){dataCache[key]=data;return data}))}(dataGetter,dataCache,key,layoutToolsHelper)).then((function(allLayouts){return condition?_.filter(allLayouts,condition):allLayouts}));var dataCache,key,dataGetter,layoutToolsHelper,cacheData}function _getSpecialLayouts(filter){return this.getAllLayouts().then((function(allLayouts){return _.chain(allLayouts).filter(filter).map(returnOriginalLayout).value()}))}function returnOriginalLayout(layout){return layout.originalLayout}function setId(layouts){return _.each(layouts,(function(layout,index){layout.id=index}))}function quickShowOrHideHighlightBg(isShow,matchedNodeKeys){var idList=matchedNodeKeys;if(this.netmapOperator._netmap){this.netmapOperator.hideHighlightBg();isShow&&this.netmapOperator.showHighlightBg(idList)}return idList}function showOrHideHighlightBg(isShow,layoutItem){var idList=[];if(this.netmapOperator._netmap){this.netmapOperator.hideHighlightBg();if(isShow)if(layoutItem&&layoutItem.bigType===TemplateLayoutType.MapLayout){var mapLayout=layoutItem.originalLayout;if(mapLayout&&mapLayout.layers&&_.isArray(mapLayout.layers)){for(var i=0;i<mapLayout.layers.length;i++){var layer=mapLayout.layers[i];if(layer.tags&&_.isArray(layer.tags))for(var j=0;j<layer.tags.length;j++){var tag=layer.tags[j];if(tag.devices&&_.isArray(tag.devices))for(var k=0;k<tag.devices.length;k++){var deviceId=tag.devices[k].key;_.indexOf(idList,deviceId)<0&&idList.push(deviceId)}}}this.netmapOperator.showHighlightBg(idList)}}else if(layoutItem.bigType===TemplateLayoutType.SampleLayout){var sampleMap=layoutItem.originalLayout;var sampleType=sampleMap.createStrategy;var categoryMgr=netBrain.Map.CategoryMgr;if(sampleType===SampleMapCreateStrategyEnum.byHostName){var deviceList=_.filter(sampleMap.content.nodeDataArray,(function(item){return!item.category||categoryMgr.isNetworkDevice(item.category)}));idList=_.pluck(deviceList,"key");this.netmapOperator.showHighlightBg(idList)}else if(sampleType===SampleMapCreateStrategyEnum.byAssignTag){idList=_.pluck(_.flatten(_.map(sampleMap.content.tags,(function(item){return item.devices}))),"key");this.netmapOperator.showHighlightBg(idList)}}}return idList}function doGetAllLayouts(layoutToolsHelper){return $q.all([doGetMapLayouts(layoutToolsHelper),doGetSampleMaps(layoutToolsHelper)]).then((function(layouts){return _.chain(layouts).flatten().sortBy(getNameOrder).sortBy(getCategoryOrder).sortBy(getTypeOrder).sortBy(getSimilarityCoefficientOrder).value()})).then((function(layouts){return(geometryLayouts=mapContextMenuManager.getLayoutMenu(mapManagerSrvc.getActivePage().getTopologyType()),$q.resolve(geometryLayouts).then((function(innerGeometryLayouts){return _.map(innerGeometryLayouts,(function(item,id){return function(item){return{text:getGeometryName(item.bigImage),oldText:item.title,image:getGeometryIconName(item.bigImage),image110:getGeometryIconName(item.bigImage,"sl110"),image70:getGeometryIconName(item.bigImage,"s70"),matchedCount:0,similarityCoefficientPercentage:0,bigType:TemplateLayoutType.GeometryLayout,originalLayout:_.extend({},item,{similarityCoefficient:1,id:item.bigImage}),orientation:OrientationEnum.tt,layoutId:item.bigImage}}(item)}))}))).then((function(geometries){return[].concat(layouts).concat(geometries)}));var geometryLayouts})).then(setId)}function getNameOrder(layout){return layout.originalLayout.name}function getCategoryOrder(layout){return layout.originalLayout.createStrategy||layout.originalLayout.type}function getTypeOrder(layout){return layout.type}function getSimilarityCoefficientOrder(layout){return-layout.originalLayout.similarityCoefficient}function doGetMapLayouts(layoutToolsHelper){return httpMapLayoutSrvc.getAllLayoutStyleByPage().then((function(mapLayouts){var mapLayoutList=_.map(mapLayouts,(function(item){return _.extend(item,{orientation:(dir=item.direction,dir===MapLayoutDirectionEnum.top?OrientationEnum.tt:dir===MapLayoutDirectionEnum.right?OrientationEnum.rr:dir===MapLayoutDirectionEnum.left?OrientationEnum.ll:dir===MapLayoutDirectionEnum.bottom?OrientationEnum.bb:OrientationEnum.tt)});var dir}));var matchInfos=layoutToolsHelper.getTemplateStylesMatchInfo(mapLayoutList);return _.map(mapLayouts,(function(mapLayout,index){return function(item){var icon=MapLayoutTypeIconList[item.mapLayout.type];item.mapLayout.layoutLayers=item.mapLayout.layers;return{text:item.mapLayout.name,image:getImageSize(item.mapLayout,110),image70:getImageSize(item.mapLayout,70),matchedCount:item.matchInfo.matchedCount,similarityCoefficientPercentage:item.matchInfo.similarityCoefficientPercentage,bigType:TemplateLayoutType.MapLayout,originalLayout:_.extend({},item.mapLayout,item.matchInfo,{unassignedDeviceCount:item.matchInfo.unAssignedCount}),orientation:item.mapLayout.orientation,tImg:icon.t.size70,bImg:icon.b?icon.b.size70:"",lImg:icon.l?icon.l.size70:"",rImg:icon.r?icon.r.size70:"",tImg110:icon.t.size110,bImg110:icon.b?icon.b.size110:"",lImg110:icon.l?icon.l.size110:"",rImg110:icon.r?icon.r.size110:"",tImg70:icon.t.size70,bImg70:icon.b?icon.b.size70:"",lImg70:icon.l?icon.l.size70:"",rImg70:icon.r?icon.r.size70:"",layoutId:item.mapLayout.id}}({mapLayout:mapLayout,matchInfo:matchInfos[index]})}))}))}function doGetSampleMaps(layoutToolsHelper){return httpMapLayoutSrvc.getAllSampleMap().then((function(sampleMaps){var matchInfos=layoutToolsHelper.getSampleMapMatchInfo(sampleMaps);return _.map(sampleMaps,(function(sampleMap,index){return convertSampleMap({sampleMap:sampleMap,matchInfo:matchInfos[index]})}))}))}function getImageSize(mapLayout,size){return MapLayoutTypeIconList[mapLayout.type][mapLayout.orientation]["size"+size]}function convertSampleMap(item){var iconObj=null;var smallImg="";var mapStyle="";var iconType="class";try{iconObj=JSON.parse(item.sampleMap.iconString)}catch(e){console.error(convertSampleMap,e)}if(iconObj){smallImg=iconObj.smallImg;iconType="image";mapStyle=iconObj.mapStyle||""}else{smallImg="layout_by_tags_highlight";iconType="class"}return{text:item.sampleMap.name,image:smallImg,iconType:iconType,matchedCount:item.matchInfo.matchedCount,similarityCoefficientPercentage:item.matchInfo.similarityCoefficientPercentage,bigType:TemplateLayoutType.SampleLayout,createStrategy:item.sampleMap.createStrategy,originalLayout:_.extend({},item.sampleMap,{mapStyle:mapStyle},item.matchInfo),orientation:OrientationEnum.tt,layoutId:item.sampleMap.id}}}}(NetBrain);!function(netBrain){angular.module("nb.qmap").directive("nbMapLayoutDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutDirective.html",scope:{netmapOperator:"="},link:function(scope,element,attrs){},controller:Controller,replace:!0}}]);Controller.$inject=["$compile","$scope","$document","$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.netbrain.httpDeviceSrvc","nb.common.nbTipSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","uiGridTreeBaseService","$uibModal","nb.qmap.httpMapLayoutSrvc"];function Controller($compile,$scope,$document,element,attr,$timeout,$rootScope,$q,mapManagerSrvc,httpDeviceSrvc,nbTipSrvc,mapContextMenuManager,updateMapSrvc,uiGridTreeBaseService,$uibModal,httpMapLayoutSrvc){var MapLayoutWording=NetBrain.MapLayout.Const.Wording.MapLayout;var mapLayoutType=NetBrain.MapLayout.Const.MapLayoutType;var layoutTypeEnums=[mapLayoutType.multiTier,mapLayoutType.pairing,mapLayoutType.pie,mapLayoutType.circle];var mapLayoutTypeIconList=["undefined",{t:{size137:"layout_by_tags_1_01",size355:"Layout_Style_1_1_big",size88:"Layout_Style_1_1",size70:"layout-1_01_small"},b:{size137:"layout_by_tags_1_02",size355:"Layout_Style_1_4_big",size88:"Layout_Style_1_4",size70:"layout-1_04_small"},l:{size137:"layout_by_tags_1_04",size355:"Layout_Style_1_3_big",size88:"Layout_Style_1_3",size70:"layout-1_03_small"},r:{size137:"layout_by_tags_1_03",size355:"Layout_Style_1_2_big",size88:"Layout_Style_1_2",size70:"layout-1_02_small"}},{t:{size137:"layout_by_tags_2_01",size355:"Layout_Style_2_1_big",size88:"Layout_Style_2_1",size70:"layout-2_01_small"},l:{size137:"layout_by_tags_2_02",size355:"Layout_Style_2_2_big",size88:"Layout_Style_2_2",size70:"layout-2_02_small"}},{t:{size137:"layout_by_tags_3",size355:"Layout_Style_3_big"}},{t:{size137:"layout_by_tags_4",size355:"Layout_Style_4_big"}},{}];var MapLayoutDirectionEnum=NetBrain.MapLayout.Const.MapLayoutDirection;var orientationEnum=NetBrain.MapLayout.Const.OrientationEnum;var mapLayoutTypeDirection=["undefined",[orientationEnum.tt,orientationEnum.bb,orientationEnum.ll,orientationEnum.rr],[orientationEnum.tt,orientationEnum.ll],[orientationEnum.tt],[orientationEnum.tt],{}];var tools=null;var categoryMgr=netBrain.Map.CategoryMgr;var runWatchScrollHeight=!1;$scope.previousOrientation=orientationEnum.tt;var SampleMapCreateStrategyEnum=NetBrain.MapLayout.Const.SampleMapCreateStrategy;var highlightDeviceIdList=null;function getGeometryIconName(type){var ico="";"Symmetric_Layout"===type?ico="layout_by_geometry_1":"Circular_Layout"===type?ico="layout_by_geometry_2":"Hierarchical_Layout"===type?ico="layout_by_geometry_4":"Orthogonal_Layout"===type?ico="layout_by_geometry_3":"Tree_Layout_Up"===type?ico="layout_by_geometry_5":"Tree_Layout_Down"===type&&(ico="layout_by_geometry_6");return ico}$scope.onRefreshButtonClick=function(){$scope.netmapOperator.hideHighlightBg();init()};function initSecondDivControlStatus(){$scope.buttonStatus={saveTagsDisabled:!0,applyToMapDisabled:!0};$scope.selectedUnassignedRows=[];$scope.selectedMatchedRows=[];var matchedCheckAll=element.find(".is-check-all-in-matched-list")[0];matchedCheckAll&&(matchedCheckAll.indeterminate=!1);var unassignedCheckAll=element.find(".is-check-all-in-unassigned-list")[0];unassignedCheckAll&&(unassignedCheckAll.indeterminate=!1);$scope.isCheckAllOption={matchedCheck:!1,unassignedCheck:!1}}function init(){$scope.mapLayoutTypeIconList=mapLayoutTypeIconList;$scope.mapLayoutTypeDirection=mapLayoutTypeDirection;$scope.orientationEnum={tt:"t",bb:"b",ll:"l",rr:"r"};$scope.popoverIsOpenCurrentIndex=-99;$scope.selectedTagsLayoutType=null;$scope.selectedLayoutItem=null;$scope.selectedLayoutItemId=0;$scope.selectedOrientation="t";$scope.selectedSampleMapItem=null;$scope.showPane="first";$scope.geometryViewShowMore=!0;$scope.tagsViewShowMore=!0;$scope.sampleViewShowMore=!0;$scope.geometryViewExpanded=!0;$scope.tagsViewExpanded=!0;$scope.sampleViewExpanded=!0;$scope.geometryLayoutCss="";$scope.geometryListCss="";$scope.tagsLayoutCss="";$scope.tagsListCss="";$scope.sampleViewCss="";$scope.sampleListCss="";$scope.currentStyleId="";$scope.geometryLayoutList=[];$scope.geometryLayoutCount=0;$scope.tagsLayoutOriginalList=[];$scope.mapLayoutList=[];$scope.mapLayoutCount=0;$scope.showTagLayoutList=!0;$scope.sampleLayoutOriginalList=[];$scope.sampleLayoutList=[];$scope.sampleMapLayoutCount=0;$scope.showSampleMapLayoutList=!0;$scope.isHighlight={value:!1};runWatchScrollHeight=!1;$scope.showLayoutDropdownInSecond=!1;$scope.previousOrientation=orientationEnum.tt;highlightDeviceIdList.splice(0,highlightDeviceIdList.length);initSecondDivControlStatus();var mapPageId=netBrain.Map.currentActiveMap.getDocId();highlightDeviceIdList=NetBrain.MapLayout.Const.MapLayoutHighlightOption.getDeviceIdList(mapPageId);$scope.geometryLayoutList=mapContextMenuManager.getLayoutMenu(mapManagerSrvc.getActivePage().getTopologyType());for(var i=0;i<$scope.geometryLayoutList.length;i++){$scope.geometryLayoutList[i].currentStyleId=i;$scope.geometryLayoutList[i].ico=getGeometryIconName($scope.geometryLayoutList[i].bigImage)}$scope.geometryLayoutCount=$scope.geometryLayoutList.length;if(NetBrain.Map.Const.MapType.overViewMap===netBrain.Map.currentActiveMap.qmapJsWrapper.qmapdata.mapType){$scope.showTagLayoutList=!1;$scope.showSampleMapLayoutList=!1}(tools=new netBrain.Map.LayoutToolsHelper($scope.netmapOperator)).refreshCachedTags().then((function(){loadLayout();!function(){var defer=$q.defer();httpMapLayoutSrvc.getAllSampleMap({pageNumber:0,pageSize:5e4}).then((function(result){var devices=result;$scope.sampleMapLayoutCount=0;var matchedByDevice=tools.getSampleMapMatchInfo(devices);matchedByDevice=_.sortBy(matchedByDevice,(function(item){return item.name}));matchedByDevice=_.sortBy(matchedByDevice,(function(item){return item.createStrategy}));matchedByDevice=_.sortBy(matchedByDevice,(function(item){return-item.similarityCoefficient}));var matchedList=[];for(var i=0;i<matchedByDevice.length;i++){var sampleItem=matchedByDevice[i];sampleItem.currentStyleId=sampleItem.id;sampleItem.matchedTotal=sampleItem.matchedCount;try{sampleItem.smallImg=JSON.parse(sampleItem.iconString).smallImg}catch(e){sampleItem.smallImg=sampleItem.iconString}sampleItem.similarityCoefficient>0&&matchedList.push(sampleItem)}$scope.sampleLayoutOriginalList=matchedList;$scope.sampleLayoutList=matchedList;$scope.sampleMapLayoutCount=matchedList.length;defer.resolve()}));defer.promise}()}))}function loadLayout(){var defer=$q.defer();httpMapLayoutSrvc.getAllLayoutStyleByPage({pageNumber:0,pageSize:5e4}).then((function(result){var originalList=result;for(var i=0;i<originalList.length;i++){var originalItem=originalList[i];originalItem.orientation=(dir=originalItem.direction)===MapLayoutDirectionEnum.top?orientationEnum.tt:dir===MapLayoutDirectionEnum.right?orientationEnum.rr:dir===MapLayoutDirectionEnum.left?orientationEnum.ll:dir===MapLayoutDirectionEnum.bottom?orientationEnum.bb:orientationEnum.tt}var dir;$scope.tagsLayoutOriginalList=originalList;var matchedResult=tools.getTemplateStylesMatchInfo(originalList);var sortedMatchedResult=_.sortBy(matchedResult,(function(item){return-item.similarityCoefficient}));console.warn("matchedResult:",matchedResult);$scope.mapLayoutCount=0;var layoutType;var _layoutItem;var _originalItem;for(var j=0;j<layoutTypeEnums.length;j++){layoutType=layoutTypeEnums[j];var originalArr=_.where($scope.tagsLayoutOriginalList,{type:layoutType});_layoutItem={type:layoutType,iconName:mapLayoutTypeIconList[layoutType].t.size137,orientation:originalArr&&originalArr[0]?originalArr[0].orientation:$scope.orientationEnum.tt,currentStyleId:30+j,layouts:[],matchedTotal:0};$scope.mapLayoutList.push(_layoutItem)}for(var k=0;k<sortedMatchedResult.length;k++){var matchedItem=sortedMatchedResult[k];if(0!==matchedItem.matchedCount){var _originalItemIndex=_.findIndex(originalList,{id:matchedItem.id});if(_originalItemIndex>=0){layoutType=(_originalItem=originalList[_originalItemIndex]).type;var mapLayoutTypeItemIndex=_.findIndex($scope.mapLayoutList,{type:layoutType});if(mapLayoutTypeItemIndex>=0){var mapLayoutTypeItem=$scope.mapLayoutList[mapLayoutTypeItemIndex];(_layoutItem={}).id=_originalItem.id;_layoutItem.name=_originalItem.name;_layoutItem.type=_originalItem.type;_layoutItem.orientation=_originalItem.orientation;_layoutItem.matchedCount=matchedItem.matchedCount;var unAssignedCount=0;for(var m=0;m<matchedItem.unAssignedDevices.length;m++){var unAssignDev=matchedItem.unAssignedDevices[m];categoryMgr.isNetworkDevice(unAssignDev.category)&&unAssignedCount++}_layoutItem.unAssignedCount=unAssignedCount;_layoutItem.unAssignedDevices=matchedItem.unAssignedDevices;_layoutItem.layers=matchedItem.layers;_layoutItem.layoutLayers=_originalItem.layers;mapLayoutTypeItem.layouts.push(_layoutItem)}}}}for(var l=0;l<$scope.mapLayoutList.length;l++){var layout=$scope.mapLayoutList[l];layout.layouts.length>0&&$scope.mapLayoutCount++;var firstLayoutMatchCount=0;layout.layouts&&layout.layouts.length>0&&(firstLayoutMatchCount=layout.layouts[0].matchedCount);layout.matchedTotal=firstLayoutMatchCount}defer.resolve();console.log("$scope.mapLayoutList-------------------------",$scope.mapLayoutList)}));return defer.promise}$scope.onClickGeometryLayout=function(layoutItem){closeTagsLayoutPopover();updateMapSrvc.canUpdateCurrentMap().then((function(){layoutItem.action();$scope.currentStyleId=layoutItem.currentStyleId}));$scope.netmapOperator.hideHighlightBg()};$scope.onClickGeometryExpanded=function(){$scope.geometryViewExpanded=!$scope.geometryViewExpanded;if($scope.geometryViewExpanded){$scope.geometryLayoutCss={};$scope.onClickGeometryViewMore($scope.geometryViewShowMore)}else $scope.geometryLayoutCss={height:"28px"}};$scope.onClickGeometryViewMore=function(showMore){$scope.geometryViewShowMore=showMore;$scope.geometryViewShowMore?$scope.geometryListCss={}:$scope.geometryListCss={height:"auto"}};function doLayoutStyle(_previousOrientation,changeToLayout){changeToLayout.type===mapLayoutType.multiTier?tools.parallelStyleLayout(changeToLayout):changeToLayout.type===mapLayoutType.pairing?tools.symmetricalParallelStyleLayout(changeToLayout):changeToLayout.type===mapLayoutType.pie?tools.petalLayout(changeToLayout):changeToLayout.type===mapLayoutType.circle&&tools.ringLayout(changeToLayout);var changeTo=changeToLayout.selectedOrientation?changeToLayout.selectedOrientation:changeToLayout.orientation;tools.rotateMap(_previousOrientation,changeTo)}function closeTagsLayoutPopover(){$scope.popoverIsOpenCurrentIndex=-99}function refreshTagsLayoutItem(tagsLayoutItem,currIndex,forceRefresh){var isCurrent=!1;$scope.popoverIsOpenCurrentIndex!==currIndex||forceRefresh||(isCurrent=!0);closeTagsLayoutPopover();$scope.popoverIsOpenCurrentIndex=currIndex;$scope.selectedTagsLayoutType=tagsLayoutItem;var icon=mapLayoutTypeIconList[tagsLayoutItem.type];$scope.selectedTagsLayoutType.tImg=icon.t.size137;$scope.selectedTagsLayoutType.bImg=icon.b?icon.b.size137:"";$scope.selectedTagsLayoutType.lImg=icon.l?icon.l.size137:"";$scope.selectedTagsLayoutType.rImg=icon.r?icon.r.size137:"";tagsLayoutItem.layouts&&tagsLayoutItem.layouts.length>0&&updateMapSrvc.canUpdateCurrentMap().then((function(){$scope.currentStyleId=tagsLayoutItem.currentStyleId;var changeToLayout=tagsLayoutItem.layouts[0];if(tagsLayoutItem.lastSelectedLayout){var lastSelectedLayoutIndex=_.findIndex(tagsLayoutItem.layouts,{id:tagsLayoutItem.lastSelectedLayout.id});lastSelectedLayoutIndex>=0&&(tagsLayoutItem.lastSelectedLayout=tagsLayoutItem.layouts[lastSelectedLayoutIndex]);changeToLayout=tagsLayoutItem.lastSelectedLayout}var changeToLayoutCopy=_.clone(changeToLayout);doLayoutStyle($scope.previousOrientation,changeToLayoutCopy);$scope.previousOrientation=changeToLayout.orientation;if(!isCurrent){$scope.selectedLayoutItem=changeToLayout;$scope.selectedLayoutItemId=changeToLayout.id;$scope.selectedOrientation=changeToLayout.orientation;$scope.selectedLayoutItem.selectedOrientation=changeToLayout.orientation}showOrHideHighlightBg($scope.isHighlight.value)}))}$scope.onClickTagsLayout=function(tagsLayoutItem,currIndex,event){$scope.previousOrientation=orientationEnum.tt;refreshTagsLayoutItem(tagsLayoutItem,currIndex,!1);$timeout((function(){var arr=angular.element(event.target).closest(".img-item").next().find(".arrow");(currIndex+1)%3==1?arr.removeClass("arrow2").removeClass("arrow3").addClass("arrow1"):(currIndex+1)%3==2?arr.removeClass("arrow1").removeClass("arrow3").addClass("arrow2"):(currIndex+1)%3==0&&arr.removeClass("arrow1").removeClass("arrow2").addClass("arrow3");var btnDropdown=element.find(".layout-dropdown button.dropdown-toggle .caret");btnDropdown&&btnDropdown.removeClass("caret").addClass("icon_nb_arrow_down")}),20)};function setCurrentSelectedLayout(layout){var mapLayoutTypeItem=_.find($scope.mapLayoutList,(function(item){return item.type===layout.type}));if(mapLayoutTypeItem){mapLayoutTypeItem.lastSelectedLayout=layout;mapLayoutTypeItem.matchedTotal=layout.matchedCount}}$scope.onChangeLayoutDropdown=function(item){$scope.selectedLayoutItem=item;$scope.selectedLayoutItemId=item.id;$scope.selectedOrientation=item.orientation;$scope.selectedLayoutItem.selectedOrientation=item.orientation;setCurrentSelectedLayout(item);var changeToLayout=_.clone($scope.selectedLayoutItem);doLayoutStyle($scope.previousOrientation,changeToLayout);$scope.previousOrientation=changeToLayout.orientation;showOrHideHighlightBg($scope.isHighlight.value)};$scope.onClickDirection=function(orientation){$scope.selectedOrientation=orientation;$scope.selectedLayoutItem.selectedOrientation=orientation;_.clone($scope.selectedLayoutItem).orientation=orientation;tools.rotateMap($scope.previousOrientation,orientation);$scope.previousOrientation=$scope.selectedLayoutItem.selectedOrientation};$scope.onBtnHighlightClick=function(event){var isCheck=angular.element(event.target).is(":checked");$scope.isHighlight.value=isCheck;showOrHideHighlightBg(isCheck)};function showOrHideHighlightBg(isShow){var idList=[];var layoutItem=$scope.selectedLayoutItem;$scope.netmapOperator.hideHighlightBg();highlightDeviceIdList&&highlightDeviceIdList.splice(0,highlightDeviceIdList.length);if(isShow){if(_.findIndex($scope.mapLayoutList,{currentStyleId:$scope.currentStyleId})>=0){if(layoutItem&&layoutItem.layers&&_.isArray(layoutItem.layers)){for(var i=0;i<$scope.selectedLayoutItem.layers.length;i++){var layer=$scope.selectedLayoutItem.layers[i];if(layer.tags&&_.isArray(layer.tags))for(var j=0;j<layer.tags.length;j++){var tag=layer.tags[j];if(tag.devices&&_.isArray(tag.devices))for(var k=0;k<tag.devices.length;k++){var deviceId=tag.devices[k].key;_.indexOf(idList,deviceId)<0&&idList.push(deviceId)}}}$scope.netmapOperator.showHighlightBg(idList)}}else if(_.findIndex($scope.sampleLayoutList,{currentStyleId:$scope.currentStyleId})>=0){var sampleType=$scope.selectedSampleMapItem.createStrategy;if(sampleType===SampleMapCreateStrategyEnum.byHostName){var devIdList=_.pluck($scope.selectedSampleMapItem.content.nodeDataArray,"key");$scope.netmapOperator.showHighlightBg(devIdList)}else if(sampleType===SampleMapCreateStrategyEnum.byAssignTag){var deviceIdList=_.pluck(_.flatten(_.map($scope.selectedSampleMapItem.content.tags,(function(item){return item.devices}))),"key");$scope.netmapOperator.showHighlightBg(deviceIdList)}}for(var z=0;z<idList.length;z++)highlightDeviceIdList.push(idList[z])}}$scope.onClickAdjustLayout=function(){runWatchScrollHeight=!1;$scope.showLayoutDropdownInSecond=!1;var layeredLayout=convertLayout($scope.selectedLayoutItem);!function(){$scope.matchedGridOptions={data:"matchedData",multiSelect:!0,enableSelection:!0,modifierKeysToMultiSelect:!1,enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableColumnMenus:!1,keepLastSelected:!0,columnDefs:[{field:"isCheck",displayName:"",width:"30",cellTemplate:('<div class="ui-grid-cell-contents" style="padding-left: 3px;"><input type="checkbox" ng-disabled="grid.appScope.showMatchedEmptyRow" ng-click="grid.appScope.onClickMatchedGridRowCheck($event, row.entity);" ng-checked="row.entity.isCheck"/></div>','<div class="ui-grid-cell-contents" style="padding-left: 3px;"><input type="checkbox" ng-disabled="grid.appScope.showMatchedEmptyRow" ng-click="grid.appScope.onClickMatchedGridRowCheck($event, row.entity);" ng-checked="row.entity.isCheck"/></div>')},{field:"layerTag",displayName:MapLayoutWording.MatchedGridColumn1Title,width:"220",cellTemplate:getMatchedLayoutTagCellTemplate()},{field:"deviceName",displayName:MapLayoutWording.MatchedGridColumn2Title,width:"170",cellTemplate:getMatchedLayoutDeviceCellTemplate()}],showTreeExpandNoChildren:!1,enableExpandAll:!0,flatEntityAccess:!1,fastWatch:!1,treeIndent:10,enableColumnResizing:!1,enableSorting:!1,onRegisterApi:function(gridApi){$scope.matchedGridApi=gridApi;$scope.matchedGridApi.selection.on.rowSelectionChanged($scope,(function(row){needRunSelected&&(row.isSelected?function(entity){var index;if("folder"===entity.nodeType){if((index=_.findIndex($scope.selectedMatchedRows,{folderId:entity.folderId}))<0){$scope.selectedMatchedRows.push(entity);entity.isCheck=!0}if((index=_.findIndex($scope.matchedData,{folderId:entity.folderId}))>=0)for(var i=index+1;i<$scope.matchedData.length;i++){var matchedItem=$scope.matchedData[i];if("folder"===matchedItem.nodeType)break;if(_.findIndex($scope.selectedMatchedRows,{deviceId:matchedItem.deviceId})<0){$scope.selectedMatchedRows.push(matchedItem);matchedItem.isCheck=!0;needRunSelected=!1;$scope.matchedGridApi.selection.selectRow(matchedItem);needRunSelected=!0}}}else if((index=_.findIndex($scope.selectedMatchedRows,{deviceId:entity.deviceId}))<0){$scope.selectedMatchedRows.push(entity);entity.isCheck=!0;checkFolder(entity)}doArrowClass()}(row.entity):function(entity){var index;if("folder"===entity.nodeType){if((index=_.findIndex($scope.selectedMatchedRows,{folderId:entity.folderId}))>=0){$scope.selectedMatchedRows.splice(index,1);entity.isCheck=!1}if((index=_.findIndex($scope.matchedData,{folderId:entity.folderId}))>=0)for(var i=index+1;i<$scope.matchedData.length;i++){var matchedItem=$scope.matchedData[i];if("folder"===matchedItem.nodeType)break;var selectedIndex=_.findIndex($scope.selectedMatchedRows,{deviceId:matchedItem.deviceId});if(selectedIndex>=0){$scope.selectedMatchedRows.splice(selectedIndex,1);matchedItem.isCheck=!1;needRunSelected=!1;$scope.matchedGridApi.selection.unSelectRow(matchedItem);needRunSelected=!0}}}else if((index=_.findIndex($scope.selectedMatchedRows,{deviceId:entity.deviceId}))>=0){$scope.selectedMatchedRows.splice(index,1);entity.isCheck=!1;checkFolder(entity)}doArrowClass()}(row.entity))}));$scope.matchedGridApi.grid.registerRowsProcessor(matchedSingleFilter,200)}};$scope.unassignedGridOptions={data:"unassignedData",multiSelect:!0,enableSelection:!0,modifierKeysToMultiSelect:!1,enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableColumnMenus:!1,keepLastSelected:!0,columnDefs:[{field:"isCheck",displayName:"",width:"30",cellTemplate:getUnassignedLayoutCheckCellTemplate()},{field:"layerTag",displayName:MapLayoutWording.UnassignedGridColumn1Title,width:"220",cellTemplate:getUnassignedLayoutTagCellTemplate()},{field:"deviceName",displayName:MapLayoutWording.UnassignedGridColumn2Title,width:"170",cellTemplate:getUnassignedLayoutDeviceCellTemplate()}],showTreeExpandNoChildren:!1,enableExpandAll:!0,flatEntityAccess:!1,fastWatch:!1,treeIndent:10,enableColumnResizing:!1,enableSorting:!1,onRegisterApi:function(gridApi){$scope.unassignedGridApi=gridApi;$scope.unassignedGridApi.selection.on.rowSelectionChanged($scope,(function(row){needRunSelected&&(row.isSelected?function(entity){if(_.findIndex($scope.selectedUnassignedRows,{deviceId:entity.deviceId})<0){$scope.selectedUnassignedRows.push(entity);entity.isCheck=!0}doArrowClass()}(row.entity):function(entity){var index=_.findIndex($scope.selectedUnassignedRows,{deviceId:entity.deviceId});if(index>=0){$scope.selectedUnassignedRows.splice(index,1);entity.isCheck=!1}doArrowClass()}(row.entity))}));$scope.unassignedGridApi.grid.registerRowsProcessor(unassignedSingleFilter,200)}}}();var deviceIds=_.pluck(layeredLayout.unAssignedDevices,"deviceId");httpMapLayoutSrvc.getDeviceTagByGuids(deviceIds).then((function(deviceData){var trueList=_.pluck(deviceData,"ID");var result=getMatchedData(layeredLayout,trueList);$scope.matchedData=result.matchedList;$scope.unassignedData=result.unassignedList;showEmptyRow(!0);$timeout((function(){var btnDropdown=element.find(".second-layout-dropdown button.dropdown-toggle .caret");btnDropdown&&btnDropdown.removeClass("caret").addClass("icon_nb_arrow_up_blue");var btnDropdown2=element.find(".second-layout-dropdown button.dropdown-toggle div.icon-container span");btnDropdown2&&btnDropdown2.removeClass("icon_nb_arrow_down").addClass("icon_nb_arrow_up_blue")}),0);initSecondDivControlStatus();runWatchScrollHeight=!0}));$scope.showPane="second"};$scope.onClickTagsExpanded=function(){closeTagsLayoutPopover();$scope.tagsViewExpanded=!$scope.tagsViewExpanded;if($scope.tagsViewExpanded){$scope.tagsLayoutCss={};$scope.onClickTagsViewMore($scope.tagsViewShowMore)}else $scope.tagsLayoutCss={height:"28px"}};$scope.onClickTagsViewMore=function(showMore){closeTagsLayoutPopover();$scope.tagsViewShowMore=showMore;$scope.tagsViewShowMore?$scope.tagsListCss={}:$scope.tagsListCss={height:"auto"}};$scope.onCloseTip=function(){closeTagsLayoutPopover()};$scope.onClickSampleExpanded=function(){$scope.sampleViewExpanded=!$scope.sampleViewExpanded;if($scope.sampleViewExpanded){$scope.sampleViewCss={};$scope.onClickSampleViewMore($scope.sampleViewShowMore)}else $scope.sampleViewCss={height:"28px"}};$scope.onClickSampleViewMore=function(showMore){$scope.sampleViewShowMore=showMore;$scope.sampleViewShowMore?$scope.sampleListCss={}:$scope.sampleListCss={height:"auto"}};$scope.onClickSampleLayout=function(sampleLayoutItem){$scope.currentStyleId=sampleLayoutItem.currentStyleId;sampleLayoutItem.createStrategy==SampleMapCreateStrategyEnum.byHostName?tools.sampleMapByDeviceLayout(sampleLayoutItem.content):sampleLayoutItem.createStrategy==SampleMapCreateStrategyEnum.byAssignTag&&sampleLayoutItem.content&&tools.sampleMapByTagLayout(sampleLayoutItem.content);$scope.selectedSampleMapItem=sampleLayoutItem;showOrHideHighlightBg($scope.isHighlight.value)};$scope.secondDirectionExpanded=!0;$scope.secondMatchedExpanded=!0;$scope.secondUnassignedExpanded=!0;$scope.secondDirectionCss={};$scope.secondMatchedCss={};$scope.secondUnassignedCss={};$scope.onCloseSecond=function(){$scope.showLayoutDropdownInSecond=!1;$scope.showPane="first"};function convertLayout(layoutItem){var resultLayout=_.clone(layoutItem);for(var j=0;j<resultLayout.layers.length;j++){var layerItem=resultLayout.layers[j];for(var k=0;k<layerItem.tags.length;k++){var tagItem=layerItem.tags[k];for(var l=0;l<tagItem.devices.length;l++){var device=tagItem.devices[l];device.deviceName=device.hostName;device.deviceId=device.key;device.isPinned=!!device.isPinned}}}for(var i=0;i<resultLayout.unAssignedDevices.length;i++){var unAssignItem=resultLayout.unAssignedDevices[i];unAssignItem.deviceName=unAssignItem.hostName;unAssignItem.deviceId=unAssignItem.key;unAssignItem.isPinned=!!unAssignItem.isPinned}return resultLayout}$scope.onChangeLayoutDropdownInSecond=function(item){$scope.selectedLayoutItem=item;$scope.selectedLayoutItemId=item.id;$scope.selectedOrientation=item.orientation;$scope.selectedLayoutItem.selectedOrientation=item.orientation;setCurrentSelectedLayout(item);refreshMatchedList($scope.selectedLayoutItem);initSecondDivControlStatus()};function refreshMatchedList(selectedLayoutItem){var layeredLayout=convertLayout(selectedLayoutItem);var deviceIds=_.pluck(layeredLayout.unAssignedDevices,"deviceId");httpMapLayoutSrvc.getDeviceTagByGuids(deviceIds).then((function(deviceData){var trueList=_.pluck(deviceData,"ID");var result=getMatchedData(layeredLayout,trueList);$scope.matchedData=result.matchedList;$scope.unassignedData=result.unassignedList;$scope.isCheckAllOption.unassignedCheck=!1;$scope.isCheckAllOption.matchedCheck=!1;showEmptyRow(!1);$scope.isCheckAllOption.matchedCheck=!1}))}$scope.onChangeLayoutSelectInSecond=function(){var index=_.findIndex($scope.selectedTagsLayoutType.layouts,{id:$scope.selectedLayoutItemId});if(index>=0){var layout=$scope.selectedTagsLayoutType.layouts[index];$scope.selectedLayoutItem=layout;setCurrentSelectedLayout(layout)}};function showEmptyRow(isRunWatch){if(0===$scope.matchedData.length){$scope.matchedData=[];$scope.showMatchedEmptyRow=!0}else $scope.showMatchedEmptyRow=!1;if(0===$scope.unassignedData.length){$scope.unassignedData=[];$scope.showUnassignedEmptyRow=!0}else $scope.showUnassignedEmptyRow=!1;$timeout((function(){var matchedGrid=element.find(".matched-content .nsGridStyle");var unassignedGrid=element.find(".unassigned-content .nsGridStyle");$scope.showMatchedEmptyRow?matchedGrid.addClass("nsGridStyle-empty"):matchedGrid.removeClass("nsGridStyle-empty");$scope.showUnassignedEmptyRow?unassignedGrid.addClass("nsGridStyle-empty"):unassignedGrid.removeClass("nsGridStyle-empty");isRunWatch&&console.warn(isRunWatch);$scope.showLayoutDropdownInSecond=!0}))}$scope.showMatchedEmptyRow=!1;$scope.showUnassignedEmptyRow=!1;$scope.onSecondOrientationExpanded=function(){$scope.secondDirectionExpanded=!$scope.secondDirectionExpanded;$scope.secondDirectionExpanded?$scope.secondDirectionCss={}:$scope.secondDirectionCss={height:0}};$scope.onSecondMatchedExpanded=function(){$scope.secondMatchedExpanded=!$scope.secondMatchedExpanded;$scope.secondMatchedExpanded?$scope.secondMatchedCss={}:$scope.secondMatchedCss={height:0}};$scope.onSecondUnassignedExpanded=function(){$scope.secondUnassignedExpanded=!$scope.secondUnassignedExpanded;$scope.secondUnassignedExpanded?$scope.secondUnassignedCss={}:$scope.secondUnassignedCss={height:0}};$scope.unassignedData=[];$scope.matchedData=[];$scope.matchedGridApi=null;$scope.filterObj={matchedFilterValue:"",unassignedFilterValue:""};$scope.selectedMathcedRow=null;$scope.toggleRow=function(row,event){uiGridTreeBaseService.toggleRowTreeState($scope.matchedGridApi.grid,row,event)};function getMatchedLayoutTagCellTemplate(){return'<div class="ui-grid-cell-contents"><span style="cursor: pointer;width: 20px; height: 17px;" ng-click="grid.appScope.toggleRow(row, $event)"><i ng-class="{\'ui-grid-icon-minus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'expanded\', \'ui-grid-icon-plus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'collapsed\'}" ng-style="{\'margin-left\': grid.options.treeIndent * row.treeLevel + \'px\'}" style=" width: 10px;height: 10px;display: inline-block;">&nbsp;</i></span><span style="margin-left: 10px;" ng-show="row.entity.nodeType===\'folder\'">{{row.entity.layerTag}}</span><select class="drop-layer-tag icon_nb_arrow_up_blue" ng-change="grid.appScope.onChangeMatchedSelect($event, row.entity)" ng-model="row.entity.selected" ng-show="row.entity.nodeType===\'node\'">    <option title="{{item.menuTitle}}" value="{{item.menuTitle}}" ng-repeat="item in grid.appScope.matchedLayerTagMenu">{{item.menuTitle}}</option></select></div>'}$scope.onChangeMatchedSelect=function(event,entity){var selected=entity.selected;var arr=selected.split(":");var level=arr[0].split(" ")[1];var tag=arr[1];var dataChanged=entity.tag!=tag;entity.layerLevel=level;entity.tag=tag;entity.layerTag=selected;if(dataChanged){$scope.buttonStatus.saveTagsDisabled=!1;$scope.buttonStatus.applyToMapDisabled=!1}};function getMatchedLayoutDeviceCellTemplate(){return'<div class="ui-grid-cell-contents"><span ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.matchedFilterValue">{{row.entity.deviceName}}</span></div>'}$scope.matchedFilter=function(event,clear){if("clear"===clear||13===event.keyCode||27===event.keyCode){27===event.keyCode&&($scope.filterObj.matchedFilterValue="");"clear"===clear&&($scope.filterObj.matchedFilterValue="");$scope.matchedGridApi.grid.refresh()}};function matchedSingleFilter(renderableRows){var matcher=new RegExp($scope.filterObj.matchedFilterValue,"i");renderableRows.forEach((function(row){var match=!1;["layerTag","deviceName"].forEach((function(field){row.entity[field].match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderableRows}$scope.onShowMatchedOption=function(){$uibModal.open({templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutSettings.html",controller:"nb.qmap.nbMapLayoutSettingsCtrl",windowClass:"map-layout-setting-ctrl",backdrop:"static",size:"sm",resolve:{mapLayoutSettingsHandle:function(){return{layoutItem:$scope.selectedLayoutItem}}}}).result.then((function(resolve){var layoutItem=resolve.layoutItem;var layers=layoutItem.layers;var layoutLayers=layoutItem.layoutLayers;for(var i=0;i<layers.length;i++)layers[i].scale=layoutLayers[i].scale;$scope.buttonStatus.applyToMapDisabled=!1}))};function getMatchedData(layeredLayout,trueList){var matchedLayerTagMenu=[];var unassignedLayerTagMenu=[{menuTitle:"None",layer:"None",tag:"None",no:NgUtil.getUniqueStr()}];var matchedList=[];for(var i=0;i<layeredLayout.layers.length;i++){var layer=layeredLayout.layers[i];var layerLevel=i+1;for(var j=0;j<layer.tags.length;j++){var tag=layer.tags[j];var layerTag="Layer "+layerLevel+":"+tag.name;var matchedParent={isCheck:!1,layerTag:layerTag+("("+tag.devices.length+")"),layerLevel:layerLevel,tag:tag.name,deviceName:"",folderId:NgUtil.getUniqueStr(),deviceId:"",isPinned:!1,nodeType:"folder",$$treeLevel:0};matchedList.push(matchedParent);for(var k=0;k<tag.devices.length;k++){var device=tag.devices[k];var matchedDevice={isCheck:!1,layerTag:layerTag,layerLevel:layerLevel,tag:tag.name,deviceName:device.deviceName,folderId:"",deviceId:device.deviceId,isPinned:device.isPinned,nodeType:"node",$$treeLevel:1};matchedDevice.selected=layerTag;matchedDevice.oldTag=matchedDevice.tag;matchedList.push(matchedDevice)}var menuItem={menuTitle:layerTag,layerLevel:layerLevel,tag:tag.name,no:NgUtil.getUniqueStr()};matchedLayerTagMenu.push(menuItem);unassignedLayerTagMenu.push(menuItem)}}for(var m=0;m<matchedList.length;m++){matchedList[m].layerTagMenu=matchedLayerTagMenu}var unassignedList=[];for(var l=0;l<layeredLayout.unAssignedDevices.length;l++){var item=layeredLayout.unAssignedDevices[l];var isDevice=categoryMgr.isNetworkDevice(item.category);var isTrue=!0;if(trueList&&_.isArray(trueList)){isTrue=_.indexOf(trueList,item.deviceId)>=0}if(isDevice&&isTrue){var unassignedDevice={layerTag:"",layerLevel:0,tag:"None",deviceName:item.deviceName,deviceId:item.deviceId,isPinned:item.isPinned};unassignedDevice.layerTagMenu=unassignedLayerTagMenu;unassignedDevice.selected=unassignedLayerTagMenu[0].menuTitle;unassignedList.push(unassignedDevice)}}$scope.selectedLayoutItem.unAssignedCount=unassignedList.length;$scope.matchedLayerTagMenu=matchedLayerTagMenu;$scope.unassignedLayerTagMenu=unassignedLayerTagMenu;return{matchedList:matchedList,unassignedList:unassignedList}}function doArrowClass(){$timeout((function(){$scope.selectedMatchedRows.length>0?element.find(".btn-bulk-matched .icon").removeClass("icon_nb_arrow_down_disable").addClass("icon_nb_arrow_up_blue"):element.find(".btn-bulk-matched .icon").removeClass("icon_nb_arrow_up_blue").addClass("icon_nb_arrow_down_disable");if($scope.matchedData.length===$scope.selectedMatchedRows.length){$scope.isCheckAllOption.matchedCheck=!0;element.find(".is-check-all-in-matched-list")[0].indeterminate=!1}else if($scope.selectedMatchedRows.length>0)element.find(".is-check-all-in-matched-list")[0].indeterminate=!0;else{$scope.isCheckAllOption.matchedCheck=!1;element.find(".is-check-all-in-matched-list")[0].indeterminate=!1}$scope.selectedUnassignedRows.length>0?element.find(".btn-bulk-unassigned .icon").removeClass("icon_nb_arrow_down_disable").addClass("icon_nb_arrow_up_blue"):element.find(".btn-bulk-unassigned .icon").removeClass("icon_nb_arrow_up_blue").addClass("icon_nb_arrow_down_disable");if($scope.unassignedData.length===$scope.selectedUnassignedRows.length){$scope.isCheckAllOption.unassignedCheck=!0;element.find(".is-check-all-in-unassigned-list")[0].indeterminate=!1}else if($scope.selectedUnassignedRows.length>0)element.find(".is-check-all-in-unassigned-list")[0].indeterminate=!0;else{$scope.isCheckAllOption.unassignedCheck=!1;element.find(".is-check-all-in-unassigned-list")[0].indeterminate=!1}}))}var needRunSelected=!0;function checkFolder(entity){if("node"===entity.nodeType){var index=_.findIndex($scope.matchedData,{deviceId:entity.deviceId});var isAllCheck=!0;var matchedItem;var folderItem;for(var i=index;i>=0;i--){if("folder"===(matchedItem=$scope.matchedData[i]).nodeType){folderItem=matchedItem;break}matchedItem.isCheck||(isAllCheck=!1)}if(isAllCheck)for(var j=index+1;j<$scope.matchedData.length&&"folder"!==(matchedItem=$scope.matchedData[j]).nodeType;j++)if(!matchedItem.isCheck){isAllCheck=!1;break}if(isAllCheck&&folderItem){$scope.selectedMatchedRows.push(folderItem);folderItem.isCheck=!0;needRunSelected=!1;$scope.matchedGridApi.selection.selectRow(folderItem);needRunSelected=!0}if(!isAllCheck&&folderItem){var selectedIndex=_.findIndex($scope.selectedMatchedRows,{folderId:folderItem.folderId});if(selectedIndex>=0){$scope.selectedMatchedRows.splice(selectedIndex,1);folderItem.isCheck=!1;needRunSelected=!1;$scope.matchedGridApi.selection.unSelectRow(folderItem);needRunSelected=!0}}}}$scope.onClickMatchedGridRowCheck=function(event,entity){angular.element(event.target).is(":checked")?$scope.matchedGridApi.selection.selectRow(entity):$scope.matchedGridApi.selection.unSelectRow(entity)};$scope.onClickCheckAllForMatched=function(event){var isCheck=angular.element(event.target).is(":checked");for(var i=0;i<$scope.matchedData.length;i++){var matchedRow=$scope.matchedData[i];isCheck?$scope.matchedGridApi.selection.selectRow(matchedRow):$scope.matchedGridApi.selection.unSelectRow(matchedRow)}};$scope.onClickCheckAllForUnassigned=function(event){var isCheck=angular.element(event.target).is(":checked");for(var i=0;i<$scope.unassignedData.length;i++){var unassignedRow=$scope.unassignedData[i];isCheck?$scope.unassignedGridApi.selection.selectRow(unassignedRow):$scope.unassignedGridApi.selection.unSelectRow(unassignedRow)}};$scope.onClickUnassignedGridRowCheck=function(event,entity){angular.element(event.target).is(":checked")?$scope.unassignedGridApi.selection.selectRow(entity):$scope.unassignedGridApi.selection.unSelectRow(entity)};$scope.selectedMatchedRows=[];$scope.selectedUnassignedRows=[];$scope.unassignedFilter=function(event,clear){if("clear"===clear||13===event.keyCode||27===event.keyCode){27===event.keyCode&&($scope.filterObj.unassignedFilterValue="");"clear"===clear&&($scope.filterObj.unassignedFilterValue="");$scope.unassignedGridApi.grid.refresh()}};function unassignedSingleFilter(renderableRows){var matcher=new RegExp($scope.filterObj.unassignedFilterValue,"i");renderableRows.forEach((function(row){var match=!1;["layerTag","deviceName"].forEach((function(field){row.entity[field].match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderableRows}$scope.layerTagMenuId=NgUtil.getUniqueStr();$scope.bulkAssignTagsDropDownCss={};$scope.layerTagMenu=[{menuTitle:"None",layer:"None",tag:"None",no:NgUtil.getUniqueStr()}];$scope.matchedLayerTagMenu=[];$scope.unassignedLayerTagMenu=[{menuTitle:"None",layer:"None",tag:"None",no:NgUtil.getUniqueStr()}];$scope.unassignedLayerTagItem="";function getUnassignedLayoutCheckCellTemplate(){return'<div class="ui-grid-cell-contents" style="padding-left: 3px;"><input type="checkbox" ng-disabled="grid.appScope.showUnassignedEmptyRow" ng-click="grid.appScope.onClickUnassignedGridRowCheck($event, row.entity);" ng-checked="row.entity.isCheck"/></div>'}function getUnassignedLayoutTagCellTemplate(){return'<div class="ui-grid-cell-contents"><div class="tagDropdownMenu"><select ng-show="!grid.appScope.showUnassignedEmptyRow" class="drop-layer-tag icon_nb_arrow_up_blue" ng-change="grid.appScope.onChangeUnassignedSelect($event, row.entity)" ng-model="row.entity.selected">    <option title="{{item.menuTitle}}" value="{{item.menuTitle}}" ng-repeat="item in grid.appScope.unassignedLayerTagMenu">{{item.menuTitle}}</option></select></div></div>'}$scope.onChangeUnassignedSelect=function(event,entity){var selected=entity.selected;var dataChanged=!1;if("None"===selected){dataChanged=""!=entity.tag;entity.layerTag="";entity.layerLevel=0;entity.tag="None"}else{var arr=selected.split(":");var level=arr[0].split(" ")[1];var tag=arr[1];entity.layerLevel=level;entity.tag=tag;entity.layerTag=selected}if(dataChanged){$scope.buttonStatus.saveTagsDisabled=!1;$scope.buttonStatus.applyToMapDisabled=!1}};function getUnassignedLayoutDeviceCellTemplate(){return'<div class="ui-grid-cell-contents"><span title="{{row.entity.deviceName}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.unassignedFilterValue">{{row.entity.deviceName}}</span></div>'}$scope.onShowBulkAssignTagsMenu=function(event){var $target=$(event.target).closest(".btn-build-assign-tag-box");var targetTop=$target.offset().top+event.target.scrollHeight;var objBtn=$target.find(".btn-build-assign-tag");var objMenu=$document.find(".bulk-assign-tags-dropdown");if(objMenu.is(":visible")){var doc=$document[0].documentElement;var docTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0);var docHeight=doc.clientHeight+docTop;if(objMenu[0].scrollHeight+targetTop>docHeight){var top=parseInt(objMenu.css("top"));top=top-2*objBtn.height()-objMenu.height();objMenu.css("top",top+"px")}else $scope.bulkAssignTagsDropDownCss={}}};$scope.onClickBulkMenuForUnassigned=function(event,menuItem){for(var i=0;i<$scope.selectedUnassignedRows.length;i++){var devId=$scope.selectedUnassignedRows[i].deviceId;var index=_.findIndex($scope.unassignedData,{deviceId:devId});if(index>=0){var entity=$scope.unassignedData[index];entity.tag=menuItem.tag;entity.layerLevel=menuItem.layerLevel;entity.layerTag=menuItem.menuTitle;entity.selected=menuItem.menuTitle}}if($scope.selectedUnassignedRows.length>0){$scope.buttonStatus.saveTagsDisabled=!1;$scope.buttonStatus.applyToMapDisabled=!1}};$scope.onClickBulkMenuForMatched=function(event,menuItem){for(var i=0;i<$scope.selectedMatchedRows.length;i++){var selectedRow=$scope.selectedMatchedRows[i];if("node"===selectedRow.nodeType){var deviceId=selectedRow.deviceId;var index=_.findIndex($scope.matchedData,{deviceId:deviceId});if(index>=0){var entity=$scope.matchedData[index];entity.tag=menuItem.tag;entity.layerLevel=menuItem.layerLevel;entity.layerTag=menuItem.menuTitle;entity.selected=menuItem.menuTitle}}}if($scope.selectedMatchedRows.length>0){$scope.buttonStatus.saveTagsDisabled=!1;$scope.buttonStatus.applyToMapDisabled=!1}};$scope.onChangeUnassignedMenu=function(layerTagItem,row){row.layerLevel=layerTagItem.layerLevel;row.tag=layerTagItem.tag};function findOldDevicesArr(deviceId,changeToLayoutItem){for(var i=0;i<changeToLayoutItem.layers.length;i++){var layer=changeToLayoutItem.layers[i];for(var j=0;j<layer.tags.length;j++){var tag=layer.tags[j];for(var k=0;k<tag.devices.length;k++){if(tag.devices[k].deviceId===deviceId)return tag.devices}}}}$scope.onApplyToMap=function(){var changeToLayoutItem=function(){var changeToLayoutItem=angular.copy($scope.selectedLayoutItem);for(var i=0;i<$scope.matchedData.length;i++){var matchedItem=$scope.matchedData[i];if("node"===matchedItem.nodeType){var oldMatchedDevice={};var oldDevicesArr=findOldDevicesArr(matchedItem.deviceId,changeToLayoutItem);if(oldDevicesArr){var oldDeviceIndex=_.findIndex(oldDevicesArr,{deviceId:matchedItem.deviceId});if(oldDeviceIndex>=0){oldMatchedDevice=oldDevicesArr[oldDeviceIndex];oldDevicesArr.splice(oldDeviceIndex,1)}var layerIndex1=matchedItem.layerLevel-1;if(layerIndex1>=0){var layer1=changeToLayoutItem.layers[layerIndex1];var tagIndex1=_.findIndex(layer1.tags,{name:matchedItem.tag});if(tagIndex1>=0){var len=oldMatchedDevice.tags.length;oldMatchedDevice.tags.splice(len-1,1);var findIndex1=_.findIndex(oldMatchedDevice.tags,matchedItem.tag);findIndex1>=0&&oldMatchedDevice.tags.splice(findIndex1,1);oldMatchedDevice.tags.push(matchedItem.tag);layer1.tags[tagIndex1].devices.push(oldMatchedDevice)}}}}}for(var z=0;z<$scope.unassignedData.length;z++){var unassignedItem=$scope.unassignedData[z];if(0!==unassignedItem.layerLevel&&"None"!==unassignedItem.tag){var unassignedDeviceIndex=_.findIndex(changeToLayoutItem.unAssignedDevices,{deviceId:unassignedItem.deviceId});if(unassignedDeviceIndex>=0){var unassignedDevice=changeToLayoutItem.unAssignedDevices[unassignedDeviceIndex];if(unassignedDevice){var layerIndex2=unassignedItem.layerLevel-1;var layer2=changeToLayoutItem.layers[layerIndex2];var tagIndex2=_.findIndex(layer2.tags,{name:unassignedItem.tag});if(tagIndex2>=0){var findIndex2=_.findIndex(unassignedDevice.tags,unassignedItem.tag);findIndex2>=0&&unassignedDevice.tags.splice(findIndex2,1);unassignedDevice.tags.push(unassignedItem.tag);layer2.tags[tagIndex2].devices.push(unassignedDevice);changeToLayoutItem.unAssignedDevices.splice(unassignedDeviceIndex,1)}}}}}return changeToLayoutItem}();doLayoutStyle($scope.previousOrientation,changeToLayoutItem);$scope.previousOrientation=changeToLayoutItem.orientation;showOrHideHighlightBg($scope.isHighlight.value);var options={tipInfo:MapLayoutWording.ApplyToMapSuccessMessage,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options)};$scope.onSaveTags=function(){var data={addDeviceTags:[],delDeviceTags:[]};for(var i=0;i<$scope.matchedData.length;i++){var matchedItem=$scope.matchedData[i];if("node"===matchedItem.nodeType&&matchedItem.tag!==matchedItem.oldTag){var deviceId1=matchedItem.deviceId;var tag1=matchedItem.tag;var delItem1={devId:deviceId1,tagNames:[matchedItem.oldTag,tag1]};data.delDeviceTags.push(delItem1);var addItem1={devId:deviceId1,tagNames:[tag1]};data.addDeviceTags.push(addItem1)}}for(var z=0;z<$scope.unassignedData.length;z++){var unassignedItem=$scope.unassignedData[z];if("None"!==unassignedItem.tag){var addItem2={devId:unassignedItem.deviceId,tagNames:[unassignedItem.tag]};data.addDeviceTags.push(addItem2)}}httpMapLayoutSrvc.saveLayoutTagsToDevs(data).then((function(result){if(!0===result){var options={tipInfo:MapLayoutWording.SaveTagsSuccessMessage,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);$scope.mapLayoutList=[];$scope.mapLayoutCount=0;$scope.isCheckAllOption.matchedCheck=!1;$scope.isCheckAllOption.unassignedCheck=!1;$scope.selectedMatchedRows=[];$scope.selectedUnassignedRows=[];tools.refreshCachedTags().then((function(){loadLayout().then((function(){var tagsLayoutIndex=_.findIndex($scope.mapLayoutList,{currentStyleId:$scope.currentStyleId});if(tagsLayoutIndex>=0){var tagsLayoutItem=$scope.mapLayoutList[tagsLayoutIndex];var selectedLayoutItemIndex=_.findIndex(tagsLayoutItem.layouts,{id:$scope.selectedLayoutItemId});if(selectedLayoutItemIndex>=0){var selectedLayoutItem=tagsLayoutItem.layouts[selectedLayoutItemIndex];tagsLayoutItem.lastSelectedLayout=selectedLayoutItem;tagsLayoutItem.matchedTotal=selectedLayoutItem.matchedCount;refreshTagsLayoutItem(tagsLayoutItem,$scope.popoverIsOpenCurrentIndex,!0);refreshMatchedList(selectedLayoutItem)}}}))}))}}))};var watchOpenPanel=$rootScope.$on(MapTabEvent.MAX_PANEL,(function(event,options){if("map layout"===options.key.toString().toLowerCase()){var activePage=mapManagerSrvc.getActivePage();$scope.$parent.pageId===activePage.getDocId()&&init()}}));var watchSecondAllDivScrollHeight=function(){};watchSecondAllDivScrollHeight=$scope.$watch((function(){return element.find(".second-all")[0]&&runWatchScrollHeight?element.find(".second-all")[0].scrollHeight:0}),(function(scrollHeight){if(0!==scrollHeight&&runWatchScrollHeight){var divHeight=element.find(".second-all").height();$scope.showScrollStyle=scrollHeight>divHeight?{"margin-right":"16px"}:{}}}));$scope.showScrollStyle={};var whenCloseTabHandler=$rootScope.$on(MapTabEvent.REMOVE_TAB,(function(event,key){"map layout"===key.toString().toLowerCase()&&$scope.selectedLayoutItem&&$scope.selectedLayoutItem.layers&&showOrHideHighlightBg(!1)}));var whenOnlyHideHightlightCloseTabHandler=$rootScope.$on(MapTabEvent.REMOVE_TAB+"_only_hide_highlight",(function(event,key){"map layout"===key.toString().toLowerCase()&&showOrHideHighlightBg(!1)}));$scope.$on("$destroy",(function(){$scope.showPane="";watchSecondAllDivScrollHeight();whenCloseTabHandler();whenOnlyHideHightlightCloseTabHandler();watchOpenPanel();tools=null}))}angular.module("nb.qmap").directive("nbMapTemplateLayoutTagsMenuDirective",[function(){return{retrict:"E",template:'<nb-dropdown class="second-unassigned-dropdown" nb-dropdown-placeholder="" dropdown-disabled="layerTagMenu.length==0" ng-model="unassignedLayerTagItem">      <nb-dropdown-option ng-click="onChangeUnassignedMenu(item, row.entity, $event)" ng-repeat="item in layerTagMenu" nb-dropdown-data="item" title="{{item.menuTitle}}">          {{item.menuTitle}} </nb-dropdown-option>        </nb-dropdown>',scope:{},link:function(scope,element,attrs){},replace:!0}}])}(NetBrain);NetBrain,angular.module("nb.qmap").directive("nbMapLayoutMatchedCount",[function(){return{restrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutMatchedCountDirective.html",scope:{similarityCoefficientPercentage:"=",matchedCount:"=",isHighlight:"=",outTriggerEvent:"="},link:function(scope,element,attrs){},controller:["$scope","$timeout",function($scope,$timeout){$scope.highlightMatchedDevices=function(){!0!==$scope.outTriggerEvent&&$scope.$emit("highlightMatchedDevices",$scope.isHighlight)};$scope.getHighlightClass=function(){var className="";$scope.isHighlight&&(className="map-layout-matched-count-view-highlight");return className};$scope.getEyeClass=function(){var className="icon_nb_map_layout_eyes_close_14";$scope.isHighlight&&(className="icon_nb_map_layout_eyes_open_14");return className}}]}}]);!function(NetBrain){angular.module("nb.qmap").controller("nb.qmap.nbMapLayoutManagerCtrl",nbMapLayoutManagerCtrl);nbMapLayoutManagerCtrl.$inject=["$scope","$log","$rootScope","$timeout","nb.common.nbAlertSrvc","nb.ng.nbValidationSrvc","$q","ivhTreeviewMgr","nb.qmap.httpMapLayoutSrvc","nb.ng.permissionSrvc","nb.uiframework.urlStateMgr"];function nbMapLayoutManagerCtrl($scope,$log,$rootScope,$timeout,nbAlertSrvc,nbValidationSrvc,$q,ivhTreeviewMgr,httpMapLayoutSrvc,permissionSrvc,urlStateMgr){document.title=StringUtil.format(NetBrain.NetworkOS.Const.UIFramework.DocumentTitleTemplate.Map,{mapName:"Map Layout Manager"});$scope.hasPermission=!0;$scope.tagList=[];$scope.isAssociation=!1;urlStateMgr.setPageSession("MapLayoutManager","Map Layout Manager","MapLayoutManager",null);!function(){var hasDomain=permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.domainMgmt);var hasMapLayout=permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.mapLayoutManagement);hasDomain||hasMapLayout||($scope.hasPermission=!1);httpMapLayoutSrvc.getDomainTagNames().then((function(result){result.length>0&&($scope.tagList=result.sort())}))}();$scope.initLayoutStyle=function(){$scope.isAssociation=!1};var funcOnClickTabCallback=null;$scope.funcOnClickTabCallback=function(func){funcOnClickTabCallback=func};$scope.initTagList=function(){$scope.isAssociation=!1;_.isFunction(funcOnClickTabCallback)&&funcOnClickTabCallback()};$scope.initAssociation=function(){$scope.isAssociation=!0}}}(NetBrain);!function(netBrain){angular.module("nb.qmap").directive("createSampleMapDirective",[function(){return{restrict:"E",templateUrl:"modules/nbQmap/views/maplayout/createSampleMapLayoutDirective.html",scope:{mapOptions:"="},link:function(scope,element,attrs){},controller:Controller,replace:!0}}]);Controller.$inject=["$window","$upload","$scope","$element","$attrs","$timeout","$rootScope","$q","$sce","ivhTreeviewMgr","nb.common.nbTipSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.ng.httpAuthSrvc","nb.uiframework.urlStateMgr","nb.datamodel.httpSiteSrvc","uiGridTreeBaseService","nb.ng.nbValidationSrvc","nb.qmap.httpMapLayoutSrvc"];function Controller($window,$upload,$scope,element,attr,$timeout,$rootScope,$q,$sce,ivhTreeviewMgr,nbTipSrvc,nbAlertSrvc,httpMapSrvc,httpAuthSrvc,urlStateMgr,httpSiteSrvc,uiGridTreeBaseService,nbValidationSrvc,httpMapLayoutSrvc){var MapLayoutTypeEnum=NetBrain.MapLayout.Const.MapLayoutType;var SampleMapCreateStrategyEnum=NetBrain.MapLayout.Const.SampleMapCreateStrategy;var FolderTypeServerEnum=NetBrain.MapLayout.Const.FolderType;var LayoutStyleWording=NetBrain.MapLayout.Const.Wording.LayoutStyle;var MapLayoutWording=NetBrain.MapLayout.Const.Wording.MapLayout;var nodeTypeEnum=NetBrain.MapLayout.Const.NodeTypeEnum;var getNodeType=NetBrain.MapLayout.Const.getNodeType;var getServerFolderType=NetBrain.MapLayout.Const.getServerFolderType;var selectedFolder=null;var editingNode=null;$scope.isSaving=!1;var highlightDeviceIdList=null;var highlightDevice=null;var netMapOperator=null;var sampleLS={};var opTag={newFolder:"newfolder",renameFolder:"renameFolder"};function fetchChildNode(curNode){var defer=$q.defer();if(curNode.loaded){defer.resolve();return defer.promise}httpMapLayoutSrvc.getSubFoldersAndLayoutsByParentId(curNode.ID,curNode.folderType).then((function(result){var nodeType=getNodeType(curNode);if(nodeType===nodeTypeEnum.sampleTplRoot||nodeType===nodeTypeEnum.sampleTplFolder){var folderArray=result.layoutFolders;for(var i=0;i<folderArray.length;i++){var fNode=folderArray[i];fNode.ID=fNode.id;fNode.nodeType=getNodeType(fNode);fNode.children=[];fNode.editable=!1;fNode.selected=!1;fNode.expanded=!1;curNode.children.push(fNode)}curNode.loaded=!0}defer.resolve()}));return defer.promise}$scope.onNameChanged=function(){nbValidationSrvc.submit("layoutFormSaveAs").then((function(){$scope.validateLayoutName=!0}),(function(){$scope.validateLayoutName=!1}))};$scope.onBlurInput=function(){nbValidationSrvc.submit("layoutFormSaveAs").then((function(){$scope.validateLayoutName=!0}),(function(){$scope.validateLayoutName=!1}))};var byDeviceContentNodeDataArray=[];function convertForCreate(item){return _.find(byDeviceContentNodeDataArray,(function(dev){return item.deviceId===dev.key}))}function getTagDevice(nodeDataArray){byDeviceContentNodeDataArray=nodeDataArray;var tagList=_.uniq(_.pluck($scope.sampleMapByTagSelectedList,"tagName"));return _.map(tagList,(function(tag){var devs=_.chain($scope.sampleMapByTagSelectedList).filter((function(dev){return dev.tagName===tag})).map(convertForCreate).value();return{tag:tag,devices:devs}}))}function recoverMapHighlight(){if(netMapOperator){netMapOperator.hideHighlightBg();highlightDevice.highlightDevice&&netMapOperator.showHighlightBg(highlightDeviceIdList)}}function highlightMapForSampleMapDevice(){$timeout((function(){if(netMapOperator){var idList=_.pluck($scope.sampleMapByTagSelectedList,"deviceId");netMapOperator.hideHighlightBg();netMapOperator.showHighlightBg(idList)}}),0)}$scope.onOK=function(){$scope.isSaving=!0;var opts={destFolder:selectedFolder,newLayoutName:$scope.uiControl.newLayoutName};var testData={name:opts.newLayoutName,parent:{id:opts.destFolder.ID,name:opts.destFolder.name,folderType:FolderTypeServerEnum.SampleMapFolder}};var saveAsSampleMap=function(){var data=function(data){var sampleMapType=MapLayoutTypeEnum.sampleMap;var strategyType=SampleMapCreateStrategyEnum.byHostName;$scope.sampleMapOption.sampleMapByTag&&(strategyType=SampleMapCreateStrategyEnum.byAssignTag);var l2=netBrain.Map.currentActiveMapPage.isL2MapStyle();var l3=netBrain.Map.currentActiveMapPage.isL3MapStyle();var mapStyle=l2?"L2":l3?"L3":"";var pfId=data.destFolder.ID;var pfName=data.destFolder.name;var pfType=FolderTypeServerEnum.SampleMapFolder;var icoObj={normalImg:"",smallImg:netBrain.Map.currentActiveMapPage?netBrain.Map.currentActiveMapPage.getImageBase64(!1,{background:"transparent"}):"",mapStyle:mapStyle};var pageObj=angular.copy(netBrain.Map.currentActiveMapPage.toJson());var mapObj=angular.copy(netBrain.Map.currentActiveMap.toJson());var allPages=netBrain.Map.currentActiveMap.getAllPage();for(var i=0;i<allPages.length;i++){var page=allPages[i];var pageItemId=page.getDocId();if(page.getRealNew()||page.getRealModify()){var pageItemIndex=_.findIndex(mapObj.pageList,{ID:pageItemId});if(pageItemIndex>=0){var pageItemObj=mapObj.pageList[pageItemIndex];pageItemObj.linkDataArray=page.newLinkList;pageItemObj.nodeDataArray=page.newNodeList}}}var mapInfo={pageId:pageObj.ID,mapObj:mapObj};var content=new netBrain.Map.LayoutToolsHelper(netMapOperator).getSampleMapByDeviceData();strategyType===SampleMapCreateStrategyEnum.byAssignTag&&(content={tags:getTagDevice(content.nodeDataArray)});return{id:"",name:data.newLayoutName,type:sampleMapType,parentFolder:{id:pfId,name:pfName,folderType:pfType},createStrategy:strategyType,iconString:JSON.stringify(icoObj),content:content,mapInfo:mapInfo}}(opts);httpMapLayoutSrvc.insert(data).then((function(){var successOpt={tipInfo:MapLayoutWording.SaveAsSampleMapSuccessTip,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};$timeout((function(){nbTipSrvc.open(successOpt)}),0);$scope.mapOptions.uibModalInstance.close()}),(function(){var errOpt={message:MapLayoutWording.SaveAsSampleMapFailedMessage};nbAlertSrvc.warning(errOpt);$scope.mapOptions.uibModalInstance.close()}))};httpMapLayoutSrvc.sampleMapHasDuplicateName(testData).then((function(result){if(result){var duplicateOpt={message:MapLayoutWording.SaveAsSampleMapHasDuplicateNameMessage};nbAlertSrvc.confirm(duplicateOpt).then((function(){saveAsSampleMap();recoverMapHighlight();$scope.mapOptions.uibModalInstance.close()}))}else{saveAsSampleMap();recoverMapHighlight();$scope.mapOptions.uibModalInstance.close()}}),(function(){recoverMapHighlight();$scope.mapOptions.uibModalInstance.close()}));$scope.isSaving=!1};$scope.onClose=function(){recoverMapHighlight();$scope.mapOptions.uibModalInstance.dismiss($scope)};$scope.onCancel=function(){recoverMapHighlight();$scope.mapOptions.uibModalInstance.dismiss($scope)};function resetEditingNode(){if(null!==editingNode){if(!0===editingNode.isNew){var index=_.findIndex(editingNode.parentNode.children,{editable:!0});index>=0&&editingNode.parentNode.children.splice(index,1)}else{editingNode.currentNode.name=editingNode.oldName;editingNode.currentNode.editable=!1;editingNode.currentNode.selected=!1}editingNode=null;angular.element(document.body).unbind("click.nbTreeDocClickHandler");angular.element("span.row-menu-no-display").removeClass("row-menu-no-display")}}function onClickFolderAdd(node){node&&fetchChildNode(node).then((function(){ivhTreeviewMgr.deselectAll($scope.mapLayoutTreeData,$scope.ivhTreeMapLayoutTreeOptions);if(node){resetEditingNode();var nodeType=nodeTypeEnum.sampleTplFolder;var folderType=getServerFolderType(nodeType);var item={ID:"",name:LayoutStyleWording.FolderAddInitializeName,children:[],editable:!0,selected:!0,expanded:!1,nodeType:nodeType,folderType:folderType};node.children.push(item);node.expanded=!0;(editingNode={}).currentNode=item;editingNode.oldName=item.name;editingNode.isNew=!0;editingNode.parentNode=node;$timeout((function(){angular.element("input.ivh-treeview-node-label.node-label-editable + span.node-dropdown-arrow").addClass("row-menu-no-display");!function(){var div=angular.element(".tree-map-layout-style");var divHeight=div.height();var divScrollTop=div[0].scrollTop;var inputPos=function(obj){var l=0;var t=0;for(;obj;){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}return{left:l,top:t}}(angular.element(".tree-map-layout-style input.node-label-editable")[0]);inputPos.top>divHeight+divScrollTop&&(div[0].scrollTop=inputPos.top);inputPos.top<divScrollTop&&(div[0].scrollTop=inputPos.top)}()}),100)}}))}function findParent(nodeId,nodeType){if(nodeId){var parentNode=null;var root;nodeType!==nodeTypeEnum.sampleTplFolder&&nodeType!==nodeTypeEnum.sampleTplEntity||(root=sampleLS);root&&function myself(_nodeId,traverseNode){if(_nodeId===traverseNode.ID)return!0;if(!traverseNode)return!1;angular.forEach(traverseNode.children,(function(child){!0===myself(_nodeId,child)&&(parentNode=traverseNode);return!1}));return!1}(nodeId,root);return parentNode}}function showErrorDialog(message,detail){var text="";detail&&detail.ResultDesc&&(text=detail.ResultDesc);return nbAlertSrvc.error(message+" "+text)}function doneEditing(node,text,mtEditingNode){ivhTreeviewMgr.deselectAll($scope.mapLayoutTreeData,$scope.ivhTreeMapLayoutTreeOptions);var defer=$q.defer();if(node.ID&&node.name===text){node.editable=!1;node.selected=!0;defer.resolve(!0);angular.element("span.row-menu-no-display").removeClass("row-menu-no-display");return defer.promise}text=text.trim();var nowEditingNode=mtEditingNode||editingNode;(function(node,newName,nowEditingNode){var text=newName;var label="folder";node.nodeType===nodeTypeEnum.sampleTplEntity&&(label="Layout Style");if(!text||text.length<=0)return nbAlertSrvc.error({message:StringUtil.format(LayoutStyleWording.IsNameValidEmpty,{label:label})});if(text.length>128)return nbAlertSrvc.error({message:StringUtil.format(LayoutStyleWording.IsNameValidLargeThen128,{label:label})});if(!nbValidationSrvc.getValidator("generalForbidWindowsAndMongoChars")(text))return nbAlertSrvc.error({message:LayoutStyleWording.IsNameValidGeneralForbidWindowsAndMongoChars});var isDuplicateResult=function(node,text,existingNodeList){for(var i=0;i<existingNodeList.length;i++){var item=existingNodeList[i];if((node.ID!==item.ID||node.name!==item.name)&&(item.ID&&item.name&&text.toUpperCase()===item.name.toUpperCase()&&item.nodeType===node.nodeType))return!0}return!1}(node,text,nowEditingNode.parentNode.children);var errorMessage=StringUtil.format(LayoutStyleWording.IsNameValidErrorMessage,{label:label});if(isDuplicateResult)return nbAlertSrvc.error({message:errorMessage});var defer=$q.defer();defer.resolve(!0);return defer.promise})(node,text,nowEditingNode).then((function(result){!0!==result?defer.resolve(!1):function(node,text,nowEditingNode){var defer=$q.defer();var nodeType=node.nodeType||getNodeType(node);if((angular.isUndefined(node.ID)||""===node.ID)&&nodeType===nodeTypeEnum.sampleTplFolder){var folderParentId=nowEditingNode.parentNode.ID;var folderParentType=nowEditingNode.parentNode.folderType;var newFolder=function(folderId){var folder={};folder.name="";folder.parent={id:folderId};return folder}(folderParentId);newFolder.name=text;var testFolder={name:text,parent:{id:folderParentId,folderType:folderParentType}};httpMapLayoutSrvc.folderHasDuplicateName(testFolder).then((function(isDup){if(isDup){var folderDupOpt={message:LayoutStyleWording.FolderMoveToHasDuplicateNameMessage};nbAlertSrvc.confirm(folderDupOpt).then((function(){httpMapLayoutSrvc.addSubFolder(newFolder).then((function(result){defer.resolve({ID:result,op:opTag.newFolder})}),(function(err){defer.reject(err)}))}))}else httpMapLayoutSrvc.addSubFolder(newFolder).then((function(result){defer.resolve({ID:result,op:opTag.newFolder})}),(function(err){defer.reject(err)}))}))}if(node.ID&&nodeType===nodeTypeEnum.sampleTplFolder){var folderId=node.ID;httpMapLayoutSrvc.renameFolder(folderId,text).then((function(result){defer.resolve({ID:result,op:opTag.renameFolder})}),(function(err){defer.reject(err)}))}return defer.promise}(node,text,nowEditingNode).then((function(resultedItem){var op=resultedItem.op;if(6===resultedItem.nodeStatus)showErrorDialog(LayoutStyleWording.EntityAddDuplicateMessage,"").then((function(){defer.resolve(!1)}));else if(op===opTag.newFolder){node.ID=resultedItem.ID;node.name=text;node.editable=!1;node.selected=!0;node.parent={id:nowEditingNode.parentNode.ID,folderType:nowEditingNode.parentNode.folderType};editingNode=null;angular.element("span.row-menu-no-display").removeClass("row-menu-no-display");defer.resolve(!0)}else{node.name=text;node.editable=!1;node.selected=!0;editingNode=null;angular.element("span.row-menu-no-display").removeClass("row-menu-no-display");defer.resolve(!0)}}),(function(reason){reason&&reason.ResultDesc&&6===reason.ResultCode?showErrorDialog(LayoutStyleWording.EntityAddDuplicateMessage,"").then((function(){defer.resolve(!1)})):showErrorDialog(LayoutStyleWording.EntityFolderAddRenameFailedMessage,reason).then((function(){defer.resolve(!1)}))}))}));return defer.promise}function _nodeClickCallback(node){if(node.ID===selectedFolder.ID){node.selected||(node.selected=!0);selectedFolder=node}else selectedFolder=node}var sampleRootMenu=[{template:"New Folder",action:function(node){onClickFolderAdd(node)}}];var sampleFolderMenu=[{template:"New Folder",action:function(node){onClickFolderAdd(node)}},{template:LayoutStyleWording.MenuRename,action:function(node){!function(node){if(node){ivhTreeviewMgr.deselectAll($scope.mapLayoutTreeData,$scope.ivhTreeMapLayoutTreeOptions);resetEditingNode();(editingNode={}).currentNode=node;editingNode.oldName=node.name;editingNode.isNew=!1;editingNode.parentNode=findParent(node.ID,node.nodeType);node.editable=!0;$timeout((function(){angular.element("input.ivh-treeview-node-label.node-label-editable + span.node-dropdown-arrow").addClass("row-menu-no-display")}))}}(node)}},{template:LayoutStyleWording.MenuDelete,action:function(node){!function(node){if(node){resetEditingNode();var dialogOptions={message:LayoutStyleWording.FolderDeleteMessage};nbAlertSrvc.confirm(dialogOptions).then((function(){var folderIdList=[node.ID];httpMapLayoutSrvc.deleteFolderByIds(folderIdList).then((function(){var parentNode=findParent(node.ID,node.nodeType);if(parentNode){var index=_.findIndex(parentNode.children,{ID:node.ID});index>=0&&parentNode.children.splice(index,1);selectedFolder.selected=!1;parentNode.selected=!0;_nodeClickCallback(parentNode)}}))}))}}(node)}}];$scope.ivhTreeMapLayoutTreeOptions={defaultSelectedState:!1,validate:!0,expandToDepth:1,labelAttribute:"name",idAttribute:"ID",childrenAttribute:"children",expandedAttribute:"expanded",selectedAttribute:"selected",editableAttribute:"editable",enableMultipleSelect:!1,enableLabelExpand:!1,iconTemplate:function(node){return node.nodeType<100?'<div class="icon_nb_folder"></div>':'<div class="icon_nb_dataviewtemplate"></div>'},nodeClickCallback:function(node,trvw){null===editingNode?_nodeClickCallback(node):node.selected=!1},enableNodeDropdown:{isDisplay:function(node){node.editable;return!0},dropdownItems:function(node){if(node.editable)return{};var nt=getNodeType(node);return nt===nodeTypeEnum.sampleTplRoot||nt===nodeTypeEnum.publicTplRoot?sampleRootMenu:nt===nodeTypeEnum.sampleTplFolder?sampleFolderMenu:{}}},lazyLoadingAttribute:function(node){var canLazy=!1;var nt=node.nodeType;nt!==nodeTypeEnum.sampleTplRoot&&nt!==nodeTypeEnum.sampleTplFolder||(canLazy=!0);return canLazy},editableCallback:function(node,trvw,text){return function(node,text,_editingNode){var defer=$q.defer();if(!0===$scope.isSaving)return $q.resolve(!1);$scope.isSaving=!0;doneEditing(node,text,_editingNode).then((function(result){if(result){selectedFolder=node;$scope.isSaving=!1;defer.resolve(!0)}else{$scope.isSaving=!1;defer.resolve(!1)}}),(function(){$scope.isSaving=!1;defer.resolve(!1)}));return defer.promise}(node,text,editingNode)},lazyLoadingCallback:function(node){return fetchChildNode(node)}};$scope.sampleMapOption={sampleMapByTag:!1,sampleMapByTagCheckAll:!1};$scope.sampleMapByTagData=[];$scope.modalBodyCss={};$scope.sampleMapByTagGridApi=null;$scope.sampleMapByTagSelectedList=[];$scope.sampleMapChkBoxCss={};function flattenEachTag(item){return item.assignTags.map((function(tag){return{id:item.ID,name:item.name,tag:tag,pos:{x:0,y:0}}}))}function convert(items,tag){return{id:NgUtil.getUniqueStr(),tagName:tag,$$treeLevel:0,deviceList:items.map((function(item){return{id:NgUtil.getUniqueStr(),devId:item.id,hostName:item.name,$$treeLevel:1}}))}}function flattenEachDevice(item){var result=[{id:item.id,isCheck:!1,tag:item.tagName,nodeType:"tag",hostName:"",$$treeLevel:item.$$treeLevel}];return result=result.concat(item.deviceList.map((function(dev){return{id:dev.id,deviceId:dev.devId,isCheck:!1,tag:"",tagName:item.tagName,nodeType:"device",hostName:dev.hostName,$$treeLevel:dev.$$treeLevel}})))}function checkFolder(entity){if("device"===entity.nodeType){var index=_.findIndex($scope.sampleMapByTagData,{id:entity.id});var isAllCheck=!0;var isAllUnCheck=!0;var sampleMapItem;var tagItem;for(var i=index;i>=0;i--){if("tag"===(sampleMapItem=$scope.sampleMapByTagData[i]).nodeType){tagItem=sampleMapItem;break}sampleMapItem.isCheck?isAllUnCheck=!1:isAllCheck=!1}for(var j=index+1;j<$scope.sampleMapByTagData.length&&"tag"!==(sampleMapItem=$scope.sampleMapByTagData[j]).nodeType;j++)sampleMapItem.isCheck?isAllUnCheck=!1:isAllCheck=!1;if(isAllCheck&&tagItem){tagItem.isCheck=!0;$scope.sampleMapByTagGridApi.selection.selectRow(tagItem)}if(!isAllCheck&&tagItem){tagItem.isCheck=!1;$scope.sampleMapByTagGridApi.selection.unSelectRow(tagItem)}var chkObj=element.find("[checkId="+tagItem.id+"]");if(isAllCheck||isAllUnCheck){chkObj.length>0&&(chkObj[0].indeterminate=!1);tagItem.indeterminate=!1}else{chkObj.length>0&&(chkObj[0].indeterminate=!0);tagItem.indeterminate=!0}}}function checkAll(){var len1=_.countBy($scope.sampleMapByTagData,(function(item){return""===item.tag}));var len2=$scope.sampleMapByTagSelectedList.length;var checkAllBox=element.find(".is-check-all-in-samplemap-bytag")[0];if(len1.true===len2){$scope.sampleMapOption.sampleMapByTagCheckAll=!0;$scope.sampleMapOption.indeterminate=!1;checkAllBox&&(checkAllBox.indeterminate=!1)}else if(len2>0){$scope.sampleMapOption.indeterminate=!0;checkAllBox&&(checkAllBox.indeterminate=!0)}else{$scope.sampleMapOption.sampleMapByTagCheckAll=!1;$scope.sampleMapOption.indeterminate=!1;checkAllBox&&(checkAllBox.indeterminate=!1)}}function addSampleMapByTagRow(entity){var index;if("tag"===entity.nodeType){var devList=_.filter($scope.sampleMapByTagData,(function(item){return item.tagName===entity.tag}));for(var i=0;i<devList.length;i++){var deviceItem=devList[i];if((index=_.findIndex($scope.sampleMapByTagSelectedList,{deviceId:deviceItem.deviceId}))>=0){var hasSelectedItem=$scope.sampleMapByTagSelectedList[index];hasSelectedItem.isCheck=!1;$scope.sampleMapByTagSelectedList.splice(index,1);$scope.sampleMapByTagGridApi.selection.unSelectRow(hasSelectedItem);checkFolder(hasSelectedItem)}deviceItem.isCheck=!0;$scope.sampleMapByTagSelectedList.push(deviceItem);$scope.sampleMapByTagGridApi.selection.selectRow(deviceItem);checkFolder(deviceItem)}}else{if((index=_.findIndex($scope.sampleMapByTagSelectedList,{deviceId:entity.deviceId}))>=0){var selectedItem=$scope.sampleMapByTagSelectedList[index];selectedItem.isCheck=!1;$scope.sampleMapByTagSelectedList.splice(index,1);$scope.sampleMapByTagGridApi.selection.unSelectRow(selectedItem);checkFolder(selectedItem)}$scope.sampleMapByTagSelectedList.push(entity);entity.isCheck=!0;checkFolder(entity)}console.log("",$scope.sampleMapByTagSelectedList);console.log("",_.where($scope.sampleMapByTagData,{isCheck:!0}));checkAll();highlightMapForSampleMapDevice()}function deleteSampleMapByTagRow(entity){var index;if("tag"===entity.nodeType){var devList=_.filter($scope.sampleMapByTagData,(function(item){return item.tagName===entity.tag}));var deviceItem;for(var i=0;i<devList.length;i++){deviceItem=devList[i];if((index=_.findIndex($scope.sampleMapByTagSelectedList,{id:deviceItem.id}))>=0){deviceItem.isCheck=!1;$scope.sampleMapByTagSelectedList.splice(index,1);$scope.sampleMapByTagGridApi.selection.unSelectRow(deviceItem)}}deviceItem&&checkFolder(deviceItem)}else{if((index=_.findIndex($scope.sampleMapByTagSelectedList,{id:entity.id}))>=0){var selectedItem=$scope.sampleMapByTagSelectedList[index];selectedItem.isCheck=!1;$scope.sampleMapByTagSelectedList.splice(index,1);$scope.sampleMapByTagGridApi.selection.unSelectRow(selectedItem)}checkFolder(entity)}checkAll();highlightMapForSampleMapDevice()}$scope.sampleMapByTagGridOptions={data:"sampleMapByTagData",multiSelect:!0,enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableColumnMenus:!1,columnDefs:[{field:"isCheck",displayName:"",width:"30",cellTemplate:'<div class="ui-grid-cell-contents" style="padding-left: 3px;"><input type="checkbox" checkId="{{row.entity.id}}" ng-click="grid.appScope.onClickSampleMapByTagGridRowCheck($event, row.entity);" ng-model="row.entity.isCheck" ng-checked="row.entity.isCheck"/></div>'},{field:"tag",displayName:MapLayoutWording.SaveAsSampleByTagGridTitle1,width:"160",cellTemplate:'<div class="ui-grid-cell-contents"><span style="cursor: pointer;width: 20px; height: 17px;" ng-click="grid.appScope.toggleRow(row, $event)"><i ng-class="{\'ui-grid-icon-minus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'expanded\', \'ui-grid-icon-plus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'collapsed\'}" ng-style="{\'margin-left\': grid.options.treeIndent * row.treeLevel + \'px\'}" style=" width: 10px;height: 10px;display: inline-block;">&nbsp;</i></span><span style="margin-left: 10px;" title="{{row.entity.tag}}">{{row.entity.tag}}</span></div>'},{field:"hostName",displayName:MapLayoutWording.SaveAsSampleByTagGridTitle2,width:"*",cellTemplate:'<div class="ui-grid-cell-contents"><span title="{{row.entity.hostName}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.matchedFilterValue">{{row.entity.hostName}}</span></div>'}],showTreeExpandNoChildren:!1,treeIndent:10,enableColumnResizing:!1,enableSorting:!1,onRegisterApi:function(gridApi){$scope.sampleMapByTagGridApi=gridApi}};$scope.onClickCheckAllForSampleMapByTag=function(event){var isCheck=angular.element(event.target).is(":checked");for(var i=0;i<$scope.sampleMapByTagData.length;i++){var sampleMap=$scope.sampleMapByTagData[i];if("tag"===sampleMap.nodeType){isCheck?addSampleMapByTagRow(sampleMap):deleteSampleMapByTagRow(sampleMap);sampleMap.isCheck=isCheck}}};$scope.onClickSampleMapByTagGridRowCheck=function(event,entity){if(angular.element(event.target).is(":checked")){addSampleMapByTagRow(entity);$scope.sampleMapByTagGridApi.selection.selectRow(entity)}else{deleteSampleMapByTagRow(entity);$scope.sampleMapByTagGridApi.selection.unSelectRow(entity)}};$scope.toggleRow=function(row,event){uiGridTreeBaseService.toggleRowTreeState($scope.sampleMapByTagGridApi.grid,row,event)};function findDeivceById(newDevices,device){for(var i=0;i<newDevices.length;i++){var item=newDevices[i];if(item.key===device.ID)return item}return null}$scope.sampleMapByTagClick=function(event){var isCheck=$scope.sampleMapOption.sampleMapByTag;if(angular.element(event.target).hasClass("chk-samplemap-btn"))isCheck=element.find(".chk-samplemap-btn").is(":checked");else{isCheck=!isCheck;$scope.sampleMapOption.sampleMapByTag=isCheck}if(!1===isCheck){$scope.sampleMapByTagSelectedList=[];checkAll();$scope.modalBodyCss={};$scope.sampleMapChkBoxCss={};element.find(".mtl-samplemap-bytag-checkbox .icon").removeClass("icon_nb_arrow_up_black").addClass("icon_nb_arrow_down_black")}if(isCheck&&netMapOperator){var newDevices=netMapOperator.getSimpleNodeDataArray();var ids=_.pluck(newDevices,"key");httpMapLayoutSrvc.getDeviceTagByGuids(ids).then((function(devices){for(var i=0;i<devices.length;i++){var deviceItem=devices[i];var findDevice=findDeivceById(newDevices,deviceItem);deviceItem.name=findDevice?findDevice.hostName:""}var deviceList=function(devices){return _.chain(devices).filter((function(dev){return dev.assignTags})).map(flattenEachTag).flatten().groupBy("tag").map(convert).map(flattenEachDevice).flatten().value()}(devices);$scope.sampleMapByTagData=deviceList;checkAll()}));$scope.modalBodyCss={height:"655px"};$scope.sampleMapChkBoxCss={"border-bottom":"none"};element.find(".mtl-samplemap-bytag-checkbox .icon").removeClass("icon_nb_arrow_down_black").addClass("icon_nb_arrow_up_black")}$scope.sampleMapByTagSelectedList=[]};!function(){$scope.validateLayoutName=!1;$scope.uiControl={newLayoutName:""};$scope.layoutNameSaveAsValidator={method:"blur",rules:[{ruleId:"required",errorMessage:MapLayoutWording.SaveAsSampleMapLayoutNameEmptyMessage},{ruleId:"mongoDBNameValidateChecker",params:{name:$scope.uiControl.newLayoutName},errorMessage:MapLayoutWording.SaveAsSampleMapLayoutNameDBNameValidateErrorMessage+nbValidationSrvc.mongoDbForbidCharString()}]};$scope.mapLayoutTreeData=[];httpMapLayoutSrvc.getRootFolderList().then((function(result){var list=_.filter(result,(function(item){item.nodeType=getNodeType(item);return item.nodeType===nodeTypeEnum.sampleTplRoot}));if(list.length>0){var node=list[0];node.ID=node.id;node.nodeType=getNodeType(node);node.children=[];node.editable=!1;node.selected=!0;node.expanded=!0;$scope.mapLayoutTreeData.push(node);selectedFolder=node;sampleLS=node;fetchChildNode(node)}}));netBrain.Map&&netBrain.Map.currentActiveMapPage&&(netMapOperator=netBrain.Map.currentActiveMapPage.getNetmapOperator());netMapOperator&&netMapOperator.hideHighlightBg();var pageId=netBrain.Map.currentActiveMapPage.getDocId();highlightDeviceIdList=NetBrain.MapLayout.Const.MapLayoutHighlightOption.getDeviceIdList(pageId);highlightDevice=NetBrain.MapLayout.Const.MapLayoutHighlightOption.getHighLightDevice(pageId)}()}angular.module("nb.qmap").directive("checkbox3",(function(){return{restrict:"EA",replace:!0,template:"<input type='checkbox'/>",require:"^ngModel",link:function(scope,element,attrs,ngModel){function apply(state){switch(state){case!1:element.attr("unchecked",!0);element.attr("checked",null);element.prop("indeterminate",!1);break;case!0:element.attr("unchecked",null);element.attr("checked",!0);element.prop("indeterminate",!1);break;default:element.attr("unchecked",null);element.attr("checked",null);element.prop("indeterminate",!0)}}var states=[!1,!0,"unknown"];element.bind("change",(function(){element.unbind("click");ngModel.$parsers=[];var state=ngModel.$viewValue;apply(state=states[(states.indexOf(state)+1)%3]);ngModel.$setViewValue(state)}));var watchViewValueFunction=scope.$watch((function(){return ngModel.$viewValue}),(function(value){apply(value);ngModel.$setViewValue(value)}));scope.$on("$destroy",(function(){watchViewValueFunction()}))}}}))}(NetBrain);!function(){angular.module("nb.qmap").controller("nb.qmap.createSampleMapCtrl",createSampleMapCtrl);createSampleMapCtrl.$inject=["$scope","$uibModalInstance","$q","createSampleMapHandle"];function createSampleMapCtrl($scope,$uibModalInstance,$q,createSampleMapHandle){$scope.mapOptions={uibModalInstance:$uibModalInstance,id:createSampleMapHandle.id}}}();!function(){angular.module("nb.qmap").controller("nb.qmap.nbMapLayoutSettingsCtrl",nbMapLayoutSettingsCtrl);nbMapLayoutSettingsCtrl.$inject=["$scope","$uibModalInstance","$q","mapLayoutSettingsHandle","$document"];function nbMapLayoutSettingsCtrl($scope,$uibModalInstance,$q,mapLayoutSettingsHandle,$document){var MapLayoutWording=NetBrain.MapLayout.Const.Wording.MapLayout;$scope.layerData=[];var currentLayout=null;var deviceIconSizeEnum=NetBrain.MapLayout.Const.DeviceIconSize;$scope.layerGridOptions={data:"layerData",columnDefs:[{field:"layer",displayName:MapLayoutWording.SettingsDialogGridColumn1TitleInLayerList,width:"129",cellTemplate:'<div class="ui-grid-cell-contents"><span class="layer-name-in-grid" title="Layer {{grid.appScope.getIndex($event, row.entity.id)}}">Layer {{grid.appScope.getIndex($event, row.entity.id)}}</span></div>'},{field:"maximumDeviceCount",displayName:MapLayoutWording.SettingsDialogGridColumn2TitleInLayerList,width:"230",cellTemplate:('<div class="ui-grid-cell-contents"><input class="input-max-device-count" ng-blur="grid.appScope.onBlur($event, row.entity.id)" type="number" name="maxDeviceCount" ng-model="row.entity.maximumDeviceCount"  min="1" max="99" required validate-tip="right" vtip-callback="grid.appScope.onChange3"  vtip-msg="grid.appScope.tipMsg3" vtip-class="vtip-error" vtip-event="input" atag="mapLayout:mapPane:secondContentDiv:matchedList:matchedOption:deviceCountInput" /></div>','<div class="ui-grid-cell-contents"><input class="input-max-device-count" ng-blur="grid.appScope.onBlur($event, row.entity.id)" type="number" name="maxDeviceCount" ng-model="row.entity.maximumDeviceCount"  min="1" max="99" required validate-tip="right" vtip-callback="grid.appScope.onChange3"  vtip-msg="grid.appScope.tipMsg3" vtip-class="vtip-error" vtip-event="input" atag="mapLayout:mapPane:secondContentDiv:matchedList:matchedOption:deviceCountInput" /></div>')},{field:"scale",displayName:MapLayoutWording.SettingsDialogGridColumn3TitleInLayerList,width:"150",cellTemplate:getFirstIconSizeCellTemplate()}],enableColumnResizing:!1,enableSorting:!1};function getFirstIconSizeCellTemplate(){return'<div class="ui-grid-cell-contents"><select class="drop-layer-tag " ng-model="row.entity.scaleValue" atag="mapLayout:mapPane:secondContentDiv:matchedList:matchedOption:deviceIconSizeSelect">    <option title="{{item.label}}" value="{{item.value}}" ng-repeat="item in grid.appScope.deviceSizeMenu">{{item.label}}</option></select></div>'}$scope.onBlur=function(event,id){var index=_.findIndex($scope.layerData,{id:id});if(index>=0){var numStr=$scope.layerData[index].maximumDeviceCount;(!numStr&&0!==numStr||(""+numStr).indexOf(".")>-1||!(+numStr>=1&&+numStr<=99))&&($scope.layerData[index].maximumDeviceCount=1);$document.find("div.showTipDirective-cmn.vtip-error").hide()}};$scope.onChange3=function(numStr){var flag=!0;(!numStr&&0!==numStr||(""+numStr).indexOf(".")>-1||!(+numStr>=1&&+numStr<=99))&&(flag=!1);try{$scope.$digest()}catch(err){console.warn("onChange3.")}return flag};$scope.tipMsg3={msg:MapLayoutWording.LayerDeviceCountErrorMessage};$scope.deviceIconSize=3;$scope.deviceSizeMenu=[{label:"Large(120%)",value:deviceIconSizeEnum.larger},{label:"Medium(100%)",value:deviceIconSizeEnum.normal},{label:"Small(80%)",value:deviceIconSizeEnum.small}];$scope.getIndex=function(event,id){return _.findIndex($scope.layerData,{id:id})+1};function findLayerItem(id){return _.find(currentLayout.layers,(function(item){return item.originalLayer.id===id}))}$scope.onOK=function(){for(var i=0;i<currentLayout.layoutLayers.length;i++){var item=currentLayout.layoutLayers[i];item.scale=parseInt(item.scaleValue);var layerItem=findLayerItem(item.id);layerItem&&(layerItem.maxNodeCount=item.maximumDeviceCount)}var opts={currentLayout:currentLayout};$uibModalInstance.close(opts)};$scope.onClose=function(){$uibModalInstance.dismiss($scope)};$scope.onCancel=function(){$uibModalInstance.dismiss($scope)};!function(){var data=mapLayoutSettingsHandle.currentLayout.layoutLayers;for(var i=0;i<data.length;i++){var item=data[i];item.id=NgUtil.getUniqueStr();item.scaleValue=item.scale.toString()}$scope.layerData=data;currentLayout=mapLayoutSettingsHandle.currentLayout}()}}();!function(){angular.module("nb.qmap").directive("nbMapLayoutStyleOrientationDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutStyleOrientationDirective.html",scope:{selectedLayout:"=",buttonStatus:"=",orientationEnum:"=",mapLayoutTypeIconList:"=",mapLayoutTypeDirection:"=",callback:"&"},link:function(scope,element,attrs){},controller:Controller,replace:!0}}]);Controller.$inject=["$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","$scope"];function Controller(element,attr,$timeout,$rootScope,$q,mapManagerSrvc,mapContextMenuManager,updateMapSrvc,$scope){var orientationEnum=$scope.orientationEnum=$scope.orientationEnum;var mapLayoutTypeIconList=$scope.mapLayoutTypeIconList;var mapLayoutTypeDirection=$scope.mapLayoutTypeDirection;var MapLayoutType=NetBrain.MapLayout.Const.MapLayoutType;var MapLayoutDirection=NetBrain.MapLayout.Const.MapLayoutDirection;var selectedLayout=$scope.selectedLayout;$scope.innerMaskOption={layerCount:0,layoutDirection:MapLayoutDirection.top,layoutType:MapLayoutType.multiTier};$scope.layer1="Layer1";$scope.layer2="Layer2";$scope.layer3="Layer3";$scope.showMask1=!1;$scope.showMask2=!1;$scope.showMask3=!1;$scope.showMask4=!1;$scope.orientationList=[{iconNames:{},css:"",orientation:""},{iconNames:{},css:"",orientation:""},{iconNames:{},css:"",orientation:""},{iconNames:{},css:"",orientation:""}];$scope.verticalStyle={};$scope.init=function(){var firstDir=selectedLayout.orientation;var layoutType=selectedLayout.type;var iconArray=mapLayoutTypeIconList[layoutType];$scope.orientationList[0].iconNames=iconArray[firstDir];$scope.orientationList[0].orientation=firstDir;var index=1;for(var i=0;i<mapLayoutTypeDirection[layoutType].length;i++){var dir=mapLayoutTypeDirection[layoutType][i];if(dir!==firstDir){$scope.orientationList[index].iconNames=iconArray[dir];$scope.orientationList[index].orientation=dir;index++}}$scope.innerMaskOption.layerCount=selectedLayout.layers.length;$scope.innerMaskOption.layoutType=layoutType;$scope.innerMaskOption.layoutDirection=getServerDir(selectedLayout.orientation)};$scope.funcOnRefreshOrientation=function(currentLayout){selectedLayout=currentLayout;$scope.init()};$scope.callback({func:$scope.funcOnRefreshOrientation});$scope.onClickItem=function(item,index){if(0!==index){var temp=$scope.orientationList[0];$scope.orientationList[0]=item;$scope.orientationList[index]=temp;selectedLayout.orientation=item.orientation;$scope.buttonStatus.applyToMapDisabled=!1;$scope.innerMaskOption.layoutDirection=getServerDir(item.orientation)}};$scope.init();function setAllMaskFalse(){$scope.showMask1=!1;$scope.showMask2=!1;$scope.showMask3=!1;$scope.showMask4=!1}function refreshMask(){if($scope.innerMaskOption.layoutType===MapLayoutType.multiTier){if($scope.innerMaskOption.layoutDirection===MapLayoutDirection.top||$scope.innerMaskOption.layoutDirection===MapLayoutDirection.bottom){$scope.showMask1=!0;$scope.verticalStyle={}}else if($scope.innerMaskOption.layoutDirection===MapLayoutDirection.left||$scope.innerMaskOption.layoutDirection===MapLayoutDirection.right){$scope.showMask2=!0;$scope.verticalStyle={"margin-top":"-20px",height:"217px"}}}else if($scope.innerMaskOption.layoutType===MapLayoutType.pairing)if($scope.innerMaskOption.layoutDirection===MapLayoutDirection.top||$scope.innerMaskOption.layoutDirection===MapLayoutDirection.bottom){$scope.showMask3=!0;$scope.verticalStyle={}}else if($scope.innerMaskOption.layoutDirection===MapLayoutDirection.left||$scope.innerMaskOption.layoutDirection===MapLayoutDirection.right){$scope.showMask4=!0;$scope.verticalStyle={}}refreshLayerCount($scope.innerMaskOption.layerCount)}var watchLayoutTypeFunction=$scope.$watch("innerMaskOption.layoutType",(function(value){setAllMaskFalse();refreshMask()}));var watchLayoutDirectionFunction=$scope.$watch("innerMaskOption.layoutDirection",(function(value){setAllMaskFalse();refreshMask()}));var watchLayerCountFunction=$scope.$watch("innerMaskOption.layerCount",(function(value){refreshLayerCount(value)}));function refreshLayerCount(count){var chg=!1;$scope.innerMaskOption.layoutDirection!==MapLayoutDirection.bottom&&$scope.innerMaskOption.layoutDirection!==MapLayoutDirection.right||(chg=!0);if(0===count||3===count){chg?$scope.layer3="Layer1":$scope.layer1="Layer1";$scope.layer2="Layer2";chg?$scope.layer1="Layer3":$scope.layer3="Layer3"}else if(1===count){chg?$scope.layer3="Layer1":$scope.layer1="Layer1";$scope.layer2="";chg?$scope.layer1="":$scope.layer3=""}else if(2===count){chg?$scope.layer3="Layer1":$scope.layer1="Layer1";$scope.layer2="Layer2";chg?$scope.layer1="":$scope.layer3=""}else if(count>3){chg?$scope.layer3="Layer1":$scope.layer1="Layer1";$scope.layer2="... ...";chg?$scope.layer1="Layer"+count:$scope.layer3="Layer"+count}else{$scope.layer1="Layer1";$scope.layer2="Layer2";$scope.layer3="Layer3"}}$scope.$on("$destroy",(function(){watchLayoutDirectionFunction();watchLayoutTypeFunction();watchLayerCountFunction()}));function getServerDir(ori){return ori===orientationEnum.tt?MapLayoutDirection.top:ori===orientationEnum.rr?MapLayoutDirection.right:ori===orientationEnum.ll?MapLayoutDirection.left:ori===orientationEnum.bb?MapLayoutDirection.bottom:MapLayoutDirection.top}}}();!function(NetBrain){angular.module("nb.qmap").directive("nbMapLayoutTagsDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutTagsDirective.html",scope:{layers:"=",associateTags:"=",tagList:"="},link:function(scope,element,attrs){},controller:Controller,replace:!0}}]);Controller.$inject=["$scope","$element","$attrs","$timeout","$rootScope","$q","$document","nb.common.nbAlertSrvc","nb.qmap.httpMapLayoutSrvc","nb.qmap.mapManagerSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","$compile","nb.ng.nbValidationSrvc"];function Controller($scope,element,attr,$timeout,$rootScope,$q,$document,nbAlertSrvc,httpMapLayoutSrvc,mapManagerSrvc,mapContextMenuManager,updateMapSrvc,$compile,nbValidationSrvc){var tagMenuId=$scope.uId="ul"+NgUtil.getUniqueStr();$scope.tagMenuItems=$scope.tagList;$scope.originalTagMenuItems=angular.copy($scope.tagList);var layers=$scope.layers;var tagsArray=$scope.associateTags;var oUl=null;var oInput=null;$scope.inputWarningStyle={};var inputWarningStyle={"background-color":"#fbd8db"};$scope.ulStyle={};var ulShowStyle={display:"block"};var ulHideStyle={display:"none"};var allTagMenuItems=[];var distinctTagMenuItems=[];$scope.search={key:""};$scope.showErroTip=!1;var LayoutTagWording=NetBrain.MapLayout.Const.Wording.LayoutTag;$scope.tagProp={showInput:!1};function initMenu(){var defer=$q.defer();httpMapLayoutSrvc.getDomainTagNames().then((function(result){allTagMenuItems=result.sort();$scope.tagList=allTagMenuItems;var tempTagsArray=getTempTagsArray(!0);distinctTagMenuItems=function(array,others){var result=[];for(var i=0;i<array.length;i++)_.indexOf(others,array[i].toUpperCase())<0&&result.push(array[i]);return result}(allTagMenuItems,tempTagsArray);$scope.tagMenuItems=distinctTagMenuItems.sort();$scope.originalTagMenuItems=angular.copy($scope.tagList);defer.resolve()}));return defer.promise}$scope.onAddTagClick=function(event){initMenu().then((function(){$scope.tagProp.showInput=!0;$scope.inputWarningStyle={};$timeout((function(){angular.element(event.target).next().find("input").focus()}),0)}))};$scope.onCloseTagInput=function(){if(oUl){var tagInput=element.find(".tag-input")[0];tagInput.value="";$scope.search.key="";for(var i=0;i<oUl.children.length;i++)angular.element(oUl.children[i]).removeClass("out-border");angular.element(tagInput).attr("nowIndex","-1");oUl.scrollTop=0;$scope.tagProp.showInput=!1}};$scope.onTagMenuItemMouseOver=function(item,event){var $li=angular.element(event.target);oInput.value=item;angular.element(oInput).attr("nowIndex",$li.attr("index"));$li.addClass("out-border").siblings().removeClass("out-border")};$scope.onTagMenuItemClick=function(){var tagInput=element.find(".tag-input")[0];if(tagInput.value&&""===tagInput.value)return!1;var str=checkStr(tagInput.value);if(!1===str){$scope.showErroTip=!0;return!1}tagInput.value="";$scope.search.key="";tagsArray.push(str);var index=_.indexOf($scope.tagMenuItems,str);index>=0&&$scope.tagMenuItems.splice(index,1);$scope.ulStyle=ulHideStyle;return!1};$scope.onInputKeyDown=function(event){var tagInput=angular.element(event.target)[0];if(13===event.keyCode||188===event.keyCode){if(""===tagInput.value)return!1;var str=checkStr(tagInput.value);if(!1===str)return!1;tagInput.value="";tagsArray.push(str);var index=_.indexOf($scope.tagMenuItems,str);index>=0&&$scope.tagMenuItems.splice(index,1);$scope.ulStyle=ulHideStyle;$scope.search.key="";return!1}if(8===event.keyCode&&""===tagInput.value)return!1;var nowIndex=parseInt($(tagInput).attr("nowIndex"));if(40===event.keyCode){(nowIndex+=1)===oUl.children.length&&(nowIndex=-1);for(var i=0;i<oUl.children.length;i++)angular.element(oUl.children[i]).removeClass("out-border");if(-1!==nowIndex){angular.element(oUl.children[nowIndex]).addClass("out-border");tagInput.value=oUl.children[nowIndex].innerHTML}else tagInput.value=angular.element(tagInput).attr("oldValue");angular.element(tagInput).attr("nowIndex",nowIndex)}if(38===event.keyCode){-2===(nowIndex-=1)&&(nowIndex=oUl.children.length-1);for(var j=0;j<oUl.children.length;j++)angular.element(oUl.children[j]).removeClass("out-border");if(-1!==nowIndex){angular.element(oUl.children[nowIndex]).addClass("out-border");tagInput.value=oUl.children[nowIndex].innerHTML}else tagInput.value=angular.element(tagInput).attr("oldValue");angular.element(tagInput).attr("nowIndex",nowIndex)}if(-1!==nowIndex){var ulPos=getPos(oUl);var ulHeight=angular.element(oUl).height();var ulScrollTop=oUl.scrollTop;var liPos=getPos(oUl.children[nowIndex]);if(40===event.keyCode){liPos.top-1+24>ulPos.top+ulHeight+ulScrollTop?oUl.scrollTop=ulScrollTop+24:0===nowIndex&&(oUl.scrollTop=0)}38===event.keyCode&&(liPos.top<ulPos.top+ulScrollTop?oUl.scrollTop=ulScrollTop-24:nowIndex===oUl.children.length-1&&(oUl.scrollTop=24*(nowIndex+1)-ulHeight))}return!1};function refreshTagMenu(){if($scope.search.key){var tempMenuItems=[];_.each(distinctTagMenuItems,(function(item){item.indexOf($scope.search.key)>=0&&tempMenuItems.push(item)}));$scope.tagMenuItems=tempMenuItems.sort()}else $scope.tagMenuItems=distinctTagMenuItems.sort()}$scope.onInputKeyUp=function(event){var tagInput=angular.element(event.target)[0];if(40===event.keyCode||38===event.keyCode||13===event.keyCode)return!1;$scope.inputWarningStyle={};if(8===event.keyCode&&""===tagInput.value){$scope.ulStyle=ulHideStyle;return!1}refreshTagMenu();if($scope.tagMenuItems.length>0){angular.element(tagInput).attr("nowIndex","-1");angular.element(tagInput).attr("oldValue",tagInput.value);var tagInputPos=getPos(tagInput);var bb=angular.element(window).height()-tagInputPos.top;ulShowStyle.left=tagInputPos.left;ulShowStyle.bottom=bb;$scope.ulStyle=ulShowStyle;resetMenuItemIndex()}else $scope.ulStyle=ulHideStyle;return!1};$scope.onInputFocus=function(event){refreshTagMenu();var tagInput=angular.element(event.target)[0];if($scope.tagMenuItems.length>0){angular.element(tagInput).attr("nowIndex","-1");angular.element(tagInput).attr("oldValue",tagInput.value);var tagInputPos=getPos(tagInput);var bb=angular.element(window).height()-tagInputPos.top;ulShowStyle.left=tagInputPos.left;ulShowStyle.bottom=bb;$scope.ulStyle=ulShowStyle;resetMenuItemIndex()}};$scope.onInputBlur=function(event){};$scope.onRemoveLabelClick=function(str,event){!function(str,tagSpan){var opt={title:LayoutTagWording.RemoveTagDialogTitle,buttons:[{id:NB_CONFIRM_CANCEL,label:LayoutTagWording.RemoveTagDialogCancelButton},{id:NB_CONFIRM_YES,label:LayoutTagWording.RemoveTagDialogOkButton}],message:StringUtil.format(LayoutTagWording.RemoveTagDialogMessage,{str:str})};nbAlertSrvc.warning(opt).then((function(result){if(result===NB_CONFIRM_YES){tagSpan.remove();!function(str){if(_.indexOf($scope.originalTagMenuItems,str)>=0){$scope.tagMenuItems.push(str);$scope.tagMenuItems=$scope.tagMenuItems.sort()}var index=_.indexOf(tagsArray,str);index>=0&&tagsArray.splice(index,1)}(str)}}))}(str,angular.element(event.target).parent().parent())};$scope.onInputChange=function(text){var str=checkStr(text,!0);return!(!str&&""!==str)};$scope.tipMsg={msg:LayoutTagWording.ForbidWindowsAndMongoChars};function resetMenuItemIndex(){for(var i=0;i<oUl.children.length;i++)oUl.children[i].index=i}function getTempTagsArray(changeToUpperCase){var tempTagsArray=[];for(var i=0;i<layers.length;i++){var layer=layers[i];for(var j=0;j<layer.associateTags.length;j++){var assTag=layer.associateTags[j];changeToUpperCase?tempTagsArray.push(assTag.toUpperCase()):tempTagsArray.push(assTag)}}return tempTagsArray}function checkStr(inputValue,isFromInputChange){if(!nbValidationSrvc.getValidator("generalForbidWindowsAndMongoCharsAndComma")(inputValue)){$scope.tipMsg.msg=LayoutTagWording.ForbidWindowsAndMongoChars;$scope.inputWarningStyle=inputWarningStyle;return!1}var str=inputValue.trim();if(_.indexOf(tagsArray,str)>-1){$scope.tipMsg.msg=LayoutTagWording.LayerTagHasDuplicateMessage;$scope.inputWarningStyle=inputWarningStyle;return!1}var tempTagsArray=getTempTagsArray(!0);if(_.indexOf(tempTagsArray,str.toUpperCase())>-1){$scope.tipMsg.msg=LayoutTagWording.LayerTagHasDuplicateMessage;$scope.inputWarningStyle=inputWarningStyle;return!1}if(tagsArray.length>=20){if(!isFromInputChange){var opt={message:LayoutTagWording.LayerTagCountLargeThen20};nbAlertSrvc.warning(opt)}$scope.tipMsg.msg=LayoutTagWording.LayerTagCountLargeThen20;$scope.inputWarningStyle=inputWarningStyle;return!1}return str}function getPos(obj){var rect=obj.getBoundingClientRect();var left=rect.left?rect.left-2:rect.x?rect.x-2:-99;var top=rect.top?rect.top-1:rect.y?rect.y-1:-99;if(-99===left||-99===top){var l=0;var t=0;for(;obj;){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}left=l-angular.element(".map-layout-right-box")[0].scrollLeft;top=t-angular.element(".map-layout-right-box")[0].scrollTop}return{left:left,top:top}}function onClickDocument(event){var $tar=angular.element(event.target);if($tar.hasClass("tag-input")&&$tar.attr("uid")===$scope.uId)$scope.showErroTip=!1;else{!$tar.hasClass("tag_input_close_class")&&oInput&&function(inputObj){var result=!0;var tagInput=angular.element(inputObj)[0];if(""===tagInput.value)result=!1;else{var str=checkStr(tagInput.value);if(!1===str)result=!1;else{tagInput.value="";tagsArray.push(str);var index=_.indexOf($scope.tagMenuItems,str);index>=0&&$scope.tagMenuItems.splice(index,1);$scope.ulStyle=ulHideStyle}}}(oInput);$scope.onCloseTagInput();$scope.ulStyle=ulHideStyle}}angular.element(document).on("click",onClickDocument);initMenu().then((function(){var $ul=angular.element("#"+tagMenuId);if(0===$ul.length){var $newElement=$compile('<ul id="'+tagMenuId+'" class="complete-list" ng-style="ulStyle"><li ng-repeat="item in tagMenuItems track by $index" r-index="$index" title="{{item}}" ng-mouseover="onTagMenuItemMouseOver(item, $event);" ng-click="onTagMenuItemClick(\''+tagMenuId+'\', item, $event);" ng-bind-html="item | nbHighlight: search.key" atag="mapLayout:layoutStylePane:layer:tag:menu{{tagMenuId}}Item{{$index}}">{{item}}</li></ul>')($scope);angular.element("body").append($newElement);$ul=angular.element("#"+tagMenuId)}oUl=$ul[0];oInput=element.find(".tag-input")[0]}));$scope.$on("$destroy",(function(){angular.element(oUl).remove();angular.element(document).off("click",onClickDocument)}))}}(NetBrain);!function(NetBrain){angular.module("nb.qmap").directive("nbMapTemplateAssignTagsDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapTemplateAssignTagsDirective.html",scope:{associateTags:"=",tagList:"=",callback:"&"},link:function(scope,element,attrs){},controller:Controller,replace:!0}}]);Controller.$inject=["$scope","$upload","$element","$attrs","$timeout","$rootScope","$q","$document","nb.common.nbAlertSrvc","nb.common.nbTipSrvc","nb.netbrain.httpDeviceSrvc","nb.netbrain.httpDeviceSettingSrvc","nb.ng.userSrvc","nb.qmap.mapManagerSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","$compile","nb.datamodel.httpDeviceGroupSrvc","nb.qmap.httpMapLayoutSrvc","nb.ng.nbValidationSrvc","nb.qmap.mapLayoutSrvc"];function Controller($scope,$upload,element,attr,$timeout,$rootScope,$q,$document,nbAlertSrvc,nbTipSrvc,httpDeviceSrvc,httpDeviceSettingSrvc,userSrvc,mapManagerSrvc,mapContextMenuManager,updateMapSrvc,$compile,httpDeviceGroupSrvc,httpMapLayoutSrvc,nbValidationSrvc,mapLayoutSrvc){var AssignTagsWording=NetBrain.MapLayout.Const.Wording.AssignTags;$scope.tagList=$scope.tagList;$scope.currentTagsTab=0;$scope.deviceGroupMapTreeData=[];$scope.selectedDeviceGroupId=null;$scope.selectedDeviceGroupName="";$scope.inputByDeviceGroupTag={value:""};$scope.hasSelectedDeviceGroup=!1;$scope.importTagsFile={value:""};$scope.isImporting=!1;$scope.uploadHandler=null;$scope.userCancelClick=!1;$scope.showImportCancelButton=!0;$scope.importTagTitle=AssignTagsWording.importTagExcelProgressTitle;var deviceIdListInDeviceGroup=[];var selectedDeviceIdListInDeviceGroup=[];$scope.selectedDeviceIdListInDeviceGroup=[];var deviceIdListInSearch=[];var selectedDeviceIdListInSearch=[];$scope.selectedDeviceIdListInSearch=[];function setCheckAllStatusForDeviceGroup(check,third){null!==check&&($scope.isCheckAllDeviceGroup.value=check);element.find(".is-check-all-in-device-group")[0]&&(element.find(".is-check-all-in-device-group")[0].indeterminate=third)}$scope.deviceGroupTreeOptions={expandToDepth:3,enableMultipleSelect:!1,labelAttribute:"Name",idAttribute:"ID",iconTemplate:function(node){return"-1"===node.ID||"1"===node.ID||"0"===node.ID||"2"===node.ID?'<div class="icon_nb_folder"></div>':'<div class="icon_nb_tree_devicegroup"></div>'},nodeClickCallback:function(node,trvw){var isSelected=trvw.isSelected(node);var id=node.ID;var rootType=NetBrain.MapLayout.Const.DeviceGroupType.Root.toString();var privateType=NetBrain.MapLayout.Const.DeviceGroupType.Private.toString();var sharedType=NetBrain.MapLayout.Const.DeviceGroupType.Shared.toString();var systemType=NetBrain.MapLayout.Const.DeviceGroupType.System.toString();if(isSelected&&id!==rootType&&id!==privateType&&id!==sharedType&&id!==systemType){$scope.selectedDeviceGroupId=node.ID;$scope.selectedDeviceGroupName=node.Name;ids=_.map(angular.element(".nb-dropdown-tree-directive.treeview-container"),(function(ele){return ele.id})),_.each(ids,(function(id){angular.element("#"+id).css({display:"none"})}));$scope.inputByDeviceGroupTag.value="";$scope.hasSelectedDeviceGroup=!0;selectedDeviceIdListInDeviceGroup=[];$scope.selectedDeviceIdListInDeviceGroup=[];refreshAssignTags($scope.selectedDeviceGroupId).then((function(){for(var i=0;i<$scope.deviceGroupAssignTagsData.length;i++){$scope.deviceGroupAssignTagsData[i].isCheck=!0}selectedDeviceIdListInDeviceGroup=deviceIdListInDeviceGroup;$scope.selectedDeviceIdListInDeviceGroup=selectedDeviceIdListInDeviceGroup;selectedDeviceIdListInDeviceGroup.length>0&&setCheckAllStatusForDeviceGroup(!0,!1)}))}else{deviceIdListInDeviceGroup=[];$scope.selectedDeviceGroupId="";$scope.selectedDeviceGroupName="";$scope.hasSelectedDeviceGroup=!1;$scope.deviceGroupAssignTagsData=[]}var ids},loadingIconOnDisplayDropdown:!0,beforeShowDropdownCallback:function(){var defer=$q.defer();mapLayoutSrvc.initDeviceGroupTreeData().then((function(result){$scope.deviceGroupMapTreeData=result;$scope.selectedDeviceGroupId="";$scope.selectedDeviceGroupName="";$scope.deviceGroupAssignTagsData=[];$scope.countInDeviceGroup=0;$scope.hasSelectedDeviceGroup=!1;setCheckAllStatusForDeviceGroup(!1,!1);defer.resolve()}),(function(){defer.resolve()}));return defer.promise}};$scope.refreshTagList=function(){httpMapLayoutSrvc.getDomainTagNames().then((function(result){result.length>0&&($scope.tagList=result.sort())}))};$scope.callback({func:$scope.refreshTagList});$scope.onAssignTagsTabClick=function(tabIndex){$scope.selectedDeviceGroupId=null;$scope.selectedDeviceGroupName="";$scope.inputByDeviceGroupTag.value="";httpMapLayoutSrvc.getDomainTagNames().then((function(result){$scope.tagList=result.sort()}));$scope.currentTagsTab=tabIndex;if(0===tabIndex){$scope.deviceGroupMapTreeData=[];$scope.deviceGroupAssignTagsData=[];$scope.countInDeviceGroup=0;$scope.hasSelectedDeviceGroup=!1;setCheckAllStatusForDeviceGroup(!1,!1)}else if(1===tabIndex){$scope.assignTagsBySearchData=[];$scope.countWithSearchDevice=0;$scope.inputBySearchDevice.value="";$scope.inSearch.value=!1;$scope.hasSearched=!1;$scope.clearFilterForSearch();$scope.inputBySearchTag.value="";$scope.isCheckAllSearchDevice.value=!1}else 2===tabIndex&&angular.element("#inputImportTagsForMapTemplateLayout").val("")};$scope.deviceGroupAssignTagsData=[];$scope.isCheckAllDeviceGroup={value:!1};$scope.assignTagsByDeviceGroupGridOptions={data:"deviceGroupAssignTagsData",columnDefs:[{field:"isCheck",displayName:"",width:"29",cellClass:"is-check",cellTemplate:'<div class="ui-grid-cell-contents"><input type="checkbox" class="input-check" ng-checked="COL_FIELD == true" ng-click="grid.appScope.onClickIsCheckInRowInDeviceGroup(row, $event)" ng-modal="COL_FIELD"/></div>'},{field:"deviceName",displayName:AssignTagsWording.gridColumn1TitleBySearch,width:"200",cellClass:"deviceName",cellTemplate:('<div class="ui-grid-cell-contents"><span class="search-device-name" title="{{row.entity.deviceName}}">{{row.entity.deviceName}}</span></div>','<div class="ui-grid-cell-contents"><span class="search-device-name" title="{{row.entity.deviceName}}">{{row.entity.deviceName}}</span></div>')},{field:"tags",displayName:AssignTagsWording.gridColumn2TitleBySearch,width:"*",cellClass:"tags",cellTemplate:get2TagsBySearchCellTemplate()}],enableColumnResizing:!1,enableSorting:!1};$scope.onClickCheckAllInDeviceGroup=function(event){var isCheck=angular.element(event.target).is(":checked");for(var i=0;i<$scope.deviceGroupAssignTagsData.length;i++){$scope.deviceGroupAssignTagsData[i].isCheck=isCheck}var selectedItems=_.where($scope.deviceGroupAssignTagsData,{isCheck:!0});selectedDeviceIdListInDeviceGroup=_.pluck(selectedItems,"deviceId");$scope.selectedDeviceIdListInDeviceGroup=selectedDeviceIdListInDeviceGroup};$scope.onClickIsCheckInRowInDeviceGroup=function(row,event){var isCheck=angular.element(event.target).is(":checked");row.entity.isCheck=isCheck;var selectedItems=_.where($scope.deviceGroupAssignTagsData,{isCheck:!0});(selectedDeviceIdListInDeviceGroup=_.pluck(selectedItems,"deviceId")).length===deviceIdListInDeviceGroup.length&&selectedDeviceIdListInDeviceGroup.length>0?setCheckAllStatusForDeviceGroup(!0,!1):selectedDeviceIdListInDeviceGroup.length>0?setCheckAllStatusForDeviceGroup(null,!0):setCheckAllStatusForDeviceGroup(!1,!1);$scope.selectedDeviceIdListInDeviceGroup=selectedDeviceIdListInDeviceGroup};function get2TagsBySearchCellTemplate(){return'<div class="ui-grid-cell-contents"><div class="tag-outer-container"><div class="tag-outer" ng-repeat="item in row.entity.tagList track by $index"><div class="tag-box"><span class="tag-msg" title="{{item}}">{{item}}</span><span class="icon_nb_tags_close_14" title="Delete the Tag" ng-click="grid.appScope.onDeleteTagFromDeviceInDeviceGroup($event, row.entity.deviceId, item, row.entity)"></span></div></div></div></div>'}$scope.onDeleteTagFromDeviceInDeviceGroup=function(event,deviceId,tagName,entity){if(tagName){var tag=tagName;var devList=[deviceId];var opt={title:AssignTagsWording.deleteTagByDeviceGroupDialogTitle,buttons:[{id:NB_CONFIRM_CANCEL,label:AssignTagsWording.deleteTagByDeviceGroupDialogCancelButton},{id:NB_CONFIRM_YES,label:AssignTagsWording.deleteTagByDeviceGroupDialogOkButton}],message:StringUtil.format(AssignTagsWording.deleteTagByDeviceGroupDialogMessage,{tag:tag})};nbAlertSrvc.warning(opt).then((function(dialogResult){dialogResult===NB_CONFIRM_YES&&httpMapLayoutSrvc.deleteLayoutTagsInDevs([tag],devList).then((function(ajaxResult){if(ajaxResult){var options={tipInfo:StringUtil.format(AssignTagsWording.deleteTagByDeviceGroupSuccessTip,{tag:tag}),autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);var index=_.indexOf(entity.tagList,tag);index>=0&&entity.tagList.splice(index,1)}}),(function(err){var opt1={message:AssignTagsWording.deleteTagByDeviceGroupFailedTip};nbAlertSrvc.warning(opt1);console.error(err)}))}))}};$scope.countInDeviceGroup=0;function refreshAssignTags(dgId){return httpMapLayoutSrvc.getAllDevicesTagsByDeviceGroupIds([dgId],0,5e4).then((function(result){if(result&&result.length>0){var list=[];for(var i=0;i<result.length;i++){var device=result[i];var item={isCheck:!1,deviceId:device.ID,deviceName:device.name};device.assignTags?item.tagList=device.assignTags:item.tagList=[];list.push(item)}$scope.deviceGroupAssignTagsData=list;deviceIdListInDeviceGroup=_.pluck($scope.deviceGroupAssignTagsData,"deviceId");$scope.countInDeviceGroup=deviceIdListInDeviceGroup.length}else{$scope.deviceGroupAssignTagsData=[];deviceIdListInDeviceGroup=[];$scope.countInDeviceGroup=0}selectedDeviceIdListInDeviceGroup=[];$scope.selectedDeviceIdListInDeviceGroup=[]}))}function doMouseOverEvent(item){$timeout((function(){item.ele=angular.element("[uib-popover-template-popup]").last();angular.element("[uib-popover-template-popup]").last().on("mouseenter",(function(){item.isOnElement=!0})).on("mouseleave",(function(){item.isOnElement=!1;item.showDevice=!1;try{$scope.$digest()}catch(e){console.error("doMouseOverEnter error")}}))}),0)}$scope.onDeviceCountMouseEnter=function(event,id){for(var i=0;i<$scope.deviceGroupAssignTagsData.length;i++){var item=$scope.deviceGroupAssignTagsData[i];if(id===item.id){item.showDevice=!0;doMouseOverEvent(item)}else{item.showDevice=!1;item.isOnElement=!1;item.ele=null}}};$scope.onDeviceCountMouseLeave=function(){$timeout((function(){for(var i=0;i<$scope.deviceGroupAssignTagsData.length;i++){var item=$scope.deviceGroupAssignTagsData[i];if(!item.isOnElement){item.showDevice=!1;item.isOnElement=!1}}}),20)};$scope.onDeleteFromDeviceGroup=function(event,id,tagName){if(tagName){var tag=tagName;var devList=deviceIdListInDeviceGroup;var opt={title:AssignTagsWording.deleteTagByDeviceGroupDialogTitle,buttons:[{id:NB_CONFIRM_CANCEL,label:AssignTagsWording.deleteTagByDeviceGroupDialogCancelButton},{id:NB_CONFIRM_YES,label:AssignTagsWording.deleteTagByDeviceGroupDialogOkButton}],message:StringUtil.format(AssignTagsWording.deleteTagByDeviceGroupDialogMessage,{tag:tag})};nbAlertSrvc.warning(opt).then((function(dialogResult){dialogResult===NB_CONFIRM_YES&&httpMapLayoutSrvc.deleteLayoutTagsInDevs([tag],devList).then((function(ajaxResult){if(ajaxResult){var options={tipInfo:StringUtil.format(AssignTagsWording.deleteTagByDeviceGroupSuccessTip,{tag:tag}),autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);refreshAssignTags($scope.selectedDeviceGroupId)}}),(function(err){var opt1={message:AssignTagsWording.deleteTagByDeviceGroupFailedTip};nbAlertSrvc.warning(opt1);console.error(err)}))}))}};$scope.clearTagInputForDeviceGroup=function(){$scope.inputByDeviceGroupTag.value=""};$scope.assignTagByDeviceGroup=function(){var devIdList=selectedDeviceIdListInDeviceGroup;var tagName=$scope.inputByDeviceGroupTag.value;var data={tagNames:[tagName],devIds:devIdList};httpMapLayoutSrvc.updateLayoutTagForDevs(data,null).then((function(result){if(result){refreshTagList();var deviceCnt=devIdList.length;var showTagName=tagName;tagName.length>20&&(showTagName=tagName.substring(0,20)+"...");var options={tipInfo:StringUtil.format(AssignTagsWording.assignTagByDeviceGroupSuccessTip,{tag:showTagName,deviceCnt:deviceCnt}),autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);for(var i=0;i<$scope.deviceGroupAssignTagsData.length;i++){var item=$scope.deviceGroupAssignTagsData[i];if(_.indexOf(devIdList,item.deviceId)>=0){if((","+item.tagList.join(",").toUpperCase()+",").indexOf(","+tagName.toUpperCase()+",")<0){tagName=tagName.toLowerCase().replace(/^\S/g,(function(s){return s.toUpperCase()}));item.tagList.push(tagName)}}}}}),(function(err){var opt1={message:AssignTagsWording.assignTagByDeviceGroupFailedTip};nbAlertSrvc.warning(opt1);console.error(err)}))};$scope.deleteAllTagsByDeviceGroup=function(){var devIdList=selectedDeviceIdListInDeviceGroup;var list=_.filter($scope.deviceGroupAssignTagsData,(function(item){return _.indexOf(devIdList,item.deviceId)>=0}));var list2=_.chain(list).filter((function(item){return item.tagList&&item.tagList.length})).map((function(item){return item.tagList.map((function(tag){return{deviceId:item.deviceId,deviceName:item.deviceName,tag:tag}}))})).flatten().groupBy("tag").map((function(items,tag){return{tagName:tag,deviceList:items.map((function(item){return item.deviceId}))}})).value();console.log(list2);var opt={title:AssignTagsWording.deleteTagBySearchAllDialogTitle,buttons:[{id:NB_CONFIRM_CANCEL,label:AssignTagsWording.deleteTagBySearchAllDialogCancelButton},{id:NB_CONFIRM_YES,label:AssignTagsWording.deleteTagBySearchAllDialogOkButton}],message:AssignTagsWording.deleteTagBySearchAllDialogMessage};nbAlertSrvc.warning(opt).then((function(dialogResult){if(dialogResult===NB_CONFIRM_YES){var tagList=_.pluck(list2,"tagName");httpMapLayoutSrvc.deleteLayoutTagsInDevs(tagList,selectedDeviceIdListInDeviceGroup).then((function(ajaxResult){if(ajaxResult){var options={tipInfo:AssignTagsWording.deleteTagBySearchAllSuccessTip,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);for(var i=0;i<list.length;i++){list[i].tagList=[]}}}))}}),(function(err){var opt1={message:AssignTagsWording.deleteTagBySearchAllFailedTip};nbAlertSrvc.warning(opt1);console.error(err)}))};$scope.searchOption={};$scope.inputBySearchDevice={value:""};$scope.inputBySearchTag={value:""};$scope.countWithSearchDevice=0;$scope.hasSearched=!1;$scope.inSearch={value:!1};$scope.assgignTagsBySearchGridApi=null;$scope.assignTagsBySearchData=[];$scope.isCheckAllSearchDevice={value:!1};$scope.onSearchDeviceInputKeyUp=function(event){27===event.keyCode&&($scope.inputBySearchDevice.value="");if(""===$scope.inputBySearchDevice.value){$scope.clearFilterForSearch();$scope.inSearch.value=!1}else{if(13!==event.keyCode){$scope.inSearch.value=!1;return}$scope.searchDevice();$scope.hasSearched=!0;$scope.inSearch.value=!0}};$scope.searchDevice=function(){var defer=$q.defer();var key=$scope.inputBySearchDevice.value;key?httpMapLayoutSrvc.getAllDeviceTagsByPaging(0,5e4,"name","asc",key).then((function(result){if(result&&result.length>0){var list=[];for(var i=0,leg=result.length;i<leg;i++){var device=result[i];var item={};item.isCheck=!0;item.deviceId=device.ID;item.deviceName=device.name;device.assignTags?item.tagList=device.assignTags:item.tagList=[];list.push(item)}$scope.assignTagsBySearchData=list;deviceIdListInSearch=_.pluck($scope.assignTagsBySearchData,"deviceId");selectedDeviceIdListInSearch=deviceIdListInSearch;$scope.selectedDeviceIdListInSearch=selectedDeviceIdListInSearch;setCheckAllStatusForSearch(!0,!1);var cnt=$scope.assignTagsBySearchData.length;$scope.countWithSearchDevice=cnt}else{$scope.assignTagsBySearchData=[];deviceIdListInSearch=[];$scope.countWithSearchDevice=0;selectedDeviceIdListInSearch=[];$scope.selectedDeviceIdListInSearch=[];setCheckAllStatusForSearch(!1,!1)}$scope.inputBySearchTag.value="";$scope.inSearch.value=!0;$scope.hasSearched=!0;defer.resolve()})):defer.resolve();return defer.promise};function setCheckAllStatusForSearch(check,third){null!==check&&($scope.isCheckAllSearchDevice.value=check);element.find(".is-check-all-in-search-device")[0]&&(element.find(".is-check-all-in-search-device")[0].indeterminate=third)}$scope.clearFilterForSearch=function(){$scope.assignTagsBySearchData=[];$scope.inputBySearchDevice.value="";$scope.countWithSearchDevice=0;$scope.inSearch.value=!1;$scope.hasSearched=!1;setCheckAllStatusForSearch(!1,!1);selectedDeviceIdListInSearch=[];$scope.selectedDeviceIdListInSearch=[]};$scope.clearTagInputForSearch=function(){$scope.inputBySearchTag.value=""};$scope.assignTagsBySearchGridOptions={onRegisterApi:function(gridApi){$scope.assgignTagsBySearchGridApi=gridApi;gridApi.selection.on.rowSelectionChanged($scope,(function(){}))},data:"assignTagsBySearchData",columnDefs:[{field:"isCheck",displayName:"",width:"29",cellClass:"is-check",cellTemplate:getIsCheckCellTemplate()},{field:"deviceName",displayName:AssignTagsWording.gridColumn1TitleBySearch,width:"200",cellClass:"deviceName",cellTemplate:getDeviceNameCellTemplate()},{field:"tags",displayName:AssignTagsWording.gridColumn2TitleBySearch,width:"*",cellClass:"tags",cellTemplate:getTagsBySearchCellTemplate()}],enableColumnResizing:!1,enableSorting:!1,multiSelect:!1,modifierKeysToMultiSelect:!1,enableRowHeaderSelection:!1,enableFullRowSelection:!1};$scope.onClickCheckAllInSearchDevice=function(event){var isCheck=angular.element(event.target).is(":checked");for(var i=0;i<$scope.assignTagsBySearchData.length;i++){$scope.assignTagsBySearchData[i].isCheck=isCheck}var selectedItems=_.where($scope.assignTagsBySearchData,{isCheck:!0});selectedDeviceIdListInSearch=_.pluck(selectedItems,"deviceId");$scope.selectedDeviceIdListInSearch=selectedDeviceIdListInSearch};$scope.onClickIsCheckInRow=function(row,event){var isCheck=angular.element(event.target).is(":checked");row.entity.isCheck=isCheck;var selectedItems=_.where($scope.assignTagsBySearchData,{isCheck:!0});(selectedDeviceIdListInSearch=_.pluck(selectedItems,"deviceId")).length===deviceIdListInSearch.length&&selectedDeviceIdListInSearch.length>0?setCheckAllStatusForSearch(!0,!1):selectedDeviceIdListInSearch.length>0?setCheckAllStatusForSearch(null,!0):setCheckAllStatusForSearch(!1,!1);$scope.selectedDeviceIdListInSearch=selectedDeviceIdListInSearch};function getIsCheckCellTemplate(){return'<div class="ui-grid-cell-contents"><input type="checkbox" class="input-check" ng-checked="COL_FIELD == true" ng-click="grid.appScope.onClickIsCheckInRow(row, $event)" ng-modal="COL_FIELD"/></div>'}function getDeviceNameCellTemplate(){return'<div class="ui-grid-cell-contents"><span class="search-device-name" title="{{row.entity.deviceName}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.inputBySearchDevice.value">{{row.entity.deviceName}}</span></div>'}function getTagsBySearchCellTemplate(){return'<div class="ui-grid-cell-contents"><div class="tag-outer-container"><div class="tag-outer" ng-repeat="item in row.entity.tagList track by $index"><div class="tag-box"><span class="tag-msg" title="{{item}}">{{item}}</span><span class="icon_nb_tags_close_14" title="Delete the Tag" ng-click="grid.appScope.onDeleteTagFromDevice($event, row.entity.deviceId, item, row.entity)"></span></div></div></div></div>'}$scope.onDeleteTagFromDevice=function(event,deviceId,tagName,entity){if(tagName){var tag=tagName;var devList=[deviceId];var opt={title:AssignTagsWording.deleteTagBySearchDialogTitle,buttons:[{id:NB_CONFIRM_CANCEL,label:AssignTagsWording.deleteTagBySearchDialogCancelButton},{id:NB_CONFIRM_YES,label:AssignTagsWording.deleteTagBySearchDialogOkButton}],message:StringUtil.format(AssignTagsWording.deleteTagBySearchDialogMessage,{tag:tag})};nbAlertSrvc.warning(opt).then((function(dialogResult){dialogResult===NB_CONFIRM_YES&&httpMapLayoutSrvc.deleteLayoutTagsInDevs([tagName],devList).then((function(ajaxResult){if(ajaxResult){var options={tipInfo:StringUtil.format(AssignTagsWording.deleteTagBySearchSuccessTip,{tag:tag}),autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);var index=_.indexOf(entity.tagList,tag);index>=0&&entity.tagList.splice(index,1)}}))}),(function(err){var opt1={message:AssignTagsWording.deleteTagBySearchFailedTip};nbAlertSrvc.warning(opt1);console.error(err)}))}};$scope.assignTagBySearch=function(){var devIdList=selectedDeviceIdListInSearch;var tagName=$scope.inputBySearchTag.value;var data={tagNames:[tagName],devIds:devIdList};httpMapLayoutSrvc.updateLayoutTagForDevs(data,null).then((function(result){if(!0===result){refreshTagList();var deviceCnt=devIdList.length;var showTagName=tagName;tagName.length>20&&(showTagName=tagName.substring(0,20)+"...");var options={tipInfo:StringUtil.format(AssignTagsWording.assignTagBySearchSuccessTip,{showTagName:showTagName,deviceCnt:deviceCnt}),autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);for(var i=0;i<$scope.assignTagsBySearchData.length;i++){var item=$scope.assignTagsBySearchData[i];if(_.indexOf(devIdList,item.deviceId)>=0){if((","+item.tagList.join(",").toUpperCase()+",").indexOf(","+tagName.toUpperCase()+",")<0){tagName=tagName.toLowerCase().replace(/^\S/g,(function(s){return s.toUpperCase()}));item.tagList.push(tagName)}}}}}),(function(err){var opt1={message:AssignTagsWording.assignTagBySearchFailedTip};nbAlertSrvc.warning(opt1);console.error(err)}))};$scope.deleteAllTagsBySearch=function(){var devIdList=selectedDeviceIdListInSearch;var list=_.filter($scope.assignTagsBySearchData,(function(item){return _.indexOf(devIdList,item.deviceId)>=0}));var list2=_.chain(list).filter((function(item){return item.tagList&&item.tagList.length})).map((function(item){return item.tagList.map((function(tag){return{deviceId:item.deviceId,deviceName:item.deviceName,tag:tag}}))})).flatten().groupBy("tag").map((function(items,tag){return{tagName:tag,deviceList:items.map((function(item){return item.deviceId}))}})).value();console.log(list2);var opt={title:AssignTagsWording.deleteTagBySearchAllDialogTitle,buttons:[{id:NB_CONFIRM_CANCEL,label:AssignTagsWording.deleteTagBySearchAllDialogCancelButton},{id:NB_CONFIRM_YES,label:AssignTagsWording.deleteTagBySearchAllDialogOkButton}],message:AssignTagsWording.deleteTagBySearchAllDialogMessage};nbAlertSrvc.warning(opt).then((function(dialogResult){if(dialogResult===NB_CONFIRM_YES){var tagList=_.pluck(list2,"tagName");httpMapLayoutSrvc.deleteLayoutTagsInDevs(tagList,devIdList).then((function(ajaxResult){if(ajaxResult){var options={tipInfo:AssignTagsWording.deleteTagBySearchAllSuccessTip,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);for(var i=0;i<list.length;i++){list[i].tagList=[]}}}))}}),(function(err){var opt1={message:AssignTagsWording.deleteTagBySearchAllFailedTip};nbAlertSrvc.warning(opt1);console.error(err)}))};$scope.validTag=!1;$scope.onInputChange=function(text){if(!nbValidationSrvc.getValidator("generalForbidWindowsAndMongoCharsAndComma")(text)){$scope.tipMsg.msg=AssignTagsWording.assignTagInputValidateMessage;$scope.validTag=!1;return!1}$scope.validTag=!0;return!0};$scope.tipMsg={msg:AssignTagsWording.assignTagInputValidateMessage};$scope.onInputKeyUp=function(event){if(27===event.keyCode){event.preventDefault();$scope.refreshTagList()}return!1};$scope.onInputFocus=function(event){var text=$(event.target).val();$scope.onInputChange(text)};function refreshTagList(){var defer=$q.defer();httpMapLayoutSrvc.getDomainTagNames().then((function(result){$scope.tagList=result.sort();defer.resolve()}),(function(err){defer.reject();console.error(err)}));return defer.promise}$scope.importTagsOptions={accept:".csv,.xls,.xlsx"};$scope.onImportFileClick=function(){angular.element("#inputImportTagsForMapTemplateLayout").click()};var fileAction_getFileType=function(file){return file.name.substr(file.name.lastIndexOf(".")).toLowerCase()},fileAction_isMatchedFileType=function(acceptType,fileType){var isMatch=!0;acceptType&&(isMatch=acceptType.indexOf(fileType)>-1);return isMatch},fileAction_isMatchedFileSize=function(file){return file.size<52428800};$scope.onFileSelect=function($files){$scope.userCancelClick=!1;var file=$files[0];var isMatchedFileType=fileAction_isMatchedFileType($scope.importTagsOptions.accept,fileAction_getFileType(file));var isMatchedFileSize=fileAction_isMatchedFileSize(file);if(isMatchedFileType&&isMatchedFileSize){$scope.uploadHandler=$q.defer();$scope.isImporting=!0;$scope.showImportCancelButton=!0;httpMapLayoutSrvc.uploadTags({file:file,fileName:file.name},$scope.uploadHandler).then((function(result){if($scope.userCancelClick){$scope.isImporting=!1;showImportTagsCancelInfo()}else if(result&&result.heads){var heads=result.heads;var head=heads[0];var col0="col_0";var col1="col_1";if(head.col0&&head.col1){col0="col0";col1="col1"}var hasHostname=head[col0]&&head[col0].toUpperCase()==="Device Name".toUpperCase();var hasLayoutTag=head[col1]&&head[col1].toUpperCase()==="Layout Tags".toUpperCase();if(hasHostname&&hasLayoutTag){var data=[];var devNameList=[];for(var i=1;i<heads.length;i++){var item=heads[i];var tags=[];item[col1]&&(tags=item[col1].split(","));var tag={devName:item[col0],tagNames:tags};if(tag.devName&&tags.length>0){data.push(tag);devNameList.push(tag.devName)}}$timeout((function(){resetImportStatus();$scope.uploadHandler=null;var deviceCnt=data.length;var opt={title:AssignTagsWording.assignTagByImportDialogTitle,buttons:[{id:NB_CONFIRM_CANCEL,label:AssignTagsWording.assignTagByImportDialogCancelButton},{id:NB_CONFIRM_YES,label:AssignTagsWording.assignTagByImportDialogOkButton}],message:StringUtil.format(AssignTagsWording.assignTagByImportDialogMessage,{deviceCnt:deviceCnt})};if($scope.userCancelClick){resetImportStatus();showImportTagsCancelInfo()}else nbAlertSrvc.confirm(opt).then((function(){$scope.isImporting=!0;$scope.showImportCancelButton=!1;httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,devNameList).then((function(deviceList){var newData=[];for(var j=0;j<data.length;j++){var newItem=data[j];_.findIndex(deviceList,{name:newItem.devName})>=0&&newData.push(newItem)}if(newData.length>0)httpMapLayoutSrvc.importLayoutTagForDevs(newData).then((function(){resetImportStatus();$timeout((function(){showImportTagsSuccessInfo(newData.length);$scope.importedTagsData=function(newData){var newGridData=[];for(var i=0;i<newData.length;i++){var newDataRow=newData[i];var newGridRow={devName:newDataRow.devName,tagNameString:newDataRow.tagNames.join(",")};newGridData.push(newGridRow)}return newGridData}(newData)}),0)}),(function(){resetImportStatus()}));else{resetImportStatus();$timeout((function(){showImportTagsSuccessInfo(0)}),0)}}),(function(){resetImportStatus()}))}),(function(){resetImportStatus()}))}),0)}else{$scope.isImporting=!1;angular.element("#inputImportTagsForMapTemplateLayout").val("");var opt0={message:AssignTagsWording.importTagExcelFormatErrorMessage};nbAlertSrvc.warning(opt0)}}else if(793001===result.statusCode||result.statusCode){$scope.isImporting=!1;angular.element("#inputImportTagsForMapTemplateLayout").val("");var opt1={message:AssignTagsWording.importTagExcelFileFormatErrorMessage};nbAlertSrvc.error(opt1)}else{$scope.isImporting=!1;angular.element("#inputImportTagsForMapTemplateLayout").val("")}}),(function(err){$scope.isImporting=!1;var opt1={message:AssignTagsWording.assignTagByImportFailedTip};nbAlertSrvc.warning(opt1);console.error(err)}))}else{angular.element("#inputImportTagsForMapTemplateLayout").val("");var opt1={message:AssignTagsWording.importTagExcelFileFormatErrorMessage};nbAlertSrvc.error(opt1)}};$scope.onDownloadTemplate=function(){console.log("download template file");return httpMapLayoutSrvc.downloadTemplate({fileName:"import_tags_template.csv"}).then((function(data){console.log("download file",data);var blob=new Blob([data],{type:"text/csv;"});saveAs(blob,"import_tags_template.csv")})).catch((function(reason){var message=StringUtil.format(AssignTagsWording.downloadTemplateFailed,{reason:reason});nbAlertSrvc.warning({message:message})}))};$scope.onCancelImporting=function(){$scope.uploadHandler&&$scope.uploadHandler.resolve();$scope.isImporting=!1;$scope.userCancelClick=!0};function showImportTagsSuccessInfo(deviceCnt){var options={tipInfo:StringUtil.format(AssignTagsWording.assignTagByImportSuccessTip,{deviceCnt:deviceCnt}),autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options)}function showImportTagsCancelInfo(){var options={tipInfo:AssignTagsWording.importTagExcelUserClickCancel,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options)}function resetImportStatus(){$scope.isImporting=!1;angular.element("#inputImportTagsForMapTemplateLayout").val("")}$scope.importedTagsData=[];$scope.importedTagsGridOptions={data:"importedTagsData",columnDefs:[{field:"devName",displayName:"Device Name",width:"200",cellClass:"deviceName",cellTemplate:'<div class="ui-grid-cell-contents"><span class="search-device-name" title="{{row.entity.devName}}">{{row.entity.devName}}</span></div>'},{field:"tagNameString",displayName:"Layout Tags",width:"*",cellClass:"tags",cellTemplate:'<div class="ui-grid-cell-contents"><span class="search-device-name" title="{{row.entity.tagNameString}}">{{row.entity.tagNameString}}</span></div>'}],enableColumnResizing:!1,enableSorting:!1,multiSelect:!1,modifierKeysToMultiSelect:!1,enableRowHeaderSelection:!1,enableFullRowSelection:!1};$scope.onAssignTagsTabClick(0)}angular.module("nb.qmap").directive("typeaheadOpenOnFocus",[function(){return{require:["ngModel","^?ngModelOptions","uibTypeahead"],link:function(scope,element,attr,ctrls){element.bind("focus",(function(){}))}}}]);angular.module("nb.qmap").directive("typeaheadFocus",["$timeout","nb.qmap.httpMapLayoutSrvc",function($timeout,httpMapLayoutSrvc){return{require:["ngModel","^?ngModelOptions","uibTypeahead"],scope:!1,link:function(scope,element,attr,ctrls){var ngModel=ctrls[0];ngModel.$parsers.push((function(inputValue){return" "===inputValue?"":inputValue}));element.bind("click",(function(){httpMapLayoutSrvc.getDomainTagNames().then((function(result){scope.$parent.tagList=result.sort();if(result.length>0){var viewValue=ngModel.$viewValue;if(ngModel.$modelValue){" "===viewValue&&ngModel.$setViewValue("");ngModel.$setViewValue(" ");ngModel.$setViewValue(viewValue||" ")}else if("true"!==element.attr("aria-expanded")){" "===viewValue&&ngModel.$setViewValue("");ngModel.$setViewValue(" ");ngModel.$setViewValue(viewValue||" ");ctrls[2].init(ctrls[0],ctrls[1]);ngModel.$setViewValue(viewValue||" ");element.blur();element.focus()}}else{scope.tagList=[];if("true"!==element.attr("aria-expanded")){var viewValue1=ngModel.$viewValue;" "===viewValue1&&ngModel.$setViewValue("");ngModel.$setViewValue(" ");ngModel.$setViewValue(viewValue1||" ");ngModel.$setViewValue(" ");ngModel.$setViewValue(viewValue1||" ");ctrls[2].init(ctrls[0],ctrls[1]);ngModel.$setViewValue(viewValue1||" ");element.blur();element.focus()}}}))}));scope.emptyOrMatch=function(actual,expected){if(" "==expected)return!0;return actual.indexOf(expected)>-1}}}}])}(NetBrain);!function(){angular.module("nb.qmap").directive("nbMapTemplateLayoutAssociationDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapTemplateLayoutAssociationDirective.html",scope:{associateTags:"=",tagList:"="},link:function(scope,element,attrs){},controller:Controller,replace:!0}}]);Controller.$inject=["$scope","$element","$attrs","$timeout","$rootScope","$q","$document","uiGridTreeBaseService","nb.common.nbAlertSrvc","nb.common.nbTipSrvc","nb.qmap.mapManagerSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","$compile","nb.qmap.mapLayoutSrvc","nb.ng.utilitySrvc"];function Controller($scope,element,attr,$timeout,$rootScope,$q,$document,uiGridTreeBaseService,nbAlertSrvc,nbTipSrvc,mapManagerSrvc,mapContextMenuManager,updateMapSrvc,$compile,mapLayoutSrvc,utilitySrvc){var AssociationWording=NetBrain.MapLayout.Const.Wording.Association;var nodeTypeEnum=NetBrain.MapLayout.Const.NodeTypeEnum;var consts=NetBrain.MapLayout.Const;$scope.filterObj={siteMapFilterValue:"",deviceGroupMapFilterValue:"",hasSelectedSiteMapRow:!1};$scope.isCheckAllOption={siteMapCheckAll:!1};$scope.siteMapData=[];$scope.siteMapLayoutTreeData=[];$scope.selectedSiteMapList=[];$scope.searchStatus=!1;$scope.siteMapSearchData=[];$scope.deviceGroupMapData=[];$scope.deviceGroupMapLayoutTreeData=[];$scope.deviceGroupTreeData=[];var deviceGroupGridLayoutStyleTreeOptions=$scope.deviceGroupGridLayoutStyleTreeOptions={};var deviceGroupTreeOptions=$scope.deviceGroupTreeOptions={};$scope.siteMapAssociationList=[];var currentSiteMapRow=null;var rootType=NetBrain.MapLayout.Const.DeviceGroupType.Root.toString();var privateType=NetBrain.MapLayout.Const.DeviceGroupType.Private.toString();var sharedType=NetBrain.MapLayout.Const.DeviceGroupType.Shared.toString();var systemType=NetBrain.MapLayout.Const.DeviceGroupType.System.toString();var deviceGroupType=NetBrain.MapLayout.Const.DeviceGroupType;$scope.loading=!1;var needRunSelected=!1;var selectedSiteMapRowList=[];var selectedSearchSiteMapRowList=[];NetBrain.MapLayout.Const.showTip;var globalShowFailTip=NetBrain.MapLayout.Const.showFailTip;function showFailTip(msg){globalShowFailTip(msg,nbTipSrvc)}function closeDropdownTree(){var ids=_.map(angular.element(".nb-dropdown-tree-directive.treeview-container"),(function(ele){return ele.id}));_.each(ids,(function(id){angular.element("#"+id).css({display:"none"})}))}$scope.siteMapFilter=function(event,clear){if("clear"===clear||13===event.keyCode||27===event.keyCode){27===event.keyCode&&($scope.filterObj.siteMapFilterValue="");"clear"===clear&&($scope.filterObj.siteMapFilterValue="");$scope.siteMapGridApi.grid.refresh()}};function siteMapSingleFilter(renderableRows){var matcher=new RegExp($scope.filterObj.siteMapFilterValue,"i");renderableRows.forEach((function(row){var match=!1;["siteMapName"].forEach((function(field){row.entity[field].match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderableRows}function findTreeNode(nodeId,data){if(nodeId){var treeNode=null;var traverseTree=function myself(_nodeId,traverseNode){if(_nodeId===traverseNode.ID){treeNode=traverseNode;return!0}if(traverseNode&&traverseNode.children)for(var i=0;i<traverseNode.children.length;i++){var child=traverseNode.children[i];if(!0===myself(_nodeId,child)){treeNode=child;break}}return!1};var root=data[0];traverseTree(nodeId,root);null===treeNode&&2===data.length&&traverseTree(nodeId,root=data[1]);return treeNode}}function checkCasscadeSite(entity,isCheck){var node=_.find($scope.siteMapTreeDataCache,(function(item){return item.ID===entity.id}));if(node){!function checkChildrenSite(node,isCheck){_.each(node.children,(function(item){var entity=_.find($scope.siteMapData,(function(row){return row.id===item.ID}));entity&&setSiteMapRowSelected(entity,isCheck);checkChildrenSite(item,isCheck)}))}(node,isCheck);!function checkParentSite(node,isCheck){if(node.parent){var isAllCheck=!1;var isAllUnCheck=!1;var needSet=!1;var allChildrenIdList=_.pluck(node.parent.children,"ID");var trueIdListFolder=_.pluck(_.where($scope.siteMapData,{isCheck:!0,nodeType:"folder",parentId:node.parent.ID}),"id");var trueIdListNode=_.pluck(_.where($scope.siteMapData,{isCheck:!0,nodeType:"node",parentId:node.parent.ID}),"id");var trueCount=trueIdListFolder.concat(trueIdListNode).length;var hasIndeterminate=!1;for(var i=0;i<node.parent.children.length;i++){var child=node.parent.children[i];var checkBoxObj=element.find("[checkId="+child.ID+"]");if(checkBoxObj.length>0&&checkBoxObj[0].indeterminate){hasIndeterminate=!0;break}}if(allChildrenIdList.length===trueCount){isAllCheck=!0;needSet=!0}if(allChildrenIdList.length>0&&0===trueCount&&!1===hasIndeterminate){isAllUnCheck=!0;needSet=!0}!1===isCheck&&(needSet=!0);var chkObj=element.find("[checkId="+node.parent.ID+"]");isAllCheck||isAllUnCheck?chkObj.length>0?chkObj[0].indeterminate=!1:console.error():chkObj.length>0?chkObj[0].indeterminate=!0:console.error();if(needSet){var entity=_.find($scope.siteMapData,(function(row){return row.id===node.parent.ID}));entity&&setSiteMapRowSelected(entity,isCheck)}checkParentSite(node.parent,isCheck)}}(node,isCheck)}}function doLayoutStyleMenuStatus(){selectedSiteMapRowList.length>0||selectedSearchSiteMapRowList.length>0?$scope.filterObj.hasSelectedSiteMapRow=!0:$scope.filterObj.hasSelectedSiteMapRow=!1}function setSiteMapRowSelected(row,isCheck){if(isCheck){var selectedIndex=_.findIndex(selectedSiteMapRowList,{id:row.id});selectedIndex>=0&&selectedSiteMapRowList.splice(selectedIndex,1);selectedSiteMapRowList.push(row);row.isCheck=!0;needRunSelected=!1;$scope.siteMapGridApi.selection.selectRow(row);needRunSelected=!0}else{var deleteIndex=_.findIndex(selectedSiteMapRowList,{id:row.id});deleteIndex>=0&&selectedSiteMapRowList.splice(deleteIndex,1);row.isCheck=!1;needRunSelected=!1;$scope.siteMapGridApi.selection.unSelectRow(row);needRunSelected=!0}$scope.selectedSiteMapList=selectedSiteMapRowList}function addSiteMapRow(entity){var nodeLevel=entity.$$treeLevel;var index;if("folder"===entity.nodeType){if((index=_.findIndex(selectedSiteMapRowList,{id:entity.id}))<0){setSiteMapRowSelected(entity,!0);checkCasscadeSite(entity,!0)}if(entity.loaded&&(index=_.findIndex($scope.siteMapData,{id:entity.id}))>=0)for(var i=index+1;i<$scope.siteMapData.length;i++){var nodeRow=$scope.siteMapData[i];if(nodeRow.$$treeLevel<=nodeLevel)break;setSiteMapRowSelected(nodeRow,!0)}}else{setSiteMapRowSelected(entity,!0);checkCasscadeSite(entity,!0)}doLayoutStyleMenuStatus()}function deleteSiteMapRow(entity){var nodeLevel=entity.$$treeLevel;var index;if("folder"===entity.nodeType){if((index=_.findIndex(selectedSiteMapRowList,{id:entity.id}))>=0){setSiteMapRowSelected(entity,!1);checkCasscadeSite(entity,!1)}if((index=_.findIndex($scope.siteMapData,{id:entity.id}))>=0)for(var i=index+1;i<$scope.siteMapData.length;i++){var nodeRow=$scope.siteMapData[i];if(nodeRow.$$treeLevel<=nodeLevel)break;setSiteMapRowSelected(nodeRow,!1)}}else{setSiteMapRowSelected(entity,!1);checkCasscadeSite(entity,!1)}doLayoutStyleMenuStatus()}$scope.onRemoveLayoutStyleInSiteTreeNode=function(event,siteMapId,entity){consts.showSaving(nbTipSrvc);mapLayoutSrvc.deleteAssociationByDeviceGroupMapId([siteMapId]).then((function(result){if(result){consts.showSaved(nbTipSrvc);entity.layoutId="";entity.layoutName="";entity.associationId=""}else showFailTip(AssociationWording.ClearSiteMapAssociationInfoFailed)}))};$scope.onClickClearSiteMapAssociation=function(event){var selectedSiteMapList=[];var idList=[];if($scope.searchStatus){idList=_.pluck(selectedSearchSiteMapRowList,"siteMapId");selectedSiteMapList=selectedSearchSiteMapRowList}else{idList=_.pluck(selectedSiteMapRowList,"siteMapId");selectedSiteMapList=selectedSiteMapRowList}consts.showSaving(nbTipSrvc);mapLayoutSrvc.deleteAssociationByDeviceGroupMapId(idList).then((function(result){if(result){consts.showSaved(nbTipSrvc);for(var i=0;i<selectedSiteMapList.length;i++){var row=selectedSiteMapList[i];row.layoutId="";row.layoutName="";row.associationId=""}}else showFailTip(AssociationWording.ClearSiteMapAssociationInfoFailed)}))};$scope.onClickCheckAllForSiteMap=function(event){var isCheck=angular.element(event.target).is(":checked");for(var i=0;i<$scope.siteMapData.length;i++){var row=$scope.siteMapData[i];isCheck?addSiteMapRow(row):deleteSiteMapRow(row)}};$scope.onClickSiteMapGridRowCheck=function(event,entity){angular.element(event.target).is(":checked")?addSiteMapRow(entity):deleteSiteMapRow(entity)};$scope.onClickSiteMapGridLayoutStyleCell=function(event,row){if(angular.element(event.target).hasClass("icon_nb_tags_close_14"))$scope.onRemoveLayoutStyleInSiteTreeNode(event,row.entity.siteMapId,row.entity);else{setEditingFalse(!1);if(currentSiteMapRow){var prevNode=findTreeNode(currentSiteMapRow.entity.layoutId,$scope.siteMapLayoutTreeData);prevNode&&(prevNode.selected=!1)}row.entity.editing=!0;if(row.entity.layoutId){var treeNode=findTreeNode(row.entity.layoutId,$scope.siteMapLayoutTreeData);treeNode&&(treeNode.selected=!0)}currentSiteMapRow=row}};$scope.toggleRow=function(row,event){(function(row){var defer=$q.defer();var index=_.findIndex($scope.siteMapData,{id:row.entity.id});var nodeIndex=_.findIndex($scope.siteMapTreeDataCache,{ID:row.entity.id});if($scope.siteMapData.length>=index+1){if("virtual"===$scope.siteMapData[index+1].nodeType){$scope.siteMapData.splice(index+1,1);var currentEntity=$scope.siteMapData[index];var currentNode=$scope.siteMapTreeDataCache[nodeIndex];var qList=[mapLayoutSrvc.getSubSiteTree(currentEntity.siteMapId,currentNode),mapLayoutSrvc.getSiteMapAssociationList()];$q.all(qList).then((function(result){var siteTreeData=result[0];var siteMapAssociationList=result[1];currentEntity.loaded=!0;var needCheck=!1;var selectedItem=_.find(selectedSiteMapRowList,(function(item){return item.id===row.entity.id}));selectedItem&&selectedItem.isCheck&&(needCheck=!0);$scope.siteMapTreeDataCache=$scope.siteMapTreeDataCache.concat(siteTreeData.siteMapTreeDataCache);index++;var siteRowList=[];for(var i=0;i<siteTreeData.data.length;i++){var item=siteTreeData.data[i];var level=currentEntity.$$treeLevel;var siteRow=getSiteMapTreeRow(item,siteMapAssociationList,level+1,$scope.styleLayoutNameList);$scope.siteMapData.splice(index++,0,siteRow);if(!item.isLeaf){var virtualNode=getSiteMapTreeVirtualRow(level,item.ID);$scope.siteMapData.splice(index++,0,virtualNode)}needCheck&&siteRowList.push(siteRow)}$scope.siteMapAssociationList=siteMapAssociationList;$timeout((function(){for(var j=0;j<siteRowList.length;j++){setSiteMapRowSelected(siteRowList[j],!0)}}),0);defer.resolve(!0)}))}else defer.resolve(!0)}else defer.resolve(!0);return defer.promise})(row).then((function(){uiGridTreeBaseService.toggleRowTreeState($scope.siteMapGridApi.grid,row,event)}))};$scope.clearFilter=function(){$scope.searchStatus=!1;$scope.loadingSiteMap=!0;selectedSearchSiteMapRowList=[];selectedSiteMapRowList=[];$scope.siteMapSearchData=[];init(!0,!1)};$scope.doSiteMapDataFilter=function(event,clear){if("clear"===clear||13===event.keyCode||27===event.keyCode||8===event.keyCode||46===event.keyCode){27===event.keyCode&&($scope.filterObj.siteMapFilterValue="");"clear"===clear&&($scope.filterObj.siteMapFilterValue="");if(""===$scope.filterObj.siteMapFilterValue)$scope.clearFilter();else if(13===event.keyCode){$scope.searchStatus=!0;!function(key){$scope.loadingSiteMap=!0;mapLayoutSrvc.filterSiteMapData(key).then((function(data){var siteMapAssociationList=data.siteMapAssociationList;var rows=[];for(var i=0;i<data.searchResult.length;i++){var row=getSiteMapTreeRow(data.searchResult[i],siteMapAssociationList,0,$scope.styleLayoutNameList);rows.push(row)}$scope.siteMapAssociationList=siteMapAssociationList;$scope.siteMapSearchData=rows;$scope.loadingSiteMap=!1}))}($scope.filterObj.siteMapFilterValue)}}};function addSearchSiteMapRow(entity){var selectedIndex=_.findIndex(selectedSearchSiteMapRowList,{id:entity.id});selectedIndex>=0&&selectedSearchSiteMapRowList.splice(selectedIndex,1);selectedSearchSiteMapRowList.push(entity);entity.isCheck=!0;needRunSelected=!1;$scope.siteMapGridSearchApi.selection.selectRow(entity);needRunSelected=!0}function deleteSearchSiteMapRow(entity){var deleteIndex=_.findIndex(selectedSiteMapRowList,{id:entity.id});deleteIndex>=0&&selectedSiteMapRowList.splice(deleteIndex,1);entity.isCheck=!1;needRunSelected=!1;$scope.siteMapGridSearchApi.selection.selectRow(entity);needRunSelected=!0}$scope.onClickSearchCheckAllForSiteMap=function(event){var isCheck=angular.element(event.target).is(":checked");for(var i=0;i<$scope.siteMapSearchData.length;i++){var row=$scope.siteMapSearchData[i];isCheck?addSearchSiteMapRow(row):deleteSearchSiteMapRow(row)}doLayoutStyleMenuStatus()};$scope.onClickSiteMapGridRowCheckSearch=function(event,entity){angular.element(event.target).is(":checked")?addSearchSiteMapRow(entity):deleteSearchSiteMapRow(entity);doLayoutStyleMenuStatus()};function confirmDeviceGroupMapTreeCheck(entity,needRecheck){var idList=_.chain($scope.deviceGroupMapData).map((function(item){return item.deviceGroupMapIdList})).flatten().value();for(var i=0;i<idList.length;i++){var selectedNode=findTreeNode(idList[i],$scope.deviceGroupTreeData);selectedNode&&(selectedNode.selected=!1)}_.each(deviceGroupType,(function(dgId){var dgNode=findTreeNode(dgId.toString(),$scope.deviceGroupTreeData);if(dgNode){dgNode.__ivhTreeviewIndeterminate=!1;dgNode.selected=!1}}));var typeList=[];entity.deviceGroupMapIdList.length>0&&typeList.push(rootType.toString());if(needRecheck){for(var j=0;j<entity.deviceGroupMapIdList.length;j++){var node=findTreeNode(entity.deviceGroupMapIdList[j],$scope.deviceGroupTreeData);if(node){node.selected=!0;typeList.splice(0,0,node.Type.toString())}}_.each(_.uniq(typeList),(function(typeId){var typeNode=findTreeNode(typeId,$scope.deviceGroupTreeData);if(typeNode){var childrenIdList=_.map(typeNode.children,(function(typeItem){return typeItem.ID}));if("-1"===typeId){var selectedChildrenIdList=_.map(_.filter(typeNode.children,(function(typeItem){return typeItem.selected})),(function(typeItem){return typeItem.ID}));0===_.difference(childrenIdList,selectedChildrenIdList).length?typeNode.selected=!0:typeNode.__ivhTreeviewIndeterminate=!0}else{0===_.difference(childrenIdList,entity.deviceGroupMapIdList).length?typeNode.selected=!0:typeNode.__ivhTreeviewIndeterminate=!0}}}))}!function(entity){var idList=_.chain($scope.deviceGroupMapData).map((function(item){return item.deviceGroupMapIdList})).flatten().value();for(var i=0;i<idList.length;i++){var selectedNode=findTreeNode(idList[i],$scope.deviceGroupTreeData);selectedNode&&(selectedNode.disableCheckbox=!0)}if(entity.deviceGroupMapIdList)for(var j=0;j<entity.deviceGroupMapIdList.length;j++){var currentNode=findTreeNode(entity.deviceGroupMapIdList[j],$scope.deviceGroupTreeData);currentNode&&(currentNode.disableCheckbox=!1)}}(entity)}function confirmDeviceGroupMapLayoutTreeCheck(entity,needReSelect){var idList=_.chain($scope.deviceGroupMapData).map((function(item){return item.layoutId})).value();for(var i=0;i<idList.length;i++){var selectedNode=findTreeNode(idList[i],$scope.deviceGroupMapLayoutTreeData);selectedNode&&(selectedNode.selected=!1)}if(needReSelect){var node=findTreeNode(entity.layoutId,$scope.deviceGroupMapLayoutTreeData);node&&(node.selected=!0)}}function clearDisabledItemCheckBox(entity){for(var i=0;i<$scope.deviceGroupMapData.length;i++){var item=$scope.deviceGroupMapData[i];if(item.id!==entity.id)for(var j=0;j<item.deviceGroupMapIdList.length;j++){var deviceGroupMapNode=findTreeNode(item.deviceGroupMapIdList[j],$scope.deviceGroupTreeData);deviceGroupMapNode&&(deviceGroupMapNode.selected=!1)}}}function getDeivceGroupMapIdListByNodeId(nodeId){var result=[];var folderNode=findTreeNode(nodeId,$scope.deviceGroupTreeData);folderNode&&(nodeId===rootType?result=_.chain(folderNode.children).map((function(item){return item.children})).flatten().map((function(item){return item.ID})).value():nodeId===privateType||nodeId===systemType||nodeId===sharedType?result=_.chain(folderNode.children).map((function(item){return item.ID})).value():result.push(nodeId));return result}function saveDeviceGroupMapEntity(entity,needDeleteMapIdList){consts.showSaving(nbTipSrvc);var defer=$q.defer();var dgMapIdList=entity.deviceGroupMapIdList;mapLayoutSrvc.saveDeviceGroupMapAssociation(dgMapIdList,entity.layoutId,entity.layoutType,entity.rowId,needDeleteMapIdList).then((function(result){if(!0===result||"Args is empty"===result){consts.showSaved(nbTipSrvc);entity.id=entity.rowId;defer.resolve(!0)}else{showFailTip(AssociationWording.UpdateDeviceGroupMapAssociationInfoFailed);defer.resolve(!1)}}),(function(error){showFailTip(AssociationWording.UpdateDeviceGroupMapAssociationInfoFailed);defer.resolve(error)}));return defer.promise}function refreshDeviceGroupMapName(entity){var dgMapIdList=entity.deviceGroupMapIdList;var dgMapNameList=[];for(var i=0;i<dgMapIdList.length;i++){var dgNode=findTreeNode(dgMapIdList[i],$scope.deviceGroupTreeData);dgNode&&dgMapNameList.push(dgNode.Name)}entity.deviceGroupMapName=dgMapIdList.length>0?dgMapNameList.join(", "):"Select"}$scope.onClickAddDeviceGroupRow=function(){!function(){for(var i=0;i<$scope.deviceGroupMapData.length;i++){var entity=$scope.deviceGroupMapData[i];confirmDeviceGroupMapTreeCheck(entity,!1);confirmDeviceGroupMapLayoutTreeCheck(entity,!1)}}();var item={id:"-99",deviceGroupMapIdList:[],deviceGroupMapName:"Select",layoutId:"",layoutName:"Select",deviceGroupTreeOptions:{},layoutStyleTreeOptions:{}};item.rowId=utilitySrvc.format(new Date,"yyyyMMddhhmmssiii");item.id="-"+item.rowId;item.deviceGroupTreeOptions=_.clone(deviceGroupTreeOptions);item.deviceGroupTreeOptions.row=item;item.layoutStyleTreeOptions=_.clone(deviceGroupGridLayoutStyleTreeOptions);item.layoutStyleTreeOptions.row=item;$scope.deviceGroupMapData.push(item)};function setStatusDeviceGroupMapTreeNode(nodes){for(var i=0;i<nodes.length;i++){var node=nodes[i];node.selected=!1;node.children&&node.children.length>0&&setStatusDeviceGroupMapTreeNode(node.children)}}$scope.onDeleteDeviceGroupRow=function(event,entity){var opt={title:AssociationWording.DeleteDeviceGroupMapRowDialogTitle,buttons:[{id:NB_CONFIRM_CANCEL,label:AssociationWording.DeleteDeviceGroupMapRowDialogCancelButton},{id:NB_CONFIRM_YES,label:AssociationWording.DeleteDeviceGroupMapRowDialogOkButton}],message:AssociationWording.DeleteDeviceGroupMapRowDialogMessage};nbAlertSrvc.warning(opt).then((function(dialogResult){if(dialogResult===NB_CONFIRM_YES){consts.showSaving(nbTipSrvc);setStatusDeviceGroupMapTreeNode($scope.deviceGroupTreeData);setStatusDeviceGroupMapTreeNode($scope.deviceGroupMapLayoutTreeData);$scope.loadingDeviceGroupMap=!0;if(entity.id>0&&entity.deviceGroupMapIdList&&entity.deviceGroupMapIdList.length>0)mapLayoutSrvc.deleteAssociationByDeviceGroupMapId(entity.deviceGroupMapIdList).then((function(){var tempData=angular.copy($scope.deviceGroupMapData);$scope.deviceGroupMapData=[];var index=_.findIndex(tempData,{id:entity.id});index>=0&&tempData.splice(index,1);$timeout((function(){$scope.deviceGroupMapData=tempData;$scope.loadingDeviceGroupMap=!1}),0);consts.showSaved(nbTipSrvc)}),(function(){showFailTip(AssociationWording.DeleteDeviceGroupMapRowInfoFailed)}));else{var tempData=angular.copy($scope.deviceGroupMapData);$scope.deviceGroupMapData=[];var index=_.findIndex(tempData,{id:entity.id});index>=0&&tempData.splice(index,1);$timeout((function(){$scope.deviceGroupMapData=tempData;$scope.loadingDeviceGroupMap=!1}),0);consts.showSaved(nbTipSrvc)}}confirmDeviceGroupMapTreeCheck(entity,!1);confirmDeviceGroupMapLayoutTreeCheck(entity,!1)}))};!function(){$scope.associationSiteMapGridOptions={data:"siteMapData",multiSelect:!0,enableSelection:!1,modifierKeysToMultiSelect:!1,enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableColumnMenus:!1,keepLastSelected:!0,columnDefs:[{field:"isCheck",displayName:"",width:"30",cellTemplate:'<div class="ui-grid-cell-contents" style="padding-left: 3px;"><input type="checkbox" checkId="{{row.entity.id}}" ng-disabled="grid.appScope.showMatchedEmptyRow" ng-click="grid.appScope.onClickSiteMapGridRowCheck($event, row.entity);" ng-checked="row.entity.isCheck"/></div>'},{field:"siteMapName",displayName:AssociationWording.SiteGridColumn1Title,width:"500",cellTemplate:'<div class="ui-grid-cell-contents"><span style="cursor: pointer;width: 20px; height: 17px;" ng-click="grid.appScope.toggleRow(row, $event)"><i ng-class="{\'ui-grid-icon-minus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'expanded\', \'ui-grid-icon-plus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'collapsed\'}" ng-style="{\'margin-left\': grid.options.treeIndent * row.treeLevel + \'px\'}" style=" width: 10px;height: 10px;display: inline-block;">&nbsp;</i></span><span class="{{row.entity.siteIcon}}" width="16px" height="16px"></span><span ng-if="row.entity.nodeType !== \'folder\'" title="{{row.entity.siteMapName}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.siteMapFilterValue">{{row.entity.siteMapName}}</span><span ng-if="row.entity.nodeType === \'folder\'" title="{{row.entity.siteMapName}}" ng-bind-html="COL_FIELD">{{row.entity.siteMapName}}</span></div>'},{field:"layoutStyle",displayName:AssociationWording.SiteGridColumn2Title,width:"350",cellTemplate:'<div class="ui-grid-cell-contents" ng-click1="grid.appScope.onClickSiteMapGridLayoutStyleCell($event, row);"><span style="margin-left: 10px;" ng-show="row.entity.nodeType===\'folder\'"></span><div ng-show="row.entity.nodeType===\'node\'"><div ng-if="!row.entity.editing" class="tag-outer site-map-grid-cell-layout-name-outer" ng-click="grid.appScope.onClickSiteMapGridLayoutStyleCell($event, row);"><div class="tag-box"><span class="tag-msg site-map-grid-cell-layout-name-outer" title="{{row.entity.layoutName}}">{{row.entity.layoutName ? row.entity.layoutName : "Select"}}</span><span class="icon_nb_tags_close_14" ng-if="row.entity.layoutName != \'\'" title="Clear Association" ng-click="grid.appScope.onRemoveLayoutStyleInSiteTreeNode($event, row.entity.siteMapId, row.entity);"></span></div></div><span ng-if="false" ng-show="false" class="site-map-grid-cell-layout-name" ng-click="grid.appScope.onClickSiteMapGridLayoutStyleCell($event, row);">{{row.entity.layoutName ? row.entity.layoutName : "Select"}}</span><nb-dropdown-tree-directive ng-if="row.entity.editing" ng-show="row.entity.nodeType===\'node\'" class="at0-layout-dropdown-tree" tree-data="grid.appScope.siteMapLayoutTreeData" tree-options="row.entity.layoutStyleTreeOptions" atag="mapLayout:association:site:grid:layout:dropdownTree:{{row.entity.id}}"></nb-dropdown-tree-directive></div></div>'}],showTreeExpandNoChildren:!1,enableExpandAll:!0,flatEntityAccess:!1,fastWatch:!1,treeIndent:10,enableColumnResizing:!1,enableSorting:!1,onRegisterApi:function(gridApi){$scope.siteMapGridApi=gridApi;$scope.siteMapGridApi.selection.on.rowSelectionChanged($scope,(function(row){needRunSelected&&(row.isSelected?addSiteMapRow(row.entity):deleteSiteMapRow(row.entity))}));$scope.siteMapGridApi.grid.registerRowsProcessor(siteMapSingleFilter,200)}};$scope.siteGridLayoutStyleTreeOptions={expandToDepth:1,enableMultipleSelect:!1,labelAttribute:"name",idAttribute:"id",enableUnselect:!0,iconTemplate:function(node){return node.nodeType<100?'<div class="icon_nb_folder"></div>':'<div class="'+consts.getTemplateIconByType(node.templateType)+'"></div>'},nodeClickCallback:function(node,trvw){var isSelected=trvw.isSelected(node);node.selected=!1;if(!isSelected||node.nodeType!==nodeTypeEnum.publicTplEntity&&node.nodeType!==nodeTypeEnum.sampleTplEntity){node.selected=!1;var entity1=trvw.opts().row;var layoutNode=findTreeNode(entity1.layoutId,$scope.siteMapLayoutTreeData);if(layoutNode){layoutNode.selected=!0;entity1.layoutName=layoutNode.name}}else{closeDropdownTree();node.selected=!1;$scope.loadingSiteMap=!0;(function(node,entity){var defer=$q.defer();var list=[];list.push({associationId:entity.associationId,layoutId:node.id,layoutType:node.type,mapId:entity.siteMapId,isCasscade:!1});consts.showSaving(nbTipSrvc);mapLayoutSrvc.saveSiteMapAssociation(list).then((function(result){if(!0===result||"Args is empty"===result){consts.showSaved(nbTipSrvc);entity.layoutId=node.id;entity.layoutName=node.name;entity.associationId="";defer.resolve(!0)}else{showFailTip(AssociationWording.UpdateSiteMapAssociationInfoFailed);defer.resolve(!1)}}),(function(error){showFailTip(AssociationWording.UpdateSiteMapAssociationInfoFailed);defer.resolve(error)}));return defer.promise})(node,trvw.opts().row).then((function(){$scope.loadingSiteMap=!1}))}}};$scope.siteMapLayoutStyleTreeOptions={expandToDepth:1,enableMultipleSelect:!1,labelAttribute:"name",idAttribute:"id",enableUnselect:!0,iconTemplate:function(node){return node.nodeType<100?'<div class="icon_nb_folder"></div>':'<div class="'+consts.getTemplateIconByType(node.templateType)+'"></div>'},beforeShowDropdownCallback:function(){var defer=$q.defer();mapLayoutSrvc.loadLayoutStyleAllTreeNode2().then((function(result){$scope.siteMapLayoutTreeData=angular.copy(result);defer.resolve()}));return defer.promise},nodeClickCallback:function(node,trvw){var isSelected=trvw.isSelected(node);node.selected=!1;if(!isSelected||node.nodeType!==nodeTypeEnum.publicTplEntity&&node.nodeType!==nodeTypeEnum.sampleTplEntity)currentSiteMapRow=null;else{closeDropdownTree();node.selected=!1;$scope.loadingSiteMap=!0;$scope.searchStatus?function(node){var defer=$q.defer();var list=[];for(var i=0;i<selectedSearchSiteMapRowList.length;i++){var item=selectedSearchSiteMapRowList[i];"virtual"!==item.nodeType&&list.push({associationId:item.associationId,layoutId:node.id,layoutType:node.type,mapId:item.siteMapId,isCasscade:!1})}consts.showSaving(nbTipSrvc);mapLayoutSrvc.saveSiteMapAssociation(list).then((function(result){if(!0===result||"Args is empty"===result){consts.showSaved(nbTipSrvc);for(var j=0;j<selectedSearchSiteMapRowList.length;j++){var row=selectedSearchSiteMapRowList[j];row.layoutId=node.id;row.layoutName=node.name;row.associationId=""}defer.resolve(!0)}else{showFailTip(AssociationWording.UpdateSiteMapAssociationInfoFailed);defer.resolve(!1)}}),(function(error){showFailTip(AssociationWording.UpdateSiteMapAssociationInfoFailed);defer.resolve(error)}));return defer.promise}(node).then((function(){$scope.loadingSiteMap=!1})):function(node){var defer=$q.defer();var list=[];for(var i=0;i<selectedSiteMapRowList.length;i++){var item=selectedSiteMapRowList[i];"virtual"!==item.nodeType&&list.push({associationId:item.associationId,layoutId:node.id,layoutType:node.type,mapId:item.siteMapId,isCasscade:!item.loaded&&"folder"===item.nodeType})}consts.showSaving(nbTipSrvc);mapLayoutSrvc.saveSiteMapAssociation(list).then((function(result){if(!0===result||"Args is empty"===result){consts.showSaved(nbTipSrvc);for(var j=0;j<selectedSiteMapRowList.length;j++){var row=selectedSiteMapRowList[j];row.layoutId=node.id;row.layoutName=node.name;row.associationId=""}defer.resolve(!0)}else{showFailTip(AssociationWording.UpdateSiteMapAssociationInfoFailed);defer.resolve(!1)}}),(function(error){showFailTip(AssociationWording.UpdateSiteMapAssociationInfoFailed);defer.resolve(error)}));return defer.promise}(node).then((function(){$scope.loadingSiteMap=!1}))}}};$scope.associationSiteMapGridSearchOptions={data:"siteMapSearchData",multiSelect:!1,enableSelection:!1,modifierKeysToMultiSelect:!1,enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableColumnMenus:!1,keepLastSelected:!0,columnDefs:[{field:"isCheck",displayName:"",width:"30",cellTemplate:'<div class="ui-grid-cell-contents" style="padding-left: 3px;"><input type="checkbox" ng-disabled="grid.appScope.showMatchedEmptyRow" ng-click="grid.appScope.onClickSiteMapGridRowCheckSearch($event, row.entity);" ng-checked="row.entity.isCheck"/></div>'},{field:"siteMapName",displayName:AssociationWording.SiteGridColumn1Title,width:"500",cellTemplate:'<div class="ui-grid-cell-contents"><span style="cursor: pointer;width: 20px; height: 17px;" ng-click="grid.appScope.toggleRow(row, $event)"><i ng-class="{\'ui-grid-icon-minus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'expanded\', \'ui-grid-icon-plus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'collapsed\'}" ng-style="{\'margin-left\': grid.options.treeIndent * row.treeLevel + \'px\'}" style=" width: 10px;height: 10px;display: inline-block;">&nbsp;</i></span><span class="{{row.entity.siteIcon}}" width="16px" height="16px"></span><span ng-if="row.entity.nodeType !== \'folder\'" title="{{row.entity.siteMapName}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.siteMapFilterValue">{{row.entity.siteMapName}}</span><span ng-if="row.entity.nodeType === \'folder\'" title="{{row.entity.siteMapName}}" ng-bind-html="COL_FIELD">{{row.entity.siteMapName}}</span></div>'},{field:"layoutStyle",displayName:AssociationWording.SiteGridColumn2Title,width:"350",cellTemplate:'<div class="ui-grid-cell-contents" ng-click1="grid.appScope.onClickSiteMapGridLayoutStyleCell($event, row);"><span style="margin-left: 10px;" ng-show="row.entity.nodeType===\'folder\'"></span><div ng-show="row.entity.nodeType===\'node\'"><div ng-if="!row.entity.editing" class="tag-outer site-map-grid-cell-layout-name-outer" ng-click="grid.appScope.onClickSiteMapGridLayoutStyleCell($event, row);"><div class="tag-box"><span class="tag-msg site-map-grid-cell-layout-name-outer" title="{{row.entity.layoutName}}">{{row.entity.layoutName ? row.entity.layoutName : "Select"}}</span><span class="icon_nb_tags_close_14" ng-if="row.entity.layoutName != \'\'" title="Clear Association" ng-click="grid.appScope.onRemoveLayoutStyleInSiteTreeNode($event, row.entity.siteMapId, row.entity);"></span></div></div><span ng-if="false" ng-show="false" class="site-map-grid-cell-layout-name" ng-click="grid.appScope.onClickSiteMapGridLayoutStyleCell($event, row);">{{row.entity.layoutName ? row.entity.layoutName : "Select"}}</span><nb-dropdown-tree-directive ng-if="row.entity.editing" ng-show="row.entity.nodeType===\'node\'" class="at0-layout-dropdown-tree" tree-data="grid.appScope.siteMapLayoutTreeData" tree-options="row.entity.layoutStyleTreeOptions" atag="mapLayout:association:site:grid:layout:dropdownTree:{{row.entity.id}}"></nb-dropdown-tree-directive></div></div>'}],showTreeExpandNoChildren:!1,enableExpandAll:!0,flatEntityAccess:!1,fastWatch:!1,treeIndent:10,enableColumnResizing:!1,enableSorting:!1,onRegisterApi:function(gridApi){$scope.siteMapGridSearchApi=gridApi;$scope.siteMapGridSearchApi.selection.on.rowSelectionChanged($scope,(function(row){row.isSelected}));$scope.siteMapGridSearchApi.grid.registerRowsProcessor(siteMapSingleFilter,200)}};$scope.associationDeviceGroupMapGridOptions={data:"deviceGroupMapData",multiSelect:!0,enableSelection:!0,modifierKeysToMultiSelect:!1,enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableColumnMenus:!1,keepLastSelected:!0,columnDefs:[{field:"deviceGroupMap",displayName:AssociationWording.DeviceGroupGridColumn1Title,width:"530",cellTemplate:'<div class="ui-grid-cell-contents"><div><nb-dropdown-tree-directive class="at0-layout-dropdown-tree max-device-group-drop" placeholder="{{row.entity.deviceGroupMapName}}" tree-data="grid.appScope.deviceGroupTreeData" tree-options="row.entity.deviceGroupTreeOptions" atag="mapLayout:association:devicegroup:grid:deivcegroup:dropdownTree:{{row.entity.id}}"></nb-dropdown-tree-directive></div></div>'},{field:"layoutStyle",displayName:AssociationWording.DeviceGroupGridColumn2Title,width:"350",cellTemplate:'<div class="ui-grid-cell-contents"><div><nb-dropdown-tree-directive class="at0-layout-dropdown-tree max-layout-drop" placeholder="{{row.entity.layoutName}}" tree-data="grid.appScope.deviceGroupMapLayoutTreeData" tree-options="row.entity.layoutStyleTreeOptions" atag="mapLayout:association:devicegroup:grid:layoutStyle:dropdownTree:{{row.entity.id}}"></nb-dropdown-tree-directive></div><span class="icon_nb_delete_blue_12" ng-click="grid.appScope.onDeleteDeviceGroupRow($event, row.entity)" atag="mapLayout:association:devicegroup:grid:deleteBtn:{{row.entity.id}}"></span></div>'}],showTreeExpandNoChildren:!1,enableExpandAll:!0,flatEntityAccess:!1,fastWatch:!1,treeIndent:10,enableColumnResizing:!1,enableSorting:!1,onRegisterApi:function(gridApi){$scope.deviceGroupMapGridApi=gridApi;$scope.deviceGroupMapGridApi.selection.on.rowSelectionChanged($scope,(function(row){row.isSelected}))}};function findDeviceGroupDataEntity(row){var id=row.id;var index=_.findIndex($scope.deviceGroupMapData,{id:id});var entity=null;index>=0&&(entity=$scope.deviceGroupMapData[index]);return entity}deviceGroupTreeOptions={expandToDepth:3,enableMultipleSelect:!0,enableSetNodeTitle:!0,labelAttribute:"Name",idAttribute:"ID",needWatchPlaceHolder:!0,iconTemplate:function(node){return"-1"===node.ID||"1"===node.ID||"0"===node.ID||"2"===node.ID?'<div class="icon_nb_folder"></div>':'<div class="icon_nb_tree_devicegroup"></div>'},beforeShowDropdownCallback:function(options){var defer=$q.defer();confirmDeviceGroupMapTreeCheck(options.row,!0);defer.resolve();return defer.promise},nodeClickCallback:function(node,trvw){var defer=$q.defer();if(!0===node.disableCheckbox){node.selected=!1;clearDisabledItemCheckBox(trvw.opts().row);return $q.resolve(!0)}if(trvw.isSelected(node)){$scope.loadingDeviceGroupMap=!0;(function(node,entity){var deviceGroupMapIdList=getDeivceGroupMapIdListByNodeId(node.ID);var newDeviceGroupMapIdList=[];for(var i=0;i<deviceGroupMapIdList.length;i++){var dgMapId=deviceGroupMapIdList[i];var dgMapNode=findTreeNode(dgMapId,$scope.deviceGroupTreeData);dgMapNode&&(dgMapNode.disableCheckbox?dgMapNode.selected=!1:newDeviceGroupMapIdList.push(dgMapId))}0===newDeviceGroupMapIdList.length&&(node.selected=!1);var mergeIdList=newDeviceGroupMapIdList.concat(entity.deviceGroupMapIdList?entity.deviceGroupMapIdList:[]);entity.deviceGroupMapIdList=_.uniq(mergeIdList);refreshDeviceGroupMapName(entity);if(entity.layoutId)return saveDeviceGroupMapEntity(entity);return $q.resolve()})(node,findDeviceGroupDataEntity(trvw.opts().row)).then((function(){$scope.loadingDeviceGroupMap=!1;clearDisabledItemCheckBox(trvw.opts().row);defer.resolve()}),(function(err){console.error(err);$scope.loadingDeviceGroupMap=!1;clearDisabledItemCheckBox(trvw.opts().row);defer.resolve()}))}else{$scope.loadingDeviceGroupMap=!0;(function(node,entity){var deviceGroupMapIdList=getDeivceGroupMapIdListByNodeId(node.ID);entity.deviceGroupMapIdList=_.difference(entity.deviceGroupMapIdList,deviceGroupMapIdList);refreshDeviceGroupMapName(entity);if(entity.layoutId){return saveDeviceGroupMapEntity(entity,deviceGroupMapIdList)}return $q.resolve(!0)})(node,findDeviceGroupDataEntity(trvw.opts().row)).then((function(){confirmDeviceGroupMapTreeCheck(trvw.opts().row,!0);$scope.loadingDeviceGroupMap=!1;clearDisabledItemCheckBox(trvw.opts().row);defer.resolve()}),(function(err){console.error(err);$scope.loadingDeviceGroupMap=!1;clearDisabledItemCheckBox(trvw.opts().row);defer.resolve()}))}return defer.promise}};deviceGroupGridLayoutStyleTreeOptions={expandToDepth:1,enableMultipleSelect:!1,labelAttribute:"name",idAttribute:"id",enableUnselect:!0,iconTemplate:function(node){return node.nodeType<100?'<div class="icon_nb_folder"></div>':'<div class="'+consts.getTemplateIconByType(node.templateType)+'"></div>'},beforeShowDropdownCallback:function(options){var defer=$q.defer();confirmDeviceGroupMapLayoutTreeCheck(options.row,!0);defer.resolve();return defer.promise},nodeClickCallback:function(node,trvw){if(!trvw.isSelected(node)||node.nodeType!==nodeTypeEnum.publicTplEntity&&node.nodeType!==nodeTypeEnum.sampleTplEntity){node.selected=!1;var entity2=findDeviceGroupDataEntity(trvw.opts().row);var layoutNode=findTreeNode(entity2.layoutId,$scope.deviceGroupMapLayoutTreeData);if(layoutNode){layoutNode.selected=!0;entity2.layoutName=layoutNode.name}}else{$scope.loadingDeviceGroupMap=!0;(function(node,entity){entity.layoutId=node.id;entity.layoutType=node.type;entity.layoutName=node.name;if(entity.deviceGroupMapIdList.length>0)return saveDeviceGroupMapEntity(entity);return $q.resolve()})(node,findDeviceGroupDataEntity(trvw.opts().row)).then((function(){$scope.loadingDeviceGroupMap=!1;closeDropdownTree()}),(function(err){console.error(err);$scope.loadingDeviceGroupMap=!1}))}}}}();var layoutStyleTreeOptionsTpl=$scope.siteGridLayoutStyleTreeOptions;function getSiteMapTreeVirtualRow(level,parentId){return{id:NgUtil.getUniqueStr(),isCheck:!1,children:[],nodeType:"virtual",layoutId:"",layoutName:"",siteMapId:"",siteMapName:"virtual",siteIcon:"leaf_site_icon",layoutStyleTreeOptions:_.clone(layoutStyleTreeOptionsTpl),$$treeLevel:level+1+1,parentId:parentId}}function getSiteMapTreeRow(node,siteMapAssociationList,level,styleLayoutNameList){var layoutIndex=_.findIndex(siteMapAssociationList,{mapId:node.ID});var layoutId="";var layoutName="";var associationId="";if(layoutIndex>=0){layoutId=siteMapAssociationList[layoutIndex].layoutId;layoutName=(layoutName=siteMapAssociationList[layoutIndex].layoutName)||(styleLayoutNameList&&styleLayoutNameList[layoutId]?styleLayoutNameList[layoutId]:layoutName);associationId=siteMapAssociationList[layoutIndex].id}var row={id:node.ID,isCheck:!1,children:[],nodeType:node.isLeaf?"node":"folder",associationId:associationId,layoutId:layoutId,layoutName:layoutName,siteMapId:node.ID,siteMapName:node.name,siteIcon:node.siteIcon,loaded:node.loaded,layoutStyleTreeOptions:_.clone(layoutStyleTreeOptionsTpl),$$treeLevel:level,parentId:node.parentId};row.layoutStyleTreeOptions.row=row;return row}function initSiteMapGrid(siteMapTreeData,siteMapAssociationList,styleLayoutNameList){var rows=[];!function convertSiteMapToRow(rows,node,siteMapAssociationList,level,styleLayoutNameList){var row=getSiteMapTreeRow(node,siteMapAssociationList,level,styleLayoutNameList);rows.push(row);for(var i=0;i<node.children.length;i++){var item=node.children[i];if(item.isLeaf){var itemRow=getSiteMapTreeRow(item,siteMapAssociationList,level+1,styleLayoutNameList);rows.push(itemRow)}else{convertSiteMapToRow(rows,item,siteMapAssociationList,level+1,styleLayoutNameList);if(0===item.children.length){var virtualNode=getSiteMapTreeVirtualRow(level,item.ID);rows.push(virtualNode)}}}}(rows,siteMapTreeData,siteMapAssociationList,0,styleLayoutNameList);return rows}function init(refreshSite,refreshDG){$scope.loading=!0;var qList=[mapLayoutSrvc.loadLayoutStyleAllTreeNode2(),mapLayoutSrvc.getAssociationList()];$q.all(qList).then((function(result){$scope.siteMapLayoutTreeData=angular.copy(result[0]);$scope.deviceGroupMapLayoutTreeData=angular.copy(result[0]);var deviceGroupMapAssociationList=result[1].dgMapAssociationList;var siteMapAssociationList=result[1].siteMapAssociationList;if(refreshSite){$scope.loadingSiteMap=!0;mapLayoutSrvc.loadSiteMapTree({}).then((function(siteMapTreeResult){var siteMapTreeDataCache=siteMapTreeResult.siteMapTreeDataCache;var siteMapTreeData=siteMapTreeResult.data;$scope.siteMapData=initSiteMapGrid(siteMapTreeData,siteMapAssociationList,[]);$scope.siteMapAssociationList=siteMapAssociationList;$scope.siteMapTreeDataCache=siteMapTreeDataCache;$scope.loadingSiteMap=!1}))}if(refreshDG){$scope.loadingDeviceGroupMap=!0;$scope.deviceGroupMapData=[];mapLayoutSrvc.initDeviceGroupTreeData().then((function(dgTreeResult){$scope.deviceGroupTreeData=dgTreeResult;$scope.deviceGroupMapData=function(deviceGroupMapAssociationList){return _.chain(deviceGroupMapAssociationList).groupBy("rowId").map((function(items,rowId){var dgMapIdList=[];var dgMapNameList=[];for(var i=0;i<items.length;i++){var dgNode=findTreeNode(items[i].mapId,$scope.deviceGroupTreeData);if(dgNode){dgMapIdList.push(dgNode.ID);dgMapNameList.push(dgNode.Name)}else dgMapIdList.push(items[i].mapId)}var dgMapName=dgMapNameList.join(", ");var layoutId=items[0].layoutId;var layoutNode=findTreeNode(layoutId,$scope.deviceGroupMapLayoutTreeData);var layoutName="Select";layoutNode&&(layoutName=layoutNode.name);var row={id:items[0].rowId,deviceGroupMapIdList:dgMapIdList,deviceGroupMapName:dgMapName||"Select",layoutId:layoutId,layoutName:layoutName,rowId:items[0].rowId,deviceGroupTreeOptions:_.clone(deviceGroupTreeOptions),layoutStyleTreeOptions:_.clone(deviceGroupGridLayoutStyleTreeOptions)};row.deviceGroupTreeOptions.row=row;row.layoutStyleTreeOptions.row=row;return row})).value()}(deviceGroupMapAssociationList);$scope.loadingDeviceGroupMap=!1}))}}))}$scope.onAssociationPaneRefresh=function(){selectedSiteMapRowList=[];$scope.siteMapData=[];$scope.deviceGroupMapData=[];$timeout((function(){init(!0,!0)}),500)};init(!0,!0);function setEditingFalse(trigger){var need=!1;var data=$scope.siteMapData;$scope.searchStatus&&(data=$scope.siteMapSearchData);_.map(data,(function(item){if(item.editing){item.editing=!1;need=!0}}));if(need&&trigger)try{$scope.$digest()}catch(e){console.error("onClickDocument error",event)}}function onClickDocument(event){if(!(angular.element(event.target).hasClass("ivh-node-row")&&angular.element(event.target).find(".icon_nb_folder").length>0||angular.element(event.target).hasClass("ivh-treeview-node-label")&&angular.element(event.target).prev().find(".icon_nb_folder").length>0||angular.element(event.target).hasClass("site-map-grid-cell-layout-name")||angular.element(event.target).hasClass("site-map-grid-cell-layout-name-outer")||angular.element(event.target).hasClass("icon_nb_folder"))){setEditingFalse(!0);if(currentSiteMapRow){var prevNode=findTreeNode(currentSiteMapRow.entity.layoutId,$scope.siteMapLayoutTreeData);prevNode&&(prevNode.selected=!1);currentSiteMapRow=null}}}angular.element(document).on("click",onClickDocument);$scope.$on("$destroy",(function(){angular.element(document).off("click",onClickDocument)}))}}(NetBrain);!function(NetBrain){angular.module("nb.qmap").directive("nbMapTemplateLayoutStyleDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapTemplateLayoutStyleDirective.html",scope:{associateTags:"=",tagList:"="},controller:Controller,replace:!0}}]);Controller.$inject=["$scope","$element","$attrs","$timeout","$rootScope","$q","$document","nb.common.nbAlertSrvc","nb.ng.nbValidationSrvc","ivhTreeviewMgr","nb.ng.userSrvc","nb.common.nbTipSrvc","nb.qmap.mapManagerSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","$compile","$uibModal","nb.qmap.httpMapLayoutSrvc"];function Controller($scope,element,attr,$timeout,$rootScope,$q,$document,nbAlertSrvc,nbValidationSrvc,ivhTreeviewMgr,userSrvc,nbTipSrvc,mapManagerSrvc,mapContextMenuManager,updateMapSrvc,$compile,$uibModal,httpMapLayoutSrvc){var LayoutStyleWording=NetBrain.MapLayout.Const.Wording.LayoutStyle;var consts=NetBrain.MapLayout.Const;var ShowRightEnum={None:0,LayoutStyle:1,SampleMap:2};$scope.showRight=ShowRightEnum.None;$scope.mapLayoutTreeData=[];var nodeTypeEnum=NetBrain.MapLayout.Const.NodeTypeEnum;var getNodeType=NetBrain.MapLayout.Const.getNodeType;var getTemplateType=NetBrain.MapLayout.Const.getTemplateType;var publicLS={};var sampleLS={};var editingNode=null;var currentSelectedNode=null;var layoutRootMenu=[{template:LayoutStyleWording.MenuNewLayoutStyle,action:function(node){onClickLayoutStyleAdd(node)}},{template:LayoutStyleWording.MenuNewFolder,action:function(node){onClickFolderAdd(node)}}];var layoutStyleMenu=[{template:LayoutStyleWording.MenuRename,action:function(node){onClickEntityRename(node)}},{template:LayoutStyleWording.MenuMoveTo,action:function(node){onClickEntityMoveTo(node)}},{template:LayoutStyleWording.MenuDelete,action:function(node){onClickEntityDelete(node)}}];var layoutFolderMenu=[{template:LayoutStyleWording.MenuNewLayoutStyle,action:function(node){onClickLayoutStyleAdd(node)}},{template:LayoutStyleWording.MenuNewFolder,action:function(node){onClickFolderAdd(node)}},{template:LayoutStyleWording.MenuRename,action:function(node){onClickFolderRename(node)}},{template:LayoutStyleWording.MenuMoveTo,action:function(node){onClickFolderMoveTo(node)}},{template:LayoutStyleWording.MenuDelete,action:function(node){onClickFolderDelete(node)}}];var sampleRootMenu=[{template:LayoutStyleWording.MenuNewFolder,action:function(node){onClickFolderAdd(node)}}];var sampleMenu=[{template:LayoutStyleWording.MenuRename,action:function(node){onClickEntityRename(node)}},{template:LayoutStyleWording.MenuMoveTo,action:function(node){onClickEntityMoveTo(node)}},{template:LayoutStyleWording.MenuDelete,action:function(node){onClickEntityDelete(node)}}];var sampleFolderMenu=[{template:LayoutStyleWording.MenuNewFolder,action:function(node){onClickFolderAdd(node)}},{template:LayoutStyleWording.MenuRename,action:function(node){onClickFolderRename(node)}},{template:LayoutStyleWording.MenuMoveTo,action:function(node){onClickFolderMoveTo(node)}},{template:LayoutStyleWording.MenuDelete,action:function(node){onClickFolderDelete(node)}}];var MapLayoutType=NetBrain.MapLayout.Const.MapLayoutType;var MapLayoutDirection=NetBrain.MapLayout.Const.MapLayoutDirection;function initCurrentSelectedNode(){if(currentSelectedNode){currentSelectedNode.selected=!1;currentSelectedNode=null}}function init1(){initCurrentSelectedNode();$scope.mapLayoutTreeData=[];$scope.isLoading=!0;httpMapLayoutSrvc.getRootFolderList().then((function(result){var qList=[];for(var i=0;i<result.length;i++){var node=result[i];node.ID=node.id;node.nodeType=getNodeType(node);node.children=[];node.editable=!1;node.selected=!1;node.expanded=!1;if(node.nodeType===nodeTypeEnum.publicTplRoot){publicLS=node;node.selected=!0;node.expanded=!0;currentSelectedNode=node;qList.push(fetchChildNode(node,null,!1,LayoutStyleWording.NoneSourceFolderId))}if(node.nodeType===nodeTypeEnum.sampleTplRoot){sampleLS=node;qList.push(fetchChildNode(node,null,!1,LayoutStyleWording.NoneSourceFolderId))}$scope.mapLayoutTreeData.push(node)}$q.all(qList).then((function(){$scope.isLoading=!1}))}));initEntity()}$scope.onLayoutTreeRefresh=function(){init1();$scope.showRight=ShowRightEnum.None};$scope.ivhTreeMapLayoutTreeOptions={defaultSelectedState:!1,validate:!0,expandToDepth:1,labelAttribute:"name",idAttribute:"ID",childrenAttribute:"children",expandedAttribute:"expanded",selectedAttribute:"selected",editableAttribute:"editable",enableMultipleSelect:!1,enableLabelExpand:!1,iconTemplate:function(node){return node.nodeType<100?'<div class="icon_nb_folder"></div>':'<div class="'+consts.getTemplateIconByType(node.templateType)+'"></div>'},nodeClickCallback:function(node,trvw){_nodeClickCallback(node).then((function(){currentSelectedNode=node}))},enableNodeDropdown:{isDisplay:function(node){node.editable;return!0},dropdownItems:function(node){var menu=[];var nt=getNodeType(node);nt===nodeTypeEnum.publicTplRoot?menu=layoutRootMenu:nt===nodeTypeEnum.publicTplFolder?menu=layoutFolderMenu:nt===nodeTypeEnum.publicTplEntity?menu=layoutStyleMenu:nt===nodeTypeEnum.sampleTplRoot?menu=sampleRootMenu:nt===nodeTypeEnum.sampleTplFolder?menu=sampleFolderMenu:nt===nodeTypeEnum.sampleTplEntity&&(menu=sampleMenu);return menu}},editableCallback:function(node,trvw,text){return doneEditing(node,text)},lazyLoadingAttribute:function(node){var canLazy=!1;var nt=getNodeType(node);nt!==nodeTypeEnum.publicTplRoot&&nt!==nodeTypeEnum.publicTplFolder||(canLazy=!0);nt!==nodeTypeEnum.sampleTplRoot&&nt!==nodeTypeEnum.sampleTplFolder||(canLazy=!0);return canLazy},lazyLoadingCallback:function(node,trvw){return fetchChildNode(node,trvw,!1,LayoutStyleWording.NoneSourceFolderId)}};function fetchChildNode(curNode,trvw,onlyFolder,sourceFolderId){var defer=$q.defer();if(curNode.loaded){defer.resolve();return defer.promise}httpMapLayoutSrvc.getSubFoldersAndLayoutsByParentId(curNode.ID,curNode.folderType).then((function(result){var folderArray=result.layoutFolders;for(var i=0;i<folderArray.length;i++){var fNode=folderArray[i];if(fNode.id!==sourceFolderId){fNode.ID=fNode.id;fNode.nodeType=getNodeType(fNode);fNode.children=[];fNode.editable=!1;fNode.selected=!1;fNode.expanded=!1;curNode.children.push(fNode)}}if(!onlyFolder){var layoutArray=result.basedLayoutStyles;for(var j=0;j<layoutArray.length;j++){var lNode=layoutArray[j];lNode.ID=lNode.id;lNode.nodeType=getNodeType(lNode);lNode.templateType=consts.getTemplateType(lNode);lNode.children=[];lNode.editable=!1;lNode.selected=!1;curNode.children.push(lNode)}var sampleArray=result.sampleMapLayOutStyles;for(var k=0;k<sampleArray.length;k++){var sNode=sampleArray[k];sNode.ID=sNode.id;sNode.nodeType=getNodeType(sNode);sNode.templateType=consts.getTemplateType(sNode);sNode.children=[];sNode.editable=!1;sNode.selected=!1;curNode.children.push(sNode)}}curNode.loaded=!0;defer.resolve()}));return defer.promise}function findParent(nodeId,nodeType){if(nodeId){var parentNode=null;var root;nodeType===nodeTypeEnum.publicTplFolder||nodeType===nodeTypeEnum.publicTplEntity?root=publicLS:nodeType!==nodeTypeEnum.sampleTplFolder&&nodeType!==nodeTypeEnum.sampleTplEntity||(root=sampleLS);root&&function myself(_nodeId,traverseNode){if(_nodeId===traverseNode.ID)return!0;if(!traverseNode)return!1;angular.forEach(traverseNode.children,(function(child){!0===myself(_nodeId,child)&&(parentNode=traverseNode);return!1}));return!1}(nodeId,root);return parentNode}}function onClickEntityRename(node){if(node){resetEditingNode();(editingNode={}).currentNode=node;editingNode.oldName=node.name;editingNode.isNew=!1;editingNode.parentNode=findParent(node.ID,getNodeType(node));node.editable=!0;$timeout((function(){}))}}function onClickEntityMoveTo(node){if(node){var fileId=node.ID;var nodeType=getNodeType(node);$uibModal.open({templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutMoveToView.html",controller:"nb.qmap.nbMapLayoutMoveToCtrl",backdrop:"static",windowClass:"map-layout-move-to-tree-dialog",size:"sm",resolve:{settings:{moveNodeType:nodeType,nodeTypeEnum:nodeTypeEnum,getNodeType:getNodeType,fetchChildNode:fetchChildNode,treeNodeFetch:treeNodeFetch,doneEditing:doneEditing,isNameValid:isNameValid,sourceFolderId:fileId,getNodeTypeForAddFolder:getNodeTypeForAddFolder,addFolderBeforeEntity:addFolderBeforeEntity,mode:"moveto"}}}).result.then((function(resolve){var destFolder=resolve.destFolder;var toFolderId=destFolder.ID;var test={name:node.name,parent:{id:destFolder.ID,folderType:destFolder.folderType}};if(node.parentFolder.id===toFolderId){var optSelf={message:LayoutStyleWording.EntityMoveToSelfDestinationErrorMessage};nbAlertSrvc.warning(optSelf)}else{var duplicateNameFetch=httpMapLayoutSrvc.hasDuplicateName;var moveToFetch=httpMapLayoutSrvc.layoutMoveTo;if(node.type===MapLayoutType.sampleMap){duplicateNameFetch=httpMapLayoutSrvc.sampleMapHasDuplicateName;moveToFetch=httpMapLayoutSrvc.sampleMapMoveTo}duplicateNameFetch(test).then((function(result){if(result){var dupOpt={message:LayoutStyleWording.EntityMoveToHasDuplicateNameMessage};nbAlertSrvc.confirm(dupOpt).then((function(){moveToFetch([fileId],toFolderId).then((function(){init1();$scope.showRight=ShowRightEnum.None}),(function(err){var errOpt={message:LayoutStyleWording.EntityMoveToHasDuplicateNameFailedTip};nbAlertSrvc.warning(errOpt);console.log(err)}))}))}else moveToFetch([fileId],toFolderId).then((function(){init1();$scope.showRight=ShowRightEnum.None}))}))}}),(function(reject){console.warn(reject)}))}}function onClickEntityDelete(node){if(node){resetEditingNode();var dialogOptions={message:LayoutStyleWording.EntityDeleteMessage};var deleteFetch=httpMapLayoutSrvc.deleteLayoutStyleByIds;if(node.type===MapLayoutType.sampleMap){dialogOptions={message:LayoutStyleWording.SampleEntityDeleteMessage};deleteFetch=httpMapLayoutSrvc.deleteByIds}nbAlertSrvc.confirm(dialogOptions).then((function(){var idList=[node.ID];deleteFetch(idList).then((function(){var parentNode=findParent(node.ID,node.nodeType);if(parentNode){var index=_.findIndex(parentNode.children,{ID:node.ID});index>=0&&parentNode.children.splice(index,1);parentNode.selected=!0;initCurrentSelectedNode();_nodeClickCallback(parentNode).then((function(){currentSelectedNode=parentNode}))}initEntity()}))}))}}function getNodeTypeForAddFolder(nt){var nodeType;nt!==nodeTypeEnum.sampleTplRoot&&nt!==nodeTypeEnum.sampleTplFolder||(nodeType=nodeTypeEnum.sampleTplFolder);nt!==nodeTypeEnum.publicTplRoot&&nt!==nodeTypeEnum.publicTplFolder||(nodeType=nodeTypeEnum.publicTplFolder);return nodeType}function scrollToShowInput(){var div=angular.element(".tree-map-layout-style");var divHeight=div.height();var divScrollTop=div[0].scrollTop;var inputPos=function(obj){var l=0;var t=0;for(;obj;){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}return{left:l,top:t}}(angular.element(".tree-map-layout-style input.node-label-editable")[0]);inputPos.top>divHeight+divScrollTop&&(div[0].scrollTop=inputPos.top);inputPos.top<divScrollTop&&(div[0].scrollTop=inputPos.top)}function getUniqName(newName,newNodeType,parentNode){var nameList=[];if(parentNode.children&&parentNode.children.length>0){var sameNodes=_.filter(parentNode.children,(function(item){return item.nodeType===newNodeType}));nameList=_.pluck(sameNodes,"name")}var uniqName=newName;var isDuplicated=_.contains(nameList,uniqName);if(!0===isDuplicated)for(var j=1;j<Number.MAX_VALUE;j++){uniqName=newName+"("+j+")";if(!1===(isDuplicated=_.contains(nameList,uniqName)))break}return uniqName}function onClickLayoutStyleAdd(node){node&&fetchChildNode(node,0,!1,LayoutStyleWording.NoneSourceFolderId).then((function(){ivhTreeviewMgr.deselectAll($scope.mapLayoutTreeData,$scope.ivhTreeMapLayoutTreeOptions);resetEditingNode();var nodeType=function(nt){var nodeType;nt!==nodeTypeEnum.sampleTplRoot&&nt!==nodeTypeEnum.sampleTplFolder||(nodeType=nodeTypeEnum.sampleTplEntity);nt!==nodeTypeEnum.publicTplRoot&&nt!==nodeTypeEnum.publicTplFolder||(nodeType=nodeTypeEnum.publicTplEntity);return nodeType}(node.nodeType);var item={ID:"",name:getUniqName(LayoutStyleWording.EntityAddInitializeName,nodeType,node),editable:!0,selected:!0,expanded:!1,nodeType:nodeType};item.templateType=getTemplateType(item);node.children.push(item);node.expanded=!0;(editingNode={}).currentNode=item;editingNode.oldName=item.name;editingNode.isNew=!0;editingNode.parentNode=node;$timeout((function(){angular.element("input.ivh-treeview-node-label.node-label-editable + span.node-dropdown-arrow").addClass("row-menu-no-display");scrollToShowInput()}),100)}))}function onClickFolderAdd(node){node&&fetchChildNode(node,0,!1,LayoutStyleWording.NoneSourceFolderId).then((function(){ivhTreeviewMgr.deselectAll($scope.mapLayoutTreeData,$scope.ivhTreeMapLayoutTreeOptions);resetEditingNode();var nodeType=getNodeTypeForAddFolder(node.nodeType);var item={ID:"",name:getUniqName(LayoutStyleWording.FolderAddInitializeName,nodeType,node),children:[],editable:!0,selected:!0,expanded:!1,nodeType:nodeType};addFolderBeforeEntity(item,node.children);node.expanded=!0;(editingNode={}).currentNode=item;editingNode.oldName=item.name;editingNode.isNew=!0;editingNode.parentNode=node;$timeout((function(){angular.element("input.ivh-treeview-node-label.node-label-editable + span.node-dropdown-arrow").addClass("row-menu-no-display");scrollToShowInput()}),100)}))}function onClickFolderRename(node){if(node){ivhTreeviewMgr.deselectAll($scope.mapLayoutTreeData,$scope.ivhTreeMapLayoutTreeOptions);if(node){resetEditingNode();(editingNode={}).currentNode=node;editingNode.oldName=node.name;editingNode.isNew=!1;editingNode.parentNode=findParent(node.ID,node.nodeType);node.editable=!0;$timeout((function(){angular.element("input.ivh-treeview-node-label.node-label-editable + span.node-dropdown-arrow").addClass("row-menu-no-display")}))}}}function onClickFolderMoveTo(node){if(node){var folderId=node.ID;var nodeType=getNodeType(node);$uibModal.open({templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutMoveToView.html",controller:"nb.qmap.nbMapLayoutMoveToCtrl",backdrop:"static",windowClass:"map-layout-move-to-tree-dialog",size:"sm",resolve:{settings:{moveNodeType:nodeType,nodeTypeEnum:nodeTypeEnum,getNodeType:getNodeType,fetchChildNode:fetchChildNode,treeNodeFetch:treeNodeFetch,doneEditing:doneEditing,isNameValid:isNameValid,sourceFolderId:folderId,getNodeTypeForAddFolder:getNodeTypeForAddFolder,addFolderBeforeEntity:addFolderBeforeEntity,mode:"moveto"}}}).result.then((function(resolve){var destFolder=resolve.destFolder;var toFolderId=destFolder.ID;var test={name:node.name,parent:{id:destFolder.ID,folderType:destFolder.folderType}};if(node.parent.id===toFolderId){var optSelf={message:LayoutStyleWording.FolderMoveToSelfDestinationErrorMessage};nbAlertSrvc.warning(optSelf)}else httpMapLayoutSrvc.folderHasDuplicateName(test).then((function(result){if(result){var folderDupOpt={message:LayoutStyleWording.FolderMoveToHasDuplicateNameMessage};nbAlertSrvc.confirm(folderDupOpt).then((function(){httpMapLayoutSrvc.folderMoveTo([folderId],toFolderId).then((function(){init1();$scope.showRight=ShowRightEnum.None}),(function(err){var errOpt={message:LayoutStyleWording.FolderMoveToHasDuplicateNameFailedTip};nbAlertSrvc.warning(errOpt);console.log(err)}))}))}else httpMapLayoutSrvc.folderMoveTo([folderId],toFolderId).then((function(){init1();$scope.showRight=ShowRightEnum.None}))}))}),(function(reject){console.warn(reject)}))}}function onClickFolderDelete(node){if(node){resetEditingNode();var dialogOptions={message:LayoutStyleWording.FolderDeleteMessage};nbAlertSrvc.confirm(dialogOptions).then((function(){var folderIdList=[node.ID];httpMapLayoutSrvc.deleteFolderByIds(folderIdList).then((function(){var parentNode=findParent(node.ID,node.nodeType);if(parentNode){var index=_.findIndex(parentNode.children,{ID:node.ID});index>=0&&parentNode.children.splice(index,1);parentNode.selected=!0;initCurrentSelectedNode();_nodeClickCallback(parentNode).then((function(){currentSelectedNode=parentNode}))}initEntity()}))}))}}function addFolderBeforeEntity(newFolder,children){if(0!==children.length)for(var i=0;i<children.length;i++){var child=children[i];if(child.nodeType===nodeTypeEnum.publicTplEntity||child.nodeType===nodeTypeEnum.sampleTplEntity){children.splice(i,0,newFolder);break}if(i===children.length-1){children.push(newFolder);break}}else children.push(newFolder)}function _nodeClickCallback(node){function innerNodeClickCallback(_node){var defer_=$q.defer();var nt=getNodeType(_node);if(_node&&nt===nodeTypeEnum.publicTplEntity){loadPublicEntity(_node.ID).then((function(){_node.selected=!0;defer_.resolve()}))}else if(_node&&nt===nodeTypeEnum.sampleTplEntity){loadSampleEntity(_node.ID,_node).then((function(){_node.selected=!0;defer_.resolve()}))}else{$scope.showRight=ShowRightEnum.None;_node.selected=!0;defer_.resolve()}return defer_.promise}var defer=$q.defer();if(null!==editingNode)return $q.resolve();if(node.editable)return $q.resolve();var isModify=function(node){var result={isSelf:!1,isSame:!0};if(currentSelectedNode&&currentSelectedNode.nodeType===nodeTypeEnum.publicTplEntity){var entityCopy=angular.copy($scope.entity);var ajaxCopy=angular.copy($scope.ajaxEntity);result.isSame=_.isEqual(entityCopy,ajaxCopy)}currentSelectedNode&&(result.isSelf=currentSelectedNode.ID===node.ID);return result}(node);if(isModify.isSelf)return $q.resolve();if(isModify.isSame)innerNodeClickCallback(node).then((function(){defer.resolve()}));else{var opt=(layoutName=$scope.entity.name,{message:StringUtil.format(LayoutStyleWording.LeaveLayoutStyleUnsaved,{layout:layoutName}),buttons:[{id:NB_CONFIRM_YES,label:"Save"},{id:NB_CONFIRM_NO,label:"Don't Save"}]});nbAlertSrvc.warning(opt).then((function(result){result===NB_CONFIRM_YES?saveLayoutStyle().then((function(){innerNodeClickCallback(node).then((function(){defer.resolve()}))}),(function(){innerNodeClickCallback(node).then((function(){defer.resolve()}))})):innerNodeClickCallback(node).then((function(){defer.resolve()}))}),(function(){innerNodeClickCallback(node).then((function(){defer.resolve()}))}))}var layoutName;return defer.promise}var opTag={newFolder:"newfolder",newLayout:"newlayout",renameFolder:"renameFolder",renameLayout:"renameLayout"};function doneEditing(node,text,mtEditingNode){ivhTreeviewMgr.deselectAll($scope.mapLayoutTreeData,$scope.ivhTreeMapLayoutTreeOptions);var defer=$q.defer();if(node.ID&&node.name===text){node.editable=!1;node.selected=!0;editingNode=null;defer.resolve(!0);angular.element("span.row-menu-no-display").removeClass("row-menu-no-display");return defer.promise}text=text.trim();var nowEditingNode=mtEditingNode||editingNode;isNameValid(node,text,nowEditingNode).then((function(result){!0!==result?defer.resolve(!1):treeNodeFetch(node,text,nowEditingNode).then((function(resultedItem){var op=resultedItem.op;if(6===resultedItem.nodeStatus)showErrorDialog(LayoutStyleWording.EntityAddDuplicateMessage,"").then((function(){defer.resolve(!1)}));else if(op===opTag.newFolder||op===opTag.newLayout){node.ID=resultedItem.ID;node.name=text;node.editable=!1;node.selected=!0;editingNode=null;angular.element("span.row-menu-no-display").removeClass("row-menu-no-display");if(node.nodeType===nodeTypeEnum.publicTplEntity){node.parentFolder={id:nowEditingNode.parentNode.ID};initEntity();loadPublicEntity(node.ID)}else if(node.nodeType===nodeTypeEnum.publicTplFolder||node.nodeType===nodeTypeEnum.sampleTplFolder){node.parent={id:nowEditingNode.parentNode.ID,folderType:nowEditingNode.parentNode.folderType};node.folderType=nowEditingNode.parentNode.folderType;$scope.showRight=ShowRightEnum.None}currentSelectedNode=node;defer.resolve(!0)}else{node.name=text;node.editable=!1;node.selected=!0;editingNode=null;angular.element("span.row-menu-no-display").removeClass("row-menu-no-display");if(node.nodeType===nodeTypeEnum.publicTplEntity)if(node.ID===$scope.entity.id){$scope.entity.name=text;$scope.ajaxEntity.name=text}else{initEntity();loadPublicEntity(node.ID)}else node.nodeType===nodeTypeEnum.sampleTplEntity?loadSampleEntity(node.ID):node.nodeType!==nodeTypeEnum.publicTplFolder&&node.nodeType!==nodeTypeEnum.sampleTplFolder||($scope.showRight=ShowRightEnum.None);currentSelectedNode=node;defer.resolve(!0)}}),(function(reason){reason&&reason.ResultDesc&&6===reason.ResultCode?showErrorDialog(LayoutStyleWording.EntityAddDuplicateMessage,"").then((function(){defer.reject(!1)})):showErrorDialog(LayoutStyleWording.EntityFolderAddRenameFailedMessage,reason).then((function(){defer.reject(!1)}))}))}));return defer.promise}function treeNodeFetch(node,text,nowEditingNode){var defer=$q.defer();var nodeType=node.nodeType||getNodeType(node);if(angular.isUndefined(node.ID)||""===node.ID)if(nodeType===nodeTypeEnum.publicTplFolder||nodeType===nodeTypeEnum.sampleTplFolder){var folderParentId=nowEditingNode.parentNode.ID;var folderParentName=nowEditingNode.parentNode.name;var folderParentType=nowEditingNode.parentNode.folderType;var newFolder=function(parentFolderId,parentFolderName,parentFolderType){var folder={};folder.name="";folder.folderType=parentFolderType;folder.parent={id:parentFolderId,name:parentFolderName,folderType:parentFolderType};return folder}(folderParentId,folderParentName,folderParentType);newFolder.name=text;var testFolder={name:text,parent:{id:folderParentId,folderType:folderParentType}};httpMapLayoutSrvc.folderHasDuplicateName(testFolder).then((function(isDup){if(isDup){var folderDupOpt={message:LayoutStyleWording.FolderMoveToHasDuplicateNameMessage};nbAlertSrvc.confirm(folderDupOpt).then((function(){httpMapLayoutSrvc.addSubFolder(newFolder).then((function(result){defer.resolve({ID:result,op:opTag.newFolder})}),(function(err){defer.reject(err)}))}))}else httpMapLayoutSrvc.addSubFolder(newFolder).then((function(result){defer.resolve({ID:result,op:opTag.newFolder})}),(function(err){defer.reject(err)}))}),(function(err){console.error(err)}))}else if(nodeType===nodeTypeEnum.publicTplEntity){var layoutParentId=nowEditingNode.parentNode.ID;var folderName=nowEditingNode.parentNode.name;var folderType=nowEditingNode.parentNode.folderType;var newLayout=function(folderId,folderName,folderType){var layout={};layout.id="";layout.name="";layout.type=MapLayoutType.multiTier;layout.direction=MapLayoutDirection.top;layout.layers=[{maximumDeviceCount:8,scale:"2",associateTags:[],layerLevel:"",id:NgUtil.getUniqueStr()},{maximumDeviceCount:12,scale:"2",associateTags:[],layerLevel:"",id:NgUtil.getUniqueStr()},{maximumDeviceCount:20,scale:"2",associateTags:[],layerLevel:"",id:NgUtil.getUniqueStr()}];layout.parentFolder={id:folderId,name:folderName,folderType:folderType};layout.operateInfo={opUserId:userSrvc.getUserID(),opUser:userSrvc.getUserName()};layout.iconName=[];return layout}(layoutParentId,folderName,folderType);newLayout.name=text;var testData={name:text,parent:{id:layoutParentId,folderType:folderType}};httpMapLayoutSrvc.hasDuplicateName(testData).then((function(isDup){if(isDup){var dupOpt={message:LayoutStyleWording.EntityMoveToHasDuplicateNameMessage};nbAlertSrvc.confirm(dupOpt).then((function(){httpMapLayoutSrvc.addLayoutStyle(newLayout).then((function(newStyleId){defer.resolve({ID:newStyleId,op:opTag.newLayout})}),(function(err){defer.reject(err)}))}))}else httpMapLayoutSrvc.addLayoutStyle(newLayout).then((function(newStyleId){defer.resolve({ID:newStyleId,op:opTag.newLayout})}),(function(err){defer.reject(err)}))}),(function(err){console.warn(err)}))}if(node.ID)if(nodeType===nodeTypeEnum.publicTplFolder||nodeType===nodeTypeEnum.sampleTplFolder){var folderId=node.ID;httpMapLayoutSrvc.renameFolder(folderId,text).then((function(result){defer.resolve({ID:result,op:opTag.renameFolder})}),(function(err){defer.reject(err)}))}else if(nodeType===nodeTypeEnum.publicTplEntity){var layoutId=node.ID;httpMapLayoutSrvc.rename(layoutId,text).then((function(result){defer.resolve({ID:result,op:opTag.renameLayout})}),(function(err){defer.reject(err)}))}else if(nodeType===nodeTypeEnum.sampleTplEntity){var sampleMapId=node.ID;var strategy=node.createStrategy;httpMapLayoutSrvc.renameById(sampleMapId,text,strategy).then((function(result){defer.resolve({ID:result,op:opTag.renameLayout})}),(function(err){defer.reject(err)}))}return defer.promise}function loadPublicEntity(layoutId){return function(){var defer=$q.defer();$scope.showRight=ShowRightEnum.LayoutStyle;httpMapLayoutSrvc.getLayoutStyleById(layoutId).then((function(result){result||($scope.entity={id:"",name:"first",type:MapLayoutType.multiTier,direction:MapLayoutDirection.top,Layers:[]});$scope.entity=result;for(var i=0;i<$scope.entity.layers.length;i++){var layer=$scope.entity.layers[i];layer.deviceIconSize=layer.scale.toString();layer.id=NgUtil.getUniqueStr()}var entityString=JSON.stringify($scope.entity);$scope.ajaxEntity=JSON.parse(entityString);!function(layoutStyle){if(""===layoutStyle.id){$scope.selectedMapLayoutType=$scope.mapLayoutTypeList[0];initOrientation(MapLayoutType.multiTier,orientationEnum.tt)}else{$scope.layerData=[];$timeout((function(){$scope.layerData=layoutStyle.layers;$scope.selectedMapLayoutType=layoutStyle;var clientOrientation=(dir=layoutStyle.direction)===MapLayoutDirection.top?orientationEnum.tt:dir===MapLayoutDirection.right?orientationEnum.rr:dir===MapLayoutDirection.left?orientationEnum.ll:dir===MapLayoutDirection.bottom?orientationEnum.bb:orientationEnum.tt;var dir;initOrientation(layoutStyle.type,clientOrientation);$scope.maskOption.layerCount={value:$scope.layerData.length};$scope.maskOption.layoutDirection={value:layoutStyle.direction};$scope.maskOption.layoutType={value:$scope.selectedMapLayoutType.type}}),0)}}($scope.entity);defer.resolve()}));return defer.promise}()}var funcShowDiagramCallback=null;$scope.funcShowDiagramCallback=function(func){funcShowDiagramCallback=func};function loadSampleEntity(sampleLayoutId,node){var defer=$q.defer();httpMapLayoutSrvc.openMapById(sampleLayoutId).then((function(result){$scope.showRight=ShowRightEnum.SampleMap;var sampleNormalImg="";try{sampleNormalImg=JSON.parse(node.iconString).normalImg}catch(e){sampleNormalImg=node.iconString}$scope.sampleEntity=node;$scope.sampleEntity.normalImg=sampleNormalImg;$scope.sampleMapNormalImg=sampleNormalImg;$scope.sampleMapData={pageId:result.pageId,mapObj:result.mapObj};$timeout((function(){_.isFunction(funcShowDiagramCallback)&&funcShowDiagramCallback()}),10);defer.resolve()}));return defer.promise}function resetEditingNode(){if(null!==editingNode){if(!0===editingNode.isNew){var index=_.findIndex(editingNode.parentNode.children,{editable:!0});index>=0&&editingNode.parentNode.children.splice(index,1)}else{editingNode.currentNode.name=editingNode.oldName;editingNode.currentNode.editable=!1;editingNode.currentNode.selected=!1}editingNode=null;angular.element(document.body).unbind("click.nbTreeDocClickHandler");angular.element("span.row-menu-no-display").removeClass("row-menu-no-display")}}function showErrorDialog(message,detail){var text="";detail&&detail.ResultDesc&&(text=detail.ResultDesc);return nbAlertSrvc.error(message+" "+text)}function isNameValid(node,newName,nowEditingNode){var text=newName;var label="folder";node.nodeType===nodeTypeEnum.publicTplEntity&&(label="Layout Style");if(!text||text.length<=0)return nbAlertSrvc.error({message:StringUtil.format(LayoutStyleWording.IsNameValidEmpty,{label:label})});if(text.length>128)return nbAlertSrvc.error({message:StringUtil.format(LayoutStyleWording.IsNameValidLargeThen128,{label:label})});if(!nbValidationSrvc.getValidator("generalForbidWindowsAndMongoChars")(text))return nbAlertSrvc.warning({message:LayoutStyleWording.IsNameValidGeneralForbidWindowsAndMongoChars});var isDuplicateResult=function(node,text,existingNodeList){for(var i=0;i<existingNodeList.length;i++){var item=existingNodeList[i];if((node.ID!==item.ID||node.name!==item.name)&&(item.ID&&item.name&&text.toUpperCase()===item.name.toUpperCase()&&item.nodeType===node.nodeType))return!0}return!1}(node,text,nowEditingNode.parentNode.children);var errorMessage=StringUtil.format(LayoutStyleWording.IsNameValidErrorMessage,{label:label});if(isDuplicateResult)return nbAlertSrvc.error({message:errorMessage});var defer=$q.defer();defer.resolve(!0);return defer.promise}var deviceIconSizeEnum=NetBrain.MapLayout.Const.DeviceIconSize;var MapLayoutTypeArray=[MapLayoutType.multiTier,MapLayoutType.pairing,MapLayoutType.pie,MapLayoutType.circle];$scope.mapLayoutTypeList=[];var orientationEnum={tt:"t",rr:"r",ll:"l",bb:"b"};var mapLayoutTypeIconList=NetBrain.MapLayout.Const.MapLayoutTypeIconList;var mapLayoutTypeDirection=["undefined",[orientationEnum.tt,orientationEnum.bb,orientationEnum.ll,orientationEnum.rr],[orientationEnum.tt,orientationEnum.ll],[orientationEnum.tt],[orientationEnum.tt],{}];$scope.currentLayoutStyleName="";$scope.showChangeLayoutStyle=!1;$scope.selectedMapLayoutType={};$scope.orientationList=[{iconNames:{},css:"",orientation:""},{iconNames:{},css:"",orientation:""},{iconNames:{},css:"",orientation:""},{iconNames:{},css:"",orientation:""}];$scope.selectedOrientation="";$scope.layerData=[];$scope.tagList=[];$scope.tagMenuId="ul"+NgUtil.getUniqueStr();$scope.ulStyle={};$scope.entity={id:"",name:"first",type:MapLayoutType.multiTier,direction:MapLayoutDirection.top,Layers:[]};$scope.sampleEntity={normalImg:""};$scope.sampleMapNormalImg="";$scope.sampleMapData={};$scope.maskOption={layerCount:0,layoutDirection:MapLayoutDirection.top,layoutType:MapLayoutType.multiTier};function initEntity(){$scope.ajaxEntity=$scope.entity;$scope.maskOption.layerCount=0;$scope.maskOption.layoutDirection=MapLayoutDirection.top;$scope.maskOption.layoutType=MapLayoutType.multiTier}function getLayoutEntityToSave(mode,destFolder,newLayoutName){var copyEntity=angular.copy($scope.entity);if("update"===mode||"saveas"===mode)for(var i=0;i<copyEntity.layers.length;i++){var layer=copyEntity.layers[i];layer.scale=parseInt(layer.deviceIconSize)}if("saveas"===mode){var toFolderId=destFolder.ID;var toFolderName=destFolder.name;copyEntity.name=newLayoutName;copyEntity.id="";copyEntity.parentFolder={id:toFolderId,name:toFolderName,folderType:destFolder.folderType}}return copyEntity}function saveLayoutStyle(){var defer=$q.defer();var entity=getLayoutEntityToSave("update");httpMapLayoutSrvc.updateLayoutStyle(entity).then((function(){var options={tipInfo:LayoutStyleWording.SaveLayoutStyleSuccessTip,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);var entityString=JSON.stringify($scope.entity);$scope.ajaxEntity=JSON.parse(entityString);defer.resolve()}),(function(){defer.resolve()}));return defer.promise}$scope.onClickSaveLayoutStyle=function(){saveLayoutStyle()};$scope.onClickSaveAsLayoutStyle=function(){var nodeType=nodeTypeEnum.publicTplEntity;$uibModal.open({templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutMoveToView.html",controller:"nb.qmap.nbMapLayoutMoveToCtrl",backdrop:"static",windowClass:"map-layout-move-to-tree-dialog",size:"sm",resolve:{settings:{moveNodeType:nodeType,nodeTypeEnum:nodeTypeEnum,getNodeType:getNodeType,fetchChildNode:fetchChildNode,treeNodeFetch:treeNodeFetch,doneEditing:doneEditing,isNameValid:isNameValid,sourceFolderId:LayoutStyleWording.NoneSourceFolderId,getNodeTypeForAddFolder:getNodeTypeForAddFolder,addFolderBeforeEntity:addFolderBeforeEntity,mode:"saveas"}}}).result.then((function(resolve){var entity=getLayoutEntityToSave("saveas",resolve.destFolder,resolve.newLayoutName);httpMapLayoutSrvc.addLayoutStyle(entity).then((function(){init1();$scope.showRight=ShowRightEnum.None;var options={tipInfo:LayoutStyleWording.SaveLayoutStyleSuccessTip,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options)}))}),(function(reject){console.warn(reject)}))};$scope.onClickChangeLayoutStyle=function(){_.each($scope.mapLayoutTypeList,(function(item){item.selected=!1;if(item.type===$scope.entity.type){item.selected=!0;$scope.selectedMapLayoutType=item}}));$scope.showChangeLayoutStyle=!0};$scope.onClickLayoutStylesCloseTip=function(){$scope.showChangeLayoutStyle=!1};$scope.onClickCancelLayoutStyleTypeButton=function(){$scope.showChangeLayoutStyle=!1};$scope.onClickSelectLayoutStyleTypeButton=function(){var index=_.findIndex($scope.mapLayoutTypeList,{selected:!0});if(index>=0){var layoutTypeObj=$scope.mapLayoutTypeList[index];$scope.selectedMapLayoutType=layoutTypeObj;$scope.entity.type=layoutTypeObj.type;$scope.entity.direction=getServerDir(orientationEnum.tt);$scope.maskOption.layoutType={value:layoutTypeObj.type};$scope.maskOption.layoutDirection={value:MapLayoutDirection.top};initOrientation($scope.selectedMapLayoutType.type,orientationEnum.tt)}$scope.showChangeLayoutStyle=!1};$scope.onClickMapLayoutStyleType=function(selectItem){_.each($scope.mapLayoutTypeList,(function(item){item.selected=!1}));selectItem.selected=!0;$scope.selectedMapLayoutType=selectItem;$scope.onClickSelectLayoutStyleTypeButton()};$scope.onClickOrientationItem=function(item,index){if(0!==index){var temp=$scope.orientationList[0];$scope.orientationList[0]=item;$scope.orientationList[index]=temp;var ori=$scope.orientationList[0].orientation;$scope.selectedOrientation=ori;$scope.maskOption.layoutDirection={value:getServerDir(ori)};$scope.entity.direction=getServerDir(ori)}};function getServerDir(ori){return ori===orientationEnum.tt?MapLayoutDirection.top:ori===orientationEnum.rr?MapLayoutDirection.right:ori===orientationEnum.ll?MapLayoutDirection.left:ori===orientationEnum.bb?MapLayoutDirection.bottom:MapLayoutDirection.top}function initOrientation(layoutType,firstDir){for(var z=0;z<$scope.orientationList.length;z++){var ori=$scope.orientationList[z];ori.iconNames={};ori.css="";ori.orientation=""}var iconArray=mapLayoutTypeIconList[layoutType];$scope.orientationList[0].iconNames=iconArray[firstDir];$scope.orientationList[0].orientation=firstDir;var index=1;for(var i=0;i<mapLayoutTypeDirection[layoutType].length;i++){var dir=mapLayoutTypeDirection[layoutType][i];if(dir!==firstDir){$scope.orientationList[index].iconNames=iconArray[dir];$scope.orientationList[index].orientation=dir;index++}}$scope.selectedOrientation=firstDir}$scope.layerGridOptions={data:"layerData",columnDefs:[{field:"layer",displayName:LayoutStyleWording.GridColumn1TitleInLayerList,width:"125",cellTemplate:'<div class="ui-grid-cell-contents"><span class="layer-name-in-grid" title="Layer {{grid.appScope.getIndex($event, row.entity.id)}}">Layer {{grid.appScope.getIndex($event, row.entity.id)}}</span></div>'},{field:"tags",displayName:LayoutStyleWording.GridColumn2TitleInLayerList,width:"*",cellTemplate:('<div class="ui-grid-cell-contents"><nb-map-layout-tags-directive layers="grid.appScope.layerData" associate-tags="row.entity.associateTags" tag-list="grid.appScope.tagList"></nb-map-layout-tags-directive></div>','<div class="ui-grid-cell-contents"><nb-map-layout-tags-directive layers="grid.appScope.layerData" associate-tags="row.entity.associateTags" tag-list="grid.appScope.tagList"></nb-map-layout-tags-directive></div>')},{field:"maximumDeviceCount",displayName:LayoutStyleWording.GridColumn3TitleInLayerList,width:"230",cellTemplate:getFirstDeviceNumberCellTemplate()},{field:"scale",displayName:LayoutStyleWording.GridColumn4TitleInLayerList,width:"180",cellTemplate:getFirstIconSizeCellTemplate()}],enableFullRowSelection:!1,enableColumnResizing:!1,enableSorting:!1,onRegisterApi:function(gridApi){$scope.matchedGridApi=gridApi;$scope.matchedGridApi.selection.on.rowSelectionChanged($scope,(function(row){$scope.selectedMathcedRow=angular.copy(row.entity)}))}};function getFirstDeviceNumberCellTemplate(){return'<div class="ui-grid-cell-contents"><input class="input-max-device-count" ng-blur="grid.appScope.onBlur($event, row.entity.id)" type="number" name="maxDeviceCount" ng-model="row.entity.maximumDeviceCount"  min="1" max="99" required validate-tip="right" vtip-callback="grid.appScope.onChange3"  vtip-msg="grid.appScope.tipMsg3" vtip-class="vtip-error" vtip-event="input" atag="mapLayout:layoutStylePane:layer:deviceCountInput" /></div>'}function getFirstIconSizeCellTemplate(){return'<div class="ui-grid-cell-contents"><select class="drop-layer-tag" ng-model="row.entity.deviceIconSize" atag="mapLayout:layoutStylePane:layer:deviceIconSizeSelect">    <option title="{{item.label}}" value="{{item.value}}" ng-repeat="item in grid.appScope.deviceSizeMenu">{{item.label}}</option></select><span class="icon_nb_delete_blue_12" ng-click="grid.appScope.onDeleteLayer($event, row.entity.id)" atag="mapLayout:layoutStylePane:layer:deleteBtn"></span></div>'}$scope.onBlur=function(event,id){var index=_.findIndex($scope.layerData,{id:id});if(index>=0){var numStr=$scope.layerData[index].maximumDeviceCount;if(!numStr&&0!==numStr||(""+numStr).indexOf(".")>-1||!(+numStr>=1&&+numStr<=99)){numStr=1;$scope.layerData[index].maximumDeviceCount=1}angular.element("div.showTipDirective-cmn.vtip-error").hide()}};$scope.onChange3=function(numStr){var flag=!0;(!numStr&&0!==numStr||(""+numStr).indexOf(".")>-1||!(+numStr>=1&&+numStr<=99))&&(flag=!1);try{$scope.$digest()}catch(err){console.warn("onChange3.")}return flag};$scope.tipMsg3={msg:LayoutStyleWording.LayerDeviceCountErrorMessage};$scope.deviceIconSize=3;$scope.deviceSizeMenu=[{label:"Large(120%)",value:deviceIconSizeEnum.larger},{label:"Medium(100%)",value:deviceIconSizeEnum.normal},{label:"Small(80%)",value:deviceIconSizeEnum.small}];$scope.onDeleteLayer=function(event,id){var dialogOptions={message:LayoutStyleWording.LayerDeleteDialogMessage};nbAlertSrvc.confirm(dialogOptions).then((function(){var index=_.findIndex($scope.layerData,{id:id});index>=0&&$scope.layerData.splice(index,1);$scope.maskOption.layerCount={value:$scope.layerData.length}}))};$scope.onClickAddLayer=function(){var item={maximumDeviceCount:8,deviceIconSize:"2",associateTags:[],layerLevel:"",id:NgUtil.getUniqueStr()};$scope.layerData.push(item);$scope.maskOption.layerCount={value:$scope.layerData.length}};$scope.getIndex=function(event,id){return _.findIndex($scope.layerData,{id:id})+1};var watchchangedDomain=$rootScope.$on(systemEvent.changedDomain,(function(){window.location=window.location}));$scope.$on("$destroy",(function(){watchchangedDomain()}));init1();!function(){$scope.mapLayoutTypeList=[];for(var i=0;i<MapLayoutTypeArray.length;i++){var layoutType=MapLayoutTypeArray[i];if(layoutType!==MapLayoutType.pie){var dir=orientationEnum.tt;var item={type:layoutType,iconNames:mapLayoutTypeIconList[layoutType][dir],id:NgUtil.getUniqueStr(),selected:!1};$scope.mapLayoutTypeList.push(item)}}}()}}(NetBrain);!function(){angular.module("nb.qmap").directive("nbMapLayoutOrientationMaskDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutOrientationMaskDirective.html",scope:{maskOption:"="},link:function(scope,element,attrs){},controller:Controller,replace:!0}}]);Controller.$inject=["$element","$attrs","$timeout","$rootScope","$q","$document","nb.common.nbAlertSrvc","nb.ng.nbValidationSrvc","ivhTreeviewMgr","nb.qmap.mapManagerSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","$compile","$scope"];function Controller(element,attr,$timeout,$rootScope,$q,$document,nbAlertSrvc,nbValidationSrvc,ivhTreeviewMgr,mapManagerSrvc,mapContextMenuManager,updateMapSrvc,$compile,$scope){$scope.innerMaskOption=$scope.maskOption;$scope.layer1="Layer1";$scope.layer2="Layer2";$scope.layer3="Layer3";$scope.showMask1=!1;$scope.showMask2=!1;$scope.showMask3=!1;$scope.showMask4=!1;var MapLayoutType=NetBrain.MapLayout.Const.MapLayoutType;var MapLayoutDirection=NetBrain.MapLayout.Const.MapLayoutDirection;function setAllMaskFalse(){$scope.showMask1=!1;$scope.showMask2=!1;$scope.showMask3=!1;$scope.showMask4=!1}function refreshMask(){$scope.innerMaskOption.layoutType.value===MapLayoutType.multiTier?$scope.innerMaskOption.layoutDirection.value===MapLayoutDirection.top||$scope.innerMaskOption.layoutDirection.value===MapLayoutDirection.bottom?$scope.showMask1=!0:$scope.innerMaskOption.layoutDirection.value!==MapLayoutDirection.left&&$scope.innerMaskOption.layoutDirection.value!==MapLayoutDirection.right||($scope.showMask2=!0):$scope.innerMaskOption.layoutType.value===MapLayoutType.pairing&&($scope.innerMaskOption.layoutDirection.value===MapLayoutDirection.top||$scope.innerMaskOption.layoutDirection.value===MapLayoutDirection.bottom?$scope.showMask3=!0:$scope.innerMaskOption.layoutDirection.value!==MapLayoutDirection.left&&$scope.innerMaskOption.layoutDirection.value!==MapLayoutDirection.right||($scope.showMask4=!0));refreshLayerCount($scope.innerMaskOption.layerCount.value)}var watchLayoutTypeFunction=$scope.$watch("innerMaskOption.layoutType",(function(value){setAllMaskFalse();refreshMask()}));var watchLayoutDirectionFunction=$scope.$watch("innerMaskOption.layoutDirection",(function(value){setAllMaskFalse();refreshMask()}));var watchLayerCountFunction=$scope.$watch("innerMaskOption.layerCount",(function(value){refreshLayerCount(value.value)}));function refreshLayerCount(count){var chg=!1;$scope.innerMaskOption.layoutDirection.value!==MapLayoutDirection.bottom&&$scope.innerMaskOption.layoutDirection.value!==MapLayoutDirection.right||(chg=!0);if(0===count||3===count){chg?$scope.layer3="Layer1":$scope.layer1="Layer1";$scope.layer2="Layer2";chg?$scope.layer1="Layer3":$scope.layer3="Layer3"}else if(1===count){chg?$scope.layer3="Layer1":$scope.layer1="Layer1";$scope.layer2="";chg?$scope.layer1="":$scope.layer3=""}else if(2===count){chg?$scope.layer3="Layer1":$scope.layer1="Layer1";$scope.layer2="Layer2";chg?$scope.layer1="":$scope.layer3=""}else if(count>3){chg?$scope.layer3="Layer1":$scope.layer1="Layer1";$scope.layer2="... ...";chg?$scope.layer1="Layer"+count:$scope.layer3="Layer"+count}else{$scope.layer1="Layer1";$scope.layer2="Layer2";$scope.layer3="Layer3"}}$scope.$on("$destroy",(function(){watchLayoutDirectionFunction();watchLayoutTypeFunction();watchLayerCountFunction()}))}}();!function(NetBrain){angular.module("nb.qmap").controller("nb.qmap.nbMapLayoutMoveToCtrl",nbMapLayoutMoveToCtrl);nbMapLayoutMoveToCtrl.$inject=["$scope","$uibModalInstance","settings","nb.common.nbAlertSrvc","$timeout","ivhTreeviewMgr","$q","nb.ng.nbValidationSrvc","nb.qmap.httpMapLayoutSrvc"];function nbMapLayoutMoveToCtrl($scope,$uibModalInstance,settings,nbAlertSrvc,$timeout,ivhTreeviewMgr,$q,nbValidationSrvc,httpMapLayoutSrvc){var LayoutStyleWording=NetBrain.MapLayout.Const.Wording.LayoutStyle;var MoveToWording=NetBrain.MapLayout.Const.Wording.MoveTo;var ctrl=$scope.ctrl=this;var editingNode=null;var selectedFolder=null;var moveNodeType="";var nodeTypeEnum={};var getNodeType;var fetchChildNode;var doneEditing;var getNodeTypeForAddFolder;var sourceFolderId="";var ivhTreeMapLayoutTreeOptions={};var getServerFolderType=NetBrain.MapLayout.Const.getServerFolderType;function onNameChanged(){nbValidationSrvc.submit("layoutFormSaveAs").then((function(){ctrl.validateLayoutName=!0}),(function(reason){ctrl.validateLayoutName=!1;console.error(reason)}))}function onBlurInput(){nbValidationSrvc.submit("layoutFormSaveAs").then((function(){ctrl.validateLayoutName=!0}),(function(reason){ctrl.validateLayoutName=!1;console.error(reason)}))}function okHandler(){var opts={destFolder:selectedFolder,newLayoutName:ctrl.uiControl.newLayoutName};$uibModalInstance.close(opts)}function cancelHandler(event){event&&event.preventDefault();$uibModalInstance.dismiss("Cancel Button Clicked!")}function onClickFolderAdd(node){fetchChildNode(node,null,!0,LayoutStyleWording.NoneSourceFolderId).then((function(){ivhTreeviewMgr.deselectAll(ctrl.mapLayoutTreeData,ctrl.ivhTreeMapLayoutTreeOptions);if(node){!function(){if(null!==editingNode){if(!0===editingNode.isNew){var index=_.findIndex(editingNode.parentNode.children,{editable:!0});index>=0&&editingNode.parentNode.children.splice(index,1)}else{editingNode.currentNode.name=editingNode.oldName;editingNode.currentNode.editable=!1;editingNode.currentNode.selected=!1}editingNode=null;$(document.body).unbind("click.nbTreeDocClickHandler");$("span.row-menu-no-display").removeClass("row-menu-no-display")}}();var nodeType=getNodeTypeForAddFolder(node.nodeType);var item={ID:"",name:"New Folder",children:[],editable:!0,selected:!0,expanded:!1,nodeType:nodeType,folderType:getServerFolderType(nodeType)};node.children.push(item);node.expanded=!0;(editingNode={}).currentNode=item;editingNode.oldName=item.name;editingNode.isNew=!0;editingNode.parentNode=node;$timeout((function(){angular.element("input.ivh-treeview-node-label.node-label-editable + span.node-dropdown-arrow").addClass("row-menu-no-display");!function(){var div=angular.element(".tree-map-layout-style");var divHeight=div.height();var divScrollTop=div[0].scrollTop;var inputPos=function(obj){var l=0;var t=0;for(;obj;){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}return{left:l,top:t}}(angular.element(".tree-map-layout-style input.node-label-editable")[0]);inputPos.top>divHeight+divScrollTop&&(div[0].scrollTop=inputPos.top);inputPos.top<divScrollTop&&(div[0].scrollTop=inputPos.top)}()}),100)}}))}var layoutRootMenu=[{template:"New Folder",action:function(node){onClickFolderAdd(node)}}];var layoutFolderMenu=[{template:"New Folder",action:function(node){onClickFolderAdd(node)}}];var sampleRootMenu=[{template:"New Folder",action:function(node){onClickFolderAdd(node)}}];var sampleFolderMenu=[{template:"New Folder",action:function(node){onClickFolderAdd(node)}}];ivhTreeMapLayoutTreeOptions={defaultSelectedState:!1,validate:!0,expandToDepth:1,labelAttribute:"name",idAttribute:"ID",childrenAttribute:"children",expandedAttribute:"expanded",selectedAttribute:"selected",editableAttribute:"editable",enableMultipleSelect:!1,enableLabelExpand:!1,iconTemplate:function(node){return node.nodeType<100?'<div class="icon_nb_folder"></div>':'<div class="icon_nb_dataviewtemplate"></div>'},nodeClickCallback:function(node,trvw){null===editingNode?function(node){if(node.ID===selectedFolder.ID){node.selected||(node.selected=!0);selectedFolder=node}else selectedFolder=node}(node):node.selected=!1},enableNodeDropdown:{isDisplay:function(node){node.editable;return!0},dropdownItems:function(node){var nt=getNodeType(node);return nt===nodeTypeEnum.publicTplRoot?layoutRootMenu:nt===nodeTypeEnum.publicTplFolder?layoutFolderMenu:nt===nodeTypeEnum.sampleTplRoot?sampleRootMenu:nt===nodeTypeEnum.sampleTplFolder?sampleFolderMenu:{}}},lazyLoadingAttribute:function(node){var canLazy=!1;var nt=node.nodeType;nt!==nodeTypeEnum.publicTplRoot&&nt!==nodeTypeEnum.publicTplFolder||(canLazy=!0);nt!==nodeTypeEnum.sampleTplRoot&&nt!==nodeTypeEnum.sampleTplFolder||(canLazy=!0);return canLazy},editableCallback:function(node,trvw,text){return doneEditing(node,text,editingNode).then((function(result){selectedFolder=node}))},lazyLoadingCallback:function(node,trvw){return fetchChildNode(node,trvw,!0,sourceFolderId)}};!function(){ctrl.validateLayoutName=!1;moveNodeType=settings.moveNodeType;nodeTypeEnum=settings.nodeTypeEnum;getNodeType=settings.getNodeType;fetchChildNode=settings.fetchChildNode;doneEditing=settings.doneEditing;getNodeTypeForAddFolder=settings.getNodeTypeForAddFolder;sourceFolderId=settings.sourceFolderId;ctrl.mode=settings.mode;if("moveto"===ctrl.mode){ctrl.uiControl={newLayoutName:"test"};ctrl.validateLayoutName=!0}else"saveas"===ctrl.mode&&(ctrl.uiControl={newLayoutName:""});ctrl.layoutNameSaveAsValidator={method:"blur",rules:[{ruleId:"required",errorMessage:MoveToWording.SaveAsLayoutNameEmptyErrorMessage},{ruleId:"mongoDBNameValidateChecker",params:{name:ctrl.uiControl.newLayoutName},errorMessage:MoveToWording.SaveAsLayoutNameDBNameValidateErrorMessage+nbValidationSrvc.mongoDbForbidCharString()}]};ctrl.onNameChanged=onNameChanged;ctrl.onBlurInput=onBlurInput;ctrl.onOK=okHandler;ctrl.onCancel=cancelHandler;ctrl.ivhTreeMapLayoutTreeOptions=ivhTreeMapLayoutTreeOptions;ctrl.mapLayoutTreeData=[];httpMapLayoutSrvc.getRootFolderList().then((function(result){var qList=[];for(var i=0;i<result.length;i++){var node=result[i];if(node.id!==sourceFolderId){node.ID=node.id;node.nodeType=getNodeType(node);node.children=[];node.editable=!1;node.selected=!1;node.expanded=!1;if(moveNodeType.toString().indexOf(node.nodeType.toString())>=0){node.selected=!0;node.expanded=!0;qList.push(fetchChildNode(node,null,!0,sourceFolderId));ctrl.mapLayoutTreeData.push(node);selectedFolder=node}}}$q.all(qList).then((function(){$scope.isLoading=!1}))}))}()}}(NetBrain);!function(netBrain){angular.module("nb.qmap").directive("nbMapLayoutDiagramDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutDiagramDirective.html",scope:{sampleMapData:"=",showDiagramCallback:"&"},controller:Controller,replace:!0}}]);Controller.$inject=["$scope","$attrs","$timeout","$rootScope","$q","$document","nb.common.nbAlertSrvc","nb.ng.callbackSrvc","nb.ng.nbValidationSrvc","ivhTreeviewMgr","nb.ng.userSrvc","nb.common.nbTipSrvc","nb.qmap.mapManagerSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","$compile","$uibModal","nb.qmap.httpMapLayoutSrvc","$element","nb.qmap.netMapCmdTarget","nb.netbrain.dataViewCacheSrvc","nb.dataview.applyDataViewSrvc","md5"];function Controller($scope,attr,$timeout,$rootScope,$q,$document,nbAlertSrvc,callbackSrvc,nbValidationSrvc,ivhTreeviewMgr,userSrvc,nbTipSrvc,mapManagerSrvc,mapContextMenuManager,updateMapSrvc,$compile,$uibModal,httpMapLayoutSrvc,element,netMapCmdTarget,dataViewCacheSrvc,applyDataViewSrvc,md5){var $=go.GraphObject.make;$scope.initCtrl=function(pageId){var mapJsData="";var tempMapPage=$scope.qmapObj.getDocById(pageId);tempMapPage&&(mapJsData=tempMapPage.toJson());$scope.netmap=$scope.mapPageObj;$scope.netmap.setCurrentScope($scope);$scope.diagram.model.modelData.space=1;if($scope.netmap.isL2MapStyle()){$scope.diagram.model.linkFromPortIdProperty="fromPort";$scope.diagram.model.linkToPortIdProperty="toPort"}else{$scope.diagram.model.linkFromPortIdProperty="fromPortIntf";$scope.diagram.model.linkToPortIdProperty="toPortIntf"}$scope.netmap.addL2StyleProperty($scope.diagram);$scope.netmap.setGoJsContext($scope.diagram,$scope.diagram.model);var diagram=$scope.netmap.getGoJsDiagram();null!=diagram&&(diagram.commandHandler.zoomCallBack=function(dZoomValue){diagram.links.each((function(l){NetBrain.Map.CategoryMgr.isPathLink(l.category)&&l.invalidateRoute()}));$scope.netmap.refreshMapViewOptionVisible();$scope.netmap.setSpace(dZoomValue)});$scope.diagram.commandHandler.setSpace($scope.netmap.getSpace());$scope.netmap.doOpen(mapJsData);$scope.netmap.refreshMapViewOptionVisible();if($scope.netmap.isMapViewOptionEmpty()){$scope.netmap.setMapViewOptionJson();$scope.getDefaultMapViewOption(null,userSrvc.getUserID()).then((function(retMapViewOptionJson){$scope.netmap.setMapViewOptionJson(retMapViewOptionJson);$scope.diagram.commandHandler.setCusZoomSetp($scope.netmap.getZoomStep())}),(function(){$scope.netmap.setMapViewOptionJson(null);$scope.diagram.commandHandler.setCusZoomSetp($scope.netmap.getZoomStep())}))}else $scope.diagram.commandHandler.setCusZoomSetp($scope.netmap.getZoomStep());$scope.netmapOperator=new NetBrain.Map.CNetMapOperator($scope.netmap,dataViewCacheSrvc,$rootScope,$q,null,applyDataViewSrvc);netMapCmdTarget.init($scope.netmapOperator,$scope).computePathManager.setMD5Service(md5);!function(cb){var defer=$q.defer();$timeout((function(){$scope.diagram.centerRect($scope.diagram.documentBounds);$scope.netmap.layoutLinkLabels(!0);cb&&_.isFunction(cb)&&cb();defer.resolve()}));defer.promise}((function(){$scope.netmap.setModify(!1)}))};$scope.showDiagram=function(){var mapObj=$scope.sampleMapData.mapObj;var pageId=$scope.sampleMapData.pageId;var map=new NetBrain.Map.CQMap;map.fromJson(mapObj);var pageObj=map.getNetmapById(pageId);$scope.mapPageObj=pageObj;$scope.qmapObj=map;$scope.mapTitle=map.getTitle()+"-"+$scope.mapPageObj.getTitle();map.getActiveNetmap().setCurrentScope($scope);var diagram=$scope.diagram;diagram.clear();var overviewsite=$scope.mapPageObj.getTopologyType()===netBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite||$scope.mapPageObj.getTopologyType()===netBrain.Map.Const.NetmapTopoLogy.overViewTopologySite;var isL2Style=$scope.mapPageObj.isL2MapStyle();diagram.linkTemplateMap=netBrain.Map.mapTemplateProvider(diagram,$scope,overviewsite,isL2Style).linkTemplateMap();diagram.nodeTemplateMap=netBrain.Map.mapTemplateProvider(diagram,$scope,overviewsite,isL2Style).nodeTemplateMap();$scope.initCtrl(pageId)};$scope.showDiagramCallback({func:$scope.showDiagram});$scope.onUpdateView=function(){void 0!==$scope.diagram&&$scope.diagram.requestUpdate()};callbackSrvc.registerCallback("nbGoDiagramDirective.onUpdateView",$scope.onUpdateView);$scope.netmapDiagramStyle={"background-color":"#FFFFFF",width:"100%"};$scope.doubleClickDevice=function(){};$scope.clickDevice=function(){};$scope.OnMouseOver=function(){};$scope.isEditMode=function(){return!1};$scope.deviceRightClicked=function(){};$scope.linkLabelClick=function(){};$scope.toggleDeviceFloatingMenu=function(){};$scope.devPosLabelClicked=function(){};$scope.linkLabelMouseEnter=function(){};$scope.linkLabelMouseLeave=function(){};$scope.popDeviceView=function(){};$scope.redPlusClick=function(){};$scope.isMultiSelected=function(){return $scope.diagram.selection.size>1};$scope.ShapeDoubleClk=function(){};$scope.tableDoubleClick=function(){};$scope.clickMultiLink=function(){};!function(){$scope.diagram=$(go.Diagram,"sampleMapContainerDiv",{initialContentAlignment:go.Spot.Center,padding:new go.Margin(50,100,50,100),autoScrollRegion:new go.Margin(50,100,50,100),initialDocumentSpot:go.Spot.TopLeft,initialViewportSpot:go.Spot.TopLeft,contentAlignment:go.Spot.Default,"layout.isInitial":!1,"layout.isOngoing":!1,"layout.isValidLayout":!0,"undoManager.isEnabled":!0,"toolManager.mouseWheelBehavior":go.ToolManager.WheelZoom,"toolManager.panningTool":new netBrain.Map.CustomizePanningTool($scope),commandHandler:$(netBrain.Map.CustomizedCommandHandler),rotatingTool:$(netBrain.Map.TopRotatingTool),hasHorizontalScrollbar:!1,hasVerticalScrollbar:!1,allowHorizontalScroll:!0,allowVerticalScroll:!0,currentCursor:cursorHelper.grab});var diagram=$scope.diagram;var layerObj=diagram.findLayer("Adornment");diagram.addLayerBefore($(go.Layer,{name:window.GlobalContext.DeviceLayerName}),layerObj);layerObj=diagram.findLayer(window.GlobalContext.DeviceLayerName);diagram.addLayerBefore($(go.Layer,{name:window.GlobalContext.LinkLayerName}),layerObj);layerObj=diagram.findLayer(window.GlobalContext.LinkLayerName);diagram.addLayerBefore($(go.Layer,{name:window.GlobalContext.NormalShapObjName}),layerObj);layerObj=diagram.findLayer(window.GlobalContext.NormalShapObjName);diagram.addLayerBefore($(go.Layer,{name:window.GlobalContext.NormalShapBelowObjName}),layerObj);diagram.position=new go.Point(0,0);(new netBrain.Map.GeometryReshapingTool).reshapeObjectName=netBrain.Map.DrawShapeCommonAttr.ObjName;diagram.mouseOver=$scope.OnMouseOver;diagram.isReadOnly=!0}();$scope.$on("$destroy",(function(){}))}}(NetBrain);!function(netBrain){angular.module("nb.qmap").directive("nbMapLayoutMiniPaneDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutMiniPaneDirective.html",scope:{optionsOut:"=",netmapOperator:"=",showOption:"="},link:function(scope,element,attrs,carouselCtrl){},controller:Controller,replace:!0}}]);Controller.$inject=["$compile","$scope","$document","$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.netbrain.httpDeviceSrvc","nb.common.nbTipSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","uiGridTreeBaseService","$uibModal","nb.qmap.httpMapLayoutSrvc","nb.qmap.mapLayoutSrvc","nb.common.nbDragDropSrvc","nb.uiframework.urlStateMgr"];function Controller($compile,$scope,$document,element,attr,$timeout,$rootScope,$q,mapManagerSrvc,httpDeviceSrvc,nbTipSrvc,mapContextMenuManager,updateMapSrvc,uiGridTreeBaseService,$uibModal,httpMapLayoutSrvc,mapLayoutSrvc,nbDragDropSrvc,urlStateMgr){var MapLayoutType=NetBrain.MapLayout.Const.MapLayoutType;var TemplateLayoutType=NetBrain.MapLayout.Const.TemplateLayoutType;var OrientationEnum=NetBrain.MapLayout.Const.OrientationEnum;var mapLayoutTypeIconList=NetBrain.MapLayout.Const.MapLayoutTypeIconList;$scope.actualOption={active:{}};$scope.options=angular.copy($scope.optionsOut);$scope.pageOption={mapNumber:1,mapTotal:1};var tools=null;var containerId="#realPage-"+$scope.options.mapPageId+"-container";var mapLayouts=$scope.mapLayouts=[];var mapPageId=$scope.options.mapPageId;$scope.selectedLayoutItem={matchedCount:0};var isFirstShow=!0;$scope.showRightSideTool=!1;$scope.showRightSideToolRotateBtn=!0;$scope.hideRightSideToolRotateBtnCss={};$scope.showRightSideToolEditBtn=!0;$scope.showRightSideToolOpenBtn=!1;$scope.showRotationsBox=!1;var isOnSlideElement=!1;var isOnRotationsBoxElement=!1;$scope.orientationEnum=OrientationEnum;var slides=$scope.slides=[];var highlightDeviceIdList=NetBrain.MapLayout.Const.MapLayoutHighlightOption.getDeviceIdList(mapPageId);$scope.highlightDevice=NetBrain.MapLayout.Const.MapLayoutHighlightOption.getHighLightDevice(mapPageId);var pageService=null;$scope.isShowHighlight=!1;var categoryMgr=netBrain.Map.CategoryMgr;var convertLayout=NetBrain.MapLayout.Const.convertLayout;var filterSimilarityFunctionHandler=NetBrain.MapLayout.Const.filterSimilarityFunctionHandler;var innerChangedStatus=NetBrain.MapLayout.Const.innerChangedStatus;var openSampleMap=NetBrain.MapLayout.Const.openSampleMap;OrientationEnum.tt;$scope.isAutoApply=NetBrain.MapLayout.Const.isAutoApply;$scope.isAutoApply.value=!1;var matchedNodeKeys=[];function loadData(){OrientationEnum.tt;var defer=$q.defer();slides.splice(0,slides.length);mapLayouts.splice(0,mapLayouts.length);mapLayoutSrvc.initPageService($scope.netmapOperator,httpDeviceSrvc,mapPageId).then((function(pageSrvc){pageService=pageSrvc;return pageSrvc.getAllLayouts(filterSimilarityFunctionHandler)})).then((function(layouts){var SampleMapCreateStrategyEnum=NetBrain.MapLayout.Const.SampleMapCreateStrategy;tools=mapLayoutSrvc.getLayoutToolsHelper(mapPageId);mapLayouts=mapLayouts.concat(layouts);var index=0;var mapType=netBrain.Map.currentActiveMap.qmapJsWrapper.qmapdata.mapType;for(var j=0;j<mapLayouts.length;j++){var item=mapLayouts[j];if(NetBrain.Map.Const.MapType.overViewMap===mapType){if(item.bigType===TemplateLayoutType.MapLayout||item.bigType===TemplateLayoutType.SampleLayout)continue}else if(NetBrain.Map.Const.MapType.siteMap!==mapType&&NetBrain.Map.Const.MapType.deviceGroupMap!==mapType&&item.bigType===TemplateLayoutType.SampleLayout&&item.createStrategy===SampleMapCreateStrategyEnum.byAssignTag)continue;item.id=index++;slides.push(item)}defer.resolve()})).catch((function(ee){console.error("loadData error.",ee)}));return defer.promise}function setCurrentLayout(layoutId){var index=_.findIndex(slides,{layoutId:layoutId});index<0&&(index=0);$scope.selectedLayoutItem=slides[index];$scope.actualOption.active=slides[index].id}function doSlideMouseOverEvent(){$timeout((function(){element.find(".layout-item-tool").on("mouseenter",(function(){isOnSlideElement=!0})).on("mouseleave",(function(){isOnSlideElement=!1;$scope.showRightSideTool=!1;try{$scope.$digest()}catch(e){console.warn("doSlideMouseOverEvent error")}}))}),0)}function doHighlightMap(){!function(isShow){highlightDeviceIdList.splice(0,highlightDeviceIdList.length);var idList=pageService.quickShowOrHideHighlightBg(isShow,matchedNodeKeys);for(var z=0;z<idList.length;z++)highlightDeviceIdList.push(idList[z])}($scope.highlightDevice.highlightDevice)}$scope.onClickDirection=function(orientation){var item=$scope.selectedLayoutItem;var previousOrientation=item.originalLayout.orientation;item.originalLayout.orientation=orientation;item.image=mapLayoutTypeIconList[item.originalLayout.type][orientation].size110;tools.rotateMap(previousOrientation,orientation);orientation};$scope.onRouteBtnMouseEnter=function(){$scope.showRotationsBox=!0;$timeout((function(){element.find(".tool-bt-rotate-ul").on("mouseenter",(function(){isOnRotationsBoxElement=!0})).on("mouseleave",(function(){isOnRotationsBoxElement=!1;$scope.showRotationsBox=!1;try{$scope.$digest()}catch(e){console.warn("doRotationsBoxsMouseOverEvent error")}}))}),0)};$scope.onRouteBtnMouseLeave=function(){$timeout((function(){isOnRotationsBoxElement||($scope.showRotationsBox=!1)}),20)};$scope.onSlideClick=function(){if(!1===$scope.isAutoApply.value){$scope.isAutoApply.value=!0;$scope.isLoading=!0;applyLayoutStyle($scope.selectedLayoutItem).then((function(){$scope.isLoading=!1}))}};$scope.onSlideMouseEnter=function(){if($scope.selectedLayoutItem.bigType===TemplateLayoutType.MapLayout){$scope.showRightSideTool=!0;$scope.showRightSideToolRotateBtn=!0;$scope.hideRightSideToolRotateBtnCss={};$scope.showRightSideToolEditBtn=!0;$scope.showRightSideToolOpenBtn=!1;doSlideMouseOverEvent()}if($scope.selectedLayoutItem.bigType===TemplateLayoutType.SampleLayout){$scope.showRightSideTool=!0;$scope.showRightSideToolRotateBtn=!1;$scope.hideRightSideToolRotateBtnCss={"margin-top":"0"};$scope.showRightSideToolEditBtn=!1;$scope.showRightSideToolOpenBtn=!0;doSlideMouseOverEvent()}if($scope.selectedLayoutItem.bigType===TemplateLayoutType.GeometryLayout){$scope.showRightSideTool=!1;$scope.showRightSideToolRotateBtn=!0;$scope.hideRightSideToolRotateBtnCss={};$scope.showRightSideToolEditBtn=!1;$scope.showRightSideToolOpenBtn=!1}};$scope.onSlideMouseLeave=function(){$timeout((function(){isOnSlideElement||($scope.showRightSideTool=!1)}),20)};$scope.onChangeLayoutDropdownInMiniPane=function(item){NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&($scope.actualOption.active=item.id)};$scope.$on("highlightMatchedDevices",(function(event,isHighlight){$scope.onCheckHighlightClick(isHighlight)}));$scope.onCheckHighlightClick=function(isHighlight){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){!1===isHighlight&&$scope.highlightDevice.highlightDevice||($scope.highlightDevice.highlightDevice=!$scope.highlightDevice.highlightDevice);doHighlightMap()}};$scope.onRefreshClick=function(){$scope.isLoading=!0;innerChangedStatus.value=!0;var layoutId=$scope.selectedLayoutItem.layoutId;NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&pageService.refreshCache().then((function(){return pageService.getAllLayouts(filterSimilarityFunctionHandler)})).then((function(){loadData().then((function(){$scope.highlightDevice.highlightDevice||highlightDeviceIdList.splice(0,highlightDeviceIdList.length);setCurrentLayout(layoutId);if($scope.isAutoApply.value){applyLayoutStyle($scope.selectedLayoutItem).then((function(){innerChangedStatus.value=!1;$scope.isLoading=!1}))}else $timeout((function(){innerChangedStatus.value=!1;$scope.isLoading=!1}))}))}))};var funcOnChangeLayoutCallback=null;$scope.funcOnChangeLayoutCallback=function(func){funcOnChangeLayoutCallback=func};$scope.setCurrentLayout=function(layoutId,_matchedNodeKeys){innerChangedStatus.value=!0;setCurrentLayout(layoutId);$timeout((function(){innerChangedStatus.value=!1}));_matchedNodeKeys&&(matchedNodeKeys=_matchedNodeKeys)};$scope.firstPaneOption={isShow:!0,showOption:{option:{isRealShow:!0}}};$scope.onMaxClick=function(){mapManagerSrvc.getActivePage().currentScopeRef.showMapLayoutPane();if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){var elementIdBuilder=NetBrain.MapLayout.Const.elementIdBuilder;if(angular.element(elementIdBuilder.getFirstPaneId(mapPageId)).length>0){funcOnChangeLayoutCallback($scope.selectedLayoutItem.layoutId,$scope.selectedLayoutItem.bigType,matchedNodeKeys);$scope.firstPaneOption.showOption.option={isRealShow:!0}}else{$scope.firstPaneOption.mapPageId=mapPageId;$scope.firstPaneOption.containerId=containerId;$scope.firstPaneOption.layoutId=$scope.selectedLayoutItem.layoutId;$scope.firstPaneOption.bigType=$scope.selectedLayoutItem.bigType;$scope.firstPaneOption.miniPaneShowOption=$scope.showOption;$scope.firstPaneOption.forceRefreshMiniPaneWithFirst=$scope.forceRefreshMiniPaneWithFirst;$scope.firstPaneOption.forceRefreshMiniPaneWithDetail=$scope.forceRefreshMiniPaneWithDetail;$scope.firstPaneOption.setCurrentLayout=$scope.setCurrentLayout;var $newElement=$compile('<nb-map-layout-first-pane-directive options-out="firstPaneOption" show-option="firstPaneOption.showOption" callback="funcOnChangeLayoutCallback(func)" ></nb-map-layout-first-pane-directive>')($scope);angular.element(containerId).append($newElement)}}$scope.showOption.isRealShow=!1};$scope.detailPaneOption={isShow:!0,showOption:{isRealShow:!0}};$scope.onMiniPaneMapLayoutEditClick=function(){mapManagerSrvc.getActivePage().currentScopeRef.showMapLayoutPane();if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){var elementIdBuilder=NetBrain.MapLayout.Const.elementIdBuilder;$document.find(elementIdBuilder.getDetailPaneId(mapPageId)).length>0?$scope.detailPaneOption.showOption={isRealShow:!0}:pageService.getMapLayouts(filterSimilarityFunctionHandler).then((function(result){var mapLayoutList=_.filter(convertLayout(categoryMgr,result),(function(item){return item.type===$scope.selectedLayoutItem.originalLayout.type}));if(mapLayoutList.length>0){var mapLayoutItem=mapLayoutList[0];var layoutId=$scope.selectedLayoutItem.originalLayout.id;var currentLayoutIndex=_.findIndex(mapLayoutItem.layouts,{id:layoutId});currentLayoutIndex>=0&&(mapLayoutItem.currentLayout=mapLayoutItem.layouts[currentLayoutIndex]);$scope.detailPaneOption.mapPageId=mapPageId;$scope.detailPaneOption.containerId=containerId;$scope.detailPaneOption.miniPaneShowOption=$scope.showOption;$scope.detailPaneOption.layoutItem=mapLayoutItem;$scope.detailPaneOption.currentStyleId=mapLayoutItem.currentStyleId;$scope.detailPaneOption.forceRefreshMiniPaneWithDetail=$scope.forceRefreshMiniPaneWithDetail;$scope.detailPaneOption.fromType="miniPane";$scope.detailPaneOption.setCurrentLayout=$scope.setCurrentLayout;var $newElement=$compile('<nb-map-layout-detail-pane-directive options-out="detailPaneOption" show-option="detailPaneOption.showOption" ></nb-map-layout-detail-pane-directive>')($scope);angular.element(containerId).append($newElement)}}))}$scope.showOption.isRealShow=!1};$scope.forceRefreshMiniPaneWithFirst=function(currentLayoutId){return pageService.refreshCache().then((function(){return loadData().then((function(){$scope.setCurrentLayout(currentLayoutId);return $q.resolve()}))}))};$scope.forceRefreshMiniPaneWithDetail=function(layoutItemType,currentLayoutId){return pageService.refreshCache().then((function(){return loadData().then((function(){return pageService.getMapLayouts(filterSimilarityFunctionHandler).then((function(result){var mapLayoutItem;var mapLayoutList=_.filter(convertLayout(categoryMgr,result),(function(item){return item.type===layoutItemType}));if(mapLayoutList.length>0){mapLayoutItem=mapLayoutList[0];var currentLayoutIndex=_.findIndex(mapLayoutItem.layouts,{id:currentLayoutId});mapLayoutItem.currentLayout=currentLayoutIndex>=0?mapLayoutItem.layouts[currentLayoutIndex]:mapLayoutItem.layouts[0];$scope.setCurrentLayout(mapLayoutItem.currentLayout.id)}else{mapLayoutItem=null;$scope.setCurrentLayout("-1")}return $q.resolve(mapLayoutItem)}))}))}))};$scope.onMiniPaneOpenMapClick=function(){var sampleLayoutItem=$scope.selectedLayoutItem;var sampleLayoutId=sampleLayoutItem.layoutId;var bigType=sampleLayoutItem.bigType;openSampleMap(mapPageId,sampleLayoutId,bigType,urlStateMgr)};$scope.onCloseClick=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){var elementIdBuilder=NetBrain.MapLayout.Const.elementIdBuilder;angular.element(elementIdBuilder.getFirstPaneId(mapPageId)).length>0&&($scope.firstPaneOption.showOption.option={isClose:!0})}$timeout((function(){element.remove();$scope.$destroy()}),10)};function applyLayoutStyle(selected){var defer=$q.defer();updateMapSrvc.canUpdateCurrentMap().then((function(){(function(selected){var defer=$q.defer();var done=!1;if(selected.bigType===TemplateLayoutType.MapLayout){var changeToLayout=_.clone(selected.originalLayout);$timeout((function(){!function(_previousOrientation,changeToLayout){NetBrain.MapLayout.Const.convertToScale(changeToLayout);changeToLayout.type===MapLayoutType.multiTier?matchedNodeKeys=tools.parallelStyleLayout(changeToLayout):changeToLayout.type===MapLayoutType.pairing?matchedNodeKeys=tools.symmetricalParallelStyleLayout(changeToLayout):changeToLayout.type===MapLayoutType.pie?matchedNodeKeys=tools.petalLayout(changeToLayout):changeToLayout.type===MapLayoutType.circle&&(matchedNodeKeys=tools.ringLayout(changeToLayout));var changeToOrientation=changeToLayout.orientation;tools.rotateMap(OrientationEnum.tt,changeToOrientation)}(0,changeToLayout);changeToLayout.orientation;doHighlightMap();done=!0;defer.resolve()}),0)}if(selected.bigType===TemplateLayoutType.SampleLayout){var SampleMapCreateStrategyEnum=NetBrain.MapLayout.Const.SampleMapCreateStrategy;selected.originalLayout.createStrategy===SampleMapCreateStrategyEnum.byHostName?$timeout((function(){matchedNodeKeys=tools.sampleMapByDeviceLayout(selected.originalLayout.content);doHighlightMap();done=!0;defer.resolve()}),0):selected.originalLayout.createStrategy===SampleMapCreateStrategyEnum.byAssignTag&&selected.originalLayout.content&&$timeout((function(){matchedNodeKeys=tools.sampleMapByTagLayout(selected.originalLayout.content);doHighlightMap();done=!0;defer.resolve()}),0)}selected.bigType===TemplateLayoutType.GeometryLayout&&$timeout((function(){updateMapSrvc.canUpdateCurrentMap().then((function(){selected.originalLayout.action();pageService.quickShowOrHideHighlightBg(!1,[]);done=!0;defer.resolve()}))}),0);!1===done&&defer.reject();return defer.promise})(selected).then((function(){defer.resolve()}),(function(){defer.resolve()}))}),(function(){defer.resolve()}));return defer.promise}var watchSlideActive=$scope.$watch("actualOption.active",(function(newValue){if(!innerChangedStatus.value){$scope.isLoading=!0;if((newValue||0===newValue)&&newValue>=0){var selected=_.find(slides,(function(item){return item.id===newValue}));!0===$scope.isAutoApply.value?applyLayoutStyle(selected).then((function(){$scope.isLoading=!1})):$scope.isLoading=!1;$scope.selectedLayoutItem=selected}$timeout((function(){$scope.isLoading=!1}),1e3)}}));var watchIsShowFunction=$scope.$watch("showOption.isRealShow",(function(value){var currentPageId="";NetBrain.Map.currentActiveMapPage&&(currentPageId=NetBrain.Map.currentActiveMapPage.getDocId());if(mapPageId===currentPageId&&!isFirstShow){!0===value&&($scope.options.isShow=!0);!1===value&&($scope.options.isShow=!1);!0===value.isClose&&currentPageId===mapPageId&&$timeout((function(){element.remove();$scope.$destroy()}),0)}}));var watchCloseMapLayoutInMiniPane=$rootScope.$on(MapLayoutEvent.CLOSE_MAP_LAYOUT,(function(){$scope.onCloseClick()}));!function(el){$rootScope.$broadcast(MapTabEvent.Min_TAB_OUTSIDE);$timeout((function(){angular.element('[atag="map:mapPanelTab:minPanel"]').parent().hide()}),0);innerChangedStatus.value=!0;$scope.isLoading=!0;el.draggable({containment:".realActive .map-canvas-containter"});$timeout((function(){}),0);loadData().then((function(){if(slides.length>0){$scope.selectedLayoutItem=slides[0];$scope.actualOption.active=slides[0].id}isFirstShow=!1;innerChangedStatus.value=!1;$scope.isLoading=!1}))}(element);$scope.$on("$destroy",(function(){$timeout((function(){angular.element('[atag="map:mapPanelTab:minPanel"]').parent().show()}),0);$scope.highlightDevice.highlightDevice=!1;doHighlightMap();watchSlideActive();watchIsShowFunction();watchCloseMapLayoutInMiniPane();mapLayoutSrvc.destroyPageService(mapPageId)}))}}(NetBrain);!function(netBrain){angular.module("nb.qmap").directive("nbMapLayoutFirstPaneDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutFirstPaneDirective.html",scope:{optionsOut:"=",showOption:"=",callback:"&"},link:function(scope,element,attrs,carouselCtrl){},controller:Controller,replace:!0}}]);Controller.$inject=["$compile","$scope","$document","$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.netbrain.httpDeviceSrvc","nb.common.nbTipSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","uiGridTreeBaseService","$uibModal","nb.qmap.httpMapLayoutSrvc","nb.qmap.mapLayoutSrvc","nb.common.nbDragDropSrvc","nb.uiframework.urlStateMgr"];function Controller($compile,$scope,$document,element,attr,$timeout,$rootScope,$q,mapManagerSrvc,httpDeviceSrvc,nbTipSrvc,mapContextMenuManager,updateMapSrvc,uiGridTreeBaseService,$uibModal,httpMapLayoutSrvc,mapLayoutSrvc,nbDragDropSrvc,urlStateMgr){$scope.options=_.clone($scope.optionsOut);var containerId=$scope.options.containerId;var mapPageId=$scope.options.mapPageId;var isFirstShow=!0;var tools=null;var pageService=null;var categoryMgr=netBrain.Map.CategoryMgr;$scope.orientationEnum=NetBrain.MapLayout.Const.OrientationEnum;var MapLayoutType=NetBrain.MapLayout.Const.MapLayoutType;var TemplateLayoutType=NetBrain.MapLayout.Const.TemplateLayoutType;var OrientationEnum=NetBrain.MapLayout.Const.OrientationEnum;var isOnSlideElement=!1;var isOnRotationsBoxElement=!1;var highlightDeviceIdList=NetBrain.MapLayout.Const.MapLayoutHighlightOption.getDeviceIdList(mapPageId);$scope.highlightDevice=NetBrain.MapLayout.Const.MapLayoutHighlightOption.getHighLightDevice(mapPageId);var filterSimilarityFunctionHandler=NetBrain.MapLayout.Const.filterSimilarityFunctionHandler;var convertLayout=NetBrain.MapLayout.Const.convertLayout;var getGeometryIconName=NetBrain.MapLayout.Const.getGeometryIconName;var getGeometryName=NetBrain.MapLayout.Const.getGeometryName;var innerChangedStatus=NetBrain.MapLayout.Const.innerChangedStatus;var openSampleMap=NetBrain.MapLayout.Const.openSampleMap;var SampleMapCreateStrategyEnum=NetBrain.MapLayout.Const.SampleMapCreateStrategy;$scope.rotateUlStyle={};OrientationEnum.tt;$scope.isShowHighlight=!1;$scope.isAutoApply=NetBrain.MapLayout.Const.isAutoApply;var matchedNodeKeys=[];function getRotateId(currentStyleId){return"[rotate-ul-current-style-id=rotate-ul-"+mapPageId+"-"+currentStyleId+"]"}function setCurrentStyle(layoutId,bigType,_matchedNodeKeys){if(bigType===TemplateLayoutType.MapLayout)for(var i=0;i<$scope.mapLayoutList.length;i++){var mapLayoutItem=$scope.mapLayoutList[i];var layoutIndex=_.findIndex(mapLayoutItem.layouts,{id:layoutId});if(layoutIndex>=0){var mapLayout=mapLayoutItem.layouts[layoutIndex];$scope.currentStyleId.id=mapLayoutItem.currentStyleId;$scope.currentStyleId.type=bigType;$scope.currentStyleId.layoutId=layoutId;mapLayoutItem.currentLayout=mapLayout;break}}if(bigType===TemplateLayoutType.SampleLayout){var index1=_.findIndex($scope.sampleMapLayoutByDeviceList,{layoutId:layoutId});if(index1>=0){$scope.currentStyleId.id=$scope.sampleMapLayoutByDeviceList[index1].currentStyleId;$scope.currentStyleId.type=bigType;$scope.currentStyleId.layoutId=layoutId}else if((index1=_.findIndex($scope.sampleMapLayoutByTagList,{layoutId:layoutId}))>=0){$scope.currentStyleId.id=$scope.sampleMapLayoutByTagList[index1].currentStyleId;$scope.currentStyleId.type=bigType;$scope.currentStyleId.layoutId=layoutId}}if(bigType===TemplateLayoutType.GeometryLayout){var index2=_.findIndex($scope.geometryLayoutList,{layoutId:layoutId});if(index2>=0){$scope.currentStyleId.id=$scope.geometryLayoutList[index2].currentStyleId;$scope.currentStyleId.type=bigType;$scope.currentStyleId.layoutId=layoutId}}_matchedNodeKeys&&(matchedNodeKeys=_matchedNodeKeys);return{}}function loadData(currentStyleId,_bigType){var defer=$q.defer();$scope.showTagLayoutList=!0;$scope.tagsViewExpanded=!0;$scope.tagsViewShowMore=!0;$scope.tagsLayoutCss={};$scope.tagsListCss={};$scope.showSampleMapLayoutList=!0;$scope.sampleViewExpanded=!0;$scope.sampleViewShowMore=!0;$scope.sampleViewCss={};$scope.sampleListCss={};$scope.showGeometryLayoutList=!0;$scope.geometryViewExpanded=!0;$scope.geometryViewShowMore=!0;$scope.geometryLayoutCss={};$scope.geometryListCss={};$scope.mapLayoutCount=0;$scope.currentStyleId={id:"-1",type:"",layoutId:""};if(currentStyleId){$scope.currentStyleId.id=currentStyleId;$scope.currentStyleId.type=_bigType}OrientationEnum.tt;var qList=[(pageService=mapLayoutSrvc.getPageService(mapPageId)).getMapLayouts(filterSimilarityFunctionHandler),pageService.getSampleMaps(filterSimilarityFunctionHandler),pageService.getGeometries(filterSimilarityFunctionHandler)];$q.all(qList).then((function(result){$scope.mapLayoutList=convertLayout(categoryMgr,result[0]);var sampleMapList=(sampleMaps=result[1],_.chain(sampleMaps).map((function(item,id){var iconObj=null;var smallImg="";var iconType="class";var imgStyle={};try{iconObj=JSON.parse(item.iconString)}catch(e){console.error(e)}if(iconObj){smallImg=iconObj.smallImg;iconType="image";var img=new Image;img.src=smallImg;imgStyle=img.height>img.width?{height:"100%"}:{width:"100%"}}else{smallImg="layout_by_tags_highlight";iconType="class";imgStyle={width:"70px",height:"70px"}}return{id:id,text:item.name,image:smallImg,iconType:iconType,matchedCount:item.matchedCount,similarityCoefficientPercentage:item.similarityCoefficientPercentage,bigType:TemplateLayoutType.SampleLayout,createStrategy:item.createStrategy,originalLayout:item,orientation:OrientationEnum.tt,layoutId:item.id,imgStyle:imgStyle}})).map((function(item){return _.extend({},{currentStyleId:item.layoutId},item)})).value());var sampleMaps;$scope.sampleMapLayoutByDeviceList=_.where(sampleMapList,{createStrategy:SampleMapCreateStrategyEnum.byHostName});$scope.sampleMapLayoutByTagList=_.where(sampleMapList,{createStrategy:SampleMapCreateStrategyEnum.byAssignTag});$scope.geometryLayoutList=(Geometries=result[2],_.chain(Geometries).map((function(item,id){return{id:id,text:getGeometryName(item.bigImage),oldText:item.title,image:getGeometryIconName(item.bigImage),image70:getGeometryIconName(item.bigImage,"s70"),matchedCount:0,bigType:TemplateLayoutType.GeometryLayout,originalLayout:item,orientation:OrientationEnum.tt,layoutId:item.id}})).map((function(item){return _.extend({},{currentStyleId:item.text},item)})).value());var Geometries;if("-1"===$scope.currentStyleId.id&&!0===$scope.isAutoApply.value){setCurrentStyle($scope.options.layoutId,$scope.options.bigType)}var mapType=netBrain.Map.currentActiveMap.qmapJsWrapper.qmapdata.mapType;if(NetBrain.Map.Const.MapType.overViewMap===mapType){$scope.showTagLayoutList=!1;$scope.showSampleMapLayoutList=!1;$scope.sampleMapLayoutByTagList=[]}else NetBrain.Map.Const.MapType.siteMap!==mapType&&NetBrain.Map.Const.MapType.deviceGroupMap!==mapType&&($scope.sampleMapLayoutByTagList=[]);var countList=_.map($scope.mapLayoutList,(function(item){return item.layouts.length}));$scope.mapLayoutCount=countList.reduce((function(x,y){return x+y}),0);$scope.mapLayoutCount+=$scope.sampleMapLayoutByTagList.length;$timeout((function(){element.find(".minipane-layout-dropdown button.dropdown-toggle .caret").removeClass("caret").addClass("icon_nb_arrow_down")}),0);tools=mapLayoutSrvc.getLayoutToolsHelper(mapPageId);defer.resolve()}));return defer.promise}function doLayoutStyle(_previousOrientation,changeToLayout){NetBrain.MapLayout.Const.convertToScale(changeToLayout);changeToLayout.type===MapLayoutType.multiTier?matchedNodeKeys=tools.parallelStyleLayout(changeToLayout):changeToLayout.type===MapLayoutType.pairing?matchedNodeKeys=tools.symmetricalParallelStyleLayout(changeToLayout):changeToLayout.type===MapLayoutType.pie?matchedNodeKeys=tools.petalLayout(changeToLayout):changeToLayout.type===MapLayoutType.circle&&(matchedNodeKeys=tools.ringLayout(changeToLayout));var changeToOrientation=changeToLayout.orientation;tools.rotateMap(OrientationEnum.tt,changeToOrientation)}function doHighlightMapCheck(highlight){$scope.highlightDevice.highlightDevice=highlight;-1!=$scope.currentStyleId.id&&doHighlightMap()}function doHighlightMap(){!function(isShow){highlightDeviceIdList.splice(0,highlightDeviceIdList.length);if(getSelectedLayoutItem()){var idList=pageService.quickShowOrHideHighlightBg(isShow,matchedNodeKeys);for(var z=0;z<idList.length;z++)highlightDeviceIdList.push(idList[z])}}($scope.highlightDevice.highlightDevice)}function hideHighlightMap(){pageService.quickShowOrHideHighlightBg(!1,[])}function getSelectedLayoutItem(){var selectedLayoutItem;if($scope.currentStyleId.type===TemplateLayoutType.MapLayout){var mapLayout=_.find($scope.mapLayoutList,(function(item){return item.currentStyleId===$scope.currentStyleId.id}));selectedLayoutItem={bigType:TemplateLayoutType.MapLayout,originalLayout:mapLayout.currentLayout}}$scope.currentStyleId.type===TemplateLayoutType.SampleLayout&&((selectedLayoutItem=_.find($scope.sampleMapLayoutByDeviceList,(function(item){return item.currentStyleId===$scope.currentStyleId.id})))||(selectedLayoutItem=_.find($scope.sampleMapLayoutByTagList,(function(item){return item.currentStyleId===$scope.currentStyleId.id}))));$scope.currentStyleId.type===TemplateLayoutType.GeometryLayout&&(selectedLayoutItem=_.find($scope.geometryLayoutList,(function(item){return item.currentStyleId===$scope.currentStyleId.id})));return selectedLayoutItem}$scope.hasRotationMoreThenOne=function(currentLayout){var list=[];currentLayout.imgSize70.t&&list.push(currentLayout.imgSize70.t);currentLayout.imgSize70.b&&list.push(currentLayout.imgSize70.b);currentLayout.imgSize70.l&&list.push(currentLayout.imgSize70.l);currentLayout.imgSize70.r&&list.push(currentLayout.imgSize70.r);return list.length>1};$scope.onClickGeometryExpanded=function(){$scope.geometryViewExpanded=!$scope.geometryViewExpanded;if($scope.geometryViewExpanded){$scope.geometryLayoutCss={};$scope.onClickGeometryViewMore($scope.geometryViewShowMore)}else $scope.geometryLayoutCss={height:"28px",overflow:"hidden"}};$scope.onClickGeometryViewMore=function(showMore){$scope.geometryViewShowMore=showMore;$scope.geometryViewShowMore?$scope.geometryListCss={}:$scope.geometryListCss={height:"auto"}};$scope.onClickSampleExpanded=function(){$scope.sampleViewExpanded=!$scope.sampleViewExpanded;if($scope.sampleViewExpanded){$scope.sampleViewCss={};$scope.onClickSampleViewMore($scope.sampleViewShowMore)}else $scope.sampleViewCss={height:"28px",overflow:"hidden"}};$scope.onClickSampleViewMore=function(showMore){$scope.sampleViewShowMore=showMore;$scope.sampleViewShowMore?$scope.sampleListCss={}:$scope.sampleListCss={height:"auto"}};$scope.onClickTagsExpanded=function(){$scope.tagsViewExpanded=!$scope.tagsViewExpanded;if($scope.tagsViewExpanded){$scope.tagsLayoutCss={overflow:"visible"};$scope.onClickTagsViewMore($scope.tagsViewShowMore)}else $scope.tagsLayoutCss={height:"28px",overflow:"hidden"}};$scope.onClickTagsViewMore=function(showMore){$scope.tagsViewShowMore=showMore;$scope.tagsViewShowMore?$scope.tagsListCss={}:$scope.tagsListCss={height:"auto"}};$scope.highlightSampleLayout=function(index,event,sampleLayout,sampleLayoutItem,isHighlight){NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&(sampleLayoutItem.currentStyleId!==$scope.currentStyleId.id||!matchedNodeKeys||matchedNodeKeys&&0===matchedNodeKeys.length?doClickSampleLayout(index,event,sampleLayout,sampleLayoutItem,!1).then((function(){doHighlightMapCheck(!isHighlight)}),(function(){})):doHighlightMapCheck(!$scope.highlightDevice.highlightDevice))};$scope.highlightTagLayout=function(currIndex,event,layout,layoutItem,isHighlight){NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&(layoutItem.currentStyleId!==$scope.currentStyleId.id||!matchedNodeKeys||matchedNodeKeys&&0===matchedNodeKeys.length?doClickTagsLayout(currIndex,event,layout,layoutItem,!1).then((function(){doHighlightMapCheck(!isHighlight)}),(function(){})):doHighlightMapCheck(!$scope.highlightDevice.highlightDevice))};$scope.onClickGeometryLayout=function(geometryLayout,currentStyleId){NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&updateMapSrvc.canUpdateCurrentMap().then((function(){geometryLayout.action();$scope.currentStyleId.id=currentStyleId;$scope.currentStyleId.type=TemplateLayoutType.GeometryLayout;$scope.currentStyleId.layoutId=geometryLayout.id;matchedNodeKeys=[];$scope.options.setCurrentLayout(geometryLayout.id,matchedNodeKeys);hideHighlightMap();$scope.isAutoApply.value=!0}))};$scope.onClickSampleLayout=function(index,event,sampleLayout,sampleLayoutItem){NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&doClickSampleLayout(index,event,sampleLayout,sampleLayoutItem,!0)};function doClickSampleLayout(index,event,sampleLayout,sampleLayoutItem,needHighlight){return updateMapSrvc.canUpdateCurrentMap().then((function(){sampleLayout.createStrategy===SampleMapCreateStrategyEnum.byHostName?matchedNodeKeys=tools.sampleMapByDeviceLayout(sampleLayout.content):sampleLayout.createStrategy===SampleMapCreateStrategyEnum.byAssignTag&&sampleLayout.content&&(matchedNodeKeys=tools.sampleMapByTagLayout(sampleLayout.content));$scope.currentStyleId.id=sampleLayoutItem.currentStyleId;$scope.currentStyleId.type=TemplateLayoutType.SampleLayout;$scope.currentStyleId.layoutId=sampleLayout.id;$scope.options.setCurrentLayout(sampleLayout.id,matchedNodeKeys);needHighlight&&doHighlightMap();$scope.isAutoApply.value=!0}))}$scope.onChangeLayoutDropdownInFirstPane=function(event,layout,layoutItem){NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&updateMapSrvc.canUpdateCurrentMap().then((function(){var changeToLayout=_.clone(layout);doLayoutStyle(0,changeToLayout);changeToLayout.orientation;$scope.currentStyleId.id=layoutItem.currentStyleId;$scope.currentStyleId.type=TemplateLayoutType.MapLayout;$scope.currentStyleId.layoutId=layout.id;layoutItem.currentLayout=layout;$scope.options.setCurrentLayout(layout.id,matchedNodeKeys);doHighlightMap();$scope.isAutoApply.value=!0}))};$scope.onClickTagsLayout=function(currIndex,event,layout,layoutItem){NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&doClickTagsLayout(currIndex,event,layout,layoutItem,!0)};function doClickTagsLayout(currIndex,event,layout,layoutItem,needHighlight){return updateMapSrvc.canUpdateCurrentMap().then((function(){layoutItem.currentStyleId!==$scope.currentStyleId.id&&OrientationEnum.tt;var changeToLayout=_.clone(layout);doLayoutStyle(0,changeToLayout);changeToLayout.orientation;$scope.currentStyleId.id=layoutItem.currentStyleId;$scope.currentStyleId.type=TemplateLayoutType.MapLayout;$scope.currentStyleId.layoutId=layout.id;$scope.options.setCurrentLayout(layout.id,matchedNodeKeys);needHighlight&&doHighlightMap();$scope.isAutoApply.value=!0}))}$scope.detailPaneOption={isShow:!0,showOption:{isRealShow:!0}};$scope.onMapLayoutEditClick=function(event,layoutItem){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){var elementIdBuilder=NetBrain.MapLayout.Const.elementIdBuilder;if(angular.element(elementIdBuilder.getDetailPaneId(mapPageId)).length>0)$scope.detailPaneOption.showOption={isRealShow:!0};else{$scope.detailPaneOption.mapPageId=mapPageId;$scope.detailPaneOption.containerId=containerId;$scope.detailPaneOption.firstPaneShowOption=$scope.showOption;$scope.detailPaneOption.layoutItem=layoutItem;$scope.detailPaneOption.currentStyleId=$scope.currentStyleId;$scope.detailPaneOption.forceRefreshFirstPane=$scope.forceRefreshFirstPane;$scope.detailPaneOption.fromType="firstPane";$scope.detailPaneOption.setCurrentStyle=setCurrentStyle;$scope.detailPaneOption.setCurrentLayout=$scope.options.setCurrentLayout;var $newElement=$compile('<nb-map-layout-detail-pane-directive options-out="detailPaneOption" show-option="detailPaneOption.showOption" ></nb-map-layout-detail-pane-directive>')($scope);$(document).find(".pageContent").append($newElement)}}$scope.showOption.isRealShow=!1};$scope.forceRefreshFirstPane=function(layoutItemType,currentLayoutId,bigType,currentStyleId){return $scope.options.forceRefreshMiniPaneWithDetail(layoutItemType,currentLayoutId).then((function(layoutItem){return loadData(currentStyleId,bigType).then((function(){return $q.resolve(layoutItem)}))}))};$scope.onMapLayoutClickDirection=function(orientation,currentLayout,layoutItem,currIndex,event){if(layoutItem.currentStyleId!==$scope.currentStyleId.id){OrientationEnum.tt;currentLayout.orientation=orientation;$scope.onClickTagsLayout(currIndex,event,currentLayout,layoutItem.currentStyleId)}else{var previousOrientation=currentLayout.orientation;currentLayout.orientation=orientation;tools.rotateMap(previousOrientation,orientation);orientation}};$scope.onOpenMapClick=function(event,sampleLayoutItem){var sampleLayoutId=sampleLayoutItem.layoutId;var bigType=sampleLayoutItem.bigType;openSampleMap(mapPageId,sampleLayoutId,bigType,urlStateMgr)};$scope.onSampleLayoutMouseEnter=function(event,sampleLayout){sampleLayout.showRightSideTool=!0;!function(event,sampleLayout){$timeout((function(){angular.element(event.target).find(".sample-item-tool").on("mouseenter",(function(){isOnSlideElement=!0})).on("mouseleave",(function(){isOnSlideElement=!1;sampleLayout.showRightSideTool=!1;try{$scope.$digest()}catch(e){console.error("doSampleLayoutMouseOverEvent error")}}))}),0)}(event,sampleLayout)};$scope.onSampleLayoutMouseLeave=function(event,sampleLayout){$timeout((function(){isOnSlideElement||(sampleLayout.showRightSideTool=!1)}),20)};$scope.onMapLayoutMouseEnter=function(event,layout){layout.showRightSideTool=!0;!function(event,layout){$timeout((function(){angular.element(event.target).find(".layout-item-tool").on("mouseenter",(function(){isOnSlideElement=!0})).on("mouseleave",(function(){isOnSlideElement=!1;layout.showRightSideTool=!1;try{$scope.$digest()}catch(e){console.error("doMapLayoutMouseOverEvent error")}}))}),0)}(event,layout)};$scope.onMapLayoutMouseLeave=function(event,layout){$timeout((function(){isOnSlideElement||(layout.showRightSideTool=!1)}),20)};$scope.onMapLayoutRouteBtnMouseEnter=function(event,layout,currentStyleId){layout.showRotationsBox=!0;!function(event,layout,currentStyleId){$timeout((function(){angular.element(event.target).find(".tool-bt-rotate-ul").on("mouseenter",(function(){isOnRotationsBoxElement=!0})).on("mouseleave",(function(){isOnRotationsBoxElement=!1;layout.showRotationsBox=!1;try{$scope.$digest()}catch(e){console.error("domapLayoutRouteBtnMouseOverEvent error")}}))}),0)}(event,layout)};$scope.onMapLayoutRouteBtnMouseLeave=function(event,layout){$timeout((function(){isOnRotationsBoxElement||(layout.showRotationsBox=!1)}),300)};$scope.onFirstPaneCheckHighlightClick=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){$scope.highlightDevice.highlightDevice=!$scope.highlightDevice.highlightDevice;-1!=$scope.currentStyleId.id&&doHighlightMap()}};function applyLayoutForRefresh(){var defer=$q.defer();updateMapSrvc.canUpdateCurrentMap().then((function(){(function(){var defer=$q.defer();var selectedLayoutItem=getSelectedLayoutItem();if(selectedLayoutItem)if($scope.currentStyleId.type===TemplateLayoutType.MapLayout){var changeToLayout=_.clone(selectedLayoutItem.originalLayout);doLayoutStyle(OrientationEnum.tt,changeToLayout);doHighlightMap();$scope.options.setCurrentLayout(changeToLayout.id,matchedNodeKeys);defer.resolve()}else if($scope.currentStyleId.type===TemplateLayoutType.SampleLayout){var sampleLayout=selectedLayoutItem.originalLayout;sampleLayout.createStrategy===SampleMapCreateStrategyEnum.byHostName?matchedNodeKeys=tools.sampleMapByDeviceLayout(sampleLayout.content):sampleLayout.createStrategy===SampleMapCreateStrategyEnum.byAssignTag&&sampleLayout.content&&(matchedNodeKeys=tools.sampleMapByTagLayout(sampleLayout.content));doHighlightMap();$scope.options.setCurrentLayout(sampleLayout.id,matchedNodeKeys);defer.resolve()}else if($scope.currentStyleId.type===TemplateLayoutType.GeometryLayout){var geometryLayout=selectedLayoutItem.originalLayout;geometryLayout.action();matchedNodeKeys=[];$scope.options.setCurrentLayout(geometryLayout.id,matchedNodeKeys);hideHighlightMap();defer.resolve()}else defer.reject();else defer.reject();return defer.promise})().then((function(){defer.resolve()}),(function(){defer.resolve()}))}),(function(){defer.resolve()}));return defer.promise}$scope.onFirstPaneRefreshClick=function(){$scope.isLoading=!0;innerChangedStatus.value=!0;NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&$scope.options.forceRefreshMiniPaneWithFirst($scope.currentStyleId.layoutId).then((function(){loadData($scope.currentStyleId.id,$scope.currentStyleId.type).then((function(){$scope.highlightDevice.highlightDevice||highlightDeviceIdList.splice(0,highlightDeviceIdList.length);applyLayoutForRefresh().then((function(){innerChangedStatus.value=!1;$scope.isLoading=!1}))}))}))};$scope.onFirstPaneMinClick=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){mapManagerSrvc.getActivePage().currentScopeRef.hideMapLayoutPane();$scope.showOption.option={isRealShow:!1};$scope.optionsOut.miniPaneShowOption.isRealShow=!0}};$scope.onFirstPaneCloseClick=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){mapManagerSrvc.getActivePage().currentScopeRef.hideMapLayoutPane();var elementIdBuilder=NetBrain.MapLayout.Const.elementIdBuilder;angular.element(elementIdBuilder.getMiniPaneId(mapPageId)).length>0&&($scope.optionsOut.miniPaneShowOption.isRealShow={isClose:!0});$timeout((function(){element.remove();$scope.$destroy()}),10)}};$scope.onChangeLayout=function(layoutId,bigType,_matchedNodeKeys){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){$scope.options.layoutId=layoutId;$scope.options.bigType=bigType;setCurrentStyle(layoutId,bigType);_matchedNodeKeys&&(matchedNodeKeys=_matchedNodeKeys)}};var watchIsShowFunction=$scope.$watch("showOption.option",(function(value){if(mapPageId===NetBrain.Map.currentActiveMapPage.getDocId()&&!isFirstShow){if(!0===value.isRealShow){$scope.options.isShow=!0;element.dialog("open")}if(!1===value.isRealShow){$scope.options.isShow=!1;element.dialog("close")}if(!0===value.isClose){NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId&&$timeout((function(){destroy();element.remove();$scope.$destroy()}),0)}}}));var watchCloseMapLayoutInFirstPane=$rootScope.$on(MapLayoutEvent.CLOSE_MAP_LAYOUT,(function(){$scope.onFirstPaneCloseClick()}));!function(el){el.dialog({autoOpen:!1,appendTo:containerId,resizable:!1,dialogClass:"map-layout-first-pane-box",diaggable:!1,minHeight:500,minWidth:420,open:function(event){var tar=angular.element(event.target);tar.parent().css("cssText","border: 1px solid #c5c5c5 !important");try{$scope.$digest()}catch(e){}tar.parent().css({"min-height":"500px",width:"420px","min-width":"420px",height:"calc(100% - 1px)"});tar.parent().css({top:"0px",left:"0px"})}});el.dialog("open");isFirstShow=!1;loadData();$scope.callback({func:$scope.onChangeLayout})}(element);function destroy(){watchIsShowFunction();for(var i=0;i<$scope.mapLayoutList.length;i++)if((i+1)%3==0){var currentStyleId=$scope.mapLayoutList[i].currentStyleId;angular.element(getRotateId(currentStyleId)).remove()}}$scope.$on("$destroy",(function(){watchCloseMapLayoutInFirstPane();destroy()}))}}(NetBrain);!function(netBrain){angular.module("nb.qmap").directive("nbMapLayoutDetailPaneDirective",[function(){return{retrict:"E",templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutDetailPaneDirective.html",scope:{optionsOut:"=",netmapOperator:"=",showOption:"="},link:function(scope,element,attrs,carouselCtrl){},controller:Controller,replace:!0}}]);Controller.$inject=["$compile","$scope","$document","$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.netbrain.httpDeviceSrvc","nb.common.nbTipSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","uiGridTreeBaseService","$uibModal","nb.qmap.httpMapLayoutSrvc","nb.qmap.mapLayoutSrvc"];function Controller($compile,$scope,$document,element,attr,$timeout,$rootScope,$q,mapManagerSrvc,httpDeviceSrvc,nbTipSrvc,mapContextMenuManager,updateMapSrvc,uiGridTreeBaseService,$uibModal,httpMapLayoutSrvc,mapLayoutSrvc){$scope.options=_.clone($scope.optionsOut);$scope.layoutItem=$scope.optionsOut.layoutItem;var containerId=$scope.options.containerId;var mapPageId=$scope.options.mapPageId;var isFirstShow=!0;var tools=null;var pageService=null;var categoryMgr=netBrain.Map.CategoryMgr;var MapLayoutType=NetBrain.MapLayout.Const.MapLayoutType;var MapLayoutWording=NetBrain.MapLayout.Const.Wording.MapLayout;$scope.filterObj={matchedFilterValue:"",unassignedFilterValue:""};var needRunSelected=!0;$scope.showScrollStyle={};var runWatchScrollHeight=!1;var MapLayoutTypeIconList=NetBrain.MapLayout.Const.MapLayoutTypeIconList;$scope.mapLayoutTypeIconList=MapLayoutTypeIconList;$scope.orientationEnum=NetBrain.MapLayout.Const.OrientationEnum;$scope.mapLayoutTypeDirection=NetBrain.MapLayout.Const.MapLayoutTypeDirection;var TemplateLayoutType=NetBrain.MapLayout.Const.TemplateLayoutType;var highlightDeviceIdList=NetBrain.MapLayout.Const.MapLayoutHighlightOption.getDeviceIdList(mapPageId);$scope.highlightDevice=NetBrain.MapLayout.Const.MapLayoutHighlightOption.getHighLightDevice(mapPageId);var funcOnRefreshOrientation=null;var innerChangedStatus=NetBrain.MapLayout.Const.innerChangedStatus;$scope.isLoading=!1;var previousLayoutId="";var OrientationEnum=NetBrain.MapLayout.Const.OrientationEnum;var globalCurrentOrientation=OrientationEnum.tt;$scope.isShowHighlight=!1;$scope.isAutoApply=NetBrain.MapLayout.Const.isAutoApply;var matchedNodeKeys=[];function refreshMatchedGrid(currentLayout){var defer=$q.defer();var layeredLayout=function(layout){var resultLayout=_.clone(layout);for(var j=0;j<resultLayout.layers.length;j++){var layerItem=resultLayout.layers[j];for(var k=0;k<layerItem.tags.length;k++){var tagItem=layerItem.tags[k];for(var l=0;l<tagItem.devices.length;l++){var device=tagItem.devices[l];device.deviceName=device.hostName;device.deviceId=device.key;device.isPinned=!!device.isPinned}}}for(var i=0;i<resultLayout.unAssignedDevices.length;i++){var unAssignItem=resultLayout.unAssignedDevices[i];unAssignItem.deviceName=unAssignItem.hostName;unAssignItem.deviceId=unAssignItem.key;unAssignItem.isPinned=!!unAssignItem.isPinned}return resultLayout}(currentLayout);var deviceIds=_.pluck(layeredLayout.unAssignedDevices,"deviceId");httpMapLayoutSrvc.getDeviceTagByGuids(deviceIds).then((function(deviceData){var trueList=_.pluck(deviceData,"ID");var result=function(layeredLayout,trueList){var matchedLayerTagMenu=[];var unassignedLayerTagMenu=[{menuTitle:"None",layer:"None",tag:"None",no:NgUtil.getUniqueStr()}];var matchedList=[];for(var i=0;i<layeredLayout.layers.length;i++){var layer=layeredLayout.layers[i];var layerLevel=i+1;for(var j=0;j<layer.tags.length;j++){var tag=layer.tags[j];var layerTag="Layer "+layerLevel+":"+tag.name;var matchedCount="("+tag.devices.length+")";var matchedParent={feId:NgUtil.getUniqueStr(),isCheck:!1,layerTag:layerTag+matchedCount,layerLevel:layerLevel,tag:tag.name,deviceName:"",folderId:NgUtil.getUniqueStr(),deviceId:"",isPinned:!1,nodeType:"folder",$$treeLevel:0};matchedList.push(matchedParent);for(var k=0;k<tag.devices.length;k++){var device=tag.devices[k];var matchedDevice={feId:NgUtil.getUniqueStr(),isCheck:!1,layerTag:layerTag,layerLevel:layerLevel,tag:tag.name,deviceName:device.deviceName,folderId:"",deviceId:device.deviceId,isPinned:device.isPinned,nodeType:"node",$$treeLevel:1};matchedDevice.selected=layerTag;matchedDevice.oldTag=matchedDevice.tag;matchedList.push(matchedDevice)}var menuItem={menuTitle:layerTag,layerLevel:layerLevel,tag:tag.name,no:NgUtil.getUniqueStr()};matchedLayerTagMenu.push(menuItem);unassignedLayerTagMenu.push(menuItem)}}for(var m=0;m<matchedList.length;m++){matchedList[m].layerTagMenu=matchedLayerTagMenu}var unassignedList=[];for(var l=0;l<layeredLayout.unAssignedDevices.length;l++){var item=layeredLayout.unAssignedDevices[l];var isDevice=categoryMgr.isNetworkDevice(item.category);var isNonUnknowIp=!gDeviceMainTypeMgr.isUnknownIp(item.devType);var isTrue=!0;if(trueList&&_.isArray(trueList)){var trueIndex=_.indexOf(trueList,item.deviceId);isTrue=trueIndex>=0}if(isDevice&&isTrue&&isNonUnknowIp){var unassignedDevice={layerTag:"",layerLevel:0,tag:"None",deviceName:item.deviceName,deviceId:item.deviceId,isPinned:item.isPinned};unassignedDevice.layerTagMenu=unassignedLayerTagMenu;unassignedDevice.selected=unassignedLayerTagMenu[0].menuTitle;unassignedList.push(unassignedDevice)}}$scope.matchedLayerTagMenu=matchedLayerTagMenu;$scope.unassignedLayerTagMenu=unassignedLayerTagMenu;return{matchedList:matchedList,unassignedList:unassignedList}}(layeredLayout,trueList);$scope.matchedData=result.matchedList;$scope.unassignedData=result.unassignedList;$scope.layoutItem.currentLayout.unassignedDeviceCount=result.unassignedList.length;$scope.selectedLayout=$scope.layoutItem.currentLayout;isFirstShow||_.isFunction(funcOnRefreshOrientation)&&funcOnRefreshOrientation(currentLayout);defer.resolve()}));return defer.promise}function refresh(layoutItemType,currentLayoutId,bigType,currentStyleId){innerChangedStatus.value=!0;var defer=$q.defer();"firstPane"===$scope.options.fromType?$scope.options.forceRefreshFirstPane(layoutItemType,currentLayoutId,bigType,currentStyleId).then((function(layoutItem){if(layoutItem){$scope.layoutItem=layoutItem;refreshMatchedGrid(layoutItem.currentLayout).then((function(){showEmptyRow(!0);initSecondDivControlStatus();doLayoutStyleForRefresh().then((function(){doHighlightMap();innerChangedStatus.value=!1;$scope.isLoading=!1;$scope.noData=!1;defer.resolve()}))}))}else{innerChangedStatus.value=!1;$scope.isLoading=!1;$scope.noData=!0;defer.resolve()}})):"miniPane"===$scope.options.fromType&&$scope.options.forceRefreshMiniPaneWithDetail(layoutItemType,currentLayoutId).then((function(layoutItem){if(layoutItem){$scope.layoutItem=layoutItem;refreshMatchedGrid(layoutItem.currentLayout).then((function(){showEmptyRow(!0);initSecondDivControlStatus();doLayoutStyleForRefresh().then((function(){doHighlightMap();innerChangedStatus.value=!1;$scope.isLoading=!1;$scope.noData=!1;defer.resolve()}))}))}else{innerChangedStatus.value=!1;$scope.isLoading=!1;$scope.noData=!0;defer.resolve()}}));return defer.promise}$scope.selectedMatchedRows=[];$scope.selectedUnassignedRows=[];function initSecondDivControlStatus(){$scope.buttonStatus={saveTagsDisabled:!0,applyToMapDisabled:!0};$scope.selectedUnassignedRows=[];$scope.selectedMatchedRows=[];var matchedCheckAll=element.find(".is-check-all-in-matched-list")[0];matchedCheckAll&&(matchedCheckAll.indeterminate=!1);var unassignedCheckAll=element.find(".is-check-all-in-unassigned-list")[0];unassignedCheckAll&&(unassignedCheckAll.indeterminate=!1);$scope.isCheckAllOption={matchedCheck:!1,unassignedCheck:!1}}$scope.funcOnRefreshOrientation=function(func){funcOnRefreshOrientation=func};function doArrowClass(){$timeout((function(){var selectedMathcedRowsLength=$scope.selectedMatchedRows.length;selectedMathcedRowsLength>0?element.find(".btn-bulk-matched .icon").removeClass("icon_nb_arrow_down_disable").addClass("icon_nb_arrow_up_blue"):element.find(".btn-bulk-matched .icon").removeClass("icon_nb_arrow_up_blue").addClass("icon_nb_arrow_down_disable");if($scope.matchedData.length===selectedMathcedRowsLength&&selectedMathcedRowsLength>0){$scope.isCheckAllOption.matchedCheck=!0;element.find(".is-check-all-in-matched-list")[0].indeterminate=!1}else if(selectedMathcedRowsLength>0)element.find(".is-check-all-in-matched-list")[0].indeterminate=!0;else{$scope.isCheckAllOption.matchedCheck=!1;element.find(".is-check-all-in-matched-list")[0].indeterminate=!1}var selectedUnassignedRowsLength=$scope.selectedUnassignedRows.length;selectedUnassignedRowsLength>0?element.find(".btn-bulk-unassigned .icon").removeClass("icon_nb_arrow_down_disable").addClass("icon_nb_arrow_up_blue"):element.find(".btn-bulk-unassigned .icon").removeClass("icon_nb_arrow_up_blue").addClass("icon_nb_arrow_down_disable");if($scope.unassignedData.length===selectedUnassignedRowsLength&&selectedUnassignedRowsLength>0){$scope.isCheckAllOption.unassignedCheck=!0;element.find(".is-check-all-in-unassigned-list")[0].indeterminate=!1}else if(selectedUnassignedRowsLength>0)element.find(".is-check-all-in-unassigned-list")[0].indeterminate=!0;else{$scope.isCheckAllOption.unassignedCheck=!1;element.find(".is-check-all-in-unassigned-list")[0].indeterminate=!1}}))}$scope.toggleRow=function(row,event){uiGridTreeBaseService.toggleRowTreeState($scope.matchedGridApi.grid,row,event)};function showEmptyRow(isRunWatch){if(0===$scope.matchedData.length){$scope.matchedData=[];$scope.showMatchedEmptyRow=!0}else $scope.showMatchedEmptyRow=!1;if(0===$scope.unassignedData.length){$scope.unassignedData=[];$scope.showUnassignedEmptyRow=!0}else $scope.showUnassignedEmptyRow=!1;$timeout((function(){var matchedGrid=element.find(".matched-content .nsGridStyle");var unassignedGrid=element.find(".unassigned-content .nsGridStyle");$scope.showMatchedEmptyRow?matchedGrid.addClass("nsGridStyle-empty"):matchedGrid.removeClass("nsGridStyle-empty");$scope.showUnassignedEmptyRow?unassignedGrid.addClass("nsGridStyle-empty"):unassignedGrid.removeClass("nsGridStyle-empty");isRunWatch&&console.warn(isRunWatch);$scope.showLayoutDropdownInSecond=!0}))}function checkFolder(entity){if("node"===entity.nodeType){var index=_.findIndex($scope.matchedData,{deviceId:entity.deviceId});var isAllCheck=!0;var matchedItem;var folderItem;for(var i=index;i>=0;i--){if("folder"===(matchedItem=$scope.matchedData[i]).nodeType){folderItem=matchedItem;break}matchedItem.isCheck||(isAllCheck=!1)}for(var j=index+1;j<$scope.matchedData.length&&"folder"!==(matchedItem=$scope.matchedData[j]).nodeType;j++)matchedItem.isCheck||(isAllCheck=!1);if(isAllCheck&&folderItem){$scope.selectedMatchedRows.push(folderItem);folderItem.isCheck=!0;needRunSelected=!1;$scope.matchedGridApi.selection.selectRow(folderItem);needRunSelected=!0}if(!isAllCheck&&folderItem){var selectedIndex=_.findIndex($scope.selectedMatchedRows,{folderId:folderItem.folderId});if(selectedIndex>=0){$scope.selectedMatchedRows.splice(selectedIndex,1);folderItem.isCheck=!1}needRunSelected=!1;$scope.matchedGridApi.selection.unSelectRow(folderItem);needRunSelected=!0}}}$scope.onChangeMatchedSelect=function(event,entity){var selected=entity.selected;var arr=selected.split(":");var level=arr[0].split(" ")[1];var tag=arr[1];var dataChanged=entity.tag!=tag;entity.layerLevel=level;entity.tag=tag;entity.layerTag=selected;if(dataChanged){$scope.buttonStatus.saveTagsDisabled=!1;$scope.buttonStatus.applyToMapDisabled=!1}};$scope.onClickMatchedGridRowCheck=function(event,entity){angular.element(event.target).is(":checked")?$scope.matchedGridApi.selection.selectRow(entity):$scope.matchedGridApi.selection.unSelectRow(entity)};$scope.onClickCheckAllForMatched=function(event){var isCheck=angular.element(event.target).is(":checked");for(var i=0;i<$scope.matchedData.length;i++){var matchedRow=$scope.matchedData[i];isCheck?$scope.matchedGridApi.selection.selectRow(matchedRow):$scope.matchedGridApi.selection.unSelectRow(matchedRow)}};function getMatchedLayoutDeviceCellTemplate(){return'<div class="ui-grid-cell-contents"><span title="{{row.entity.deviceName}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.matchedFilterValue">{{row.entity.deviceName}}</span></div>'}function getMatchedLayoutTagCellTemplate(){return'<div class="ui-grid-cell-contents"><span style="cursor: pointer;width: 20px; height: 17px;" ng-click="grid.appScope.toggleRow(row, $event)"><i ng-class="{\'ui-grid-icon-minus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'expanded\', \'ui-grid-icon-plus-squared\': ( ( grid.options.showTreeExpandNoChildren &amp;&amp; row.treeLevel > -1 ) || ( row.treeNode.children &amp;&amp; row.treeNode.children.length > 0 ) ) &amp;&amp; row.treeNode.state === \'collapsed\'}" ng-style="{\'margin-left\': grid.options.treeIndent * row.treeLevel + \'px\'}" style=" width: 10px;height: 10px;display: inline-block;">&nbsp;</i></span><span style="margin-left: 10px;" ng-show="row.entity.nodeType===\'folder\'">{{row.entity.layerTag}}</span><select class="drop-layer-tag icon_nb_arrow_up_blue" ng-change="grid.appScope.onChangeMatchedSelect($event, row.entity)" ng-model="row.entity.selected" ng-show="row.entity.nodeType===\'node\'">    <option title="{{item.menuTitle}}" value="{{item.menuTitle}}" ng-repeat="item in grid.appScope.matchedLayerTagMenu">{{item.menuTitle}}</option></select></div>'}$scope.matchedFilter=function(event,clear){if("clear"===clear||13===event.keyCode||27===event.keyCode||8===event.keyCode||46===event.keyCode){27===event.keyCode&&($scope.filterObj.matchedFilterValue="");"clear"===clear&&($scope.filterObj.matchedFilterValue="");""===$scope.filterObj.matchedFilterValue&&$scope.matchedGridApi.treeBase.collapseAllRows();""!==$scope.filterObj.matchedFilterValue&&$scope.matchedGridApi.treeBase.expandAllRows();$scope.matchedGridApi.grid.refresh()}};function matchedSingleFilter(renderableRows){var matcher=new RegExp($scope.filterObj.matchedFilterValue,"i");renderableRows.forEach((function(row){var match=!1;["deviceName"].forEach((function(field){row.entity[field].match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderableRows}$scope.onClickBulkMenuForMatched=function(event,menuItem){for(var i=0;i<$scope.selectedMatchedRows.length;i++){var selectedRow=$scope.selectedMatchedRows[i];if("node"===selectedRow.nodeType){var deviceId=selectedRow.deviceId;var index=_.findIndex($scope.matchedData,{deviceId:deviceId});if(index>=0){var entity=$scope.matchedData[index];entity.tag=menuItem.tag;entity.layerLevel=menuItem.layerLevel;entity.layerTag=menuItem.menuTitle;entity.selected=menuItem.menuTitle}}}if($scope.selectedMatchedRows.length>0){$scope.buttonStatus.saveTagsDisabled=!1;$scope.buttonStatus.applyToMapDisabled=!1}};$scope.onClickCheckAllForUnassigned=function(event){var isCheck=angular.element(event.target).is(":checked");for(var i=0;i<$scope.unassignedData.length;i++){var unassignedRow=$scope.unassignedData[i];isCheck?$scope.unassignedGridApi.selection.selectRow(unassignedRow):$scope.unassignedGridApi.selection.unSelectRow(unassignedRow)}};$scope.onChangeUnassignedSelect=function(event,entity){var selected=entity.selected;var dataChanged=!1;if("None"===selected){dataChanged=""!=entity.tag;entity.layerTag="";entity.layerLevel=0;entity.tag="None"}else{var arr=selected.split(":");var level=arr[0].split(" ")[1];var tag=arr[1];entity.layerLevel=level;entity.tag=tag;entity.layerTag=selected;dataChanged=!0}if(dataChanged){$scope.buttonStatus.saveTagsDisabled=!1;$scope.buttonStatus.applyToMapDisabled=!1}};$scope.onClickUnassignedGridRowCheck=function(event,entity){angular.element(event.target).is(":checked")?$scope.unassignedGridApi.selection.selectRow(entity):$scope.unassignedGridApi.selection.unSelectRow(entity)};function getUnassignedLayoutDeviceCellTemplate(){return'<div class="ui-grid-cell-contents"><span title="{{row.entity.deviceName}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.unassignedFilterValue">{{row.entity.deviceName}}</span></div>'}function getUnassignedLayoutTagCellTemplate(){return'<div class="ui-grid-cell-contents"><div class="tagDropdownMenu"><select ng-show="!grid.appScope.showUnassignedEmptyRow" class="drop-layer-tag icon_nb_arrow_up_blue" ng-change="grid.appScope.onChangeUnassignedSelect($event, row.entity)" ng-model="row.entity.selected">    <option title="{{item.menuTitle}}" value="{{item.menuTitle}}" ng-repeat="item in grid.appScope.unassignedLayerTagMenu">{{item.menuTitle}}</option></select></div></div>'}function getUnassignedLayoutCheckCellTemplate(){return'<div class="ui-grid-cell-contents" style="padding-left: 3px;"><input type="checkbox" ng-disabled="grid.appScope.showUnassignedEmptyRow" ng-click="grid.appScope.onClickUnassignedGridRowCheck($event, row.entity);" ng-checked="row.entity.isCheck"/></div>'}$scope.unassignedFilter=function(event,clear){if("clear"===clear||13===event.keyCode||27===event.keyCode||8===event.keyCode||46===event.keyCode){27===event.keyCode&&($scope.filterObj.unassignedFilterValue="");"clear"===clear&&($scope.filterObj.unassignedFilterValue="");$scope.unassignedGridApi.grid.refresh()}};function unassignedSingleFilter(renderableRows){var matcher=new RegExp($scope.filterObj.unassignedFilterValue,"i");renderableRows.forEach((function(row){var match=!1;["deviceName"].forEach((function(field){row.entity[field].match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderableRows}$scope.onClickBulkMenuForUnassigned=function(event,menuItem){for(var i=0;i<$scope.selectedUnassignedRows.length;i++){var devId=$scope.selectedUnassignedRows[i].deviceId;var index=_.findIndex($scope.unassignedData,{deviceId:devId});if(index>=0){var entity=$scope.unassignedData[index];entity.tag=menuItem.tag;entity.layerLevel=menuItem.layerLevel;entity.layerTag=menuItem.menuTitle;entity.selected=menuItem.menuTitle}}if($scope.selectedUnassignedRows.length>0){$scope.buttonStatus.saveTagsDisabled=!1;$scope.buttonStatus.applyToMapDisabled=!1}};$scope.onShowMatchedOption=function(){$uibModal.open({templateUrl:"modules/nbQmap/views/maplayout/nbMapLayoutSettings.html",controller:"nb.qmap.nbMapLayoutSettingsCtrl",windowClass:"map-layout-setting-ctrl",backdrop:"static",size:"sm",resolve:{mapLayoutSettingsHandle:function(){return{currentLayout:$scope.layoutItem.currentLayout}}}}).result.then((function(resolve){var currentLayout=resolve.currentLayout;var layers=currentLayout.layers;var layoutLayers=currentLayout.layoutLayers;for(var i=0;i<layers.length;i++)layers[i].scale=layoutLayers[i].scale;$scope.buttonStatus.applyToMapDisabled=!1}))};function doLayoutStyleForRefresh(){var defer=$q.defer();updateMapSrvc.canUpdateCurrentMap().then((function(){var changeToLayout=getLayoutItemForApply();doLayoutStyle(globalCurrentOrientation,changeToLayout);globalCurrentOrientation=changeToLayout.orientation;$scope.isAutoApply.value=!0;defer.resolve()}),(function(){defer.resolve()}));return defer.promise}function doLayoutStyle(_previousOrientation,changeToLayout){changeToLayout.type===MapLayoutType.multiTier?matchedNodeKeys=tools.parallelStyleLayout(changeToLayout):changeToLayout.type===MapLayoutType.pairing?matchedNodeKeys=tools.symmetricalParallelStyleLayout(changeToLayout):changeToLayout.type===MapLayoutType.pie?matchedNodeKeys=tools.petalLayout(changeToLayout):changeToLayout.type===MapLayoutType.circle&&(matchedNodeKeys=tools.ringLayout(changeToLayout));var changeToOrientation=changeToLayout.orientation;tools.rotateMap(OrientationEnum.tt,changeToOrientation)}$scope.onDetailPaneUnassignedExpanded=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){$scope.detailUnassignedExpanded=!$scope.detailUnassignedExpanded;$scope.detailUnassignedExpanded?$scope.detailPaneUnassignedCss={}:$scope.detailPaneUnassignedCss={height:0}}};$scope.onDetailPaneMatchedExpanded=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){$scope.detailMatchedExpanded=!$scope.detailMatchedExpanded;$scope.detailMatchedExpanded?$scope.detailPaneMatchedCss={}:$scope.detailPaneMatchedCss={height:0}}};$scope.onDetailPaneOrientationExpanded=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){$scope.detailDirectionExpanded=!$scope.detailDirectionExpanded;$scope.detailDirectionExpanded?$scope.detailPaneDirectionCss={}:$scope.detailPaneDirectionCss={height:0}}};$scope.onChangeLayoutDropdownInDetailPane=function(event,layout,layoutItem){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){$scope.currentStyleId.id=layoutItem.currentStyleId;layoutItem.currentLayout=layout;refreshMatchedGrid($scope.layoutItem.currentLayout).then((function(){showEmptyRow(!0);initSecondDivControlStatus();runWatchScrollHeight=!0;$scope.buttonStatus.applyToMapDisabled=!1;console.warn("$scope.layoutItem",$scope.layoutItem)}))}};function doHighlightMap(){var isShow=$scope.highlightDevice.highlightDevice;var idList=pageService.quickShowOrHideHighlightBg(isShow,matchedNodeKeys);for(var z=0;z<idList.length;z++)highlightDeviceIdList.push(idList[z])}$scope.onDetailPaneCheckHighlightClick=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){$scope.highlightDevice.highlightDevice=!$scope.highlightDevice.highlightDevice;doHighlightMap()}};$scope.onDetailPaneRefreshClick=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){$scope.isLoading=!0;var bigType=$scope.layoutItem.bigType;var currentStyleId=$scope.layoutItem.currentStyleId;refresh($scope.layoutItem.type,$scope.layoutItem.currentLayout.id,bigType,currentStyleId)}};$scope.onDetailPaneMinClick=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){$scope.showOption.isRealShow=!1;$scope.optionsOut.firstPaneShowOption.isRealShow=!0}};$scope.onDetailPaneCloseClick=function(){if(NetBrain.Map.currentActiveMapPage.getDocId()===mapPageId){if("miniPane"===$scope.options.fromType){mapManagerSrvc.getActivePage().currentScopeRef.hideMapLayoutPane();$scope.optionsOut.miniPaneShowOption.isRealShow=!0}else"firstPane"===$scope.options.fromType&&($scope.optionsOut.firstPaneShowOption.isRealShow=!0);element.remove();$scope.$destroy()}};$scope.onSaveTags=function(){var data={addDeviceTags:[],delDeviceTags:[]};for(var i=0;i<$scope.matchedData.length;i++){var matchedItem=$scope.matchedData[i];if("node"===matchedItem.nodeType&&matchedItem.tag!==matchedItem.oldTag){var deviceId1=matchedItem.deviceId;var tag1=matchedItem.tag;var delItem1={devId:deviceId1,tagNames:[matchedItem.oldTag,tag1]};data.delDeviceTags.push(delItem1);var addItem1={devId:deviceId1,tagNames:[tag1]};data.addDeviceTags.push(addItem1)}}for(var z=0;z<$scope.unassignedData.length;z++){var unassignedItem=$scope.unassignedData[z];if("None"!==unassignedItem.tag){var addItem2={devId:unassignedItem.deviceId,tagNames:[unassignedItem.tag]};data.addDeviceTags.push(addItem2)}}httpMapLayoutSrvc.saveLayoutTagsToDevs(data).then((function(result){if(!0===result){var options={tipInfo:MapLayoutWording.SaveTagsSuccessMessage,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);$scope.isCheckAllOption.matchedCheck=!1;$scope.isCheckAllOption.unassignedCheck=!1;$scope.selectedMatchedRows=[];$scope.selectedUnassignedRows=[];var bigType=$scope.layoutItem.bigType;var currentStyleId=$scope.layoutItem.currentStyleId;var layoutItemType=$scope.layoutItem.type;var currentLayoutId=$scope.layoutItem.currentLayout.id;$scope.buttonStatus.saveTagsDisabled=!0;refresh(layoutItemType,currentLayoutId,bigType,currentStyleId).then((function(){$scope.buttonStatus.applyToMapDisabled=!1}))}}))};function findOldDevicesArr(deviceId,changeToLayoutItem){for(var i=0;i<changeToLayoutItem.layers.length;i++){var layer=changeToLayoutItem.layers[i];for(var j=0;j<layer.tags.length;j++){var tag=layer.tags[j];for(var k=0;k<tag.devices.length;k++){if(tag.devices[k].deviceId===deviceId)return tag.devices}}}}function getLayoutItemForApply(){var changeToLayout=angular.copy($scope.layoutItem.currentLayout);for(var i=0;i<$scope.matchedData.length;i++){var matchedItem=$scope.matchedData[i];if("node"===matchedItem.nodeType){var oldMatchedDevice={};var oldDevicesArr=findOldDevicesArr(matchedItem.deviceId,changeToLayout);if(oldDevicesArr){var oldDeviceIndex=_.findIndex(oldDevicesArr,{deviceId:matchedItem.deviceId});if(oldDeviceIndex>=0){oldMatchedDevice=oldDevicesArr[oldDeviceIndex];oldDevicesArr.splice(oldDeviceIndex,1)}var layerIndex1=matchedItem.layerLevel-1;if(layerIndex1>=0){var layer1=changeToLayout.layers[layerIndex1];var tagIndex1=_.findIndex(layer1.tags,{name:matchedItem.tag});if(tagIndex1>=0){var len=oldMatchedDevice.tags.length;oldMatchedDevice.tags.splice(len-1,1);var findIndex1=_.findIndex(oldMatchedDevice.tags,matchedItem.tag);findIndex1>=0&&oldMatchedDevice.tags.splice(findIndex1,1);oldMatchedDevice.tags.push(matchedItem.tag);layer1.tags[tagIndex1].devices.push(oldMatchedDevice)}}}}}NetBrain.MapLayout.Const.convertToScale(changeToLayout);for(var z=0;z<$scope.unassignedData.length;z++){var unassignedItem=$scope.unassignedData[z];if(0!==unassignedItem.layerLevel&&"None"!==unassignedItem.tag){var unassignedDeviceIndex=_.findIndex(changeToLayout.unAssignedDevices,{deviceId:unassignedItem.deviceId});if(unassignedDeviceIndex>=0){var unassignedDevice=changeToLayout.unAssignedDevices[unassignedDeviceIndex];if(unassignedDevice){var layerIndex2=unassignedItem.layerLevel-1;var layer2=changeToLayout.layers[layerIndex2];var tagIndex2=_.findIndex(layer2.tags,{name:unassignedItem.tag});if(tagIndex2>=0){var findIndex2=_.findIndex(unassignedDevice.tags,unassignedItem.tag);findIndex2>=0&&unassignedDevice.tags.splice(findIndex2,1);unassignedDevice.tags.push(unassignedItem.tag);layer2.tags[tagIndex2].devices.push(unassignedDevice);changeToLayout.unAssignedDevices.splice(unassignedDeviceIndex,1)}}}}}return changeToLayout}$scope.onApplyToMap=function(){updateMapSrvc.canUpdateCurrentMap().then((function(){var changeToLayout=getLayoutItemForApply();doLayoutStyle(0,changeToLayout);globalCurrentOrientation=changeToLayout.orientation;doHighlightMap();if(previousLayoutId!==changeToLayout.id)if("firstPane"===$scope.options.fromType){$scope.options.setCurrentStyle(changeToLayout.id,TemplateLayoutType.MapLayout,matchedNodeKeys);$scope.options.setCurrentLayout(changeToLayout.id,matchedNodeKeys)}else"miniPane"===$scope.options.fromType&&$scope.options.setCurrentLayout(changeToLayout.id,matchedNodeKeys);var options={tipInfo:MapLayoutWording.ApplyToMapSuccessMessage,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip",appendTo:"body",position:{right:"45%",top:"105px"}};nbTipSrvc.open(options);$scope.buttonStatus.applyToMapDisabled=!0}))};var watchIsShowFunction=$scope.$watch("showOption.isRealShow",(function(value){if(mapPageId===NetBrain.Map.currentActiveMapPage.getDocId()&&!isFirstShow){if(!0===value){$scope.options.isShow=!0;element.dialog("open")}if(!1===value){$scope.options.isShow=!1;element.dialog("close")}}}));var watchSecondAllDivScrollHeight=function(){};watchSecondAllDivScrollHeight=$scope.$watch((function(){return element.find(".detail-pane-content .second-all")[0]&&runWatchScrollHeight?element.find(".detail-pane-content .second-all")[0].scrollHeight:0}),(function(scrollHeight){if(0!==scrollHeight&&runWatchScrollHeight){var divHeight=element.find(".detail-pane-content .second-all").height();$scope.showScrollStyle=scrollHeight>divHeight?{"margin-right":"10px"}:{}}}));var watchCloseMapLayoutInDetailPane=$rootScope.$on(MapLayoutEvent.CLOSE_MAP_LAYOUT,(function(){$scope.onCloseClick()}));!function(el){el.dialog({autoOpen:!1,appendTo:containerId,resizable:!1,dialogClass:"map-layout-detail-pane-box",diaggable:!1,minHeight:500,minWidth:420,open:function(event){var tar=angular.element(event.target);tar.parent().css("cssText","border: 1px solid #c5c5c5 !important");try{$scope.$digest()}catch(e){}tar.parent().css({"min-height":"500px",width:"420px","min-width":"420px",height:"calc(100% - 1px)"});tar.parent().css({top:"0px",left:"0px"})}});el.dialog("open");!function(){$scope.matchedGridOptions={data:"matchedData",multiSelect:!0,enableSelection:!0,modifierKeysToMultiSelect:!1,enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableColumnMenus:!1,keepLastSelected:!0,columnDefs:[{field:"isCheck",displayName:"",width:"30",cellTemplate:('<div class="ui-grid-cell-contents" style="padding-left: 3px;"><input type="checkbox" rowId="{{row.entity.feId}}" ng-disabled="grid.appScope.showMatchedEmptyRow" indeterminate="row.entity.indeterminate" ng-click="grid.appScope.onClickMatchedGridRowCheck($event, row.entity);" ng-checked="row.entity.isCheck"/></div>','<div class="ui-grid-cell-contents" style="padding-left: 3px;"><input type="checkbox" rowId="{{row.entity.feId}}" ng-disabled="grid.appScope.showMatchedEmptyRow" indeterminate="row.entity.indeterminate" ng-click="grid.appScope.onClickMatchedGridRowCheck($event, row.entity);" ng-checked="row.entity.isCheck"/></div>')},{field:"layerTag",displayName:MapLayoutWording.MatchedGridColumn1Title,width:"190",cellTemplate:getMatchedLayoutTagCellTemplate()},{field:"deviceName",displayName:MapLayoutWording.MatchedGridColumn2Title,width:"140",cellTemplate:getMatchedLayoutDeviceCellTemplate()}],showTreeExpandNoChildren:!1,enableExpandAll:!0,flatEntityAccess:!1,fastWatch:!1,treeIndent:10,enableColumnResizing:!1,enableSorting:!1,onRegisterApi:function(gridApi){$scope.matchedGridApi=gridApi;$scope.matchedGridApi.selection.on.rowSelectionChanged($scope,(function(row){needRunSelected&&(row.isSelected?function(entity){var index;if("folder"===entity.nodeType){if((index=_.findIndex($scope.selectedMatchedRows,{folderId:entity.folderId}))<0){$scope.selectedMatchedRows.push(entity);entity.isCheck=!0}if((index=_.findIndex($scope.matchedData,{folderId:entity.folderId}))>=0)for(var i=index+1;i<$scope.matchedData.length;i++){var matchedItem=$scope.matchedData[i];if("folder"===matchedItem.nodeType)break;if(_.findIndex($scope.selectedMatchedRows,{deviceId:matchedItem.deviceId})<0){$scope.selectedMatchedRows.push(matchedItem);matchedItem.isCheck=!0;needRunSelected=!1;$scope.matchedGridApi.selection.selectRow(matchedItem);needRunSelected=!0}}}else if((index=_.findIndex($scope.selectedMatchedRows,{deviceId:entity.deviceId}))<0){$scope.selectedMatchedRows.push(entity);entity.isCheck=!0;checkFolder(entity)}doArrowClass()}(row.entity):function(entity){var index;if("folder"===entity.nodeType){if((index=_.findIndex($scope.selectedMatchedRows,{folderId:entity.folderId}))>=0){$scope.selectedMatchedRows.splice(index,1);entity.isCheck=!1}if((index=_.findIndex($scope.matchedData,{folderId:entity.folderId}))>=0)for(var i=index+1;i<$scope.matchedData.length;i++){var matchedItem=$scope.matchedData[i];if("folder"===matchedItem.nodeType)break;var selectedIndex=_.findIndex($scope.selectedMatchedRows,{deviceId:matchedItem.deviceId});if(selectedIndex>=0){$scope.selectedMatchedRows.splice(selectedIndex,1);matchedItem.isCheck=!1;needRunSelected=!1;$scope.matchedGridApi.selection.unSelectRow(matchedItem);needRunSelected=!0}}}else if((index=_.findIndex($scope.selectedMatchedRows,{deviceId:entity.deviceId}))>=0){$scope.selectedMatchedRows.splice(index,1);entity.isCheck=!1;checkFolder(entity)}doArrowClass()}(row.entity))}));$scope.matchedGridApi.grid.registerRowsProcessor(matchedSingleFilter,200)}};$scope.unassignedGridOptions={data:"unassignedData",multiSelect:!0,enableSelection:!0,modifierKeysToMultiSelect:!1,enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableColumnMenus:!1,keepLastSelected:!0,columnDefs:[{field:"isCheck",displayName:"",width:"30",cellTemplate:getUnassignedLayoutCheckCellTemplate()},{field:"layerTag",displayName:MapLayoutWording.UnassignedGridColumn1Title,width:"190",cellTemplate:getUnassignedLayoutTagCellTemplate()},{field:"deviceName",displayName:MapLayoutWording.UnassignedGridColumn2Title,width:"140",cellTemplate:getUnassignedLayoutDeviceCellTemplate()}],showTreeExpandNoChildren:!1,enableExpandAll:!0,flatEntityAccess:!1,fastWatch:!1,treeIndent:10,enableColumnResizing:!1,enableSorting:!1,onRegisterApi:function(gridApi){$scope.unassignedGridApi=gridApi;$scope.unassignedGridApi.selection.on.rowSelectionChanged($scope,(function(row){needRunSelected&&(row.isSelected?function(entity){if(_.findIndex($scope.selectedUnassignedRows,{deviceId:entity.deviceId})<0){$scope.selectedUnassignedRows.push(entity);entity.isCheck=!0}doArrowClass()}(row.entity):function(entity){var index=_.findIndex($scope.selectedUnassignedRows,{deviceId:entity.deviceId});if(index>=0){$scope.selectedUnassignedRows.splice(index,1);entity.isCheck=!1}doArrowClass()}(row.entity))}));$scope.unassignedGridApi.grid.registerRowsProcessor(unassignedSingleFilter,200)}}}();(function(){var defer=$q.defer();$scope.buttonStatus={saveTagsDisabled:!0,applyToMapDisabled:!0};$scope.mapLayoutDetailPaneCss={height:"100%"};$scope.noData=!1;$scope.detailDirectionExpanded=!0;$scope.detailPaneDirectionCss={};$scope.detailMatchedExpanded=!0;$scope.detailPaneMatchedCss={};$scope.detailUnassignedExpanded=!0;$scope.detailPaneUnassignedCss={};$scope.matchedData=[];$scope.unassignedData=[];$scope.currentStyleId={id:"-1",type:TemplateLayoutType.MapLayout};globalCurrentOrientation=OrientationEnum.tt;pageService=mapLayoutSrvc.getPageService(mapPageId);tools=mapLayoutSrvc.getLayoutToolsHelper(mapPageId);runWatchScrollHeight=!1;refreshMatchedGrid($scope.layoutItem.currentLayout).then((function(){showEmptyRow(!0);initSecondDivControlStatus();runWatchScrollHeight=!0;previousLayoutId=$scope.layoutItem.currentLayout.id;defer.resolve();console.log("detail pane$scope.layoutItem",$scope.layoutItem)}));return defer.promise})().then((function(result){console.log("loadData",result);isFirstShow=!1;$timeout((function(){element.find(".minipane-layout-dropdown button.dropdown-toggle .caret").removeClass("caret").addClass("icon_nb_arrow_down")}),0)}))}(element);$scope.$on("$destroy",(function(){watchIsShowFunction();watchCloseMapLayoutInDetailPane();watchSecondAllDivScrollHeight()}))}}(NetBrain);!function(){angular.module("nb.qmap").factory("nb.qmap.historyChartSrvc",HistoryChartSrvc);HistoryChartSrvc.$inject=["nb.ng.nbHttp"];function HistoryChartSrvc(nbHttp){return{getTimeRangeList:function(){return[{type:"minute",count:60,text:"1H"},{type:"minute",count:360,text:"6H"},{type:"day",count:1,text:"24H"},{type:"day",count:7,text:"7D"},{type:"all",text:"MAX"}]},getRunQappResult:function(unitIds,para,startTime,endTime){var param={dataViewGroupId:para.dataViewInfo.dataViewGroupId,dataViewTaskInfoId:para.dataViewInfo.dataViewTaskInfoId,deviceId:para.deviceId,interfaceIds:para.interfaceId?[para.interfaceId]:[],unitIds:unitIds,startTime:startTime,endTime:endTime,currentUnit:para.currentUnit};return nbHttp.post("dataview/dataviewgroup/GetDeviceDataValueForUnitChartNew",param,{avoidBlockUI:!0})},formatForCompound:function(value){return-1===value?"No Value":0===value?"Normal":1===value?"Warning":2===value?"Error":"No Value"}}}}();!function(NetBrain){angular.module("nb.qmap").directive("historyChartDirective",["$log","$compile",function($log,$compile){return{restrict:"EA",scope:{mapCurrentTime:"=",canNotClearAll:"=",fromModule:"@"},controller:function($scope,$element){$scope.openChartPanelList=[];$scope.openChartPanelElementList=[];this.zIndex=9999;this.getRandomPos=function(el){var mapCon=$element.parent(),conW=mapCon.width(),conH=mapCon.height(),elW=el.width(),elH=el.height(),randomW=Math.floor((conW-elW)/2);return{top:Math.floor((conH-elH)/2),left:randomW}};this.destroy=function(el,onlyKey){el.remove();var panelList=$scope.openChartPanelList;$scope.openChartPanelList=_.without(panelList,onlyKey);0===$scope.openChartPanelList.length&&(this.zIndex=9999)}},link:function($scope,$element){$scope.add=function(info){info.popUrl="metricPopoverTemplate.html";info.titleType||(info.titleType=info.interfaceId?"Interface":"Device");var newScope=$scope.$new();newScope.para=info;if(-1===_.indexOf($scope.openChartPanelList,newScope.para.onlyKey)){var newElement=$compile('<div history-chart-item-directive map-current-time="mapCurrentTime"  class="historyChartLayer" style="display:none"></div>')(newScope);$element.append(newElement);$scope.openChartPanelElementList.push(newElement);$scope.openChartPanelList.push(newScope.para.onlyKey)}else $scope.$broadcast("changeMetricOuter",newScope.para.onlyKey,newScope.para.currentUnit)};$scope.addDv=function(info){info.popUrl="metricPopoverTemplate.html";info.titleType||(info.titleType=info.interfaceId?"Interface":"Device");var newScope=$scope.$new();newScope.para=info;if(-1===_.indexOf($scope.openChartPanelList,newScope.para.onlyKey)){var newChart='<div history-chart-item-directive map-current-time="mapCurrentTime"  class="historyChartLayerDv historyChartLayer" style="display:none"></div>';_.isEmpty(newScope.para)&&(newChart='<div history-chart-item-directive map-current-time="mapCurrentTime" class="historyChartLayerDv historyChartLayer" style="display:none"></div>');var newElement=$compile(newChart)(newScope);$element.append(newElement);$scope.openChartPanelElementList.push(newElement);$scope.openChartPanelList.push(newScope.para.onlyKey)}else $scope.$broadcast("changeMetricOuter",newScope.para.onlyKey,newScope.para.currentUnit)};$scope.clearAll=function(){_.map($scope.openChartPanelElementList,(function(openChartItem){openChartItem.remove()}));$scope.openChartPanelElementList=[];$scope.openChartPanelList=[]};$scope.$on("changeHistoryChartPanelEvent",(function(e,info){if("qapp-output-console"!==$scope.fromModule){$scope.clearAll();var unitList=[];for(var i=0;i<info.unitList.length;i++){var item=info.unitList[i];0===_.where(unitList,{uId:item.uId}).length&&unitList.push(item)}info.unitList=unitList;$scope.add(info)}}));$scope.$on("refreshMetricOuterForDv",(function(e){$scope.$broadcast("refreshMetricOuter")}));$scope.$on("changeHistoryChartPanelEventForDv",(function(e,info){$scope.clearAll();var unitList=[];if(info.isEmpty){info.onlyKey="high-chart-empty";return $scope.addDv(info)}for(var i=0;i<info.unitList.length;i++){var item=info.unitList[i];0===_.where(unitList,{uId:item.uId}).length&&unitList.push(item)}info.unitList=unitList;return $scope.addDv(info)}));$scope.$root.$on(NetBrain.Map.Event.ActivePageChanged,(function(){$scope.clearAll()}));$scope.$root.$on(NetBrain.Map.Event.CloseAllFloatDialog,(function(){$scope.clearAll()}));$scope.$root.$on(NetBrain.Map.Event.DataViewChanged,(function(){$scope.canNotClearAll||$scope.clearAll()}))}}}])}(NetBrain);NetBrain,angular.module("nb.qmap").directive("historyChartItemDirective",["$timeout","$rootScope","$q","nb.qmap.historyChartSrvc",function($timeout,$rootScope,$q,historyChartSrvc){return{restrict:"EA",require:["^historyChartDirective"],scope:!0,templateUrl:"modules/nbQmap/historychart/nbHistoryChart.html",controller:function(){},link:function($scope,$element,attrs,ctrls){var DATETIME_LABEL_FORMATS={millisecond:"%H:%M:%S",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m/%d",week:"%m/%d",month:"%Y/%m",year:"%Y"};var con=ctrls[0];$element.draggable({handle:".historyChartTitle,.metricList",containment:".realActiveOnlyOne"});$scope.popoverFlag=!1;$scope.loading=!1;$scope.changeZindex=function(el){if(el&&$scope.popoverFlag){var metricPop=$(el).closest(".metricPop"),spopoverTpl=$(el).attr("uib-popover-template");metricPop[0]||spopoverTpl||($scope.popoverFlag=!1)}var currentZindex=$element.css("zIndex");if(!(currentZindex&&currentZindex>=con.zIndex)){con.zIndex+=1;$element.css({zIndex:con.zIndex})}};$element.css(con.getRandomPos($element));$element.show();$element.on("mousedown",(function(event){$scope.changeZindex(event.target)}));$scope.changeZindex();$scope.closeThisPanel=function(){con.destroy($element,$scope.para.onlyKey);$scope.$destroy()};$scope.selectedMetricType=[$scope.para.currentUnit];$scope.checkModel={};$scope.multiSelectedMetric=function(){angular.forEach($scope.para.unitList,(function(metric){$scope.checkModel[metric.uId]=!!_.find($scope.selectedMetricType,(function(each){return each.uId===metric.uId}))}))};$scope.multiSelectedMetric();$scope.selectedMetric=function(metric){$scope.selectedMetricType=[metric];$scope.para.currentUnit=metric};$scope.$on("refreshMetricOuter",(function(e){chart.reflow()}));$scope.$on("changeMetricOuter",(function(e,key,currentUnit){if(key===$scope.para.onlyKey){var metricTypeLength=$scope.selectedMetricType.length;(0===metricTypeLength||metricTypeLength>1||1===metricTypeLength&&$scope.selectedMetricType[0].uId!==currentUnit.uId)&&$scope.selectedMetric(currentUnit)}}));$scope.checkChangeStatus=function(metric){$scope.checkModel[metric.uId]?$scope.selectedMetricType.push(metric):$scope.selectedMetricType=_.filter($scope.selectedMetricType,(function(each){return each.uId!==metric.uId}))};$scope.selectedMetricTypeCurrentTime=null;$scope.startTime=null;$scope.endTime=null;$scope.currentMetricType=null;$scope.rangeSelectorIndex=4;$scope.firstLoad=!0;$scope.methodLoad=!1;Highcharts.setOptions({global:{useUTC:!1}});var chart;var chartEl=$element.find(".chartMain");var chartCreate=function(_data){var orgHighchartsRangeSelectorPrototypeRender=Highcharts.RangeSelector.prototype.render;Highcharts.RangeSelector.prototype.render=function(min,max){orgHighchartsRangeSelectorPrototypeRender.apply(this,[min,max]);var leftPosition=$element.find(".highcharts-container").width()-220;this.zoomText.attr({x:leftPosition,y:15});leftPosition+=this.zoomText.getBBox().width+2;for(var i=0;i<this.buttons.length;i++){this.buttons[i].attr({x:leftPosition,y:0});leftPosition+=this.buttons[i].width+2}};chartEl.highcharts("StockChart",function(_data){var chartOption={credits:{enabled:!1},rangeSelector:{inputEnabled:!1,allButtonsEnabled:!0,buttons:historyChartSrvc.getTimeRangeList(),selected:4,enabled:!0},lang:{noData:"No choice metrics"},legend:{enabled:!1,align:"center",verticalAlign:"bottom",shadow:!0},scrollbar:{liveRedraw:!1},xAxis:{type:"datetime",dateTimeLabelFormats:DATETIME_LABEL_FORMATS,minRange:6e4,events:{afterSetExtremes:function(){},setExtremes:function(e){if($scope.loading)console.log("===================$scope.loading",e.trigger);else if($scope.methodLoad){$scope.methodLoad=!1;console.log("===================$scope.methodLoad",e.trigger)}else{if($scope.firstLoad){"navigator"===e.trigger?chart.rangeSelector.buttons[4].setState(2):"rangeSelectorButton"===e.trigger&&"MAX"!==e.rangeSelectorButton.text&&chart.rangeSelector.buttons[4].setState(null);$scope.firstLoad=!1}if("rangeSelectorButton"===e.trigger){chart.rangeSelector.buttons[0].setState(0);chart.rangeSelector.buttons[1].setState(0);chart.rangeSelector.buttons[2].setState(0);chart.rangeSelector.buttons[3].setState(0);chart.rangeSelector.buttons[4].setState(0);$scope.startTime=new Date($scope.selectedMetricTypeCurrentTime);$scope.endTime=new Date($scope.selectedMetricTypeCurrentTime);if("MAX"===e.rangeSelectorButton.text){$scope.startTime=null;$scope.endTime=null;$scope.rangeSelectorIndex=4;chart.rangeSelector.buttons[4].setState(2)}else if("7D"===e.rangeSelectorButton.text){$scope.startTime.setDate($scope.startTime.getDate()-7);$scope.rangeSelectorIndex=3;chart.rangeSelector.buttons[3].setState(2)}else if("24H"===e.rangeSelectorButton.text){$scope.startTime.setHours($scope.startTime.getHours()-24);$scope.rangeSelectorIndex=2;chart.rangeSelector.buttons[2].setState(2)}else if("6H"===e.rangeSelectorButton.text){$scope.startTime.setHours($scope.startTime.getHours()-6);$scope.rangeSelectorIndex=1;chart.rangeSelector.buttons[1].setState(2)}else if("1H"===e.rangeSelectorButton.text){$scope.startTime.setHours($scope.startTime.getHours()-1);$scope.rangeSelectorIndex=0;chart.rangeSelector.buttons[0].setState(2)}seriesList($scope.currentMetricType,$scope.currentMetricType)}else if("navigator"===e.trigger||"zoom"===e.trigger){$scope.startTime=e.min?new Date(e.min):null;$scope.endTime=e.max?new Date(e.max):null;seriesList($scope.currentMetricType,$scope.currentMetricType)}}}}},plotOptions:{line:{connectNulls:!0}},series:[{data:_data,id:"dataseries"}],navigator:{enabled:!0,adaptToUpdatedData:!1,series:{id:"nav",type:"areaspline",color:"#4572A7",fillOpacity:.1},xAxis:{type:"datetime",dateTimeLabelFormats:DATETIME_LABEL_FORMATS}}};var noDataOption={title:{text:"No data in line chart",align:"left",floating:!0},xAxis:{type:"datetime",dateTimeLabelFormats:DATETIME_LABEL_FORMATS,title:{text:""},showEmpty:!0,lineWidth:1,opposite:!0,labels:{formatter:function(){}}},yAxis:unitToAxis({unit:"%"},0,[]),series:[{animation:!0,yAxis:"percentY",data:[0,0],valueSuffix:"%"}],lang:{noData:"no data"},noData:{style:{fontWeight:"bold",fontSize:"15px",color:"#303030"}}};var renderChartOpt=chartOption;$scope.para.isEmpty&&(renderChartOpt=noDataOption);return renderChartOpt}(_data));chart=chartEl.highcharts()};var scopeWatchCollection=$scope.$watchCollection("selectedMetricType",(function(newType,oldType){if(chart)if($scope.para.isEmpty)chart.redraw();else{$scope.multiSelectedMetric();seriesList(newType,oldType);$scope.currentMetricType=newType}}));var LEGEND_COLOR=["#2F7ED8","#90ED7D","#FEC321","#0D233A","#6666FF","#FF6633","#66CC99","#FF3366","#CC99FF","#F69C9F","#6AF9C4","#FFFD74","#003366","#8BBC21","#50B432","#ED561B","#DDDF00","#24CBE5","#64E572","#FF9655"];function valueTypeIsCompoundVar(newType,uid){var result=!1;var list=_.where(newType,{uId:uid});if(list&&list.length>0){var vType=list[0].valueType;result=vType===DataUnitType.uCompoundVar||vType===DataUnitType.uBool}return result}function seriesList(newType,oldType){clearInterval($scope.setThirtySecond);if(0!==newType.length){$scope.loading=!0;var qList=[];var chartSeries=chart.series;var nav=chart.get("nav");var unitIds=[];angular.forEach(newType,(function(metric){unitIds.push(metric.uId)}));var runQappResult=historyChartSrvc.getRunQappResult(unitIds,$scope.para,$scope.startTime,$scope.endTime);runQappResult&&qList.push(runQappResult);$q.all(qList).then((function(arr){chartSeries.length>0&&angular.forEach(oldType,(function(d){chart.get(d.uId)&&chart.get(d.uId).remove(!1)}));var percentY=chart.get("percentY");var numberY=chart.get("numberY");percentY&&percentY.remove(!1);numberY&&numberY.remove(!1);for(var zzIndex=0;zzIndex<arr.length;zzIndex++){var d=arr[zzIndex];d.isruning;var all=[];for(var ii=0;ii<d.chartInfo.conditionSeries.length;ii++){var val=d.chartInfo.conditionSeries[ii];var uid=val.name;var isCompoundVar=valueTypeIsCompoundVar(newType,uid);var isNew=!0;var item={UId:uid,allValueList:[],frequence:d.frequence};for(var j=0;j<all.length;j++){var allVal=all[j];if(allVal.UId===uid){item=allVal;isNew=!1;break}}for(var k=0;k<val.data.length;k++){var dataVal=val.data[k];var obj=[];obj.push(new Date(dataVal[0]).getTime());isCompoundVar?obj.push(isNaN(parseFloat(dataVal[2]))?null:parseFloat(dataVal[2])):obj.push(isNaN(parseFloat(dataVal[1]))?null:parseFloat(dataVal[1]));item.allValueList.push(obj)}isNew&&all.push(item)}if(0!==all.length){var seriesItem=all[0];if(d.chartInfo.series.length>0){var seriesOne=d.chartInfo.series[0];seriesItem={UId:seriesOne.name,allValueList:[],frequence:d.frequence};uid=seriesOne.name;isCompoundVar=valueTypeIsCompoundVar(newType,uid);for(var iii=0;iii<seriesOne.data.length;iii++){var dataVal1=seriesOne.data[iii];var obj1=[];obj1.push(new Date(dataVal1[0]).getTime());isCompoundVar?obj1.push(isNaN(parseFloat(dataVal1[2]))?null:parseFloat(dataVal1[2])):obj1.push(isNaN(parseFloat(dataVal1[1]))?null:parseFloat(dataVal1[1]));seriesItem.allValueList.push(obj1)}}angular.forEach(all,(function(f,i){var unit=newType[i];var yAxis;if(0===i){var freq="";if(f.frequence){var h=parseInt(f.frequence%86400/3600);h>0&&(freq+=h+"h");var m=parseInt(f.frequence%3600/60);m>0&&(freq+=m+"m");var s=f.frequence%60;s>0&&(freq+=s+"s")}$scope.selectedMetricTypeFrequence=freq;var lastTimeValue=new Date;f.allValueList.length>0&&(lastTimeValue=f.allValueList[f.allValueList.length-1][0]);$scope.selectedMetricTypeCurrentTime=new Date(lastTimeValue)}var seria=null;if(unit){yAxis=unitToAxis(unit,newType.length,f.allValueList);chart.get(yAxis.id)||chart.addAxis(yAxis,!1,!1);var sers={animation:!0,id:unit.uId,name:unit.displayName,yAxis:"%"===unit.unit?"percentY":"numberY",data:f.allValueList,tooltip:{pointFormatter:function(){var yy=isNaN(this.y)?"N/A":this.y;"N/A"!==yy&&(yy=/^-?\d+$/.test(this.y.toString())?Math.round(yy):/^(-?\d+)(\.\d+)?$/.test(this.y.toString())?yy.toFixed(2):"N/A");return'<span style="color:'+this.series.color+'">'+this.series.name+": <b>"+yy+(unit.unit?unit.unit:"")+"</b></span><br/>"},valueSuffix:unit.unit}};"uCompoundVar"===unit.valueType&&(sers.tooltip={pointFormatter:function(){return'<span style="color:{'+this.series.color+'}"></span> '+this.series.name+": <b>"+historyChartSrvc.formatForCompound(this.y)+"</b><br/>"}});sers.color=LEGEND_COLOR[i];seria=chart.addSeries(sers,!1)}1===f.allValueList.length&&seria.update({marker:{enabled:!0,radius:2,symbol:"circle"}})}));(nav=chart.get("nav"))&&nav.setData(seriesItem.allValueList,!1)}else(nav=chart.get("nav"))&&nav.setData([],!1)}chart.redraw();_.each(chart.series,(function(item1){item1.show()}));$scope.loading=!1;if($scope.firstLoad){chart.rangeSelector.buttons[4].setState(2);$scope.firstLoad=!1}}),(function(result){console.warn("GetDeviceDataValueForUnitChartNew call failed",result);$scope.loading=!1;if($scope.firstLoad){chart.rangeSelector.buttons&&chart.rangeSelector.buttons.length>=4&&chart.rangeSelector.buttons[4].setState(2);$scope.firstLoad=!1}}))}else _.each(chart.series,(function(item){item.hide()}))}function unitToAxis(unit,metricLength,allValueList,index){var axisUnit,axisId;axisUnit=metricLength>1&&"%"!==unit.unit?"":unit.unit||"";var axis={id:axisId="%"===unit.unit?"percentY":"numberY",title:{text:""},lineWidth:1,opposite:!(1===metricLength||"%"===unit.unit),labels:{formatter:function(){var retValue=this.value;return null==retValue||isNaN(retValue)?"N/A":retValue+axisUnit}}};if("percentY"==axisId){axis.min=0;axis.max=100;axis.tickPositions=[0,20,40,60,80,100]}var containsAnalysisValue=[];if(1===metricLength){axis.plotLines=[];if(unit.analysisList&&angular.isArray(unit.analysisList)&&unit.analysisList.length>0){_.each(unit.analysisList,(function(each){var threshold=JSON.parse(each.threshold);var thresholdValue=parseFloat(threshold.value);if(!isNaN(thresholdValue)){containsAnalysisValue.push(thresholdValue);axis.plotLines.push({value:thresholdValue,color:"red",dashStyle:"shortdash",width:2})}}));var minA=_.find(axis.plotLines,(function(p){return p.value===Math.min.apply(this,containsAnalysisValue)}));minA&&(minA.color="#ffcc2b")}}axis.tickPositioner=function(){if(unit.valueType===DataUnitType.uCompoundVar)return[-1,0,1,2];if(unit.valueType===DataUnitType.uBool)return[0,1,2];var max=this.dataMax;var min=this.dataMin;var positions=[];var increment=Math.ceil((max-min)/4);increment<10&&(increment=10);var tick;if(min>=0){(tick=min-increment)<0&&(tick=0);if(null!==max&&null!==min){for(;tick-increment<=max;tick+=increment)positions.push(Math.ceil(tick));positions.push(Math.ceil(tick))}}else if(max>0){if(null!==max&&null!==min){for(tick=0;tick+increment>=min;tick-=increment)positions.push(Math.ceil(tick));positions.push(Math.ceil(tick));for(tick=0;tick-increment<=max;tick+=increment)positions.push(Math.ceil(tick));positions.push(Math.ceil(tick))}}else{(tick=max+increment)>0&&(tick=0);if(null!==max&&null!==min){for(;tick+increment>=min;tick-=increment)positions.push(Math.ceil(tick));positions.push(Math.ceil(tick))}}return positions=_.sortBy(_.uniq(positions))};if("uCompoundVar"===unit.valueType){axis.max=2;axis.min=-1;axis.labels.formatter=function(){return historyChartSrvc.formatForCompound(this.value)}}if(containsAnalysisValue.length>0){var allValue=[];_.each(allValueList,(function(item){item[1]&&allValue.push(item[1])}));allValue=allValue.concat(containsAnalysisValue);var maxv=Math.max.apply(Math,allValue);var minv=Math.min.apply(Math,allValue);axis.max=maxv;axis.min=minv}return axis}!function(){chartCreate([]);$scope.refreshDataViewDetailPanel=$rootScope.$on("refreshDataViewDetailPanel",(function(){seriesList($scope.currentMetricType,$scope.currentMetricType)}))}();$scope.$on("$destroy",(function(){scopeWatchCollection();try{$scope.refreshDataViewDetailPanel()}catch(e){}}))}}}]);!function(NetBrain){angular.module("nb.qmap").controller("nb.qmap.nbRequestEditingRightCtrl",nbRequestEditingRightCtrl).filter("filterOddChars",(function(){return function(input){return input?input.replace(/<a>/g,"").replace(/<\/a>/g,""):""}}));nbRequestEditingRightCtrl.$inject=["$scope","$q","$rootScope","nb.admin.httpSystemAdminSrvc","nb.ng.httpAuthSrvc","nb.admin.httpAdminSrvc","$log","$uibModalInstance","nb.ng.userSrvc","nb.qmap.httpMapSrvc","nb.common.nbAlertSrvc","$filter","$timeout","args","nb.qmap.mapManagerSrvc","nb.collaboration.collaborationGridSrvc"];function nbRequestEditingRightCtrl($scope,$q,$rootScope,httpSystemAdminSrvc,httpAuthSrvc,httpAdminSrvc,$log,$uibModalInstance,userSrvc,httpMapSrvc,nbAlertSrvc,$filter,$timeout,args,mapManagerSrvc,collaborationGridSrvc){$scope.isRequest=!1;$scope.localpersonList=[];$scope.personList=[];$scope.selectedUser=null==args.User?{}:args.User;$scope.editingRightModal={};$scope.editingRightModal.Title=args.Title;$scope.editingRightModal.Content=args.Content;$scope.editingRightModal.Tip=args.Tip;$scope.editingRightModal.User=args.User;$scope.editingRightModal.ShowCancel=args.ShowCancel;$scope.editingRightModal.BtnTitle=args.BtnTitle;$scope.permisstionType="";var editRightResult=NetBrain.Map.Const.EditRightResult;var errorMsg="But failed to send email, please contact your NetBrain administrator to double check email setting.";"Transfer"!==args.BtnTitle&&($scope.isRequest=!0);mapManagerSrvc.getActiveMap()&&mapManagerSrvc.getActiveMap().getMapType()===NetBrain.Map.Const.MapType.siteMap&&($scope.permisstionType=NetBrain.NG.Permissions.siteManagement);httpSystemAdminSrvc.getAllUsers().then((function(objList){httpSystemAdminSrvc.getPermissionUsersOnDomain($scope.permisstionType).then((function(obAllUser){for(var i=0;i<objList.length;i++)for(var j=0;j<obAllUser.length;j++)if(objList[i].ID===obAllUser[j].userId){if(objList[i].ID===userSrvc.getUserID())break;$scope.personList.push(objList[i])}$scope.localpersonList=angular.copy($scope.personList);selectedUser=$scope.selectedUser,user=_.find($scope.personList,(function(person){return selectedUser.id===person.ID||selectedUser.name===person.name})),selectedUser.name=user?user.name:selectedUser.name;var selectedUser,user}))}));$scope.ok=function(){if(function(){if(null==$scope.selectedUser||null==$scope.selectedUser.name||""===$scope.selectedUser.name.trim()||!function(username){for(var i=0;i<$scope.personList.length;i++)if(username===$scope.personList[i].name)return!0;return!1}($scope.selectedUser.name)){nbAlertSrvc.warnning("Please select one user to transfer the editing rights of this map.");return!1}return!0}())switch(args.BtnTitle){case"Transfer":!function(option){mapManagerSrvc.transferMapEditRight(option,"The editing rights of an unsaved map cannot be transferred.Do you want to save the map and then transfer its editing rights?").then((function(result){$uibModalInstance.close();var successMsg='The editing rights of map "'+option.MapList[0].MapName+'" has been transferred to '+option.ReceiveUserName+".";showMsgByReturnVal(result,successMsg,successMsg+"<br/>"+errorMsg)}),(function(err){nbAlertSrvc.warning(err)}))}(GetRequestOption());break;case"Request":!function(isEditorOnline){var requestOption=GetRequestOption();requestOption.isEditorOnline=isEditorOnline;httpMapSrvc.requestEditingRight(requestOption).then((function(data){$uibModalInstance.close();if(isEditorOnline)showMsgByReturnVal(data,"Your request has been sent to "+requestOption.ReceiveUserName+".","Your request has been sent to "+requestOption.ReceiveUserName+".<br/>"+errorMsg);else{$scope.isClickedEditRight=!$scope.isClickedEditRight;mapManagerSrvc.getActiveMap().setEditRight(userSrvc.getUserName(),userSrvc.getUserID());showMsgByReturnVal(data,"You are now the editor of this map.","You are now the editor of this map.<br/>"+errorMsg)}}),(function(msg){$log.log("Transfer got error: "+msg)}))}(!0);break;default:console.warn("ok in default!")}};function showMsgByReturnVal(result,successMsg,failedMsg){result===editRightResult.success?(msg=successMsg,(new MapTip).show({message:msg})):result===editRightResult.successButEmailFailed&&nbAlertSrvc.warning(failedMsg);var msg}function GetRequestOption(){var tenandId=httpAuthSrvc.getSelectedTenantId();var domainId=httpAuthSrvc.getSelectedDomainIds()[0];var href=/^http.*\//.exec(document.location.href)[0];var localHref=StringUtil.format(href+NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.Map,{tenantId:tenandId,domainId:domainId,id:mapManagerSrvc.getActiveMap().getDocId()});var collaborationHistoryOption={};var receiveUserId=$scope.selectedUser.id;var receiveUserEmail="";if(receiveUserId)receiveUserEmail=(userId=$scope.selectedUser.id,_.find($scope.personList,{ID:userId})).email;else{receiveUserId=getUserByName($scope.selectedUser.name).ID;receiveUserEmail=getUserByName($scope.selectedUser.name).email}var userId;collaborationHistoryOption.MapList=[];collaborationHistoryOption.MapList.push({MapId:mapManagerSrvc.getActiveMap().getDocId(),MapName:mapManagerSrvc.getActiveMap().getTitle(),imageStr:mapManagerSrvc.getActivePage().realImage});collaborationHistoryOption.ReceiveUserName=$scope.selectedUser.name;var message=$("#editRightTextArea").val()||$scope.editingRightModal.Content;message===NetBrain.Map.Message.ShareMapNotePlaceHolder&&(message="");collaborationHistoryOption.Message=message;collaborationHistoryOption.ReceiveUserId=receiveUserId;collaborationHistoryOption.FilteType=NetBrain.Map.Const.CollaborationFilterType.Map;collaborationHistoryOption.ReceiveUserEmail=receiveUserEmail;collaborationHistoryOption.URL=localHref;return collaborationHistoryOption}function getUserByName(userName){return _.find($scope.personList,{name:userName})}$scope.cancel=function(){$uibModalInstance.dismiss("cancel")};$scope.shareUserClick=function($event,person){person.name&&(person.name=person.name.replace(/<a>/g,"").replace(/<\/a>/g,""));$scope.selectedUser.name=person.name};$scope.inputSelectedUserChanged=function(event,currentUser){$(".nbMapEditingRightDialog .dropdown").addClass("open");$scope.filterCol=currentUser.name.trim();""===$scope.filterCol?$scope.localpersonList=angular.copy($scope.personList):$scope.localpersonList=angular.copy($filter("personListFilter")($scope.personList,$scope.filterCol));var reg=new RegExp($scope.filterCol,"gi");for(var i=0;i<$scope.localpersonList.length;i++){if($scope.localpersonList[i].name){$scope.localpersonList[i].name=$scope.localpersonList[i].name.replace(/<a>/g,"").replace(/<\/a>/g,"");$scope.localpersonList[i].name=$scope.localpersonList[i].name.replace(reg,"<a>"+$scope.filterCol+"</a>")}if($scope.localpersonList[i].email){$scope.localpersonList[i].email=$scope.localpersonList[i].email.replace(/<a>/g,"").replace(/<\/a>/g,"");$scope.localpersonList[i].email=$scope.localpersonList[i].email.replace(reg,"<a>"+$scope.filterCol+"</a>")}}};$scope.inputSelectUserClick=function(){$scope.localpersonList=angular.copy($scope.personList)}}}(NetBrain);angular.module("nb.qmap").directive("nbRequestEditingRightDirective",["$q","$log","$rootScope","$uibModal","nb.qmap.mapManagerSrvc","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.admin.httpSystemAdminSrvc","nb.collaboration.collaborationGridSrvc","nb.admin.domainAdminMgr","nb.ng.permissionSrvc","nb.ng.httpAuthSrvc","nb.common.nbTipSrvc",function($q,$log,$rootScope,$uibModal,mapManagerSrvc,userSrvc,nbAlertSrvc,httpMapSrvc,httpSystemAdminSrvc,collaborationGridSrvc,domainAdminMgr,permissionSrvc,httpAuthSrvc,nbTipSrvc){return{restrict:"A",templateUrl:"modules/nbQmap/views/mapEditRight/nbRequestEditingRight.html",link:function($scope){var _args={};var userName;var userId=userSrvc.getUserID();var permissions=domainAdminMgr.getDomainPermissions();$scope.hasSiteMgrPermission=permissions.hasSiteManagementPerm;$scope.count=0;$scope.hasPermission=!0;mapManagerSrvc.getActiveMap()&&mapManagerSrvc.getActiveMap().getMapType()===NetBrain.Map.Const.MapType.siteMap&&($scope.hasPermission=domainAdminMgr.getDomainPermissions().hasSiteManagementPerm);$scope.showEditRight=function(type){type&&"mapbar"===type?$(".requestEditingRightPopup").css({left:"40px"}):$(".requestEditingRightPopup").css({left:"inherit"});mapManagerSrvc.getActiveMap().realNew?$q.when(checkMapSaved()).then((function(){getData();$scope.isClickedEditRight=!0})):queryEditRightFromServer().then((function(data){var editBy=data.editBy;if(userSrvc.getUserName()===editBy)$q.when(checkMapSaved()).then((function(){getData(data);$scope.isClickedEditRight=!0}));else{getData(data);$scope.isClickedEditRight=!0}}))};function getData(data){var deferred=$q.defer();$scope.requestDialogContent="";$scope.showRelease=!1;$scope.requestBtnTitle="";userId=userSrvc.getUserID();userName=userSrvc.getUserName();if(data){initData(data);deferred.resolve()}else queryEditRightFromServer().then((function(result){initData(result);deferred.resolve()}),(function(reason){deferred.reject(reason)}));return deferred.promise}function initData(data){var editByWho="None";httpSystemAdminSrvc.getAllDisplayUsersOnDomain().then((function(){data.editBy=data.editBy;if(mapManagerSrvc.getActiveMap().realNew)editByWho="Me";else{data.editBy;editByWho=userId===data.editById?"Me":""===data.editById||null==data.editById?"None":"Another"}data.editByWho=editByWho;data.modifyTm>mapManagerSrvc.getActiveMap().getModifyTm()?$rootScope.$emit("changeRefreshStatus","map-updated"):$rootScope.$emit("changeRefreshStatus","map-not-updated");_args.User={};$scope.editByWho=data.editByWho;switch(data.editByWho){case"Me":$scope.requestDialogContent="You are the editor of this map. Other people can view and perform actions on this map, but they cannot save the changes.";$scope.showRelease=!0;$scope.requestBtnTitle="Transfer Editing Rights";_args.Title="Transfer Editing Rights";_args.Content=NetBrain.Map.Message.ShareMapNotePlaceHolder;_args.Tip="Transfer to";_args.ShowCancel=!0;_args.BtnTitle="Transfer";break;case"Another":$scope.requestDialogContent=data.editBy+" is the editor of this map. You can view and perform actions on this map, but you cannot save the changes.";$scope.requestBtnTitle=" Request Editing Rights";_args.isEditorOnline=!0;_args.Title="Request Editing Rights";_args.Content=NetBrain.Map.Message.ShareMapNotePlaceHolder;_args.Tip="Request from";_args.User.name=data.editBy;_args.User.id=data.editById;_args.ShowCancel=!0;_args.BtnTitle="Request";break;case"None":$scope.requestDialogContent="This map is unclaimed. To get its editing rights, click the link below.";$scope.requestBtnTitle="Get Editing Rights";_args.BtnTitle="";break;default:console.warn("initData in default")}$scope.count++}))}function queryEditRightFromServer(){var deferred=$q.defer();var docId=mapManagerSrvc.getActiveMap().getDocId();var editByWho="None";var activeMap=mapManagerSrvc.getActiveMap();var editBy="";var editById="";var modifyTm=mapManagerSrvc.getActiveMap().modifyTm;httpMapSrvc.getMapInfoByKey(docId).then((function(doc){if(mapManagerSrvc.getActiveMap().realNew)editByWho="Me";else{if(void 0===doc){$log.error("getMapByKey got error!");return deferred.reject("getMapByKey got error!")}var editor=doc.editor;if(editor&&editor.opUserId){editBy=editor.opUser;editById=editor.opUserId;activeMap.setEditRight(editBy,editById)}else{editBy="";activeMap.setEditRight("")}modifyTm=doc.modifyTm;var isEditorOnline=doc.isEditorOnline;editByWho=userSrvc.getUserID()===editBy?"Me":""===editBy||null==editBy?"None":"Another"}return deferred.resolve({editByWho:editByWho,editBy:editBy,editById:editById,isEditorOnline:isEditorOnline,modifyTm:modifyTm||"None"})}));return deferred.promise}function getEditingRight(){var mapId=mapManagerSrvc.getActiveMap().getDocId();httpMapSrvc.getEditingRight(mapId).then((function(){$scope.isClickedEditRight=!$scope.isClickedEditRight;mapManagerSrvc.getActiveMap().setEditRight(userName,userId);(new window.MapTip).show({message:"You are now the editor of this map."});closeEditingRightsTip()}),(function(msg){$log.info("getEditingRight get error: "+msg)}))}function checkMapSaved(msg){var deferred=$q.defer();var activeMap=mapManagerSrvc.getActiveMap();if(null==activeMap)return $.reject();var msgTitle=msg||'The map "'+activeMap.getTitle()+'" has been modified, do you want to save?';activeMap.realNew||activeMap.isModify()?nbAlertSrvc.confirm(msgTitle).then((function(){mapManagerSrvc.saveMap().then((function(){deferred.resolve()}),(function(error){deferred.reject(error)}))}),(function(result){2===result?deferred.reject("cancel"):deferred.resolve()})):deferred.resolve();return deferred.promise}$scope.getEditingRight=getEditingRight;$scope.releaseEditingRight=function(event){if($scope.hasPermission){mapManagerSrvc.checkMapSaved("The editing rights of an unsaved map cannot be released.Do you want to save the map and then release its editing right?","").then((function(){var mapId=mapManagerSrvc.getActiveMap().getDocId();collaborationGridSrvc.getCollaborationHistory().then((function(res){_.each(res.requestsAndTransfers,(function(item){var mapIds=_.pluck(item.mapList,"mapId");if(_.contains(mapIds,mapId)&&!item.haveProcessed&&2===item.type){item.receiveUserName=item.fromUserName;item.receiveUserId=item.fromUserId;mapManagerSrvc.denyMapEditRight(item).then((function(){}))}}))}));httpMapSrvc.releaseEditingRight(mapId).then((function(){mapManagerSrvc.getActiveMap().setEditRight("");mapManagerSrvc.getActiveMap().isTempEditRight=!1;$rootScope.$emit("releaseTempEditRight");$scope.isClickedEditRight=!$scope.isClickedEditRight;(new window.MapTip).show({message:"You have successfully released the editing rights of this map."});$scope.$emit(NetBrain.Map.Event.ShowEditingRightsTip)}),(function(data){$log.error("releaseEditingRight get error: "+data.ResultDesc)}))}));event.preventDefault()}else nbAlertSrvc.warning("Failed to release the editing rights due to the insufficient privilege of Site Management.")};function closeEditingRightsTip(){$scope.editingRightsTipId&&nbTipSrvc.close($scope.editingRightsTipId)}$scope.openEditingRightDialog=function(){if("Request"===_args.BtnTitle&&permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.domainMgmt))(function(){var deferred=$q.defer();var tenandId=httpAuthSrvc.getSelectedTenantId();var domainId=httpAuthSrvc.getSelectedDomainIds()[0];var href=/^http.*\//.exec(document.location.href)[0];var localHref=StringUtil.format(href+NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.Map,{tenantId:tenandId,domainId:domainId,id:mapManagerSrvc.getActiveMap().getDocId()});var editRighter=mapManagerSrvc.getActiveMap().getEditRight();httpSystemAdminSrvc.getUserByGuid(editRighter.editorId).then((function(receiveUser){var collaborationHistoryOption={};var receiveUserId=editRighter.editorId;var receiveUserEmail=receiveUser?receiveUser.email:"";collaborationHistoryOption.MapList=[];collaborationHistoryOption.MapList.push({MapId:mapManagerSrvc.getActiveMap().getDocId(),MapName:mapManagerSrvc.getActiveMap().getTitle(),imageStr:mapManagerSrvc.getActivePage().realImage});collaborationHistoryOption.ReceiveUserName=editRighter.editorName;collaborationHistoryOption.Message="";collaborationHistoryOption.ReceiveUserId=receiveUserId;collaborationHistoryOption.FilteType=NetBrain.Map.Const.CollaborationFilterType.Map;collaborationHistoryOption.ReceiveUserEmail=receiveUserEmail;collaborationHistoryOption.URL=localHref;deferred.resolve(collaborationHistoryOption)}));return deferred.promise})().then((function(requestOption){collaborationOption=requestOption,httpMapSrvc.forceGetEditingRight(collaborationOption).then((function(){$scope.isClickedEditRight=!$scope.isClickedEditRight;mapManagerSrvc.getActiveMap().setEditRight(userName,userId);(new window.MapTip).show({message:"You are now the editor of this map."});closeEditingRightsTip()}),(function(msg){$log.info("forceGetEditingRight get error: "+msg)}));var collaborationOption}));else if(_args.BtnTitle)$scope.hasPermission?$uibModal.open({animation:!0,templateUrl:"modules/nbQmap/views/mapEditRight/nbEditingRightModalContent.html",controller:"nb.qmap.nbRequestEditingRightCtrl",size:"lg",resolve:{args:function(){return _args}}}).result.then((function(){$scope.isClickedEditRight=!1})):nbAlertSrvc.warning("Failed to request the editing rights due to the insufficient privilege of Site Management.");else{if(!$scope.hasPermission){nbAlertSrvc.warning("Failed to obtain the editing rights due to the insufficient privilege of Site Management.");return}getEditingRight()}};$scope.$on("openTransferEditRightDialog",(function(){mapManagerSrvc.getActiveMap().realNew||getData().then((function(){$scope.openEditingRightDialog()}))}));$scope.$on(NetBrain.Map.Event.ShowEditingRightsTip,(function(){if(!$scope.editingRightsTipId){var options={tipInfo:"",hasCloseBtn:!0,autoClose:!1,customClass:"editingRightsTip",template:'<div style="text-align:left;">'+NetBrain.Map.Message.IsOnlyViewMapTipMsg+"</div>",position:{right:2,top:30},closeCallback:function(){$scope.editingRightsTipId=null}};var editingRightsTipId=nbTipSrvc.open(options);$scope.editingRightsTipId=editingRightsTipId}}))}}}]);NetBrain,angular.module("nb.qmap").directive("nbL2PortTip",["nb.qmap.updateMapSrvc",function(updateMapSrvc){return{restrict:"E",templateUrl:"modules/nbQmap/views/nbL2PortTip.html",scope:{tipInfo:"=",addInterfaceNote:"&"},link:function(scope,element,attrs){scope.onClick=function($event){$event.stopPropagation()};scope.element=element;element.find(".L2PortTip").draggable({containment:".realActive .map-canvas-containter",scroll:!1});scope.dropTip=function(position){var parentWidth=this.element.offsetParent().width();var parentHeight=this.element.offsetParent().height();var left=parseInt(position.left),top=parseInt(position.top);left<0?left=0:left+300>parentWidth&&(left=parentWidth-300);top<0?top=0:top+220>parentHeight&&(top=parentHeight-220);position.left=left+"px";position.top=top+"px";return position}},controller:["$scope","$element","$attrs","$timeout","nb.qmap.mapManagerSrvc","nb.ng.userSrvc",function($scope,element,attr,$timeout,mapManagerSrvc,userSrvc){var scope=$scope;element.on("mouseenter",(function(){scope.$parent.$parent.closeL2PortTimer&&$timeout.cancel(scope.$parent.$parent.closeL2PortTimer)}));element.on("mouseleave",(function(){scope.$parent.$parent.closeL2PortTip&&scope.$parent.$parent.closeL2PortTip(250)}));scope.addInterfaceNote=function(){updateMapSrvc.canUpdateCurrentMap().then((function(){var tipInfo=scope.tipInfo;var note={title:tipInfo.title,content:"",user:userSrvc.getUserName(),time:new Date};_.each(tipInfo.data,(function(item,index){note.content+=item.title+": "+item.value+"\r\n"}),note);mapManagerSrvc.getActivePage().getNetmapOperator().mergeIntfNoteRefDevice(tipInfo.devId,tipInfo.intf,note)}))}}]}}]);NetBrain,angular.module("nb.qmap").directive("nbTopoLinkTip",[function(){return{restrict:"E",templateUrl:"modules/nbQmap/views/nbTopoLinkTip.html",scope:{tipInfo:"="},link:function(scope,element,attrs){scope.onClick=function($event){$event.stopPropagation()};scope.element=element;element.find(".L2PortTip").draggable({containment:".realActive .map-canvas-containter",scroll:!1});scope.dropTip=function(position){position=position||{left:100,top:100};var parentWidth=this.element.offsetParent().width();var parentHeight=this.element.offsetParent().height();var left=parseInt(position.left),top=parseInt(position.top);left<0?left=0:left+300>parentWidth&&(left=parentWidth-300);top<0?top=0:top+220>parentHeight&&(top=parentHeight-220);position.left=left+"px";position.top=top+"px";return position}}}}]);NetBrain,angular.module("nb.qmap").directive("nbSiteInfoTip",[function(){return{restrict:"E",templateUrl:"modules/nbQmap/views/nbSiteInfoTipDirective.html",scope:{tipInfo:"="},link:function(scope,element,attrs){scope.onClick=function($event){$event.stopPropagation()};scope.element=element;element.find(".siteInfoTip").draggable();scope.dropTipPosition=function(position){var parentWidth=this.element.offsetParent().width();var parentHeight=this.element.offsetParent().height();var left=parseInt(position.left),top=parseInt(position.top);left<0?left=0:left+300>parentWidth&&(left=parentWidth-300);top<0?top=0:top+220>parentHeight&&(top=parentHeight-220);position.left=left+"px";position.top=top+"px";return position}},controller:["$scope","$element","$attrs","$timeout",function($scope,element,attr,$timeout){var scope=$scope;element.on("mouseenter",(function(){scope.$parent.$parent.closeSiteInfoTimer&&$timeout.cancel(scope.$parent.$parent.closeSiteInfoTimer)}));element.on("mouseleave",(function(){scope.$parent.$parent.closeSiteInfoTip&&scope.$parent.$parent.closeSiteInfoTip(250)}))}]}}]);NetBrain,angular.module("nb.qmap").directive("nbEditorToolbarDirective",["nb.qmap.editorToolbarOptions","nb.qmap.editorToolbarManager","nb.qmap.editorToolbarAction","$document",function(editorToolbarOptions,editorToolbarManager,editorToolbarAction){return{scope:{},restrict:"E",templateUrl:"modules/nbQmap/views/editorToolbar.html",replace:!1,link:function(scope,element){scope.element=element;$(scope.element).draggable();scope.$watch((function(){return editorToolbarOptions.getOptions()}),(function(options){if(options){scope.options=options;scope.isShow=options.isShow;editorToolbarManager.init(scope,options)}}))},controller:["$scope",function($scope){$scope.toggleSubmenu=function(event){var li=angular.element(event.target).parent();var submenu=li.children(".submenu");li.siblings().find(".selected").removeClass("selected");li.find(".selected").removeClass("selected");submenu.addClass("selected")};$scope.changeFonts=function(font){editorToolbarAction.changeFonts($scope,font)};$scope.changeFontSize=function(font){editorToolbarAction.changeFontSize($scope,font)};$scope.fontColorChanged=function(color){editorToolbarAction.fontColorChanged($scope,color)};$scope.fontBold=function(){editorToolbarAction.fontBold($scope)};$scope.fontItalic=function(){editorToolbarAction.fontItalic($scope)};$scope.fontUnderLine=function(){editorToolbarAction.fontUnderLine($scope)};$scope.fontThrough=function(){editorToolbarAction.fontThrough($scope)};$scope.pragraphList=function(){editorToolbarAction.pragraphList($scope)};$scope.pragraphAlign=function(align){editorToolbarAction.pragraphAlign($scope,align)};$scope.linkWeightSelected=function(weight){editorToolbarAction.linkWeightSelected($scope,weight);$scope.isShow=!1};$scope.linkStyleSelected=function(style){editorToolbarAction.linkStyleSelected($scope,style);$scope.isShow=!1};$scope.linkColorSelected=function(color){editorToolbarAction.linkColorSelected($scope,color)};$scope.fillColorSelected=function(color){editorToolbarAction.fillColorSelected($scope,color)};$scope.linkArrowSelected=function(type,arrow){editorToolbarAction.linkArrowSelected($scope,type,arrow);$scope.isShow=!1};$scope.changeArrange=function(arrange){editorToolbarAction.changeArrange($scope,arrange);$scope.isShow=!1};$scope.clickOutSide=function(){}}]}}]);!function(NetBrain){angular.module("nb.qmap").factory("nb.qmap.editorToolbarAction",["nb.qmap.editorToolbarManager","nb.qmap.updateMapSrvc","nb.qmap.mapManagerSrvc",function(editorToolbarManager,updateMapSrvc,mapManagerSrvc){function setFont($scope,partIndex,pValue){var textblock=$scope.data.textblock;var textEditor=$scope.data.textEditor.mainElement;var style=editorToolbarManager.parseFont(textblock);var styleArray=[style.fontStyle,style.fontWeight,style.fontSize,style.fontFamily];if(partIndex>=0&&partIndex<styleArray.length){var value=pValue;if(0===partIndex){value="italic"===style.fontStyle?"normal":"italic";styleArray[partIndex]=value}else if(1===partIndex){value="700"===style.fontWeight||"bold"===style.fontWeight?"normal":"bold";styleArray[partIndex]=value}else styleArray[partIndex]=value}var newStyle=styleArray[0]+" normal "+styleArray[1]+" "+styleArray[2]+" "+styleArray[3];textblock.font=newStyle;textEditor.style.font=newStyle;setTimeout(textEditor.fontChanged,0)}function setTextDecoration($scope,type){var textblock=$scope.data.textblock;var textEditor=$scope.data.textEditor.mainElement;var textDecoration="";var underline=textEditor.style.textDecoration.match(/underline/gi);var lineThrough=textEditor.style.textDecoration.match(/line-through/gi);"underline"===type&&lineThrough?textDecoration+=lineThrough[0]+" ":"line-throuth"===type&&underline&&(textDecoration+=underline[0]+" ");"underline"!==type||textblock.isUnderline?"line-throuth"!==type||textblock.isStrikethrough||(textDecoration+="line-through"):textDecoration+="underline";textDecoration.length>0?textEditor.style.textDecoration=textDecoration:textEditor.style.textDecoration="none";"underline"===type?textblock.isUnderline=!textblock.isUnderline:"line-throuth"===type&&(textblock.isStrikethrough=!textblock.isStrikethrough)}return{changeFonts:function($scope,font){setFont($scope,3,font.value)},changeFontSize:function($scope,font){setFont($scope,2,font.size+"px ")},fontColorChanged:function($scope,color){var textblock=$scope.data.textblock;var textEditor=$scope.data.textEditor.mainElement;textblock.stroke=$scope.fontColor=color;textEditor.style.color=color},fontBold:function($scope){setFont($scope,1)},fontItalic:function($scope){setFont($scope,0)},fontUnderLine:function($scope){setTextDecoration($scope,"underline")},fontThrough:function($scope){setTextDecoration($scope,"line-throuth")},pragraphList:function($scope){var textblock=$scope.data.textblock;var textEditor=$scope.data.textEditor.mainElement;var text=textblock.text;text=String.fromCharCode(9679)+" "+text.replace(/\n/g,"\n "+String.fromCharCode(9679)+" ");textEditor.value=text},pragraphAlign:function($scope,align){var textblock=$scope.data.textblock;var textEditor=$scope.data.textEditor.mainElement;textblock.textAlign=align;textEditor.style.textAlign=align},linkWeightSelected:function($scope,weight){updateMapSrvc.canUpdateCurrentMap().then((function(){$scope.data.shape.setLineWidth($scope.data.part,weight)}))},linkStyleSelected:function($scope,style){updateMapSrvc.canUpdateCurrentMap().then((function(){$scope.data.shape.setLineStyle($scope.data.part,style)}))},linkColorSelected:function($scope,color){updateMapSrvc.canUpdateCurrentMap().then((function(){$scope.data.shape.setLineColor($scope.data.part,color)}))},fillColorSelected:function($scope,color){updateMapSrvc.canUpdateCurrentMap().then((function(){$scope.data.shape.setBackColor($scope.data.part,color);$scope.data.shape.category===NetBrain.Map.CategoryMgr.Text&&$scope.data.shape.setTextBlockBackColor($scope.data.part,color)}))},linkArrowSelected:function($scope,fromTo){$scope.data.shape.setLineArrow($scope.data.part,fromTo)},changeArrange:function($scope,arrange){var netmapCmd=mapManagerSrvc.getActivePage().getCmdTarget();switch(arrange){case"alignLeft":netmapCmd.onAlignLeft();break;case"alignRight":netmapCmd.onAlignRight();break;case"alignTop":netmapCmd.onAlignTop();break;case"alignBottom":netmapCmd.onAlignBottom();break;case"alignCenterY":netmapCmd.onAlignCenterY();break;case"alignCenterX":netmapCmd.onAlignCenterX()}},submitNoteToolText:function(){var netmap=mapManagerSrvc.getActivePage();if(netmap){var operator=netmap.getNetmapOperator();operator&&operator.submitNoteToolText()}}}}])}(NetBrain);angular.module("nb.qmap").factory("nb.qmap.editorToolbarManager",[function(){function parseFont(textblock){var div=angular.element("<div></div>")[0];div.style.font=textblock.font;var style=div.style;return{fontStyle:style.fontStyle,fontWeight:style.fontWeight,fontSize:style.fontSize,fontFamily:style.fontFamily}}return{init:function(scope,options){if(scope.isShow){scope.textBar=!1;scope.shapeBar=!1;var data=options.data;scope.data=data;!function($scope,data){if(data.textblock){$scope.fontColors={preferredFormat:"hex",color:"black",showPaletteOnly:!0,togglePaletteOnly:!0,cancelText:"Cancel",chooseText:"Choose",togglePaletteMoreText:"More",togglePaletteLessText:"Less",hideAfterPaletteSelect:!0,showInput:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]]};$scope.fontColors.color=data.textblock.stroke;$scope.fontColor=data.textblock.stroke}else{$scope.lineColors={preferredFormat:"hex",color:"black",showPaletteOnly:!0,togglePaletteOnly:!0,cancelText:"Cancel",chooseText:"Choose",togglePaletteMoreText:"More",togglePaletteLessText:"Less",hideAfterPaletteSelect:!0,showInput:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]]};$scope.lineColors.color=data.shape.shapeLineColor||data.shape.stroke;$scope.lineColorPicked=data.shape.shapeLineColor;$scope.fillColors={preferredFormat:"hex",color:"black",showPaletteOnly:!0,togglePaletteOnly:!0,cancelText:"Cancel",chooseText:"Choose",togglePaletteMoreText:"More",togglePaletteLessText:"Less",hideAfterPaletteSelect:!0,showInput:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]]};$scope.fillColors.color=data.shape.color;$scope.bgColorPicked=data.shape.color}}(scope,data);if(data.textblock){var font=parseFont(data.textblock);!function($scope,fontFamily){$scope.fonts=[{name:"Georgia",value:"'Georgia, serif'"},{name:"Palatino",value:"'Palatino Linotype', 'Book Antiqua', Palatino, serif"},{name:"Times New Roman",value:"'Times New Roman', Times, serif"},{name:"Arial",value:"Arial, 'Arial Black', Gadget, sans-serif"},{name:"Comic Sans MS",value:"'Comic Sans MS', cursive, sans-serif"},{name:"Impact",value:"Impact, Charcoal, sans-serif"},{name:"Open Sans",value:"'open sans'"}];$scope.font=$scope.fonts[0];fontFamily=fontFamily.replace(/['"]/g,"").replace(/\s*,\s*/g,",");var font=_.find($scope.fonts,(function(item){var value=item.value.replace(/['"]/g,"").replace(/\s*,\s*/g,",");return value.indexOf(fontFamily)>=0||fontFamily.indexOf(value)>=0}));font&&($scope.font=font)}(scope,font.fontFamily);!function($scope,size){$scope.fontSizes=[{size:"16",title:"Normal Text"}];for(var i=8;i<=30;i++)$scope.fontSizes.push({size:""+i,title:""+i});$scope.fontSize=$scope.fontSizes[0];var fontSize=_.find($scope.fontSizes,(function(item){return item.size===size.toString()}));fontSize&&($scope.fontSize=fontSize)}(scope,parseInt(font.fontSize));!function($scope,data){var textblock=data.textblock;var textEditor=data.textEditor.mainElement;textEditor.style.font=textblock.font;textEditor.style.color=textblock.stroke;textEditor.style.textDecoration="none";var textDecoration="";textblock.isUnderline&&(textDecoration+="underline ");textblock.isStrikethrough&&(textDecoration+="line-through");textDecoration.length>0&&(textEditor.style.textDecoration=textDecoration);textEditor.style.textAlign=textblock.textAlign}(0,data);scope.textBar=!0}else if(data.shape)if(data.part.diagram.selection.count>1)!function(data){data.part.diagram.selection.count>1&&data.part.diagram.selection.each((function(item){"Line"===item.part.data.category&&!0}))}(data);else{scope.shapeBar=!0;scope.lineWeightList=[{weight:1,tooltip:"1px"},{weight:2,tooltip:"2px"},{weight:5,tooltip:"5px"},{weight:8,tooltip:"8px"},{weight:15,tooltip:"15px"},{weight:25,tooltip:"25px"}]}}!function($scope,options){$scope.element[0].style.left="0";$scope.element[0].style.top="0";var width;width=$scope.textBar?297:$scope.shapeBar?205:290;var maxWidth=$scope.element.offsetParent().width();var left=options.data.position.right+10;options.data.isMapPanelShow&&(left+=460);if(left+width>maxWidth)if($scope.shapeBar){left=options.data.position.left-width/2-20;options.data.isMapPanelShow&&(left+=460)}else left=options.data.position.left-width-20;options.data.position.left=left;options.data.position.top<70&&(options.data.position.top=70);$scope.toolbarPosition=options.data.position}(scope,options)},parseFont:parseFont}}]);NetBrain,angular.module("nb.qmap").factory("nb.qmap.editorToolbarOptions",[function(){var options=null;return{setOptions:function(data,isShow){options={data:data,isShow:isShow}},changeShowState:function(state){null!=options&&((options=_.clone(options)).isShow=void 0!==state?state:!options.isShow)},getOptions:function(){return options}}}]);NetBrain,angular.module("nb.qmap").factory("nb.qmap.mapContextMenuConfig",["$timeout","nb.qmap.mapContextMenuAction","nb.runbook.mapTargetDeviceSrvc","nb.admin.httpDomainAdminNewSrvc",function($timeout,mapContextMenuAction,mapTargetDeviceSrvc,httpDomainAdminNewSrvc){var _autoLinkSubMenu=[];var _autoLinkByNodesSubMenu=[];var _runbookBuiltInList;var enabledStartTelnetSSHCLITool=!1;if(angular.isArray(NetBrain.AllTopoLinkType)){var idx=0;NetBrain.AllTopoLinkType.forEach((function(item){var object={};object.id=item.ID;object.subMenus=getAutoLinkThirdLevelSubMenus(item);object.title=item.name;object.showDivider=++idx==NetBrain.AllTopoLinkType.length;object.action=function(){};_autoLinkSubMenu.push(object);var byNodesObj=angular.copy(object);byNodesObj.subMenus=getAutoLinkThirdLevelSubMenus(item,!0);_autoLinkByNodesSubMenu.push(byNodesObj)}));mapTargetDeviceSrvc.buildForContext().then((function(data){_runbookBuiltInList=data}),(function(ev){console.warn(ev)}));$timeout((function(){httpDomainAdminNewSrvc.getDomainLiveSettingOptions().then((function(result){enabledStartTelnetSSHCLITool=result&&result.enabledTelnetSSHTool}))}),1e3)}function getAutoLinkThirdLevelSubMenus(item,onlyBetweenDevices){return[{id:item.ID,title:"Select",action:function(){mapContextMenuAction.selectAllLinkByTopoType(item.ID,item.name,onlyBetweenDevices)},subMenus:null,showDivider:!1},{id:item.ID,title:"Add Link",action:function(){mapContextMenuAction.autoLink(item.ID,item.name,onlyBetweenDevices)},subMenus:null,showDivider:!1},{id:item.ID,title:"Unlink All",action:function(){mapContextMenuAction.unlinkAllByTopoType(item.ID,item.name,onlyBetweenDevices)},subMenus:null,showDivider:!1}]}function getChangeLinkLineThicknessSubMenus(){var data=[];_.each(NetBrain.Map.Const.contextMenuLineWeightList,(function(weight){var obj={title:'<span class="map-context-menu-line-thickness-title">'+weight+'px</span><i class="map-context-menu-line-thickness" style="height: '+weight+'px;"></i>',action:function(){mapContextMenuAction.changeLinkLineThickness(weight)},subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"changeLinkLineThickness"+weight};data.push(obj)}));return data}function getChangeLinkLineStyleSubMenus(){var data=[];_.each(NetBrain.Map.Const.contextMenuLineStyleList,(function(item,index){var obj={title:'<i class="'+item.className+'"></i>',action:function(){mapContextMenuAction.changeLinkLineDashType(item.type)},subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"changeLinkLineStyle"+index};data.push(obj)}));return data}return function(){return angular.merge({configurationFile:{title:"Configuration File",image:"icon_nb_Configuration_File",action:mapContextMenuAction.configurationFile,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"configurationFile"},dataTables:{title:"Data Tables",image:"icon_nb_Data_Tables",action:null,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"dataTables"},sharedDeviceSettings:{title:"Shared Device Settings",image:"icon_nb_Shared_Device_Settings",action:mapContextMenuAction.sharedDeviceSettings,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"sharedDeviceSettings"},privateCLISettings:{title:"Private CLI Settings",image:"Private_CLI_Settings",action:mapContextMenuAction.privateCLISettings,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"privateCLISettings"},startTelnetSSHCLITool:{title:"Telnet/SSH CLI",image:"run-cli-command-16",action:mapContextMenuAction.startTelnetSSHCLITool,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"telnetSSHCLI",enabled:enabledStartTelnetSSHCLITool},smartTelnetSSHCLITool:{title:"Smart CLI",image:"smart_cli_16",action:mapContextMenuAction.smartTelnetSSHCLITool,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"smartTelnetSSHCLI"},deviceDetailsPane:{title:"View Device Details",image:"icon_nb_View_Device_Details",action:mapContextMenuAction.deviceDetailsPane,subMenus:null,showDivider:!1,isCheckMapLocked:!1},deviceContextMapsPane:{title:"View Context Maps",image:"icon_nb_map16",action:mapContextMenuAction.deviceContextMapsPane,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"deviceDetailsPane"},runQapp:{title:"Run Qapp",image:"run-qapp-16",action:mapContextMenuAction.runQapp,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"runQapp"},pingTo:{title:"Ping to",image:"ping-to-16",action:mapContextMenuAction.pingTo,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"pingTo"},pingFrom:{title:"Ping from",image:"ping-to-16",action:mapContextMenuAction.pingFrom,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"pingFrom"},tracerouteTo:{title:"Traceroute to",image:"trace-route-to-16",action:mapContextMenuAction.tracerouteTo,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"tracerouteTo"},tracerouteFrom:{title:"Traceroute from",image:"trace-route-to-16",action:mapContextMenuAction.tracerouteFrom,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"tracerouteFrom"},retrieveLiveData:{title:"Retrieve Live Data",image:"retrieve-live-data-16",action:mapContextMenuAction.retrieveLiveData,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"retrieveLiveData"},showPortChannel:{title:"Show Port Channel",image:"icon_nb_Port_Channel",action:mapContextMenuAction.showPortChannel,isCheckMapLocked:!0,atag:"showPortChannel"},showPhysicalPorts:{title:"Show Physical Ports",image:"icon_nb_Port_Channel",action:mapContextMenuAction.showPhysicalPorts,isCheckMapLocked:!0,atag:"showPhysicalPorts"},createNote:{title:"Create Note",image:"icon_nb_note_16",action:mapContextMenuAction.createNote,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"createNote"},pinDevices:{title:"Pin Devices",image:"note_02",action:mapContextMenuAction.pinDevices,subMenus:null,showDivider:!1,isCheckMapLocked:!0},autoLink:{title:"Auto Link",image:"icon_nb_Auto_Link",action:null,subMenus:_autoLinkSubMenu,showDivider:!1,isCheckMapLocked:!0,atag:"autoLink"},autoLinkByNodes:{title:"Auto Link",image:"icon_nb_Auto_Link",action:null,subMenus:_autoLinkByNodesSubMenu,showDivider:!1,isCheckMapLocked:!0,atag:"autoLink"},autoLinkForMedia:{title:"Auto Link",image:"icon_nb_Auto_Link",action:mapContextMenuAction.autoLinkForMedia,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"autoLink"},viewVirtualRouteTable:{title:"View Virtual Route Table",image:"icon_nb_View_Virtual_Route_Table",action:mapContextMenuAction.viewVirtualRouteTable,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"viewVirtualRouteTable"},extendNeighbors:{title:"Extend Neighbors",image:"icon_nb_Extend_Neighbors",action:mapContextMenuAction.extendNeighbors,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"extendNeighbors"},openSiteMap:{title:"Open Site Map",image:"icon_nb_Open_Site_Map",action:mapContextMenuAction.openSiteMap,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"openSiteMap"},collapseAllChildSite:{title:"Collapse All Child Site",image:"icon_nb_Collapse_All_Child_Site",action:mapContextMenuAction.collapseAllChildSite,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"collapseAllChildSite"},locateInSitePane:{title:"Locate in Site Pane",image:"icon_nb_Locate_in_Site_Pane",action:mapContextMenuAction.locateInSitePane,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"locateInSitePane"},mapDevicesInSite:{title:"Map Devices in Site",image:"icon_nb_Map_Devices_in_Site",action:mapContextMenuAction.mapDevicesInSite,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"mapDevicesInSite"},openDeviceGroupMap:{title:"Open Group Map",image:"icon_nb_Open_Device_Group_Map",action:mapContextMenuAction.openDeviceGroupMap,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"openDeviceGroupMap"},mapDevicesInDeviceGroup:{title:"Map Devices in Device Group",image:"icon_nb_Map_Devices_in_DeviceGroup",action:mapContextMenuAction.mapDevicesInDeviceGroup,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"mapDevicesInDeviceGroup"},layout:{title:"Layout",image:"icon_nb_Layout",action:null,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"layout"},layoutStyles:{title:"Auto Layout",image:"icon_nb_Layout",action:mapContextMenuAction.layoutStyles,subMenus:null,showDivider:!1,isCheckMapLocked:!0},saveAsSampleLayout:{title:"Save as Sample Layout",image:"icon_nb_save_as_16",action:mapContextMenuAction.saveAsSampleLayout,subMenus:null,showDivider:!1,isCheckMapLocked:!0},IconSettings:{title:"Icon Settings",image:"icon_nb_Change_Device_Style",action:null,subMenus:[{title:"Large",image:"",action:mapContextMenuAction.iconSettingLarge,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"iconSettingLarge"},{title:"Medium",image:"",action:mapContextMenuAction.iconSettingMedium,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"iconSettingMedium"},{title:"Small",image:"",action:mapContextMenuAction.iconSettingSmall,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"iconSettingSmall"}],showDivider:!0},portChannel:{title:"Port Channel",image:"icon_nb_Port_Channel",action:null,subMenus:[{title:"Show All Logic Ports",action:mapContextMenuAction.showAllPortChannels,isCheckMapLocked:!0,atag:"showAllPortChannels"},{title:"Show All Physical Ports",action:mapContextMenuAction.showAllPhysicalPorts,isCheckMapLocked:!0,atag:"showAllPhysicalPorts"}],showDivider:!0,isCheckMapLocked:!0},changeDeviceStyle:{title:"Change Device Style",image:"icon_nb_Change_Device_Style",action:null,subMenus:[{title:"Compact Style",image:"",action:mapContextMenuAction.compactStyle,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"compactStyle"},{title:"Expanded Style",image:"",action:mapContextMenuAction.expandedStyle,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"expandedStyle"}],showDivider:!1},viewChangeAnalysisReport:{title:"View Change Analysis Report",image:"app_nb_ca_report_16",action:mapContextMenuAction.viewChangeAnalysisReport,showDivider:!0},symmetricLayout:{title:"Symmetric Layout",image:"",action:mapContextMenuAction.symmetricLayoutNew,subMenus:null,showDivider:!1,bigImage:"Symmetric_Layout",isCheckMapLocked:!0,atag:"symmetricLayoutNew"},symmetricLayoutNew:{title:"Symmetric Layout New",image:"",action:mapContextMenuAction.symmetricLayoutNew,subMenus:null,showDivider:!1,bigImage:"Symmetric_Layout",isCheckMapLocked:!0,atag:"symmetricLayoutNew"},circularLayout:{title:"Circular Layout",image:"",action:mapContextMenuAction.circularLayout,subMenus:null,showDivider:!1,bigImage:"Circular_Layout",isCheckMapLocked:!0,atag:"circularLayout"},hierarchicalLayout:{title:"Hierarchical Layout",image:"",action:mapContextMenuAction.hierarchicalLayout,subMenus:null,showDivider:!1,bigImage:"Hierarchical_Layout",isCheckMapLocked:!0,atag:"hierarchicalLayout"},orthogonalLayout:{title:"Orthogonal Layout",image:"",action:mapContextMenuAction.orthogonalLayout,subMenus:null,showDivider:!1,bigImage:"Orthogonal_Layout",isCheckMapLocked:!0,atag:"orthogonalLayout"},treeLayoutUp:{title:"Tree Layout Up",image:"",action:mapContextMenuAction.treeLayoutUp,subMenus:null,showDivider:!1,bigImage:"Tree_Layout_Up",isCheckMapLocked:!0,atag:"treeLayoutUp"},treeLayoutDown:{title:"Tree Layout Down",image:"",action:mapContextMenuAction.treeLayoutDown,subMenus:null,showDivider:!1,bigImage:"Tree_Layout_Down",isCheckMapLocked:!0,atag:"treeLayoutDown"},treeLayoutold:{title:"Tree Layout",image:"",action:mapContextMenuAction.treeLayout,subMenus:null,showDivider:!1,bigImage:"",isCheckMapLocked:!0,atag:"treeLayout"},exeCliCmd:{title:"Execute CLI Commands",action:mapContextMenuAction.exeCliCmd,image:"run-cli-command-16",subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"exeCliCmd"},displayTopologyViewAllLeafSites:{title:"Display All Leaf Sites",action:mapContextMenuAction.displayTopologyViewAllLeafSites,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"displayTopologyViewAllLeafSites"},dataview:{title:"Data View",action:null,image:"action_node_dynamic_dataview_16",subMenus:[{title:"Clear All",action:mapContextMenuAction.clearAllDataview,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"clearAllDataview"},{title:"Save As",action:mapContextMenuAction.saveAsDataview,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"saveAsDataview"}],showDivider:!0,isCheckMapLocked:!0},mapTracerouteResult:{title:"Map Traceroute Result",action:mapContextMenuAction.mapTracerouteResult,image:"icon_nb_map_traceroute_result",subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"mapTracerouteResult"},alignLeft:{title:"Align Left(Alt+L)",image:"icon_nb_align_left_16",action:mapContextMenuAction.alignLeft,subMenus:null,showDivider:!1,isCheckMapLocked:!0},alignCenterX:{title:"Align Center(Alt+C)",image:"icon_nb_align_center_16",action:mapContextMenuAction.alignCenterX,subMenus:null,showDivider:!1,isCheckMapLocked:!0},alignRight:{title:"Align Right(Alt+R)",image:"icon_nb_align_right_16",action:mapContextMenuAction.alignRight,subMenus:null,showDivider:!1,isCheckMapLocked:!0},alignTop:{title:"Align Top(Alt+T)",image:"icon_nb_align_top_16",action:mapContextMenuAction.alignTop,subMenus:null,showDivider:!1,isCheckMapLocked:!0},alignCenterY:{title:"Align Middle(Alt+M)",image:"icon_nb_align_middle_16",action:mapContextMenuAction.alignCenterY,subMenus:null,showDivider:!1,isCheckMapLocked:!0},alignBottom:{title:"Align Bottom(Alt+B)",image:"icon_nb_align_bottom_16",action:mapContextMenuAction.alignBottom,subMenus:null,showDivider:!1,isCheckMapLocked:!0},alignStyle:{title:"Alignment",image:"icon_nb_align_16",action:null,subMenus:[],showDivider:!1},mergeToOneNote:{title:"Merge to One Note",image:"nb_icon_merge_one_note_16",action:mapContextMenuAction.mergeToOneNote,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"mergeToOneNote"},addToDeviceGroup:{title:"Add to Device Group",image:"icon_nb_add_to_device_group_16",action:mapContextMenuAction.addToDeviceGroup,subMenus:null,showDivider:!1,isCheckMapLocked:!1},dataViewEditDataUnit:{title:"Edit Data Unit",image:"icon_nb_edit_dv_dataunit",action:mapContextMenuAction.dataViewEditDataUnit,subMenus:null,showDivider:!1,isCheckMapLocked:!1},changePathHop:{title:"Change Hop",image:null,action:mapContextMenuAction.changePathHop,subMenus:null,showDivider:!1,isCheckMapLocked:!1,atag:"changePathHop"},changeLinkLineThickness:{title:"Line Thickness",action:null,subMenus:getChangeLinkLineThicknessSubMenus(),showDivider:!1,isCheckMapLocked:!0,atag:"changeLinkLineThickness"},changeLinkLineDashType:{title:"Line Style",action:null,subMenus:getChangeLinkLineStyleSubMenus(),showDivider:!1,isCheckMapLocked:!0,atag:"changeLinkLineDashType"},changeLinkLineColor:{title:"Line Color",action:null,subMenus:null,showDivider:!1,isColorPicker:!0,onColorChanged:mapContextMenuAction.changeLinkLineColor,pickedColor:"#000000",colorPickerOptions:NetBrain.Map.Const.contextMenuColorPickerOptions,isCheckMapLocked:!0,atag:"changeLinkLineColor"},removeLinkLineCustomizedStyle:{title:"Remove customized style",action:mapContextMenuAction.removeLinkLineCustomizedStyle,subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"removeLinkLineCustomizedStyle"},copy:{title:"Copy",action:mapContextMenuAction.copy,image:"icon_nb_copy",subMenus:null,showDivider:!1,isCheckMapLocked:!0,atag:"copy"},cut:{title:"Cut",action:mapContextMenuAction.cut,image:"icon_nb_cut",subMenus:null,showDivider:!0,isCheckMapLocked:!0,atag:"cut"},paste:function(position){return{title:"Paste",action:function(){mapContextMenuAction.paste(position)},image:"icon_nb_paste",subMenus:null,showDivider:!0,isCheckMapLocked:!0,atag:"paste"}}},{runbookBuiltInList:_runbookBuiltInList})}}]);!function(NetBrain){angular.module("nb.qmap").factory("nb.qmap.mapContextMenuAction",["$rootScope","$uibModal","$timeout","$location","nb.netbrain.httpDeviceSrvc","nb.netbrain.httpDeviceSettingSrvc","nb.admin.httpPrivateDeviceSettingSrvc","nb.admin.httpChangeMgmtSettingSrvc","nb.admin.httpDomainAdminNewSrvc","nb.qmap.deviceTableSrvc","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.miniTask.miniTaskUtilSrvc","nb.qmap.updateMapSrvc","nb.datamodel.httpSiteSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.topo.httpExternNbrSrvc","nb.common.nbAlertSrvc","nb.netbrain.dataViewCacheSrvc","nb.qmap.mapManagerSrvc","nb.ng.userSrvc","nb.uiframework.urlStateMgr","nb.common.nbDragDropSrvc","nb.common.nbAddToDeviceGroupModalSrvc","nb.application.applicationFlowSrvc","nb.dataview.applyDataViewSrvc","nb.qmap.autoLinkOptionSrvc","nb.runbook.mapTargetDeviceSrvc","nb.runbook.pingTraceSrvc","nb.common.nbTipSrvc","nb.path.pathResultDataHandlerSrvc","nb.ng.deviceAccessCacheSrvc","nb.deviceDetail.deviceDataNonModelDialogSrvc",function($rootScope,$uibModal,$timeout,$location,httpDeviceSrvc,httpDeviceSettingSrvc,httpPrivateDeviceSettingSrvc,httpChangeMgmtSettingSrvc,httpDomainAdminNewSrvc,deviceTableSrvc,utilitySrvc,httpAuthSrvc,miniTaskUtilSrvc,updateMapSrvc,httpSiteSrvc,httpDeviceGroupSrvc,httpExternNbrSrvc,nbAlertSrvc,dataViewCacheSrvc,mapManagerSrvc,userSrvc,urlStateMgr,nbDragDropSrvc,nbAddToDeviceGroupModalSrvc,applicationFlowSrvc,applyDataViewSrvc,autoLinkOptionSrvc,mapTargetDeviceSrvc,pingTraceSrvc,nbTipSrvc,pathResultDataHandlerSrvc,deviceAccessCacheSrvc,deviceDataNonModelDialogSrvc){return{configurationFile:function(){var activtePage=mapManagerSrvc.getActivePage();var selectedDev=activtePage.getNetmapOperator().getSelectedDevcies()[0];selectedDev&&httpDeviceSrvc.getDomainListByDevIdList([selectedDev.getKey()]).then((function(arrResults){var currObj=arrResults[0];var deviceTenantDomain={TenantGuid:httpAuthSrvc.getDataSrc(utilitySrvc).TenantGuid,DomainGuid:[]};deviceTenantDomain.DomainGuid.push(currObj.domainId);var dialogId=utilitySrvc.getGUID();deviceDataNonModelDialogSrvc.showNonModalDialog({dialogId:dialogId,templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",resolve:{args:function(){var args={};args.currTenantDomain=deviceTenantDomain;args.isConfigFile=!0;args.deviceId=selectedDev.getKey();args.deviceType=selectedDev.getDevType();args.dataType=DeviceDataType.Config;var currScope=activtePage.getCurrentScope();var isOpenFromMap=!0;currScope&&_.isFunction(currScope.isEditMode)&&(isOpenFromMap=!currScope.isEditMode());args.isOpenFromMap=isOpenFromMap;return args}}})}))},sharedDeviceSettings:function(){var activtePage=mapManagerSrvc.getActivePage();var selectedDev=activtePage.getNetmapOperator().getSelectedDevcies()[0];selectedDev&&httpDeviceSettingSrvc.openSharedDeviceSettingsModal(selectedDev.getKey(),activtePage.getCurrentScope())},privateCLISettings:function(){var activtePage=mapManagerSrvc.getActivePage();var selectedDev=activtePage.getNetmapOperator().getSelectedDevcies()[0];selectedDev&&httpDomainAdminNewSrvc.getAccessCredentialSetting().then((function(cmSetting){cmSetting.accessCredentialOption===CMLiveAccessOptions.SharedOnly?nbAlertSrvc.warning({message:"Private CLI Settings have been disabled since administrator disabled Network Change function or changed access credentials from Private to Shared Credentials."}):httpPrivateDeviceSettingSrvc.openPrivateDeviceSettingsModal(userSrvc.getUserID(),selectedDev.getKey(),activtePage.getCurrentScope())}),(function(error){100017===error.ResultCode?nbAlertSrvc.warning("You don't have the privilege to manage private CLI settings. Contact your administrator for details."):nbAlertSrvc.warning(error.ResultDesc)}))},deviceDetailsPane:function(){var selectedDev=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedDevcies()[0];if(selectedDev){var deviceTenantDomain={TenantGuid:httpAuthSrvc.getDataSrc(utilitySrvc).TenantGuid,DomainGuid:[]};var detailEventData={deviceGuid:selectedDev.getKey(),deviceHostName:selectedDev.getHostname(),deviceType:selectedDev.getDevType(),deviceTenantDomain:deviceTenantDomain,argIsOpenFromMap:!0,bActiveTab:!1,isSubView:!1};var deviceDetailEventData=new DeviceDetailEventData(detailEventData);$rootScope.$emit(viewFrameEvent.toggleTopPanel,"deviceDetail",deviceDetailEventData)}},deviceContextMapsPane:function(){var activtePage=mapManagerSrvc.getActivePage();var selectedDev=activtePage.getNetmapOperator().getSelectedDevcies()[0];if(selectedDev&&selectedDev.devNodeData){var nodeName=selectedDev.hostName;var entityPanelInformation={objInfo:{},curNodeObj:{key:selectedDev.devNodeData.nodeIdentify.nbPathValue,name:selectedDev.hostName,nbPathSchema:selectedDev.devNodeData.nodeIdentify.nbPathSchema,nbPathValue:selectedDev.devNodeData.nodeIdentify.nbPathValue,isRealDev:selectedDev.devNodeData.isRealDev,role:selectedDev.devNodeData.role,expanded:!0,child:[],__Node_Name__:nodeName,netmap:activtePage},schemPropertyDisplayName:{},triggerSource:"mapNode"};$timeout((function(){$rootScope.$emit(viewFrameEvent.toggleTopPanel,"entitySDNPanel",entityPanelInformation);$rootScope.$emit(SDNEvent.DISPLAY_RIGHTPANEL,entityPanelInformation,!0)}))}},startTelnetSSHCLITool:function(){var os=(navigator.platform.match(/mac|win|linux/i)||["other"])[0].toLowerCase();var isWin="win"===os;var isMac="mac"===os;if(isWin||isMac){var selectedDev=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedDevcies()[0];selectedDev&&httpDeviceSettingSrvc.getDeviceSSHTelnetSetting(selectedDev.getKey()).then((function(data){if(null!=data){var ip=data.ip;var port=data.port;var user=data.userName;var pwd=data.password;var conType=data.conType;var url=conType+"://"+ip+":"+port;if("ssh"===conType)if(isWin){conType="netbrainSSH";url=""!==user?""!==pwd?conType+"://"+user+"@"+ip+":"+port+"$$"+pwd:conType+"://"+user+"@"+ip+":"+port:conType+"://"+ip+":"+port}else isMac&&(url=""!==user?conType+"://"+user+"@"+ip+":"+port:conType+"://"+ip+":"+port);var link=angular.element('<a href="'+url+'" rel="noreferrer" target="_self"></a>');angular.element(document.body).append(link);$timeout((function(){link[0].click();link.remove()}))}else nbAlertSrvc.warning({message:"The device settings of the device cannot be found."})}),(function(err){400100==err.ResultCode&&nbAlertSrvc.error({message:"The action cannot be performed because you are not privileged to view the network data of the selected device."})}))}else nbAlertSrvc.warning({message:"This function is not available in a Linux/Unix system."})},smartTelnetSSHCLITool:function(){if("win"===(navigator.platform.match(/mac|win|linux/i)||["other"])[0].toLowerCase()){var activteMap=mapManagerSrvc.getActiveMap(),activtePage=mapManagerSrvc.getActivePage(),currentDevice=activtePage.getNetmapOperator().getSelectedDevcies()[0];if(currentDevice){var authentication=utilitySrvc.getLocalStorage(NetBrain.NG.LocalStorageDefine.loginAuth.mainUi),currentRunbook=activteMap&&activteMap.currentRunbook;var uri=(params={cliSvrBase:$location.protocol()+"://"+$location.host()+":"+$location.port(),apiSvrBase:NetBrain.NG.ConfigSettings.API_ROOT,userName:userSrvc.getUserName(),userId:userSrvc.getUserID(),authId:authentication?authentication.id:"",tenantId:httpAuthSrvc.getSelectedTenantId(),tenantName:httpAuthSrvc.getSelectedTenant().name,domainId:httpAuthSrvc.getSelectedDomainIds()[0],domainName:httpAuthSrvc.getSelectedDomains()[0].name,mapName:activteMap&&activteMap.getTitle(),mapId:activteMap&&activteMap.getDocId(),mapPageId:activtePage&&activtePage.getDocId(),deviceId:currentDevice.id,deviceName:currentDevice.hostName,runbookId:currentRunbook?currentRunbook._id:"",runbookName:currentRunbook?currentRunbook.name:""},"NBLaunchSmartCli://"+btoa(unescape(encodeURIComponent(JSON.stringify(params)))));var params;utilitySrvc.getLocalStorage("disabledSmartDownloadDialog")||$uibModal.open({templateUrl:"modules/nbQmap/views/smartTool/downloadSmartToolDialog.html",controller:"nb.qmap.downloadSmartToolDialogCtrl",windowClass:"",backdrop:!1,resolve:{params:function(){return{}}}}).result;var iframe=document.querySelector("#smartHiddenIframe");iframe||(iframe=function(target,uri){var iframe=document.createElement("iframe");iframe.src=uri;iframe.id="smartHiddenIframe";iframe.style.display="none";target.appendChild(iframe);return iframe}(document.body,"about:blank"));iframe.contentWindow.location.href=uri}else nbAlertSrvc.warning({message:"Please select a device first."})}else nbAlertSrvc.warning({message:"NetBrain Smart CLI is available in a Windows system."})},createNote:function(){var netmapOperator=mapManagerSrvc.getActivePage().getNetmapOperator();var keys=netmapOperator.getSelectedNodes().map((function(e){return e.key}));deviceAccessCacheSrvc.getDAPArray(keys,1).then((function(res){var needAlert=!1;if(res&&res.length>0){var trueCount=_.countBy(res,(function(item){return item}));res.length===trueCount.true?netmapOperator.addDeviceNoteRefDevice(keys,{title:"Title",content:"Content",user:userSrvc.getUserName(),time:new Date,noteFromType:NetBrain.Map.Const.NoteFromType.Normal}):needAlert=!0}else needAlert=!0;needAlert&&nbAlertSrvc.alert(NetBrain.Map.Message.NoRightForCreateNoteAlert)}))},pinDevices:function(){var netmapOperator=mapManagerSrvc.getActivePage().getNetmapOperator();var keys=netmapOperator.getSelectedNodes().map((function(e){return e.key}));netmapOperator.addDeviceNoteRefDevice(keys,{title:"Title",content:"Content",user:userSrvc.getUserName(),time:new Date,noteFromType:NetBrain.Map.Const.NoteFromType.Normal})},iconSettingLarge:function(){var netmapOperator=mapManagerSrvc.getActivePage().getNetmapOperator();var keys=_.pluck(netmapOperator.getSelectedNodes(),"key");netmapOperator.updateDevicesIconRatio(keys,1.2)},iconSettingMedium:function(){var netmapOperator=mapManagerSrvc.getActivePage().getNetmapOperator();var keys=_.pluck(netmapOperator.getSelectedNodes(),"key");netmapOperator.updateDevicesIconRatio(keys,1)},iconSettingSmall:function(){var netmapOperator=mapManagerSrvc.getActivePage().getNetmapOperator();var keys=_.pluck(netmapOperator.getSelectedNodes(),"key");netmapOperator.updateDevicesIconRatio(keys,.8)},viewVirtualRouteTable:function(){var selectedDev=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedDevcies()[0];selectedDev&&$uibModal.open({templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",backdrop:"static",resolve:{args:function(){var args={};args.currTenantDomain=httpAuthSrvc.getDataSrc();args.isBaseline=!0;args.isDataTable=!0;args.isConfigFile=!1;args.deviceId=selectedDev.getKey();args.deviceHostname=selectedDev.getHostname();args.dataType="routeTable";args.isRouteTable=!0;args.currentDeviceName=selectedDev.getHostname();return args}}})},extendNeighbors:function(){var activtePage=mapManagerSrvc.getActivePage();var selectedDev=activtePage.getNetmapOperator().getSelectedNodes()[0];if(selectedDev){var tempObj={};if("Media"===selectedDev.category){tempObj.key=selectedDev.getKey();tempObj.topoType=selectedDev.topoType}var vsInfo=activtePage.getVisualSpaceInfo();var vsId=vsInfo?vsInfo.visualSpaceInstanceId:VisualSpaceConstant.defaultVisualSpaceInstanceId;httpExternNbrSrvc.getNbrFromMedia(tempObj.key,tempObj.topoType,vsId).then((function(result){var nbrList=[];result.nbrIntfs.length>0&&result.nbrIntfs.forEach((function(nbrIntf){nbrIntf.nbrs.forEach((function(nbrInfo){nbrInfo.id="";nbrInfo.devId="";nbrInfo.isP2P=!1;nbrInfo.name="";nbrInfo.intf=nbrIntf.intf;nbrList.push(nbrInfo)}))}));var extResult=activtePage.getNetmapOperator().extendNeighbors(nbrList,!1,!0);nbrList.length>=50&&_.isFunction(extResult.then)&&extResult.then((function(){var options={tipInfo:NetBrain.Map.Message.ExtendNbrMoreThen,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapSucessTip"};nbTipSrvc.open(options)}))}))}},openSiteMap:function(){var selectedDev=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedSites()[0];if(!selectedDev)return null;if(0===selectedDev.siteCategory)return null;var options={mapType:NetBrain.Map.Const.MapType.siteMap,id:selectedDev.getKey()};return urlStateMgr.openMap(options)},collapseAllChildSite:function(){var activtePage=mapManagerSrvc.getActivePage();var selectedDev=activtePage.getNetmapOperator().getSelectedSites()[0];if(selectedDev){var curNode=activtePage._diagram.findNodeForKey(selectedDev.getKey());if(curNode.isTreeExpanded){activtePage._diagram.startTransaction("collapseTree");curNode.collapseTree(0);activtePage._diagram.commitTransaction("collapseTree")}else{activtePage._diagram.startTransaction("expandTree");var dia=curNode.diagram;dia.isExpandAll=!0;dia.addBacknodes=[];dia.addLinks=[];curNode.expandTree(21);$timeout((function(){dia.isExpandAll=!1;dia.model.addNodeDataCollection(dia.addBacknodes);dia.model.addLinkDataCollection(dia.addLinks);dia.addBacknodes=[];dia.addLinks=[];activtePage._diagram.commitTransaction("expandTree")}))}}},displayTopologyViewAllLeafSites:function(){mapManagerSrvc.getActivePage().displayTopologyViewAllLeafSites()},locateInSitePane:function(){var selectedDev=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedSites()[0];if(selectedDev){$rootScope.$emit(viewFrameEvent.toggleTopPanel,"site",{alwaysShow:!0});$timeout((function(){selectedDev.parentPath&&selectedDev.parentPath.length>0?$rootScope.$emit("select_site_node",{siteId:selectedDev.getKey(),parentPath:selectedDev.parentPath}):httpSiteSrvc.getSitePropertiesBySiteID(selectedDev.getKey(),!1).then((function(data){selectedDev.parentPath=data.parentPath;$rootScope.$emit("select_site_node",{siteId:selectedDev.getKey(),parentPath:selectedDev.parentPath})}))}),500)}},mapDevicesInSite:function(){var selectedDev=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedSites()[0];if(selectedDev){var siteKey=selectedDev.getKey();httpSiteSrvc.getSiteDeviceBySiteID(siteKey,1,4).then((function(devices){var deviceList=devices.memberList;var deviceIds=[];angular.forEach(deviceList,(function(device){var devObj={id:device.deviceId};deviceIds.push(devObj)}));var drawData={actionData:deviceIds,actionType:NetBrain.Common.Const.ActionType.DrawDevice};drawData.forceCreateNewMap=!0;nbDragDropSrvc.drawDevice(drawData)}))}},openDeviceGroupMap:function(){var selectedDev=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedDeviceGroups()[0];if(!selectedDev)return!1;var options={mapType:NetBrain.Map.Const.MapType.deviceGroupMap,id:selectedDev.getKey()};return urlStateMgr.openMap(options)},mapDevicesInDeviceGroup:function(){var selectedDev=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedDeviceGroups()[0];if(selectedDev){var dgID=selectedDev.getKey();httpDeviceGroupSrvc.getDevicesOfDeviceGroupByCondition(null,dgID,1e3,0).then((function(listDevicesAndIntfs){var drawData={actionData:listDevicesAndIntfs,actionType:NetBrain.Common.Const.ActionType.DrawDeviceAndIntfs};drawData.forceCreateNewMap=!0;nbDragDropSrvc.drawDeviceAndIntfs(drawData)}))}},selectAllLinkByTopoType:function(topoTypeID,topoTypeName){if(!mapManagerSrvc.getActivePage().getCmdTarget().selectAllLinkByTopoType(topoTypeID)){showTipForLink(StringUtil.format(NetBrain.Map.Message.NoLinkForSelectMessage,{linkname:topoTypeName}))}},unlinkAllByTopoType:function(topoTypeID,topoTypeName){if(!mapManagerSrvc.getActivePage().getCmdTarget().unlinkAllByTopoType(topoTypeID)){showTipForLink(StringUtil.format(NetBrain.Map.Message.NoLinkForUnLinkMessage,{linkname:topoTypeName}))}},autoLink:function(topoTypeID,topoTypeName,onlyBetweenDevices){var activtePage=mapManagerSrvc.getActivePage();var topoTypeList=autoLinkOptionSrvc.getTopoTypesList();if(null!=topoTypeList&&0!=topoTypeList.length){var topoType=_.find(topoTypeList,(function(item){return item.id===topoTypeID}));if(topoType){var autolinkResultHasLinkFunc=function(autolinkResult){if(autolinkResult.hasLink)activtePage.getCmdTarget().selectAllLinkByTopoType(topoType.id);else{showTipForLink(StringUtil.format(NetBrain.Map.Message.NoLinkForAutoLinkMessage,{linkname:topoTypeName}))}};var autolinkResultNoHasLinkFunc=function(autolinkResult){if(!autolinkResult.hasLink){showTipForLink(StringUtil.format(NetBrain.Map.Message.NoLinkForAutoLinkMessage,{linkname:topoTypeName}))}};if(onlyBetweenDevices){var selectedDev=activtePage.getNetmapOperator().getSelectedNodes();if(!selectedDev)return;var onAutoLinkBetweenDevices=activtePage.getCmdTarget().onAutoLinkBetweenDevices(httpExternNbrSrvc,selectedDev,topoType.id,nbAlertSrvc);onAutoLinkBetweenDevices&&onAutoLinkBetweenDevices.then&&onAutoLinkBetweenDevices.then((function(autolinkResult){autolinkResultHasLinkFunc(autolinkResult)}),(function(autolinkResult){autolinkResultNoHasLinkFunc(autolinkResult)}))}else{var onAutoLink=activtePage.getCmdTarget().onAutoLink(httpExternNbrSrvc,topoType.id,nbAlertSrvc,dataViewCacheSrvc,applyDataViewSrvc);onAutoLink&&onAutoLink.then&&onAutoLink.then((function(autolinkResult){autolinkResultHasLinkFunc(autolinkResult)}),(function(autolinkResult){autolinkResultNoHasLinkFunc(autolinkResult)}))}}}},autoLinkForMedia:function(){var activtePage=mapManagerSrvc.getActivePage();var selectedDev=activtePage.getNetmapOperator().getSelectedNodes()[0];if(selectedDev){var topoTypeList=autoLinkOptionSrvc.getTopoTypesList();if(null!=topoTypeList&&0!=topoTypeList.length){var topoType=_.find(topoTypeList,(function(item){return item.id===selectedDev.topoType}));topoType&&activtePage.getCmdTarget().onAutoLinkForFloatMeau(httpExternNbrSrvc,selectedDev.getKey(),topoType.id,nbAlertSrvc,applyDataViewSrvc).then((function(autolinkResult){if(!autolinkResult.hasLink){showTipForLink(NetBrain.Map.Message.NoLinkForAutoLinkMessage)}}))}}},layoutStyles:function(){var MapLayoutEvent=NetBrain.MapLayout.Const.MapLayoutEvent;$rootScope.$emit(MapLayoutEvent.OpenMapLayoutMiniPane,"Map Layout")},saveAsSampleLayout:function(){$uibModal.open({templateUrl:"modules/nbQmap/views/maplayout/createSampleMapLayout.html",controller:"nb.qmap.createSampleMapCtrl",windowClass:"create-sample-map-ctrl",backdrop:"static",size:"sm",resolve:{createSampleMapHandle:function(){return{id:0}}}}).result.then((function(){}))},mapTracerouteResult:function(){var manuallyTempData={data:mapTargetDeviceSrvc.getNodeTemplateByType(5),devIntfMap:{},deviceMap:{},devInfos:[],pointDSFrom:[{id:1,name:"Front Server"},{id:2,name:"Device"}],enableDeviceIntf:!1,alogID:"",isTrace:!0,forMap:{range:null,ipArr:[]},devNs:{devId:null}};pingTraceSrvc.openManuallyDialog(manuallyTempData)},showAllPortChannels:function(actionObj){mapManagerSrvc.getActivePage().getCmdTarget().showAllPortChannels(actionObj)},showAllPhysicalPorts:function(actionObj){mapManagerSrvc.getActivePage().getCmdTarget().showAllPhysicalPorts(actionObj)},showPortChannel:function(actionObj){mapManagerSrvc.getActivePage().getCmdTarget().showPortChannel(actionObj)},showPhysicalPorts:function(actionObj){mapManagerSrvc.getActivePage().getCmdTarget().showPhysicalPorts(actionObj)},compactStyle:function(){mapManagerSrvc.getActivePage().getCmdTarget().displayL3MapStyle();$rootScope.$emit(netMapEvent.changeMapStyle,"L3")},expandedStyle:function(){mapManagerSrvc.getActivePage().getCmdTarget().displayL2MapStyle();$rootScope.$emit(netMapEvent.changeMapStyle,"L2")},symmetricLayout:function(){mapManagerSrvc.getActivePage().getCmdTarget().onForceDirected()},symmetricLayoutNew:function(){mapManagerSrvc.getActivePage().getCmdTarget().onForceDirectedNew()},circularLayout:function(){mapManagerSrvc.getActivePage().getCmdTarget().onCircularLayout()},hierarchicalLayout:function(){mapManagerSrvc.getActivePage().getCmdTarget().onLayeredDigraphLayout()},orthogonalLayout:function(){mapManagerSrvc.getActivePage().getCmdTarget().onGridLayout()},treeLayoutUp:function(){treeLayoutNew("up")},treeLayoutDown:function(){treeLayoutNew("down")},treeLayout:function(){mapManagerSrvc.getActivePage().getCmdTarget().onTreeLayout()},clearAllDataview:function(){$rootScope.$emit("clearAllDataViews");mapManagerSrvc.getActivePage().getCurrentScope().netmap.runingDataViewGroupId=""},saveAsDataview:function(){$rootScope.$emit("saveAsDataView")},alignLeft:function(){mapManagerSrvc.getActivePage().getCmdTarget().onAlignLeft()},alignRight:function(){mapManagerSrvc.getActivePage().getCmdTarget().onAlignRight()},alignTop:function(){mapManagerSrvc.getActivePage().getCmdTarget().onAlignTop()},alignBottom:function(){mapManagerSrvc.getActivePage().getCmdTarget().onAlignBottom()},alignCenterY:function(){mapManagerSrvc.getActivePage().getCmdTarget().onAlignCenterY()},alignCenterX:function(){mapManagerSrvc.getActivePage().getCmdTarget().onAlignCenterX()},mergeToOneNote:function(){var activtePage=mapManagerSrvc.getActivePage();var selectedNodes=activtePage.getNetmapOperator().getSelectedNodes();var isDeviceNoteOrNote=NetBrain.Map.CategoryMgr.isDeviceNoteOrNote;var selectedNotes=_.filter(selectedNodes,(function(item){return isDeviceNoteOrNote(item.category)}));var dataViewNoteType=NetBrain.Map.Const.NoteFromType.DataView;var selectedNormalNotes=_.filter(selectedNotes,(function(data){return data.noteFromType!==dataViewNoteType}));if(selectedNotes.length!==selectedNormalNotes.length){var options={tipInfo:NetBrain.Map.Message.MergeOneNoteWarning,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapFailTip"};nbTipSrvc.open(options)}selectedNormalNotes.length>1&&activtePage.getCmdTarget().mergeToOneNote(selectedNormalNotes)},addToDeviceGroup:function(){var selectedNodes=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedNodes();if(selectedNodes){var deviceIds=[];angular.forEach(selectedNodes,(function(node){deviceIds.push(node.getKey())}));nbAddToDeviceGroupModalSrvc.showModal(deviceIds)}},dataViewEditDataUnit:function(){var activtePage=mapManagerSrvc.getActivePage();var deviceKey=activtePage.getNetmapOperator().getSelectedNodes()[0].key;$rootScope.$emit("open-edit-data-view-from-context",{pageId:activtePage.getDocId(),diagram:activtePage._diagram,target:activtePage._getGraphDeviceByKey(deviceKey)})},changePathHop:function(){var netmapOperator=mapManagerSrvc.getActivePage().getNetmapOperator();var link=netmapOperator.getSelectedLinks()[0];if(link.lastContextClickedInfo){var selectedHop=_.find(link.lastContextClickedInfo.selectHops.hops,(function(hop){return hop.hopId===link.lastContextClickedInfo.selectHopId}));pathResultDataHandlerSrvc.getPathMapViewDataBySwitchLB(link.data,selectedHop).then((function(pathMapViewData){nbDragDropSrvc.updatePath(netmapOperator,pathMapViewData);$rootScope.$emit("change-lb-from-map",pathMapViewData)}))}},changeLinkLineThickness:function(weight){mapManagerSrvc.getActivePage().getNetmapOperator().changeSelectedLinksLineStrokeWidth(weight)},changeLinkLineDashType:function(type){mapManagerSrvc.getActivePage().getNetmapOperator().changeSelectedLinksLineStrokeDashArray(type)},changeLinkLineColor:function(color){mapManagerSrvc.getActivePage().getNetmapOperator().changeSelectedLinksLineStroke(color)},removeLinkLineCustomizedStyle:function(color){mapManagerSrvc.getActivePage().getNetmapOperator().removeLinkLineCustomizedStyle()},viewChangeAnalysisReport:function(){mapManagerSrvc.jumpToCAWithMapDevices()},copy:function(){mapManagerSrvc.getActivePage().getGoJsDiagram().commandHandler.copySelection()},cut:function(){mapManagerSrvc.getActivePage().getGoJsDiagram().commandHandler.cutSelection()},paste:function(position){mapManagerSrvc.getActivePage().getGoJsDiagram().commandHandler.pasteSelection(position)}};function showTipForLink(text){var options={tipInfo:text,autoClose:!0,hasCloseBtn:!1,customClass:"updateMapFailTip"};nbTipSrvc.open(options)}function treeLayoutNew(direction){mapManagerSrvc.getActivePage().getCmdTarget().onTreeLayoutNew(direction)}}])}(NetBrain);!function(NetBrain){angular.module("nb.qmap").service("nb.qmap.mapContextMenuManager",["nb.qmap.mapContextMenuConfig","nb.qmap.deviceTableSrvc","nb.qmap.mapManagerSrvc","nb.qmap.mapContextMenuAction","nb.netbrain.httpDeviceSrvc","nb.ng.featureSrvc","nb.ng.utilitySrvc","nb.admin.httpGenericDevicesSrvc",function(mapContextMenuConfigFunc,deviceTableSrvc,mapManagerSrvc,mapContextMenuAction,httpDeviceSrvc,featureSrvc,utilitySrvc,httpGenericDevicesSrvc){var mapContextMenuConfig=mapContextMenuConfigFunc();function _getFixUpRouteTable(selectedDev){return{title:"Fix-up Route Table",action:function(){httpGenericDevicesSrvc.fixUpRouteTableDialogofNonModal({id:selectedDev.id,name:selectedDev.hostName||""})},showDivider:!0}}this.getLayoutMenu=function(pageTopogyType){var data=[];if(pageTopogyType===NetBrain.Map.Const.NetmapTopoLogy.overViewHierarchicalSite){(data=[]).push(mapContextMenuConfig.circularLayout);data.push(mapContextMenuConfig.treeLayoutUp);data.push(mapContextMenuConfig.treeLayoutDown);return data}(data=[]).push(mapContextMenuConfig.symmetricLayout);data.push(mapContextMenuConfig.circularLayout);data.push(mapContextMenuConfig.hierarchicalLayout);data.push(mapContextMenuConfig.orthogonalLayout);data.push(mapContextMenuConfig.treeLayoutUp);data.push(mapContextMenuConfig.treeLayoutDown);return data};this.getMenuData=function(options){var isBackgroundContextClicked=options.isBackgroundContextClicked;var allSelectedNodes=options.allSelectedNodes;var allSelectedLinks=options.selectedLinks;var activePage=options.activePage;mapContextMenuConfig=mapContextMenuConfigFunc();var data=[];function FiterMenusRet(autolinkMenu){var autoLink=[];var bFiterMenusRet=!1;var info=mapManagerSrvc.getActivePage().getVisualSpaceInfo();var vsId=info&&info.visualSpaceInstanceId&&info.visualSpaceInstanceId.length>0?info.visualSpaceInstanceId:VisualSpaceConstant.defaultVisualSpaceInstanceId;angular.copy(autolinkMenu,autoLink);var visualSpaceTopoTypeList=NetBrain.CurAutolinkType[vsId];if(null!=visualSpaceTopoTypeList&&!_.isEmpty(visualSpaceTopoTypeList)){for(var index=0;index<autoLink.subMenus.length;index++){if(visualSpaceTopoTypeList.indexOf(autoLink.subMenus[index].id)<0){autoLink.subMenus.splice(index,1);index--}}if(autoLink.subMenus.length>0){bFiterMenusRet=!0;data.push(autoLink)}}return bFiterMenusRet}function getPortChanelContextMenu(options,data){var portChannelHelper=NetBrain.MapImprovements.PortChannelHelper;var part=portChannelHelper.getCurrentPart(options);var selectedLinks=options.selectedLinks;if(portChannelHelper.partIsOnlySelectedLink(part,selectedLinks)){var action=null;portChannelHelper.isPortChannel(part)?action=mapContextMenuConfig.showPhysicalPorts:portChannelHelper.isPhysicalOfPortChannel(part)&&(action=mapContextMenuConfig.showPortChannel);if(action){var actionCopy=_.extend({},action,{event:options.event,selectedLinks:options.selectedLinks,currentLink:part});data.push(actionCopy);return data}}}function addIconSettingsMenuForOneNode(_oneObj){if(_oneObj&&(_oneObj.category===NetBrain.Map.CategoryMgr.NetworkDevice||_oneObj.category===NetBrain.Map.CategoryMgr.Stencil||_oneObj.category===NetBrain.Map.CategoryMgr.StencilExt||_oneObj.category===NetBrain.Map.CategoryMgr.Media||_oneObj.category===NetBrain.Map.CategoryMgr.UnknownIp||_oneObj.category===NetBrain.Map.CategoryMgr.VirtualNode)){mapContextMenuConfig.IconSettings.subMenus[0].image="";mapContextMenuConfig.IconSettings.subMenus[1].image="";mapContextMenuConfig.IconSettings.subMenus[2].image="";var iconRatio=activePage.getNetmapOperator().getDeviceIconRatio(_oneObj.key);mapContextMenuConfig.IconSettings.subMenus[{1.2:0,1:1,.8:2}[iconRatio]].image="checked-icon";data.push(mapContextMenuConfig.IconSettings)}}function addIconSettingsMenuForMoreNode(allSelectedNodes){var atLeaseOneNodeSupportRatio=!0;if(allSelectedNodes){atLeaseOneNodeSupportRatio=!1;_.each(allSelectedNodes,(function(item){if(item&&(item.category===NetBrain.Map.CategoryMgr.NetworkDevice||item.category===NetBrain.Map.CategoryMgr.Stencil||item.category===NetBrain.Map.CategoryMgr.StencilExt||item.category===NetBrain.Map.CategoryMgr.Media||item.category===NetBrain.Map.CategoryMgr.UnknownIp||item.category===NetBrain.Map.CategoryMgr.VirtualNode)){atLeaseOneNodeSupportRatio=!0;return!1}}))}if(atLeaseOneNodeSupportRatio){mapContextMenuConfig.IconSettings.subMenus[0].image="";mapContextMenuConfig.IconSettings.subMenus[1].image="";mapContextMenuConfig.IconSettings.subMenus[2].image="";data.push(mapContextMenuConfig.IconSettings)}}var currScope=activePage.getCurrentScope();if(currScope&&_.isFunction(currScope.isEditMode)&&currScope.isEditMode())return data=function(allSelectedNodes){var data;if(allSelectedNodes&&1===allSelectedNodes.length){var oneObj=allSelectedNodes[0];if(NetBrain.Map.CategoryMgr.isNetworkDevice(oneObj.category)&&[1024,1037].indexOf(oneObj.devCategory)<0){data=[];if(activePage.isInPanelNamed(options.event.subject,NetBrain.Map.CompDevice.devPosInfoLabelPanel))return;var isExistDevObj=!0;oneObj&&oneObj.devNodeData&&oneObj.devNodeData.isRealDev?httpDeviceSrvc.isExistsSimpleByHostName(null,oneObj.hostName,(function(result){0===result.code&&(isExistDevObj=result.data.data)})):isExistDevObj=!1;isExistDevObj&&data.push(mapContextMenuConfig.configurationFile);data.push(mapContextMenuConfig.dataViewEditDataUnit)}}return data}(allSelectedNodes);if(isBackgroundContextClicked){if(activePage.getParentQmap().getMapType()===NetBrain.Map.Const.MapType.overViewMap){(data=[]).push(mapContextMenuConfig.layoutStyles);activePage.getTopologyType()===NetBrain.Map.Const.NetmapTopoLogy.overViewTopologySite&&data.push(mapContextMenuConfig.displayTopologyViewAllLeafSites);return data}(data=[]).push(mapContextMenuConfig.layoutStyles);data.push(mapContextMenuConfig.saveAsSampleLayout);mapContextMenuConfig.saveAsSampleLayout.showDivider=!0;mapContextMenuConfig.autoLink.showDivider=!0;FiterMenusRet(mapContextMenuConfig.autoLink)||data.push(mapContextMenuConfig.autoLink);data.push(mapContextMenuConfig.portChannel);if(activePage.isL2MapStyle()){mapContextMenuConfig.changeDeviceStyle.subMenus[0].image="";mapContextMenuConfig.changeDeviceStyle.subMenus[1].image="checked-icon"}else{mapContextMenuConfig.changeDeviceStyle.subMenus[0].image="checked-icon";mapContextMenuConfig.changeDeviceStyle.subMenus[1].image=""}mapContextMenuConfig.changeDeviceStyle.showDivider=!0;data.push(mapContextMenuConfig.changeDeviceStyle);data.push(mapContextMenuConfig.viewChangeAnalysisReport);if(mapContextMenuConfig.runbookBuiltInList&&mapContextMenuConfig.runbookBuiltInList.length){_.each(mapContextMenuConfig.runbookBuiltInList,(function(item){data.push(item)}));_.last(mapContextMenuConfig.runbookBuiltInList).showDivider=!0}data.push(mapContextMenuConfig.dataview);data.push(mapContextMenuConfig.mapTracerouteResult);data[data.length-1].showDivider=!0;data.push(mapContextMenuConfig.paste(options.position));return data}if(NetBrain.Map.CategoryMgr.isCustomizableLink(NgUtil.getValueFromObjAndPath(options,"event.subject.part.category"))&&allSelectedLinks.length>0){data.push(mapContextMenuConfig.changeLinkLineThickness);data.push(mapContextMenuConfig.changeLinkLineDashType);data.push(mapContextMenuConfig.changeLinkLineColor);data.push(mapContextMenuConfig.removeLinkLineCustomizedStyle);if(1===allSelectedLinks.length){getPortChanelContextMenu(options,data);var link=allSelectedLinks[0];NetBrain.Map.CategoryMgr.isPath(link.category)}return data}if(1===allSelectedNodes.length&&allSelectedNodes[0]){var oneObj=allSelectedNodes[0];if(NetBrain.Map.CategoryMgr.isNetworkDevice(oneObj.category)&&[1024,1037].indexOf(oneObj.devCategory)<0){if(activePage.isInPanelNamed(options.event.subject,NetBrain.Map.CompDevice.devPosInfoLabelPanel))return;var isExistDev=!0;oneObj&&oneObj.devNodeData&&oneObj.devNodeData.isRealDev?httpDeviceSrvc.isExistsSimpleByHostName(null,oneObj.hostName,(function(result){0===result.code&&(isExistDev=result.data.data)})):isExistDev=!1;if(isExistDev){(data=[]).push(mapContextMenuConfig.configurationFile);mapContextMenuConfig.configurationFile.showDivider=!0;mapContextMenuConfig.dataTables.subMenus=function(){var selectedDev=mapManagerSrvc.getActivePage().getNetmapOperator().getSelectedDevcies()[0];if(selectedDev){var table=deviceTableSrvc.getTableSourceExt(selectedDev);var fixUpRouteTable=_getFixUpRouteTable(selectedDev);table.subMenus.splice(0,0,fixUpRouteTable);return table.subMenus}}();if(0!==mapContextMenuConfig.dataTables.subMenus.length){data.push(mapContextMenuConfig.dataTables);mapContextMenuConfig.dataTables.showDivider=!0;mapContextMenuConfig.configurationFile.showDivider=!1}data.push(mapContextMenuConfig.deviceDetailsPane);data.push(mapContextMenuConfig.deviceContextMapsPane);data.push(mapContextMenuConfig.sharedDeviceSettings);if(featureSrvc.isFeatureValid(NetBrain.NG.Const.nbFeatures.TunePrivate.name)){data.push(mapContextMenuConfig.privateCLISettings);mapContextMenuConfig.startTelnetSSHCLITool.enabled&&data.push(mapContextMenuConfig.startTelnetSSHCLITool);data.push(mapContextMenuConfig.smartTelnetSSHCLITool);mapContextMenuConfig.smartTelnetSSHCLITool.showDivider=!0}else mapContextMenuConfig.sharedDeviceSettings.showDivider=!0;data.push(mapContextMenuConfig.addToDeviceGroup);mapContextMenuConfig.addToDeviceGroup.showDivider=!0;if(mapContextMenuConfig.runbookBuiltInList&&mapContextMenuConfig.runbookBuiltInList.length){_.each(mapContextMenuConfig.runbookBuiltInList,(function(item){"Data View Template"!==item.name&&data.push(item)}));_.last(mapContextMenuConfig.runbookBuiltInList).showDivider=!0}addIconSettingsMenuForOneNode(oneObj);data.push(mapContextMenuConfig.createNote);return data}data=[];addIconSettingsMenuForOneNode(oneObj);data.push(mapContextMenuConfig.createNote);if(oneObj&&oneObj.devNodeData&&oneObj.devNodeData.nodeIdentify){var tmpNbPathSchema=oneObj.devNodeData.nodeIdentify.nbPathSchema;var tmpNbPathValue=oneObj.devNodeData.nodeIdentify.nbPathValue;httpDeviceSrvc.isExistsContextMap(tmpNbPathSchema,tmpNbPathValue,(function(result){result&&result.data&&result.data.data&&data.push(mapContextMenuConfig.deviceContextMapsPane)}))}return data}if(oneObj.category===NetBrain.Map.CategoryMgr.NetworkDevice&&1024===oneObj.devCategory){(data=[]).push(mapContextMenuConfig.addToDeviceGroup);mapContextMenuConfig.addToDeviceGroup.showDivider=!0;data.push(mapContextMenuConfig.deviceDetailsPane);var fixUpRouteTable=_getFixUpRouteTable(oneObj);fixUpRouteTable.showDivider=!1;fixUpRouteTable.image="icon_nb_fix_up_route_table_16";data.push(fixUpRouteTable);data.push(mapContextMenuConfig.viewVirtualRouteTable);addIconSettingsMenuForOneNode(oneObj);data.push(mapContextMenuConfig.createNote);return data}if(oneObj.category===NetBrain.Map.CategoryMgr.NetworkDevice&&1037===oneObj.devCategory){(data=[]).push(mapContextMenuConfig.deviceDetailsPane);addIconSettingsMenuForOneNode(oneObj);data.push(mapContextMenuConfig.createNote);return data}if(oneObj.category===NetBrain.Map.CategoryMgr.Media){if("MuteLan"===oneObj.devType){data=[];addIconSettingsMenuForOneNode(oneObj);data.push(mapContextMenuConfig.createNote);return data}(data=[]).push(mapContextMenuConfig.extendNeighbors);data.push(mapContextMenuConfig.autoLinkForMedia);addIconSettingsMenuForOneNode(oneObj);data.push(mapContextMenuConfig.createNote);return data}if(oneObj.category===NetBrain.Map.CategoryMgr.MuteLan||oneObj.category===NetBrain.Map.CategoryMgr.Stencil||oneObj.category===NetBrain.Map.CategoryMgr.StencilExt){(data=[]).push(mapContextMenuConfig.copy);data.push(mapContextMenuConfig.cut);addIconSettingsMenuForOneNode(oneObj);data.push(mapContextMenuConfig.createNote);return data}if(oneObj.category===NetBrain.Map.CategoryMgr.Site){if(activePage.getParentQmap().getMapType()!==NetBrain.Map.Const.MapType.overViewMap){(data=[]).push(mapContextMenuConfig.openSiteMap);data.push(mapContextMenuConfig.locateInSitePane);mapContextMenuConfig.mapDevicesInSite.showDivider=!0;data.push(mapContextMenuConfig.mapDevicesInSite);addIconSettingsMenuForOneNode(oneObj);data.push(mapContextMenuConfig.createNote);return data}if(1===oneObj.siteCategory||0===oneObj.siteCategory){data=[];1===oneObj.siteCategory&&data.push(mapContextMenuConfig.openSiteMap);if(mapManagerSrvc.getActivePage()._diagram.findNodeForKey(oneObj.getKey()).isTreeExpanded){mapContextMenuConfig.collapseAllChildSite.title="Collapse All Child Site";mapContextMenuConfig.collapseAllChildSite.image="icon_nb_Collapse_All_Child_Site"}else{mapContextMenuConfig.collapseAllChildSite.title="Expand All Child Site";mapContextMenuConfig.collapseAllChildSite.image="icon_nb_Expand_All_Child_Site"}data.push(mapContextMenuConfig.collapseAllChildSite);data.push(mapContextMenuConfig.locateInSitePane);data.push(mapContextMenuConfig.mapDevicesInSite);return data}if(2===oneObj.siteCategory){(data=[]).push(mapContextMenuConfig.openSiteMap);data.push(mapContextMenuConfig.locateInSitePane);data.push(mapContextMenuConfig.mapDevicesInSite);return data}}else if(oneObj.category===NetBrain.Map.CategoryMgr.Cluter){(data=[]).push(mapContextMenuConfig.openDeviceGroupMap);oneObj.hasInterface?mapContextMenuConfig.mapDevicesInDeviceGroup.title="Map Devices and Interfaces in Group":mapContextMenuConfig.mapDevicesInDeviceGroup.title="Map Devices in Device Group";mapContextMenuConfig.mapDevicesInDeviceGroup.showDivider=!0;data.push(mapContextMenuConfig.mapDevicesInDeviceGroup);addIconSettingsMenuForOneNode(oneObj);data.push(mapContextMenuConfig.createNote);return data}}else if(allSelectedNodes.length>1){var allIsDevice=!0;_.each(allSelectedNodes,(function(item){if(item.category!==NetBrain.Map.CategoryMgr.NetworkDevice&&item.category!==NetBrain.Map.CategoryMgr.VirtualNode||item.category===NetBrain.Map.CategoryMgr.NetworkDevice&&1024===item.devCategory){allIsDevice=!1;return!1}}));if(allIsDevice){data=[];mapContextMenuConfig.autoLinkByNodes.showDivider=!0;FiterMenusRet(mapContextMenuConfig.autoLinkByNodes)||data.push(mapContextMenuConfig.autoLinkByNodes);data.push(mapContextMenuConfig.addToDeviceGroup);mapContextMenuConfig.addToDeviceGroup.showDivider=!0;if(mapContextMenuConfig.runbookBuiltInList&&mapContextMenuConfig.runbookBuiltInList.length){_.each(mapContextMenuConfig.runbookBuiltInList,(function(item){"Data View Template"!==item.name&&data.push(item)}));_.last(mapContextMenuConfig.runbookBuiltInList).showDivider=!0}addIconSettingsMenuForMoreNode();mapContextMenuConfig.createNote.showDivider=!0;data.push(mapContextMenuConfig.createNote);mapContextMenuConfig.alignStyle.subMenus=[];mapContextMenuConfig.alignStyle.subMenus.push(mapContextMenuConfig.alignLeft);mapContextMenuConfig.alignStyle.subMenus.push(mapContextMenuConfig.alignCenterX);mapContextMenuConfig.alignStyle.subMenus.push(mapContextMenuConfig.alignRight);mapContextMenuConfig.alignStyle.subMenus.push(mapContextMenuConfig.alignTop);mapContextMenuConfig.alignStyle.subMenus.push(mapContextMenuConfig.alignCenterY);mapContextMenuConfig.alignStyle.subMenus.push(mapContextMenuConfig.alignBottom);data.push(mapContextMenuConfig.alignStyle);return data}data=[];addIconSettingsMenuForMoreNode(allSelectedNodes);data.push(mapContextMenuConfig.alignLeft);data.push(mapContextMenuConfig.alignCenterX);data.push(mapContextMenuConfig.alignRight);data.push(mapContextMenuConfig.alignTop);data.push(mapContextMenuConfig.alignCenterY);data.push(mapContextMenuConfig.alignBottom);var CategoryMgr=NetBrain.Map.CategoryMgr;_.every(allSelectedNodes,(function(item){return CategoryMgr.isDeviceNoteOrNote(item.category)}))&&allSelectedNodes.length>1&&data.push(mapContextMenuConfig.mergeToOneNote);return data}getPortChanelContextMenu(options,data);return data&&data.length>0?data:void 0}}])}(NetBrain);!function(NetBrain){angular.module("nb.qmap").service("nb.qmap.mapContextMenuSrvc",["$document","$compile","$rootScope","$timeout","nb.qmap.mapContextMenuManager","nb.qmap.mapManagerSrvc","nb.qmap.updateMapSrvc",function($document,$compile,$rootScope,$timeout,mapContextMenuManager,mapManagerSrvc,updateMapSrvc){var me=this;var containerTemplate='<div id="{{menuID}}" class="map-context-menu" ng-show="isShow" nb-click-outside-directive click-outside="clickOutSide()"></div>';var menuContainerTemplate='<ul class="context-menu-container" ng-if="menu.subMenus.length > 0"></ul>';var menuTemplate='<li class="context-menu-item" ng-repeat="menu in menu.subMenus"><a ng-if="menu.isColorPicker !== true" ng-click="execAction(menu)" atag="map:menu:{{menu.atag}}"  ng-class="{\'right-arrow\':menu.subMenus.length}" ng-mouseenter="toggleSubmenu($event,menu)"><i class="menuImage {{menu.image}}" ng-class="{\'none-image\':!menu.image}"></i><span class="menu-title" ng-bind-html="menu.title"></span><span class="icon-sm icon_nb_arrow_right" ng-if="menu.subMenus.length > 0"></span></a><a ng-if="menu.isColorPicker === true" spectrum-colorpicker ng-model="menu.pickedColor" options="menu.colorPickerOptions" ng-change="menu.onColorChanged(menu.pickedColor)" atag="map:menu:{{menu.atag}}"  ng-class="{\'right-arrow\':menu.subMenus.length}" ng-mouseenter="toggleSubmenu($event,menu)"><i class="menuImage {{menu.image}}" ng-class="{\'none-image\':!menu.image}"></i><span class="menu-title" ng-bind-html="menu.title"></span><span class="icon-sm icon_nb_arrow_right" ng-if="menu.subMenus.length > 0"></span></a><hr ng-if="menu.showDivider" ng-class="{\'divider\': menu.showDivider}" /></li>';var layoutTemplate='<ul id="layout" class="context-menu-container submenu"><li class="context-menu-item" ng-repeat="layoutItem in layoutList" ng-click="execAction(layoutItem)" atag="map:menu:{{layoutItem.atag}}" class="imgHover"><i class="menuImage {{layoutItem.bigImage}}"></i><div> {{layoutItem.title}}</div></li></ul>';var menuDeep=0;var menuID="mapContextMenu-"+(new Date).getTime();var scope;function initScope(data){var scope=$rootScope.$new();scope.layoutList={};data&&"Layout"===data[0].title&&(scope.layoutList=data[0].subMenus);scope.menuID=menuID;scope.toggleSubmenu=function(event){var submenu,li;if(event.target.children[1]&&event.target.children[1].innerText&&"Layout"===event.target.children[1].innerText.trim()){scope.showLayout=!0;var element=$compile(layoutTemplate)(scope);submenu=(li=angular.element(event.target).parent()).children(".submenu").remove();element.find("#layout")&&0===element.find("#layout").length&&li.children().append(element);$("#layout").show();li.siblings().find(".selected").removeClass("selected");li.find(".selected").removeClass("selected");submenu.addClass("selected")}else{$("#layout").hide();scope.showLayout=!1;if(li=angular.element(event.target).closest(".context-menu-item")){submenu=li.children(".submenu");li.siblings().find(".selected").removeClass("selected");li.find(".selected").removeClass("selected");submenu.addClass("selected")}}submenu.length>0&&function(event,menuElement){if(0===menuElement.length)return;var doc=$document[0].documentElement;var selectSubMenuEle=menuElement.find(".submenu.selected");var docLeft=(window.pageXOffset||doc.scrollLeft)-(doc.clientLeft||0),docTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0),elementWidth=menuElement[0].scrollWidth,elementHeight=selectSubMenuEle.height();var menuLeft=function(obj){var l=0;var t=0;for(;obj;){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}return{left:l,top:t}}(menuElement[0]).left;var docWidth=doc.clientWidth+docLeft;var docHeight=doc.clientHeight+docTop;var totalWidth=elementWidth+menuLeft;var totalHeight=elementHeight+event.pageY;"Auto Link"===event.target.innerText&&(totalWidth+=127);if(totalWidth>docWidth){menuElement.find(".submenu").css("right","100%");menuElement.find(".submenu").css("left","inherit")}"Layout"===event.target.innerText.slice(0,6)?totalHeight+300>docHeight&&menuElement.find(".submenu").css("top","-180px"):totalHeight+5>docHeight?selectSubMenuEle.css("top","-"+(selectSubMenuEle.height()-30)+"px"):selectSubMenuEle.css("top","-5px")}(event,$document.find("#"+scope.menuID))};scope.execAction=function(menu){if(null!=menu.action){menu.isCheckMapLocked?updateMapSrvc.canUpdateCurrentMap().then((function(){menu.action(menu)})):menu.action(menu);scope.isShow=!1}};return scope}var clickEvent=null;$document.bind("contextmenu",(function(event){clickEvent=event}));me.open=function(options){var length=0;$rootScope.$emit(NetBrain.Map.Event.CloseAllTip);var data=mapContextMenuManager.getMenuData(options);(scope=initScope(data)).clickOutSide=function(){me.close()};options.allSelectedNodes&&options.allSelectedNodes.length>0&&(scope.lastClickNodeKey=options.allSelectedNodes[options.allSelectedNodes.length-1].key);scope.menu={};scope.menu.subMenus=data;var topContainer=$document.find("#"+scope.menuID);topContainer.length>0&&topContainer.remove();menuDeep=0;!function calculateMenuDeep(menuList){menuDeep++;var temp=[];_.each(menuList,(function(item){item.subMenus&&item.subMenus.length>0&&Array.prototype.push.apply(temp,item.subMenus)}));temp.length>0&&calculateMenuDeep(temp)}(data);var template=function(menuDeep1){var topContainer=angular.element(containerTemplate);var menu;for(var i=0;i<menuDeep1;i++){var container=angular.element(menuContainerTemplate);var item=angular.element(menuTemplate);container.append(item);if(menu){container.addClass("submenu");menu.append(container)}else topContainer.append(container);menu=item}return topContainer}(menuDeep);var element=$compile(template)(scope);element.css("display","none");element.css("top","-500px");element.css("left","-500px");$document.find("body").append(element);data&&data.length&&(length=data.length);$timeout((function(){!function(event,menuElement,dataLength){if(0!==menuElement.length){var doc=$document[0].documentElement;var docLeft=(window.pageXOffset||doc.scrollLeft)-(doc.clientLeft||0),docTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0),elementWidth=menuElement[0].scrollWidth,elementHeight=menuElement[0].scrollHeight;var docWidth=doc.clientWidth+docLeft,docHeight=doc.clientHeight+docTop,totalWidth=elementWidth+event.pageX,totalHeight=elementHeight+event.pageY,left=Math.max(event.pageX-docLeft,0),top=Math.max(event.pageY-docTop,0);totalWidth+220>docWidth&&(left=totalWidth+(docWidth-totalWidth-220));totalHeight>docHeight&&(top-=totalHeight-docHeight);var height=26*dataLength+7*dataLength;top+height>doc.clientHeight&&(top=doc.clientHeight-height);menuElement.css("top",top+"px");menuElement.css("left",left+"px")}}(clickEvent,$document.find("#"+scope.menuID),length);scope.isShow=!0;element.css("display","")}),100)};me.close=function(){if(scope){scope.isShow=!1;scope.$destroy();$document.find("#"+scope.menuID).remove()}};me.isShowStatus=function(){return $(".map-context-menu").length>0&&"none"!==$(".map-context-menu")[0].style.display};me.getLastClickNodeKey=function(){return scope.lastClickNodeKey};me.element=function(){return $document.find("#"+scope.menuID)}}])}(NetBrain);!function(NetBrain){angular.module("nb.qmap").directive("nbMapTopBar",nbMapTopBar);nbMapTopBar.$inject=["$q","$document","$rootScope","$templateRequest","$templateCache","$uibModal","nb.common.nbAlertSrvc","nb.ng.userSrvc","nb.ng.utilitySrvc","dialogService","nb.qmap.httpMapSrvc","nb.qmap.updateMapSrvc","nb.qmap.autoLinkOptionSrvc","nb.qmap.mapManagerSrvc","nb.uiframework.urlStateMgr","nb.uiframework.mainUISrvc","nb.collaboration.collaborationGridSrvc","nb.admin.domainAdminMgr","nb.taskmanager.backendQappPopupSrvc","nb.common.nbTipSrvc"];function nbMapTopBar($q,$document,$rootScope,$templateRequest,$templateCache,$uibModal,nbAlertSrvc,userSrvc,utilitySrvc,dialogService,httpMapSrvc,updateMapSrvc,autoLinkOptionSrvc,mapManagerSrvc,urlStateMgr,mainUISrvc,collaborationGridSrvc,domainAdminMgr,backendQappPopupSrvc,nbTipSrvc){var directive={scope:{},restrict:"EA",replace:!0,transclude:!0,templateUrl:"modules/nbQmap/views/nbMapTopBarDirective.html",link:function(element,arrts,scope){},controller:controller};controller.$inject=["$scope","$rootScope","$element","$timeout","$document"];function controller($scope,$rootScope,$element,$timeout,$document){var self=$scope;var permissions=domainAdminMgr.getDomainPermissions();self.hasSiteMgrPermission=permissions.hasSiteManagementPerm;self.viewOnlyShowed=!1;self.allowShare=utilitySrvc.getLocalStorage("allowShare");self.maximizeMainUI=function(){mainUISrvc.maximizeMainUI("map")};self.$parent&&self.$parent.$parent?self.doUpdateMaping=self.$parent.$parent.doUpdateMaping:self.doUpdateMaping={updating:!1};self.activeMap=mapManagerSrvc.getActiveMap();self.activePage=mapManagerSrvc.getActivePage();self.pathtip=new PathTip(self.activePage);self.isMapNew=function(){return!!mapManagerSrvc.getActiveMap()&&mapManagerSrvc.getActiveMap().realNew};self.modifiedStyle="map-not-updated";self.LockMapMenuTitle="Lock Map";$scope.DisplayTooltipOrNot=function(){$(".requestEditingRightPopup").is(":visible")?$scope.enableTooltip=!1:$scope.enableTooltip=!0};self.isModified=function(){var itemMap=mapManagerSrvc.getActiveMap();return!!itemMap&&itemMap.isModify()};self.userName=userSrvc.getUserName();self.userId=userSrvc.getUserID();self.isViewOnly=function(){var itemMap=mapManagerSrvc.getActiveMap();var result=!1;if(self.hasSiteMgrPermission){if(!self.ignoreViewOnlyShowed){if(void 0!==itemMap&&itemMap.getMapType()===NetBrain.Map.Const.MapType.overViewMap)return result;itemMap&&(result=itemMap.getEditRight().editorId!==self.userId)}}else result=itemMap.getEditRight().editorId!==self.userId;if(result&&!self.viewOnlyShowed){self.viewOnlyShowed=!0;$scope.$emit(NetBrain.Map.Event.ShowEditingRightsTip)}return result};var rootScopeonConfimAddNewMapPage=$rootScope.$on(NetBrain.Map.Event.ConfirmAddNewMapPage,(function(event,qMap,deferred,hostNames){if(self.activeMap==qMap){var message='Node "';for(var i=0;i<hostNames.length;++i){message+=hostNames[i];if(i==hostNames.length-1)break;if(2==i){message+="...";break}message+=", "}message+='" is in a different view than the current opened map, and cannot be dragged to this map.<br/><br/>Do you want to create a new map with the Node?';hostNames.length<=0&&(message="The selected Nodes are in a different view than the current map, and thus cannot be dragged to this map.<br/><br/>Do you want to create a new map with the selected Nodes?");nbAlertSrvc.confirm({message:message,title:"Warning",iconType:NB_ICON_WARNING,buttons:[{id:NB_CONFIRM_YES,label:"Create New Map Page"},{id:NB_CONFIRM_NO,label:"Cancel"}]}).then((function(){deferred.resolve()}),(function(btn){deferred.reject()}))}}));var rootScopeonAddNewMapPage=$rootScope.$on(NetBrain.Map.Event.AddNewMapPage,(function(event,qMap,deferred){self.activeMap==qMap&&self.addNewMapPage(event,qMap,deferred)}));self.onDndDisable=!1;self.onEditingName=!1;var dndDragIndex=null;var dndDragItem=null;self.onDndDragstart=function(index,item){dndDragIndex=index;dndDragItem=item};self.onDndDrop=function(index,item,external,type){if(dndDragItem){var removeIndex=dndDragIndex;index<dndDragIndex&&(removeIndex+=1);if(index!==dndDragIndex&&dndDragIndex+1!==index){self.activeMap._docList.splice(index,0,dndDragItem);self.activeMap._docList.splice(removeIndex,1);dndDragIndex=null;dndDragItem=null;try{$scope.$digest()}catch(e){console.error("doMouseOverEnter error")}self.activePage.setModify(!0)}}return!0};self.onDndDragend=function(){return!0};self.onDndMoved=function(event,index){return!0};self.addNewMapPage=function(event,qMap,deferred){event.preventDefault();angular.element($document[0].querySelectorAll(".pageContent")).css({visibility:"hidden"});null==qMap&&deferred&&deferred.reject();updateMapSrvc.canUpdateCurrentMap().then((function(){var doc=qMap.createNewDoc(NgDocType.Page,!0);null==doc&&deferred&&deferred.reject();qMap.setModify(!0);self.toggleActiveNetMapPage(doc,!0);$rootScope.$emit(pagePaneEvent.closePane);$timeout((function(){angular.element($document[0].querySelectorAll(".pageContent")).css({visibility:"visible"});if(self.activePage){var currMapOption=self.activePage.getMapViewOptionJson();self.activePage._diagram.commandHandler.setCusZoomSetp(currMapOption.step);var userL3=userSrvc.getUserConf().getJsWrapper().getUserL3StyleInExpandedStyle();var sysL3=NetBrain.Map.Const.getL3StyleInExpandedStyle();userL3?self.activePage.setL3StyleInExpandedStyle(userL3):self.activePage.setL3StyleInExpandedStyle(sysL3);var highlightMode=userSrvc.getUserConf().getJsWrapper().getUserInterfaceHighlightMode();highlightMode?self.activePage.setInterfaceHighlightMode(highlightMode):self.activePage.setInterfaceHighlightMode(NetBrain.Map.Const.InterfaceHighlightModeEnum.All);var vsId=function(mapPage){if(null==mapPage)return null;var info=mapPage.getVisualSpaceInfo();return null==info?null:info.visualSpaceInstanceId}(self.activePage);var userDefaultTopoTypes=userSrvc.getUserConf().getJsWrapper().getMapAutoLinkOptionList(vsId);self.activePage.getMapAutoLinkOptionList(vsId)||(userDefaultTopoTypes?self.activePage.setMapAutoLinkOptionList(userDefaultTopoTypes,vsId):self.activePage.setMapAutoLinkOptionList(["L3_Topo_Type"],vsId))}}),200);deferred&&deferred.resolve(doc)}),(function(){deferred&&deferred.reject()}));$timeout((function(){$rootScope.$emit("closeCacheLiveRunBox")}),50)};self.toggleActiveNetMapPage=function(netMap,bActive){if(null!=netMap){netMap.setActive(bActive);self.refreshMap();bActive&&(NetBrain.Map.currentActiveMapPage=netMap);self.activePage=mapManagerSrvc.getActivePage();$timeout((function(){$rootScope.$emit(NetBrain.Map.Event.ActivePageChanged)}),200)}};self.refreshMap=function(){var diagramPage=mapManagerSrvc.getActivePage()._diagram;null!=diagramPage&&diagramPage.delayInitialization((function(){diagramPage.requestUpdate()}))};self.toggleActiveNew=function(pageID){mapManagerSrvc.switchMapPage(pageID)};var rootScopeonPageChnaged=$rootScope.$on(NetBrain.Map.Event.ActivePageChanged,(function(){self.activePage=mapManagerSrvc.getActivePage();self.activeMap=mapManagerSrvc.getActiveMap()}));self.pageTitleClick=function(event){var tabwidth=$(event.target).closest(".tab-item").width();var dropDownWidth=$(".page-dropdown-frame").width();var left=$(event.target).closest(".tab-item").offset().left+tabwidth-dropDownWidth+33;$(".page-dropdown-frame").css("left",left+"px")};self.refreshDoc=function(){$rootScope.$emit("refreshOverviewMap")};self.shareDoc=function(){var activeMap=mapManagerSrvc.getActiveMap();if(null!=activeMap){var iHasEditRight=mapManagerSrvc.hasEditingRights(activeMap);var op={message:"",title:"Warning",iconType:NB_ICON_WARNING,buttons:[{id:NB_CONFIRM_YES,label:"Save"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};if(activeMap.realNew){op.message=NetBrain.Map.Message.ShareTipForNewMap;op.type=1}else if(activeMap.isModify()&&iHasEditRight){op.message=StringUtil.format(NetBrain.Map.Message.ShareTipForHasEditRight,{mapname:activeMap.getTitle()});op.type=2;op.buttons=[{id:NB_CONFIRM_YES,label:"Save"},{id:NB_CONFIRM_NO,label:"Don't Save"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]}else if(activeMap.isModify()&&!iHasEditRight){activeMap.getMapType()===NetBrain.Map.Const.MapType.overViewMap?op.message=NetBrain.Map.Message.ShareTipForOverViewMap:op.message=NetBrain.Map.Message.ShareTipForNoEditRight;op.type=3;op.buttons=[{id:NB_CONFIRM_NO,label:"Share Original Map"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]}(function(op){var deferred=$q.defer();if(!op.message)return $q.resolve();nbAlertSrvc.confirm(op).then((function(){mapManagerSrvc.saveMap().then((function(){deferred.resolve()}),(function(){deferred.reject()}))}),(function(result){2===result?deferred.resolve():3===result?deferred.reject("cancel"):deferred.resolve()}));return deferred.promise})(op).then((function(){self.shareURLPopup(activeMap)}),(function(){}))}};self.isShowCloseMapOndesktop=function(){return mainUISrvc.isDesktop()};var rootScopecloseMapOndesktop=$rootScope.$on("closeMapOndesktop",(function(event,isFromChangeDomain){self.closeMapOndesktop(event,isFromChangeDomain)}));var rootScopeViewOnlyShowed=$rootScope.$on("ignoreViewOnlyShowed",(function(event,isIgnoreViewOnlyShowed){self.ignoreViewOnlyShowed=isIgnoreViewOnlyShowed}));self.closeMapOndesktop=function(event,isFromChangeDomain){if(mainUISrvc.isDesktop()){var closemap=function(){httpMapSrvc.closeMap(self.activeMap.getDocId());!function(){var activeMap=mapManagerSrvc.getActiveMap();if(activeMap&&(activeMap.isTempEditRight||self.$parent.isSystemDeviceGroupMapType||activeMap.getMapType()===NetBrain.Map.Const.MapType.siteMap)){var currentMapId=activeMap.getDocId();activeMap.setEditRight("","");httpMapSrvc.releaseEditingRight(currentMapId);activeMap.isTempEditRight=!1;collaborationGridSrvc.getCollaborationHistory().then((function(res){_.each(res.requestsAndTransfers,(function(item){var mapIds=_.pluck(item.mapList,"mapId");if(_.contains(mapIds,currentMapId)&&!item.haveProcessed&&2===item.type){item.receiveUserName=item.fromUserName;item.receiveUserId=item.fromUserId;mapManagerSrvc.denyMapEditRight(item).then((function(){}))}}))}))}}();self.activeItem=void 0;self.ignoreViewOnlyShowed=!1;$rootScope.$emit(RunBookEvent.TOGGLE_RBA_PANEL,!1,"closeMap");$rootScope.$emit(NetBrain.Map.Event.CloseMap);NetBrain.Map.currentActiveMap=void 0;NetBrain.Map.currentActiveMapPage=void 0;NetBrain.Map.MapArgs=void 0;NetBrain.Map.CacheActivitySession=void 0;event.stopPropagation();event.preventDefault()};!function(){if(NetBrain.Map.currentActiveMap&&NetBrain.Map.currentActiveMap.isModify()&&!isFromChangeDomain){var mapName=NetBrain.Map.currentActiveMap.getTitle();var unSaveMsg=StringUtil.format(NetBrain.Map.Message.LeaveMapUnSaved,{mapname:mapName});NB_ICON_WARNING,NB_CONFIRM_YES,NB_CONFIRM_NO;backendQappPopupSrvc.openCloseMap({msg:unSaveMsg,mapId:mapManagerSrvc.getActiveMap().getDocId()}).then((function(){}),(function(ret){ret&&ret.button&&("save"===ret.button.type?mapManagerSrvc.saveMap().then((function(){backendQappPopupSrvc.onStopUnKeptTasks(mapManagerSrvc.getActiveMap().getDocId(),closemap)})):"notsave"===ret.button.type&&backendQappPopupSrvc.onStopUnKeptTasks(mapManagerSrvc.getActiveMap().getDocId(),closemap))}))}else backendQappPopupSrvc.onStopUnKeptTasks(mapManagerSrvc.getActiveMap().getDocId(),closemap)}()}};self.shareURLPopup=function(activeDoc){return $uibModal.open({templateUrl:"modules/nbQmap/views/sharemap/shareFileURLPopup.html",controller:"nb.qmap.shareFileURLPopupCtrl",windowClass:"shareFileURLPopup",backdrop:"static",size:"sm",resolve:{initList:function(){return activeDoc}}})};NetBrain.Page.SaveCallback=function(){if(angular.element("[modal-title='Save Map']").length>0)return!1;self.saveDoc();return!1};self.saveDoc=function(){if($scope.isEditor())mapManagerSrvc.saveMap();else{var obj={title:"Confirmation",iconType:NB_ICON_QUESTION,message:"You cant save this map unless you get the editing rights. Do you want to save it as a new map?"};nbAlertSrvc.confirm(obj).then((function(){mapManagerSrvc.saveMapAs()}),(function(){}))}};self.onSaveAs=function(){mapManagerSrvc.saveMapAs()};$scope.toggleViewPage=function(open){if(open){var activeMap=mapManagerSrvc.getActiveMap();var mapId=activeMap.getDocId();httpMapSrvc.getMapThumbnails(mapId).then((function(result){activeMap.getMapType()!==NetBrain.Map.Const.MapType.general&&activeMap.getMapType()!==NetBrain.Map.Const.MapType.siteMap&&activeMap.getMapType()!==NetBrain.Map.Const.MapType.deviceGroupMap||_.each(activeMap.getAllPage(),(function(pageItem){var noAjax=!0;if(result&&result.docPngList){var index=_.findIndex(result.docPngList,{pageID:pageItem.getDocId()});if(index>=0){var pageImg=result.docPngList[index].image;if(pageImg){pageItem.realImage=pageImg;noAjax=!1}}}if(activeMap.isModify()&&pageItem.isModify()||activeMap.getRealNew()||!0===noAjax){var realImage=pageItem.getImageBase64();"data:,"!==realImage&&(pageItem.realImage=realImage)}}))}))}};self.deleteMapPage=function(qMap,netMap,event){if(null!=qMap&&null!=netMap){var that=this;null!=event&&event.stopPropagation();updateMapSrvc.canUpdateCurrentMap().then((function(){nbAlertSrvc.confirm("Are you sure you want to delete the map page?").then((function(){var bDelActive=netMap.getActive();qMap.deletePage(netMap);var netMapPages=qMap.getAllPage();if(0===netMapPages.length){var newpage=qMap.createSubDoc(!0);that.toggleActiveNetMapPage(newpage,!0)}if(bDelActive){if(null==(netMapPages=qMap.getAllPage())||netMapPages.length<=0)return;that.toggleActiveNetMapPage(netMapPages[0],!0)}}))}))}};self.duplicateMapPage=function(qMap,netMap,event){if(null!=qMap&&null!=netMap){null!=event&&event.stopPropagation();updateMapSrvc.canUpdateCurrentMap().then((function(){qMap.doSave();var cloneNetMap=qMap.duplicateNetMap(netMap);qMap.deactiveAllPage();self.toggleActiveNetMapPage(cloneNetMap,!0);qMap.setModify(!0);$timeout((function(){var ul=angular.element(event.target).closest(".page-dropdown-frame").find(".pages.dnd");var li=ul.find(".map-page.selected");!function(ul,nli){console.log("top1",ul[0].scrollTop);var ulHeight=ul.height()-2;var li=nli[nli.length-1];if(ul[0]){var ulScrollTop=ul[0].scrollTop;var ulPos=getPos(ul[0]);if(li){var liPos=getPos(li);var rTop=liPos.top-ulPos.top;liPos&&rTop+90>=ulHeight+ulScrollTop&&(ul[0].scrollTop=rTop-180);liPos&&rTop<ulScrollTop&&(ul[0].scrollTop=rTop);console.log("top2",ul[0].scrollTop)}}}(ul,li)}),0)}))}};function getPos(obj){var l=0;var t=0;for(;obj;){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}return{left:l,top:t}}self.renameMapPage=function(qMap,netMap,event){if(null!=qMap&&null!=netMap){null!=event&&event.stopPropagation();var input=$(event.target);input.val($.trim(input.val()));self.onEditingName=!1;updateMapSrvc.canUpdateCurrentMap().then((function(){var newVal=$.trim(netMap.getTitle());if(0===newVal.length){netMap.setTitle($scope.oldNetMapTitle);return nbAlertSrvc.warnning("Page name can't be null.")}if(newVal.length>128){netMap.setTitle($scope.oldNetMapTitle);return nbAlertSrvc.warnning("The length of a page name cannot exceed 128 characters!")}if(NetBrain.NG.Const.valiteFileNameReg.test(newVal)){netMap.setTitle($scope.oldNetMapTitle);return nbAlertSrvc.warnning("A file name can't contain any of the following characters:</br> "+NetBrain.NG.Const.valiteFileNameRegTip)}if($(event.target).closest(".page-dropdown-frame").find('.page_title_font[title="'+$.trim(netMap.getTitle())+'"]').length>1){netMap.setTitle($scope.oldNetMapTitle);return nbAlertSrvc.warnning({showText:!0,message:'A page with the name "'+newVal+'" already exists. Please enter another name.'})}qMap.setModify(!0)}))}};self.setFocus=function(selector,mapPageObj){updateMapSrvc.canUpdateCurrentMap().then((function(){self.onEditingName=!0;$timeout((function(){var ele=angular.element($document[0].querySelectorAll(selector));Utility.setCursorPosition(ele[0]);$scope.oldNetMapTitle=$.trim(mapPageObj.getTitle());mapPageObj.rename=!0}),1)}))};self.onMapModeOptions=function(){updateMapSrvc.canUpdateCurrentMap().then((function(){var activePage=mapManagerSrvc.getActivePage();$uibModal.open({templateUrl:"modules/nbDataView/views/nbDataViewDisplayModeModal.html",controller:"nb.dataview.nbDataViewDisplayModeModalCtrl",windowClass:"dataview-display-mode-modal",backdrop:"static",resolve:{currentPage:function(){return activePage}}})}))};self.onAutoLinkOptions=function(){autoLinkOptionSrvc.openAutoLinkOption()};$scope.isEditor=function(){var activeMap=mapManagerSrvc.getActiveMap();if(null==activeMap)return!1;var result=!1;var editor=activeMap.getEditRight();userSrvc.getUserName()===editor.editorName&&(result=!0);return result};var rootScopeonRenameFileSuccess=$rootScope.$on("MyFiles::RenameFileSuccess",(function(event,data){var map=mapManagerSrvc.getActiveMap();map&&11===data.file.type&&data.file.originalId===map.getDocId()&&mapManagerSrvc.renameMap(data.file.newName)}));var rootScopeonDeleteFilesSuccess=$rootScope.$on("MyFiles::DeleteFilesSuccess",(function(event,data){var map=mapManagerSrvc.getActiveMap();map&&_.each(data.files,(function(item){11===item.type&&item.originalId===map.getDocId()&&(map.realNew=!0)}))}));var rootScopeonchangeRefreshStatus=$rootScope.$on("changeRefreshStatus",(function(event,data){self.modifiedStyle=data}));$scope.$on("$destroy",(function(){rootScopeonchangeRefreshStatus();rootScopeonRenameFileSuccess();rootScopeonDeleteFilesSuccess();rootScopeonPageChnaged();rootScopecloseMapOndesktop();rootScopeViewOnlyShowed();rootScopeonAddNewMapPage();rootScopeonConfimAddNewMapPage();NetBrain.Page.SaveCallback=null}));!0==(self.activeMap.getMapType()===NetBrain.Map.Const.MapType.overViewMap)&&(self.onDndDisable=!0);!0===window.isInIframe&&(NetBrain.Page.SaveCallback=function(){})}return directive}}(NetBrain);NetBrain,angular.module("nb.qmap").controller("PathLegende",["$scope",function($scope){$scope.isPositioning=!1;$scope.shouldShowPathLegend=!1;$scope.pathLegend=[];$scope.hasPath=!1}]).directive("nbPathLegendDirective",[function(){return{restrict:"E",templateUrl:"modules/nbQmap/views/pathLegend.html",scope:{},link:function(scope,element,attrs){},controller:["$scope","$element","$attrs","$rootScope","nb.qmap.mapManagerSrvc","nb.qmap.updateMapSrvc","nb.common.nbAlignSrvc",function($scope,element,attr,$rootScope,mapManagerSrvc,updateMapSrvc,nbAlignSrvc){function processPaths(netMapPage){var netMapOperator=netMapPage.getNetmapOperator();if(netMapOperator){var rawPathData=netMapOperator.getAllPaths();if(0!==rawPathData.length){$scope.hasPath=!0;$scope.pathLegend=rawPathData.map((function(rawPath){var pathData={id:rawPath.pathId,shouldDisplay:netMapOperator.getPathByPathId(rawPath.pathId).visible,type:"U",color:"-",source:"-",dest:"-",group:"None",protocol:"-",time:"-",strokeDashArray:null,isSelected:!1};var strokeDashArray=null;if(1===rawPath.routingScheme){pathData.type="M";strokeDashArray=BindHelper.lineTypeToArray(1===rawPath.dataSource.type?NetBrain.Map.Const.LinkType.DashDot:NetBrain.Map.Const.LinkType.Dot)}else{pathData.type="U";strokeDashArray=BindHelper.lineTypeToArray(1===rawPath.dataSource.type?NetBrain.Map.Const.LinkType.Dash:NetBrain.Map.Const.LinkType.Solid)}Array.isArray(strokeDashArray)&&(pathData.strokeDashArray=strokeDashArray.join(","));pathData.color=rawPath.color;pathData.source=rawPath.source;rawPath.sourcePort&&(pathData.source+=":"+rawPath.sourcePort.toString());pathData.dest=rawPath.dest;rawPath.destPort&&(pathData.dest+=":"+rawPath.destPort.toString());if(3===rawPath.orientation&&!rawPath.isA2B){var temp=pathData.source;pathData.source=pathData.dest;pathData.dest=temp}pathData.group=""===rawPath.group||void 0===rawPath.group?"None":rawPath.group;pathData.isGolden=rawPath.aamInfo&&""!==rawPath.aamInfo.goldenPathId;pathData.protocol=rawPath.protocolKeyWord;pathData.time=moment(rawPath.pathTime).local().format("YYYY-MM-DD hh:mm:ss");pathData.isSelected=netMapOperator.getPathByPathId(pathData.id).isSelected;return pathData}))}else $scope.hasPath=!1}}function removeEvtListener(){var netMapPage=mapManagerSrvc.getActivePage();if(netMapPage){var d=netMapPage.getGoJsDiagram();d.removeModelChangedListener((function(evt){evt.isTransactionFinished&&processPaths(netMapPage)}));d.removeDiagramListener("ChangedSelection",(function(){processPaths(netMapPage)}))}}function getPathObj(ind){var netMapOperator=(netMapPage=mapManagerSrvc.getActivePage())?netMapPage.getNetmapOperator():null;var netMapPage;return netMapOperator?netMapOperator.getPathByPathId($scope.pathLegend[ind].id):null}$scope.toggleDisplay=function(ind){var pathObj=getPathObj(ind);if(pathObj){$scope.pathLegend[ind].shouldDisplay=!$scope.pathLegend[ind].shouldDisplay;pathObj.visible=$scope.pathLegend[ind].shouldDisplay}};$scope.selectPath=function(ind){var pathObj=getPathObj(ind);$scope.pathLegend.forEach((function(path){path.isSelected=!1}));if(pathObj){pathObj.diagram.select(pathObj);pathObj.selectAllHops();$scope.pathLegend[ind].isSelected=!0;mapManagerSrvc.getActivePage().getNetmapOperator().showPathABByPathId($scope.pathLegend[ind].id)}};$scope.getTooltip=function(type){return"M"===type?"Multicast Path":"U"===type?"Unicast Path":""};$scope.closePathLegend=function(){$scope.shouldShowPathLegend=!1;removeEvtListener()};$scope.$on("$destroy",(function(){removeEvtListener()}));$rootScope.$on("openPathLegend",(function(){var netMapPage=mapManagerSrvc.getActivePage();if(netMapPage){processPaths(netMapPage);var d=netMapPage.getGoJsDiagram();d.addModelChangedListener((function(evt){evt.isTransactionFinished&&processPaths(netMapPage)}));d.addDiagramListener("ChangedSelection",(function(){processPaths(netMapPage)}))}$scope.isPositioning=!0;$scope.shouldShowPathLegend=!0;nbAlignSrvc.align(element,".realActive .map-canvas-containter",{spot:nbAlignSrvc.Spots.BottomLeft,rectify:{top:$scope.hasPath?45*($scope.pathLegend.length-6):-270,left:20}}).then((function(){$scope.isPositioning=!1}))}));$rootScope.$on(NetBrain.Map.Event.CloseMapOndesktop,(function(){$scope.$destroy()}))}]}}]);!function(NetBrain){angular.module("nb.qmap").directive("nbPreviewMapDirective",NbPreviewMapDirective);NbPreviewMapDirective.$inject=["$rootScope","$q","nb.netbrain.dataViewCacheSrvc","nb.common.nbDragDropSrvc","nb.topo.httpExternNbrSrvc","nb.dataview.applyDataViewSrvc","$log","nb.qmap.httpMapSrvc"];function NbPreviewMapDirective($rootScope,$q,dataViewCacheSrvc,nbDragDropSrvc,httpExternNbrSrvc,applyDataViewSrvc,$log,httpMapSrvc){controller.$inject=["$scope"];function controller($scope){$scope.netmap=new NetBrain.Map.CNetMap;$scope.renderMap=function(){$scope.netmap.setReadOnly(!1);$scope.netmap.setCurrentScope($scope);$scope.netmapOperator=new NetBrain.Map.CNetMapOperator($scope.netmap,dataViewCacheSrvc,$rootScope,$q,null,applyDataViewSrvc,$log);$scope.preDiagram.model.nodeDataArray=[];$scope.preDiagram.model.linkDataArray=[];$scope.netmap.setGoJsContext($scope.preDiagram,$scope.preDiagram.model);var tsName=NgUtil.getUniqueStr("fromPreviewMapDirective");$scope.netmapOperator.startTransaction(tsName);$scope.renderType===NetBrain.Map.Const.RenderMapType.byLinks?function(){var drawDataViewsSegment,drawNbrs;var displayDevIds=[];if($scope.limitNodeCount>0||$scope.limitLinkCount>0){!function(){drawDataViewsSegment={devDataViewSegmentList:[],intfDataViewSegmentList:$scope.dataViewsSegment&&$scope.dataViewsSegment.intfDataViewSegmentList};if($scope.dataViewsSegment&&$scope.dataViewsSegment.devDataViewSegmentList)for(var i=0;i<$scope.dataViewsSegment.devDataViewSegmentList.length;i++){var item=$scope.dataViewsSegment.devDataViewSegmentList[i];if(!(0===$scope.limitNodeCount||displayDevIds.length<$scope.limitNodeCount))break;if(!_.contains(displayDevIds,item.devId)){drawDataViewsSegment.devDataViewSegmentList.push(item);displayDevIds.push(item.devId)}}}();drawNbrs=function(displayNodes){var counter={};var displayLinks=[];var neighborLinks=$scope.neighborLinks;if(displayNodes&&displayNodes.length>0&&neighborLinks)for(var j=0;j<neighborLinks.length;j++){var nbrLink=neighborLinks[j];if(_.contains(displayNodes,nbrLink.devId)||_.contains(displayNodes,nbrLink.nbrDevId)){if(_overflowCheck(counter,nbrLink.devId)||_overflowCheck(counter,nbrLink.nbrDevId))continue;displayLinks.push(nbrLink)}}return displayLinks}(displayDevIds)}else{drawNbrs=$scope.neighborLinks;drawDataViewsSegment=$scope.dataViewsSegment}drawNbrs&&drawNbrs.length>0&&$scope.netmapOperator.extendNeighborsWithDataViewsSegment(drawNbrs,drawDataViewsSegment);_.each(drawDataViewsSegment.devDataViewSegmentList,(function(item){_.find(drawNbrs,(function(obj){return obj.devId===item.devId||obj.nbrDevId===item.devId}))||(0===$scope.limitNodeCount||$scope.limitNodeCount>0&&displayDevIds.length>0&&_.contains(displayDevIds,item.devId))&&$scope.netmapOperator.dropDeviceByDataView(item.devDataView)}));$scope.refreshShow();$scope.netmapOperator.commitTransaction(tsName)}():$scope.renderType===NetBrain.Map.Const.RenderMapType.byNodes&&(neighborNodes=$scope.limitNodeCount>0?_.first($scope.neighborNodes,$scope.limitNodeCount):$scope.neighborNodes,$scope.netmapOperator.addDevices(httpExternNbrSrvc,neighborNodes,"L3_Topo_Type").then((function(){$scope.refreshShow();$scope.netmapOperator.commitTransaction(tsName)})));var neighborNodes};$scope.$on(NetBrain.Map.Const.PreviewMapEvent.renderMap,(function(event,args){$scope.renderType=args.renderType||NetBrain.Map.Const.RenderMapType.byLinks;$scope.neighborLinks=args.neighborLinks;$scope.dataViewsSegment=args.dataViewsSegment;$scope.neighborNodes=args.neighborNodes||[];$scope.selectedDevices=args.selectedDevices||[];$scope.limitNodeCount=args.limitNodeCount||0;$scope.limitLinkCount=args.limitLinkCount||0;$scope.currentTopoTypeId=args.currentTopoTypeId;$scope.nodes=args.nodes;if($scope.dataViewsSegment)$scope.renderMap();else{var dataViewsSegmentIn=function(){var dataViewsSegmentIn=new window.DataViewsSegment;var currentShowDevices=[];var counter={};for(var nbrIndex in $scope.neighborLinks)if(Object.prototype.hasOwnProperty.call($scope.neighborLinks,nbrIndex)){var info=$scope.neighborLinks[nbrIndex];_addIntoDataViewsSegmentIn(dataViewsSegmentIn,info.id,currentShowDevices);null!=info.intf&&null!=info.intf.intfKeyObj&&(_overflowCheck(counter,info.id)?_setPreFilterFlag():dataViewsSegmentIn.addIntf(info.id,info.intf.intfKeyObj,info.topoTypeId));null!=info.nbrIntf&&null!=info.nbrIntf.intfKeyObj&&(_overflowCheck(counter,info.nbrId)?_setPreFilterFlag():dataViewsSegmentIn.addIntf(info.nbrId,info.nbrIntf.intfKeyObj,info.topoTypeId));if(!_addIntoDataViewsSegmentIn(dataViewsSegmentIn,info.nbrId,currentShowDevices)){_setPreFilterFlag();break}}for(var i in $scope.nodes)if(Object.prototype.hasOwnProperty.call($scope.nodes,i)){var deviceId=$scope.nodes[i];if(!_addIntoDataViewsSegmentIn(dataViewsSegmentIn,deviceId,currentShowDevices)){_setPreFilterFlag();break}}return dataViewsSegmentIn}();dataViewCacheSrvc.getDataViewsSegment(null,dataViewsSegmentIn).then((function(dataViewsSegmentOut){if(null!=dataViewsSegmentOut){$scope.dataViewsSegment=dataViewsSegmentOut;$scope.renderMap()}}))}}));$scope.$on(NetBrain.Map.Const.PreviewMapEvent.openPreviewMap,(function(event,args){if($scope.netmapOperator&&$scope.netmapOperator.getJson){var drawData={actionData:$scope.netmapOperator.getJson(),actionType:NetBrain.Common.Const.ActionType.DrawJson};if(args===NetBrain.Map.Const.ForceCreateNewMapFlag){drawData.forceCreateNewMap=!0;event.currentScope&&event.currentScope.currentTopoTypeId&&(drawData.topoType=event.currentScope.currentTopoTypeId);nbDragDropSrvc.drawJson(drawData)}else{drawData.needLayout=!0;nbDragDropSrvc.drawNodeJson(drawData)}}}));$scope.$on(NetBrain.Map.Const.PreviewMapEvent.openFullMap,(function(event,args){var json={renderType:$scope.renderType,neighborLinks:$scope.neighborLinks,neighborNodes:$scope.neighborNodes,selectedDevices:$scope.selectedDevices,limitNodeCount:$scope.limitNodeCount};var actionDataId=NgUtil.getGUID();var serialized=JSON.stringify(json);httpMapSrvc.addMapAction({id:actionDataId,content:serialized}).then((function(){var drawData={actionDataId:actionDataId,actionData:json,actionType:NetBrain.Common.Const.ActionType.DrawNodeByTopoLinks};args===NetBrain.Map.Const.ForceCreateNewMapFlag&&(drawData.forceCreateNewMap=!0);delete drawData.actionData.neighborLinks;nbDragDropSrvc.drawNodeByTopoLinks(drawData)}),(function(err){console.log(err)}))}));function _setPreFilterFlag(){!0}function _addIntoDataViewsSegmentIn(dataViewsSegmentIn,deviceId,currentShowDevices){if(0===$scope.limitNodeCount||currentShowDevices.length<$scope.limitNodeCount){if(null!=deviceId&&!_.contains(currentShowDevices,deviceId)){dataViewsSegmentIn.addDev(deviceId);currentShowDevices.push(deviceId)}return!0}return!1}function _overflowCheck(counter,nodeId,limitCount){limitCount||(limitCount=$scope.limitLinkCount);obj=counter,key=nodeId,_.has(obj,key)?obj[key]=parseInt(obj[key])+1:obj[key]=1;var obj,key;return!(0===limitCount||counter[nodeId]<=limitCount)}$scope.setDeviceSelected=function(){if($scope.selectedDevices)for(var i=0;i<$scope.selectedDevices.length;i++){var nodeId=$scope.selectedDevices[i];$scope.netmapOperator.setDeviceSelected(nodeId)}};$scope.refreshShow=function(){$scope.netmapOperator.forceDirectedLayoutNew();$scope.preDiagram.clearSelection();$scope.preDiagram.zoomToFit();$scope.setDeviceSelected();$scope.netmap.setReadOnly(!0);$scope.preDiagram.delayInitialization((function(){$scope.netmap.refreshMapViewOptionVisible()}))};$scope.isEditMode=function(){return!1}}return{restrict:"EA",scope:{},templateUrl:"modules/nbQmap/views/nbPreviewMapDirective.html",replace:!0,controller:controller}}}(NetBrain);!function(NetBrain){angular.module("nb.qmap").directive("nbSimplifiedMap",(function(){var directive={restrict:"E",scope:{},template:"<div style='width: 100%; height:100%;'></div>",controller:controller,link:function(scope,element,attrs){var $=go.GraphObject.make;scope.diagram=$(go.Diagram,element[0],{contentAlignment:go.Spot.Center,commandHandler:$(NetBrain.Map.CustomizedCommandHandler),padding:10,layout:$(go.GridLayout),"animationManager.isEnabled":!1,"layout.isInitial":!1,"layout.isOngoing":!1,"layout.isValidLayout":!0,hasHorizontalScrollbar:!1,hasVerticalScrollbar:!1,allowHorizontalScroll:!0,allowVerticalScroll:!0});scope.diagram.layout.spacing=new go.Size(30,0);scope.init(attrs.model,attrs.getdataeventname);if("backend"===attrs.model){element[0].style.position="absolute";element[0].style.opacity=0;element[0].style.zIndex=-1}attrs.width&&(element[0].style.width=attrs.width);attrs.height&&(element[0].style.height=attrs.height);var layerObj=scope.diagram.findLayer("Adornment");scope.diagram.addLayerBefore($(go.Layer,{name:GlobalContext.DeviceLayerName}),layerObj);layerObj=scope.diagram.findLayer(GlobalContext.DeviceLayerName);scope.diagram.addLayerBefore($(go.Layer,{name:GlobalContext.LinkLayerName}),layerObj);layerObj=scope.diagram.findLayer(GlobalContext.LinkLayerName);scope.diagram.addLayerBefore($(go.Layer,{name:GlobalContext.NormalShapObjName}),layerObj);layerObj=scope.diagram.findLayer(GlobalContext.NormalShapObjName);scope.diagram.addLayerBefore($(go.Layer,{name:GlobalContext.NormalShapBelowObjName}),layerObj);var _nodeTemplateMap=new go.Map("string",go.Node);var _groupTemplateMap=new go.Map("string",go.Node);var _linkTemplateMap=new go.Map("string",go.Link);_nodeTemplateMap.add(NetBrain.Map.CategoryMgr.NetworkDevice,NetBrain.Map.CompDevice.getMapTemplate(scope.diagram,scope,!1));_nodeTemplateMap.add(NetBrain.Map.CategoryMgr.VirtualNode,NetBrain.Map.CompVirtualNode.getMapTemplate(scope.diagram,scope));_nodeTemplateMap.add(NetBrain.Map.CategoryMgr.Media,NetBrain.Map.CompMedia.getMapTemplate(scope.diagram,scope,!1));_nodeTemplateMap.add(NetBrain.Map.CategoryMgr.Site,NetBrain.Map.CompSite.getMapTemplate(scope.diagram,scope,!1));_groupTemplateMap.add(NetBrain.Map.CategoryMgr.VirtualGroupNode,NetBrain.Map.CompVirtualGroupNode.getMapTemplate(scope.diagram,scope,!0));var linkTemplateOption=new NetBrain.Map.TopoLinkTemplateOption;NetBrain.Map.CompTopolink.initSomeLinkTemplateOption(linkTemplateOption);linkTemplateOption.linkLabelMouseHover=function(){};linkTemplateOption.linkLabelMouseLeave=function(){};linkTemplateOption.linkLabelClick=function(){};linkTemplateOption.linkLabelMouseEnter=function(){};linkTemplateOption.linkSelectChangeFunc=function(){};linkTemplateOption.isEditMode=function(){};linkTemplateOption.editLinkShow=function(){};linkTemplateOption.getEditDataView=function(){return null};_linkTemplateMap.add(NetBrain.Map.CompTopolink.getCategory(),NetBrain.Map.CompTopolink.getMapTemplate(linkTemplateOption,scope.diagram));_linkTemplateMap.add(NetBrain.Map.CategoryMgr.VirtualTopoLink,NetBrain.Map.CompVirtualLink.getMapTemplate(linkTemplateOption,scope.diagram,!1,scope));scope.diagram.nodeTemplateMap=_nodeTemplateMap;scope.diagram.groupTemplateMap=_groupTemplateMap;scope.diagram.linkTemplateMap=_linkTemplateMap},replace:!0};controller.$inject=["$scope","$rootScope","$q","nb.netbrain.dataViewCacheSrvc","nb.topo.httpExternNbrSrvc","nb.dataview.httpDataViewSrvc","nb.dataview.applyDataViewSrvc","nb.qmap.randomColorSrvc","nb.common.nbDragDropSrvc","$log"];function controller($scope,$rootScope,$q,dataViewCacheSrvc,httpExternNbrSrvc,httpDataViewSrvc,applyDataViewSrvc,randomColorSrvc,nbDragDropSrvc,$log){$scope.netmap=new NetBrain.Map.CNetMap;$scope.netmapOperator=new NetBrain.Map.CNetMapOperator($scope.netmap,dataViewCacheSrvc,$rootScope,$q,null,applyDataViewSrvc,$log);$scope.netmap.setReadOnly(!1);$scope.netmap.setCurrentScope($scope);$scope.extendNbrOp=$scope.netmapOperator.getExtendNbrOp();$scope.layoutTools=new NetBrain.Map.LayoutToolsHelper($scope.netmapOperator);$scope.extendNbrOp.checkDevice=function(){};$scope.queue=[];var deleteGetDataEventName=null;$scope.init=function(model,getdataeventname){deleteGetDataEventName&&deleteGetDataEventName();$scope.netmap.setGoJsContext($scope.diagram,$scope.diagram.model);deleteGetDataEventName=$rootScope.$on(getdataeventname,getData)};function getData(event,data,defered){$scope.queue.push({event:event,data:data,defered:defered});if(1==$scope.queue.length){setTimeout((function asynGetData(){$scope.queue.length>0&&function(arg){var defered=$q.defer();$scope.diagram.model.nodeDataArray=[];$scope.diagram.model.linkDataArray=[];$scope.netmap.getNetMapJsWrapper().setVisualSpaceInfo(null,!0);if(arg.data.mapJsonData){var pageList=arg.data.mapJsonData.pageList;if(null!=pageList&&pageList.length>=1){$scope.netmap.fromJson(pageList[0],arg.data.mapJsonData.version);$scope.netmap.doOpen(pageList[0])}}var extendNeighborLayout=$scope.layoutTools.extendNeighborLayout;$scope.layoutTools.extendNeighborLayout=function(){};arg.data.dataViewsSegment&&$scope.netmapOperator.extendNeighborsWithDataViewsSegment(arg.data.linkInfos,arg.data.dataViewsSegment);$scope.layoutTools.extendNeighborLayout=extendNeighborLayout;$scope.wait().then((function(){arg.defered.resolve({image:$scope.netmap.getImageBase64(!0),nodeDataArray:$scope.diagram.model.nodeDataArray,linkDataArray:$scope.diagram.model.linkDataArray,page:arg.data.pageInfo});defered.resolve()}),(function(){arg.defered.reject("");defered.resolve()}));return defered.promise}($scope.queue[0]).then((function(){$scope.queue.shift();asynGetData()}),(function(){$scope.queue.shift();asynGetData()}))}),0)}}$scope.wait=function(){var defered=$q.defer();var hitCount=0;var complete=function(){2==++hitCount&&defered.resolve()};var imgUrlsObj={};var imgUrls=[];_.forEach($scope.diagram.model.nodeDataArray,(function(node){var dataViewData=node.dataViewData;if(dataViewData){var imgUrl=BindHelper.toTarget_device_source(dataViewData);imgUrlsObj[imgUrl]=imgUrl}}));_.forEach(imgUrlsObj,(function(v,k){imgUrls.push(v)}));NgUtil.loadImages($q,imgUrls).then((function(){complete()}),(function(){complete()}));$scope.diagram.delayInitialization((function(){$scope.netmapOperator.forceDirectedLayoutNew();$scope.layoutTools.layoutForSDN({_id:"62adb752-7416-44e4-8d2e-9a55adbf5793",name:"SDN-Node-Layout",orientation:"t",type:1,layers:[{maximumDeviceCount:8,scale:2,associateTags:["ipn"]},{maximumDeviceCount:8,scale:2,associateTags:["spine","vrf"]},{maximumDeviceCount:8,scale:2,associateTags:["leaf","subnet","bd"],layerLevel:2},{maximumDeviceCount:8,scale:2,associateTags:["vcenter","outside","epg"],layerLevel:3},{maximumDeviceCount:8,scale:2,associateTags:["other","controller","endsys","contract"],layerLevel:4}]}).then((function(){$scope.diagram.clearSelection();$scope.diagram.zoomToFit();$scope.diagram.commandHandler.setSpace(1);$scope.netmap.refreshMapViewOptionVisible();$scope.diagram.requestUpdate();complete();defered.resolve()}),(function(){$scope.diagram.clearSelection();$scope.diagram.zoomToFit();$scope.diagram.commandHandler.setSpace(1);$scope.netmap.refreshMapViewOptionVisible();$scope.diagram.requestUpdate();complete();defered.resolve()}))}));return defered.promise};$scope.popDeviceView=function(event,target){};$scope.devPosLabelClicked=function(event,target,type){};$scope.redPlusClick=function(s,e){};$scope.isEditMode=function(){return!1};$scope.notifyHighlightChanged=function(){};$scope.$on("$destroy",(function(){deleteGetDataEventName&&deleteGetDataEventName()}))}return directive}))}(NetBrain);!function(){angular.module("nb.qmap").controller("nb.qmap.downloadSmartToolDialogCtrl",downloadSmartToolDialogCtrl);downloadSmartToolDialogCtrl.$inject=["$scope","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","$uibModalInstance"];function downloadSmartToolDialogCtrl($scope,nbAlertSrvc,utilitySrvc,$uibModalInstance){$scope.toolName="NetBrain Smart CLI";$scope.smartCliDownloadPath=NetBrain.NG.ConfigSettings.SMART_CLI_DOWNLOAD_PATH;$scope.disabledSmartDownloadDialog={state:!!utilitySrvc.getLocalStorage("disabledSmartDownloadDialog")};$scope.onCancel=function(){utilitySrvc.setLocalStorage("disabledSmartDownloadDialog",$scope.disabledSmartDownloadDialog.state);$uibModalInstance.dismiss()}}}(NetBrain);