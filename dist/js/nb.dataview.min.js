NetBrain,angular.module("nb.dataview",["nb.common","nb.systemmodel","nb.datamodel","nb.ng","nb.parserlib","nb.goldenbaseline"]);NetBrain,angular.module("nb.dataview").service("nb.dataview.aceEditInitSrvc",(function(){this.initAceEditor=function(aceEditor){define("ace/mode/config_file_highlight_rules",["require","exports","module","ace/lib/oop","ace/mode/text_highlight_rules"],(function(require,exports,module){var oop=require("../lib/oop");var TextHighlightRules=require("./text_highlight_rules").TextHighlightRules;var configFileHighlightRules=function(){this.$rules={start:[{token:"keyword",regex:"^Interface|^interface|^Address-family|^address-family|^Ip classless|^ip classless|^Snmp-server|^snmp-server|^Access-list|^access-list|^Hostname|^hostname|^Aaa authentication|^aaa authentication|^Aaa authorization|^aaa authorization|^Aaa accounting|^aaa accounting|^Controller|^controller|^Router|^router|^Access-list|^access-list|^Ip access-list|^ip access-list|^Queue-list|^queue-list|^Priority-list|^priority-list|^Route-map|^route-map|^Spanning-tree|^spanning-tree|^Ip route|^ip route|^Vpdn|^vpdn|^Vpdn-group|^vpdn-group|^Buffers|^buffers|^Ip local pool|^ip local pool|^Ip nat|^ip nat|^Ip community-list|^ip community-list|^Ip as-path access-list|^ip as-path access-list|^Ip prefix-list|^ip prefix-list|^Class-map|^class-map|^Ip pim|^ip pim|^Policy-list|^policy-list|^Dial-peer|^dial-peer|^Voice-port|^voice-port|^Ip vrf|^ip vrf|^Mpls|^mpls",next:"valData"}],valData:[{token:"constant",regex:":.*| .*|;.*|\\t.*|!.*|\\(.*|\\).*|\\{.*|\\}.*",next:"start"}]};this.normalizeRules()};oop.inherits(configFileHighlightRules,TextHighlightRules);exports.configFileHighlightRules=configFileHighlightRules}));define("ace/mode/folding/configFileStyle",["require","exports","module","ace/lib/oop","ace/range","ace/mode/folding/fold_mode"],(function(require,exports,module){var oop=require("../../lib/oop");var Range=require("../../range").Range;var BaseFoldMode=require("./fold_mode").FoldMode;var FoldMode=exports.FoldMode=function(){};oop.inherits(FoldMode,BaseFoldMode);(function(){this.foldingStartMarker=/^[^!\n].*$|(!\s\w)/;this.foldingStopMarker=/^!$/;this.getFoldWidget=function(session,foldStyle,row){var line=session.getLine(row);if("end"!==line&&this.foldingStartMarker.test(line)){if(0===row)return"start";var tmpRow=row;var tmpLine=session.getLine(--tmpRow);for(;""===tmpLine;){tmpLine=session.getLine(--tmpRow);if(tmpRow<0)return""}if(!this.foldingStartMarker.test(tmpLine))return"start"}return"markbeginend"===foldStyle&&this.foldingStopMarker&&this.foldingStopMarker.test(line)?"end":""};this.getFoldWidgetRange=function(session,foldStyle,row,forceMultiline){var line=session.getLine(row);if(new RegExp(this.foldingStartMarker.source).exec(line))return this.getSectionRange(session,row)};this.getSectionRange=function(session,row){var startRow=row;var startColumn=session.getLine(row).length;var endRow=row;var maxRow=session.getLength();var findFoldingStop=!1;for(;++row<maxRow;)if(session.getLine(row).match(this.foldingStopMarker)){endRow=row;findFoldingStop=!0;break}findFoldingStop||(endRow=row-1);return new Range(startRow,startColumn,endRow,session.getLine(endRow).length)}}).call(FoldMode.prototype)}));define("ace/mode/configFile",["require","exports","module","ace/lib/oop","ace/mode/text","ace/mode/config_file_highlight_rules","ace/range","ace/mode/folding/configFileStyle"],(function(require,exports,module){var oop=require("../lib/oop");var TextMode=require("./text").Mode;var configHighlightRules=require("./config_file_highlight_rules").configFileHighlightRules;var configStyleFoldMode=require("./folding/configFileStyle").FoldMode;var Mode=function(){this.HighlightRules=configHighlightRules;this.foldingRules=new configStyleFoldMode};oop.inherits(Mode,TextMode);(function(){this.$id="ace/mode/configFile"}).call(Mode.prototype);exports.Mode=Mode}));aceEditor.session.setFoldStyle("markbegin");aceEditor.session.setMode("ace/mode/configFile")}}));!function(NetBrain){angular.module("nb.dataview").factory("nb.dataview.httpDataViewManagerSrvc",HttpDataViewManagerSrvc);HttpDataViewManagerSrvc.$inject=["nb.ng.nbHttp"];function HttpDataViewManagerSrvc(nbHttp){return{getDataViewTreeRoot:function(dataSrc,dataViewType,mapId){var options={mapId:mapId,dataViewType:dataViewType};return nbHttp.post("dataviewtree/getDataViewTreeRoot",options)},getMonitorDataViewTreeRoot:function(){return nbHttp.post("dataviewtree/getMonitorDataViewTreeRoot",{dataViewType:"Monitor"})},getDataViewTreeNodeWithChildren:function(dataSrc,dataViewType,mapId,startNodeId){var options={mapId:mapId,dataViewType:dataViewType,startNodeId:startNodeId};return nbHttp.post("dataviewtree/getDataViewTreeNodeWithChildren",options)},getDataViewTreeChildNodes:function(dataSrc,parentId){var options={parentId:parentId};return nbHttp.post("dataviewtree/getDataViewTreeChildNodes",options)},getDataViewTreeNodeById:function(dataSrc,nodeId){var path="dataviewtree/getDataViewTreeNodeById/"+nodeId;return nbHttp.get(path)},upInsertDataViewTreeNode:function(dataSrc,dataViewTreeNode){var options=dataViewTreeNode||{};return nbHttp.post("dataviewtree/upInsertDataViewTreeNode",options)},deleteDataViewTreeNodes:function(dataSrc,nodeIds){var options=nodeIds||[];return nbHttp.delete("dataviewtree/deleteDataViewTreeNodes",options)},deleteDeviceDataViewsForDevices:function(dataSrc,dataViewGroupId,deviceIds){var options={dataViewGroupId:dataViewGroupId,deviceIds:deviceIds};return nbHttp.post("dataview/deleteDeviceDataViewsForDevices",options)},deleteDataViewGroupsInALog:function(dataSrc,dataViewGroupIds){var options={dataViewGroupIds:dataViewGroupIds};return nbHttp.post("dataviewtree/deleteDataViewGroupsInALog",options)},filterDataViewTreeLeaves:function(dataSrc,mapId,filter){var options={mapId:mapId,filter:filter};return nbHttp.post("dataviewtree/filterDataViewTreeLeaves",options)},getDeviceDataViewsByDataViewGroupId:function(dataSrc,nodeId){var options={dataViewGroupId:nodeId};return nbHttp.post("dataviewgroup/getDeviceDataViewsByDataViewGroupId",options)},getDeviceDataViewsInPage:function(dataSrc,dataViewGroupId,pageSize,pageNumber,filterFields,filter,filterByValue,sortField,sortOrder,getDataViewGroup){var options={dataViewGroupId:dataViewGroupId,pageSize:pageSize,pageNumber:pageNumber,FilterFields:filterFields,filter:filter,filterByValue:filterByValue,sortField:sortField,sortOrder:sortOrder,getDataViewGroup:!!getDataViewGroup};return nbHttp.post("dataviewgroup/getDeviceDataViewsInPage",options)},resetDeviceDataViewOnPos:function(dataSrc,deviceDataViewId,devicePos,overflowPos){var options={deviceDataViewId:deviceDataViewId,devicePos:devicePos,overflowPos:overflowPos};return nbHttp.post("dataviewedit/resetDeviceDataViewOnPos",options)},resetDeviceDataViews:function(dataSrc,deviceDataViewIds){var options={deviceDataViewIds:deviceDataViewIds};return nbHttp.post("dataviewedit/resetDeviceDataViews",options)},resetDeviceDataViewOnInterfacePos:function(dataSrc,deviceDataViewId,interfaceKey,interfacePos,overflowPos){var options={deviceDataViewId:deviceDataViewId,interfacePos:interfacePos,overflowPos:overflowPos,interfaceKey:interfaceKey};return nbHttp.post("dataviewedit/resetDeviceDataViewOnInterfacePos",options)},resetDeviceDataViewOnInterfaces:function(dataSrc,deviceDataViewId,interfaceKeys){var options={deviceDataViewId:deviceDataViewId,interfaceKeys:interfaceKeys};return nbHttp.post("dataviewedit/resetDeviceDataViewOnInterfaces",options)},resetDeviceDataViewsInDataViewGroup:function(dataSrc,dataViewGroupId){var options={dataViewGroupId:dataViewGroupId};return nbHttp.post("dataviewedit/resetDeviceDataViewsInDataViewGroup",options)},saveAsDataViewFromMap:function(dataSrc,mapDataView,needMerge){var options={needMerge:needMerge,mapDataView:mapDataView};return nbHttp.post("dataviewgroup/saveAsDataViewFromMap",options)},getDataViewGroupsById:function(dataSrc,dataViewGroupId){var path="dataviewgroup/getDataViewGroupsById/"+dataViewGroupId;return nbHttp.get(path)},getDataViewGroupUpdateRecords:function(dataSrc,dataViewGroupId){var path="dataviewgroup/getDataViewGroupUpdateRecords/"+dataViewGroupId;return nbHttp.get(path)},upInsertDataViewGroup:function(dataSrc,dataViewGroup){return nbHttp.post("dataviewgroup/upInsertDataViewGroup",dataViewGroup)},deleteDeviceDataViews:function(dataSrc,deviceDataViewIds){var options={deviceDataViewIds:deviceDataViewIds};return nbHttp.post("dataview/deleteDeviceDataViews",options)},deleteDeviceDataViewsInDataViewGroup:function(dataSrc,dataViewGroupId){var options={dataViewGroupId:dataViewGroupId};return nbHttp.post("dataviewgroup/deleteDeviceDataViewsInDataViewGroup",options)},deleteDataViewGroup:function(dataViewGroupId){var options={dataViewGroupId:dataViewGroupId};return nbHttp.post("dataview/deleteDataViewGroup",options)},unlockDeviceDataViewOnPos:function(dataSrc,deviceDataViewId,devicePos,overflowPos){var options={deviceDataViewId:deviceDataViewId,devicePos:devicePos,overflowPos:overflowPos};return nbHttp.post("dataviewedit/unlockDeviceDataViewOnPos",options)},unlockDeviceDataViewOnInterfacePos:function(dataSrc,deviceDataViewId,interfaceKey,interfacePos,overflowPos){var options={deviceDataViewId:deviceDataViewId,interfaceKey:interfaceKey,interfacePos:interfacePos,overflowPos:overflowPos};return nbHttp.post("dataviewedit/unlockDeviceDataViewOnInterfacePos",options)},unlockDeviceDataViewOnInterfaces:function(dataSrc,deviceDataViewId,interfaceKeys){var options={deviceDataViewId:deviceDataViewId,interfaceKeys:interfaceKeys};return nbHttp.post("dataviewedit/unlockDeviceDataViewOnInterfaces",options)},unlockDeviceDataViews:function(dataSrc,deviceDataViewIds){var options={deviceDataViewIds:deviceDataViewIds};return nbHttp.post("dataviewedit/unlockDeviceDataViews",options)},unlockDeviceDataViewsInDataViewGroup:function(dataSrc,dataViewGroupId){var options={dataViewGroupId:dataViewGroupId};return nbHttp.post("dataviewedit/unlockDeviceDataViewsInDataViewGroup",options)},deleteInterfaceInDeviceDataView:function(dataSrc,deviceDataViewId,interfaceKeys){var options={deviceDataViewId:deviceDataViewId,interfaceKeys:interfaceKeys};return nbHttp.post("dataviewedit/deleteInterfaceInDeviceDataView",options)},getDataViewTreeLeafNodeByName:function(dataSrc,parentId,dataViewGroupName){var options={parentId:parentId,name:dataViewGroupName};return nbHttp.post("dataviewtree/getDataViewTreeLeafNodeByName",options)},moveDataViewTreeNode:function(dataSrc,parentId,nodeId){var options={parentId:parentId,nodeId:nodeId};return nbHttp.post("dataviewtree/moveDataViewTreeNode",options)},getDataViewTreeChildNodeByName:function(dataSrc,parentId,name,nodeType){var options={parentId:parentId,name:name,nodeType:nodeType};return nbHttp.post("dataviewtree/getDataViewTreeChildNodeByName",options)},areDevicesExisting:function(lsNodeIds){return nbHttp.post("dataviewedit/areDevicesExisting",lsNodeIds)},setHideInDataviewPanel:function(folderId,isHide){var reqInfo={folderId:folderId,isHide:isHide};return nbHttp.post("dataviewedit/setHideInDataviewPanel",reqInfo)},getInterfaceDisplaySchemaValues:function(intfKeys){return nbHttp.post("dataviewgroup/GetInterfaces",intfKeys,{avoidBlockUI:!0})},getDeviceDataViewInterface:function(deviceDataViewId){return nbHttp.get("dataviewgroup/getDeviceDataViewInterface/"+deviceDataViewId,null,{avoidBlockUI:!0})}}}}(NetBrain);!function(NetBrain){angular.module("nb.dataview").factory("nb.dataview.httpDataViewInfoMgrSrvc",HttpDataViewInfoMgrSrvc);HttpDataViewInfoMgrSrvc.$inject=["nb.ng.nbHttp"];function HttpDataViewInfoMgrSrvc(nbHttp){return{getDataViewPanelData:function(devIdList,mapId){var options={mapId:mapId,devices:devIdList};return nbHttp.post("dataview/GetDataViewPanelData",options)}}}}(NetBrain);!function(NetBrain){angular.module("nb.dataview").factory("nb.dataview.httpDataViewSrvc",HttpDataViewSrvc);HttpDataViewSrvc.$inject=["$http","$q","$log","$location","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.ng.nbHttp"];function HttpDataViewSrvc($http,$q,$log,$location,utilitySrvc,httpAuthSrvc,nbHttp){return{updatePosList:function(devicePosList,devInterfacePosList,dataViewGroupId){var options={deviceDataViewPositionsList:devicePosList,deviceIntfDataViewPositionsList:devInterfacePosList,dataViewGroupId:dataViewGroupId};return nbHttp.post("dataview/updatePosList",options)},updatePosListForDevices:function(dataSrc,devicePosList){var options={deviceDataViewPositionsList:devicePosList};return nbHttp.post("dataview/updatePosListForDevices",options)},updatePosListForDevIntfs:function(dataSrc,devInterfacePosList){var options={deviceIntfDataViewPositionsList:devInterfacePosList};return nbHttp.post("dataview/updatePosListForDevIntfs",options)},getDeviceDataViewsByDataViewGroupIdAndDevIds:function(dataSrc,strDataViewGroupId,devIds,strTime){var options={dataViewGroupId:strDataViewGroupId,deviceIdList:devIds};strTime&&(options.dateTime=new Date(strTime));return nbHttp.post("dataviewgroup/getDeviceDataViewsByDataViewGroupIdAndDevIds",options)},getDeviceDataViewsByDataViewGroup:function(groupId,deviceIds){var options={deviceIds:deviceIds,dataViewGroupId:groupId};return nbHttp.post("dataviewgroup/getDeviceDataViewsByDataViewGroup",options)},getApplyDataViewsByDataViewGroupIdAndDevIds:function(dataSrc,dataViewGroupIds,devIds){var options={dataViewGroupIds:dataViewGroupIds,deviceIdList:devIds};return nbHttp.post("dataviewgroup/getApplyDataViewsByDataViewGroupIdAndDevIds",options)},getMergedDataViewAndTemplate:function(req){return nbHttp.post("dataviewgroup/getMergedDeviceDataViewByDataViewAndDataViewTemplate",req)},getApplyDataViewTemplateResult:function(req){return nbHttp.post("dataViewTemplate/apply",req)},getDeviceDataViewsByAlogIdAndDevIds:function(dataSrc,strDataViewGroupId,strAlogId,devIds,strTime){var options={dataViewGroupId:strDataViewGroupId,alogId:strAlogId,deviceIdList:devIds};strTime&&(options.dateTime=new Date(strTime));return nbHttp.post("dataviewgroup/getDeviceDataViewsByAlogIdAndDevIds",options)},getDataTableByTimePoint:function(option){return nbHttp.post("dataview/getDataTableByTimePoint",option)},getExclusiveDeviceDataViewsByCompoundDVIdAndDevIds:function(dataSrc,compoundDVId,dvgId,devIds){var options={compoundDVId:compoundDVId,dataViewGroupId:dvgId,deviceIdList:devIds};return nbHttp.post("dataviewgroup/getExclusiveDeviceDataViewsByCompoundDVIdAndDevIds",options)},getDataViewsSegment:function(dataSrc,dataViewsSegment){return nbHttp.post("dataview/getDataViewsSegment",dataViewsSegment,{avoidBlockUI:!0})},addAttachmentToLabelPosition:function(dataSrc,argFile,argFileGuid,argDVGId){var options={file:argFile,fileId:argFileGuid,dataViewGroupId:argDVGId};return nbHttp.post("dataview/attchment/addAttachmentToLabelPosition",options)},getAttachmentByKey:function(dataSrc,argFileGuid){var path="dataview/attchment/getAttachmentByKey/"+argFileGuid;return nbHttp.get(path)},deleteAttachmentByKey:function(fileId){var options={fileId:fileId};return nbHttp.post("dataview/attachment/deleteAttachmentByKey",options)},deleteAttachemntsByKeys:function(fileIds){var options=fileIds||[];return nbHttp.delete("dataview/attchment/deleteAttachemntsByKeys",options)},getDevicesInGroup:function(groupId,avoidBlockUI){var options={avoidBlockUI:avoidBlockUI};return nbHttp.get("dataview/GetDevicesInDataViewGroup/"+groupId,null,options)},getDevicesInGroups:function(groupList){var options={groupIds:groupList};return nbHttp.post("dataview/GetDevicesInDataViewGroups",options)},getMapDataViewList:function(mapId){return nbHttp.get("dataview/getMapDataViewList/"+mapId)},getDataViewInfoAndDevices:function(groupId){return nbHttp.get("dataview/GetDataViewInfoAndDevices/"+groupId)},getDataUnitListByDefinitionId:function(dataSrc,argDataViewDefinitionId,belongType){var options={belongType:belongType,dataViewDefinitionId:argDataViewDefinitionId};return nbHttp.post("dataviewdefinition/getDataUnitListByDefinitionId",options)},getDataUnitStorageValue:function(dataSrc,argDVGroupId,argDVTaskInfoId,argDevId,argIntfId,argUId){var options={intfId:argIntfId,uId:argUId,deviceId:argDevId,dataViewGroupId:argDVGroupId,dataViewTaskInfoId:argDVTaskInfoId};return nbHttp.post("dataviewtask/getDataUnitStorageValue",options)},doesDataViewGroupExist:function(dataSrc,argDataViewGroupId){var path="dataviewgroup/doesDataViewGroupExist/"+argDataViewGroupId;return nbHttp.get(path)},checkInGlobalDataView:function(dataSrc,dataViewGroupId,dataViewName,parentNodeId){var options={dataViewGroupId:dataViewGroupId,dataViewName:dataViewName,parentNodeId:parentNodeId};return nbHttp.post("dataviewtree/checkInGlobalDataView",options)},getDataViewGroupsByALogId:function(dataSrc,alogId){var path="dataviewgroup/getDataViewGroupsByALogId/"+alogId;return nbHttp.get(path)},getFrequence:function(dataSrc,dataViewTaskInfoId){var path="dataviewtask/getFrequence/"+dataViewTaskInfoId;return nbHttp.get(path)},hasGlobalDataViewGroupWithName:function(dataSrc,name,folderId){var options={name:name,folderId:folderId};return nbHttp.post("dataviewtree/hasGlobalDataViewGroupWithName",options)},isRunningTaskByDataViewGroupId:function(dataViewGroupId){var path="dataviewtask/isRunningTask/"+dataViewGroupId;return nbHttp.get(path)},isRunningTasksByDataViewGroupIds:function(dataViewGroupIds){var options=_.map(dataViewGroupIds,(function(dataViewGroupId){return{dataViewGroupId:dataViewGroupId,isRunning:!1}}));return nbHttp.post("dataviewtask/isRunningTask/",options)},getSdnDataUnitValueByTemplate:function(isNodePosition,nodeIdentify,uId,duSrcType,isRefLink){var args={isNodePosition:isNodePosition||!1,nodeIdentify:nodeIdentify,uId:uId,duSrcType:duSrcType,isRefLink:isRefLink};return nbHttp.post("dataview/getSdnDataUnitValueByTemplate/",args)},getParseredLink:function(link,devId,interfaceId){var options={link:link,devId:devId,interfaceId:interfaceId};return nbHttp.post("dataview/GetParsedLink",options,{avoidBlockUI:!1})},updateDataViewNote:function(note,dataviewGroupId,noteLinkedInfos){var args={note:note,dataviewGroupId:dataviewGroupId,noteLinkedInfos:noteLinkedInfos};return nbHttp.post("dataviewedit/updateDataViewNote",args)}}}}(NetBrain);!function(NetBrain){angular.module("nb.dataview").factory("nb.dataview.applyDataViewSrvc",applyDataViewSrvc);applyDataViewSrvc.$inject=["$document","$timeout","nb.dataview.aceEditInitSrvc","nb.netbrain.dataViewCacheSrvc","nb.common.nbAlertSrvc","$q","nb.ng.userSrvc","nb.qmap.updateMapSrvc","nb.dataview.httpDataViewSrvc","nb.ng.deviceAccessCacheSrvc","nb.qmap.mapManagerSrvc","$rootScope"];function applyDataViewSrvc($document,$timeout,aceEditInitSrvc,dataViewCacheSrvc,nbAlertSrvc,$q,userSrvc,updateMapSrvc,httpDataViewSrvc,deviceAccessCacheSrvc,mapManagerSrvc,$rootScope){function _getDataViewGroupId(page){page||console.error("page is null");return page.getNetMapJsWrapper().getExtendDataViewData().dataViewId}function _applyDataviewsOnDevicesInternal(relativeDevices,dataViewGroupId,mapPage,avoidBlockUI,refreshDv,showNoPermissionAlert){var page=mapPage||mapManagerSrvc.getActivePage();var deferred=$q.defer();var promiseForGetDevicesInGroup=null;dataViewGroupId&&dataViewGroupId!==DefaultDataViewInfo.defaultDevDVGId&&(promiseForGetDevicesInGroup=httpDataViewSrvc.getDevicesInGroup(dataViewGroupId,avoidBlockUI));var directiveScope=function(page){var elements=$(".dataViewListContainer .templateList");for(var i=0;i<elements.length;i++){var currentScope=angular.element(elements[i]).scope();if(currentScope.activePage.getDocId()===page.getDocId())return currentScope}return null}(page);var promiseForRefreshDataViewPanel=null;refreshDv&&(directiveScope?promiseForRefreshDataViewPanel=directiveScope.getAllDataView(!0):$rootScope.$emit("refreshDataViewList"));promiseForRefreshDataViewPanel?promiseForRefreshDataViewPanel.then((function(){applyDataViewInternal(promiseForGetDevicesInGroup,page,relativeDevices,avoidBlockUI,deferred,showNoPermissionAlert);directiveScope.getRecommendDvTemplate()})):applyDataViewInternal(promiseForGetDevicesInGroup,page,relativeDevices,avoidBlockUI,null,showNoPermissionAlert).then((function(){deferred.resolve()}),(function(reason){deferred.reject(reason)}));return deferred.promise}function _setMapExtendData(page,dataViewInfo,runbookInfo,dvtInfo){var wrapper=page.getNetMapJsWrapper();var defaultData=wrapper.getDefaultExtendData();runbookInfo&&(defaultData.extendRunbookData=_.extend(defaultData.extendRunbookData,runbookInfo));dvtInfo&&(defaultData.extendDataViewTemplateData=_.extend(defaultData.extendDataViewTemplateData,dvtInfo));dataViewInfo&&(defaultData.extendDataViewData=_.extend(defaultData.extendDataViewData,dataViewInfo));wrapper.setExtendData(defaultData)}function applyDataViewInternal(promiseForGetDevicesInGroup,page,relativeDevices,avoidBlockUI,deferred,showNoPermissionAlert){var noDeferred=!1;if(!deferred){deferred=$q.defer();noDeferred=!0}promiseForGetDevicesInGroup?promiseForGetDevicesInGroup.then((function(deviceList){doApplyDataViewOnDevices(page,deviceList,showNoPermissionAlert).then((function(){page.refreshMapViewOptionVisible();$rootScope.$broadcast(ConsolePaneEvent.REFRESH_DATA_VIEW_CONSOLE_PANE);deferred.resolve()}),(function(reazon){deferred.reject(reazon)}))}),(function(){return deferred.reject()})):doApplyDataViewOnDevices(page,relativeDevices,showNoPermissionAlert).then((function(){page.refreshMapViewOptionVisible();$rootScope.$broadcast(ConsolePaneEvent.REFRESH_DATA_VIEW_CONSOLE_PANE);deferred.resolve()}),(function(reazon){deferred.reject(reazon)}));if(noDeferred)return deferred.promise}function doApplyDataViewOnDevices(page,relativeDevices,showNoPermissionAlert){var deferred=$q.defer();var noPrivilegetip="The data view of some qualified devices cannot be displayed due to restricted privileges.";var dataViewApplyOp=page.getNetmapOperator().getDataViewApplyOp();var groupId=_getDataViewGroupId(page);if(!groupId){console.warn("data view group id is empty, can't get device data views");return $q.reject()}deviceAccessCacheSrvc.getDAPObject(relativeDevices,[1]).then((function(res){var filteredDevices=_.compact(_.map(res,(function(v,k){return!0===v?k:""})));showNoPermissionAlert&&_.any(res,(function(v,k){return!1===v}))&&$rootScope.$emit("GEVENT_MapFloatMessage",noPrivilegetip);httpDataViewSrvc.getDeviceDataViewsByDataViewGroup(groupId,filteredDevices).then((function(devDvObjs){try{_.some(devDvObjs,(function(obj){return obj.noPrivilege}))&&showNoPermissionAlert&&$rootScope.$emit("GEVENT_MapFloatMessage",noPrivilegetip);if((devDvObjs=_.filter(devDvObjs,(function(obj){return!obj.noPrivilege})))&&_.isArray(devDvObjs)&&0===devDvObjs.length)return deferred.resolve();if(page.getExtendDataViewData().dataViewId==!groupId)return deferred.resolve();dataViewApplyOp.doApplyDataViewGroup(null,devDvObjs,null,!0);page.refreshMapViewOptionVisible();deferred.resolve()}catch(err){deferred.reject()}}),(function(reason){console.warn(reason);deferred.reject(reason)}))}),(function(reason){console.warn(reason);deferred.reject(reason)}));return deferred.promise}return{applyDataviewsOnDevices:function(relativeDevices,dataViewGroupId,mapPage,avoidBlockUI,refreshDv){return _applyDataviewsOnDevicesInternal(relativeDevices,dataViewGroupId,mapPage,avoidBlockUI,refreshDv,!1)},applyDataviewsOnDevicesWithPermissionAlert:function(relativeDevices,dataViewGroupId,mapPage,avoidBlockUI,refreshDv){return _applyDataviewsOnDevicesInternal(relativeDevices,dataViewGroupId,mapPage,avoidBlockUI,refreshDv,!0)},applyTemporaryView:function(dvList,page){page.setDisplayMode("switchMode");page.getNetmapOperator().resetDefaultDataView(dataViewCacheSrvc,!1).then((function(){!function(dvList,page){var devDataViewSegment={};devDataViewSegment.__proto__=new DataViewsSegment;devDataViewSegment.devDataViewSegmentList=dvList.devDataViewSegmentList;devDataViewSegment.intfDataViewSegmentList=dvList.intfDataViewSegmentList;page.getNetmapOperator().getDataViewApplyOp().doApplyDataViewsSegmentTemp(devDataViewSegment)}(dvList,page)}))},applyDataViewTemplate:function(data,dataViewInfo,runbookInfo,dvtInfo){var deferred=$q.defer();var page=mapManagerSrvc.getActivePage();(function(page){var deferred=$q.defer();if(function(page){page||console.error("page is null");if(_getDataViewGroupId(page)||function(page){page||console.error("page is null");return page.getNetMapJsWrapper().getExtendDataViewTemplateData().dataViewTemplateId}(page))return!1;return!0}(page))return $q.resolve();page.getNetmapOperator().resetDefaultDataView(dataViewCacheSrvc,!1).then((function(){deferred.resolve()}),(function(){deferred.resolve()}));return deferred.promise})(page).then((function(){httpDataViewSrvc.getApplyDataViewTemplateResult(data).then((function(devDvObjs){dataViewInfo=_.isEmpty(dataViewInfo)?{dataViewName:data.dvtName,dataViewId:devDvObjs.dataViewGroupId}:dataViewInfo;runbookInfo.runbookNodeName=data.dvtName;runbookInfo.runbookNodeResultId=devDvObjs.alogId;runbookInfo.runbookNodeResultName=devDvObjs.alogName;runbookInfo.lastUpdateTime=new Date;_setMapExtendData(page,dataViewInfo,runbookInfo,dvtInfo);!function(devDvObjs){try{if(devDvObjs&&_.isArray(devDvObjs)&&0===devDvObjs.length)return;var page=mapManagerSrvc.getActivePage();page.getNetmapOperator().getDataViewApplyOp().doApplyDataViewGroup(null,devDvObjs,null,!0);$rootScope.$emit(NetBrain.Map.Event.DataViewChanged);page.refreshMapViewOptionVisible()}catch(err){console.error(err)}}(devDvObjs.deviceDataViews);$rootScope.$emit(NetBrain.Map.Event.DataViewChanged);deferred.resolve(devDvObjs)}),(function(reason){console.warn(reason);deferred.reject(reason)}))}),(function(err){console.error(err);deferred.reject(err)}));return deferred.promise},highLightDeviceDataUnits:function(dvgId,relativeDevices,page,devDvObjs){console.warn("highLightDeviceDataUnits is not use")},clearTemporaryView:function(page){page.getNetmapOperator().resetDefaultDataView(dataViewCacheSrvc,!1)},changeToSwitchMode:function(page){if("switchMode"===(page=page||mapManagerSrvc.getActivePage()).getDisplayMode())return;page.setDisplayMode("switchMode")},getDataViewInfoId:function(dataView){console.warn("getDataViewInfoId not use")},setMapExtendData:_setMapExtendData}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataViewManagerCtrl",DataViewManagerCtrl);DataViewManagerCtrl.$inject=["$scope","$rootScope","$routeParams","$log","$sce","$parse","$location","nb.qmap.mapManagerSrvc","nb.uiframework.urlStateMgr"];function DataViewManagerCtrl($scope,$rootScope,$routeParams,$log,$sce,$parse,$location,mapManagerSrvc,urlStateMgr){var params=urlStateMgr.getUrlParams("dataviewMgr.html#/GlobalDataView?dataViewTreeType={dataViewTreeType}&mapId={mapId}");$scope.dataViewTreeType=params.dataViewTreeType;$scope.mapId=params.mapId;$scope.dataViewTreeType=$scope.dataViewTreeType?$scope.dataViewTreeType:DataViewTreeType.GlobalDataView;var url=NetBrain.NG.Const.PageType.DataViewManager;if($scope.dataViewTreeType===DataViewTreeType.MapDataView){url="dataviewMgr.html#/GlobalDataView?dataViewTreeType="+DataViewTreeType.MapDataView+"&mapId="+$scope.mapId;$scope.title="Map Data View Manager";jQuery(document).attr("title","Map Data View Manager - NetBrain IE")}else{$scope.title="Static Data View Manager";jQuery(document).attr("title","Static Data View Manager - NetBrain IE")}urlStateMgr.setPageSession(url,"DataViewManager",$scope.dataViewTreeType,null);if($scope.mapId){var activeMap=mapManagerSrvc.getActiveMap();var mapName="";if(null!=activeMap){mapName+=" for "+activeMap.getTitle();$scope.title+=mapName}}$scope.gotoInitial=function(){};$scope.UIControl={showCompoundView:!1};$scope.onShowCompoundView=function(){$scope.UIControl.showCompoundView=!$scope.UIControl.showCompoundView};$scope.selectedCompoundView="All Compound Data View";var dataViewCompoundSelected=$rootScope.$on(dataViewManagerEvent.dataViewCompoundSelected,(function(event,compoundObj){if(compoundObj.comp){var groupId=compoundObj.comp.defaultDataViewGroup;$scope.selectedCompoundView="All Compound Data View"!==groupId?compoundObj.comp.name:"All Compound Data View"}}));$scope.$on("$destroy",dataViewCompoundSelected);$scope.refreshRecords=function(){$rootScope.$emit(dataViewManagerEvent.switchToUpdateRecordsTab)}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataViewManagerTreeCtrl",DataViewManagerTreeCtrl);DataViewManagerTreeCtrl.$inject=["$scope","$rootScope","$uibModal","$log","$timeout","nb.dataview.httpDataViewManagerSrvc","nb.common.nbAlertSrvc","nb.dataview.dataViewEditMgr","ivhTreeviewMgr","nb.ng.nbValidationSrvc","$q","nb.admin.domainAdminMgr"];function DataViewManagerTreeCtrl($scope,$rootScope,$uibModal,$log,$timeout,httpDataViewManagerSrvc,nbAlertSrvc,dataViewEditMgr,ivhTreeviewMgr,nbValidationSrvc,$q,domainAdminMgr){$scope.dataViewTreeType=$scope.$parent.dataViewTreeType;$scope.dataViewTreeType||($scope.dataViewTreeType=DataViewTreeType.GlobalDataView);$scope.mapId=$scope.$parent.mapId;$scope.showtree=!0;$scope.afterMovedNode={};$scope.currParentNode=null;$scope.filterOption={filterString:""};$scope.showFilterView=!1;$scope.selectedFilteredItems=[];$scope.selectedCompoundView=null;$scope.thisFolderMgr=new folderMgr;var noPermissionMsg="Sorry, you are not privileged to perform the operation. Please contact your NetBrain administrators.";var domainPermObj=domainAdminMgr.getDomainPermissions();$scope.newFolderNode={name:"Unnamed Folder",nodeType:DataViewNodeType.Folder,editable:!0,child:[]};$scope.dataViewGroups={};$scope.firstChildSet=!1;$scope.editingNode=null;$scope.selectNode=function(node){node&&$rootScope.$emit(dataViewManagerEvent.dataViewGroupSelected,{selectedNode:node,dataViews:$scope.dataViewGroups})};var dvIconHtml=$scope.dataViewTreeType==DataViewTreeType.GlobalDataView?'<div class="action_node_static_dataview_14"></div>':'<div class="action-node-map-dataview-14"></div>';$scope.ivhTreeOptions={defaultSelectedState:!1,validate:!0,expandToDepth:1,labelAttribute:"name",idAttribute:"ID",childrenAttribute:"child",expandedAttribute:"expanded",selectedAttribute:"selected",editableAttribute:"editable",enableMultipleSelect:!1,enableLabelExpand:!1,iconTemplate:function(node,trvw){return node.nodeType<=0?'<div class="icon_nb_folder"></div>':dvIconHtml},nodeClickCallback:$scope.selectNode,enableNodeDropdown:{isDisplay:function(node,trvw){return!($scope.dataViewTreeType===DataViewTreeType.MapDataView&&(node.nodeType===DataViewNodeType.Folder&&!node.parentId||node.dataViewType===DataViewTreeType.ALog&&node.nodeType===DataViewNodeType.Folder))},dropdownItems:function(node,trvw){if(node.nodeType===DataViewNodeType.Folder&&!node.parentId)return $scope.rootFolderActionMenu;if(node.nodeType===DataViewNodeType.Folder&&!node.editable){if("907d6a11-3607-4d1e-a173-f10edf585022"===node.ID){var actions=angular.copy($scope.folderActionMenu);actions.splice(3,1);return actions}return $scope.folderActionMenu}if(node.nodeType===DataViewNodeType.Leaf){var menuItem=node.dataViewType&&node.dataViewType===DataViewTreeType.ALog?$scope.aLogActionMenu:$scope.leafActionMenu;"907d6a11-3607-4d1e-a173-f10edf585022"===node.parentId&&(menuItem=$scope.qappSchedulerLeafActionMenu);return menuItem}}},editableCallback:function(node,trvw,text,event){return $scope.doneEditing(node,text,event)},labelTemplate:function(node){return node&&node.name?node.name.replace(/\s/gi,"&nbsp;"):""},nodeTitle:function(node){return node.name}};$scope.rootFolderActionMenu=[{template:"New Folder",action:function(node,trvw,event){if(!domainPermObj.hasSharedResourceManagementPerm)return nbAlertSrvc.notification({message:noPermissionMsg});$scope.addSubFolder(node)}}];$scope.folderActionMenu=[{template:"New Folder",action:function(node,trvw,event){if(!domainPermObj.hasSharedResourceManagementPerm)return nbAlertSrvc.notification({message:noPermissionMsg});$scope.addSubFolder(node)}},{template:"Rename",action:function(node,trvw,event){if(!domainPermObj.hasSharedResourceManagementPerm)return nbAlertSrvc.notification({message:noPermissionMsg});$scope.renameFolder(node)}},{template:"Move to...",action:function(node,trvw,event){if(!domainPermObj.hasSharedResourceManagementPerm)return nbAlertSrvc.notification({message:noPermissionMsg});$scope.moveDvgAndFolder(node,trvw)}},{template:"Delete",action:function(node,trvw,event){if(!domainPermObj.hasSharedResourceManagementPerm)return nbAlertSrvc.notification({message:noPermissionMsg});$scope.deleteFolder(node)}}];$scope.toggleinPanel=function(node,isHide){var folderId=node.ID;httpDataViewManagerSrvc.setHideInDataviewPanel(folderId,isHide).then((function(data){}))};$scope.qappSchedulerLeafActionMenu=[{template:"Delete",action:function(node,trvw,event){$scope.deleteDataView(node)}}];$scope.leafActionMenu=$scope.dataViewTreeType===DataViewTreeType.GlobalDataView?[{template:"Move to...",action:function(node,trvw,event){if(!domainPermObj.hasSharedResourceManagementPerm)return nbAlertSrvc.notification({message:noPermissionMsg});$scope.moveDvgAndFolder(node,trvw)}},{template:"Delete",action:function(node,trvw,event){if(!domainPermObj.hasSharedResourceManagementPerm)return nbAlertSrvc.notification({message:noPermissionMsg});$scope.deleteDataView(node)}}]:[{template:"Delete",action:function(node,trvw,event){$scope.deleteDataView(node)}}];$scope.aLogActionMenu=[{template:"Delete",action:function(node,trvw,event){if(!domainPermObj.hasSharedResourceManagementPerm)return nbAlertSrvc.notification({message:noPermissionMsg});$scope.deleteDataView(node)}}];$scope.getDataViewRelationTree=function(){httpDataViewManagerSrvc.getDataViewTreeRoot(null,$scope.dataViewTreeType,$scope.mapId).then((function(dataViewTree){$scope.dataViewGroups=dataViewTree;$scope.setDataViews()}))};$scope.setDataViews=function(){$timeout((function(){$scope.selectFirstDataView($scope.dataViewGroups)}),200)};$scope.selectFirstDataView=function(folder){var children=folder.child;var lastFolderChild=folder;if(children&&children.length>0){folder.expanded=!0;var firstChild=$scope.getFirstLeafChild(children);if(null!=firstChild){firstChild.selected=!0;$scope.selectNode(firstChild);$scope.firstChildSet=!0}else{var childNodes=children;for(var i=0;i<childNodes.length;i++){var child=childNodes[i];if(child.nodeType===DataViewNodeType.Folder){lastFolderChild=child;child.expended=!0;$scope.selectFirstDataView(child)}if($scope.firstChildSet)break}}}if(!$scope.firstChildSet&&null!=lastFolderChild){$scope.firstChildSet=!0;$scope.selectNode(lastFolderChild)}};$scope.getFirstFolderChild=function(childNodes){var folderChild=null;for(var i=0;i<childNodes.length;i++){var child=childNodes[i];if(child.nodeType===DataViewNodeType.Folder){folderChild=child;break}}return folderChild};$scope.getFirstLeafChild=function(childNodes){var leafChild=null;for(var i=0;i<childNodes.length;i++){var child=childNodes[i];if(child.nodeType===DataViewNodeType.Leaf){leafChild=child;break}}return leafChild};$scope.initData=function(){$scope.getDataViewRelationTree()};$scope.addSubFolder=function(folder){$scope.currParentNode=folder;resetEditingNode();var newFolder=angular.copy($scope.newFolderNode);folder.child||(folder.child=[]);folder.child.unshift(newFolder);folder.expanded=!0;newFolder.parentId=folder.ID;newFolder.path=folder.path+">"+folder.name;$scope.editingNode={};$scope.editingNode.currentNode=newFolder;$scope.editingNode.oldName=newFolder.name;$scope.editingNode.isNew=!0;$scope.editingNode.parentNode=$scope.currParentNode};$scope.renameFolder=function(node,trvw){$scope.currParentNode=findParent(node.ID);resetEditingNode();$scope.editingNode={};$scope.editingNode.currentNode=node;$scope.editingNode.oldName=node.name;$scope.editingNode.isNew=!1;$scope.editingNode.parentNode=$scope.currParentNode;node.editable=!0;$timeout((function(){$("input.ivh-treeview-node-label.node-label-editable + span.node-dropdown-arrow").addClass("row-menu-no-display")}))};function resetEditingNode(){if(null!==$scope.editingNode){if(!0===$scope.editingNode.isNew){var index=_.findIndex($scope.editingNode.parentNode.child,{editable:!0});index>=0&&$scope.editingNode.parentNode.child.splice(index,1)}else{$scope.editingNode.currentNode.name=$scope.editingNode.oldName;$scope.editingNode.currentNode.editable=!1;$scope.editingNode.currentNode.selected=!1}$scope.editingNode=null;$(document.body).unbind("click.nbTreeDocClickHandler");$("span.row-menu-no-display").removeClass("row-menu-no-display")}}$scope.doneEditing=function(editingFolder,newName){var defer=$q.defer();angular.isUndefined(newName)&&defer.resolve(!1);newName=newName.trim();(function(editingFolder,newName){if(0===newName.length)return showErrorDialog("Please enter a unique folder name.","");if(newName.length>128)return showErrorDialog("A folder name can't exceed 128 characters.","");if(!nbValidationSrvc.getValidator("generalForbidWindowsAndMongoChars")(newName))return nbAlertSrvc.warning({message:"Name cannot contain special characters."});if(angular.isDefined($scope.currParentNode)){var childNodes=$scope.currParentNode.child;if(angular.isDefined(childNodes)&&childNodes.length>0)for(var i=0;i<childNodes.length;i++)if((!editingFolder.ID||editingFolder.ID!==childNodes[i].ID||editingFolder.name!==childNodes[i].name)&&angular.isDefined(childNodes[i].ID)&&0===childNodes[i].nodeType&&childNodes[i].name.toUpperCase()===newName.toUpperCase())return showErrorDialog("A folder with the same name already exists in the folder.","")}var defer=$q.defer();defer.resolve(!0);return defer.promise})(editingFolder,newName).then((function(result){if(!0!==result)defer.resolve(!1);else{editingFolder.name=newName;$("span.row-menu-no-display").removeClass("row-menu-no-display");httpDataViewManagerSrvc.upInsertDataViewTreeNode(null,editingFolder).then((function(resultedFolder){if(2===resultedFolder.nodeStatus&&resultedFolder.ID!==editingFolder.ID)showErrorDialog("A folder with the same name already exists in the folder.","").then((function(){defer.resolve(!1)}));else if(angular.isUndefined(editingFolder.ID)){editingFolder.editable=!1;editingFolder.selected=!0;var newChildList=_.reject($scope.currParentNode.child,(function(node){return angular.isUndefined(node.ID)}));newChildList.unshift(resultedFolder);$scope.currParentNode.child=newChildList;ivhTreeviewMgr.deselectAll($scope.dataViewGroups,$scope.ivhTreeOptions);ivhTreeviewMgr.validate($scope.dataViewGroups,$scope.ivhTreeOptions);$scope.currParentNode.child[0].selected=!0;$scope.editingNode=null;defer.resolve(!0)}else{editingFolder.editable=!1;editingFolder.selected=!0;$scope.editingNode=null;!function(newNode){if(angular.isUndefined(newNode))return;httpDataViewManagerSrvc.getDataViewTreeNodeWithChildren(null,$scope.dataViewTreeType,$scope.mapId,newNode.parentId).then((function(resultNode){if(angular.isDefined(resultNode)&&angular.isDefined(resultNode.child)){var newNodeParent=findParent(newNode.ID);if(null!=newNodeParent){newNodeParent.child=resultNode.child;newNodeParent.childNumber=resultNode.childNumber;ivhTreeviewMgr.deselectAll($scope.dataViewGroups,$scope.ivhTreeOptions);ivhTreeviewMgr.validate($scope.dataViewGroups,$scope.ivhTreeOptions);_.find(newNodeParent.child,(function(child){return child.ID===newNode.ID})).selected=!0}}}),(function(reason){showErrorDialog("Failed to get updated tree node",reason);$log.debug(reason)}))}(resultedFolder);defer.resolve(!0)}}),(function(reason){resetEditingNode();showErrorDialog("Failed to update tree Node",reason);defer.reject(!1);$log.debug(reason)}))}}));return defer.promise};function refreshDataViewTreeAfterDelete(node,isDeleteDataView){var parentNode=findParent(node.ID);if(parentNode){var children=parentNode.child;if(angular.isDefined(children)){for(var i=0;i<children.length;i++)if(node.ID===children[i].ID){children.splice(i,1);break}parentNode.childNumber=children.length}isDeleteDataView&&$timeout((function(){$scope.selectFirstDataView($scope.dataViewGroups)}),200)}}function findParent(nodeId){if(nodeId){var parentNode=null;!function myself(nodeId,traverseNode){if(nodeId===traverseNode.ID)return!0;angular.forEach(traverseNode.child,(function(child){!0===myself(nodeId,child)&&(parentNode=traverseNode);return!1}))}(nodeId,$scope.dataViewGroups);return parentNode}}$scope.deleteFolder=function(folder){resetEditingNode();var folderId=folder.ID;var dialogOptions={message:"Deleting a folder will delete all sub folders and included data views, which is irreversible. Do you want to delete this folder anyway?"};0===folder.childNumber&&(dialogOptions.message="Do you want to delete this folder?");nbAlertSrvc.confirm(dialogOptions).then((function(){httpDataViewManagerSrvc.deleteDataViewTreeNodes(null,[folderId]).then((function(){refreshDataViewTreeAfterDelete(folder,!1)}))}))};$scope.deleteDataView=function(dataView){resetEditingNode();var dataViewId=dataView.ID;$scope.showFilterView&&(dataViewId=dataView);var dialogOptions={title:"Warning",iconType:NB_ICON_WARNING,message:"Are you sure you want to delete the Data View?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){dataView.dataViewType===DataViewTreeType.ALog?httpDataViewManagerSrvc.deleteDataViewGroupsInALog(null,[dataViewId]).then((function(){$scope.showFilterView?$scope.getFilteredDataViews():$scope.getDataViewRelationTree();ivhTreeviewMgr.validate($scope.dataViewGroups,$scope.ivhTreeOptions)})):httpDataViewManagerSrvc.deleteDataViewTreeNodes(null,[dataViewId]).then((function(){if($scope.showFilterView){for(var i=0;i<$scope.filteredDataViews.length;i++)if($scope.filteredDataViews[i].ID===dataViewId){$scope.filteredDataViews.splice(i,1);break}}else refreshDataViewTreeAfterDelete(dataView,!0)}))}))};$scope.setSingleNode=function(node,moveNodeId,data){for(var i=0;i<data.child.length;i++){if(node.ID===data.child[i].ID){data.child[i].selected=!1;for(var j=0;j<data.child[i].child.length;j++)data.child[i].child[j].ID===moveNodeId?data.child[i].child[j].selected=!0:data.child[i].child[j].selected=!1;break}data.child[i].child&&$scope.setSingleNode(node,moveNodeId,data.child[i])}return data};$scope.moveDvgAndFolder=function(moveNode){resetEditingNode();var origNode=angular.copy(moveNode);var dialogOption={showMenu:!0,dataViewTree:$scope.dataViewGroups,beingMovedNode:moveNode};$uibModal.open({templateUrl:"modules/nbDataView/views/nbDataViewTreeModal.html",controller:"nb.dataview.nbDataViewTreeModalCtrl",windowClass:"dataViewTreeModalDialog",backdrop:"static",resolve:{dialogOption:dialogOption}}).result.then((function(result){if(!angular.isUndefined(result)){angular.isDefined(result.dataViewTree)&&($scope.dataViewGroups=result.dataViewTree);var moveToFolder=result.selectedDataViewFolder;var moveToFolderId=moveToFolder.ID;httpDataViewManagerSrvc.getDataViewTreeChildNodeByName(null,moveToFolderId,moveNode.name,moveNode.nodeType).then((function(node){node&&null!=node&&nbAlertSrvc.warning("A data view with duplicate name already exists in this folder.").then((function(result){}))}),(function(){httpDataViewManagerSrvc.moveDataViewTreeNode(null,moveToFolderId,moveNode.ID).then((function(){refreshDataViewTreeAfterDelete(origNode,!1);httpDataViewManagerSrvc.getDataViewTreeNodeWithChildren(null,$scope.dataViewTreeType,$scope.mapId,moveToFolderId).then((function(newNode){if(angular.isDefined(newNode)&&angular.isDefined(newNode.child)){moveToFolder.child=newNode.child;for(var i=0;i<moveToFolder.child.length;i++)if(moveNode.ID===moveToFolder.child[i].ID){$scope.afterMovedNode=moveToFolder.child[i];break}moveToFolder.childNumber=newNode.childNumber}$scope.setSingleNode(moveToFolder,moveNode.ID,$scope.dataViewGroups);$timeout((function(){$timeout((function(){ivhTreeviewMgr.expandTo($scope.dataViewGroups,$scope.afterMovedNode.ID,$scope.ivhTreeOptions)}),5)}),5)}))}),(function(reason){reason&&100005===reason.ResultCode?showErrorDialog("The data view or folder does not exist, which might have been deleted by someone."):showErrorDialog("Move action failed",reason)}))}))}}),(function(reason){$log.debug(reason)}))};function showErrorDialog(message,detail){return nbAlertSrvc.error(message)}$scope.deleteALogFolder=function(folderId){nbAlertSrvc.confirm({message:"Do you want to delete this folder?"}).then((function(){var childIds=$scope.thisFolderMgr.getChildNodeIds(folderId);childIds&&childIds.length>0&&httpDataViewManagerSrvc.deleteDataViewGroupsInALog(null,childIds).then((function(){$scope.setSelectedNodeAfterDelete(folderId)}))}))};$scope.setSelectedNodeAfterDelete=function(nodeId,newSelectNode){var parentNode=$scope.thisFolderMgr.getTreeParentNode(nodeId);$scope.thisFolderMgr.deleteBrowseNode(nodeId);$scope.thisFolderMgr.setSelectNodeListForTree(parentNode);newSelectNode?$scope.selectNode(newSelectNode):$scope.selectNode(parentNode);parentNode.childNumber>0&&parentNode.childNumber--};$scope.startFilter=function(event){if(38===event.which||40===event.which||13===event.which){event.preventDefault();($scope.filterOption.filterString||$scope.filterOption.filterString.length>0)&&$scope.getFilteredDataViews()}};$scope.getFilteredDataViews=function(){httpDataViewManagerSrvc.filterDataViewTreeLeaves(null,$scope.mapId,$scope.filterOption.filterString).then((function(filteredDataViews){$scope.showFilterView=!0;$scope.filteredDataViews=filteredDataViews;if($scope.filteredDataViews.length>0){var firstDataView=$scope.filteredDataViews[0];firstDataView.isActive=!0;$scope.selectNode(firstDataView)}}),(function(reason){$log.debug(reason)}))};var dataViewCompoundSelected=$rootScope.$on(dataViewManagerEvent.dataViewCompoundSelected,(function(event,compoundObj){if(compoundObj.comp){var groupId=compoundObj.comp.defaultDataViewGroup;if("All Compound Data View"!==groupId){$scope.showFilterView=!0;$scope.filteredDataViews=compoundObj.currentDataviewGroupList.sort(dataViewEditMgr.compareDataViewName);angular.forEach($scope.filteredDataViews,(function(filteredDV){filteredDV.ID===groupId?filteredDV.isDefault=!0:filteredDV.isDefault=!1}));if($scope.filteredDataViews.length>0){var firstDataView=$scope.filteredDataViews[0];firstDataView.isActive=!0;$scope.selectNode(firstDataView)}$scope.selectedCompoundView=compoundObj}else{$scope.showFilterView=!1;$scope.selectedCompoundView=null;$timeout((function(){$scope.selectFirstDataView($scope.dataViewGroups)}),200)}}}));$scope.$on("$destroy",dataViewCompoundSelected);var filterWatcher=$scope.$watch("filterOption.filterString",(function(val,oldVal){if((void 0===val||0===val.length)&&oldVal&&oldVal.length>=0)if(null!==$scope.selectedCompoundView){$scope.showFilterView=!0;$scope.filteredDataViews=$scope.selectedCompoundView.currentDataviewGroupList}else{$scope.showFilterView=!1;$scope.getDataViewRelationTree()}}));var filterSelectionWatcher=$scope.$watch("selectedFilteredItems",(function(val,oldVal){if(void 0!==val&&val.length>0){var node=val[0];$scope.selectNode(node)}}));$scope.$on("$destroy",(function(){filterWatcher();filterSelectionWatcher()}));var AllCompoundSelected=$rootScope.$on(dataViewManagerEvent.dataViewCompoundSelected,(function(event,compoundObj){compoundObj.comp&&"All Compound Data View"===compoundObj.comp.defaultDataViewGroup&&$scope.getDataViewRelationTree()}));$scope.$on("$destroy",AllCompoundSelected);var systemEventChangedDomain=$rootScope.$on(systemEvent.changedDomain,(function(event,selectedTenant,lsSelectedDomains){$scope.initData()}));$scope.$on("$destroy",(function(){systemEventChangedDomain()}));$scope.initData()}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataViewDefinitionModalCtrl",DataViewDefinitionModalCtrl);DataViewDefinitionModalCtrl.$inject=["$scope","$uibModal","$uibModalInstance","$timeout","nb.netbrain.httpDataViewTmplSrvc","nb.ng.userSrvc","isShared"];function DataViewDefinitionModalCtrl($scope,$uibModal,$uibModalInstance,$timeout,httpDataViewTmplSrvc,userSrvc,isShared){$scope.dataViewDefinition=new DataViewDefinition;$scope.title="Data View Definition";$scope.sharedDataHint="Shared Data Views are visible to everyone in the tenant and can be modified by anyone with Editor access";$scope.ok_button="Save";$scope.cancel_button="Cancel";$scope.isShared=isShared;$scope.isAutoRefresh=!1;$scope.dataviewFilterText="";$scope.appliedSelectionIndex=-1;$scope.showHint=!1;$scope.availableTemplates=[];$scope.dataViewDefinition.setIsPrivate($scope.isShared?0:1);$scope.isShared||$scope.dataViewDefinition.addUserId(userSrvc.getUserID());$scope.testTemplates=[{ID:"4659eb3e-eadb-6400-acae-ee7d9ccd1190",name:"BGP Design",IsAllDevice:1,DeviceGroupIds:["db8b94ff-36d0-4091-8de0-6543f6dd094f"],SiteIds:["83450e7a-8865-4274-ab08-2f85fc8d3f5e"]},{ID:"4659eb3e-eadb-6400-acae-ee7d9ccd1191",name:"EIGRP Design",IsAllDevice:1,DeviceGroupIds:["db8b94ff-36d0-4091-8de0-6543f6dd094f"],SiteIds:["83450e7a-8865-4274-ab08-2f85fc8d3f5e"]},{ID:"4659eb3e-eadb-6400-acae-ee7d9ccd1192",name:"OSPF Design",IsAllDevice:1,DeviceGroupIds:["db8b94ff-36d0-4091-8de0-6543f6dd094f"],SiteIds:["83450e7a-8865-4274-ab08-2f85fc8d3f5e"]}];httpDataViewTmplSrvc.getAllDataViewTemplates(null).then((function(dataViewTmpl){$scope.availableTemplates=dataViewTmpl;$scope.filteredTemplateList=$scope.availableTemplates}));$scope.appliedTemplateList=[];$scope.setAutoRefresh=function(){var autoRefresh=$scope.isAutoRefresh?1:0;$scope.dataViewDefinition.setIsAutoRefresh(autoRefresh)};$scope.closeDialog=function(){$uibModalInstance.dismiss("cancel")};$scope.performOk=function(){var templates=[];angular.forEach($scope.appliedTemplateList,(function(template,key){var template1={TemplateId:template.ID,IsAllDevice:1,DeviceGroupIds:[],SiteIds:[]};templates.push(template1)}));$scope.dataViewDefinition.addTemplates(templates);$uibModalInstance.close($scope.dataViewDefinition.data)};$scope.onAddTemplate=function(){var delIndexArray=[];for(var index=0;index<$scope.uiFilteredTemplateList.length;index++){var item=$scope.uiFilteredTemplateList[index];if(null!=item&&item.selected){item.selected=!1;delIndexArray.push(index);$scope.appliedTemplateList=$scope.appliedTemplateList.concat(item)}}for(var index2=0;index2<$scope.appliedTemplateList.length;index2++){var item2=$scope.appliedTemplateList[index2];null!=item2&&(item2.selected&&(item2.selected=!1))}for(var index3=delIndexArray.length-1;index3>=0;index3--){var delIndex=delIndexArray[index3];$scope.deleteTemplateFromList($scope.filteredTemplateList,$scope.uiFilteredTemplateList[delIndex]);$scope.uiFilteredTemplateList.splice(delIndex,1);$scope.clearTemplateListSelect($scope.filteredTemplateList)}$scope.appliedSelectionIndex=-1};$scope.onDeleteTemplate=function(){var delIndexArray=[];for(var indexApp=0;indexApp<$scope.appliedTemplateList.length;indexApp++){var item=$scope.appliedTemplateList[indexApp];if(null!=item&&item.selected){item.selected=!1;delIndexArray.push(indexApp);for(var index=0;index<$scope.filteredTemplateList.length;index++)$scope.filteredTemplateList[index];$scope.filteredTemplateList=$scope.filteredTemplateList.concat(item)}}for(var indexDelArray=delIndexArray.length-1;indexDelArray>=0;indexDelArray--){var delIndex=delIndexArray[indexDelArray];$scope.appliedTemplateList.splice(delIndex,1)}$scope.appliedSelectionIndex=-1};$scope.onSelectedTemplate=function(template,event){null!=event&&event.stopPropagation();template.selected=!template.selected};$scope.onSelectedAppliedTemplate=function(template,event){null!=event&&event.stopPropagation();template.selected=!template.selected;$scope.appliedSelectionIndex=function(){var selIndex=-1;var templateList=[];for(var i=0;i<$scope.appliedTemplateList.length;i++){var template=$scope.appliedTemplateList[i];if(template.selected){selIndex=i;templateList.push(template)}}return 1==templateList.length?selIndex:-1}()};$scope.clearTemplateListSelect=function(templateList){for(var index=0;index<templateList.length;index++){var itemTmp=templateList[index];null!=itemTmp&&(itemTmp.selected=!1)}};$scope.deleteTemplateFromList=function(templateList,template){for(var index=0;index<templateList.length;index++){var itemTmp=templateList[index];if(null!=itemTmp&&itemTmp.ID===template.ID){templateList.splice(index,1);break}}};$scope.dragStart=function(scope,event){console.log("moving from  "+scope.$index);$scope.dragIndex=scope.$index};$scope.dropItem=function(scope,event){console.log("moving to, "+scope.$index);$scope.dropIndex=scope.$index;$scope.dropIndex!==$scope.dragIndex&&($scope.dragIndex>$scope.dropIndex?function(){var resultList=[];var tempList=angular.copy($scope.appliedTemplateList);tempList.splice($scope.dragIndex,1);for(var i=0;i<$scope.dropIndex;i++)resultList.push($scope.appliedTemplateList[i]);resultList.push($scope.appliedTemplateList[$scope.dragIndex]);for(var j=$scope.dropIndex;j<tempList.length;j++)resultList.push(tempList[j]);$scope.appliedTemplateList=[];$timeout((function(){$scope.appliedTemplateList=resultList}))}():function(){var resultList=[];for(var i=0;i<$scope.dragIndex;i++)resultList.push($scope.appliedTemplateList[i]);for(var j=$scope.dragIndex+1;j<=$scope.dropIndex;j++)resultList.push($scope.appliedTemplateList[j]);resultList.push($scope.appliedTemplateList[$scope.dragIndex]);for(var k=$scope.dropIndex+1;k<$scope.appliedTemplateList.length;k++)resultList.push($scope.appliedTemplateList[k]);$scope.appliedTemplateList=[];$timeout((function(){$scope.appliedTemplateList=resultList}))}())}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataViewDefinitionCtrl",DataViewDefinitionCtrl);DataViewDefinitionCtrl.$inject=["$scope","$rootScope","$uibModal","$routeParams","$log","$sce","$parse","$timeout","$filter","uiGridConstants","nb.netbrain.dataViewCacheSrvc","nb.dataview.httpDataViewManagerSrvc","nb.ng.utilitySrvc","nb.ng.callbackSrvc","nb.common.nbAlertSrvc","nb.admin.domainAdminMgr"];function DataViewDefinitionCtrl($scope,$rootScope,$uibModal,$routeParams,$log,$sce,$parse,$timeout,$filter,uiGridConstants,dataViewCacheSrvc,httpDataViewManagerSrvc,utilitySrvc,callbackSrvc,nbAlertSrvc,domainAdminMgr){$scope.edit={groupDesc:!1};$scope.globalButton={clearIcon:!1,unlockIcon:!1};$scope.filterText="";$scope.UIControl={noSelection:!1,text:"Select a Data View to see its definition and make modifications as desired."};var domainPermObj=domainAdminMgr.getDomainPermissions();var noPermissionMsg="Sorry, you are not privileged to perform the operation. Please contact your NetBrain administrators.";$scope.selectAll=!1;$scope.rightClickContextMenu=function(rows,grid,event){var contextMenu=[];for(var i=0;i<rows.length;i++)if(rows[i].isCustomize){var clearMenuItem={template:"Delete Position Data",action:function(rows,grid,event){$scope.onClearDeviceProperty()}};contextMenu.push(clearMenuItem);break}for(var m=0;m<rows.length;m++)if(rows[m].isLock){var unlockMenuItem={template:"Unlock Positions",action:function(rows,grid,event){$scope.onUnlockDeviceProperty()}};contextMenu.push(unlockMenuItem);break}var deleteMenuItem={template:rows.length>1?"Delete Rows":"Delete Row",action:function(rows,grid,event){$scope.onDeleteDevices()}};contextMenu.push(deleteMenuItem);return contextMenu};$scope.filterOptions={filterTarget:""};$scope.startFilter=function(event){if(38===event.which||40===event.which||13===event.which){event.preventDefault();$scope.filterText=$scope.filterOptions.filterTarget||"";$scope.initPaging();$scope.maxDeviceCount=$scope.PAGE_SIZE*$scope.pageNumber;$scope.lazyLoading();$scope.selectAll=!1}};$scope.stopFilter=function(){if(""===$scope.filterOptions.filterTarget){$scope.filterText="";$scope.initPaging();$scope.lazyLoading();$scope.selectAll=!1}};$scope.initPaging=function(){$scope.pageNumber=1;$scope.gridOptions.data=[]};$scope.sortField="";$scope.sortOrder="";$scope.listDeviceCategory=[{text:"All Devices"},{text:"Only Devices with Overwrites"},{text:"Only Devices with Defaults"}];$scope.selectedDeviceCategory=$scope.listDeviceCategory[0];$scope.selectShowDeviceCategory=function(category){$scope.selectedDeviceCategory=category;$scope.showCategory=category.text;$scope.filterOptions.filterTarget="";$scope.filterText="";$scope.gridApi&&$scope.gridApi.grid&&$scope.gridApi.grid.refresh()};$scope.typeFilterDevice=function(renderableRows){renderableRows.forEach((function(row){"All Devices"===$scope.showCategory||("Only Devices with Overwrites"===$scope.showCategory?!0===row.entity.prop1.isCustomize||!0===row.entity.prop2.isCustomize||!0===row.entity.prop3.isCustomize||!0===row.entity.prop4.isCustomize:"Only Devices with Defaults"!==$scope.showCategory||!1===row.entity.prop1.isCustomize&&!1===row.entity.prop2.isCustomize&&!1===row.entity.prop3.isCustomize&&!1===row.entity.prop4.isCustomize)||(row.visible=!1)}));return renderableRows};$scope.renderHtml=function(html_code){return $sce.trustAsHtml(html_code)};$scope.gridCellTemplateWithFilter='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div>';$scope.gridCellTemplateInterfaceLink='<div class="ui-grid-cell-contents" style="cursor: pointer; text-decoration: underline;" ng-if="!row.entity.noPrivilege" ng-click="grid.appScope.getMoreInterfacePopup(row); $event.stopPropagation();" ng-bind-html="COL_FIELD || 0" title="{{COL_FIELD}}"></div><div class="ui-grid-cell-contents noPrivilege" style="cursor: pointer;" ng-if="row.entity.noPrivilege && COL_FIELD>0" title="===No Privilege===">===No Privilege===</div>';$scope.gridCellTemplateProp1='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop1.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop1.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop1.isCustomize || true==row.entity.prop1.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop1.isCustomize" ng-click="grid.appScope.onClearCellDeviceProperty(row.entity, 0); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop1.isLock" ng-click="grid.appScope.onUnlockCellDeviceProperty(row.entity, 0); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp2='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop2.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop2.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop2.isCustomize || true==row.entity.prop2.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop2.isCustomize" ng-click="grid.appScope.onClearCellDeviceProperty(row.entity, 1); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop2.isLock" ng-click="grid.appScope.onUnlockCellDeviceProperty(row.entity, 1); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp3='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop3.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop3.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop3.isCustomize || true==row.entity.prop3.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop3.isCustomize" ng-click="grid.appScope.onClearCellDeviceProperty(row.entity, 2); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop3.isLock" ng-click="grid.appScope.onUnlockCellDeviceProperty(row.entity, 2); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp4='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop4.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop4.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop4.isCustomize || true==row.entity.prop4.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop4.isCustomize" ng-click="grid.appScope.onClearCellDeviceProperty(row.entity, 3); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop4.isLock" ng-click="grid.appScope.onUnlockCellDeviceProperty(row.entity, 3); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateVal1='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.val1.isCustomize,noPrivilege: row.entity.noPrivilege}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.val1.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.val1.isCustomize || true==row.entity.val1.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.val1.isCustomize" ng-click="grid.appScope.onClearCellDeviceProperty(row.entity, 0); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.val1.isLock" ng-click="grid.appScope.onUnlockCellDeviceProperty(row.entity, 0); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateVal2='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.val2.isCustomize,noPrivilege: row.entity.noPrivilege}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.val2.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.val2.isCustomize || true==row.entity.val2.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.val2.isCustomize" ng-click="grid.appScope.onClearCellDeviceProperty(row.entity, 1); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.val2.isLock" ng-click="grid.appScope.onUnlockCellDeviceProperty(row.entity, 1); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateVal3='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.val3.isCustomize,noPrivilege: row.entity.noPrivilege}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.val3.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.val3.isCustomize || true==row.entity.val3.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.val3.isCustomize" ng-click="grid.appScope.onClearCellDeviceProperty(row.entity, 2); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.val3.isLock" ng-click="grid.appScope.onUnlockCellDeviceProperty(row.entity, 2); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateVal4='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.val4.isCustomize,noPrivilege: row.entity.noPrivilege}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.val4.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.val4.isCustomize || true==row.entity.val4.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.val4.isCustomize" ng-click="grid.appScope.onClearCellDeviceProperty(row.entity, 3); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.val4.isLock" ng-click="grid.appScope.onUnlockCellDeviceProperty(row.entity, 3); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateOverflowLink='<div class="ui-grid-cell-contents" style="cursor: pointer; text-decoration: underline;" ng-show="row.entity.showOverflowLink&&!row.entity.noPrivilege;" ng-click="grid.appScope.getMoreProptyPopup(row); $event.stopPropagation();" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget"></div><div class="ui-grid-cell-contents noPrivilege" style="cursor: pointer;" ng-if="row.entity.showOverflowLink&&row.entity.noPrivilege" title="===No Privilege===">===No Privilege===</div>';$scope.devValuePropertySelect=!0;$scope.switchPropValue=function(value){$scope.devValuePropertySelect=value;if(!0===$scope.devValuePropertySelect){$scope.gridOptions.data=$filter("selectedColumnsFilter")($scope.gridOptions.data,["hostName","val1.text","val2.text","val3.text","val4.text"],$scope.filterOptions.filterTarget);$scope.columnDefsWithReset[2].visible=!1;$scope.columnDefsWithReset[3].visible=!1;$scope.columnDefsWithReset[4].visible=!1;$scope.columnDefsWithReset[5].visible=!1;$scope.columnDefsWithReset[6].visible=!0;$scope.columnDefsWithReset[7].visible=!0;$scope.columnDefsWithReset[8].visible=!0;$scope.columnDefsWithReset[9].visible=!0}else{$scope.gridOptions.data=$filter("selectedColumnsFilter")($scope.gridOptions.data,["hostName","prop1.text","prop2.text","prop3.text","prop4.text"],$scope.filterOptions.filterTarget);$scope.columnDefsWithReset[2].visible=!0;$scope.columnDefsWithReset[3].visible=!0;$scope.columnDefsWithReset[4].visible=!0;$scope.columnDefsWithReset[5].visible=!0;$scope.columnDefsWithReset[6].visible=!1;$scope.columnDefsWithReset[7].visible=!1;$scope.columnDefsWithReset[8].visible=!1;$scope.columnDefsWithReset[9].visible=!1}$scope.showCategory=$scope.selectedDeviceCategory.text;if($scope.gridApi&&$scope.gridApi.grid){$scope.gridApi.grid.refresh();$scope.gridApi.grid.scrollToIfNecessary(0,0)}};$scope.gridOptions={enableColumnMenus:!1,enableColumnResizing:!0,multiSelect:!0,enableFullRowSelection:!0,modifierKeysToMultiSelect:!0,enableRowSelection:!0,enableSelectAll:!1,enableRowHeaderSelection:!1,enableGridMenu:!1,enableFiltering:!1,enableRowContextMenu:!0,rowContextMenuItems:function(rows,grid,event){return $scope.rightClickContextMenu(rows,grid,event)},rowTemplate:'<div class="dropdown primary-icon actionDropdown" uib-dropdown><img src="img/Assets/icon_nb_map_menu.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu dropdownPos"><li ng-if="true==row.entity.isCustomize" ng-click="grid.appScope.onClearRowDeviceProperty(row.entity); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.isLock" ng-click="grid.appScope.onUnlockRowDeviceProperty(row.entity); $event.stopPropagation();"><a>Unlock Positions</a></li><li ng-click="grid.appScope.onDeleteOneDevice(row.entity); $event.stopPropagation();"><a>Delete Row</a></li></ul></div><div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell></div>'};$scope.gridOptions.onRegisterApi=function(gridApi){$scope.gridApi=gridApi;$scope.switchPropValue(!0);$scope.gridApi.grid.registerRowsProcessor($scope.typeFilterDevice,300);$scope.gridApi.infiniteScroll.on.needLoadMoreData($scope,$scope.lazyLoading);$scope.gridApi.core.on.sortChanged($scope,(function(grid,sortColumns){if(0===sortColumns.length);else{$scope.sortField=sortColumns[0].field;$scope.sortOrder=sortColumns[0].sort.direction;$scope.initPaging();$scope.lazyLoading()}}));$scope.gridApi.selection.on.rowSelectionChanged($scope,(function(row){$scope.gridApi.selection.getSelectedRows().length===$scope.gridOptions.data.length?$scope.selectAll=!0:$scope.selectAll=!1}));$scope.gridApi.selection.on.rowSelectionChangedBatch($scope,(function(rows){$scope.gridApi.selection.getSelectedRows().length===$scope.gridOptions.data.length?$scope.selectAll=!0:$scope.selectAll=!1}))};$scope.columnDefsWithReset=[{field:"hostName",displayName:"Hostname",cellTemplate:$scope.gridCellTemplateWithFilter,width:"15%"},{field:"infs",displayName:"Interfaces",cellTemplate:$scope.gridCellTemplateInterfaceLink,enableSorting:!1,width:"10%",type:"number"},{field:"prop1.text",displayName:"Position 1",cellTemplate:$scope.gridCellTemplateProp1,enableSorting:!1,width:"15%"},{field:"prop2.text",displayName:"Position 2",cellTemplate:$scope.gridCellTemplateProp2,enableSorting:!1,width:"15%"},{field:"prop3.text",displayName:"Position 3",cellTemplate:$scope.gridCellTemplateProp3,enableSorting:!1,width:"15%"},{field:"prop4.text",displayName:"Position 4",cellTemplate:$scope.gridCellTemplateProp4,enableSorting:!1,width:"15%"},{field:"val1.text",displayName:"Position 1",cellTemplate:$scope.gridCellTemplateVal1,enableSorting:!1,width:"15%"},{field:"val2.text",displayName:"Position 2",cellTemplate:$scope.gridCellTemplateVal2,enableSorting:!1,width:"15%"},{field:"val3.text",displayName:"Position 3",cellTemplate:$scope.gridCellTemplateVal3,enableSorting:!1,width:"15%"},{field:"val4.text",displayName:"Position 4",cellTemplate:$scope.gridCellTemplateVal4,enableSorting:!1,width:"15%"},{field:"more",displayName:"Overflow Data",cellTemplate:$scope.gridCellTemplateOverflowLink,enableSorting:!1,width:"15%"}];$scope.gridOptions.columnDefs=$scope.columnDefsWithReset;function getValueForCompoundVar(dataUnit){var val={"-1":"NoValue",0:"Normal",1:"Warning",2:"Error"}[dataUnit.value]||"";return dataUnit.prefix?dataUnit.prefix+val:val}$scope.loadOneDeviceDataView=function(deviceObj){var newDeviceObj={ID:deviceObj.ID,hostName:deviceObj.hostName?deviceObj.hostName:"",infs:deviceObj.dataViewData.intfCount+""||"",devPosList:deviceObj.dataViewData.devPosList?deviceObj.dataViewData.devPosList:[],intfInfoList:deviceObj.dataViewData.intfInfoList?deviceObj.dataViewData.intfInfoList:[],isCustomize:!1,isLock:!1,more:"More",overflow:deviceObj.overflow,showOverflowLink:!1,noPrivilege:deviceObj.noPrivilege};for(var i=0;i<4;i++){newDeviceObj["prop"+(i+1)]={text:"",isCustomize:!1,isLock:!1};newDeviceObj["val"+(i+1)]={text:"",isCustomize:!1,isLock:!1};if(null!=deviceObj.dataViewData&&null!=deviceObj.dataViewData.devPosList){for(var j=0;j<deviceObj.dataViewData.devPosList.length;j++)if(deviceObj.dataViewData.devPosList[j].posName===DataViewPosName["devPos"+(i+1)]){newDeviceObj["devPos"+(i+1)]=DataViewPosName["devPos"+(i+1)];try{var val="";if(deviceObj.dataViewData.devPosList[j].posInfo.dataUnitList[0]&&deviceObj.dataViewData.devPosList[j].posInfo.dataUnitList[0].displayName){val=(val=(val=deviceObj.dataViewData.devPosList[j].posInfo.dataUnitList[0].displayName).replace(/\(string\)$/gi,"")).replace(/\(int\)$/gi,"")}newDeviceObj["prop"+(i+1)].text=val}catch(err){}try{if(!0===deviceObj.dataViewData.devPosList[j].posInfo.isCustomize){newDeviceObj["prop"+(i+1)].isCustomize=!0;newDeviceObj.isCustomize=!0}else newDeviceObj["prop"+(i+1)].isCustomize=!1}catch(err){}try{if(deviceObj.dataViewData.devPosList[j].posInfo.isLock){newDeviceObj["prop"+(i+1)].isLock=!0;newDeviceObj.isLock=!0}else newDeviceObj["prop"+(i+1)].isLock=!1}catch(err){}try{var dataUnit=deviceObj.dataViewData.devPosList[j].posInfo.dataUnitList[0];"uSrcQapp"===dataUnit.type&&"uCompoundVar"===dataUnit.valueType?newDeviceObj["val"+(i+1)].text=getValueForCompoundVar(dataUnit):newDeviceObj["val"+(i+1)].text=deviceObj.dataViewData.devPosList[j].posInfo.displayInfo?deviceObj.dataViewData.devPosList[j].posInfo.displayInfo:""}catch(err){}try{newDeviceObj["val"+(i+1)].isCustomize=!!deviceObj.dataViewData.devPosList[j].posInfo.isCustomize&&deviceObj.dataViewData.devPosList[j].posInfo.isCustomize}catch(err){}try{newDeviceObj["val"+(i+1)].isLock=!!deviceObj.dataViewData.devPosList[j].posInfo.isLock&&deviceObj.dataViewData.devPosList[j].posInfo.isLock}catch(err){}}for(var j2=0;j2<deviceObj.dataViewData.devPosList.length;j2++)if(deviceObj.dataViewData.devPosList[j2].posName===DataViewPosName.overflowPos)try{newDeviceObj.overflow=!!deviceObj.dataViewData.devPosList[j2].extraData.overflowList&&deviceObj.dataViewData.devPosList[j2].extraData.overflowList;newDeviceObj.showOverflowLink=$scope.showOverflowLink(deviceObj.dataViewData.devPosList[j2].extraData.overflowList,deviceObj.dataViewData.dataViewInfo.dataViewType)}catch(err){}}}if(null!=$scope.globalButton){newDeviceObj.isCustomize?$scope.globalButton.clearIcon=!0:$scope.globalButton.clearIcon=!1;newDeviceObj.isLock?$scope.globalButton.unlockIcon=!0:$scope.globalButton.unlockIcon=!1}return newDeviceObj};$scope.PAGE_SIZE=30;$scope.lazyLoading=function(getDataViewGroup){httpDataViewManagerSrvc.getDeviceDataViewsInPage(null,$scope.selectedNode.ID,$scope.PAGE_SIZE,$scope.pageNumber,["hostName","devPos"],$scope.filterText,$scope.devValuePropertySelect,$scope.sortField,$scope.sortOrder,getDataViewGroup).then((function(deviceObjs){if(getDataViewGroup&&deviceObjs.dataViewGroup){_.isBoolean(deviceObjs.dataViewGroup.hideInDataviewPanel)||(deviceObjs.dataViewGroup.hideInDataviewPanel=!1);$scope.dataviewGroup=deviceObjs.dataViewGroup;$scope.dataviewGroup.showInDataviewPanel=!$scope.dataviewGroup.hideInDataviewPanel;var newUpdateDateTime=new Date($scope.dataviewGroup.lastUpdateTime);$scope.lastUpdateTime=utilitySrvc.formatDateTime(newUpdateDateTime)}deviceObjs&&($scope.deviceDataViewCount=deviceObjs.total);if(deviceObjs&&deviceObjs.deviceList&&deviceObjs.deviceList.length>0){angular.forEach(deviceObjs.deviceList,(function(deviceObj){_.findIndex(this,(function(d){return d.ID===deviceObj.ID}))>=0||this.push($scope.loadOneDeviceDataView(deviceObj))}),$scope.gridOptions.data);if(0!==$scope.gridOptions.data.length){$scope.gridApi.infiniteScroll.saveScrollPercentage();$scope.gridApi.infiniteScroll.dataLoaded(!1,deviceObjs.deviceList.length===$scope.PAGE_SIZE)}$scope.gridApi.core.notifyDataChange(uiGridConstants.dataChange.ALL)}}),(function(reason){$scope.gridApi.infiniteScroll.dataLoaded()})).then((function(){$scope.pageNumber++}))};$scope.changeShowInDataviewPanel=function(){$scope.dataviewGroup.hideInDataviewPanel=!$scope.dataviewGroup.showInDataviewPanel};var onSelectNode=$rootScope.$on(dataViewManagerEvent.dataViewGroupSelected,(function(event,dataviewInfo){$scope.selectAll=!1;$scope.edit={groupDesc:!1};$scope.selectedNode=dataviewInfo.selectedNode;$scope.dataViews=dataviewInfo.dataViews;$scope.initPaging();$scope.maxDeviceCount=$scope.PAGE_SIZE*$scope.pageNumber;if($scope.selectedNode&&$scope.selectedNode.nodeType===DataViewNodeType.Leaf&&$scope.selectedNode.ID&&$scope.dataViews){$scope.UIControl.noSelection=!1;$scope.deviceDataViewCount=0;$scope.lazyLoading(!0)}else $scope.UIControl.noSelection=!0;$scope.gridApi&&$scope.gridApi.grid&&$scope.gridApi.grid.refresh()}));$scope.$on("$destroy",onSelectNode);$scope.selectAll=!1;$scope.onSelectAll=function(){if(!0===$scope.selectAll){$scope.selectAll=!1;$scope.gridApi.selection.clearSelectedRows()}else{$scope.selectAll=!0;$scope.gridApi.selection.selectAllRows()}};$scope.showDeviceProperty={show:!1};$scope.getMoreProptyPopup=function(row){$scope.showDeviceProperty.show=!0;$rootScope.$emit(dataViewManagerEvent.devicePropertyOverflowSelected,{rowEntity:row.entity})};$scope.showOverflowLink=function(overFlowDataList,dataViewType){if("dvManual"!==dataViewType)return!0;var bShowOverflowLink=!1;if(angular.isDefined(overFlowDataList)&&angular.isArray(overFlowDataList)&&overFlowDataList.length>0)for(var i=0;i<overFlowDataList.length;i++)if(angular.isDefined(overFlowDataList[i].posInfo)&&overFlowDataList[i].posInfo.isCustomize){bShowOverflowLink=!0;break}return bShowOverflowLink};$scope.showDeviceInterface={show:!1};$scope.getMoreInterfacePopup=function(row){if(0!==row.entity.intfInfoList.length||Number.parseInt(row.entity.infs)){$scope.showDeviceInterface.show=!0;$rootScope.$emit(dataViewManagerEvent.deviceInterfaceSelected,{rowEntity:row.entity})}};var deviceCellPropertyUpdated=$rootScope.$on(dataViewManagerEvent.deviceCellPropertyUpdated,(function(event,deviceObj){for(var i=0;i<$scope.gridOptions.data.length;i++)if(deviceObj.ID===$scope.gridOptions.data[i].ID){$scope.gridOptions.data[i]=$scope.loadOneDeviceDataView(deviceObj);break}}));$scope.$on("$destroy",deviceCellPropertyUpdated);var deviceInterfaceUpdated=$rootScope.$on(dataViewManagerEvent.deviceInterfaceUpdated,(function(event,deviceInfo){for(var i=0;i<$scope.gridOptions.data.length;i++)if($scope.gridOptions.data[i].ID===deviceInfo.ID){$scope.gridOptions.data[i].intfInfoList=deviceInfo.entity.intfInfoList;$scope.gridOptions.data[i].infs=deviceInfo.entity.intfInfoList?deviceInfo.entity.intfInfoList.length+"":"";break}}));$scope.$on("$destroy",deviceInterfaceUpdated);var deviceRowPropertyUpdated=$rootScope.$on(dataViewManagerEvent.deviceRowPropertyUpdated,(function(event,deviceInfo){for(var i=0;i<$scope.gridOptions.data.length;i++)if($scope.gridOptions.data[i].ID===deviceInfo.ID){for(var j=0;j<$scope.gridOptions.data[i].devPosList.length;j++){$scope.gridOptions.data[i]["prop"+(j+1)].text="";$scope.gridOptions.data[i]["prop"+(j+1)].isCustomize=!1;$scope.gridOptions.data[i]["val"+(j+1)].text="";$scope.gridOptions.data[i]["val"+(j+1)].isCustomize=!1;$scope.gridOptions.data[i].devPosList[j].posInfo.dataUnitList[0].displayName="";$scope.gridOptions.data[i].devPosList[j].posInfo.displayInfo="";$scope.gridOptions.data[i].devPosList[j].posInfo.isCustomize=!1}break}}));$scope.$on("$destroy",deviceRowPropertyUpdated);$scope.onClearCellDeviceProperty=function(row,i){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={title:"Warning",iconType:NB_ICON_WARNING,message:"Are you sure you want to delete the data in this position?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){$scope.onClearCellDevicePropertyConfirmed(row,i)}))};$scope.onClearCellDevicePropertyConfirmed=function(row,i){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}httpDataViewManagerSrvc.resetDeviceDataViewOnPos(null,row.ID,[{posName:row["devPos"+(i+1)]}]).then((function(deviceObj){for(var i=0;i<$scope.gridOptions.data.length;i++)if(row.ID===$scope.gridOptions.data[i].ID){$scope.gridOptions.data[i]=$scope.loadOneDeviceDataView(deviceObj);break}$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("Can't clear the manually edited data unit at this position.",reason)}))};$scope.onUnlockCellDeviceProperty=function(row,i){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:"Are you sure you want to unlock the data unit at this position?"}).then((function(){$scope.onUnlockCellDevicePropertyConfirmed(row,i)}))};$scope.onUnlockCellDevicePropertyConfirmed=function(row,i){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}httpDataViewManagerSrvc.unlockDeviceDataViewOnPos(null,row.ID,[{posName:row["devPos"+(i+1)]}]).then((function(deviceObj){for(var i=0;i<$scope.gridOptions.data.length;i++)if(row.ID===$scope.gridOptions.data[i].ID){$scope.gridOptions.data[i]=$scope.loadOneDeviceDataView(deviceObj);break}$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("Can't clear the data unit at this position.",reason)}))};$scope.onClearRowDeviceProperty=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={message:"Are you sure you want to delete the data in this position?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(result){$scope.onClearRowDevicePropertyConfirmed(row)}))};$scope.onClearRowDevicePropertyConfirmed=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}httpDataViewManagerSrvc.resetDeviceDataViewOnPos(null,row.ID).then((function(deviceObj){for(var i=0;i<$scope.gridOptions.data.length;i++)if(row.ID===$scope.gridOptions.data[i].ID){$scope.gridOptions.data[i]=$scope.loadOneDeviceDataView(deviceObj);break}$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("Can't clear all the manually edited data units in this data view.",reason)}))};$scope.onClearAllDeviceProperty=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={message:"Are you sure you want to delete the data in this position?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){httpDataViewManagerSrvc.resetDeviceDataViewsInDataViewGroup(null,$scope.selectedNode.ID).then((function(result){angular.forEach($scope.gridOptions.data,(function(obj){for(var i=0;i<4;i++)if(obj.devPosList[i]&&obj.devPosList[i].posInfo)try{if(!0===obj.devPosList[i].posInfo.isCustomize){obj.devPosList[i].posInfo.dataUnitList[0].displayName="";obj.devPosList[i].posInfo.displayInfo="";obj.devPosList[i].posInfo.isCustomize=!1;obj["prop"+(i+1)].text="";obj["prop"+(i+1)].isCustomize=!1;obj["val"+(i+1)].text="",obj["val"+(i+1)].isCustomize=!1}}catch(err){}for(var i2=0;i2<obj.intfInfoList.length;i2++)for(var j=0;j<obj.intfInfoList[i2].intfPosList.length;j++)try{if(obj.intfInfoList[i2].intfPosList[j].posInfo.isCustomize){obj.intfInfoList[i2].intfPosList[j].posInfo.displayInfo="";obj.intfInfoList[i2].intfPosList[j].posInfo.isCustomize=!1}}catch(err){}}));$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("Can't clear the data units in this device data view.",reason)}))}))};$scope.onClearSelectedDeviceProperty=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={message:"Are you sure you want to delete the data in this position?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){var selectedIDs=[];var selectedRows=$scope.gridApi.selection.getSelectedRows();for(var i=0;i<selectedRows.length;i++)selectedIDs.push(selectedRows[i].ID);httpDataViewManagerSrvc.resetDeviceDataViews(null,selectedIDs).then((function(deviceObjs){for(var i=0;i<deviceObjs.length;i++)for(var j=0;j<$scope.gridOptions.data.length;j++)if($scope.gridOptions.data[j].ID===deviceObjs[i].ID){$scope.gridOptions.data[j]=$scope.loadOneDeviceDataView(deviceObjs[i]);break}$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("Can't clear the selected manually edited data units.",reason)}))}))};$scope.onClearDeviceProperty=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}if(!0===$scope.selectAll){$scope.onClearAllDeviceProperty();$scope.selectAll=!1}else $scope.onClearSelectedDeviceProperty()};$scope.onEditDataviewGroupDesc=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}$scope.dvgDescriptionOrg=angular.copy($scope.dataviewGroup.description);$scope.edit={groupDesc:!0}};$scope.onCancelEditDataviewGroupDesc=function(){$scope.dataviewGroup.description=angular.copy($scope.dvgDescriptionOrg);$scope.edit={groupDesc:!1}};$scope.onSaveDataviewGroupDesc=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}if($scope.dataviewGroup.description.length>1024)nbAlertSrvc.error({message:"The length of description cannot exceed 1024 characters."});else{httpDataViewManagerSrvc.upInsertDataViewGroup(null,$scope.dataviewGroup).then((function(result){$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("Can't save the Data View.",reason)}));$scope.edit={groupDesc:!1}}};$scope.onDeleteOneDevice=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={title:"Warning",iconType:NB_ICON_WARNING,message:"Are you sure you want to delete the device from the Data View?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){$scope.onDeleteOneDeviceConfirmed(row)}))};$scope.onDeleteOneDeviceConfirmed=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}httpDataViewManagerSrvc.deleteDeviceDataViews(null,[row.ID]).then((function(result){for(var i=0;i<$scope.gridOptions.data.length;i++)if(row.ID===$scope.gridOptions.data[i].ID){$scope.gridOptions.data.splice(i,1);break}$scope.deviceDataViewCount-=1;$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("There is an error when delete the row.",reason)}))};$scope.onDeleteDevices=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={title:"Warning",iconType:NB_ICON_WARNING,message:"Are you sure you want to delete the devices from the Data View?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){$scope.onDeleteDevicesConfirmed()}))};$scope.onDeleteDevicesConfirmed=function(){var selectedIDs=[];var selectedRows=$scope.gridApi.selection.getSelectedRows();for(var i=0;i<selectedRows.length;i++)selectedIDs.push(selectedRows[i].ID);httpDataViewManagerSrvc.deleteDeviceDataViews(null,selectedIDs).then((function(result){for(var i=0;i<$scope.gridOptions.data.length;i++)for(var j=0;j<selectedIDs.length;j++)selectedIDs[j]===$scope.gridOptions.data[i].ID&&$scope.gridOptions.data.splice(i,1);$scope.deviceDataViewCount-=selectedIDs.length;$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("Can't delete these data views.",reason)}))};$scope.onUnlockRowDeviceProperty=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:"Are you sure you want to unlock all data units for this device in the data view?"}).then((function(){$scope.onUnlockRowDevicePropertyConfirmed(row)}))};$scope.onUnlockRowDevicePropertyConfirmed=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}httpDataViewManagerSrvc.unlockDeviceDataViewOnPos(null,row.ID).then((function(deviceObj){for(var i=0;i<$scope.gridOptions.data.length;i++)if(row.ID===$scope.gridOptions.data[i].ID){$scope.gridOptions.data[i]=$scope.loadOneDeviceDataView(deviceObj);break}$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("There is an error when clear the device data view position.",reason)}))};$scope.onUpdateLastUpdateDate=function(event,updateTime){httpDataViewManagerSrvc.getDataViewGroupsById(null,$scope.selectedNode.ID).then((function(dataviewGroupObj){_.isBoolean(dataviewGroupObj.hideInDataviewPanel)||(dataviewGroupObj.hideInDataviewPanel=!1);$scope.dataviewGroup=dataviewGroupObj;$scope.dataviewGroup.showInDataviewPanel=!$scope.dataviewGroup.hideInDataviewPanel;var newUpdateDateTime=new Date(dataviewGroupObj.lastUpdateTime);$scope.lastUpdateTime=utilitySrvc.formatDateTime(newUpdateDateTime)}),(function(reason){$log.debug(reason)}))};var lastUpdateDate=$rootScope.$on(dataViewManagerEvent.lastUpdateDate,$scope.onUpdateLastUpdateDate);$scope.$on("$destroy",lastUpdateDate);$scope.onUnlockAllDeviceProperty=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:"Are you sure you want to unlock all data units?"}).then((function(){httpDataViewManagerSrvc.unlockDeviceDataViewsInDataViewGroup(null,$scope.selectedNode.ID).then((function(result){angular.forEach($scope.gridOptions.data,(function(obj){for(var i=0;i<obj.devPosList.length;i++)try{if(!0===obj.devPosList[i].posInfo.isLock){obj.devPosList[i].posInfo.isLock=!1;obj["prop"+(i+1)].isLock=!1;obj["val"+(i+1)].isLock=!1}}catch(err){}for(var i2=0;i2<obj.intfInfoList.length;i2++)for(var j=0;j<obj.intfInfoList[i2].intfPosList.length;j++)try{!0===obj.intfInfoList[i2].intfPosList[j].posInfo.isLock&&(obj.intfInfoList[i2].intfPosList[j].posInfo.isLock=!1)}catch(err){}}))}),(function(reason){showFailDlg("Can't clear the data units in this device data view.",reason)}))}))};$scope.onUnlockSelectedDeviceProperty=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var selectedIDs=[];var selectedRows=$scope.gridApi.selection.getSelectedRows();for(var i=0;i<selectedRows.length;i++)selectedIDs.push(selectedRows[i].ID);httpDataViewManagerSrvc.unlockDeviceDataViews(null,selectedIDs).then((function(deviceObjs){for(var i=0;i<deviceObjs.length;i++)for(var j=0;j<$scope.gridOptions.data.length;j++)if($scope.gridOptions.data[j].ID===deviceObjs[i].ID){$scope.gridOptions.data[j]=$scope.loadOneDeviceDataView(deviceObjs[i]);break}$scope.onUpdateLastUpdateDate(null,new Date)}),(function(reason){showFailDlg("Can't clear the data units in this device data view.",reason)}))};$scope.onUnlockDeviceProperty=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:"Are you sure you want to unlock all data units for this device in the data view?"}).then((function(){if(!0===$scope.selectAll){$scope.onUnlockAllDeviceProperty();$scope.selectAll=!1}else $scope.onUnlockSelectedDeviceProperty()}))};function showFailDlg(msg,reason){nbAlertSrvc.error({message:msg+utilitySrvc.getErrorMessage(reason)})}var systemEventChangedDomain=$rootScope.$on(systemEvent.changedDomain,(function(event,selectedTenant,lsSelectedDomains){$scope.UIControl={noSelection:!0,text:""}}));$scope.$on("$destroy",(function(){systemEventChangedDomain()}))}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.morePropertyPopoutCtrl",MorePropertyPopoutCtrl);MorePropertyPopoutCtrl.$inject=["$scope","$log","$rootScope","nb.dataview.httpDataViewManagerSrvc","nb.ng.utilitySrvc","nb.common.nbAlertSrvc","nb.admin.domainAdminMgr"];function MorePropertyPopoutCtrl($scope,$log,$rootScope,httpDataViewManagerSrvc,utilitySrvc,nbAlertSrvc,domainAdminMgr){$scope.gridOptionsMore={enableColumnMenus:!1,enableColumnResizing:!0,multiSelect:!0,modifierKeysToMultiSelect:!0,enableFullRowSelection:!0,enableRowSelection:!0,enableGridMenu:!1,enableRowHeaderSelection:!1,enableFiltering:!1,rowTemplate:'<div ng-if="true==row.entity.isCustomize || true==row.entity.isLock" class="dropdown primary-icon rowActionDropdown" uib-dropdown><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false"><ul class="dropdown-menu dropdownPos" uib-dropdown-menu><li ng-if="true==row.entity.isCustomize" ng-click="grid.appScope.onClearOneProperty(row)"><a>Delete Position Data</a></li><li ng-if="true==row.entity.isLock" ng-click="grid.appScope.onUnlockOneDevice(row)"><a>Unlock Position</a></li></ul></div><div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell></div>'};var domainPermObj=domainAdminMgr.getDomainPermissions();var noPermissionMsg="Sorry, you are not privileged to perform the operation. Please contact your NetBrain administrators.";$scope.gridCellTemplate='<div class="ui-grid-cell-contents" title="{{COL_FIELD}}" style="cursor: pointer;" ng-class="{customized : row.entity.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget"></div>';$scope.gridOptionsMore.columnDefs=[{field:"prop",displayName:"Property",cellTemplate:$scope.gridCellTemplate+'<img ng-show="true == row.entity.isLock" class="lockImg" src="img/lock.png"/>'},{field:"value",displayName:"Value",cellTemplate:$scope.gridCellTemplate}];$scope.gridOptionsMore.onRegisterApi=function(gridApi){$scope.gridApiMore=gridApi;$scope.switchPropValue(!0)};var loadPositioneData=function(rowEntity){$scope.gridOptionsMore.data=[];for(var i=0;i<rowEntity.overflow.length;i++){var newMoreDataView={seq:i+1+""};try{newMoreDataView["overflowPos"+(i+1)]=rowEntity.overflow[i].posName}catch(err){}try{var val="";if(rowEntity.overflow[i].posInfo.dataUnitList[0]&&rowEntity.overflow[i].posInfo.dataUnitList[0].displayName){val=(val=(val=rowEntity.overflow[i].posInfo.dataUnitList[0].displayName).replace(/\(string\)$/gi,"")).replace(/\(int\)$/gi,"")}newMoreDataView.prop=val}catch(err){}try{newMoreDataView.value=rowEntity.overflow[i].posInfo.displayInfo?rowEntity.overflow[i].posInfo.displayInfo:""}catch(err){}try{newMoreDataView.isCustomize=rowEntity.overflow[i].posInfo.isCustomize}catch(err){}try{newMoreDataView.isLock=rowEntity.overflow[i].posInfo.isLock}catch(err){}$scope.gridOptionsMore.data.push(newMoreDataView)}};var devicePropertyOverflowSelected=$rootScope.$on(dataViewManagerEvent.devicePropertyOverflowSelected,(function(event,deviceInfo){$scope.rowEntity=deviceInfo.rowEntity;loadPositioneData($scope.rowEntity);$scope.gridApiMore&&$scope.gridApiMore.grid&&$scope.gridApiMore.grid.refresh()}));$scope.$on("$destroy",devicePropertyOverflowSelected);$scope.onClearOneProperty=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}httpDataViewManagerSrvc.resetDeviceDataViewOnPos(null,$scope.rowEntity.ID,null,[{posName:row.entity["overflowPos"+row.entity.seq]}]).then((function(deviceObj){for(var i=0;i<deviceObj.dataViewData.devPosList.length;i++)if(deviceObj.dataViewData.devPosList[i].extraData&&deviceObj.dataViewData.devPosList[i].extraData.overflowList){var newDeviceObj={ID:deviceObj.ID};newDeviceObj.overflow=deviceObj.dataViewData.devPosList[i].extraData.overflowList;loadPositioneData(newDeviceObj)}$rootScope.$emit(dataViewManagerEvent.deviceCellPropertyUpdated,deviceObj);$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(reason){nbAlertSrvc.error({message:"Failed to remove the device data view position.<br>"+utilitySrvc.getErrorMessage(reason)})}))};$scope.onUnlockOneDevice=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:"Are you sure you want to unlock the data unit at this position?"}).then((function(){httpDataViewManagerSrvc.unlockDeviceDataViewOnPos(null,$scope.rowEntity.ID,null,[{posName:row.entity["overflowPos"+row.entity.seq]}]).then((function(deviceObj){for(var i=0;i<deviceObj.dataViewData.devPosList.length;i++)if(deviceObj.dataViewData.devPosList[i].extraData&&deviceObj.dataViewData.devPosList[i].extraData.overflowList){var newDeviceObj={ID:deviceObj.ID};newDeviceObj.overflow=deviceObj.dataViewData.devPosList[i].extraData.overflowList;loadPositioneData(newDeviceObj)}$rootScope.$emit(dataViewManagerEvent.deviceCellPropertyUpdated,deviceObj);$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(reason){nbAlertSrvc.error({message:"Failed to remove the device data view position.<br>"+utilitySrvc.getErrorMessage(reason)})}))}))}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.showInterfacePopoutCtrl",ShowInterfacePopoutCtrl);ShowInterfacePopoutCtrl.$inject=["$scope","$q","$log","$rootScope","$filter","uiGridConstants","nb.dataview.httpDataViewManagerSrvc","nb.ng.utilitySrvc","nb.common.nbAlertSrvc","$timeout","nb.admin.domainAdminMgr"];function ShowInterfacePopoutCtrl($scope,$q,$log,$rootScope,$filter,uiGridConstants,httpDataViewManagerSrvc,utilitySrvc,nbAlertSrvc,$timeout,domainAdminMgr){$scope.filterOptions={filterTarget:""};var unlockWording="Are you sure you want to unlock the data unit at this position?";var domainPermObj=domainAdminMgr.getDomainPermissions();var noPermissionMsg="Sorry, you are not privileged to perform the operation. Please contact your NetBrain administrators.";$scope.filterData=function(){!0===$scope.intfValuePropertySelect?$scope.gridOptionsInterface.data=$filter("interfaceGridColumnsFilter")($scope.deviceInterfaceList,["intfName","val1","val2","val3","val4","val5","val6","val7","val8"],$scope.filterOptions.filterTarget):$scope.gridOptionsInterface.data=$filter("interfaceGridColumnsFilter")($scope.deviceInterfaceList,["intfName","prop1","prop2","prop3","prop4","pos5","pos6","pos7","pos8"],$scope.filterOptions.filterTarget)};$scope.selectAll=!1;$scope.rightClickContextMenu=function(rows,grid,event){var contextMenu=[];for(var i=0;i<rows.length;i++)if(rows[i].isCustomize){var clearMenuItem={template:"Delete Position Data",action:function(rows,grid,event){$scope.onClearDeviceInterface()}};contextMenu.push(clearMenuItem);break}for(var i2=0;i2<rows.length;i2++)if(rows[i2].isLock){var unlockMenuItem={template:"Unlock Positions",action:function(rows,grid,event){$scope.onUnlockDeviceInterface()}};contextMenu.push(unlockMenuItem);break}var deleteMenuItem={template:rows.length>1?"Delete Rows":"Delete Row",action:function(rows,grid,event){$scope.onDeleteInterfaces()}};contextMenu.push(deleteMenuItem);return contextMenu};$scope.listInterfaceCategory=[{text:"All Interfaces"},{text:"Only Interfaces with Overwrites"},{text:"Only Interfaces with Defaults"}];$scope.selectedInterfaceCategory=$scope.listInterfaceCategory[0];$scope.selectShowInterfaceCategory=function(category){$scope.showCategory=category.text;$scope.filterOptions.filterTarget="";$scope.gridApiInterface&&$scope.gridApiInterface.grid&&$scope.gridApiInterface.grid.refresh()};$scope.intfValuePropertySelect=!0;$scope.switchPropValue=function(value){$scope.intfValuePropertySelect=value;if(!0===$scope.intfValuePropertySelect){$scope.gridOptionsInterface.data=$filter("selectedColumnsFilter")($scope.deviceInterfaceList,["intfName","val1.text","val2.text","val3.text","val4.text","val5.text","val6.text","val7.text","val8.text"],$scope.filterOptions.filterTarget);$scope.gridOptionsInterface.columnDefs[1].visible=!1;$scope.gridOptionsInterface.columnDefs[2].visible=!1;$scope.gridOptionsInterface.columnDefs[3].visible=!1;$scope.gridOptionsInterface.columnDefs[4].visible=!1;$scope.gridOptionsInterface.columnDefs[5].visible=!1;$scope.gridOptionsInterface.columnDefs[6].visible=!1;$scope.gridOptionsInterface.columnDefs[7].visible=!1;$scope.gridOptionsInterface.columnDefs[8].visible=!1;$scope.gridOptionsInterface.columnDefs[9].visible=!0;$scope.gridOptionsInterface.columnDefs[10].visible=!0;$scope.gridOptionsInterface.columnDefs[11].visible=!0;$scope.gridOptionsInterface.columnDefs[12].visible=!0;$scope.gridOptionsInterface.columnDefs[13].visible=!0;$scope.gridOptionsInterface.columnDefs[14].visible=!0;$scope.gridOptionsInterface.columnDefs[15].visible=!0;$scope.gridOptionsInterface.columnDefs[16].visible=!0}else{$scope.gridOptionsInterface.data=$filter("selectedColumnsFilter")($scope.deviceInterfaceList,["intfName","prop1.text","prop2.text","prop3.text","prop4.text","prop5.text","prop6.text","prop7.text","prop8.text"],$scope.filterOptions.filterTarget);$scope.gridOptionsInterface.columnDefs[1].visible=!0;$scope.gridOptionsInterface.columnDefs[2].visible=!0;$scope.gridOptionsInterface.columnDefs[3].visible=!0;$scope.gridOptionsInterface.columnDefs[4].visible=!0;$scope.gridOptionsInterface.columnDefs[5].visible=!0;$scope.gridOptionsInterface.columnDefs[6].visible=!0;$scope.gridOptionsInterface.columnDefs[7].visible=!0;$scope.gridOptionsInterface.columnDefs[8].visible=!0;$scope.gridOptionsInterface.columnDefs[9].visible=!1;$scope.gridOptionsInterface.columnDefs[10].visible=!1;$scope.gridOptionsInterface.columnDefs[11].visible=!1;$scope.gridOptionsInterface.columnDefs[12].visible=!1;$scope.gridOptionsInterface.columnDefs[13].visible=!1;$scope.gridOptionsInterface.columnDefs[14].visible=!1;$scope.gridOptionsInterface.columnDefs[15].visible=!1;$scope.gridOptionsInterface.columnDefs[16].visible=!1}$scope.showCategory=$scope.selectedDeviceCategory.text;$scope.gridApiInterface&&$scope.gridApiInterface.grid&&$scope.gridApiInterface.grid.refresh()};$scope.gridOptionsInterface={};$scope.gridOptionsInterface={enableColumnMenus:!1,enableColumnResizing:!0,multiSelect:!0,enableFullRowSelection:!0,modifierKeysToMultiSelect:!0,enableRowSelection:!0,enableSelectAll:!1,enableRowHeaderSelection:!1,enableGridMenu:!1,enableFiltering:!1,enableRowContextMenu:!0,rowContextMenuItems:function(rows,grid,event){return $scope.rightClickContextMenu(rows,grid,event)},rowTemplate:'<div class="dropdown primary-icon actionDropdown" uib-dropdown><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu dropdownPos" uib-dropdown-menu><li ng-if="true==row.entity.isCustomize" ng-click="grid.appScope.onClearOneInterface(row)"><a>Delete Position Data</a></li><li ng-if="true==row.entity.isLock" ng-click="grid.appScope.onUnlockOneInterface(row)"><a>Unlock Positions</a></li><li ng-click="grid.appScope.onDeleteOneInterface(row)"><a>Delete Row</a></li></ul></div><div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell></div>'};$scope.gridOptionsInterface.onRegisterApi=function(gridApi){$scope.gridApi=gridApi;$scope.gridApiInterface=gridApi;$scope.switchPropValue(!0);$scope.gridApiInterface.grid.registerRowsProcessor($scope.typeFilterInterface,300);$scope.gridApi.selection.on.rowSelectionChanged($scope,(function(row){$scope.gridApi.selection.getSelectedRows().length===$scope.gridOptionsInterface.data.length?$scope.selectAll=!0:$scope.selectAll=!1}));$scope.gridApi.grid.registerDataChangeCallback((function(data){!0===$scope.selectAll&&$scope.gridApi.selection.selectAllRows()}),[uiGridConstants.dataChange.ROW])};$scope.gridCellTemplateWithFilter='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div>';$scope.gridCellTemplateProp1='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop1.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop1.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop1.isCustomize || true==row.entity.prop1.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop1.isCustomize" ng-click="grid.appScope.onClearCellInterface(row.entity, 0); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop1.isLock" ng-click="grid.appScope.onUnlockCellInterface(row.entity, 0); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp2='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop2.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop2.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop2.isCustomize || true==row.entity.prop2.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop2.isCustomize" ng-click="grid.appScope.onClearCellInterface(row.entity, 1); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop2.isLock" ng-click="grid.appScope.onUnlockCellInterface(row.entity, 1); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp3='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop3.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop3.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop3.isCustomize || true==row.entity.prop3.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop3.isCustomize" ng-click="grid.appScope.onClearCellInterface(row.entity, 2); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop3.isLock" ng-click="grid.appScope.onUnlockCellInterface(row.entity, 2); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp4='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop4.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop4.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop4.isCustomize || true==row.entity.prop4.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop4.isCustomize" ng-click="grid.appScope.onClearCellInterface(row.entity, 3); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop4.isLock" ng-click="grid.appScope.onUnlockCellInterface(row.entity, 3); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp5='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop5.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop5.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop5.isCustomize || true==row.entity.prop5.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop5.isCustomize" ng-click="grid.appScope.onClearCellInterface(row.entity, 4); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop5.isLock" ng-click="grid.appScope.onUnlockCellInterface(row.entity, 4); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp6='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop6.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop6.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop6.isCustomize || true==row.entity.prop6.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop6.isCustomize" ng-click="grid.appScope.onClearCellInterface(row.entity, 5); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop6.isLock" ng-click="grid.appScope.onUnlockCellInterface(row.entity, 5); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp7='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop7.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop7.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop7.isCustomize || true==row.entity.prop7.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop7.isCustomize" ng-click="grid.appScope.onClearCellInterface(row.entity, 6); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop7.isLock" ng-click="grid.appScope.onUnlockCellInterface(row.entity, 6); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateProp8='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-class="{customized : row.entity.prop8.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div><img ng-show="true == row.entity.prop8.isLock" class="lockImg" src="img/lock.png"/><div class="dropdown primary-icon cellActionDropdown" uib-dropdown ng-show="true==row.entity.prop8.isCustomize || true==row.entity.prop8.isLock"><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false" /><ul class="dropdown-menu cellDropdownPos" uib-dropdown-menu><li ng-if="true == row.entity.prop8.isCustomize" ng-click="grid.appScope.onClearCellInterface(row.entity, 7); $event.stopPropagation();"><a>Delete Position Data</a></li><li ng-if="true == row.entity.prop8.isLock" ng-click="grid.appScope.onUnlockCellInterface(row.entity, 7); $event.stopPropagation();"><a>Unlock Position</a></li></ul></div>';$scope.gridCellTemplateOverflowLink='<div class="ui-grid-cell-contents" style="cursor: pointer; text-decoration: underline;" ng-show="row.entity.overflow" ng-click="grid.appScope.getMoreInterfacePopup(row); $event.stopPropagation();" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" title="{{COL_FIELD}}"></div>';$scope.gridOptionsInterface.columnDefs=[{field:"intfName",displayName:"Interface Name",cellTemplate:$scope.gridCellTemplateWithFilter,width:"10%"},{field:"prop1.text",displayName:"Position 1",cellTemplate:$scope.gridCellTemplateProp1,width:"10%"},{field:"prop2.text",displayName:"Position 2",cellTemplate:$scope.gridCellTemplateProp2,width:"10%"},{field:"prop3.text",displayName:"Position 3",cellTemplate:$scope.gridCellTemplateProp3,width:"10%"},{field:"prop4.text",displayName:"Position 4",cellTemplate:$scope.gridCellTemplateProp4,width:"10%"},{field:"prop5.text",displayName:"Position 5",cellTemplate:$scope.gridCellTemplateProp5,width:"10%"},{field:"prop6.text",displayName:"Position 6",cellTemplate:$scope.gridCellTemplateProp6,width:"10%"},{field:"prop7.text",displayName:"Position 7",cellTemplate:$scope.gridCellTemplateProp7,width:"10%"},{field:"prop8.text",displayName:"Position 8",cellTemplate:$scope.gridCellTemplateProp8,width:"10%"},{field:"val1.text",displayName:"Position 1",cellTemplate:$scope.gridCellTemplateProp1,width:"10%"},{field:"val2.text",displayName:"Position 2",cellTemplate:$scope.gridCellTemplateProp2,width:"10%"},{field:"val3.text",displayName:"Position 3",cellTemplate:$scope.gridCellTemplateProp3,width:"10%"},{field:"val4.text",displayName:"Position 4",cellTemplate:$scope.gridCellTemplateProp4,width:"10%"},{field:"val5.text",displayName:"Position 5",cellTemplate:$scope.gridCellTemplateProp5,width:"10%"},{field:"val6.text",displayName:"Position 6",cellTemplate:$scope.gridCellTemplateProp6,width:"10%"},{field:"val7.text",displayName:"Position 7",cellTemplate:$scope.gridCellTemplateProp7,width:"10%"},{field:"val8.text",displayName:"Position 8",cellTemplate:$scope.gridCellTemplateProp8,width:"10%"},{field:"more",displayName:"Overflow Data",cellTemplate:$scope.gridCellTemplateOverflowLink,width:"10%"}];$scope.typeFilterInterface=function(renderableRows){renderableRows.forEach((function(row){"All Interfaces"===$scope.showCategory||("Only Interfaces with Overwrites"===$scope.showCategory?!0===row.entity.prop1.isCustomize||!0===row.entity.prop2.isCustomize||!0===row.entity.prop3.isCustomize||!0===row.entity.prop4.isCustomize||!0===row.entity.prop5.isCustomize||!0===row.entity.prop6.isCustomize||!0===row.entity.prop7.isCustomize||!0===row.entity.prop8.isCustomize:"Only Interfaces with Defaults"!==$scope.showCategory||!1===row.entity.prop1.isCustomize&&!1===row.entity.prop2.isCustomize&&!1===row.entity.prop3.isCustomize&&!1===row.entity.prop4.isCustomize&&!1===row.entity.prop5.isCustomize&&!1===row.entity.prop6.isCustomize&&!1===row.entity.prop7.isCustomize&&!1===row.entity.prop8.isCustomize)||(row.visible=!1)}));return renderableRows};$scope.loadDataFromIntfInfoList=function(entity){var deferred=$q.defer();$scope.globalButton={clearIcon:!1,unlockIcon:!1};$scope.gridOptionsInterface.data=[];if(entity.intfInfoList&&entity.intfInfoList.length>0)return loadData(entity);httpDataViewManagerSrvc.getDeviceDataViewInterface(entity.ID).then((function(intfs){entity.intfInfoList=intfs;loadData(entity).then((function(d){deferred.resolve()}),(function(error){deferred.resolve()}))}),(function(error){deferred.resolve();console.error(error)}));return deferred.promise};function loadData(entity){var deferred=$q.defer();$timeout((function(){var intfKeyObjs=function(intfInfoList){var result=[];_.each(intfInfoList,(function(intfInfo){intfInfo.intf.intfDisplaySchemaObj||result.push(intfInfo.intf.intfKeyObj)}));return result}(entity.intfInfoList);if(intfKeyObjs.length)httpDataViewManagerSrvc.getInterfaceDisplaySchemaValues(intfKeyObjs).then((function(intfs){!function(intfInfoList,intfs){_.each(intfInfoList,(function(intfInfo){if(!intfInfo.intf.intfDisplaySchemaObj){var intf=_.find(intfs,(function(item){return item.intfKeyObj&&item.intfKeyObj.value===intfInfo.intf.intfKeyObj.value}));intf&&(intfInfo.intf.intfDisplaySchemaObj=intf.intfDisplaySchemaObj)}}))}(entity.intfInfoList,intfs);loadDataFromIntInfoListRefresh(entity);deferred.resolve()}),(function(error){deferred.resolve()}));else{loadDataFromIntInfoListRefresh(entity);deferred.resolve()}}),0);return deferred.promise}function loadDataFromIntInfoListRefresh(entity){var data=[];angular.forEach(entity.intfInfoList,(function(intfObj,i2){var newIntfObject={ID:entity.ID,intfKey:intfObj.intf.intfKeyObj.value,intfName:intfObj.intf.intfDisplaySchemaObj.value,intfPosList:void 0!==intfObj.intfPosList?intfObj.intfPosList:[],isCustomize:!1,isLock:!1,more:"More",overflow:intfObj.overflow,intfInfoList:intfObj.intfPosList};var emptyCount=0;for(var i=0;i<8;i++){newIntfObject["prop"+(i+1)]={text:"",isCustomize:!1,isLock:!1};newIntfObject["val"+(i+1)]={text:"",isCustomize:!1,isLock:!1};if(!intfObj||intfObj.intfPosList&&0!==intfObj.intfPosList.length){for(var j=0;j<intfObj.intfPosList.length;j++)if(intfObj.intfPosList[j].posName===DataViewPosName["intfPos"+(i+1)]){newIntfObject["intfPos"+(i+1)]=DataViewPosName["intfPos"+(i+1)];try{var val="";if(intfObj.intfPosList[j].posInfo.dataUnitList[0]&&intfObj.intfPosList[j].posInfo.dataUnitList[0].displayName){val=(val=(val=intfObj.intfPosList[j].posInfo.dataUnitList[0].displayName).replace(/\(string\)$/gi,"")).replace(/\(int\)$/gi,"")}newIntfObject["prop"+(i+1)].text=val}catch(err){}try{if(intfObj.intfPosList[j].posInfo.isCustomize){newIntfObject["prop"+(i+1)].isCustomize=!0;newIntfObject.isCustomize=!0}else newIntfObject["prop"+(i+1)].isCustomize=!1}catch(err){}try{if(intfObj.intfPosList[j].posInfo.isLock){newIntfObject["prop"+(i+1)].isLock=!0;newIntfObject.isLock=!0}else newIntfObject["prop"+(i+1)].isLock=!1}catch(err){}try{newIntfObject["val"+(i+1)].text=intfObj.intfPosList[j].posInfo.displayInfo?intfObj.intfPosList[j].posInfo.displayInfo:""}catch(err){}try{newIntfObject["val"+(i+1)].isCustomize=!!intfObj.intfPosList[j].posInfo.isCustomize&&intfObj.intfPosList[j].posInfo.isCustomize}catch(err){}try{newIntfObject["val"+(i+1)].isLock=!!intfObj.intfPosList[j].posInfo.isLock&&intfObj.intfPosList[j].posInfo.isLock}catch(err){}}for(var j2=0;j2<intfObj.intfPosList.length;j2++)if(intfObj.intfPosList[j2].posName===DataViewPosName.overflowPos)try{newIntfObject.overflow=!!intfObj.intfPosList[j2].extraData.overflowList&&intfObj.intfPosList[j2].extraData.overflowList}catch(err){}}else emptyCount++}newIntfObject.isCustomize&&($scope.globalButton.clearIcon=!0);newIntfObject.isLock&&($scope.globalButton.unlockIcon=!0);(emptyCount<8||newIntfObject.overflow)&&data.push(newIntfObject)}));$timeout((function(){$scope.gridOptionsInterface.data=data;$scope.deviceInterfaceList=$scope.gridOptionsInterface.data;$scope.gridApiInterface&&$scope.gridApiInterface.grid&&$timeout((function(){$scope.gridApiInterface.grid.refresh();$scope.deviceInterfaceList.length}),10)}),0)}$scope.selectAll=!1;$scope.onSelectAll=function(){if(!0===$scope.selectAll){$scope.selectAll=!1;$scope.gridApi.selection.clearSelectedRows()}else{$scope.selectAll=!0;$scope.gridApi.selection.selectAllRows()}};var deviceInterfaceSelected=$rootScope.$on(dataViewManagerEvent.deviceInterfaceSelected,(function(event,deviceInfo){$scope.rowEntity=deviceInfo.rowEntity;$scope.loadDataFromIntfInfoList($scope.rowEntity).then((function(){refreshGrid(event)}),(function(){refreshGrid(event)}))}));function refreshGrid(event){$timeout((function(){if($scope.gridApiInterface&&$scope.gridApiInterface.grid){$scope.gridApiInterface.grid.refresh();$scope.gridApiInterface.grid.refreshRows();$scope.gridApiInterface.grid.resetColumnSorting();$scope.gridApiInterface.grid.scrollTo(event,0);$scope.gridApiInterface.grid.scrollToIfNecessary(0,0);for(var i=0;i<$scope.gridApiInterface.grid.columns.length;i++)$scope.gridApiInterface.grid.columns[i].width="10%"}}),20)}$scope.$on("$destroy",deviceInterfaceSelected);$scope.onClearCellInterface=function(intfObj,i){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={message:"Are you sure you want to delete the data in this position?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){httpDataViewManagerSrvc.resetDeviceDataViewOnInterfacePos(null,intfObj.ID,intfObj.intfKey,[{posName:intfObj["intfPos"+(i+1)]}]).then((function(deviceObj){deviceObj.dataViewData.ID=intfObj.ID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:intfObj.ID,entity:deviceObj.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(){nbAlertSrvc.error({message:"Failed to remove the manually edited data unit at this position."})}))}))};$scope.onUnlockCellInterface=function(intfObj,i){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:unlockWording}).then((function(){httpDataViewManagerSrvc.unlockDeviceDataViewOnInterfacePos(null,intfObj.ID,intfObj.intfKey,[{posName:intfObj["intfPos"+(i+1)]}]).then((function(deviceObj){deviceObj.dataViewData.ID=intfObj.ID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:intfObj.ID,entity:deviceObj.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(){nbAlertSrvc.error({message:"Failed to remove the manually edited data unit at this position."})}))}))};$scope.onClearOneInterface=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={message:"Are you sure you want to delete the data in this position?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){httpDataViewManagerSrvc.resetDeviceDataViewOnInterfacePos(null,row.entity.ID,row.entity.intfKey).then((function(deviceObj){deviceObj.dataViewData.ID=row.entity.ID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:row.entity.ID,entity:deviceObj.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(reason){nbAlertSrvc.error({message:"Failed to remove the data units of this interface.<br>"+utilitySrvc.getErrorMessage(reason)})}))}))};$scope.onClearAllDeviceInterface=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={message:"Are you sure you want to delete the data in this position?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){var deviceID=$scope.gridOptionsInterface.data[0].ID;httpDataViewManagerSrvc.resetDeviceDataViewOnInterfacePos(null,deviceID).then((function(deviceObj){deviceObj.dataViewData.ID=deviceID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:deviceID,entity:deviceObj.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(reason){nbAlertSrvc.error("Failed to remove all manually edited interface data units.<br>"+utilitySrvc.getErrorMessage(reason))}))}))};$scope.onClearSelectedDeviceInterface=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={message:"Are you sure you want to delete the data in this position?",buttons:[{id:NB_CONFIRM_YES,label:"Delete"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(dialogOptions).then((function(){var deviceID=$scope.gridOptionsInterface.data[0].ID;var selectedRows=$scope.gridApi.selection.getSelectedRows();var selectedIDs=[];for(var i=0;i<selectedRows.length;i++){deviceID=selectedRows[i].ID;selectedIDs.push(selectedRows[i].intfKey)}httpDataViewManagerSrvc.resetDeviceDataViewOnInterfaces(null,deviceID,selectedIDs).then((function(deviceObjs){angular.forEach(deviceObjs,(function(deviceObj){deviceObj.dataViewData.ID=deviceID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:deviceID,entity:deviceObj.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}))}),(function(reason){nbAlertSrvc.error({message:"Failed to remove the manually edited interface data units.<br>"+reason})}))}))};$scope.onClearDeviceInterface=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}if(!0===$scope.selectAll){$scope.onClearAllDeviceInterface();$scope.selectAll=!1}else $scope.onClearSelectedDeviceInterface()};$scope.showInterfaceOverflow={show:!1};$scope.getMoreInterfacePopup=function(row){$scope.showInterfaceOverflow.show=!0;$rootScope.$emit(dataViewManagerEvent.deviceInterfaceOverflowSelected,{rowEntity:row.entity,loadDataFromIntfInfoList:$scope.loadDataFromIntfInfoList})};$scope.onDeleteOneInterface=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:"Deleting an interface is irreversible. Do you want to delete this interface anyway?"}).then((function(){httpDataViewManagerSrvc.deleteInterfaceInDeviceDataView(null,row.entity.ID,[row.entity.intfKey]).then((function(deviceObj){deviceObj.dataViewData.ID=row.entity.ID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:row.entity.ID,entity:deviceObj.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(reason){nbAlertSrvc.error({message:"Failed to remove the interface data units from this data view.<br>"+utilitySrvc.getErrorMessage(reason)})}))}))};$scope.onUnlockOneInterface=function(row){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:unlockWording}).then((function(){httpDataViewManagerSrvc.unlockDeviceDataViewOnInterfacePos(null,row.entity.ID,row.entity.intfKey).then((function(deviceObj){deviceObj.dataViewData.ID=row.entity.ID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:row.entity.ID,entity:deviceObj.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(){nbAlertSrvc.error({message:"Can't unlock the interface data unit(s)."})}))}))};$scope.onUnlockAllDeviceInterface=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}var dialogOptions={message:unlockWording};nbAlertSrvc.confirm(dialogOptions).then((function(){var deviceID=$scope.gridOptionsInterface.data[0].ID;httpDataViewManagerSrvc.unlockDeviceDataViewOnInterfacePos(null,deviceID).then((function(deviceObj){deviceObj.dataViewData.ID=deviceID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:deviceID,entity:deviceObj.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(reason){nbAlertSrvc.error("Can't unlock all interface data units.<br>"+utilitySrvc.getErrorMessage(reason))}))}))};$scope.onUnlockSelectedDeviceInterface=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:unlockWording}).then((function(){var deviceID=$scope.gridOptionsInterface.data[0].ID;var selectedRows=$scope.gridApi.selection.getSelectedRows();var selectedIDs=[];for(var i=0;i<selectedRows.length;i++){deviceID=selectedRows[i].ID;selectedIDs.push(selectedRows[i].intfKey)}httpDataViewManagerSrvc.unlockDeviceDataViewOnInterfaces(null,deviceID,selectedIDs).then((function(deviceObjs){angular.forEach(deviceObjs,(function(deviceObj){deviceObj.dataViewData.ID=deviceID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:deviceID,entity:deviceObj.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}))}),(function(reason){nbAlertSrvc.error({message:"Can't unlock the selected interface data units.<br>"+utilitySrvc.getErrorMessage(reason)})}))}))};$scope.onUnlockDeviceInterface=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}if(!0===$scope.selectAll){$scope.onUnlockAllDeviceInterface();$scope.selectAll=!1}else $scope.onUnlockSelectedDeviceInterface()};$scope.onDeleteInterfaces=function(){if(!domainPermObj.hasSharedResourceManagementPerm){nbAlertSrvc.notification({message:noPermissionMsg});return!1}nbAlertSrvc.confirm({message:"Deleting an interface is irreversible. Do you want to delete the selected interfaces anyway?"}).then((function(){var selectedRows=$scope.gridApi.selection.getSelectedRows();var deviceID="";var selectedIDs=[];for(var i=0;i<selectedRows.length;i++){deviceID=selectedRows[i].ID;selectedIDs.push(selectedRows[i].intfKey)}httpDataViewManagerSrvc.deleteInterfaceInDeviceDataView(null,deviceID,selectedIDs).then((function(deviceObj){deviceObj.dataViewData.ID=deviceID;$scope.loadDataFromIntfInfoList(deviceObj.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:deviceID,entity:deviceObj.dataViewData});$scope.onUpdateLastUpdateDate()}),(function(reason){nbAlertSrvc.error({message:"Failed to remove the interfaces.<br>"+utilitySrvc.getErrorMessage(reason)})}))}))};$scope.onClickClose=function(){$timeout((function(){$scope.gridOptionsInterface.data=[];$scope.deviceInterfaceList=[];$timeout((function(){$scope.showDeviceInterface.show=!1;$scope.showInterfaceOverflow.show=!1}),0)}),0)}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.moreInterfacePopoutCtrl",MoreInterfacePopoutCtrl);MoreInterfacePopoutCtrl.$inject=["$scope","$log","$rootScope","nb.dataview.httpDataViewManagerSrvc","nb.ng.utilitySrvc","nb.common.nbAlertSrvc"];function MoreInterfacePopoutCtrl($scope,$log,$rootScope,httpDataViewManagerSrvc,utilitySrvc,nbAlertSrvc){$scope.gridOptionsMore={enableColumnMenus:!1,enableColumnResizing:!0,multiSelect:!0,modifierKeysToMultiSelect:!0,enableFullRowSelection:!0,enableRowSelection:!0,enableGridMenu:!1,enableRowHeaderSelection:!1,enableFiltering:!1,rowTemplate:'<div ng-if="true==row.entity.isCustomize || true==row.entity.isLock" class="dropdown primary-icon actionDropdown actionOverflow" uib-dropdown><img src="img/Assets/More_Actions_Button_20x20.png" uib-dropdown-toggle aria-haspopup="true" aria-expanded="false"><ul class="dropdown-menu dropdownPos" uib-dropdown-menu><li ng-if="true==row.entity.isCustomize" ng-click="grid.appScope.onClearCellInterface(row)"><a>Delete Position Data</a></li><li ng-if="true==row.entity.isLock" ng-click="grid.appScope.onUnlockOneInterface(row)"><a>Unlock Interface Position</a></li></ul></div><div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell></div>'};$scope.gridCellTemplate='<div class="ui-grid-cell-contents" title="{{COL_FIELD}}" style="cursor: pointer;" ng-class="{customized : row.entity.isCustomize}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget"></div>';$scope.gridOptionsMore.columnDefs=[{field:"prop",displayName:"Property",cellTemplate:$scope.gridCellTemplate+'<img ng-show="true == row.entity.isLock" class="lockImg" src="img/lock.png"/>'},{field:"value",displayName:"Value",cellTemplate:$scope.gridCellTemplate}];$scope.gridOptionsMore.onRegisterApi=function(gridApi){$scope.gridApiMore=gridApi;$scope.switchPropValue(!0)};var loadInterfaceData=function(rowEntity){$scope.rowEntity=rowEntity;$scope.gridOptionsMore.data=[];for(var i=0;i<rowEntity.overflow.length;i++){var newMoreInterface={seq:i+1+"",ID:rowEntity.ID};try{newMoreInterface["overflowPos"+(i+1)]=rowEntity.overflow[i].posName}catch(err){}try{newMoreInterface.intfKey=rowEntity.intfKey}catch(err){}try{var val="";if(rowEntity.overflow[i].posInfo.dataUnitList[0]&&rowEntity.overflow[i].posInfo.dataUnitList[0].displayName){val=(val=(val=rowEntity.overflow[i].posInfo.dataUnitList[0].displayName).replace(/\(string\)$/gi,"")).replace(/\(int\)$/gi,"")}newMoreInterface.prop=val}catch(err){}try{newMoreInterface.value=rowEntity.overflow[i].posInfo.displayInfo?rowEntity.overflow[i].posInfo.displayInfo:""}catch(err){}try{newMoreInterface.isCustomize=rowEntity.overflow[i].posInfo.isCustomize}catch(err){}try{newMoreInterface.isLock=rowEntity.overflow[i].posInfo.isLock}catch(err){}$scope.gridOptionsMore.data.push(newMoreInterface)}};var devicePropertyOverflowSelected=$rootScope.$on(dataViewManagerEvent.deviceInterfaceOverflowSelected,(function(event,deviceInfo){loadInterfaceData(deviceInfo.rowEntity);$scope.loadDataFromIntfInfoList=deviceInfo.loadDataFromIntfInfoList;$scope.gridApiMore&&$scope.gridApiMore.grid&&$scope.gridApiMore.grid.refresh()}));$scope.$on("$destroy",devicePropertyOverflowSelected);$scope.onClearCellInterface=function(row){httpDataViewManagerSrvc.resetDeviceDataViewOnInterfacePos(null,row.entity.ID,row.entity.intfKey,null,[{posName:row.entity["overflowPos"+row.entity.seq]}]).then((function(result){for(var i=0;i<result.dataViewData.intfInfoList.length;i++)if(row.entity.intfKey===result.dataViewData.intfInfoList[i].intf.intfKeyObj.value)for(var j=0;j<result.dataViewData.intfInfoList[i].intfPosList.length;j++)if(result.dataViewData.intfInfoList[i].intfPosList[j].posName===DataViewPosName.overflowPos){loadInterfaceData({ID:row.entity.ID,intfKey:row.entity.intfKey,overflow:result.dataViewData.intfInfoList[i].intfPosList[j].extraData.overflowList});break}result.dataViewData.ID=row.entity.ID;$scope.loadDataFromIntfInfoList(result.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:row.entity.ID,entity:result.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(reason){nbAlertSrvc.error({message:"Failed to remove the device data view interface.<br>"+utilitySrvc.getErrorMessage(reason)})}))};$scope.onClosePopout=function(){$scope.showInterfaceOverflow.show=!1};$scope.onUnlockOneInterface=function(row){nbAlertSrvc.confirm({message:"Are you sure you want to unlock the data unit at this position?"}).then((function(){httpDataViewManagerSrvc.unlockDeviceDataViewOnInterfacePos(null,row.entity.ID,row.entity.intfKey,null,[{posName:row.entity["overflowPos"+row.entity.seq]}]).then((function(result){for(var i=0;i<result.dataViewData.intfInfoList.length;i++)if(row.entity.intfKey===result.dataViewData.intfInfoList[i].intf.intfKeyObj.value)for(var j=0;j<result.dataViewData.intfInfoList[i].intfPosList.length;j++)if(result.dataViewData.intfInfoList[i].intfPosList[j].posName===DataViewPosName.overflowPos){loadInterfaceData({ID:row.entity.ID,intfKey:row.entity.intfKey,overflow:result.dataViewData.intfInfoList[i].intfPosList[j].extraData.overflowList});break}result.dataViewData.ID=row.entity.ID;$scope.loadDataFromIntfInfoList(result.dataViewData);$rootScope.$emit(dataViewManagerEvent.deviceInterfaceUpdated,{ID:row.entity.ID,entity:result.dataViewData});$rootScope.$emit(dataViewManagerEvent.lastUpdateDate,new Date)}),(function(reason){nbAlertSrvc.error({message:"Failed to remove the device data view interface.<br>"+utilitySrvc.getErrorMessage(reason)})}))}))}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataViewUpdateRecordCtrl",DataViewUpdateRecordCtrl);DataViewUpdateRecordCtrl.$inject=["$scope","$rootScope","$uibModal","$routeParams","$log","$sce","$parse","$timeout","$filter","uiGridConstants","nb.netbrain.dataViewCacheSrvc","nb.dataview.httpDataViewManagerSrvc","nb.ng.utilitySrvc","nb.ng.callbackSrvc"];function DataViewUpdateRecordCtrl(self,$rootScope,$uibModal,$routeParams,$log,$sce,$parse,$timeout,$filter,uiGridConstants,dataViewCacheSrvc,httpDataViewManagerSrvc,utilitySrvc,callbackSrvc){self.gridTitle="Update Records";self.UIControl={noSelection:!0,text:"Select a Data View to see its update records."};self.taskHistory=[];self.scheduledTasks=[{updateSource:"a benchmark task",taskType:"Data View Task after Benchmark",taskName:"a data view task",nextRunTime:"2016-02-19T06:53:17Z",frequency:"Daily"},{updateSource:"another benchmark task",taskType:"Data View Task after Benchmark",taskName:"another data view task",nextRunTime:"2016-02-22T06:53:17Z",frequency:"Weekly"}];self.taskCount=0;self.gridCellTemplate='<div class="ui-grid-cell-contents" style="cursor: pointer;" ng-bind-html="COL_FIELD"></div>';self.gridCellDateTemplate='<div class="ui-grid-cell-contents" style="cursor: pointer;">{{COL_FIELD | dateTimeFilter}}</div>';self.futureGridOptions={data:"scheduledTasks",MultiSelect:!1,enableRowSelection:!1,enableSelectAll:!1,columnDefs:[{field:"taskType",displayName:"Task Type",cellTemplate:self.gridCellTemplate,width:"25%"},{field:"updateSource",displayName:"Update Source",cellTemplate:self.gridCellTemplate,width:"30%"},{field:"nextRunTime",displayName:"Next Run Time",cellTemplate:self.gridCellDateTemplate,width:"25%"},{field:"frequency",displayName:"Frequency",cellTemplate:self.gridCellTemplate}]};self.futureGridOptions.onRegisterApi=function(gridApi){self.futureGridOptionsApi=gridApi};self.historyGridOptions={data:"taskHistory",MultiSelect:!1,enableRowSelection:!1,enableSelectAll:!1,columnDefs:[{field:"opTime",displayName:"Update Time",cellTemplate:self.gridCellDateTemplate,width:"20%"},{field:"opName",displayName:"Operation",cellTemplate:self.gridCellTemplate,width:"40%"},{field:"taskType",displayName:"Task Type",cellTemplate:self.gridCellTemplate,width:"20%"},{field:"updateSource",displayName:"Update Source",cellTemplate:self.gridCellTemplate}]};self.historyGridOptions.onRegisterApi=function(gridApi){self.historyGridOptionsApi=gridApi};var onSelectNode=$rootScope.$on(dataViewManagerEvent.dataViewGroupSelected,(function(event,dataviewInfo){self.selectedNode=dataviewInfo.selectedNode;if(self.selectedNode&&self.selectedNode.nodeType===DataViewNodeType.Leaf&&self.selectedNode.ID){self.UIControl.noSelection=!1;self.loadData()}else self.UIControl.noSelection=!0}));self.$on("$destroy",onSelectNode);var onSwitchToUpdateRecordsTab=$rootScope.$on(dataViewManagerEvent.switchToUpdateRecordsTab,(function(){self.loadData()}));self.$on("$destroy",onSwitchToUpdateRecordsTab);self.loadData=function(){self.taskHistory=[];$timeout((function(){httpDataViewManagerSrvc.getDataViewGroupUpdateRecords(null,self.selectedNode.ID).then((function(updateRecord){self.taskHistory=updateRecord.updateRecords?updateRecord.updateRecords:[]}))}),100)}}angular.module("nb.dataview").filter("dateTimeFilter",DateTimeFilter);DateTimeFilter.$inject=["nb.ng.utilitySrvc"];function DateTimeFilter(utilitySrvc){return function(dateStr){var dateObj=new Date(dateStr);return utilitySrvc.formatDateTime(dateObj)}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.editDataViewLabelCtrl",EditDataViewLabelCtrl);EditDataViewLabelCtrl.$inject=["$scope","$log","$element","$timeout","$uibModal","$rootScope","nb.netbrain.httpDeviceSrvc","nb.dataview.httpDataViewSrvc","nb.dataview.dataViewEditMgr","nb.systemmodel.deviceTypeMgrSrvc","nb.qmap.mapManagerSrvc","nb.ng.userSrvc","nb.dataview.editDataViewSrvc"];function EditDataViewLabelCtrl($scope,$log,$element,$timeout,$uibModal,$rootScope,httpDeviceSrvc,httpDataViewSrvc,dataViewEditMgr,deviceTypeMgrSrvc,mapManagerSrvc,userSrvc,editDataViewSrvc){$scope.activeMap=mapManagerSrvc.getActivePage();$scope.dialogPos={left:0,top:0};$scope.vm={hasDeviceAccess:!0};$scope.deviceAccessCallback=function(val){$scope.vm.hasDeviceAccess=val};$scope.vm={devId:dataViewEditMgr.editingDataViewDevice.key};$scope.getDisplayIntfName=function(intf){var intfName="";dataViewEditMgr.editingDataViewDevice.key===intf.from?intfName=intf.intfSrc.intfInfo.intf.intfDisplaySchemaObj&&intf.intfSrc.intfInfo.intf.intfDisplaySchemaObj.value||"":dataViewEditMgr.editingDataViewDevice.key===intf.to?intfName=intf.intfDest.intfInfo.intf.intfDisplaySchemaObj&&intf.intfDest.intfInfo.intf.intfDisplaySchemaObj.value||"":init();return intfName};$scope.setActiveInterface=function(editingDataViewLink){$scope.$broadcast("edit-link-save");$scope.activeMap.removeAllLinkHighlightFlag();dataViewEditMgr.editingDataViewLink=editingDataViewLink;editingDataViewLink&&setSelected(editingDataViewLink);$scope.$broadcast("change-model-by-link","child")};$scope.onClose=function(){$scope.disableInterface||$scope.$emit("editLinkClose");$scope.$emit("editDeviceClose");$scope.$emit("editDataViewClose");$scope.$destroy()};$scope.onCancel=function(){$scope.disableInterface||$scope.$broadcast("edit-link-cancel");$scope.$broadcast("edit-device-cancel");$scope.onClose()};$scope.onSave=function(){$scope.$broadcast("execLeaveDataUnitFuncNow");$scope.disableInterface||$scope.$broadcast("edit-link-save");$scope.$broadcast("edit-device-save");$scope.activeMap.removeAllLinkHighlightFlag();editDataViewSrvc.saveDataView().then((function(dataViewGroupId){$rootScope.$broadcast("nbGEventUpdateDataView",dataViewGroupId);$scope.onClose()}),(function(){$scope.onClose()}))};$scope.openNotePopup=function(noteType,conditionArray,successCallback){$uibModal.open({templateUrl:"modules/nbDataView/views/EditDataView/multiMapNotePopup.html",controller:"nb.dataview.multiMapNotePopupCtrl",windowClass:"multiMapNotePopup",backdrop:"static",keyboard:!1,resolve:{args:{noteType:noteType,conditionArray:conditionArray}}}).result.then((function(objParam){successCallback(objParam)}))};$scope.isNotesChanged=function(conditionArray,backInitNotes){var flag=!0;_.size(backInitNotes)===_.size(conditionArray)&&(flag=0!==_.size(conditionArray)&&_.some(conditionArray,(function(item,index){var backItem=backInitNotes[index];return item.title!==backItem.title||item.content!==backItem.content})));return flag};init();function setSelected(intf){_.each($scope.interfaceList,(function(intfs){intfs.selected=!1}));intf.selected=!0}function init(){interfaceListsort=$scope.activeMap.getConnectedLinkDatasByDeviceIdAndFilter(dataViewEditMgr.editingDataViewDevice.key,(function(intf){return!!netBrain.Map.CategoryMgr.isTopolink(intf.category)&&(intf.from===dataViewEditMgr.editingDataViewDevice.key?!_.isEmpty(intf.intfSrc):intf.to===dataViewEditMgr.editingDataViewDevice.key&&!_.isEmpty(intf.intfDest))})),$scope.interfaceList=interfaceListsort.sort((function(a1,a2){return function(a1,a2){if(!a1)return-1;if(!a2)return 1;var len=a1.length>a2.length?a1.length:a2.length;for(var i=0;i<len;i++){if(!a1[i])return-1;if(!a2[i])return 1;if(a1.charCodeAt(i)>a2.charCodeAt(i))return 1;if(a1.charCodeAt(i)<a2.charCodeAt(i))return-1}return 0}($scope.getDisplayIntfName(a1),$scope.getDisplayIntfName(a2))}));var interfaceListsort;!function(){var deviceNoteConditionObj={};var editingDevice=dataViewEditMgr.editingDataViewDevice;var conditionInfos=createConditionInfos(NgUtil.getValueFromObjAndPath(editingDevice,"dataViewData.deviceNotes"));deviceNoteConditionObj[editingDevice.key]=conditionInfos;$scope.deviceNoteConditionObj=deviceNoteConditionObj;dataViewEditMgr.setBackupEditingDeviceDataViewNotes(deviceNoteConditionObj)}();!function(){var intfNoteConditionObj={};var deviceId=dataViewEditMgr.editingDataViewDevice.key;_.each($scope.interfaceList,(function(link){var intfSrcOrDest=link.from===deviceId?link.intfSrc:link.intfDest;var intfKey=NgUtil.getValueFromObjAndPath(intfSrcOrDest,"intfInfo.intf.intfKeyObj.value");if(intfKey){var conditionInfos=createConditionInfos(NgUtil.getValueFromObjAndPath(intfSrcOrDest,"intfInfo.intfNotes"));intfNoteConditionObj[intfKey]=conditionInfos}}));$scope.intfNoteConditionObj=intfNoteConditionObj;dataViewEditMgr.setBackupEditingIntfDataViewNotes(intfNoteConditionObj)}();$scope.editDeviceShow&&$scope.setActiveInterface($scope.interfaceList&&$scope.interfaceList[0]);$scope.editLinkShow&&setSelected(dataViewEditMgr.editingDataViewLink);_.isEmpty($scope.interfaceList)&&($scope.disableInterface=!0);if($scope.editDeviceShow){$scope.dialogPos.left=(jQuery(window).width()-$element.width())/2;$scope.dialogPos.top=(jQuery(window).height()-$element.height())/2}if($scope.editLinkShow){$scope.dialogPos.left=(jQuery(window).width()-$element.width())/2;$scope.dialogPos.top=(jQuery(window).height()-$element.height())/2}$element.css({top:$scope.dialogPos.top,left:$scope.dialogPos.left})}function createConditionInfos(dataViewNotes){var conditionInfos=[];_.each(dataViewNotes,(function(dvnt){if(!dvnt.isCompound){var obj=DataViewHelper.formatNote(dvnt);conditionInfos.push({title:obj.title,content:obj.content,isCompound:!!obj.isCompound})}}));return conditionInfos}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.EditDeviceLabelCtrl",EditDeviceLabelCtrl);EditDeviceLabelCtrl.$inject=["$scope","$log","$element","$timeout","nb.netbrain.httpDeviceSrvc","nb.dataview.httpDataViewSrvc","nb.dataview.dataViewEditMgr","nb.systemmodel.deviceTypeMgrSrvc","nb.qmap.mapManagerSrvc","nb.dataview.applyDataViewSrvc"];function EditDeviceLabelCtrl($scope,$log,$element,$timeout,httpDeviceSrvc,httpDataViewSrvc,dataViewEditMgr,deviceTypeMgrSrvc,mapManagerSrvc,applyDataViewSrvc){$scope.showOverflowLabels=!1;$scope.isOverflowDivInitiated=!1;$scope.lsDataUnitFromQapp=[];$scope.toggleOverflowDiv=function(){if($scope.isOverflowDivInitiated)$scope.showOverflowLabels=!$scope.showOverflowLabels;else{$scope.isOverflowDivInitiated=!0;$timeout((function(){$scope.showOverflowLabels=!$scope.showOverflowLabels}),1)}};$scope.showSchemaOrValue="Schema";$element.css({top:$scope.$parent.$parent.$parent.editDeviceTop,left:$scope.$parent.$parent.$parent.editDeviceLeft});$scope.currDevice={};$scope.lsPosObj=[];$scope.lsPosObj.length=4;$scope.lsPosObj_overflow=[];$scope.lsPosObj_overflow.length=16;$scope.deviceJson=null;$scope.deviceId=null;$scope.devType=null;$scope.nodeIdentify=null;$scope.dataViewGroupId="";$scope.dataViewTaskInfoId="";$scope.devicePictureDirectory="";$scope.lsSchemaObjs=[];$scope.$on("edit-device-save",(function(){$scope.onOK()}));$scope.$on("edit-device-cancel",(function(){}));$scope.$on("edit-device-data-unit",(function(event,posData){$scope.$broadcast("edit-data-view-device-data-unit-edit-mode",posData)}));$scope.initDataViewInfo=function(){dataViewEditMgr.backupNodeData(dataViewEditMgr.editingDataViewDevice);$scope.deviceId=dataViewEditMgr.editingDataViewDevice.key;$scope.devType=dataViewEditMgr.editingDataViewDevice.devType;dataViewEditMgr.editingDataViewDevice.devNodeData&&($scope.nodeIdentify=dataViewEditMgr.editingDataViewDevice.devNodeData.nodeIdentify);$scope.activeMap=mapManagerSrvc.getActivePage();var compDevice=$scope.activeMap._getCompDeviceByKey($scope.deviceId);$scope.dataViewGroupId=dataViewEditMgr.editingDataView.ID;$scope.dataViewTaskInfoId=compDevice.getDataViewTaskInfoId()};$scope.initDeviceJson=function(deviceGuid){var arrDevIds=[];arrDevIds.push(deviceGuid);httpDeviceSrvc.getDevicesJsonByGuids(arrDevIds,null).then((function(arrDeviceJson){$scope.deviceJson=arrDeviceJson[0]}))};$scope.initDevicePicture=function(nDevType){var picId=deviceTypeMgrSrvc.getPictureIDByDevType(nDevType);null!=picId&&($scope.devicePictureDirectory="img/picture/"+picId+".png")};$scope.initDataUnitFromQapp=function(devId){$scope.activeMap=mapManagerSrvc.getActivePage();var dvDefinitionId=$scope.activeMap._getCompDeviceByKey(devId).getDataViewDefinitionId();httpDataViewSrvc.getDataUnitListByDefinitionId(null,dvDefinitionId,DataUnitBelongTo.devLevel).then((function(lsDataUnits){$scope.lsDataUnitFromQapp=lsDataUnits||[]}),(function(reason){}))};$scope.lsOverflowJson=null;$scope.initPositions=function(){var devPosList=dataViewEditMgr.editingDataViewDevice.dataViewData.devPosList;devPosList&&devPosList.forEach((function(posJson){var posName=posJson.posName;if("overflowPos"!==posName){var index=parseInt(posName.substring(posName.length-1))-1;$scope.lsPosObj[index]=new CDataViewLabelPosData(posJson)}else{$scope.overflowPosition=posJson;$scope.lsOverflowJson=posJson.extraData.overflowList;if($scope.lsOverflowJson&&$scope.lsOverflowJson.length>0)for(var i=0;i<$scope.lsOverflowJson.length;i++){var currOverflowPosJson=$scope.lsOverflowJson[i];var indexOverflow=parseInt(currOverflowPosJson.posName.substring(11))-1;indexOverflow<16?$scope.lsPosObj_overflow[indexOverflow]=new CDataViewLabelPosData(currOverflowPosJson):$scope.lsPosObj_overflow.push(new CDataViewLabelPosData(currOverflowPosJson))}}}))};$scope.initData=function(){var currDeviceNode=dataViewEditMgr.editingDataViewDevice;$scope.currDevice.hostName=currDeviceNode.hostName;$scope.currDevice.key=currDeviceNode.key;$scope.currDevice.devType=currDeviceNode.devType;$scope.initDataViewInfo();$scope.initDeviceJson($scope.currDevice.key);$scope.initDevicePicture($scope.currDevice.devType);$scope.initDataUnitFromQapp($scope.currDevice.key);$scope.initPositions();!function(){for(var i=0;i<$scope.lsPosObj.length;i++)if(!$scope.lsPosObj[i]){var pos=new CDataViewLabelPosData;pos.setPosName("devPos"+(i+1).toString());$scope.lsPosObj[i]=pos}for(var i2=0;i2<$scope.lsPosObj_overflow.length;i2++)if(!$scope.lsPosObj_overflow[i2]){var overflowPos=new CDataViewLabelPosData;overflowPos.setPosName("overflowPos"+(i2+1).toString());$scope.lsPosObj_overflow[i2]=overflowPos}}()};$scope.onOK=function(){var bIsModified=!1;for(var i=0;i<$scope.lsPosObj.length;i++)if($scope.lsPosObj[i].isModified()){bIsModified=!0;break}if(!bIsModified)for(var ii=0;ii<$scope.lsPosObj_overflow.length;ii++)if($scope.lsPosObj_overflow[ii].isModified()){bIsModified=!0;break}bIsModified||(bIsModified=function(){var deviceId=dataViewEditMgr.editingDataViewDevice.key;var conditionArray=$scope.deviceNoteConditionObj[deviceId];var backInitNotes=dataViewEditMgr.getBackupEditingDeviceDataViewNotes()[deviceId];return $scope.isNotesChanged(conditionArray,backInitNotes)}());var device=dataViewEditMgr.editingDataViewDevice;var deviceId=device.key;bIsModified||(bIsModified=dataViewEditMgr.getIntfPosListChangeState());if(bIsModified){var argDevPosList=[];$scope.lsPosObj.forEach((function(posObj){if(!posObj.isEmpty()){posObj.setDataViewId($scope.dataViewGroupId);argDevPosList.push(posObj.toJson())}}));var argDevPosList_overflow=[];$scope.lsPosObj_overflow.forEach((function(posObj){if(!posObj.isEmpty()){posObj.setDataViewId($scope.dataViewGroupId);argDevPosList_overflow.push(posObj.toJson())}}));if(argDevPosList_overflow.length>0){$scope.overflowPosition||($scope.overflowPosition={posName:"overflowPos",dataViewId:$scope.dataViewGroupId,posInfo:{dataUnitList:[],displayTemplate:"...",displayInfo:"...",isCustomize:!1,isLock:!1},labelNote:{},tagList:[],extraData:null});$scope.overflowPosition.extraData={overflowList:argDevPosList_overflow};argDevPosList.push($scope.overflowPosition)}$scope.activeMap=mapManagerSrvc.getActivePage();if(null!=$scope.activeMap){var conditionArray=$scope.deviceNoteConditionObj[deviceId];var oldNotes=NgUtil.getValueFromObjAndPath(dataViewEditMgr,"editingDataViewDevice.dataViewData.deviceNotes");var notes=_.chain(oldNotes).filter((function(on){return on.isCompound})).union(_.map(conditionArray,(function(noteInfo){return DataViewHelper.buildDataViewNoteData(noteInfo)}))).value();_.each(argDevPosList,(function(item){item.posName!==DataViewPosName.overflowPos&&!1===NgUtil.getValueFromObjAndPath(item,"posInfo.dataUnitList.0.valueEx.isVisiable")?item.posInfo.dataUnitList[0].valueEx.isVisiable=!0:item.posName===DataViewPosName.overflowPos&&_.each(item.extraData.overflowList,(function(item2){!1===NgUtil.getValueFromObjAndPath(item2,"posInfo.dataUnitList.0.valueEx.isVisiable")&&(item2.posInfo.dataUnitList[0].valueEx.isVisiable=!0)}))}));var currDataViewObj={deviceId:$scope.deviceId,dataViewGroupId:$scope.dataViewGroupId,dataViewTaskInfoId:$scope.dataViewTaskInfoId,devPosList:argDevPosList,deviceNotes:notes};dataViewEditMgr.addToUpdatedDevPosList(currDataViewObj);var netMapOperator=$scope.activeMap.getNetmapOperator();if(null!=netMapOperator){delete device.dataViewData.dataViewInfos;device.setDataViewGroupId($scope.dataViewGroupId);device.setDataViewTaskInfoId($scope.dataViewTaskInfoId);device.setDataViewType("dvManual");device.setDataViewName(dataViewEditMgr.editingDataView.name);netMapOperator.updateDeviceDataOnMap(currDataViewObj)}var dv=$scope.activeMap._netmapJsWrapper.getLastAppliedDataView();var dvgId=applyDataViewSrvc.getDataViewInfoId(dv);dv.isPreview&&applyDataViewSrvc.highLightDeviceDataUnits(dvgId,dataViewEditMgr.editingDataViewDevice,$scope.activeMap)}}};$scope.onClose=function(){$scope.$emit("editDeviceClose");$scope.$destroy()};$scope.onCancel=function(){dataViewEditMgr.editingDataViewDevice.dataViewData.devPosList=$scope.backupDeviceDataViewPosList};$scope.testPrint=function(){$log.debug($scope.lsPosObj)};$scope.addDeviceNote=function(){var deviceId=dataViewEditMgr.editingDataViewDevice.key;var conditionArray=$scope.deviceNoteConditionObj[deviceId];$scope.openNotePopup(1,conditionArray,(function(obj){$scope.deviceNoteConditionObj[deviceId]=obj.conditionArray}))};$scope.initData()}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.EditLinkLabelCtrl",EditLinkLabelCtrl);EditLinkLabelCtrl.$inject=["$scope","$q","$timeout","$log","$element","nb.dataview.httpDataViewSrvc","nb.dataview.dataViewEditMgr","nb.netbrain.httpDeviceSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.qmap.mapManagerSrvc","nb.dataview.applyDataViewSrvc"];function EditLinkLabelCtrl($scope,$q,$timeout,$log,$element,httpDataViewSrvc,dataViewEditMgr,httpDeviceSrvc,deviceTypeMgrSrvc,mapManagerSrvc,applyDataViewSrvc){var fromOrTo=null;$scope.toggleOverflowDiv=function(){if($scope.isOverflowDivInitiated)$scope.showOverflowLabels=!$scope.showOverflowLabels;else{$scope.isOverflowDivInitiated=!0;$timeout((function(){$scope.showOverflowLabels=!$scope.showOverflowLabels}),1)}};$scope.showSchemaOrValue="Schema";$scope.hostName="sample hostname";$scope.interfaceName="sample interface name";$scope.devicePictureDirectory="";$scope.conditionObj={};$scope.deviceGuid=null;$scope.edgeValue=null;$scope.initDataViewInfo=function(){var devId=dataViewEditMgr.editingDataViewDevice.key;$scope.activeMap=mapManagerSrvc.getActivePage();var compDevice=$scope.activeMap._getCompDeviceByKey(devId);dataViewEditMgr.backupDeviceDataViewData(compDevice);$scope.dataViewGroupId=dataViewEditMgr.editingDataView.ID;$scope.dataViewTaskInfoId=compDevice.getDataViewTaskInfoId()};$scope.initDevicePicture=function(nDevType){var picId=deviceTypeMgrSrvc.getPictureIDByDevType(nDevType);null!=picId&&($scope.devicePictureDirectory="img/picture/"+picId+".png")};$scope.initDataUnitFromQapp=function(devId){$scope.activeMap=mapManagerSrvc.getActivePage();var dvDefinitionId=$scope.activeMap._getCompDeviceByKey(devId).getDataViewDefinitionId();httpDataViewSrvc.getDataUnitListByDefinitionId(null,dvDefinitionId,DataUnitBelongTo.intfLevel).then((function(lsDataUnits){$scope.lsDataUnitFromQapp=lsDataUnits||[]}),(function(reason){}))};$scope.lsOverflowJson=null;$scope.initPositions=function(){var editingLink=dataViewEditMgr.editingDataViewLink;var intfPosList=("from"===fromOrTo?editingLink.intfSrc:editingLink.intfDest).intfInfo.intfPosList;if(intfPosList){$scope.backupDeviceDataViewPosList=angular.copy(intfPosList);intfPosList.forEach((function(posJson){var posName=posJson.posName;if("overflowPos"!==posName){var index=parseInt(posName.substring(posName.length-1));$scope.lsPosObj[index]=new CDataViewLabelPosData(posJson)}else{$scope.overflowPosition=posJson;$scope.lsOverflowJson=posJson.extraData.overflowList;if($scope.lsOverflowJson&&$scope.lsOverflowJson.length>0)for(var i=0;i<$scope.lsOverflowJson.length;i++){var currOverflowPosJson=$scope.lsOverflowJson[i];var indexOverflow=parseInt(currOverflowPosJson.posName.substring(11))-1;indexOverflow<16?$scope.lsPosObj_overflow[indexOverflow]=new CDataViewLabelPosData(currOverflowPosJson):$scope.lsPosObj_overflow.push(new CDataViewLabelPosData(currOverflowPosJson))}}}))}};$scope.$on("change-model-by-link",(function(){$scope.initData()}));$scope.$on("edit-link-save",(function(){$scope.onOK()}));$scope.$on("edit-link-cancel",(function(){}));$scope.$on("edit-link-data-unit",(function(event,posData){$scope.$broadcast("edit-data-view-link-data-unit-edit-mode",posData)}));$scope.initData=function(){var currLink=dataViewEditMgr.editingDataViewLink;if(dataViewEditMgr.editingDataViewLink){!function(){$scope.lsDataUnitFromQapp=[];fromOrTo=null;$scope.deviceId=dataViewEditMgr.editingDataViewDevice.key;$scope.devType=dataViewEditMgr.editingDataViewDevice.devType;$scope.deviceId===dataViewEditMgr.editingDataViewLink.from?fromOrTo="from":$scope.deviceId===dataViewEditMgr.editingDataViewLink.to?fromOrTo="to":$log.error("Error data on map!");$scope.nodeIdentify=null;"to"==fromOrTo?dataViewEditMgr.editingDataViewLink.intfDest&&dataViewEditMgr.editingDataViewLink.intfDest.intfInfo&&($scope.nodeIdentify=getIntfNodeIdentifyByIntfInfo(dataViewEditMgr.editingDataViewLink.intfDest.intfInfo)):dataViewEditMgr.editingDataViewLink.intfSrc&&dataViewEditMgr.editingDataViewLink.intfSrc.intfInfo&&($scope.nodeIdentify=getIntfNodeIdentifyByIntfInfo(dataViewEditMgr.editingDataViewLink.intfSrc.intfInfo));$scope.showOverflowLabels=!1;$scope.isOverflowDivInitiated=!1}();var intfInfo=("from"===fromOrTo?currLink.intfSrc:currLink.intfDest).intfInfo;var intf=intfInfo.intf;var intfDisplaySchemaObj=intf.intfDisplaySchemaObj;$scope.interfaceName=intfDisplaySchemaObj?intfDisplaySchemaObj.value:null;$scope.intfInfo=intfInfo;$scope.intfKeyObj=intf.intfKeyObj;$scope.intfKeySchema=$scope.intfKeyObj.schema;$scope.intfKeySchemaValue=$scope.intfKeyObj.value;$scope.lsPosObj=[new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData];for(var i=0;i<$scope.lsPosObj.length;i++)$scope.lsPosObj[i].setPosName("intfPos"+i.toString());$scope.lsPosObj_overflow=[new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData,new CDataViewLabelPosData];for(var i2=0;i2<$scope.lsPosObj_overflow.length;i2++)$scope.lsPosObj_overflow[i2].setPosName("overflowPos"+(i2+1).toString());var currDev=dataViewEditMgr.editingDataViewDevice;$scope.devType=currDev.devType;$scope.hostName=currDev.hostName;$scope.initDataViewInfo();$scope.initDevicePicture($scope.devType);$scope.initDataUnitFromQapp($scope.deviceId);$scope.initPositions()}};$scope.onOK=function(){dataViewEditMgr.setIntfPosListChangeState(!1);var bIsModified=!1;for(var i=0;i<$scope.lsPosObj.length;i++)if($scope.lsPosObj[i].isModified()){bIsModified=!0;break}if(!bIsModified)for(var ii=0;ii<$scope.lsPosObj_overflow.length;ii++)if($scope.lsPosObj_overflow[ii].isModified()){bIsModified=!0;break}bIsModified||(bIsModified=function(){var intfKey=$scope.intfKeyObj.value;var conditionArray=$scope.intfNoteConditionObj[intfKey];var backInitNotes=dataViewEditMgr.getBackupEditingIntfDataViewNotes()[intfKey];return $scope.isNotesChanged(conditionArray,backInitNotes)}());if(bIsModified){var argIntfsPosList=[];$scope.lsPosObj.forEach((function(posObj){if(!posObj.isEmpty()){posObj.setDataViewId($scope.dataViewGroupId);argIntfsPosList.push(posObj.toJson())}}));var argIntfsPosList_overflow=[];$scope.lsPosObj_overflow.forEach((function(posObj){if(!posObj.isEmpty()){posObj.setDataViewId($scope.dataViewGroupId);argIntfsPosList_overflow.push(posObj.toJson())}}));if(argIntfsPosList_overflow.length>0){$scope.overflowPosition||($scope.overflowPosition={posName:"overflowPos",posInfo:{dataUnitList:[],displayTemplate:"...",displayInfo:"...",isCustomize:!1,isLock:!1},labelNote:{},tagList:[],extraData:null});$scope.overflowPosition.extraData={overflowList:argIntfsPosList_overflow};argIntfsPosList.push($scope.overflowPosition)}if(null!=$scope.activeMap){var conditionArray=$scope.intfNoteConditionObj[$scope.intfKeyObj.value];var notes=_.map(conditionArray,(function(noteInfo){return DataViewHelper.buildDataViewNoteData(noteInfo)}));_.each(argIntfsPosList,(function(item){item.posName!==DataViewPosName.overflowPos&&!1===NgUtil.getValueFromObjAndPath(item,"posInfo.dataUnitList.0.valueEx.isVisiable")?item.posInfo.dataUnitList[0].valueEx.isVisiable=!0:item.posName===DataViewPosName.overflowPos&&_.each(item.extraData.overflowList,(function(item2){!1===NgUtil.getValueFromObjAndPath(item2,"posInfo.dataUnitList.0.valueEx.isVisiable")&&(item2.posInfo.dataUnitList[0].valueEx.isVisiable=!0)}))}));var currDataViewObj={deviceId:$scope.deviceId,dataViewGroupId:$scope.dataViewGroupId,dataViewTaskInfoId:$scope.dataViewTaskInfoId,intf:$scope.intfInfo.intf,intfGraphicInfo:$scope.intfInfo.intfGraphicInfo,intfPosList:argIntfsPosList,intfNotes:notes};dataViewEditMgr.addToUpdatedIntfPosList(currDataViewObj);dataViewEditMgr.setIntfPosListChangeState(!0);var netMapOperator=$scope.activeMap.getNetmapOperator();if(null!=netMapOperator){var editingLink=dataViewEditMgr.editingDataViewLink;var intfSrcOrDest;delete(intfSrcOrDest="from"===fromOrTo?editingLink.intfSrc:editingLink.intfDest).dataViewInfos;intfSrcOrDest.dataViewInfo.dataViewGroupId=$scope.dataViewGroupId;intfSrcOrDest.dataViewInfo.dataViewType="dvManual";intfSrcOrDest.dataViewInfo.name=dataViewEditMgr.editingDataView.name;netMapOperator.updateLinkDataOnMap(currDataViewObj,fromOrTo)}var dv=$scope.activeMap._netmapJsWrapper.getLastAppliedDataView();var dvgId=applyDataViewSrvc.getDataViewInfoId(dv);dv.isPreview&&applyDataViewSrvc.highLightDeviceDataUnits(dvgId,dataViewEditMgr.editingDataViewDevice,$scope.activeMap)}}};$scope.onCancel=function(){var editingLink=dataViewEditMgr.editingDataViewLink;var intfInfo=("from"===fromOrTo?editingLink.intfSrc:editingLink.intfDest).intfInfo;$scope.backupDeviceDataViewPosList&&(intfInfo.intfPosList=$scope.backupDeviceDataViewPosList)};$scope.onClose=function(){$scope.$emit("editLinkClose");$scope.$destroy()};$scope.addLinkNote=function(){var intfKey=$scope.intfKeyObj.value;if(intfKey){var conditionArray=$scope.intfNoteConditionObj[intfKey];$scope.openNotePopup(2,conditionArray,(function(obj){$scope.intfNoteConditionObj[intfKey]=obj.conditionArray}))}};function getIntfNodeIdentifyByIntfInfo(intfInfo){if(intfInfo&&intfInfo.intf){if(intfInfo.intf.intfNodeData&&intfInfo.intf.intfNodeData.nodeIdentify)return intfInfo.intf.intfNodeData.nodeIdentify;if(intfInfo.intf.intfKeyObj){var nodeIdentify={nbPathSchema:"",nbPathValue:""};var schema=intfInfo.intf.intfKeyObj.schema.split(".")[0];nodeIdentify.nbPathSchema=(dataViewEditMgr.isLegacyNodeSchema(schema)?NetBrain.Common.Const.LegacySchema.Legacy+".":"")+schema;nodeIdentify.nbPathValue=intfInfo.intf.intfKeyObj.value;return nodeIdentify}}return null}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.addLabelLinkPopupCtrl",AddLabelLinkPopupCtrl);AddLabelLinkPopupCtrl.$inject=["$scope","$log","$uibModalInstance","args"];function AddLabelLinkPopupCtrl($scope,$log,$uibModalInstance,args){$scope.isDeviceLabel=args.isDeviceLabel;$scope.strLabel=args.label;$scope.strHyperlink=args.link&&args.link.length>=7?args.link.substring(7):null;$scope.labelValidationOption={method:"watch",rules:[{ruleId:"required",errorMessage:"Please enter Label."},{ruleId:"maxLength",params:{length:128},errorMessage:"The Label cannot exceed 128 characters"},{ruleId:"generalForbidChars",errorMessage:"Label cannot contain special characters."}]};$scope.labelValidationResult={result:!0};$scope.onOK=function(){$scope.strHyperlink=$scope.strHyperlink?$scope.strHyperlink.trim():null;if($scope.strHyperlink){"http://"===$scope.strHyperlink.substring(0,7)&&($scope.strHyperlink=$scope.strHyperlink.substring(7));"https://"===$scope.strHyperlink.substring(0,8)&&($scope.strHyperlink=$scope.strHyperlink.substring(7));$scope.strHyperlink="http://"+$scope.strHyperlink}$uibModalInstance.close([$scope.strLabel,$scope.strHyperlink])};$scope.onCancel=function(){$uibModalInstance.dismiss()}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.addAttachmentPopupCtrl",AddAttachmentPopupCtrl);AddAttachmentPopupCtrl.$inject=["$scope","$timeout","$q","$upload","$log","$uibModalInstance","nb.dataview.httpDataViewSrvc","nb.common.nbAlertSrvc","nb.ng.httpAuthSrvc","nb.ng.utilitySrvc","nb.ng.inputFileSrvc","args"];function AddAttachmentPopupCtrl($scope,$timeout,$q,$upload,$log,$uibModalInstance,httpDataViewSrvc,nbAlertSrvc,httpAuthSrvc,utilitySrvc,inputFileSrvc,args){$scope.fileName=args.fileName;$scope.displayName=args.displayName;$scope.fileGuid=args.fileGuid;$scope.fileType=args.fileType;$scope.dvgId=args.dvgId;var file=null;var isModified=!1;$scope.onSelectFile=function(){inputFileSrvc.createInputFile({fileType:"dataviewAttachment",scope:$scope,fileChange:"onFileSelect"})};$scope.limitLen=function(num){$scope.displayName=$scope.displayName.slice(0,num)};$scope.labelValidationOption={method:"watch",rules:[{ruleId:"required",errorMessage:"Please enter Label."},{ruleId:"generalForbidChars",errorMessage:"Display name cannot contain special characters."}]};$scope.labelValidationResult={result:!0};$scope.onFileSelect=function(files){if(file=files[0]){if(".exe"!==file.name.substring(file.name.length-4)){isModified=!0;$scope.fileName=file.name;$scope.displayName=file.name;var targetIndex=$scope.displayName.lastIndexOf(".");$scope.displayName=$scope.displayName.substring(0,targetIndex);$scope.fileType=file.type;$timeout((function(){$("#attachementFileDisplay").focus()}),500)}else{file=null;nbAlertSrvc.error({message:"Failed to upload the file: the EXE format is not supported."})}}};$scope.uploadFile=function(){var dataSrc=httpAuthSrvc.getDataSrc(utilitySrvc);var headers={TenantGuid:dataSrc.TenantGuid,DomainGuid:dataSrc.DomainGuid};var importUrl=NetBrain.NG.ConfigSettings.API_ROOT+"dataview/attchment/addAttachment/"+$scope.dvgId;$scope.upload=$upload.upload({url:importUrl,method:"POST",headers:headers,file:file,fileName:file.name}).progress((function(evt){})).success((function(resData,status,headers,config){var re=resData.data;if(re.result){nbAlertSrvc.notification({message:"Successfully uploaded the file."});$scope.fileGuid=re.fileId;$uibModalInstance.close({fileName:$scope.fileName,displayName:$scope.displayName,fileGuid:$scope.fileGuid,fileType:$scope.fileType})}else if(0===config.file.size){nbAlertSrvc.error({message:"Upload Failed: empty file."});$uibModalInstance.dismiss()}else{nbAlertSrvc.error({message:"Failed to upload the file. Please refer to related logs for details."});$uibModalInstance.dismiss()}})).error((function(data,status,headers,config){nbAlertSrvc.error({message:"Failed to upload the file. Please try again."});$uibModalInstance.dismiss()}))};$scope.onOK=function(){isModified?$scope.uploadFile():$uibModalInstance.close({fileName:$scope.fileName,displayName:$scope.displayName,fileGuid:$scope.fileGuid,fileType:$scope.fileType})};$scope.onCancel=function(){$uibModalInstance.dismiss()}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.formatNotePopupCtrl",FormatNotePopupCtrl);FormatNotePopupCtrl.$inject=["$scope","$log","$uibModalInstance","args"];function FormatNotePopupCtrl($scope,$log,$uibModalInstance,args){$scope.isEditMode=!(!args||void 0===args.isEditMode)&&args.isEditMode;var nodeTitle=args&&args.title?args.title:"";$scope.node={title:nodeTitle};$scope.titleOrigText=args&&args.titleOrigText?args.titleOrigText:"";$scope.content=args&&args.content&&""!==args.content?args.content:null;$scope.contentOrigText=args&&args.contentOrigText&&""!==args.contentOrigText?args.contentOrigText:null;$scope.labelValidationOption={method:"watch",rules:[{ruleId:"generalForbidChars",errorMessage:"Label cannot contain special characters."}]};$scope.labelValidationResult={result:!0};$scope.limitLen=function(num,node){node.title=node.title.slice(0,num)};$scope.onOK=function(){if($scope.isEditMode){$scope.contentOrigText=angular.copy($scope.content);$scope.contentOrigText=String($scope.contentOrigText).replace(/<[^>]+>/gm,"");$uibModalInstance.close({title:$scope.node.title,titleOrigText:$scope.titleOrigText,content:$scope.content,contentOrigText:$scope.contentOrigText})}else $scope.onCancel()};$scope.onCancel=function(){$uibModalInstance.dismiss()}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.multiMapNotePopupCtrl",MultiMapNotePopupCtrl);MultiMapNotePopupCtrl.$inject=["$scope","$log","$uibModalInstance","args","nb.ng.utilitySrvc","nb.common.nbAlertSrvc"];function MultiMapNotePopupCtrl($scope,$log,$uibModalInstance,args,utilitySrvc,nbAlertSrvc){$scope.$on("multi-condition-init-completed",(function(event,condition){updateNoteInfo(condition)}));$scope.$on("multi-condition-selected",(function(event,condition){updateNoteInfo(condition)}));var MapNoteCondition=netBrain.DataView.MapNoteCondition;var noteStr=1===args.noteType?"Device":"Interface";var addConditionBtnLabel="Add "+noteStr+" Note";var defaultConditionName=noteStr+" Note";$scope.titleName=noteStr+" Note";var conditionList=_.map(args.conditionArray,(function(item,index){var con=new MapNoteCondition(defaultConditionName+(index+1));con.setNoteInfo(item);return con}));$scope.conditionInfo={conditionList:conditionList,initConditionIndex:0,defaultConditionName:defaultConditionName,addConditionBtnLabel:addConditionBtnLabel,enableRename:!1,emptyConditionName:"Select Note",buildConditionFun:function(name){return new MapNoteCondition(name)}};$scope.noteTitleValidator={method:"blur",errorTipPosition:"top",rules:[{ruleId:"required"},{ruleId:"maxLength",params:{length:128}}]};$scope.noteContentValidator={method:"blur",rules:[{ruleId:"required",errorMessage:"Please enter note content."}]};var CHECK_NOTE_WORDING_title_empty="{0} note title is empty.",CHECK_NOTE_WORDING_title_duplicated="{0} note title({1}) duplicated.";$scope.onOK=function(){var validConditions=_.map($scope.conditionInfo.conditionList,(function(con){return con.toJSON()}));if(notes=validConditions,_.every(notes,(function(note){return note.title&&note.title.trim()}))){var notes;var duplicateNoteTitle=function(notes){var duplicateNotes=_.filter(_.groupBy(notes,"title"),(function(g){return g.length>1}));if(duplicateNotes.length>0)return duplicateNotes[0][0].title;return""}(validConditions);duplicateNoteTitle?nbAlertSrvc.error(utilitySrvc.formatString(CHECK_NOTE_WORDING_title_duplicated,noteStr,duplicateNoteTitle)):$uibModalInstance.close({conditionArray:validConditions})}else nbAlertSrvc.error(utilitySrvc.formatString(CHECK_NOTE_WORDING_title_empty,noteStr))};$scope.onCancel=function(){$uibModalInstance.dismiss()};function updateNoteInfo(condition){$scope.note=condition.getNoteInfo();$scope.$broadcast("clear-validation")}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.createMapDataViewDialogCtrl",CreateMapDataViewDialogCtrl);CreateMapDataViewDialogCtrl.$inject=["$rootScope","$scope","$uibModal","$uibModalInstance","$log","$parse","$q","$timeout","ivhTreeviewMgr","nb.dataview.httpDataViewManagerSrvc","nb.ng.nbValidationSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.ng.utilitySrvc","nb.common.nbAlertSrvc","mapInfo","nb.qmap.mapManagerSrvc","nb.systemmodel.httpDeviceIconSrvc"];function CreateMapDataViewDialogCtrl($rootScope,$scope,$uibModal,$uibModalInstance,$log,$parse,$q,$timeout,ivhTreeviewMgr,httpDataViewManagerSrvc,nbValidationSrvc,deviceTypeMgrSrvc,utilitySrvc,nbAlertSrvc,mapInfo,mapManagerSrvc,httpDeviceIconSrvc){$scope.ivhTreeOptions={defaultSelectedState:!1,validate:!0,expandToDepth:1,labelAttribute:"name",idAttribute:"ID",childrenAttribute:"child",expandedAttribute:"expended",useCheckboxes:!1,twistieLeafTpl:""};$scope.pathSeparator=" > ";$scope.dataViewGroupScopes=[{key:DataViewGroupScope.dvgScopeGlobal,name:"Global Data View",label:"Static Data View",info:"Static Data View will show up in whichever maps the devices appear."},{key:DataViewGroupScope.dvgScopeMap,name:"Map Data View",label:"Map Data View",info:"Map Data View can only be visible in the current map."}];$scope.saveWithData=!!mapInfo.saveWithData;$scope.mapInfo=mapInfo;$scope.devices=$scope.mapInfo.devices;$scope.mapId=$scope.mapInfo.mapId;!function(){var currentPage=mapManagerSrvc.getActivePage();currentPage.currentScopeRef;var allLinks=currentPage._getAllTopoLink();for(var i=0;i<$scope.devices.length;i++){var deviceData=$scope.devices[i];if(deviceData.dataViewData){var allFromSelfLinks=_.filter(allLinks,(function(link){return link.from===deviceData.key}));for(var p=0;p<allFromSelfLinks.length;p++)if(deviceData.dataViewData){deviceData.dataViewData.intfInfoList=deviceData.dataViewData.intfInfoList||[];var index=_.findIndex(deviceData.dataViewData.intfInfoList,(function(intfInfo){return intfInfo&&intfInfo.intfDataView?intfInfo.intfDataView.intfInfo.intf.intfKeyObj.value===allFromSelfLinks[p].intfSrc.intfInfo.intf.intfKeyObj.value:!!(intfInfo&&intfInfo.intf&&intfInfo.intf.intfKeyObj)&&intfInfo.intf.intfKeyObj.value===allFromSelfLinks[p].intfSrc.intfInfo.intf.intfKeyObj.value}));allFromSelfLinks[p].intfSrc&&allFromSelfLinks[p].intfSrc.intfInfo&&(index<0?deviceData.dataViewData.intfInfoList.push(allFromSelfLinks[p].intfSrc.intfInfo):allFromSelfLinks[p].intfSrc.dataViewInfo.dataViewType===DataViewType.dvDefault&&(deviceData.dataViewData.intfInfoList[index]=allFromSelfLinks[p].intfSrc.intfInfo))}var allToSelfLinks=_.filter(allLinks,(function(link){return link.to===deviceData.key}));for(p=0;p<allToSelfLinks.length;p++)if(deviceData.dataViewData){deviceData.dataViewData.intfInfoList=deviceData.dataViewData.intfInfoList||[];index=_.findIndex(deviceData.dataViewData.intfInfoList,(function(intfInfo){return intfInfo&&intfInfo.intfDataView?intfInfo.intfDataView.intfInfo.intf.intfKeyObj.value===allToSelfLinks[p].intfDest.intfInfo.intf.intfKeyObj.value:!!(intfInfo&&intfInfo.intf&&intfInfo.intf.intfKeyObj)&&intfInfo.intf.intfKeyObj.value===allToSelfLinks[p].intfDest.intfInfo.intf.intfKeyObj.value}));allToSelfLinks[p].intfDest&&allToSelfLinks[p].intfDest.intfInfo&&(index<0?deviceData.dataViewData.intfInfoList.push(allToSelfLinks[p].intfDest.intfInfo):allToSelfLinks[p].intfSrc.dataViewInfo.dataViewType===DataViewType.dvDefault&&(deviceData.dataViewData.intfInfoList[index]=allToSelfLinks[p].intfDest.intfInfo))}}}}();$scope.dataViewDefinition={name:"",description:"",scopeInfo:{type:DataViewGroupScope.dvgScopeGlobal}};function setSelectedPath(selectedFolder){if(selectedFolder&&$scope.mapDataView){$scope.mapDataView.folderId=selectedFolder.ID;$scope.dataViewDefinition.folderName=selectedFolder.name;var folderPath="";selectedFolder.path&&selectedFolder.path.length>0&&(folderPath=selectedFolder.path+$scope.pathSeparator);$scope.dataViewDefinition.path=folderPath+selectedFolder.name}}$scope.selectAllDeviceFlag=!0;$scope.nameValidator={method:"blur",rules:[{ruleId:"required",errorMessage:"Please enter a data view name."},{ruleId:"generalForbidChars",errorMessage:"Data view name cannot have special characters "+nbValidationSrvc.getGeneralForbidChars()+"."},{ruleId:"maxLength",params:{length:96},errorMessage:"A data view name cannot exceed 96 characters."}]};$scope.pathValidator={method:"blur",rules:[{ruleId:"required",errorMessage:"Data view path is required."}]};$scope.descriptionValidator={method:"blur",rules:[{ruleId:"maxLength",params:{length:1024},errorMessage:"The description field should be less than 1024 characters"}]};$scope.folderTree=null;$scope.getDataViewTree=function(){var dataViewTreeType=DataViewTreeType.GlobalDataView;$scope.dataViewDefinition.scopeInfo.type===DataViewGroupScope.dvgScopeMap&&(dataViewTreeType=DataViewTreeType.MapDataView);httpDataViewManagerSrvc.getDataViewTreeRoot(null,dataViewTreeType,$scope.mapId).then((function(root){root&&setSelectedPath(root)}))};$scope.initData=function(){$scope.initDeviceData()};$scope.initDeviceData=function(){$scope.deviceList=[];_.pluck($scope.devices,"key");var lsNodeIds=_.map($scope.devices,(function(dev){return dev.getVSNodeIdentify()}));httpDataViewManagerSrvc.areDevicesExisting(lsNodeIds).then((function(result){if(result){angular.forEach($scope.devices,(function(device){if(1024!==device.devType&&device.dataViewData&&(device.dataViewData.dataViewInfo||device.dataViewData.dataViewInfos)){var dataViewInfo=null;dataViewInfo=device.dataViewData.dataViewInfo?device.dataViewData.dataViewInfo:_.last(device.dataViewData.dataViewInfos);var deviceDvgObj={devId:device.key,name:device.hostName,deviceType:device.devType,dataViewDefinitionId:dataViewInfo.dataViewDefinitionId,taskInfoId:dataViewInfo.taskInfoId,dataViewGroupId:dataViewInfo.dataViewGroupId};$scope.deviceList.push(deviceDvgObj)}}));$scope.setDeviceIcons();$scope.mapDataView={folderId:"",dataViewGroup:$scope.dataViewDefinition,deviceList:$scope.deviceList};$scope.saveWithData&&($scope.mapDataView.deviceDataViewData=$scope.devices);httpDataViewManagerSrvc.getDataViewTreeRoot(null,DataViewTreeType.GlobalDataView,null).then((function(root){setSelectedPath(root)}));$scope.selectAllDevices()}}),(function(error){}))};$scope.setDeviceIcons=function(){angular.forEach($scope.deviceList,(function(device){device.imgIcon=httpDeviceIconSrvc.getIconStreamURIBy2Id(device.deviceType,device.oid)}))};$scope.selectAllDevices=function(){angular.forEach($scope.deviceList,(function(device){device.isSelected=$scope.selectAllDeviceFlag;device.dataViewType=DataViewType.dvManual}))};$scope.selectFolder=function(){$uibModal.open({templateUrl:"modules/nbDataView/views/nbDataViewTreeModal.html",controller:"nb.dataview.nbDataViewTreeModalCtrl",windowClass:"selectDataViewFolder",backdrop:"static",resolve:{dialogOption:{showMenu:!0,option:{filterSchedulerId:"907d6a11-3607-4d1e-a173-f10edf585022"}}}}).result.then((function(selectedFolder){setSelectedPath(selectedFolder)}))};$scope.treeNodeSelect=function(folder,trvw){if(folder.clicked){$scope.mapDataView.folderId=folder.ID;$scope.dataViewDefinition.folderName=folder.name;$scope.dataViewDefinition.path=folder.path}};$scope.onSelectDevices=function(){$scope.selectAllDeviceFlag=!$scope.selectAllDeviceFlag;$scope.selectAllDevices()};$scope.onSave=function(){nbValidationSrvc.submit("mapDataViewForm").then((function(){var dvgName=$scope.dataViewDefinition.name;$scope.dataViewDefinition.scopeInfo.type,DataViewGroupScope.dvgScopeMap;var parentId=$scope.mapDataView.folderId;httpDataViewManagerSrvc.getDataViewTreeLeafNodeByName(null,parentId,dvgName).then((function(dvgInDb){if(dvgInDb)if(dvgInDb.scopeInfo.dataViewType===DataViewType.dvDynamic)nbAlertSrvc.warning("A data view with duplicate name already exists in this location. Please use a different name.");else{var options={title:"Warning",iconType:NB_ICON_WARNING,message:"This destination already contains a Data View with the same name. Do you want to overwrite it?",buttons:[{id:NB_CONFIRM_YES,label:"Overwrite "},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(options).then((function(){$scope.dataViewDefinition.ID=dvgInDb.ID;$scope.saveDataViewData(!0)}))}}),(function(reason){$scope.saveDataViewData(!1)}))}))};$scope.saveDataViewData=function(needMerge){var selectedDevices=[];angular.forEach($scope.deviceList,(function(device){device.isSelected&&selectedDevices.push(device)}));nbValidationSrvc.submit("mapDataViewForm").then((function(){if(0===selectedDevices.length)nbAlertSrvc.warning({message:"Please select devices to add to the data view."});else{$scope.mapDataView.deviceList=selectedDevices;$scope.dataViewDefinition.scopeInfo.type===DataViewGroupScope.dvgScopeMap&&($scope.dataViewDefinition.scopeInfo.mapId=$scope.mapId);$scope.saveWithData?$scope.saveAsDataViewFromMap(selectedDevices,needMerge):$scope.saveNewDataView(needMerge)}}),(function(){$log.log("There are invalid input in the form.")}))};$scope.saveAsDataViewFromMap=function(selectedDevices,needMerge){var deviceDvDataList=[];var allLinks=mapManagerSrvc.getActivePage()._getAllTopoLink();angular.forEach(selectedDevices,(function(selectedDevice){for(var i=0;i<$scope.devices.length;i++){var deviceData=$scope.devices[i];if(deviceData.dataViewData&&selectedDevice.devId===deviceData.key){var dataViewData=deviceData.getJsData();deviceData._netmap&&(deviceData._netmap=null);if(dataViewData.dataViewData&&dataViewData.dataViewData.intfInfoList&&_.isArray(dataViewData.dataViewData.intfInfoList))for(var j=0;j<dataViewData.dataViewData.intfInfoList.length;j++)if(dataViewData.dataViewData.intfInfoList[j].intfInfo){_.extend(dataViewData.dataViewData.intfInfoList[j],dataViewData.dataViewData.intfInfoList[j].intfInfo);delete dataViewData.dataViewData.intfInfoList[j].intfInfo}var allFromSelfLinks=_.filter(allLinks,(function(link){return link.from===deviceData.key}));for(var p=0;p<allFromSelfLinks.length;p++)if(dataViewData.dataViewData){dataViewData.dataViewData.intfInfoList=dataViewData.dataViewData.intfInfoList||[];_.some(dataViewData.dataViewData.intfInfoList,(function(intfInfo){return intfInfo&&intfInfo.intfDataView?intfInfo.intfDataView.intfInfo.intf.intfKeyObj.value===allFromSelfLinks[p].intfSrc.intfInfo.intf.intfKeyObj.value:!!(intfInfo&&intfInfo.intf&&intfInfo.intf.intfKeyObj)&&intfInfo.intf.intfKeyObj.value===allFromSelfLinks[p].intfSrc.intfInfo.intf.intfKeyObj.value}))||allFromSelfLinks[p].intfSrc&&allFromSelfLinks[p].intfSrc.intfInfo&&dataViewData.dataViewData.intfInfoList.push(allFromSelfLinks[p].intfSrc.intfInfo)}var allToSelfLinks=_.filter(allLinks,(function(link){return link.to===deviceData.key}));for(p=0;p<allToSelfLinks.length;p++)if(dataViewData.dataViewData){dataViewData.dataViewData.intfInfoList=dataViewData.dataViewData.intfInfoList||[];_.some(dataViewData.dataViewData.intfInfoList,(function(intfInfo){return intfInfo&&intfInfo.intfDataView?intfInfo.intfDataView.intfInfo.intf.intfKeyObj.value===allToSelfLinks[p].intfDest.intfInfo.intf.intfKeyObj.value:!!(intfInfo&&intfInfo.intf&&intfInfo.intf.intfKeyObj)&&intfInfo.intf.intfKeyObj.value===allToSelfLinks[p].intfDest.intfInfo.intf.intfKeyObj.value}))||allToSelfLinks[p].intfDest&&allToSelfLinks[p].intfDest.intfInfo&&dataViewData.dataViewData.intfInfoList.push(allToSelfLinks[p].intfDest.intfInfo)}deviceDvDataList.push(dataViewData);break}}}));$scope.mapDataView.deviceList=deviceDvDataList;httpDataViewManagerSrvc.saveAsDataViewFromMap(null,$scope.mapDataView,needMerge).then((function(newDataView){if(newDataView){newDataView.path=newDataView.path||$scope.mapDataView.path||$scope.mapDataView.dataViewGroup.path;nbAlertSrvc.notification({message:"Successfully saved the data view."});$rootScope.$emit(NetBrain.Map.Event.MapDataViewListChanged);$uibModalInstance.close(newDataView)}else nbAlertSrvc.error({message:"Failed to save the data view."})}),(function(reason){$log.log("create data view failed: "+reason);nbAlertSrvc.error({message:"Can't save the Data View. <br>"+utilitySrvc.getErrorMessage(reason)})}))};$scope.saveNewDataView=function(needMerge){httpDataViewManagerSrvc.createDataViewFromMap(null,$scope.mapDataView,needMerge).then((function(newDataView){nbAlertSrvc.notification({message:"Successfully saved the data view."});$rootScope.$emit("refreshDataViewList");$uibModalInstance.close(newDataView)}),(function(reason){$log.log("create data view failed: "+reason);nbAlertSrvc.error({message:"Can't save the Data View. <br>"+utilitySrvc.getErrorMessage(reason)})}))};$scope.onCancel=function(){$uibModalInstance.dismiss("Cancel Button Clicked!")};$scope.changeDataViewType=function(){$scope.dataViewDefinition.scopeInfo.type===DataViewGroupScope.dvgScopeMap&&($scope.dataViewDefinition.scopeInfo.mapId=$scope.mapId);$scope.getDataViewTree()};$scope.initData()}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.nbOverflowDataModalCtrl",OverflowDataModalCtrl);OverflowDataModalCtrl.$inject=[];function OverflowDataModalCtrl(){}}(NetBrain);!function(netbrain){angular.module("nb.dataview").directive("nbDataElementDetailsPaneDirective",Directive);Directive.$inject=["$document"];function Directive(){var directive={restrict:"EA",templateUrl:"modules/nbDataView/dataElementDetails/views/nbDataElementDetailsPaneDirective.html",controller:controller,replace:!0,scope:{paneOption:"="},link:function(){}};controller.$inject=["$compile","$scope","$document","$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.netbrain.httpDeviceSrvc","nb.common.nbTipSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","uiGridTreeBaseService","$uibModal","nb.common.nbDragDropSrvc","nb.uiframework.urlStateMgr","nb.dataview.dataElementDetailsSrvc","nb.dataview.detailDrillDownLabelSrvc","nb.goldenbaseline.goldenBaselineConsts","nb.common.nbAlertSrvc","ivhTreeviewMgr"];function controller($compile,$scope,$document,element,attr,$timeout,$rootScope,$q,mapManagerSrvc,httpDeviceSrvc,nbTipSrvc,mapContextMenuManager,updateMapSrvc,uiGridTreeBaseService,$uibModal,nbDragDropSrvc,urlStateMgr,dataElementDetailsSrvc,detailDrillDownLabelSrvc,goldenBaselineConsts,nbAlertSrvc,ivhTreeviewMgr){var EventType=NetBrain.DataView.ElementConst.EventType;var loading=!1;var paneOption=$scope.paneOption;var option=$scope.paneOption;var detailsSrvc=dataElementDetailsSrvc;var Const=dataElementDetailsSrvc.dataElementConst;$scope.VariablePaneType=Const.VariablePaneType;var dataUnitSet={devUnitData:{},intfUnitData:{}};$scope.Wording={noDataText:Const.Wording.noDataText,noHistoryDataTextWording:Const.Wording.noHistoryDataTextWording,pleaseSelectVariable:Const.Wording.pleaseSelectVariable};$scope.viewModel={icon:"default-dataview-14",title:"",deviceIcon:"img/icon/Cisco Router.png",deviceList:[],selectedDevice:{},currentVariableType:Const.VariableType.none,currentVariablePaneType:Const.VariablePaneType.none,devUnitData:[],intfUnitData:[],pageId:"",currentTabId:0,mode:0,noDevice:!1,unload:!1,paneStyle:{},DetailPaneMode:Const.DetailPaneMode,forceRealDev:!1};var extendData=null;var currentSelectedNode=null;var deviceDataOption=null;var interfaceDataOption=null;$scope.ivhTreeDevDataOptions={defaultSelectedState:!1,expandToDepth:1,idAttribute:"id",labelAttribute:"name",enableMultipleSelect:!1,enableLabelExpand:!1,iconTemplate:function(node){var hasAlert=node.dataUnit.alarm===Const.DataUnitAlarmValue;var divObj=detailsSrvc.getVariableIcon(hasAlert,node.dataUnit.type,node.dataUnit.valueType);divObj.isElse&&console.warn("Failed to get icon. type is: ",node.dataUnit.type,", valueType is: ",node.dataUnit.valueType,", variable name is: ",node.name,".");var div=divObj.icon;var vId=node.posName+node.id;var encodeVId=Const.htmlEncodeByRegExp(vId);return StringUtil.format(div,{tag:encodeVId})},nodeClickCallback:function(node,trvw){currentSelectedNode=node;refreshByNode(node,$scope.viewModel.mode)}};$scope.ivhTreeIntfDataOptions={defaultSelectedState:!1,validate:!0,expandToDepth:0,idAttribute:"id",labelAttribute:"name",enableMultipleSelect:!1,enableLabelExpand:!1,iconTemplate:function(node){var hasAlert=node.dataUnit.alarm===Const.DataUnitAlarmValue;var divObj=detailsSrvc.getVariableIcon(hasAlert,node.dataUnit.type,node.dataUnit.valueType);divObj.isElse&&console.warn("Failed to get icon. type is: ",node.dataUnit.type,", valueType is: ",node.dataUnit.valueType,", variable name is: ",node.name,".");var div=divObj.icon;var vId=node.pId+node.posName+node.id;var encodeVId=Const.htmlEncodeByRegExp(vId);return StringUtil.format(div,{tag:encodeVId})},nodeClickCallback:function(node,trvw){currentSelectedNode=node;refreshByNode(node,$scope.viewModel.mode)}};function refreshByNode(node,mode){var devKey=$scope.viewModel.selectedDevice.devKey;var devType=$scope.viewModel.selectedDevice.devType;var hostName=$scope.viewModel.selectedDevice.hostName;refreshVariablePane({dataUnit:node.dataUnit,dataViewInfo:option.dataViewInfo,devKey:devKey,devType:devType,hostName:hostName,intfKeyObj:node.dataUnit.intfKey,mode:mode,posName:node.posName,unitShowName:node.name,variableType:""})}function refreshVariablePane(pOption){var dataUnit=pOption.dataUnit;var varType=detailsSrvc.getVariableType(dataUnit.type,dataUnit.valueType);var varPaneType=detailsSrvc.getVariablePaneType(dataUnit.type,dataUnit.valueType,dataUnit.uId);$scope.viewModel.currentVariableType=varType;$scope.viewModel.currentVariablePaneType=varPaneType;var dataViewShowName=function(){var showName="";extendData&&extendData.extendDataViewData&&extendData.extendDataViewData.dataViewName&&(showName=extendData.extendDataViewData.dataViewName);extendData&&extendData.extendRunbookData&&extendData.extendRunbookData.runbookNodeName&&(showName=extendData.extendRunbookData.runbookNodeName);extendData&&extendData.extendRunbookData&&extendData.extendRunbookData.runbookNodeResultName&&(showName+=" - "+extendData.extendRunbookData.runbookNodeResultName);if(option.mode===Const.DetailPaneMode.Map){var appliedDvInfo=dataElementDetailsSrvc.getAppliedDataViewInfo();appliedDvInfo&&(showName=appliedDvInfo.dvName)}return showName}();$timeout((function(){try{if(pOption.dataUnit){pOption.forceRealDev=$scope.viewModel.forceRealDev;pOption.variableType=varType;pOption.dataUnit.requestFrom=pOption.mode;!function(pOption){var pOptionData={handle:function(){},dataUnit:pOption.dataUnit,dataViewInfo:option.dataViewInfo,devKey:pOption.devKey,devType:pOption.devType,forceRealDev:pOption.forceRealDev,hostName:pOption.hostName,intfKeyObj:pOption.dataUnit.intfKey,mode:pOption.mode,posName:pOption.posName,queryParams:pOption.queryParams,unitShowName:pOption.unitShowName,variableType:pOption.variableType};$scope.$broadcast(Const.Event.INIT_VARIABLE_PANE,pOptionData)}(pOption);$scope.$broadcast(Const.Event.SHOW_VARIABLE_LOADING);var duration=Const.getTimeAroundDuration();detailDrillDownLabelSrvc.loadSubPaneData(pOption,duration).then((function(obj){obj.gb&&obj.gb.error&&obj.gb.errorMsg&&nbAlertSrvc.alert(obj.gb.errorMsg);!function(obj){$scope.$broadcast(Const.Event.SHOW_VARIABLE_DATA,obj)}(obj)}));var userFilter=Const.getTimeListUserFilter();detailDrillDownLabelSrvc.loadSubPaneTimeList(pOption,null,userFilter).then((function(obj){!function(obj,dataViewShowName){$scope.$broadcast(Const.Event.SHOW_VARIABLE_TIME,obj,dataViewShowName)}(obj,dataViewShowName)}))}}catch(ex){console.warn(ex)}}),5);0===$scope.viewModel.currentTabId&&(deviceDataOption=pOption);1===$scope.viewModel.currentTabId&&(interfaceDataOption=pOption);setDataViewContent(pOption.mode);option.variableList&&(pOption.variableList=option.variableList);option.title&&(pOption.title=option.title);option=pOption}$scope.onToggleDevice=function(){};function setCurrentNode(changedDevice){var currentNode=null;if(0===$scope.viewModel.currentTabId&&deviceDataOption){var devUnitData=$scope.viewModel.devUnitData;var dUId=deviceDataOption.dataUnit.uId;var dPosName=deviceDataOption.posName;(currentNode=detailsSrvc.getNodeByPosName(devUnitData,dUId,dPosName))&&detailsSrvc.setSelectedStatus(devUnitData,currentNode.id,currentNode.posName)}if(1===$scope.viewModel.currentTabId&&interfaceDataOption){var intfKeyObj=interfaceDataOption.dataUnit.intfKey;var index=_.findIndex($scope.viewModel.intfUnitData,{id:intfKeyObj.value});var intfUnitData=[];intfUnitData=index>=0?[$scope.viewModel.intfUnitData[index]]:$scope.viewModel.intfUnitData.length>0?[$scope.viewModel.intfUnitData[0]]:$scope.viewModel.intfUnitData;var iUId=interfaceDataOption.dataUnit.uId;var iPosName=interfaceDataOption.posName;(currentNode=detailsSrvc.getNodeByPosName(intfUnitData,iUId,iPosName))&&detailsSrvc.setSelectedStatus(intfUnitData,currentNode.id,currentNode.posName)}if(currentNode){if(changedDevice){deviceDataOption=!1;interfaceDataOption=!1}refreshByNode(currentNode,$scope.viewModel.mode);currentSelectedNode=currentNode}else{$scope.viewModel.currentVariablePaneType=Const.VariablePaneType.empty;currentSelectedNode=null}}$scope.onDeviceDropdownMenuItemClick=function(device){$scope.viewModel.selectedDevice=device;refreshVariableList(device,dataUnitSet);dataElementDetailsSrvc.getDeviceIconUrl(device.devType,device.devKey,$scope.viewModel,"",device.imageName);setCurrentNode(!0)};$scope.onTabClick=function(tabIndex){if(!loading){$scope.viewModel.currentTabId=tabIndex;$scope.viewModel.currentVariablePaneType=Const.VariablePaneType.empty;setCurrentNode()}};function refreshVariableList(device,dus){if(dus.devUnitData&&dus.devUnitData[device.devKey]){$scope.viewModel.devUnitData=dus.devUnitData[device.devKey].unitData||[];detailsSrvc.clearSelectedStatus($scope.viewModel.devUnitData)}if(dus.intfUnitData&&dus.intfUnitData[device.devKey]){var intfUnitData=dus.intfUnitData[device.devKey].unitData||[];$scope.viewModel.intfUnitData=intfUnitData;$timeout((function(){intfUnitData.length>0&&intfUnitData.length<=5&&expandNode($scope.viewModel.intfUnitData,!0)}),5);detailsSrvc.clearSelectedStatus($scope.viewModel.intfUnitData)}}function expandNode(nodeArr,id){var goo=!0;for(var i=0;i<nodeArr.length;i++){var node=nodeArr[i];if(node.id===id){ivhTreeviewMgr.expand($scope.viewModel.intfUnitData,node,$scope.ivhTreeIntfDataOptions);goo=!1;break}!0===id&&ivhTreeviewMgr.expand($scope.viewModel.intfUnitData,node,$scope.ivhTreeIntfDataOptions);node.children&&node.children.length>0&&expandNode(node.children,id)}return goo}function initLeftPane(){var devList=[];if(option.variableList){$scope.viewModel.forceRealDev=!0;devList=[{devKey:option.devKey,devType:option.devType,hostName:option.hostName,imageName:""}];!function(variableList,dataUnit,devKey,isRunCmd){attachValueExpr(dataUnit,devKey);_.each(option.variableList.devUnitData,(function(item){_.each(item.unitData,(function(data){attachValueExpr(data.dataUnit,devKey,isRunCmd)}))}));_.each(option.variableList.intfUnitData,(function(item){_.each(item.unitData,(function(data){_.each(data.children,(function(child){attachValueExpr(child.dataUnit,devKey,isRunCmd)}))}))}))}(option.variableList,option.dataUnit,option.devKey,!0)}else devList=detailsSrvc.getDeviceList();if(0===devList.length){$scope.viewModel.noDevice=!0;$scope.viewModel.currentVariableType=Const.VariableType.none;$scope.viewModel.currentVariablePaneType=Const.VariablePaneType.none;return!1}option.devKey||(option.devKey=devList[0].devKey);var selectedDevice=detailsSrvc.getSelectedDevice(devList,option.devKey);$scope.viewModel.deviceList=devList;$scope.viewModel.selectedDevice=selectedDevice;dataElementDetailsSrvc.getDeviceIconUrl(option.devType,option.devKey,$scope.viewModel,"",selectedDevice.imageName);refreshVariableList(selectedDevice,dataUnitSet=option.variableList?option.variableList:detailsSrvc.getUnitList());!function(intfKeyObj,posName,uId){var selectedNode=null;if(posName&&uId)if(intfKeyObj){$scope.viewModel.currentTabId=1;detailsSrvc.clearSelectedStatus($scope.viewModel.intfUnitData);var index=_.findIndex($scope.viewModel.intfUnitData,{id:intfKeyObj.value});var intfUnitData=[];intfUnitData=index>=0?[$scope.viewModel.intfUnitData[index]]:$scope.viewModel.intfUnitData;detailsSrvc.setSelectedStatus(intfUnitData,uId,posName);var iVId=intfKeyObj.value+posName+uId;var encodeIVId=Const.htmlEncodeByRegExp(iVId);selectedNode=detailsSrvc.getSelectedVariableNode(intfUnitData);$timeout((function(){$scope.viewModel.intfUnitData.length>5?expandNode($scope.viewModel.intfUnitData,selectedNode.pId):expandNode($scope.viewModel.intfUnitData,!0);$timeout((function(){scrollToShowVariable(".intf-tree"," div[tag='"+encodeIVId+"']");detailsSrvc.clearSelectedStatus($scope.viewModel.intfUnitData,uId,posName)}),50)}),5)}else{$scope.viewModel.currentTabId=0;detailsSrvc.clearSelectedStatus($scope.viewModel.devUnitData);detailsSrvc.setSelectedStatus($scope.viewModel.devUnitData,uId,posName);var dVId=posName+uId;var encodeDVId=Const.htmlEncodeByRegExp(dVId);selectedNode=detailsSrvc.getSelectedVariableNode($scope.viewModel.devUnitData);$timeout((function(){scrollToShowVariable(".device-tree"," div[tag='"+encodeDVId+"']");detailsSrvc.clearSelectedStatus($scope.viewModel.devUnitData,uId,posName)}),50)}currentSelectedNode=selectedNode}(option.dataUnit.intfKey,option.posName,option.dataUnit.uId);return!0}function initData(){$scope.viewModel.icon=0;if(option.mode===Const.DetailPaneMode.Map){$scope.viewModel.mode=option.mode;$scope.viewModel.forceRealDev=!1;$scope.viewModel.pageId=detailsSrvc.getPageId();if(!1===initLeftPane())return!1;var unitShowName=detailsSrvc.getUnitShowName(option.dataUnit.prefix,option.dataUnit.displayName,option.dataUnit.displayInfo,option.dataUnit.type,option.dataUnit.valueType);var varName=detailsSrvc.getRealVariableName(option.dataUnit.uId,null,option.dataUnit.valueType);var parserParam=detailsSrvc.getDataUnitParserParamByDevKey(option.devKey,option.dataUnit);var extendDataUnitMap={displayTemplate:option.dataUnit.displayTemplate,varName:varName};refreshVariablePane({dataUnit:_.extend(option.dataUnit,parserParam,extendDataUnitMap),dataViewInfo:option.dataViewInfo,devKey:option.devKey,devType:option.devType,hostName:option.hostName,intfKeyObj:option.dataUnit.intfKey,mode:option.mode,posName:option.posName,queryParams:option.queryParams,unitShowName:unitShowName,variableType:""});$scope.viewModel.paneStyle={"border-bottom":"1px solid #ccc","border-right":"none"};return!0}if(option.mode===Const.DetailPaneMode.GbManager){$scope.viewModel.mode=option.mode;$scope.viewModel.forceRealDev=!0;var extendDataUnitGbm={displayTemplate:option.dataUnit.variableName,varName:option.dataUnit.variableName};var pOptionGbm={dataUnit:_.extend(option.dataUnit,extendDataUnitGbm),devKey:option.devKey,devType:option.devType,hostName:option.hostName,intfKeyObj:option.dataUnit.intfKey,mode:option.mode,posName:null,queryParams:option.queryParams,unitShowName:option.dataUnit.prefix||option.dataUnit.variableName,variableType:""};attachValueExpr(pOptionGbm.dataUnit,option.devKey);refreshVariablePane(pOptionGbm);$scope.viewModel.paneStyle={border:"1px solid #ccc","border-top":"none"};return!0}return!1}function attachValueExpr(dataUnit,devKey,isRunCmd){dataUnit.valueExpr={deviceId:devKey};if(isRunCmd){dataUnit.valueExpr.isRunCommand=!0;dataUnit.varName=detailsSrvc.getRealVariableName(dataUnit.uId,null,dataUnit.valueType)}}var throttleEmitOnResize=_.debounce((function(){$rootScope.$emit(Const.Event.DETAIL_PANE_RESIZE_EVENT)}),200);function initParams(){extendData=null;currentSelectedNode=null;deviceDataOption=null;interfaceDataOption=null}function init(){loading=!0;initParams();$timeout((function(){var mainContainer=element.parent();var maxHeight=mainContainer.height()-60;var mapPane=mainContainer.find(".container-main-pane");mapPane.height(maxHeight-270);mapPane.resizable({handles:"s",minHeight:30,maxHeight:maxHeight,resize:function(){updateDiagram();throttleEmitOnResize()}});element.find(".pane-left").resizable({handles:"e",minWidth:250,maxWidth:250,resize:function(){}});loading=!1}),5);initData()}init();$scope.onClose=function(){var map=element.parent().find(".container-main-pane");paneOption.isShow=!1;map.css({height:""});try{map.resizable("destroy")}catch(e){var mapPane=element.parent().find(".container-main-pane");$timeout((function(){angular.element(mapPane).find("> .ui-resizable-handle.ui-resizable-s").remove();angular.element(mapPane).css("height","")}),5)}$scope.viewModel.unload=!0;$timeout((function(){updateDiagram()}),5);$timeout((function(){option.handle&&option.handle.onClose&&_.isFunction(option.handle.onClose)&&option.handle.onClose()}),5)};function initDataWithNode(node){if(node){var pOption=option;0===$scope.viewModel.currentTabId&&(pOption=deviceDataOption);1===$scope.viewModel.currentTabId&&(pOption=interfaceDataOption);var devKey=$scope.viewModel.selectedDevice.devKey;var devType=$scope.viewModel.selectedDevice.devType;var hostName=$scope.viewModel.selectedDevice.hostName;if(!pOption.variableList){var currentNodeObj=detailsSrvc.getCurrentDataUnitAndPosName(pOption);if(currentNodeObj&&currentNodeObj.currentDataUnit){option.dataUnit=currentNodeObj.currentDataUnit;option.posName=currentNodeObj.posName}}option.dataViewInfo=detailsSrvc.getDataViewInfo(devKey);option.devKey=devKey;option.devType=devType;option.hostName=hostName;initData()}else{$scope.viewModel.currentVariablePaneType=Const.VariablePaneType.empty;initLeftPane();setDataViewContent(Const.DetailPaneMode.Map)}}var watchRefreshDataElementPane=$rootScope.$on(EventType.REFRESH_DATA_ELEMENT_PANE,(function(event,pageId,newOption){if(option){option.dataUnit=newOption.dataUnit;option.dataViewInfo=newOption.dataViewInfo;option.devKey=newOption.devKey;option.devType=newOption.devType;option.hostName=newOption.hostName;option.handle=newOption.handle;option.mode=newOption.mode;option.posName=newOption.posName;option.queryParams=newOption.queryParams;option.variableList=null;newOption.variableList&&(option.variableList=newOption.variableList);option.title=null;newOption.title&&(option.title=newOption.title);paneOption.dataUnit=newOption.dataUnit;paneOption.dataViewInfo=newOption.dataViewInfo;paneOption.devKey=newOption.devKey;paneOption.devType=newOption.devType;paneOption.hostName=newOption.hostName;paneOption.handle=newOption.handle;paneOption.mode=newOption.mode;paneOption.posName=newOption.posName;paneOption.queryParams=newOption.queryParams;paneOption.variableList=null;newOption.variableList&&(paneOption.variableList=newOption.variableList);paneOption.title=null;newOption.title&&(paneOption.title=newOption.title);init()}}));var watchActivePageChanged=$rootScope.$on(NetBrain.Map.Event.ActivePageChanged,(function(){paneOption&&paneOption.isShow&&$scope.onClose()}));var watchCloseDataElementPane=$rootScope.$on(EventType.CLOSE_DATA_ELEMENT_PANE,(function(event,pageId,dvtPath){var closePageId=pageId;if(!pageId){closePageId=mapManagerSrvc.getActivePage().getDocId()}var sameTpl=!1;dvtPath&&extendData&&extendData.extendDataViewTemplateData&&dvtPath===extendData.extendDataViewTemplateData.dataViewTemplatePath&&(sameTpl=!0);if($scope.viewModel.pageId===closePageId&&!sameTpl&&paneOption&&paneOption.isShow){initParams();$scope.onClose()}}));var goldebaselineUpdateEvent=$rootScope.$on(goldenBaselineConsts.Events.UpdateSingleGoldenBaseline,(function(event,result){result&&(option.mode===Const.DetailPaneMode.Map?initDataWithNode(currentSelectedNode):option.mode===Const.DetailPaneMode.GbManager&&initData())}));var refreshDataViewDetailPanel=$rootScope.$on("refreshDataViewDetailPanel",(function(){initDataWithNode(currentSelectedNode)}));var watchDataViewChanged=$rootScope.$on(NetBrain.Map.Event.DataViewChanged,(function(evt,dvChanged){(!dvChanged||"onRunDVT"!==dvChanged.trigger&&"liveRun"!==dvChanged.trigger)&&initDataWithNode(currentSelectedNode)}));var watchModelDataArrayChanged=$rootScope.$on(NetBrain.Map.Event.ModelDataArrayChanged,(function(event,isrefresh){}));var watchDeviceChanged=$rootScope.$on(EventType.DEVICE_CHANGED_DATA_ELEMENT_PANE,(function(event,newDevData){if(!option.variableList){var newDevKey=newDevData.key;var devList=$scope.viewModel.deviceList;var index=_.findIndex(devList,{devKey:newDevKey});if(index>=0){var newDevice=devList[index];$scope.onDeviceDropdownMenuItemClick(newDevice)}}}));function updateDiagram(){var curPage=mapManagerSrvc.getActivePage();curPage&&curPage.getGoJsDiagram().requestUpdate()}function scrollToShowVariable(tr,vId){var div=angular.element(tr);var divHeight=div.height();if(div[0]){var divScrollTop=div[0].scrollTop;var divPos=getPos(div[0]);var input=angular.element(tr+vId)[0];if(input){var inputPos=getPos(input);var rTop=inputPos.top-divPos.top-8;inputPos&&rTop>divHeight+divScrollTop&&(div[0].scrollTop=rTop);inputPos&&rTop<divScrollTop&&(div[0].scrollTop=rTop)}}}function getPos(obj){var l=0;var t=0;for(;obj;){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}return{left:l,top:t}}$scope.$on("$destroy",(function(){watchActivePageChanged();watchCloseDataElementPane();watchRefreshDataElementPane();goldebaselineUpdateEvent();refreshDataViewDetailPanel();watchDataViewChanged();watchModelDataArrayChanged();watchDeviceChanged()}));function setDataViewContent(mode){var _extendData=null;if(option.title){extendData=null;$scope.viewModel.icon=option.title.icon;$scope.viewModel.title=option.title.content}else{_extendData=extendData=detailsSrvc.getPageExtendData(mode);if(mode===Const.DetailPaneMode.Map&&_extendData){var appliedDvInfo=dataElementDetailsSrvc.getAppliedDataViewInfo();$scope.viewModel.icon=appliedDvInfo.dvIcon;$scope.viewModel.title=appliedDvInfo.dvName}else if(mode===Const.DetailPaneMode.GbManager){dataElementDetailsSrvc.getDeviceIconUrl(option.devType,option.devKey,$scope.viewModel,"icon");$scope.viewModel.title=option.hostName}}}}return directive}}(NetBrain);!function(){angular.module("nb.dataview").controller("nb.dataview.dataElementDeviceTablePaneCtrl",dataElementDeviceTablePaneCtrl);dataElementDeviceTablePaneCtrl.$inject=["$scope","$uibModal","$element","$timeout","$rootScope","$log","nb.admin.http3rdPartyApiIntegrationSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.nbValidationSrvc","nb.common.nbTextEditorSrvc","$q","nb.dataview.aceEditInitSrvc","nb.ng.inputFileSrvc","nb.admin.httpTenantAdminSrvc","nb.dataview.dataElementDetailsSrvc","nb.dataview.detailDrillDownLabelSrvc","nb.deviceDetail.httpDeviceDetailSrvc","nb.qmap.mapManagerSrvc","nb.ng.userSrvc"];function dataElementDeviceTablePaneCtrl($scope,$uibModal,$element,$timeout,$rootScope,$log,http3rdPartyApiIntegrationSrvc,nbAlertSrvc,utilitySrvc,nbValidationSrvc,nbTextEditorSrvc,$q,aceEditInitSrvc,inputFileSrvc,httpTenantAdminSrvc,dataElementDetailsSrvc,detailDrillDownLabelSrvc,httpDeviceDetailSrvc,mapManagerSrvc,userSrvc){var detailsSrvc=dataElementDetailsSrvc;var Const=detailsSrvc.dataElementConst;var option=null;var member={};$scope.Wording={noDataText:Const.Wording.noDataText};function initMember(){$scope.viewModel={mainDivId:"",Title:"",noData:!1,parserPathParam:"",parserPath:"",variableIconClass:"icon_nb_String_12",mode:0,gb:{status:Const.GoldenBaselineStatus.NotApplicable,displayName:"Define Golden Baseline",gbDefinition:Const.getGoldenBaselineDefinition(),dataUnit:null,devInfo:null,mode:0,queryParams:null,dataViewInfo:null},search:{text:"",status:!1},rowCount:0,allRecordCount:0,timeListOption:{timeList:[],dataViewTimeList:[],dataEngineTimeList:[],gbTime:null,generateTime:"",dataViewShowName:"data view",refresh:!1,timePointChanged:timePointChanged,timePointInited:timePointInited,dropdownMenuStyle:{"max-width":"420px","max-height":"230px"},currentTimeItemChanged:null,pOption:null},generateTime:"",showTimeList:!1,loading:!0,tableRowCountLoading:!1,inited:!1,currentTabId:0,showTableRowCount:!1,enabledGrid:!0,isDataTable:!1,nctList:null,vrfList:null,selectedNct:null,selectedVrf:null,noFirstNctVrfData:!1,isConfigFile:!1,searchConfigFile:{text:"",isMatchWordForSearch:"",userInputSearchText:"",isMatchWord:""},configContentData:{id:"",content:"",isConfigAllLoad:!0,hasNoData:!1},configTreeData:{},selectedFullConfigration:{},isOpenFromMap:!0,selectedConfigContent:"",moreLoading:!1,tableSearchPlaceholder:"Search...",sampleText:""};$scope.tableData=[];member.tableGridApi=null;member.columnNameList=[];member.currentUserEvt={timeOrigin:null};member.m_pageIndex=0;member.m_pageSize=Const.DefaultPageSize;member.gridLoading=!1;member.m_isAllLoaded=!1;member.isInSearch=!1;member.hasSearchResult=!1;member.isOnTableRowCountClick=!1;member.isGbData=null;member.firstDataTimeValue=null;member.scrollTimerout=null;member.mainDivId="";member.hasMoreType=!1;member.l_timePointInited=!1;member.l_timeListInited=!1;member.l_dataInited=!1;member.firstNct=!0;member.firstVrf=!0;$scope.tableRowCountOption={tableRowCountChanged:tableRowCountChanged,data:{valueList:[],allRecordCount:0},generateTime:"",refreshRowCountData:refreshRowCountData}}function timePointChanged(userEvt){$scope.viewModel.moreLoading=!0;if(userEvt.timeOrigin){var nctList=userEvt.nctList;var vrfList=userEvt.vrfList;if(nctList){$scope.viewModel.nctList=nctList;if(nctList.length>0){$scope.viewModel.selectedNct=nctList[0];var nctVrfList=nctList[0].vrfList;$scope.viewModel.vrfList=nctVrfList||[];nctVrfList&&nctVrfList.length>0&&($scope.viewModel.selectedVrf=nctVrfList[0])}}else if(vrfList){$scope.viewModel.vrfList=vrfList;vrfList.length>0&&($scope.viewModel.selectedVrf=vrfList[0])}member.currentUserEvt=userEvt;member.currentUserEvt.nctName=$scope.viewModel.selectedNct?$scope.viewModel.selectedNct.nctName:"";member.currentUserEvt.vrfName=$scope.viewModel.selectedVrf?$scope.viewModel.selectedVrf.vrfName:"";innerRefreshData(member.currentUserEvt)}}function timePointInited(userEvt,isFirstDataTime){var setCurrentUserEvt=function(_userEvt){if(_userEvt.timeOrigin&&_userEvt.timeItem.origin)member.currentUserEvt=_userEvt;else{var timeItem=detailDrillDownLabelSrvc.convertDeviceMetaDataToTimeItem(option.dataUnit.deviceMetadata);timeItem&&(member.currentUserEvt={timeItem:timeItem,timeOrigin:timeItem.origin,isGoldenBaselineTime:!1})}if(member.currentUserEvt.timeItem){var nctList=member.currentUserEvt.timeItem.nctList;var vrfList=member.currentUserEvt.timeItem.vrfList;$scope.viewModel.nctList=nctList||[];$scope.viewModel.vrfList=vrfList||[];if(nctList&&nctList.length>0){$scope.viewModel.selectedNct=nctList[0];var nctVrfList=nctList[0].vrfList;$scope.viewModel.vrfList=nctVrfList||[];nctVrfList&&nctVrfList.length>0&&($scope.viewModel.selectedVrf=nctVrfList[0])}vrfList&&vrfList.length>0&&($scope.viewModel.selectedVrf=vrfList[0])}member.l_timePointInited=!0;$scope.viewModel.loading=!(member.l_timePointInited&&member.l_timeListInited&&member.l_dataInited)};$scope.viewModel.mode===Const.DetailPaneMode.Map?setCurrentUserEvt(userEvt):$scope.viewModel.mode===Const.DetailPaneMode.GbManager&&(isFirstDataTime?setCurrentUserEvt(userEvt):setTimeListSelectedItem())}function setTimeListSelectedItem(){if(null!==member.firstDataTimeValue){var timeValue=member.firstDataTimeValue;_.isFunction($scope.viewModel.timeListOption.currentTimeItemChanged)&&$scope.viewModel.timeListOption.currentTimeItemChanged(timeValue,member.isGbData,!0)}}function prepareDataGrid(){$scope.tablePaneGridOptions={data:"tableData",columnDefs:[],multiSelect:!0,enableFullRowSelection:!0,enableSelection:!0,modifierKeysToMultiSelect:!0,enableRowHeaderSelection:!1,enableColumnResizing:!0,enableSorting:!1,excessColumns:100,flatEntityAccess:!0,onRegisterApi:function(gridApi){if(member.isOnTableRowCountClick)member.isOnTableRowCountClick=!1;else{member.tableGridApi=gridApi;member.tableGridApi.infiniteScroll.on.needLoadMoreData($scope,$scope.scrollToBottom);member.tableGridApi.infiniteScroll.on.needLoadMoreDataTop($scope,$scope.scrollToTop);member.tableGridApi.grid.registerRowsProcessor(singleFilter,200)}}}}$scope.scrollToBottom=function(){member.gridLoading?member.tableGridApi.infiniteScroll.dataLoaded(!1,!member.m_isAllLoaded):$scope.viewModel.loading||$scope.viewModel.moreLoading?member.tableGridApi.infiniteScroll.dataLoaded(!1,!member.m_isAllLoaded):$timeout((function(){!function(userEvt){if(!member.gridLoading&&!member.m_isAllLoaded){member.gridLoading=!0;if(userEvt){userEvt.filterWords=$scope.viewModel.search.text;userEvt.pageIndex=member.m_pageIndex}detailDrillDownLabelSrvc.loadSubPaneData(option,null,userEvt).then((function(obj){var pData=obj;if(pData&&pData.data&&pData.data.valueList&&pData.data.valueList.length>0){var data=pData.data;$scope.tableData=$scope.tableData.concat(data.valueList);member.m_isAllLoaded=data.isAllLoaded;member.tableGridApi&&member.tableGridApi.infiniteScroll.dataLoaded(!1,!member.m_isAllLoaded)}member.gridLoading=!1;member.m_pageIndex+=1}))}}(member.currentUserEvt)}),50)};$scope.scrollToTop=function(){member.tableGridApi.infiniteScroll.dataLoaded(!1,!member.m_isAllLoaded)};function innerRefreshData(userEvt){$scope.viewModel.moreLoading=!0;var tempUserEvt=null;if(userEvt){var gbOrigin=$scope.viewModel.gb.gbDefinition.origin;var filter={pageIndex:0,pageSize:member.m_pageSize,filterWords:$scope.viewModel.search.text};tempUserEvt=_.extend({gbOrigin:gbOrigin},userEvt,filter)}$scope.viewModel.enabledGrid=!1;detailDrillDownLabelSrvc.loadSubPaneData(option,null,tempUserEvt).then((function(obj){$timeout((function(){prepareDataGrid();showData(obj);$scope.viewModel.moreLoading=!1;$scope.viewModel.enabledGrid=!0;member.isInSearch=!1}),50)}))}function refreshData(isFirst,noNeedTimeList){isFirst?$scope.viewModel.loading=!0:$scope.viewModel.moreLoading=!0;innerRefreshData(isFirst?null:member.currentUserEvt);if(!noNeedTimeList){var userFilter=Const.getTimeListUserFilter();detailDrillDownLabelSrvc.loadSubPaneTimeList(option,null,userFilter).then((function(obj){showTime(obj,$scope.viewModel.timeListOption.dataViewShowName)}))}}$scope.onNctChanged=function(label,item){if($scope.viewModel.loading||member.firstNct)member.firstNct=!1;else{member.currentUserEvt.nctName=label;$scope.viewModel.vrfList=item.vrfList;item.vrfList&&item.vrfList.length>0&&($scope.viewModel.selectedVrf=item.vrfList[0]);$scope.viewModel.selectedNct=item;member.currentUserEvt.nctName=$scope.viewModel.selectedNct?$scope.viewModel.selectedNct.nctName:"";member.currentUserEvt.vrfName=$scope.viewModel.selectedVrf?$scope.viewModel.selectedVrf.vrfName:"";innerRefreshData(member.currentUserEvt)}};$scope.onVrfChanged=function(label,item){if(!$scope.viewModel.loading)if(member.firstVrf)member.firstVrf=!1;else{$scope.viewModel.selectedVrf=item;member.currentUserEvt.vrfName=$scope.viewModel.selectedVrf?$scope.viewModel.selectedVrf.vrfName:"";innerRefreshData(member.currentUserEvt)}};$scope.onClickRefresh=function(){member.currentUserEvt.nctName=$scope.viewModel.selectedNct?$scope.viewModel.selectedNct.nctName:"";member.currentUserEvt.vrfName=$scope.viewModel.selectedVrf?$scope.viewModel.selectedVrf.vrfName:"";innerRefreshData(member.currentUserEvt)};function tableRowCountChanged(timeText,timeValue){var showForTableRowCountChanged=function(timeItem){member.currentUserEvt={timeOrigin:timeItem.origin,isGoldenBaselineTime:timeItem.isGoldenBaselineTime,vrfList:timeItem.vrfList,nctList:timeItem.nctList};refreshData(!1,!0);_.isFunction($scope.viewModel.timeListOption.currentTimeItemChanged)&&$scope.viewModel.timeListOption.currentTimeItemChanged(timeValue);$timeout((function(){$scope.viewModel.currentTabId=0;$scope.viewModel.showTableRowCount=!1}),50)};var timeList=$scope.viewModel.timeListOption.timeList;var index=_.findIndex(timeList,{timeValue:timeValue});var timeItem=null;if(index>=0){timeItem=timeList[index];showForTableRowCountChanged(timeItem)}else{moment.utc(new Date(timeValue)).local().format("YYYY-MM-DDThh:mm:ss");var duration={time:timeText,value:10,unit:2};var timeListType={timeListType:Const.TimeListType.timePointer};detailDrillDownLabelSrvc.loadSubPaneTimeList(option,duration,timeListType).then((function(timeObj){if(timeObj&&timeObj.timeList&&timeObj.timeList.length>0&&(index=_.findIndex(timeObj.timeList,{timeValue:timeValue}))>=0){timeItem=timeObj.timeList[index];showForTableRowCountChanged(timeItem)}}))}}function refreshRowCountData(duration,userEvt){var defer=$q.defer();var tempUserEvt=_.extend({nct:$scope.viewModel.selectedNct?$scope.viewModel.selectedNct.nctName:null,vrf:$scope.viewModel.selectedVrf?$scope.viewModel.selectedVrf.vrfName:null},userEvt);detailDrillDownLabelSrvc.loadTableRowCount(option,duration,tempUserEvt).then((function(data){var resultOption={data:{allRecordCount:data?data.allRecordCount:0,valueList:data?data.valueList:[]},generateTime:option.dataUnit.generateTime};defer.resolve(resultOption)}));return defer.promise}$scope.onTabClick=function(index){if(0===index){angular.element(".tbl-row-c").hide();$scope.viewModel.currentTabId=0;$scope.viewModel.showTableRowCount=!1}else if(1===index){member.isOnTableRowCountClick=!0;setMainPaneWidth(!0);$timeout((function(){$scope.viewModel.tableRowCountLoading=!0;var tempUserEvt={nct:$scope.viewModel.selectedNct?$scope.viewModel.selectedNct.nctName:null,vrf:$scope.viewModel.selectedVrf?$scope.viewModel.selectedVrf.vrfName:null,pageIndex:0,pageSize:Const.DefaultPageSize};detailDrillDownLabelSrvc.loadTableRowCount(option,{value:30},tempUserEvt).then((function(data){setMainPaneWidth(!1);data&&($scope.tableRowCountOption.data=data);$scope.tableRowCountOption.generateTime=option.dataUnit.generateTime;$timeout((function(){$scope.viewModel.currentTabId=1;$scope.viewModel.showTableRowCount=!0;$scope.viewModel.tableRowCountLoading=!1}),50)}))}),50)}};$scope.onClickCompare=function(){var vrfName=$scope.viewModel.selectedVrf?$scope.viewModel.selectedVrf.vrfName:null;var timePoint=null;if(member.currentUserEvt&&member.currentUserEvt.timeOrigin){timePoint={executeTime:member.currentUserEvt.timeOrigin.executeTime}}dataElementDetailsSrvc.openCommonCompareModal(option,vrfName,null,timePoint)};$scope.variableSampleClick=function(){console.log("sample")};$scope.onClickExport=function(){if($scope.viewModel.noData){nbAlertSrvc.error({message:"No data to export."})}else if(!member.currentUserEvt.isGoldenBaselineTime){var location=null;var filter={nct:$scope.viewModel.selectedNct?$scope.viewModel.selectedNct.nctName:null,vrf:$scope.viewModel.selectedVrf?$scope.viewModel.selectedVrf.vrfName:null};var tempUserEvt=_.extend(filter,member.currentUserEvt);member.currentUserEvt.timeOrigin&&member.currentUserEvt.timeItem.nctList?location=detailDrillDownLabelSrvc.getNctLocation(tempUserEvt):member.currentUserEvt.timeOrigin&&member.currentUserEvt.timeItem.vrfList&&(location=detailDrillDownLabelSrvc.getVrfLocation(tempUserEvt));location&&detailsSrvc.exportDeviceTable(location)}};$scope.onSearchInputKeyUp=function(event,clear){if(!($scope.viewModel.loading||$scope.viewModel.moreLoading||"clear"!==clear&&13!==event.keyCode&&27!==event.keyCode&&8!==event.keyCode&&46!==event.keyCode)){if(27===event.keyCode){$scope.viewModel.search.text="";if(member.hasSearchResult){refreshData(!1,!0);member.hasSearchResult=!1;return}}if("clear"===clear||(8===event.keyCode||46===event.keyCode)&&""===$scope.viewModel.search.text){$scope.viewModel.search.text="";if(member.hasSearchResult){refreshData(!1,!0);member.hasSearchResult=!1;return}}if(13!==event.keyCode)member.tableGridApi.grid.refresh();else{if(member.isInSearch)return;if($scope.viewModel.search.text){member.hasSearchResult=!0;member.isInSearch=!0;refreshData(!1,!0)}}}};$scope.searchDevice=function(){};$scope.onClickConfigFileCompare=function(){var timePoint=null;if(member.currentUserEvt&&member.currentUserEvt.timeOrigin&&member.currentUserEvt.timeOrigin.location){timePoint={executeTime:member.currentUserEvt.timeOrigin.executeTime,location:member.currentUserEvt.timeOrigin.location}}dataElementDetailsSrvc.openCommonCompareModal(option,null,null,timePoint)};$scope.closeConfigExportTip=function(){$scope.viewModel.configContentData.isConfigAllLoad=!0};$scope.exportMoreConfigData=function(){var location=member.currentUserEvt.timeOrigin.location;location&&httpDeviceDetailSrvc.export(location).then((function(){$scope.closeConfigExportTip()}))};$scope.onClickExportConfig=function(){if($scope.viewModel.noData){nbAlertSrvc.error({message:"No data to export."})}else{var location=member.currentUserEvt.timeOrigin.location;location&&httpDeviceDetailSrvc.export(location)}};$scope.addNote=function(){if($scope.viewModel.selectedConfigContent){var noteObj={title:'Config Let of "'+option.hostName+'"',content:$scope.viewModel.selectedConfigContent,user:userSrvc.getUserName(),time:new Date,noteFromType:NetBrain.Map.Const.NoteFromType.Normal};mapManagerSrvc.getActivePage().getNetmapOperator().mergeDeviceNoteRefDevice(option.devKey,noteObj)}};$scope.onSearchNext=function(){$scope.aceSearchApi.findNext()};$scope.onSearchPrev=function(){$scope.aceSearchApi.findPrevious()};$scope.onSearchSetMatchWord=function(){$scope.viewModel.searchConfigFile.isMatchWord=!$scope.viewModel.searchConfigFile.isMatchWord;onSearchAll()};$scope.onClear=function(){$scope.viewModel.searchConfigFile.text="";$scope.viewModel.searchConfigFile.userInputSearchText=""};$scope.onSearchAll=function(){onSearchAll()};function onSearchAll(){$scope.viewModel.searchConfigFile.text=$scope.viewModel.searchConfigFile.userInputSearchText;$scope.viewModel.searchConfigFile.isMatchWordForSearch=$scope.viewModel.searchConfigFile.isMatchWord}function onClickEditor(){$scope.viewModel.searchConfigFile.text.trim()&&onSearchAll()}function changeFullConfig(configNode){$scope.viewModel.selectedFullConfigration&&($scope.viewModel.selectedFullConfigration.selected=!1);$scope.viewModel.selectedFullConfigration=configNode;if("Full Configuration"===configNode.Id)!function(){var location=member.currentUserEvt.timeOrigin.location;location&&httpDeviceDetailSrvc.getConfigFileData(location).then((function(data){if(data&&data.content){$scope.viewModel.configContentData.content=data.content;$scope.viewModel.configContentData.isConfigAllLoad=data.isAllLoaded;$scope.viewModel.configContentData.hasNoData=!1}else $scope.viewModel.configContentData.hasNoData=!0}))}();else{$scope.viewModel.configContentData.content="";$scope.viewModel.configContentData.isConfigAllLoad=!0;var varJson={pathType:2,devSubType:option.devType};var location=member.currentUserEvt.timeOrigin.location;httpDeviceDetailSrvc.getResultJson({dataId:location,treeNode:configNode.Id,varJson:varJson}).then((function(resultData){if(resultData){$scope.viewModel.configContentData.hasNoData=!1;$scope.viewModel.configContentData.content=resultData}else $scope.viewModel.configContentData.hasNoData=!0}),(function(){$scope.viewModel.configContentData.hasNoData=!0}))}}function initConfig(){$scope.configTreeOptions={defaultSelectedState:!1,validate:!0,expandToDepth:2,labelAttribute:"Name",childrenAttribute:"Children",expandedAttribute:"expended",enableLabelExpand:!1,enableMultipleSelect:!1,nodeClickCallback:function(node,trvw){trvw.isLeaf(node)&&changeFullConfig(node)},maxSize:""};$scope.aceSearchOption={filterText:function(){return $scope.viewModel.searchConfigFile.text},matchWholeWord:function(){return $scope.viewModel.searchConfigFile.isMatchWordForSearch},highlightAllWhenNext:!0,editor:function(){return $scope.aceEditor_configFile},onload:function(aceSearchApi){$scope.aceSearchApi=aceSearchApi},onFilterResult:function(){}};$scope.aceOption_configFile={onLoad:function(_ace){$scope.aceEditor_configFile=_ace;aceEditInitSrvc.initAceEditor($scope.aceEditor_configFile);$scope.aceEditor_configFile.setTheme("ace/theme/kuroir");$scope.aceEditor_configFile.setReadOnly(!0);$scope.aceEditor_configFile.setAnimatedScroll(!0);$scope.aceEditor_configFile.setHighlightActiveLine(!1);$scope.aceEditor_configFile.setHighlightGutterLine(!1);$scope.aceEditor_configFile.on("click",onClickEditor,!0);$scope.aceEditor_configFile.renderer.$cursorLayer.element.style.display="none";$scope.aceEditor_configFile.addEventListener("mouseup",(function(){!function(selText){if($scope.viewModel.isConfigFile&&$scope.viewModel.isOpenFromMap&&selText){var pos=function(obj){var l=0;var t=0;for(;obj;){l+=obj.offsetLeft;t+=obj.offsetTop;obj=obj.offsetParent}return{left:l,top:t}}(angular.element(member.mainDivId+" .sub-pane-content")[0]);$timeout((function(){var offset=angular.element(member.mainDivId+" .dp-cf-ace-editor").find(".ace_selection").offset();if(pos&&offset){var top=offset.top-pos.top;var left=offset.left-pos.left;var addSelectNoteMenu=angular.element(".show-add-device-note-on-ace");addSelectNoteMenu.css({left:left,top:top});addSelectNoteMenu.fadeIn("fast");$timeout((function(){$scope.viewModel.selectedConfigContent=selText}),50)}}),50)}}($scope.aceEditor_configFile.getSelectedText())}));$scope.aceEditor_configFile.addEventListener("changeSelection",(function(){$scope.aceEditor_configFile.getSelectedText()||($scope.viewModel.selectedConfigContent="")}))}}}function showTime(pTime,dataViewShowName){if(pTime){$scope.viewModel.timeListOption.timeList=pTime.timeList;$scope.viewModel.timeListOption.dataViewTimeList=pTime.dataViewTimeList;$scope.viewModel.timeListOption.dataEngineTimeList=pTime.dataEngineTimeList;$scope.viewModel.timeListOption.gbTime=pTime.gbTime;$scope.viewModel.timeListOption.generateTime=$scope.viewModel.generateTime;$scope.viewModel.timeListOption.dataViewShowName=dataViewShowName;$scope.viewModel.timeListOption.pOption=option;if($scope.viewModel.showTimeList){$scope.viewModel.timeListOption.refresh=!0;$timeout((function(){$scope.viewModel.timeListOption.refresh=!1;member.l_timePointInited=!0}),50)}else{$scope.viewModel.showTimeList=!1;pTime.gbTime&&pTime.gbTime.isGoldenBaselineTime&&pTime.gbTime.timeText||pTime.timeList&&pTime.timeList.length>0||pTime.dataViewTimeList&&pTime.dataViewTimeList.length>0||pTime.dataEngineTimeList&&pTime.dataEngineTimeList.length>0?$scope.viewModel.showTimeList=!0:member.l_timePointInited=!0}member.hasMoreType=(timeList=pTime.timeList,dataViewTimeList=pTime.dataViewTimeList,dataEngineTimeList=pTime.dataEngineTimeList,has1=(hasVrf=function(_timeList){var hasVrf=!1;if(_timeList&&_timeList.length>0){_timeList[0].vrfList&&_timeList[0].vrfList.length>0&&(hasVrf=!0);_timeList[0].nctList&&_timeList[0].nctList.length>0&&(hasVrf=!0)}return hasVrf})(timeList),has2=hasVrf(dataViewTimeList),has3=hasVrf(dataEngineTimeList),has1||has2||has3);member.hasMoreType?$scope.viewModel.noData=!1:$scope.viewModel.noData=!0;member.l_timeListInited=!0;$scope.viewModel.loading=!(member.l_timePointInited&&member.l_timeListInited&&member.l_dataInited)}var timeList,dataViewTimeList,dataEngineTimeList,hasVrf,has1,has2,has3}function showData(pData,onload){if(option){if(pData&&pData.gb&&pData.gb.rule){$scope.viewModel.gb.displayName=pData.gb.rule.displayName;$scope.viewModel.gb.gbDefinition=pData.gb;$scope.viewModel.gb.status=pData.gb.rule.status}$scope.viewModel.gb.dataUnit=option.dataUnit;$scope.viewModel.gb.devInfo=detailDrillDownLabelSrvc.getDevInfo(option);$scope.viewModel.gb.mode=$scope.viewModel.mode;$scope.viewModel.gb.queryParams=option.queryParams;$scope.viewModel.gb.dataViewInfo=option.dataViewInfo;$scope.viewModel.parserPathParam=detailDrillDownLabelSrvc.getParserPathParam(option);$scope.viewModel.parserPath=option.dataUnit.parserPath;var data=null;if(pData&&pData.data&&pData.data.valueList&&pData.data.valueList.length>0||pData&&pData.data&&pData.data.columnList&&pData.data.columnList.length>0&&member.hasMoreType){data=pData.data;member.columnNameList=_.pluck(data.columnList,"fieldName");if(option.dataUnit.uId===DeviceDataType.RouteTable&&data.columnList.length>7){member.columnNameList=[];member.columnNameList.push(data.columnList[1].fieldName);member.columnNameList.push(data.columnList[6].fieldName);member.columnNameList.push(data.columnList[7].fieldName)}var columnShowSetting=null;option.dataUnit.valueExpr&&option.dataUnit.valueExpr.columnShowSetting&&(columnShowSetting=option.dataUnit.valueExpr.columnShowSetting);var columnDefs=function(columnList,columnShowSetting){var cols=[];if(columnList)for(var i=0;i<columnList.length;i++){var col=columnList[i];var displayName=col.name;var isShowField=!1;if(columnShowSetting)for(var j=0;j<columnShowSetting.length;j++){var columnShow=columnShowSetting[j];if(columnShow.name===col.name){displayName=columnShow.displayName;isShowField=!0;break}}else isShowField=!0;if(isShowField){var colObj={field:col.fieldName,displayName:displayName,headerTooltip:displayName,dataFieldName:col.name,minWidth:90,cellTemplate:getTextCellTemplate(col.fieldName,i)};cols.push(colObj)}}return cols}(data.columnList,columnShowSetting);if(columnDefs&&columnDefs.length>0){$scope.tablePaneGridOptions.columnDefs=columnDefs;$scope.viewModel.rowCount=data.allRecordCount?data.allRecordCount:data.valueList.length;$scope.tableData=data.valueList;member.m_isAllLoaded=data.isAllLoaded;member.tableGridApi&&member.tableGridApi.infiniteScroll.dataLoaded(!1,!member.m_isAllLoaded);!function(){member.scrollTimerout&&$timeout.cancel(member.scrollTimerout);member.scrollTimerout=$timeout((function(){member.tableGridApi&&member.tableGridApi.infiniteScroll.resetScroll()}))}();$scope.viewModel.isDataTable=!0;$scope.viewModel.isConfigFile=!1;var noValue=!1;pData.data.valueList&&0===pData.data.valueList.length&&(noValue=!0);if(noValue){$scope.viewModel.noFirstNctVrfData=!0;$scope.viewModel.rowCount=0}else{$scope.viewModel.noData=!1;$scope.viewModel.noFirstNctVrfData=!1}}else{$scope.viewModel.noData=!0;$scope.viewModel.noFirstNctVrfData=!0;$scope.viewModel.rowCount=0}}else $scope.tableData=[];if(pData&&pData.data&&pData.data.isConfigFile){data=pData.data;$scope.viewModel.configContentData.content=data.content;$scope.viewModel.configContentData.isConfigAllLoad=data.isAllLoaded;if(data.configTree&&data.configTree.Children){$scope.viewModel.configTreeData=data.configTree;$scope.viewModel.selectedFullConfigration=data.configTree.Children[0];$scope.viewModel.selectedFullConfigration.selected=!0}data.isAllLoaded||httpDeviceDetailSrvc.getContentMaxSize().then((function(size){$scope.configTreeOptions.maxSize=size}));!function(lineNo){if($scope.viewModel.isConfigFile&&$scope.aceEditor_configFile&&lineNo&&lineNo>0){var Range=ace.require("ace/range").Range;setTimeout((function(){$scope.aceEditor_configFile.scrollToLine(lineNo+0,!0,!0,(function(){}));$scope.aceEditor_configFile.gotoLine(lineNo+0,0,!0);$scope.aceEditor_configFile.session.addMarker(new Range(lineNo-1,0,lineNo,0),"lineHighLighted","text")}),1e3)}}(0);$scope.viewModel.isDataTable=!1;$scope.viewModel.isConfigFile=!0;pData&&pData.data&&pData.data.content?$scope.viewModel.noData=!1:$scope.viewModel.noData=!0}member.l_dataInited=!0;$scope.viewModel.loading=!(member.l_timePointInited&&member.l_timeListInited&&member.l_dataInited);$scope.viewModel.inited=!0;if(pData){member.isGbData=pData.isGbData;member.firstDataTimeValue=pData.dataTimeValue;onload&&setTimeListSelectedItem()}}}var setOptionEvent=$scope.$on(Const.Event.INIT_VARIABLE_PANE,(function(event,pOption){initMember();!function(pOption){option=pOption;$scope.viewModel.Title=detailsSrvc.getVariableTitle(pOption.dataUnit.prefix,pOption.dataUnit.displayName,pOption.unitShowName);$scope.viewModel.hostName=pOption.hostName;$scope.viewModel.devKey=pOption.devKey;$scope.viewModel.mode=pOption.mode;$scope.viewModel.generateTime=pOption.dataUnit.generateTime;var dataUnit=pOption.dataUnit;pOption.mode===Const.DetailPaneMode.GbManager&&($scope.viewModel.sampleText="View Sample");$scope.viewModel.variableIconClass=detailsSrvc.getVariableIcon(!1,dataUnit.type,dataUnit.valueType,!0);if(dataUnit.valueType!==DataUnitType.uTable||dataUnit.uId!==DeviceDataType.NctTable&&dataUnit.uId!==DeviceDataType.ArpTable&&dataUnit.uId!==DeviceDataType.CdpTable&&dataUnit.uId!==DeviceDataType.MacTable&&dataUnit.uId!==DeviceDataType.RouteTable&&dataUnit.uId!==DeviceDataType.StpTable&&dataUnit.uId!==DeviceDataType.BgpNbrTable){if(dataUnit.valueType===DataUnitType.uConfigFile&&dataUnit.uId===DeviceDataType.Config){$scope.viewModel.isDataTable=!1;$scope.viewModel.isConfigFile=!0;initConfig()}}else{$scope.viewModel.isDataTable=!0;$scope.viewModel.isConfigFile=!1;dataUnit.uId===DeviceDataType.RouteTable&&($scope.viewModel.tableSearchPlaceholder="Search Dest.Addr, Next Hop IP or Hostname")}}(pOption);$scope.onTabClick(0);prepareDataGrid()}));var setOptionLoading=$scope.$on(Const.Event.SHOW_VARIABLE_LOADING,(function(){$scope.viewModel.loading=!0;member.firstVrf=!0}));var setOptionData=$scope.$on(Const.Event.SHOW_VARIABLE_DATA,(function(event,pData){showData(pData,!0);member.m_pageIndex=1}));var setOptionTime=$scope.$on(Const.Event.SHOW_VARIABLE_TIME,(function(event,pTime,dataViewShowName){showTime(pTime,dataViewShowName)}));!function(){initMember();prepareDataGrid();$scope.viewModel.mainDivId=NgUtil.getUniqueStr();member.mainDivId="#"+$scope.viewModel.mainDivId}();$scope.$on("$destroy",(function(){setOptionEvent();setOptionLoading();setOptionData();setOptionTime()}));function getTextCellTemplate(fieldName,colIndex){var spanHtml='<span title="{{row.entity.'+fieldName+'}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.viewModel.search.text">{{row.entity.'+fieldName+"}}</span>";if(option.dataUnit.uId===DeviceDataType.RouteTable){1!==colIndex&&6!==colIndex&&7!==colIndex&&(spanHtml='<span title="{{row.entity.'+fieldName+'}}" ng-bind-html="COL_FIELD">{{row.entity.'+fieldName+"}}</span>")}return'<div class="ui-grid-cell-contents">'+spanHtml+"</div>"}function setMainPaneWidth(need){var mainTablePane=$element.closest(".pane-content").find(".sub-pane-body");need?mainTablePane.css("width","auto"):mainTablePane.css("width","")}function singleFilter(renderableRows){if(!$scope.viewModel.loading&&!$scope.viewModel.moreLoading){var matcher=new RegExp($scope.viewModel.search.text,"i");renderableRows.forEach((function(row){var match=!1;member.columnNameList.forEach((function(field){row.entity[field]&&row.entity[field].match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderableRows}}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataElementStringCompareCtrl",dataElementStringCompareCtrl);dataElementStringCompareCtrl.$inject=["$scope","$uibModal","$uibModalInstance","$timeout","$rootScope","$log","nb.admin.http3rdPartyApiIntegrationSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.nbValidationSrvc","nb.common.nbTextEditorSrvc","$q","dataHandler","nb.ng.inputFileSrvc","nb.admin.httpTenantAdminSrvc","nb.dataview.dataElementDetailsSrvc","nb.dataview.detailCompareSrvc"];function dataElementStringCompareCtrl($scope,$uibModal,$uibModalInstance,$timeout,$rootScope,$log,http3rdPartyApiIntegrationSrvc,nbAlertSrvc,utilitySrvc,nbValidationSrvc,nbTextEditorSrvc,$q,dataHandler,inputFileSrvc,httpTenantAdminSrvc,dataElementDetailsSrvc,detailCompareSrvc){$scope.viewModel={mainDivId:"",deviceIcon:"img/icon/Cisco Router.png",noData:!1,hostName:"",gb:{status:0,displayName:"Define Golden Baseline",gbDefinition:null},timeListOption:{timeList:[],currentDataTime:"",refresh:!1,timePointChanged:function(timePoint){console.log("timePointChanged",timePoint)}},summaryView:!0,compareDataStyle:{height:"360px",width:"1000px"},inited:!1};var stringLeftGridApi=null;$scope.stringLeftData=[];$scope.stringRightData=[];!function(){var data=dataHandler.getData();var _pOption=data.pOption;$scope.viewModel.hostName=_pOption.hostName;dataElementDetailsSrvc.getDeviceIconUrl(_pOption.devType,_pOption.devKey,$scope.viewModel,"deviceIcon");var maxWidth=data.maxWidth;var columns1=[{field:"value",displayName:"Name",width:maxWidth,cellTemplate:getTextCellTemplate()}];var columns2=[{field:"value",displayName:"Name",width:maxWidth,cellTemplate:getTextCellTemplate()}];$scope.stringCompareLeftGridOptions={data:"stringLeftData",columnDefs:columns1,multiSelect:!1,enableFullRowSelection:!0,enableSelection:!0,modifierKeysToMultiSelect:!1,enableRowHeaderSelection:!1,enableColumnResizing:!0,enableSorting:!1,showHeader:!1,rowTemplate:getRowTemplate(),onRegisterApi:function(gridApi){stringLeftGridApi=gridApi;$timeout((function(){gridApi.grid.refresh()}),5);stringLeftGridApi.grid.api.core.on.scrollBegin($scope,(function(i){}));stringLeftGridApi.grid.api.core.on.scrollEnd($scope,(function(i){var newScrollLeft=i.newScrollLeft;newScrollLeft||(newScrollLeft=angular.element(".left-grid .ui-grid-viewport")[0].scrollLeft);$timeout((function(){angular.element(".right-grid .ui-grid-viewport").scrollLeft(newScrollLeft)}),100);angular.element(".right-grid .ui-grid-viewport").scrollLeft(newScrollLeft)}))}};$scope.stringCompareRightGridOptions={data:"stringRightData",columnDefs:columns2,multiSelect:!1,enableFullRowSelection:!0,enableSelection:!0,modifierKeysToMultiSelect:!1,enableRowHeaderSelection:!1,enableColumnResizing:!0,enableSorting:!1,showHeader:!1,rowTemplate:getRowTemplate(),onRegisterApi:function(gridApi){gridApi;$timeout((function(){gridApi.grid.refresh()}),5)}};$timeout((function(){$scope.viewModel.compareDataStyle={};$scope.stringCompareLeftGridOptions.columnDefs[0].width=896;$scope.stringCompareLeftGridOptions.columnDefs[0].maxWidth=896}),500);!function(data){var gridData=detailCompareSrvc.convertStringCompareDataToGridObj(data.compareResult);$scope.stringLeftData=gridData.leftData;$scope.stringRightData=gridData.rightData;$scope.viewModel.timeListOption.timeList=data.timeList.valueList;$scope.viewModel.timeListOption.currentDataTime=data.pOption.dataUnit.generateTime}(data);$scope.viewModel.inited=!0}();$scope.onClose=function(){$uibModalInstance.dismiss({$value:"close"})};function getRowTemplate(){return'<div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-row"'+" ng-class=\"{ 'compare-unchanged': row.entity.type==0, 'compare-deleted': row.entity.type==1, 'compare-inserted': row.entity.type==2, 'compare-modified': row.entity.type==4 }\" ui-grid-cell></div>"}function getTextCellTemplate(){return'<div class="ui-grid-cell-contents ui-grid-cell-cmp"><span ng-if="row.entity.type === 0" class="compare-unchanged-text" title="{{row.entity.text}}">{{row.entity.text}}</span><span ng-if="row.entity.type === 1" class="compare-deleted-text" title="{{row.entity.text}}">{{row.entity.text}}</span><span ng-if="row.entity.type === 2" class="compare-inserted-text" title="{{row.entity.text}}">{{row.entity.text}}</span><span ng-if="row.entity.type === 3" class="compare-imaginary-text" title="{{row.entity.text}}">{{row.entity.text}}</span><span ng-if="row.entity.type === 4" class="compare-modified-text" title="{{row.entity.text}}">{{row.entity.text}}</span></div>'}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataElementStringPaneCtrl",dataElementStringPaneCtrl);dataElementStringPaneCtrl.$inject=["$scope","$uibModal","$timeout","$rootScope","$log","nb.admin.http3rdPartyApiIntegrationSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.nbValidationSrvc","nb.common.nbTextEditorSrvc","$q","nb.ng.inputFileSrvc","nb.admin.httpTenantAdminSrvc","nb.dataview.dataElementDetailsSrvc","nb.dataview.detailCompareSrvc","nb.dataview.detailDrillDownLabelSrvc"];function dataElementStringPaneCtrl($scope,$uibModal,$timeout,$rootScope,$log,http3rdPartyApiIntegrationSrvc,nbAlertSrvc,utilitySrvc,nbValidationSrvc,nbTextEditorSrvc,$q,inputFileSrvc,httpTenantAdminSrvc,dataElementDetailsSrvc,detailCompareSrvc,detailDrillDownLabelSrvc){var Const=dataElementDetailsSrvc.dataElementConst;var option=null;$scope.Wording={noDataText:Const.Wording.noDataText,noHistoryDataText:Const.Wording.noHistoryDataText,noHistoryDataTextWording:Const.Wording.noHistoryDataTextWording};$scope.stringData=[];var m_pageNumber=0;var m_pageSize=Const.DefaultPageSize;function initMember(){$scope.viewModel={mainDivId:"",Title:"",noData:!1,parserPathParam:"",parserPath:"",variableIconClass:"icon_nb_String_12",mode:0,gb:{status:Const.GoldenBaselineStatus.NotDefined,displayName:"Define Golden Baseline",gbDefinition:null,dataUnit:null,devInfo:null,mode:0,queryParams:null,dataViewInfo:null},showNote:!1,showDevIntfNote:!1,isDevIntfNote:!1,noteContent:"",showTextNote:!1,isTextNoteContent:!1,textNoteContent:"",noHistoryData:!0,loading:!0,inited:!1,gbs:Const.GoldenBaselineStatus,isShowOlderButton:!0,isShowNewerButton:!1,moreLoading:!1,rowCount:0,allRecordCount:0,noteTime:"",pop:{isShowPreview:!1,onShowTip:function(data,isShow){var dm=$scope.viewModel;isShow?dm.popMgr.show(data):dm.popMgr.hide(data)},onAsyncShowTip:function(data,isShow,e){var dm=$scope.viewModel;if(isShow){dm.popMgr.asyncShow(data,500);$timeout((function(){angular.element(".data-element-string-pane-preview-popover-box").css({left:e.pageX})}),600)}else dm.popMgr.asyncHide(data,10)}},popMgr:new nbPLM.MouseOverPopupManager({nShow:"isShowPreview",nId:"timePoint",onShow:function(){$timeout()},onHide:function(){$timeout()}}),gridBoxStyle:{},sampleText:"",showCompare:!1};$scope.stringData=[];m_pageNumber=0}function initGrid(displayName,needClick,columnList,valueList){var data=null;var column1={field:"value",displayName:displayName||"Name",width:"30%",cellTemplate:getTextCellTemplate(needClick)};var column11={field:"value",displayName:displayName||"Name",width:"30%",cellTemplate:getGdrTextCellTemplate("value",needClick)};var columns=[column1,{field:"timeText",displayName:"Time",width:"70%",cellTemplate:('<div class="ui-grid-cell-contents"><span>{{row.entity.timeText}}&nbsp;&nbsp;<span ng-if="row.entity.currentMapTime">(Map Data Time)</span><span ng-if="row.entity.isGbTime">(Golden Sample)</span></span></div>','<div class="ui-grid-cell-contents"><span>{{row.entity.timeText}}&nbsp;&nbsp;<span ng-if="row.entity.currentMapTime">(Map Data Time)</span><span ng-if="row.entity.isGbTime">(Golden Sample)</span></span></div>')}];if(columnList&&0===columnList.length){columns=[column11];setGridBoxStyle()}if(columnList&&columnList.length>0){columns=[];for(var i=0;i<columnList.length;i++){var col=columnList[i];var colObj={field:col.fieldName,displayName:col.name,headerTooltip:col.name,minWidth:100,dataFieldName:col.name,cellTemplate:getGdrTextCellTemplate(col.fieldName,!1)};columns.push(colObj)}data=valueList;setGridBoxStyle()}$scope.stringPaneGridOptions={data:"stringData",columnDefs:columns,multiSelect:!1,enableFullRowSelection:!0,enableSelection:!0,modifierKeysToMultiSelect:!1,enableRowHeaderSelection:!1,enableColumnResizing:!0,enableSorting:!1,flatEntityAccess:!0,onRegisterApi:function(gridApi){$timeout((function(){gridApi.grid.refresh()}),5)}};$scope.viewModel.mainDivId=NgUtil.getUniqueStr();$scope.viewModel.inited=!0;return{data:data}}$scope.cellClick1=function(row,$event){if(row.entity.noCompare){if(option.dataUnit.link){var devKey=option.devKey;var intfId=option.dataUnit.intfKey?option.dataUnit.intfKey.value:"";detailDrillDownLabelSrvc.getParseredLink(option.dataUnit.link,devKey,intfId).then((function(data){data&&window.open(data)}))}}else;};$scope.cellClick=function(row,$event){var timePoint={executeTime:row.entity.timePoint};dataElementDetailsSrvc.openCommonCompareModal(option,null,$scope.viewModel.gb,timePoint)};$scope.onClickCompare=function(){dataElementDetailsSrvc.openCommonCompareModal(option,null,$scope.viewModel.gb)};$scope.variableSampleClick=function(){if(option&&option.dataUnit&&option.dataUnit.parserPath){var parserPath=option.dataUnit.parserPath;var varName=option.dataUnit.varName;var title=$scope.viewModel.Title;var deviceId=option.devKey;var dataUnit=option.dataUnit;dataElementDetailsSrvc.showVariableSample(varName,parserPath,title,deviceId,dataUnit)}};$scope.onClickShowOlderData=function(){m_pageNumber++;refreshData().then((function(noData){noData&&m_pageNumber--;$scope.viewModel.isShowNewerButton=0!==m_pageNumber}))};$scope.onClickShowNewerData=function(){m_pageNumber=m_pageNumber<=0?0:m_pageNumber-1;refreshData().then((function(noData){noData&&m_pageNumber++;$scope.viewModel.isShowNewerButton=0!==m_pageNumber}))};function setGridBoxStyle(){$scope.viewModel.gridBoxStyle={height:"calc(100% - 32px)"}}function refreshData(){var defer=$q.defer();$scope.viewModel.moreLoading=!0;var tempUserEvt={gbOrigin:$scope.viewModel.gb.gbDefinition.origin,pageIndex:m_pageNumber,pageSize:m_pageSize};var noData=!1;detailDrillDownLabelSrvc.loadSubPaneData(option,null,tempUserEvt).then((function(obj){if(obj&&obj.data&&obj.data.valueList&&obj.data.valueList.length>0)showData(obj);else{noData=!0;$scope.viewModel.moreLoading=!1;$scope.viewModel.isShowOlderButton=!($scope.stringData.length<m_pageSize)}defer.resolve(noData)}));return defer.promise}function findIndexTwoRow(str,cha){var x=str.indexOf(cha);x>=0&&(x=str.indexOf(cha,x+cha.length));return x}function checkTextNoteContent(textNoteContent){var forceNoData=!1;if(textNoteContent&&'""'!==textNoteContent&&'{"ops":[{"insert":"\n"}]}'!==textNoteContent)try{var insert=JSON.parse(textNoteContent).ops[0].insert.trim();_.isEmpty(insert)&&(forceNoData=!0)}catch(e){forceNoData=!0}else forceNoData=!0;return forceNoData}function showData(pData){if(option){if(pData&&pData.gb&&pData.gb.rule){$scope.viewModel.gb.displayName=pData.gb.rule.displayName;$scope.viewModel.gb.gbDefinition=pData.gb;$scope.viewModel.gb.status=pData.gb.rule.status}if(option){$scope.viewModel.gb.dataUnit=option.dataUnit;$scope.viewModel.gb.devInfo=detailDrillDownLabelSrvc.getDevInfo(option);$scope.viewModel.gb.mode=$scope.viewModel.mode;$scope.viewModel.gb.queryParams=option.queryParams;$scope.viewModel.gb.dataViewInfo=option.dataViewInfo;$scope.viewModel.parserPathParam=detailDrillDownLabelSrvc.getParserPathParam(option);$scope.viewModel.parserPath=option.dataUnit.parserPath}var forceNoData=!1;if(pData&&pData.data){var data=pData.data;if($scope.viewModel.showDevIntfNote&&data.valueList&&data.valueList.length>0){var noteContent=('{"ops":[{"insert": "'+data.valueList[0].value.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')+'"}]}').replace(/\r\n/g,"\\n").replace(/\r/g,"\\n").replace(/\n/g,"\\n");if(!(forceNoData=checkTextNoteContent(noteContent))){$scope.viewModel.isDevIntfNote=!1;$timeout((function(){$scope.viewModel.isDevIntfNote=!0;$scope.viewModel.noteContent=noteContent}),50)}$scope.viewModel.noteTime=data.valueList[0].timeText}if($scope.viewModel.showTextNote){var textNoteContent=data.valueList[0].value;if(!(forceNoData=checkTextNoteContent(textNoteContent))){$scope.viewModel.isTextNoteContent=!1;$timeout((function(){$scope.viewModel.isTextNoteContent=!0;$scope.viewModel.textNoteContent=textNoteContent}),50)}$scope.viewModel.noteTime=data.valueList[0].timeText}else $timeout((function(){var needClick=$scope.viewModel.gb.status!==Const.GoldenBaselineStatus.NotApplicable;var gdrData=initGrid($scope.viewModel.Title,needClick,data.columnList,data.valueList);gdrData.data?$scope.stringData=gdrData.data:$scope.stringData=function(valueList){var newList=[];_.each(valueList,(function(val){if(val.value){val.html=val.value.trim().replace(/\n/g,"<br>");var index=findIndexTwoRow(val.value,"\r\n");index>=0?val.value=val.value.substr(0,index+1):(index=findIndexTwoRow(val.value,"\r"))>=0?val.value=val.value.substr(0,index+1):(index=findIndexTwoRow(val.value,"\n"))>=0&&(val.value=val.value.substr(0,index+1))}else{val.value=Const.NA;val.html=Const.NA}val.pop=$scope.viewModel.pop;newList.push(val)}));return newList}(data.valueList);$scope.viewModel.rowCount=data.allRecordCount?data.allRecordCount:data.valueList.length;$scope.viewModel.allRecordCount=data.allRecordCount?data.allRecordCount:data.valueList.length;$scope.viewModel.isShowOlderButton=$scope.stringData.length>=Const.DefaultPageSize;$scope.viewModel.showCompare=option.dataUnit.type===DataUnitSourceType.uSrcParserLibrary}),50);$scope.viewModel.noHistoryData=pData.data.noHistoryData}pData&&pData.data&&pData.data.valueList&&0!==pData.data.valueList.length&&!forceNoData?$scope.viewModel.noData=!1:$scope.viewModel.noData=!0;$scope.viewModel.loading=!1;$scope.viewModel.moreLoading=!1}}var setOptionEvent=$scope.$on(Const.Event.INIT_VARIABLE_PANE,(function(event,pOption){initMember();!function(pOption){option=pOption;$scope.viewModel.Title=dataElementDetailsSrvc.getVariableTitle(pOption.dataUnit.prefix,pOption.dataUnit.displayName,pOption.unitShowName);$scope.viewModel.hostName=pOption.hostName;$scope.viewModel.devKey=pOption.devKey;$scope.viewModel.mode=pOption.mode;var showDevIntfNote=pOption.dataUnit.type===DataUnitSourceType.uSrcCustomized&&pOption.dataUnit.valueType===Const.TempDataUnitValueType.uTempNote;$scope.viewModel.showDevIntfNote=showDevIntfNote;var showTextNote=pOption.dataUnit.type===DataUnitSourceType.uSrcCustomized&&pOption.dataUnit.valueType===DataUnitType.uParagraph;$scope.viewModel.showTextNote=showTextNote;$scope.viewModel.showNote=showDevIntfNote||showTextNote;pOption.mode===Const.DetailPaneMode.GbManager&&($scope.viewModel.sampleText="View Sample");$scope.viewModel.variableIconClass=dataElementDetailsSrvc.getVariableIcon(!1,pOption.dataUnit.type,pOption.dataUnit.valueType,!0)}(pOption)}));var setOptionLoading=$scope.$on(Const.Event.SHOW_VARIABLE_LOADING,(function(){$scope.viewModel.loading=!0}));var setOptionData=$scope.$on(Const.Event.SHOW_VARIABLE_DATA,(function(event,pData){showData(pData)}));!function(){initMember();initGrid()}();$scope.$on("$destroy",(function(){setOptionEvent();setOptionLoading();setOptionData()}));var popover='popover-placement="auto" popover-class="data-element-string-pane-preview-popover-box" uib-popover-template="\'dataElementStringPanePreviewPop.html\'" popover-trigger="\'none\'" popover-is-open="row.entity.isShowPreview" popover-append-to-body="true" ng-mouseover="grid.appScope.viewModel.pop.onAsyncShowTip(row.entity, true, $event)" ng-mouseleave="grid.appScope.viewModel.pop.onAsyncShowTip(row.entity, false)"';function getTextCellTemplate(needClick){return'<div ng-class="{\'has-alert-cell\': row.entity.alert > 0}" class="ui-grid-cell-contents" ><p class="link-cell '+(needClick?"show-link":"")+'" ng-click="grid.appScope.cellClick(row, $event);" ng-bind-html="row.entity.value"'+popover+"></p></div>"}function getGdrTextCellTemplate(fieldName,showLink){return'<div ng-class="{\'has-alert-cell\': row.entity.alert > 0}" class="ui-grid-cell-contents" ><p class="link-cell '+(showLink?"show-link":"")+'" ng-click="grid.appScope.cellClick(row, $event);" ng-bind-html="row.entity.'+fieldName+'" title="{{row.entity.'+fieldName+'}}" ></p></div>'}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataElementTableCompareCtrl",dataElementTableCompareCtrl);dataElementTableCompareCtrl.$inject=["$scope","$uibModal","$uibModalInstance","$timeout","$rootScope","$log","nb.admin.http3rdPartyApiIntegrationSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.nbValidationSrvc","nb.common.nbTextEditorSrvc","$q","nb.ng.inputFileSrvc","nb.admin.httpTenantAdminSrvc","nb.dataview.dataElementDetailsSrvc","dataHandler"];function dataElementTableCompareCtrl($scope,$uibModal,$uibModalInstance,$timeout,$rootScope,$log,http3rdPartyApiIntegrationSrvc,nbAlertSrvc,utilitySrvc,nbValidationSrvc,nbTextEditorSrvc,$q,inputFileSrvc,httpTenantAdminSrvc,dataElementDetailsSrvc,dataHandler){$scope.viewModel={mainDivId:"",noData:!1,summaryView:!0};$scope.tableCompareData=[];!function(){var columns=[{field:"role",displayName:"Dataset",width:"200",grouping:{groupPriority:0}},{field:"name",displayName:"Name",width:"200",cellTemplate:('<div class="ui-grid-cell-contents"><span>{{row.entity.name}}</span></div>','<div class="ui-grid-cell-contents"><span>{{row.entity.name}}</span></div>')},{field:"time",displayName:"Time",width:"*",cellTemplate:getTimeCellTemplate()}];$scope.tableCompareGridOptions={data:"tableCompareData",columnDefs:columns,multiSelect:!0,enableFullRowSelection:!0,enableSelection:!0,modifierKeysToMultiSelect:!0,enableRowHeaderSelection:!1,enableColumnResizing:!0,enableSorting:!1,onRegisterApi:function(gridApi){$timeout((function(){gridApi.grid.refresh()}),5)}};$timeout((function(){angular.element(".data-element-table-compare-box .compare-data").css("height","calc(100% - 45px)")}),1e3);$scope.tableCompareData.push({role:"add",name:"a",time:"aaa"});$scope.tableCompareData.push({role:"add",name:"b",time:"bbb"});$scope.tableCompareData.push({role:"delete",name:"aa",time:"aaaaaa"});$scope.tableCompareData.push({role:"delete",name:"bb",time:"bbbbbb"})}();$scope.onClose=function(){$uibModalInstance.dismiss({$value:"close"})};function getTimeCellTemplate(){return'<div class="ui-grid-cell-contents"><span>{{row.entity.time}}</span></div>'}}}(NetBrain);!function(netbrain){angular.module("nb.dataview").controller("nb.dataview.dataElementTablePaneCtrl",dataElementTablePaneCtrl);dataElementTablePaneCtrl.$inject=["$scope","$uibModal","$element","$timeout","$rootScope","$log","nb.admin.http3rdPartyApiIntegrationSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.nbValidationSrvc","nb.common.nbTextEditorSrvc","$q","nb.ng.inputFileSrvc","nb.admin.httpTenantAdminSrvc","nb.dataview.dataElementDetailsSrvc","nb.dataview.detailDrillDownLabelSrvc","nb.uiframework.urlStateMgr"];function dataElementTablePaneCtrl($scope,$uibModal,$element,$timeout,$rootScope,$log,http3rdPartyApiIntegrationSrvc,nbAlertSrvc,utilitySrvc,nbValidationSrvc,nbTextEditorSrvc,$q,inputFileSrvc,httpTenantAdminSrvc,dataElementDetailsSrvc,detailDrillDownLabelSrvc,urlStateMgr){var detailsSrvc=dataElementDetailsSrvc;var Const=detailsSrvc.dataElementConst;var option=null;var member={};$scope.Wording={noDataText:Const.Wording.noDataText};function initMember(){$scope.viewModel={mainDivId:"",Title:"",noData:!1,parserPathParam:"",parserPath:"",variableIconClass:"icon_nb_String_12",mode:0,gb:{status:Const.GoldenBaselineStatus.NotDefined,displayName:"Define Golden Baseline",gbDefinition:Const.getGoldenBaselineDefinition(),dataUnit:null,devInfo:null,mode:0,queryParams:null,dataViewInfo:null,goldenBaselineChanged:goldenBaselineChanged},search:{text:"",status:!1},rowCount:0,allRecordCount:0,timeListOption:{timeList:[],dataViewTimeList:[],dataEngineTimeList:[],gbTime:null,generateTime:"",dataViewShowName:"data view",refresh:!1,timePointChanged:timePointChanged,timePointInited:timePointInited,dropdownMenuStyle:{"max-width":"420px","max-height":"230px"},currentTimeItemChanged:null,pOption:null},generateTime:"",showTimeList:!1,loading:!0,tableRowCountLoading:!1,inited:!1,currentTabId:0,showTableRowCount:!1,enabledGrid:!0,moreLoading:!1,hasKey:!0,tableSpogInfo:null,sampleText:""};$scope.tableData=[];member.tableGridApi=null;member.columnNameList=[];member.currentUserEvt={timeOrigin:null};member.m_pageIndex=0;member.m_pageSize=Const.DefaultPageSize;member.gridLoading=!1;member.m_isAllLoaded=!1;member.isInSearch=!1;member.hasSearchResult=!1;member.isOnTableRowCountClick=!1;member.isGbData=null;member.firstDataTimeValue=null;member.m_needLoadByMap=!0;member.m_parserData=null;$scope.tableRowCountOption={tableRowCountChanged:tableRowCountChanged,data:{valueList:[],allRecordCount:0},generateTime:"",refreshRowCountData:refreshRowCountData}}function timePointChanged(userEvt){var timeValue=new Date(userEvt.timeOrigin.time).getTime();var generateTimeValue=new Date(option.dataUnit.generateTime).getTime();member.m_needLoadByMap=timeValue===generateTimeValue;$scope.tableData=null;member.currentUserEvt=userEvt;refreshData()}function timePointInited(userEvt,isFirstDataTime){$scope.viewModel.mode===Const.DetailPaneMode.Map?member.currentUserEvt=userEvt:$scope.viewModel.mode===Const.DetailPaneMode.GbManager&&(isFirstDataTime?member.currentUserEvt=userEvt:setTimeListSelectedItem())}function setTimeListSelectedItem(){if(member.firstDataTimeValue&&0!==member.firstDataTimeValue){var timeValue=member.firstDataTimeValue;_.isFunction($scope.viewModel.timeListOption.currentTimeItemChanged)&&$scope.viewModel.timeListOption.currentTimeItemChanged(timeValue,member.isGbData,!0)}}function prepareDataGrid(){$scope.tablePaneGridOptions={data:"tableData",columnDefs:[],multiSelect:!0,enableFullRowSelection:!0,enableSelection:!0,modifierKeysToMultiSelect:!0,enableRowHeaderSelection:!1,enableColumnResizing:!0,enableSorting:!1,excessColumns:100,flatEntityAccess:!0,onRegisterApi:function(gridApi){if(member.isOnTableRowCountClick)member.isOnTableRowCountClick=!1;else{member.tableGridApi=gridApi;member.tableGridApi.infiniteScroll.on.needLoadMoreData($scope,$scope.scrollToBottom);member.tableGridApi.infiniteScroll.on.needLoadMoreDataTop($scope,$scope.scrollToTop);member.tableGridApi.grid.registerRowsProcessor(singleFilter,200)}}}}$scope.scrollToBottom=function(){member.gridLoading?member.tableGridApi.infiniteScroll.dataLoaded(!1,!member.m_isAllLoaded):$scope.viewModel.loading||$scope.viewModel.moreLoading?member.tableGridApi.infiniteScroll.dataLoaded(!1,!member.m_isAllLoaded):$timeout((function(){!function(userEvt){if(!member.gridLoading&&!member.m_isAllLoaded){member.gridLoading=!0;$scope.viewModel.moreLoading=!0;var tempUserEvt=null;if(userEvt){var gbOrigin=$scope.viewModel.gb.gbDefinition.origin;var filter={pageIndex:member.m_pageIndex,pageSize:member.m_pageSize,filterWords:$scope.viewModel.search.text};tempUserEvt=_.extend({gbOrigin:gbOrigin,needLoadByMap:member.m_needLoadByMap},filter,userEvt)}detailDrillDownLabelSrvc.loadSubPaneData(option,null,tempUserEvt).then((function(obj){var pData=obj;if(pData&&pData.data&&pData.data.valueList&&pData.data.valueList.length>0){var data=pData.data;$scope.tableData=$scope.tableData.concat(data.valueList);member.m_isAllLoaded=data.allRecordCount?member.m_pageIndex*Const.DefaultPageSize>=data.allRecordCount:data.valueList.length<Const.DefaultPageSize;member.tableGridApi&&member.tableGridApi.infiniteScroll.dataLoaded(!1,!member.m_isAllLoaded)}member.gridLoading=!1;$scope.viewModel.moreLoading=!1;member.m_pageIndex+=1}))}}(member.currentUserEvt)}),50)};$scope.scrollToTop=function(){member.tableGridApi.infiniteScroll.dataLoaded(!1,!member.m_isAllLoaded)};function refreshData(isFirst){isFirst?$scope.viewModel.loading=!0:$scope.viewModel.moreLoading=!0;$scope.viewModel.noData=!1;!function(userEvt){var tempUserEvt=null;if(userEvt){var gbOrigin=$scope.viewModel.gb.gbDefinition.origin;var filter={pageIndex:0,pageSize:member.m_pageSize,filterWords:$scope.viewModel.search.text};tempUserEvt=_.extend({gbOrigin:gbOrigin,needLoadByMap:member.m_needLoadByMap},filter,userEvt)}$scope.viewModel.enabledGrid=!1;detailDrillDownLabelSrvc.loadSubPaneData(option,null,tempUserEvt).then((function(obj){$timeout((function(){prepareDataGrid();showData(obj);$scope.viewModel.enabledGrid=!0;member.isInSearch=!1}),50)}))}(isFirst?null:member.currentUserEvt)}function goldenBaselineChanged(isDefined){isDefined?refreshData(!0):refreshData()}function defineGoldenBaselineChanged(isDefined){goldenBaselineChanged(isDefined)}function tableRowCountChanged(timeText,timeValue){var showForTableRowCountChanged=function(timeItem){member.currentUserEvt={timeOrigin:timeItem.origin,isGoldenBaselineTime:timeItem.isGoldenBaselineTime,vrfList:timeItem.vrfList,nctList:timeItem.nctList};refreshData();_.isFunction($scope.viewModel.timeListOption.currentTimeItemChanged)&&$scope.viewModel.timeListOption.currentTimeItemChanged(timeValue);$timeout((function(){$scope.viewModel.currentTabId=0;$scope.viewModel.showTableRowCount=!1}),50)};member.m_needLoadByMap=!1;var timeList=$scope.viewModel.timeListOption.timeList;var index=_.findIndex(timeList,{timeValue:timeValue});var timeItem=null;if(index>=0){timeItem=timeList[index];showForTableRowCountChanged(timeItem)}else{moment.utc(new Date(timeValue)).local().format("YYYY-MM-DDThh:mm:ss");var duration={time:timeText,value:10,unit:2};var timeListType={timeListType:Const.TimeListType.timePointer};detailDrillDownLabelSrvc.loadSubPaneTimeList(option,duration,timeListType).then((function(timeObj){if(timeObj&&timeObj.timeList&&timeObj.timeList.length>0&&(index=_.findIndex(timeObj.timeList,{timeValue:timeValue}))>=0){timeItem=timeObj.timeList[index];showForTableRowCountChanged(timeItem)}}))}}function refreshRowCountData(duration,userEvt){var defer=$q.defer();detailDrillDownLabelSrvc.loadTableRowCount(option,duration,userEvt).then((function(data){var resultOption={data:{allRecordCount:data?data.allRecordCount:0,valueList:data?data.valueList:[]},generateTime:option.dataUnit.generateTime};defer.resolve(resultOption)}));return defer.promise}$scope.onTabClick=function(index){if(0===index){angular.element(".tbl-row-c").hide();$scope.viewModel.currentTabId=0;$scope.viewModel.showTableRowCount=!1}else if(1===index){member.isOnTableRowCountClick=!0;setMainPaneWidth(!0);$timeout((function(){$scope.viewModel.tableRowCountLoading=!0;detailDrillDownLabelSrvc.loadTableRowCount(option,{value:30},{pageIndex:0,pageSize:member.m_pageSize}).then((function(data){setMainPaneWidth(!1);data&&($scope.tableRowCountOption.data=data);$scope.tableRowCountOption.generateTime=option.dataUnit.generateTime;$timeout((function(){$scope.viewModel.currentTabId=1;$scope.viewModel.showTableRowCount=!0;$scope.viewModel.tableRowCountLoading=!1}),50)}))}),50)}};$scope.onClickCompare=function(){var timePoint=member.currentUserEvt?member.currentUserEvt.timeOrigin:null;dataElementDetailsSrvc.openCommonCompareModal(option,null,$scope.viewModel.gb,timePoint)};$scope.variableSampleClick=function(){if(option&&option.dataUnit&&option.dataUnit.parserPath){var parserPath=option.dataUnit.parserPath;var varName=option.dataUnit.varName;var title=$scope.viewModel.Title;var deviceId=option.devKey;var dataUnit=option.dataUnit;detailsSrvc.showVariableSample(varName,parserPath,title,deviceId,dataUnit)}};$scope.onClickExport=function(){if(member.currentUserEvt&&member.currentUserEvt.isGoldenBaselineTime){var para1={currentUnit:option.dataUnit,devKey:option.devKey,hostName:option.hostName,devType:option.devType,valueTime:member.currentUserEvt.timeOrigin.valueTime};detailsSrvc.exportGBTableData(para1)}else if(member.m_needLoadByMap)detailsSrvc.exportParserTableById(option.dataUnit.valueExpr.guid);else if(member.currentUserEvt&&member.currentUserEvt.timeOrigin&&option){var para={currentUnit:option.dataUnit,dataLocation:member.currentUserEvt.timeOrigin.dataLocation,devKey:option.devKey};detailsSrvc.exportParserTable(para)}};$scope.onSearchInputKeyUp=function(event,clear){if(!($scope.viewModel.loading||$scope.viewModel.moreLoading||"clear"!==clear&&13!==event.keyCode&&27!==event.keyCode&&8!==event.keyCode&&46!==event.keyCode)){if(27===event.keyCode){$scope.viewModel.search.text="";if(member.hasSearchResult){refreshData();member.hasSearchResult=!1;return}}if("clear"===clear||(8===event.keyCode||46===event.keyCode)&&""===$scope.viewModel.search.text){$scope.viewModel.search.text="";if(member.hasSearchResult){refreshData();member.hasSearchResult=!1;return}}if(13!==event.keyCode){member.tableGridApi.grid.refresh();$scope.viewModel.rowCount=member.tableGridApi.grid.getVisibleRowCount()}else{if(member.isInSearch)return;if($scope.viewModel.search.text){member.hasSearchResult=!0;member.isInSearch=!0;refreshData()}}}};$scope.searchDevice=function(){};$scope.onClickSetKey=function(){var parserInfo={id:member.m_parserData.id,catId:member.m_parserData.structureId};var url=StringUtil.format(NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.Parser,parserInfo);urlStateMgr.switchTabOrOpenNewTab(url,NetBrain.NG.Const.PageType.Parser,(function(){urlStateMgr.openNewTab(url)}))};$scope.missingInterfaceClick=function(){};$scope.onClickSetAsGoldenBaseline=function(){var handle={defineGoldenBaselineChanged:defineGoldenBaselineChanged};var timePoint=null;member.m_needLoadByMap||(timePoint={id:member.currentUserEvt.timeOrigin.id,dataLocation:member.currentUserEvt.timeOrigin.dataLocation,md5:member.currentUserEvt.timeOrigin.md5,sourceType:2});detailsSrvc.setTableAsGoldenBaseline($scope.viewModel.gb,timePoint,handle)};function ifHasKey(keys,uId){var result=!1;var varName=function(uId){var rVarName=uId;uId&&0===uId.indexOf("Single Value.")&&(rVarName=uId.replace("Single Value.","$"));return rVarName}(uId);var name=varName.replace(/\$/g,"");varName&&_.each(keys,(function(key){var arr=key.split(".");if(arr.length>=2){if(arr[arr.length-2].replace(/\$/g,"")===name){result=!0;return!1}}return!0}));return result}function showData(pData){if(option){if(pData&&pData.gb&&pData.gb.rule){$scope.viewModel.gb.displayName=pData.gb.rule.displayName;$scope.viewModel.gb.gbDefinition=pData.gb;$scope.viewModel.gb.status=pData.gb.rule.status}$scope.viewModel.gb.dataUnit=option.dataUnit;$scope.viewModel.gb.devInfo=detailDrillDownLabelSrvc.getDevInfo(option);$scope.viewModel.gb.mode=$scope.viewModel.mode;$scope.viewModel.gb.queryParams=option.queryParams;$scope.viewModel.gb.dataViewInfo=option.dataViewInfo;!function(parserData1){var setHasKey=function(parserData){$scope.viewModel.hasKey=!1;member.m_parserData=parserData;var uId=option.dataUnit.uId;option.dataUnit.mappingParserPath&&option.dataUnit.mappingVariable&&(uId=option.dataUnit.mappingVariable);if(parserData&&parserData.samples&&parserData.samples.length>0){var hasKey=ifHasKey(parserData.samples[0].interfaceKeys,uId);hasKey?$scope.viewModel.hasKey=!0:(hasKey=ifHasKey(parserData.samples[0].tableKeys,uId))&&($scope.viewModel.hasKey=!0)}};if(parserData1)setHasKey(parserData1);else if(option.dataUnit.parserPath){var parserPath=option.dataUnit.parserPath;option.dataUnit.mappingParserPath&&option.dataUnit.mappingVariable&&(parserPath=option.dataUnit.mappingParserPath);member.m_parserData&&member.m_parserData.path===parserPath?setHasKey(member.m_parserData):detailsSrvc.getParserByPath(parserPath).then((function(parserData2){setHasKey(parserData2)}),(function(){$scope.viewModel.hasKey=!1}))}else $scope.viewModel.hasKey=!1}(pData.gb&&pData.gb.dest?pData.gb.dest.parserData:null);$scope.viewModel.parserPathParam=detailDrillDownLabelSrvc.getParserPathParam(option);$scope.viewModel.parserPath=option.dataUnit.parserPath;if(pData&&pData.data&&(pData.data.valueList&&pData.data.valueList.length>0||pData.data.columnList&&pData.data.columnList.length>0)){var devInfo=detailDrillDownLabelSrvc.getDevInfo(option);(function(dataUnit,devInfo){var defer=$q.defer();detailsSrvc.prepareDataForTableSpog(dataUnit,devInfo).then((function(data){defer.resolve(data)}),(function(){defer.resolve(null)}));return defer.promise})(option.dataUnit,devInfo).then((function(spogData){var data=pData.data;member.columnNameList=_.pluck(data.columnList,"fieldName");var columnShowSetting=null;option.dataUnit.valueExpr&&option.dataUnit.valueExpr.columnShowSetting&&(columnShowSetting=option.dataUnit.valueExpr.columnShowSetting);timeValue=pData.dataTimeValue,generateTimeValue=new Date(option.dataUnit.generateTime).getTime(),timeValue&&0!==timeValue&&timeValue!==generateTimeValue&&(member.m_needLoadByMap=!1);var timeValue,generateTimeValue;var columnDefs=function(columnList,spogData,columnShowSetting){var varGroup=spogData&&spogData.varGroup?spogData.varGroup:[];varGroup.forEach((function(ele){ele.used=!1}));var cols=[];if(columnList){for(var i=0;i<columnList.length;i++){var col=columnList[i];var displayName=col.name;var isShowField=!1;if(columnShowSetting&&columnShowSetting.length>0){for(var j=0;j<columnShowSetting.length;j++){var columnShow=columnShowSetting[j];if(columnShow.name===col.name){displayName=columnShow.displayName;isShowField=!0;break}}isShowField=!member.m_needLoadByMap||isShowField}else isShowField=!0;if(isShowField){var isSpogCell=!1;var spogId="";varGroup.some((function(eleGroup){if(_.indexOf(eleGroup.linkedVars,col.name)>=0){eleGroup.used=!0;isSpogCell=!0;spogId=eleGroup.spogId;return!0}}));var colObj={field:col.fieldName,displayName:displayName,headerTooltip:displayName,dataFieldName:col.name,minWidth:90,used:isSpogCell,spogId:spogId,cellTemplate:getTextCellTemplate(col.fieldName,isSpogCell)};cols.push(colObj)}else varGroup.forEach((function(eleGroup){_.indexOf(eleGroup.linkedVars,col.name)>=0&&(eleGroup.used=!0)}))}if(columnShowSetting&&columnShowSetting.length>0){var currentIndex=0;for(var k=0;k<columnShowSetting.length;k++){var sortColumnShow=columnShowSetting[k];var index=_.findIndex(cols,{dataFieldName:sortColumnShow.name});if(index>=0){var item=cols[index];cols.splice(index,1);cols.splice(currentIndex,0,item);currentIndex++}}}}cols.forEach((function(_colObj){if(!_colObj.used&&varGroup.some((function(eleGroup){if(!eleGroup.used&&_.indexOf(eleGroup.relatedVars,_colObj.dataFieldName)>=0){_colObj.spogId=eleGroup.spogId;return!0}}))){_colObj.used=!0;_colObj.cellTemplate=getTextCellTemplate(_colObj.field,!0)}}));return cols}(data.columnList,spogData,columnShowSetting);if(columnDefs&&columnDefs.length>0){$scope.tablePaneGridOptions.columnDefs=columnDefs;$scope.viewModel.allRecordCount=data.allRecordCount?data.allRecordCount:data.valueList.length;$scope.tableData=data.valueList;$scope.viewModel.tableSpogInfo=spogData;member.m_isAllLoaded=data.allRecordCount?member.m_pageIndex*Const.DefaultPageSize>=data.allRecordCount:data.valueList.length<Const.DefaultPageSize;var noValue=!1;pData.data.valueList&&0===pData.data.valueList.length&&(noValue=!0);var noColumn=!1;pData.data.columnList&&0===pData.data.columnList.length&&(noColumn=!0);$scope.viewModel.noData=!(!noValue||!noColumn)}else{$scope.viewModel.noData=!0;$scope.viewModel.allRecordCount=0}$scope.viewModel.loading=!1;$scope.viewModel.inited=!0;$scope.viewModel.moreLoading=!1}));member.isGbData=pData.isGbData;member.firstDataTimeValue=pData.dataTimeValue;setTimeListSelectedItem();$scope.viewModel.mode===Const.DetailPaneMode.GbManager&&(member.m_needLoadByMap=!1)}else{$scope.viewModel.noData=!0;$scope.viewModel.loading=!1;$scope.viewModel.inited=!0;$scope.viewModel.moreLoading=!1}}}var setOptionEvent=$scope.$on(Const.Event.INIT_VARIABLE_PANE,(function(event,pOption){initMember();!function(pOption){option=pOption;$scope.viewModel.Title=detailsSrvc.getVariableTitle(pOption.dataUnit.prefix,pOption.dataUnit.displayName,pOption.unitShowName);$scope.viewModel.hostName=pOption.hostName;$scope.viewModel.devKey=pOption.devKey;$scope.viewModel.mode=pOption.mode;$scope.viewModel.generateTime=pOption.dataUnit.generateTime;pOption.mode===Const.DetailPaneMode.GbManager&&($scope.viewModel.sampleText="View Sample");$scope.viewModel.variableIconClass=detailsSrvc.getVariableIcon(!1,pOption.dataUnit.type,pOption.dataUnit.valueType,!0)}(pOption);$scope.onTabClick(0);prepareDataGrid()}));var setOptionLoading=$scope.$on(Const.Event.SHOW_VARIABLE_LOADING,(function(){$scope.viewModel.loading=!0}));var setOptionData=$scope.$on(Const.Event.SHOW_VARIABLE_DATA,(function(event,pData){showData(pData);member.m_pageIndex=1}));var setOptionTime=$scope.$on(Const.Event.SHOW_VARIABLE_TIME,(function(event,pTime,dataViewShowName){!function(pTime,dataViewShowName){if(pTime){$scope.viewModel.timeListOption.timeList=pTime.timeList;$scope.viewModel.timeListOption.dataViewTimeList=pTime.dataViewTimeList;$scope.viewModel.timeListOption.dataEngineTimeList=pTime.dataEngineTimeList;$scope.viewModel.timeListOption.gbTime=pTime.gbTime;$scope.viewModel.timeListOption.generateTime=$scope.viewModel.generateTime;$scope.viewModel.timeListOption.dataViewShowName=dataViewShowName;$scope.viewModel.timeListOption.pOption=option;if($scope.viewModel.showTimeList){$scope.viewModel.timeListOption.refresh=!0;$timeout((function(){$scope.viewModel.timeListOption.refresh=!1}),50)}else{$scope.viewModel.showTimeList=!1;(pTime.gbTime&&pTime.gbTime.isGoldenBaselineTime&&pTime.gbTime.timeText||pTime.timeList&&pTime.timeList.length>0||pTime.dataViewTimeList&&pTime.dataViewTimeList.length>0||pTime.dataEngineTimeList&&pTime.dataEngineTimeList.length>0)&&($scope.viewModel.showTimeList=!0)}}}(pTime,dataViewShowName)}));!function(){initMember();prepareDataGrid();$scope.viewModel.mainDivId=NgUtil.getUniqueStr();member.mainDivId="#"+$scope.viewModel.mainDivId}();$scope.$on("$destroy",(function(){setOptionEvent();setOptionLoading();setOptionData();setOptionTime()}));$scope.spogURLTipModel={popMgr:new nbPLM.MouseOverPopupManager({nShow:"isShowSpogURL",nId:"$id",onShow:function(){$timeout()},onHide:function(){$timeout()}}),popLayout:{tmpl:"drillDownActionSpogURLCellPop.html",placement:"top-left"}};$scope.onSpogCellClick=function(rowObj,colIndex){detailsSrvc.runSpogAction($scope.viewModel.tableSpogInfo,$scope.tablePaneGridOptions.columnDefs,rowObj,$scope.tablePaneGridOptions.columnDefs[colIndex])};$scope.onTriggerShowSpogURLTip=function(rowObj,colIndex,fieldName,status,e){var spogURLTipModel=$scope.spogURLTipModel;rowObj.$id=rowObj.$$hashKey+"_"+fieldName;rowObj.cShowSPOGCell=fieldName;status?rowObj[fieldName+"_URL"]?spogURLTipModel.popMgr.asyncShow(rowObj,500):function(rowObj,colIndex){return detailsSrvc.runSpogAction($scope.viewModel.tableSpogInfo,$scope.tablePaneGridOptions.columnDefs,rowObj,$scope.tablePaneGridOptions.columnDefs[colIndex],!0)}(rowObj,colIndex).then((function(url){rowObj[fieldName+"_URL"]=url;spogURLTipModel.popMgr.asyncShow(rowObj,500)})):spogURLTipModel.popMgr.asyncHide(rowObj,50)};$scope.onShowSpogURLTip=function(status){var spogURLTipModel=$scope.spogURLTipModel;status?spogURLTipModel.popMgr.show():spogURLTipModel.popMgr.hide()};function getTextCellTemplate(fieldName,isSpogCell){var tpl='<div class="ui-grid-cell-contents">';tpl+=isSpogCell?'<span class="spog-cell-span" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.viewModel.search.text" popover-placement="{{grid.appScope.spogURLTipModel.popLayout.placement}}" uib-popover-template="grid.appScope.spogURLTipModel.popLayout.tmpl" popover-trigger="\'none\'" popover-is-open="row.entity.isShowSpogURL&&row.entity.cShowSPOGCell==\''+fieldName+'\'" popover-append-to-body="true" ng-mouseover="grid.appScope.onTriggerShowSpogURLTip(row.entity,colRenderIndex + grid.renderContainers.body.currentFirstColumn,\''+fieldName+"', true, $event,row)\" ng-mouseleave=\"grid.appScope.onTriggerShowSpogURLTip(row.entity,colRenderIndex + grid.renderContainers.body.currentFirstColumn,'"+fieldName+'\', false)" ng-click="grid.appScope.onSpogCellClick(row.entity, colRenderIndex + grid.renderContainers.body.currentFirstColumn);">{{row.entity.'+fieldName+"}}</span>":'<span title="{{row.entity.'+fieldName+'}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.viewModel.search.text">{{row.entity.'+fieldName+"}}</span>";return tpl+="</div>"}function setMainPaneWidth(need){var mainTablePane=$element.closest(".pane-content").find(".sub-pane-body");need?mainTablePane.css("width","auto"):mainTablePane.css("width","")}function singleFilter(renderableRows){if(!$scope.viewModel.loading&&!$scope.viewModel.moreLoading){var matcher=new RegExp($scope.viewModel.search.text,"i");renderableRows.forEach((function(row){var match=!1;member.columnNameList.forEach((function(field){row.entity[field]&&row.entity[field].match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderableRows}}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataElementVariableSample",dataElementVariableSample);dataElementVariableSample.$inject=["$scope","$uibModal","$uibModalInstance","$timeout","$rootScope","$log","nb.admin.http3rdPartyApiIntegrationSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.nbValidationSrvc","nb.common.nbTextEditorSrvc","$q","dataHandler","nb.dataview.aceEditInitSrvc","nb.ng.inputFileSrvc","nb.admin.httpTenantAdminSrvc","nb.dataview.dataElementDetailsSrvc","nb.dataview.detailCompareSrvc"];function dataElementVariableSample($scope,$uibModal,$uibModalInstance,$timeout,$rootScope,$log,http3rdPartyApiIntegrationSrvc,nbAlertSrvc,utilitySrvc,nbValidationSrvc,nbTextEditorSrvc,$q,dataHandler,aceEditInitSrvc,inputFileSrvc,httpTenantAdminSrvc,dataElementDetailsSrvc){var data=dataHandler.getData();$scope.viewModel={variableDisplayName:"",parserName:"",parserDescription:"",parserSampleContent:""};$scope.parserOps={parserId:"",activeIndex:null,selectVarFullName:""};function showParserSample(parserId,variableFullName){$timeout((function(){$scope.parserOps.parserId=parserId;$scope.parserOps.activeIndex=1;$scope.parserOps.selectVarFullName="_original_result."+variableFullName;$rootScope.$broadcast("changeSampleTab",1)}),50)}!function(){$scope.aceOptions={onLoad:function(_ace){$scope.aceEditor_configFile=_ace;aceEditInitSrvc.initAceEditor($scope.aceEditor_configFile);$scope.aceEditor_configFile.setReadOnly(!0);$scope.aceEditor_configFile.setAnimatedScroll(!0);$scope.aceEditor_configFile.renderer.$cursorLayer.element.style.display="none"},useWrapMode:!1,showGutter:!0,theme:"textnb",mode:"textnb",advanced:{fontSize:12,enableBasicAutocompletion:!1,enableSnippets:!1,enableLiveAutocompletion:!1}};$scope.viewModel.variableDisplayName=data.title;data.parserId&&data.variableFullName?showParserSample(data.parserId,data.variableFullName):dataElementDetailsSrvc.getParserByPath(data.parserPath).then((function(parserData){if(parserData){var variableFullName=data.variableFullName;if(parserData.variables&&parserData.variables.length>0){var index=_.findIndex(parserData.variables,{name:data.variableName});index>=0&&(variableFullName=parserData.variables[index].fullName)}showParserSample(parserData.id,variableFullName)}}))}();$scope.onClose=function(){$uibModalInstance.dismiss({$value:"close"})}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").factory("nb.dataview.dataElementDetailsSrvc",dataElementDetailsSrvc);dataElementDetailsSrvc.$inject=["$rootScope","nb.ng.nbHttp","$q","$log","$uibModal","$location","nb.networkos.myFilesSrvc","nb.datamodel.httpSiteSrvc","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.uiframework.urlStateMgr","nb.ng.httpAuthSrvc","$timeout","nb.ng.utilitySrvc","nb.ng.sessionSrvc","nb.uiframework.mainUISrvc","nb.networkos.fileSrvc","nb.dataview.httpDataElementDetailsSrvc","nb.runbook.httpRunBookSrvc","nb.topo.httpTopoSrvc","nb.common.nbTipSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.qmap.httpMapLayoutSrvc","nb.qmap.mapContextMenuManager","nb.qmap.mapManagerSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.goldenbaseline.goldenBaselineSrvc","nb.deviceDetail.httpDeviceDetailSrvc","nb.dataviewtemplate.drillDownActionHttpSrvc","nb.goldenbaseline.goldenBaselineConsts","nb.qapp.httpQappResultSrvc","nb.dataview.detailPaneSrvc","nb.parserlib.parserEditSrvc","nb.common.cacheInterfaceInfoSrvc","nb.systemmodel.httpDeviceIconSrvc","nb.dataviewtemplate.drillDownActionRunPopupSrvc","nb.ng.httpDownloadingSrvc","nb.comparison.compareSrvc","nb.netbrain.httpDeviceSrvc"];function dataElementDetailsSrvc($rootScope,nbHttp,$q,$log,$uibModal,$location,myFilesSrvc,httpSiteSrvc,userSrvc,nbAlertSrvc,httpMapSrvc,urlStateMgr,httpAuthSrvc,$timeout,utilitySrvc,sessionSrvc,mainUISrvc,fileSrvc,httpDataElementDetailsSrvc,runbookMgr,httpTopoSrvc,nbTipSrvc,httpDeviceGroupSrvc,httpMapLayoutSrvc,mapContextMenuManager,mapManagerSrvc,deviceTypeMgrSrvc,goldenBaselineSrvc,httpDeviceDetailSrvc,drillDownActionHttpSrvc,goldenBaselineConsts,httpQappResultSrvc,detailPaneSrvc,parserEditSrvc,cacheInterfaceInfoSrvc,httpDeviceIconSrvc,drillDownActionRunPopupSrvc,httpDownloadingSrvc,compareSrvc,httpDeviceSrvc){var TempDataUnitValueType={uTempNote:"uTempNote",uTempString:"string",uTempNone:"uTempNone"};var stringTypes=[["string",TempDataUnitValueType.uTempString,DataUnitType.uString,DataUnitType.uBool,DataUnitType.uConfigLet,DataUnitType.uHyperLink,DataUnitType.uDoc,DataUnitType.uList,TempDataUnitValueType.uTempNote,DataUnitSourceType.uSrcCustomized,DataUnitSourceType.uSrcParserLibrary,DataUnitSourceType.uSrcGDR,DataUnitSourceType.uSrcCompoundVar],[DataUnitType.uParagraph,DataUnitSourceType.uSrcCustomized],[DataUnitType.uFloat,DataUnitType.uInt,DataUnitType.uCompoundVar,DataUnitType.uPercent,DataUnitSourceType.uSrcGDR],["string",TempDataUnitValueType.uTempString,DataUnitType.uString,DataUnitType.uBool,DataUnitType.uFloat,DataUnitType.uInt,DataUnitType.uCompoundVar,DataUnitType.uPercent,DataUnitSourceType.uSrcDeviceData,DataUnitSourceType.uSrcInputVar],[DataUnitType.uObject,DataUnitSourceType.uSrcGDR],[DataUnitType.uConfigFile,DataUnitSourceType.uSrcDeviceData]];var numberTypes=[[DataUnitType.uFloat,"uDouble",DataUnitType.uInt,DataUnitType.uCompoundVar,DataUnitType.uPercent,DataUnitSourceType.uSrcParserLibrary],[DataUnitType.uFloat,DataUnitType.uInt,DataUnitSourceType.uSrcCompoundVar]];var tableTypes=[[DataUnitType.uParagraph,DataUnitType.uTable,DataUnitType.uList_primitive_subtype,DataUnitType.uList_object_subtype,DataUnitType.uParserTable,DataUnitSourceType.uSrcParserLibrary,DataUnitSourceType.uSrcDeviceData]];var strPaneTypes=[["string",TempDataUnitValueType.uTempString,DataUnitType.uString,DataUnitType.uBool,DataUnitType.uConfigLet,DataUnitType.uHyperLink,DataUnitType.uDoc,DataUnitType.uList,TempDataUnitValueType.uTempNote,DataUnitSourceType.uSrcCustomized,DataUnitSourceType.uSrcParserLibrary,DataUnitSourceType.uSrcGDR,DataUnitSourceType.uSrcCompoundVar],[DataUnitType.uParagraph,DataUnitSourceType.uSrcCustomized],[DataUnitType.uFloat,DataUnitType.uInt,DataUnitType.uCompoundVar,DataUnitType.uPercent,DataUnitSourceType.uSrcGDR],["string",TempDataUnitValueType.uTempString,DataUnitType.uString,DataUnitType.uBool,DataUnitType.uFloat,DataUnitType.uInt,DataUnitType.uCompoundVar,DataUnitType.uPercent,DataUnitSourceType.uSrcDeviceData,DataUnitSourceType.uSrcInputVar],[DataUnitType.uObject,DataUnitSourceType.uSrcGDR]];var numPaneTypes=[[DataUnitType.uFloat,"uDouble",DataUnitType.uInt,DataUnitType.uCompoundVar,DataUnitType.uPercent,DataUnitSourceType.uSrcParserLibrary],[DataUnitType.uFloat,DataUnitType.uInt,DataUnitSourceType.uSrcCompoundVar]];var parTblPaneTypes=[[DataUnitType.uParagraph,DataUnitType.uTable,DataUnitType.uList_primitive_subtype,DataUnitType.uList_object_subtype,DataUnitType.uParserTable,DataUnitSourceType.uSrcParserLibrary]];var devTblPaneTypes=[[DataUnitType.uConfigFile,DataUnitType.uTable,DataUnitSourceType.uSrcDeviceData]];var stringIcons=[["string",TempDataUnitValueType.uTempString,DataUnitType.uString,DataUnitType.uBool,DataUnitType.uConfigLet,DataUnitType.uHyperLink,DataUnitType.uDoc,DataUnitType.uList,DataUnitSourceType.uSrcCustomized,DataUnitSourceType.uSrcParserLibrary,DataUnitSourceType.uSrcGDR,DataUnitSourceType.uSrcCompoundVar],[DataUnitType.uFloat,DataUnitType.uInt,DataUnitType.uCompoundVar,DataUnitType.uPercent,DataUnitSourceType.uSrcGDR],["string",TempDataUnitValueType.uTempString,DataUnitType.uString,DataUnitType.uBool,DataUnitType.uFloat,DataUnitType.uInt,DataUnitType.uCompoundVar,DataUnitType.uPercent,DataUnitSourceType.uSrcDeviceData,DataUnitSourceType.uSrcInputVar],[DataUnitType.uObject,DataUnitSourceType.uSrcGDR]];var numberIcons=[[DataUnitType.uFloat,"uDouble",DataUnitType.uInt,DataUnitType.uCompoundVar,DataUnitType.uPercent,DataUnitSourceType.uSrcParserLibrary],[DataUnitType.uFloat,DataUnitType.uInt,DataUnitSourceType.uSrcCompoundVar]];var tableIcons=[[DataUnitType.uParagraph,DataUnitType.uTable,DataUnitType.uList_primitive_subtype,DataUnitType.uList_object_subtype,DataUnitType.uParserTable,DataUnitSourceType.uSrcParserLibrary],[DataUnitType.uConfigFile,DataUnitType.uTable,DataUnitSourceType.uSrcDeviceData]];var noteIcons=[[TempDataUnitValueType.uTempNote,DataUnitSourceType.uSrcCustomized]];var insertTextIcons=[[DataUnitType.uParagraph,DataUnitSourceType.uSrcCustomized],[DataUnitType.uParagraph,DataUnitSourceType.uSrcCustomized]];var attachFileIcons=[[DataUnitType.uDoc,DataUnitSourceType.uSrcCustomized]];var noneIcons=[[TempDataUnitValueType.uTempNone,DataUnitSourceType.uSrcCustomized]];var Const={NA:"N/A",DetailPaneMode:{Map:1,GbManager:0},DataUnitNoAlarmValue:0,DataUnitAlarmValue:2,TempDataUnitValueType:TempDataUnitValueType,uIdType:{Note:"Note"},VariableType:{none:"none",string:"string",number:"number",table:"table"},VariablePaneType:{none:"none",string:"string",number:"number",parserTable:"parserTable",deviceTable:"deviceTable",empty:"empty"},DataType:{string:0,number:1,table:2},chartRangeSelector:[{type:"day",count:1,text:"1D"},{type:"day",count:5,text:"5D"},{type:"day",count:7,text:"7D"},{type:"day",count:30,text:"30D",selected:!0},{type:"all",text:"MAX"}],chartDateTimeLabelFormats:{millisecond:"%I:%M:%S %p",second:"%I:%M:%S %p",minute:"%I:%M %p",hour:"%I:%M %p",day:"%m/%d",week:"%m/%d",month:"%Y/%m",year:"%Y"},LEGEND_COLOR:["#2F7ED8","#90ED7D","#FEC321","#0D233A","#6666FF","#FF6633","#66CC99","#FF3366","#CC99FF","#F69C9F","#6AF9C4","#FFFD74","#003366","#8BBC21","#50B432","#ED561B","#DDDF00","#24CBE5","#64E572","#FF9655"],Event:{INIT_VARIABLE_PANE:"INIT_VARIABLE_PANE",SHOW_VARIABLE_DATA:"SHOW_VARIABLE_DATA",SHOW_VARIABLE_TIME:"SHOW_VARIABLE_TIME",SHOW_VARIABLE_LOADING:"SHOW_VARIABLE_LOADING",DETAIL_PANE_RESIZE_EVENT:"DETAIL_PANE_RESIZE_EVENT"},Mode:{InManager:0,InMap:1},GoldenBaselineStatus:{NotDefined:0,NoAlerts:1,AlertDetected:2,NotApplicable:3},CompareStatus:{Unchanged:0,Deleted:1,Inserted:2,Imaginary:3,Modified:4},GBVariableType:{none:0,string:1,bool:2,int:3,double:4,ip:5,mac:6,device:7,interface:8,statement:9,procedure:12,probe:13,cmd:14,trigger:15,summaryTrigger:16,filter:17,paragraph:18,table:19,percent:23,IPv6:24,float:25},parserParamKeySuffix:"_param",DefaultPageSize:200,TimeListType:{dataView:"dataView",dataEngine:"dataEngine",all:"all",timePointer:"timePointer",timePointerWithGb:"timePointerWithGb"},getGoldenBaselineDefinition:function(error,displayName){return{error:error,errorMsg:"",origin:null,rule:{displayName:displayName||"",status:Const.GoldenBaselineStatus.NotApplicable,lines:[],bands:null},dest:{parserData:null}}},getDataUserFilter:function(){return{pageIndex:0,pageSize:this.DefaultPageSize}},getTimeAroundDuration:function(){return{value:30}},getTimeListUserFilter:function(type){return{pageIndex:0,pageSize:this.TimeListPageSize,timeListType:type||this.TimeListType.all}},getTimeListResultObj:function(){return{gbTime:null,timeList:null,allRecordCount:0,dataViewTimeList:null,dataViewAllRecordCount:0,dataEngineTimeList:null,dataEngineAllRecordCont:0}},getTimeItemObj:function(isGbTime){return{origin:null,isGoldenBaselineTime:isGbTime,timeText:"",timeValue:0}},TimeListPageSize:20,htmlEncodeByRegExp:function(value){var en=_.pluck([{en:"&",de:"&amp;"},{en:"<",de:"&lt;"},{en:">",de:"&gt;"},{en:" ",de:"&nbsp;"},{en:"'",de:"&#39;"},{en:'"',de:"&quot;"}],"en");return Utility.htmlEncodeByRegExp(value,en).replace(/"/g,'"')},Wording:{noDataText:"There is currently no data available for the selected variable.",noHistoryDataText:"There is no history data available for the selected variable.",noHistoryDataTextWording:"No history data exists for this type of data.",pleaseSelectVariable:"Please select a variable on left."},formatDateTime:function(dateTime){return moment.utc(dateTime).local().format("MM/DD/YYYY hh:mm:ss A")}};function isIncludeType(typeArrs,t,vt){var is=!1;for(var i=0;i<typeArrs.length;i++){var typeArr=typeArrs[i];_.indexOf(typeArr,t)>=0&&_.indexOf(typeArr,vt)>=0&&(is=!0)}return is}function getVariableType(type,valueType){var t=type;var vt=valueType;if(!t&&!vt){t=DataUnitSourceType.uSrcCustomized;vt=TempDataUnitValueType.uTempString}t||(t=DataUnitSourceType.uSrcCustomized);vt||(vt=TempDataUnitValueType.uTempString);return isIncludeType(stringTypes,t,vt)?Const.VariableType.string:isIncludeType(numberTypes,t,vt)?Const.VariableType.number:isIncludeType(tableTypes,t,vt)?Const.VariableType.table:Const.VariableType.none}function getAllDevicesOnMapWithMore(withNetMapOperator,bIncludeNonRealDevice){var netMapOperator=mapManagerSrvc.getActivePage().getNetmapOperator();var devices=netMapOperator.getAllDevcies(!0,bIncludeNonRealDevice);return withNetMapOperator?{devices:devices,netMapOperator:netMapOperator}:devices}function getAllDevicesOnMap(withNetMapOperator){return getAllDevicesOnMapWithMore(withNetMapOperator,!0)}function buildIconString(className,oc,alertSpan){return oc?className:'<div class="var-icon-div"><div tag="{tag}" class="'+className+' var-icon"></div>'+alertSpan+"</div>"}function trimRightColon(str){var ts="";str&&":"===(ts=(ts=str.trim()).replace(/:+$/,""))[ts.length-1]&&(ts=ts.substr(0,ts.length-1));return ts}function getUnitShowName(prefix,displayName,displayInfo,type,valueType,noNeedTrim){return noNeedTrim?prefix||displayName||displayInfo:trimRightColon(type||valueType?prefix||displayName||displayInfo:displayInfo||displayName)}function getRealVariableName(uId,displayName,valueType){var rVarName=uId;if(uId){0===uId.indexOf("Single Value.")&&(rVarName=uId.replace("Single Value.","$"));valueType===DataUnitType.uParserTable&&(rVarName=uId.substr(uId.lastIndexOf(".")+1))}else displayName&&(rVarName=displayName);return rVarName}function getDataUnitParserParam(dataUnit,variableValues){var param=null;if(dataUnit.parserPath&&variableValues){var key=dataUnit.parserPath.replace(/\./g,"@")+Const.parserParamKeySuffix;if(variableValues[key]){param={};var val=null;"{}"!==variableValues[key]&&(val=variableValues[key]);var obj=null;try{obj=JSON.parse(val)}catch(e){}if(obj){param[key]=obj;param.param=obj}else{param[key]=val;param.param=val}}}return param}function getParserParamObj(dataUnit){var obj=null;if(dataUnit.parserPath){var key=dataUnit.parserPath.replace(/\./g,"@")+Const.parserParamKeySuffix;if(dataUnit[key])if(_.isObject(dataUnit[key]))obj=dataUnit[key];else try{obj=JSON.parse(dataUnit[key])}catch(err){console.log("Failed to parse json obj from parser param.",obj)}}return obj}function getDevUnit(dataUnit,posInfo,posName,variableValues){var type=dataUnit.type;var valueType=dataUnit.valueType;var unitName=getUnitShowName(dataUnit.prefix,dataUnit.displayName,posInfo.displayInfo,type,valueType);delete angular.copy(posInfo).dataUnitList;var parserParam=getDataUnitParserParam(dataUnit,variableValues);var varName=getRealVariableName(dataUnit.uId,null,dataUnit.valueType);return{id:dataUnit.uId,name:unitName,dataUnit:_.extend({},parserParam,dataUnit,{displayTemplate:posInfo.displayTemplate,varName:varName}),variableType:getVariableType(type,valueType),children:[],posName:posName}}function getNoteNode(note,i,variableValues,pId,intfKey){var noteDataUnit=function(noteItem,title,intfKey){var generateTime=(new Date).toDateString();var value="";if(noteItem&&noteItem.noteContent){generateTime=noteItem.timeStamp;value=DataViewHelper.formatNote(noteItem).content}return{alarm:Const.DataUnitNoAlarmValue,displayName:"",displayTemplate:"",generateTime:generateTime,intfKey:intfKey,prefix:title,type:DataUnitSourceType.uSrcCustomized,uId:title,value:value,valueType:TempDataUnitValueType.uTempNote}}(note,note.title,intfKey);var noteNode={id:noteDataUnit.uId,name:note.title,dataUnit:noteDataUnit,variableType:Const.VariableType.string,children:[],pId:pId,posName:"f"+i};_.each(note.refVariables,(function(dataUnit,index){var type=dataUnit.type;var valueType=dataUnit.valueType;var unitName=getUnitShowName(dataUnit.prefix,dataUnit.displayName,dataUnit.uId,type,valueType);var parserParam=getDataUnitParserParam(dataUnit,variableValues);var varName=getRealVariableName(dataUnit.uId,dataUnit.displayName,dataUnit.valueType);var subUnit={id:dataUnit.uId||dataUnit.displayName,name:unitName,dataUnit:_.extend({},parserParam,dataUnit,{displayTemplate:"$"+dataUnit.displayName,varName:varName,intfKey:intfKey}),variableType:getVariableType(type,valueType),children:[],pId:pId,posName:"f"+noteNode.id+"f"+index};dataUnit.alarm===Const.DataUnitAlarmValue&&(noteNode.dataUnit.alarm=Const.DataUnitAlarmValue);noteNode.children.push(subUnit)}));return noteNode}function getDeviceUnit(dvData){var unitData=[];_.each(dvData.devPosList,(function(devPos){var posInfo=devPos.posInfo;if(posInfo&&posInfo.dataUnitList&&posInfo.dataUnitList.length>0){var devUnit=getDevUnit(posInfo.dataUnitList[0],posInfo,devPos.posName,dvData.variableValues);unitData.push(devUnit)}else devPos.extraData&&devPos.extraData.overflowList&&_.each(devPos.extraData.overflowList,(function(devOverPos){if(devOverPos&&devOverPos.posInfo&&devOverPos.posInfo.dataUnitList&&devOverPos.posInfo.dataUnitList.length>0){var devOverPosInfo=devOverPos.posInfo;var devOverUnit=getDevUnit(devOverPosInfo.dataUnitList[0],devOverPosInfo,devOverPos.posName,dvData.variableValues);unitData.push(devOverUnit)}}))}));_.each(dvData.deviceNotes,(function(devNote,i){var noteNode=getNoteNode(devNote,i,dvData.variableValues);unitData.push(noteNode)}));return{unitData:unitData}}function getIntfObj(linkLine,deviceId){return linkLine.from===deviceId&&linkLine.intfSrc?linkLine.intfSrc:linkLine.to===deviceId&&linkLine.intfDest?linkLine.intfDest:null}function getIntfObjList(deviceId,netMapOperator){var intfInfoList=[];var linkLines=netMapOperator._netmap.getConnectedLinkDatasByDeviceId(deviceId);if(linkLines)for(var i=0;i<linkLines.length;i++){var linkLine=linkLines[i];if(_.isFunction(linkLine.getCategory)&&netBrain.Map.CategoryMgr.isTopolink(linkLine.getCategory())){var intfObj=getIntfObj(linkLine,deviceId);intfObj&&intfInfoList.push(intfObj)}}return intfInfoList}function getIntfUnit(dataUnit,intfPosInfo,intfId,posName,intfKey,variableValues){var type=dataUnit.type;var valueType=dataUnit.valueType;var unitName=getUnitShowName(dataUnit.prefix,dataUnit.displayName,intfPosInfo.displayInfo,type,valueType);delete angular.copy(intfPosInfo).dataUnitList;var parserParam=getDataUnitParserParam(dataUnit,variableValues);var varName=getRealVariableName(dataUnit.uId,null,dataUnit.valueType);return{id:dataUnit.uId,name:unitName,dataUnit:_.extend({},parserParam,dataUnit,{displayTemplate:intfPosInfo.displayTemplate,varName:varName,intfKey:intfKey}),variableType:getVariableType(type,valueType),children:[],pId:intfId,posName:posName}}function getInterfaceUnit(dvData,devKey,netMapOperator,currentUnitId){var unitData=[];var intfObjList=getIntfObjList(devKey,netMapOperator);_.each(intfObjList,(function(intfObj){var dataViewInfo=intfObj.dataViewInfo;var dvDataDataViewInfo=null;dvData.dataViewInfo?dvDataDataViewInfo=dvData.dataViewInfo:dvData.dataViewInfos&&dvData.dataViewInfos.length>0&&(dvDataDataViewInfo=dvData.dataViewInfos[0]);if(dvDataDataViewInfo&&dataViewInfo&&dvDataDataViewInfo.dataViewGroupId===dataViewInfo.dataViewGroupId){var intfInfo=intfObj.intfInfo;var intf=intfInfo.intf;var intfName=intf&&intf.intfDisplaySchemaObj&&intf.intfDisplaySchemaObj.value||"test-InterfaceName";var intfId=intf&&intf.intfKeyObj&&intf.intfKeyObj.value;var intfKey=function(intf){var intfKey=null;intf&&intf.intfDisplaySchemaObj&&intf.intfKeyObj&&(intfKey={schema:intf.intfKeyObj.schema,value:intf.intfKeyObj.value,name:intf.intfDisplaySchemaObj.value});return intfKey}(intf);var intfNode={id:intfId,name:intfName,dataUnit:{uId:intfId,type:DataUnitSourceType.uSrcCustomized,valueType:TempDataUnitValueType.uTempNone,intfKey:intfKey},variableType:Const.VariableType.none,children:[],pId:"",posName:""};_.each(intfInfo.intfPosList,(function(intfPos){if("intfPos0"!==intfPos.posName){var intfPosInfo=intfPos.posInfo;if(intfPosInfo&&intfPosInfo.dataUnitList&&intfPosInfo.dataUnitList.length>0){var intfUnit=getIntfUnit(intfPosInfo.dataUnitList[0],intfPosInfo,intfId,intfPos.posName,intfKey,dvData.variableValues);intfNode.children.push(intfUnit)}else intfPos.extraData&&intfPos.extraData.overflowList&&_.each(intfPos.extraData.overflowList,(function(intfOverPos){if(intfOverPos&&intfOverPos.posInfo&&intfOverPos.posInfo.dataUnitList&&intfOverPos.posInfo.dataUnitList.length>0){var intfOverPosInfo=intfOverPos.posInfo;var intfUnitExtra=getIntfUnit(intfOverPosInfo.dataUnitList[0],intfOverPosInfo,intfId,intfOverPos.posName,intfKey,dvData.variableValues);intfNode.children.push(intfUnitExtra)}}))}}));_.each(intfInfo.intfNotes,(function(intfNote,i){var noteNode=getNoteNode(intfNote,i,dvData.variableValues,intfId,intfKey);intfNode.children.push(noteNode)}));intfNode.children.length>0&&unitData.push(intfNode)}}));return{unitData:unitData,currentUnit:null}}function getNodeByPosName(treeData,uId,posName){var result=function getNodeByPosName2(treeData,uId,posName){var result=null;_.some(treeData,(function(node){return node.dataUnit&&node.dataUnit.uId===uId&&node.posName===posName?result=node:!!(node.children&&node.children.length>0&&(result=getNodeByPosName2(node.children,uId,posName)))&&result}));return result}(treeData,uId,posName);var firstNode=function getFirstNode(treeData){var result=null;_.some(treeData,(function(node){return node.posName&&node.variableType!==Const.VariableType.none&&null===result?result=node:!!(node.children&&node.children.length>0&&(result=getFirstNode(node.children)))&&result}));return result}(treeData);return result||firstNode}function setNewAlarm(unitData1,unitData2){console.log(unitData1,unitData2)}function getCurrentDataUnitAndPosName(pOption){var devKey=pOption.devKey;var posName=pOption.posName;var resultObj=null;var devOnMapObj=getAllDevicesOnMap(!0);var netMapOperator=devOnMapObj.netMapOperator;var devices=devOnMapObj.devices;var index=_.findIndex(devices,{key:devKey});if(index>=0){var dev=devices[index];var dvData=dev.dataViewData;if(dvData){var tempDevUnits=getDeviceUnit(dvData);var tempIntfUnits=getInterfaceUnit(dvData,dev.key,netMapOperator);var dataUnit=pOption.dataUnit;if(!dataUnit.intfKey){var devUnit=getNodeByPosName(tempDevUnits.unitData,dataUnit.uId,posName);resultObj=devUnit?{currentDataUnit:devUnit.dataUnit,posName:devUnit.posName}:null}else{var intfIndex=_.findIndex(tempIntfUnits.unitData,{id:dataUnit.intfKey.value});var intfUnit=getNodeByPosName(intfIndex>=0?[tempIntfUnits.unitData[intfIndex]]:tempIntfUnits.unitData.length>0?[tempIntfUnits.unitData[0]]:tempIntfUnits.unitData,dataUnit.uId,posName);resultObj=intfUnit?{currentDataUnit:intfUnit.dataUnit,posName:intfUnit.posName}:null}}}return resultObj}function getAppliedDataViewInfo(){return mapManagerSrvc.getAppliedDataViewInfo()}function getIfObjFromCache(value,schema){var defer=$q.defer();cacheInterfaceInfoSrvc.getData({intfKeyObj:{value:value,schema:schema}}).then((function(data){data&&data.JsonObj?defer.resolve(data.JsonObj):defer.resolve({})})).catch((function(){(function(value,schema){return httpTopoSrvc.getIfObj({intfKeyObj:{value:value,schema:schema}})})(value,schema).then((function(data2){data2&&data2.JsonObj?defer.resolve(data2.JsonObj):defer.resolve({})}))}));return defer.promise}function getParserByPath(parserPath){return parserEditSrvc.getParserByPath(parserPath)}function resetGenerateTime(generateTime){var gt=generateTime;"0001-01-01T00:00:00"!==generateTime&&generateTime||(gt=moment.utc(new Date).local().format("YYYY-MM-DDThh:mm:ss"));return gt}function getDevNodeData(devKey){var devNodeData=null;var devices=getAllDevicesOnMap(!0).devices;var index=_.findIndex(devices,{key:devKey});if(index>=0){var dev=devices[index];dev&&(devNodeData=dev.devNodeData)}return devNodeData}return{dataElementConst:Const,getDeviceDataType:function(uId){var deviceDataType=1;switch(uId){case DeviceDataType.RouteTable:deviceDataType=2;break;case DeviceDataType.ArpTable:deviceDataType=4;break;case DeviceDataType.MacTable:deviceDataType=6;break;case DeviceDataType.CdpTable:deviceDataType=8;break;case DeviceDataType.StpTable:deviceDataType=10;break;case DeviceDataType.NctTable:deviceDataType=12;break;case DeviceDataType.BgpNbrTable:deviceDataType=16;break;case DeviceDataType.Config:deviceDataType=1}return deviceDataType},getVariableType:getVariableType,getVariablePaneType:function(type,valueType,uId){var t=type;var vt=valueType;if(!t&&!vt){t=DataUnitSourceType.uSrcCustomized;vt=TempDataUnitValueType.uTempString}t||(t=DataUnitSourceType.uSrcCustomized);vt||(vt=TempDataUnitValueType.uTempString);var paneType=Const.VariablePaneType.none;return isIncludeType(strPaneTypes,t,vt)?Const.VariablePaneType.string:isIncludeType(numPaneTypes,t,vt)?Const.VariablePaneType.number:isIncludeType(parTblPaneTypes,t,vt)?Const.VariablePaneType.parserTable:isIncludeType(devTblPaneTypes,t,vt)?Const.VariablePaneType.deviceTable:paneType},getVariableIcon:function(hasAlert,type,valueType,onlyClass){var alertSpan="";hasAlert&&(alertSpan='<span class="var-icon-alert">&nbsp;</span>');var oc=onlyClass;var t=type;var vt=valueType;if(!t&&!vt){t=DataUnitSourceType.uSrcCustomized;vt=TempDataUnitValueType.uTempString}t||(t=DataUnitSourceType.uSrcCustomized);vt||(vt=TempDataUnitValueType.uTempString);var isElse=!1;var icon="";if(isIncludeType(attachFileIcons,t,vt))icon=buildIconString("icon_nb_attach_file_12",oc,alertSpan);else if(isIncludeType(stringIcons,t,vt))icon=buildIconString("string_icon",oc,alertSpan);else if(isIncludeType(numberIcons,t,vt))icon=buildIconString("icon_nb_parser_variable",oc,alertSpan);else if(isIncludeType(tableIcons,t,vt))icon=buildIconString("table_variable_icon",oc,alertSpan);else if(isIncludeType(noteIcons,t,vt))icon=buildIconString("note_02-12",oc,alertSpan);else if(isIncludeType(insertTextIcons,t,vt))icon=buildIconString("icon-nb-pure-text",oc,alertSpan);else if(isIncludeType(noneIcons,t,vt)){icon='<div class="var-icon-div-none"><div tag="{tag}"></div></div>';oc&&(icon="")}else{icon='<div class="var-icon-div"><div tag="{tag}" style="width: 12px; height: 12px;"></div></div>';oc&&(icon="string_icon");isElse=!0}return oc?icon:{icon:icon,isElse:isElse}},getVariableIconString:function(hasAlert,variableType,folderType,onlyClass){var alertSpan="";hasAlert&&(alertSpan='<span class="var-icon-alert">&nbsp;</span>');var icon="";if(variableType===Const.VariableType.string){icon='<div class="var-icon-div"><div tag="{tag}" class="string_icon var-icon"></div>'+alertSpan+"</div>";onlyClass&&(icon="string_icon")}else if(variableType===Const.VariableType.number){icon='<div class="var-icon-div"><div tag="{tag}" class="string_icon var-icon"></div>'+alertSpan+"</div>";onlyClass&&(icon="string_icon")}else if(variableType===Const.VariableType.table){icon='<div class="var-icon-div"><div tag="{tag}" class="table_icon var-icon"></div>'+alertSpan+"</div>";onlyClass&&(icon="table_variable_icon")}else if(variableType===Const.VariableType.none){icon='<div class="var-icon-div"><div tag="{tag}" style="width: 12px; height: 12px;"></div></div>';onlyClass&&(icon="string_icon")}else{icon='<div class="var-icon-div"><div tag="{tag}" style="width: 12px; height: 12px;"></div></div>';onlyClass&&(icon="string_icon")}if(folderType===Const.FolderType.note){icon='<div class="var-icon-div"><div tag="{tag}" class="note_02-12 var-icon"></div>'+alertSpan+"</div>";onlyClass&&(icon="note_02-12")}return icon},getDeviceList:function(){var devList=[];var devices=getAllDevicesOnMap();_.each(devices,(function(item){var dvData=item.dataViewData;if(dvData&&dvData.templateId){var imageName="";dvData.devGraphicInfo&&dvData.devGraphicInfo.imageList&&dvData.devGraphicInfo.imageList.length>0&&(imageName=dvData.devGraphicInfo.imageList[0].name);devList.push({hostName:item.hostName,devKey:item.key,devType:item.devType,imageName:imageName})}}));return devList=_.sortBy(devList,"hostName")},getSelectedDevice:function(devList,devKey){var dev=null;_.each(devList,(function(item){if(item.devKey===devKey){dev=item;return!1}return!0}));return dev},getPageId:function(){var page=mapManagerSrvc.getActivePage();return page?page.getDocId():"0"},getDataUnitParserParamByDevKey:function(devKey,dataUnit){var param=null;var devices=getAllDevicesOnMap();var index=_.findIndex(devices,{key:devKey});if(index>=0){param=getDataUnitParserParam(dataUnit,devices[index].dataViewData.variableValues)}return param},getParserParamObj:getParserParamObj,getUnitList:function(){var result={};var devUnitData={};var intfUnitData={};var devOnMapObj=getAllDevicesOnMap(!0);var netMapOperator=devOnMapObj.netMapOperator;var devices=devOnMapObj.devices;_.each(devices,(function(dev){var devObj={devKey:dev.key,unitData:[]};var intfObj={devKey:dev.key,unitData:[]};var dvData=dev.dataViewData;if(dvData&&dvData.templateId){var tempDevUnitData=getDeviceUnit(dvData);devObj.unitData=tempDevUnitData.unitData;var tempIntfUnitData=getInterfaceUnit(dvData,dev.key,netMapOperator);intfObj.unitData=tempIntfUnitData.unitData;devUnitData[dev.key]=devObj;intfUnitData[dev.key]=intfObj}}));result.devUnitData=devUnitData;result.intfUnitData=intfUnitData;return result},getUnitShowName:getUnitShowName,getRealVariableName:getRealVariableName,getVariableTitle:function(prefix,displayName,unitName){return trimRightColon(prefix&&displayName?prefix:displayName||unitName)},getNodeByPosName:getNodeByPosName,clearSelectedStatus:function clearSelectedStatus(treeData,id,posName){_.each(treeData,(function(node){node.children&&node.children.length>0&&clearSelectedStatus(node.children,id,posName);node.selected&&node.id!==id&&node.posName!==posName&&(node.selected=!1)}))},setSelectedStatus:function setSelectedStatus(treeData,id,posName){_.each(treeData,(function(node){if(node.children&&node.children.length>0){if(!1===setSelectedStatus(node.children,id,posName))return!1}if(node.id===id&&node.posName===posName){node.selected=!0;return!1}return!0}))},getSelectedVariableNode:function getSelectedVariableNode(treeData){var result=null;for(var i=0;i<treeData.length;i++){var node=treeData[i];if(node.selected){result=node;break}if(node.children&&node.children.length>0){var findNode=getSelectedVariableNode(node.children);if(findNode){result=findNode;break}}}return result},getPageExtendData:function(mode){var result=null;if(mode===Const.DetailPaneMode.Map){var page=mapManagerSrvc.getActivePage();try{result=page.getExtendData()}catch(e){console.warn("Failed to get Extend Data in the page.")}}return result},getDataViewTemplate:function(dvtPath){return drillDownActionHttpSrvc.getDvtByPath(dvtPath)},refreshUnitAlarm:function(devKey,devUnitData,intfUnitData){var devOnMapObj=getAllDevicesOnMap(!0);var netMapOperator=devOnMapObj.netMapOperator;var devices=devOnMapObj.devices;var index=_.findIndex(devices,{key:devKey});if(index>=0){var dev=devices[index];var dvData=dev.dataViewData;if(dvData){var tempDevUnitData=getDeviceUnit(dvData);var tempIntfUnitData=getInterfaceUnit(dvData,dev.key,netMapOperator);setNewAlarm(devUnitData,tempDevUnitData.unitData);setNewAlarm(intfUnitData,tempIntfUnitData.unitData)}}},getCurrentDataUnitAndPosName:getCurrentDataUnitAndPosName,getUnitAlarm:function(pOption){var alarm=0;var currentNodeObj=getCurrentDataUnitAndPosName(pOption);currentNodeObj&&currentNodeObj.currentDataUnit&&(alarm=currentNodeObj.currentDataUnit.alarm);return alarm},getDataViewInfo:function(devKey){var dataViewInfo=null;var devices=getAllDevicesOnMap();_.each(devices,(function(dev){if(dev.key===devKey){var dvData=dev.dataViewData;if(dvData&&dvData.dataViewInfo){dataViewInfo=dvData.dataViewInfo;return!1}}return!0}));return dataViewInfo},getAppliedDataViewInfo:getAppliedDataViewInfo,test:function(mapIdList){},getDeviceIconUrl:function(devType,devKey,obj,propName,imageName){var imgIcon="img/icon/Cisco Router.png";imageName?imgIcon=httpDeviceIconSrvc.getIconStreamURIById(imageName):devKey?httpDeviceSrvc.getSimpleDevicesByGuidsSync(null,[devKey]).then((function(result){if(result&&result.length>0){var oid=result[0].oid;imgIcon=httpDeviceIconSrvc.getIconStreamURIBy2Id(devType,oid)}else imgIcon=httpDeviceIconSrvc.getIconStreamURIBy2Id(devType);propName?obj[propName]=imgIcon:obj.deviceIcon=imgIcon})):imgIcon=httpDeviceIconSrvc.getIconStreamURIBy2Id(devType);propName?obj[propName]=imgIcon:obj.deviceIcon=imgIcon;return imgIcon},getIfObjFromCache:getIfObjFromCache,showVariableSample:function(variableName,parserPath,title,deviceId,currentUnit){detailPaneSrvc.showVariableSample(variableName,parserPath,title,deviceId,currentUnit)},getParserByPath:getParserByPath,exportDeviceTable:function(location){return httpDeviceDetailSrvc.export(location)},exportParserTable:function(data){var url=NetBrain.NG.ConfigSettings.API_ROOT+"dataviewhistory/exportCsvDataByDataLocation";var tenandId=httpAuthSrvc.getSelectedTenantId();var domainId=httpAuthSrvc.getSelectedDomainIds()[0];httpDownloadingSrvc.getTicket().then((function(ticketData){url+="?dl_ticket="+ticketData+"&TenantGuid="+tenandId+"&DomainGuid="+domainId;var newdata={};newdata.collectionName=data.dataLocation.collectionName;newdata.fileName=data.dataLocation.fileName;newdata.len=data.dataLocation.len;newdata.offset=data.dataLocation.offset;newdata.uId=data.currentUnit.uId;newdata.parserPath=data.currentUnit.parserPath;newdata.valueType=data.currentUnit.valueType;newdata.type=data.currentUnit.type;newdata.deviceId=data.devKey;httpDownloadingSrvc.downloadFileByPost(url,newdata)}),(function(){alert("failed to get downloading ticket...")}))},exportGBTableData:function(data){var url=NetBrain.NG.ConfigSettings.API_ROOT+"goldenBaseline/gbDataEngine/exportGBTableData";var tenandId=httpAuthSrvc.getSelectedTenantId();var domainId=httpAuthSrvc.getSelectedDomainIds()[0];var deviceId=data.devKey;var deviceName=data.hostName;var deviceType=data.devType;var dataUnit=data.currentUnit;var interfaceFullName=dataUnit.intfKey?dataUnit.intfKey.name:"";var parserPath=dataUnit.mappingParserPath?dataUnit.mappingParserPath:dataUnit.parserPath;var gbVariableName=dataUnit.mappingVariable?dataUnit.mappingVariable:formatGbVariableName(dataUnit.varName);var valueTime=data.valueTime;httpDownloadingSrvc.getTicket().then((function(ticketData){url+="?dl_ticket="+ticketData+"&TenantGuid="+tenandId+"&DomainGuid="+domainId;var newdata={};newdata.sourceType=0;newdata.deviceId=deviceId;newdata.deviceName=deviceName;newdata.deviceType=deviceType;newdata.interfaceValue=interfaceFullName;newdata.parserPath=parserPath;newdata.variablename=gbVariableName;newdata.valueTime=valueTime;newdata.taskId=null;newdata.param=getParserParamObj(dataUnit);dataUnit.intfKey&&dataUnit.intfKey.value&&dataUnit.intfKey.schema&&dataUnit.intfKey.name?getIfObjFromCache(dataUnit.intfKey.value,dataUnit.intfKey.schema).then((function(JsonObj){newdata.interfaceValue=JsonObj.name;httpDownloadingSrvc.downloadFileByPost(url,newdata)})):httpDownloadingSrvc.downloadFileByPost(url,newdata)}),(function(){alert("failed to get downloading ticket...")}))},prepareDataForTableSpog:function(dataUnit,devInfo){return drillDownActionRunPopupSrvc.prepareDataForTableSpog(dataUnit,devInfo)},runSpogAction:function(tableSpogInfo,columnDefs,rowObj,curColumn,spogURLOnly){return drillDownActionRunPopupSrvc.runSpogAction(tableSpogInfo,columnDefs,rowObj,curColumn,spogURLOnly)},getParserTableById:function(valueExprId,pageIndex,pageSize,filterWords){var obj={id:valueExprId,pageIndex:pageIndex,pageSize:pageSize,filterWords:filterWords};return httpDataElementDetailsSrvc.getParserTableById(obj)},exportParserTableById:function(valueExprId,filterWords){var url=NetBrain.NG.ConfigSettings.API_ROOT+"actionTask/otherwrapper/exportParserTable";var tenandId=httpAuthSrvc.getSelectedTenantId();var domainId=httpAuthSrvc.getSelectedDomainIds()[0];httpDownloadingSrvc.getTicket().then((function(ticketData){url+="?dl_ticket="+ticketData+"&TenantGuid="+tenandId+"&DomainGuid="+domainId;var newdata={};newdata.id=valueExprId;newdata.filterWords=filterWords;httpDownloadingSrvc.downloadFileByPost(url,newdata)}),(function(){alert("failed to get downloading ticket...")}))},resetGenerateTime:resetGenerateTime,getDataViewHistoryData:function(pOption,gbOrigin,duration,userFilter){var devKey=pOption.devKey;var dataUnit=pOption.dataUnit;var intfKeyValue=dataUnit.intfKey?dataUnit.intfKey.value:null;var dataViewTaskInfoId=pOption.dataViewInfo?pOption.dataViewInfo.dataViewTaskInfoId:null;var dataType=Const.DataType[pOption.variableType];var time=resetGenerateTime(pOption.dataUnit.generateTime);var timeAround=null;if(duration&&duration.value){timeAround={time:time,radius:{duration:duration.value/2,unit:4}}}var filter=null;userFilter&&(filter={pageIndex:userFilter.pageIndex,pageSize:userFilter.pageSize,filterWords:userFilter.filterWords});var devNodeData=null;pOption.mode===Const.DetailPaneMode.Map&&(devNodeData=getDevNodeData(devKey));var data={deviceId:devKey,devNodeData:devNodeData,interfaceId:intfKeyValue,currentUnit:dataUnit,dataViewTaskInfoId:dataViewTaskInfoId,timeAround:timeAround,dataType:dataType,ruleObj:gbOrigin&&-1===gbOrigin.ruleTypeId?null:gbOrigin,filter:filter};return httpDataElementDetailsSrvc.getDataViewHistoryData(data)},getDataViewHistoryDataTimeList:function(pOption,duration,userFilter,dataViewTaskInfoId){var devKey=pOption.devKey;var dataUnit=pOption.dataUnit;var intfKeyValue=dataUnit.intfKey?dataUnit.intfKey.value:null;var dataType=Const.DataType[pOption.variableType];var time=resetGenerateTime(pOption.dataUnit.generateTime);duration&&duration.time&&(time=duration.time);var timeAround=null;var unit=4;if(duration&&duration.value){duration.unit&&(unit=duration.unit);timeAround={time:time,radius:{duration:duration.value/2,unit:unit}}}var filter=null;userFilter&&userFilter.pageSize&&(filter={pageIndex:userFilter.pageIndex,pageSize:userFilter.pageSize,filterWords:userFilter.filterWords});var devNodeData=null;pOption.mode===Const.DetailPaneMode.Map&&(devNodeData=getDevNodeData(devKey));var data={deviceId:devKey,devNodeData:devNodeData,interfaceId:intfKeyValue,currentUnit:dataUnit,dataViewTaskInfoId:dataViewTaskInfoId,dataType:dataType,timeAround:timeAround,filter:filter};return httpDataElementDetailsSrvc.getDataViewHistoryDataTimeList(data)},getDataViewHistoryDataByLocation:function(dataLocation,dataUnit,gbOrigin,userFilter){var filter=null;userFilter&&(filter={pageIndex:userFilter.pageIndex,pageSize:userFilter.pageSize,filterWords:userFilter.filterWords});var data={dataLocation:dataLocation,currentUnit:dataUnit,ruleObj:gbOrigin&&-1===gbOrigin.ruleTypeId?null:gbOrigin,filter:filter};return httpDataElementDetailsSrvc.getDataViewHistoryDataByLocation(data)},compareStringWithGoldenBaseLine:function(item1,item2){return httpDataElementDetailsSrvc.compareWithGoldenBaseLine(0,item1,item2)},compareWithGoldenBaseLine:function(dataType,item1,item2){return httpDataElementDetailsSrvc.compareWithGoldenBaseLine(dataType,item1,item2)},getTableCountHistoryData:function(pOption,duration,userEvt){var dataViewTaskInfoId=getDataViewTaskInfoId(pOption.dataViewInfo,pOption.dataUnit.type,pOption.dataUnit.valueType);var param=null;userEvt&&userEvt.vrf&&(param={nct:userEvt.nct,vrf:userEvt.vrf});var time=resetGenerateTime(pOption.dataUnit.generateTime);var timeAround=null;if(duration&&duration.value){timeAround={time:time,radius:{duration:duration.value/2,unit:4}}}var filter=null;userEvt&&userEvt.pageSize&&(filter={pageIndex:userEvt.pageIndex,pageSize:userEvt.pageSize,filterWords:userEvt.filterWords});var devNodeData=null;pOption.mode===Const.DetailPaneMode.Map&&(devNodeData=getDevNodeData(pOption.devKey));var obj={dataViewTaskInfoId:dataViewTaskInfoId,deviceId:pOption.devKey,devNodeData:devNodeData,currentUnit:pOption.dataUnit,timeAround:timeAround,filter:filter,ruleObj:null,param:param};return httpDataElementDetailsSrvc.getTableCountHistoryData(obj)},viewGoldenBaselineRuleDialog:function(gbOrigin,mode,queryParams,dataUnit,dataViewInfo){var isFromMap=!!mode&&1===mode;var isDevice=!0;var onMapDevList=[];if(isFromMap){onMapDevList=getDeviceListOnMap();isDevice=!dataUnit.intfKey}else isDevice=!(!dataUnit.intfKey||""!==dataUnit.intfKey.name);var thirdParam=isFromMap?onMapDevList:queryParams;var dataViewTaskInfoId=getDataViewTaskInfoId(dataViewInfo,dataUnit.type,dataUnit.valueType);var ruleDialogParam={currentUnit:dataUnit,rule:gbOrigin,isFromMap:isFromMap,devParserParams:thirdParam,isEdit:!1,isDevSelect:isDevice,dataViewTaskID:dataViewTaskInfoId,varDataType:convertToServerDataType(dataUnit.valueType,DataUnitSourceType.uSrcParserLibrary)};return goldenBaselineSrvc.openGoldenBaselineRuleDialog(ruleDialogParam)},editGoldenBaselineRuleDialog:editGoldenBaselineRuleDialog,defineGoldenBaselineRuleDialog:defineGoldenBaselineRuleDialog,saveGoldenBaselineRule:function(obj,value,type){obj.value=value;obj.type=type;goldenBaselineSrvc.saveGoldenBaselineRule(obj)},setTableAsGoldenBaseline:function(viewModelGb,timePoint,handle){var gb=viewModelGb;var gbVariableName=formatGbVariableName(gb.dataUnit.varName);var saveTable={sourceType:-1,deviceId:gb.devInfo.devKey,deviceType:gb.devInfo.devType,interfaceValue:gb.devInfo.intfFullName,parserPath:gb.dataUnit.parserPath,variableName:gbVariableName,valueTime:timePoint?timePoint.location.time:gb.dataUnit.generateTime,taskId:getDataViewTaskInfoId(gb.dataViewInfo,gb.dataUnit.type,gb.dataUnit.valueType),param:getParserParamObj(gb.dataUnit),variableSourceType:getVariableSourceType(gb.dataUnit.type),timePoint:timePoint,valueExpr:gb.dataUnit.valueExpr,dataUnit:gb.dataUnit,ruleObj:gb.gbDefinition?gb.gbDefinition.origin:null};if(gb.gbDefinition&&gb.gbDefinition.origin){editGoldenBaselineRuleDialog(gb.gbDefinition.origin,gb.mode,gb.queryParams,gb.dataUnit,gb.dataViewInfo,saveTable)}else{var gbOrigin2=gb.gbDefinition?gb.gbDefinition.origin:null;defineGoldenBaselineRuleDialog(gb.devInfo,gbOrigin2,gb.mode,gb.queryParams,gb.dataUnit,gb.dataViewInfo,saveTable)}},getGoldenBaselineDataTime:function(param){var defer=$q.defer();var deviceId=param.devKey;var deviceType=param.devType;var dataUnit=param.dataUnit;var interfaceFullName=dataUnit.intfKey?dataUnit.intfKey.name:"";var parserPath=dataUnit.mappingParserPath?dataUnit.mappingParserPath:dataUnit.parserPath;var gbVariableName=dataUnit.mappingVariable?dataUnit.mappingVariable:formatGbVariableName(dataUnit.varName);var obj={sourceType:0,deviceId:deviceId,deviceType:deviceType,interfaceValue:interfaceFullName,parserPath:parserPath,variablename:gbVariableName,valueTime:null,taskId:null,param:getParserParamObj(dataUnit)};dataUnit.intfKey&&dataUnit.intfKey.value&&dataUnit.intfKey.schema&&dataUnit.intfKey.name?getIfObjFromCache(dataUnit.intfKey.value,dataUnit.intfKey.schema).then((function(JsonObj){obj.interfaceValue=JsonObj.name;httpDataElementDetailsSrvc.getGoldenBaselineData(obj).then((function(result){defer.resolve(result)}),(function(err){defer.reject(err)}))})):httpDataElementDetailsSrvc.getGoldenBaselineData(obj).then((function(result){defer.resolve(result)}),(function(err){defer.reject(err)}));return defer.promise},getGoldenBaselineData:function(param){var defer=$q.defer();var deviceId=param.devKey;var deviceType=param.devType;var dataUnit=param.dataUnit;var interfaceFullName=dataUnit.intfKey?dataUnit.intfKey.name:"";var parserPath=dataUnit.mappingParserPath?dataUnit.mappingParserPath:dataUnit.parserPath;var gbVariableName=dataUnit.mappingVariable?dataUnit.mappingVariable:formatGbVariableName(dataUnit.varName);var valueTime=param.valueTime;var obj={sourceType:0,deviceId:deviceId,deviceType:deviceType,interfaceValue:interfaceFullName,parserPath:parserPath,variablename:gbVariableName,valueTime:valueTime,taskId:null,param:getParserParamObj(dataUnit)};dataUnit.intfKey&&dataUnit.intfKey.value&&dataUnit.intfKey.schema&&dataUnit.intfKey.name?getIfObjFromCache(dataUnit.intfKey.value,dataUnit.intfKey.schema).then((function(JsonObj){obj.interfaceValue=JsonObj.name;httpDataElementDetailsSrvc.getGoldenBaselineData(obj).then((function(result){defer.resolve(result)}),(function(err){defer.reject(err)}))})):httpDataElementDetailsSrvc.getGoldenBaselineData(obj).then((function(result){defer.resolve(result)}),(function(err){defer.reject(err)}));return defer.promise},getGoldenBaseline:function(pOption,isNumber){var defer=$q.defer();var devKey=pOption.devKey;var devName=pOption.hostName;var dataUnit=pOption.dataUnit;var parserPath=dataUnit.parserPath;var gbVariableName=formatGbVariableName(dataUnit.varName);var devType=pOption.devType;var intfFullName=dataUnit.intfKey?dataUnit.intfKey.name:"";var isRealDev=!0;pOption.mode!==Const.DetailPaneMode.Map||pOption.forceRealDev||(isRealDev=function(devKey){var devices=getAllDevicesOnMapWithMore(!1,!1);if(_.findIndex(devices,{key:devKey})>=0)return!0;return!1}(devKey));var useVariableMapping=!0;if(pOption.mode===Const.DetailPaneMode.Map&&dataUnit.mappingParserPath&&dataUnit.mappingVariable){parserPath=dataUnit.mappingParserPath;gbVariableName=dataUnit.mappingVariable;useVariableMapping=!1}pOption.mode===Const.DetailPaneMode.GbManager&&(useVariableMapping=!1);var obj3={devName:devName,interfaceValue:intfFullName,nodeId:devKey,param:getParserParamObj(dataUnit),parserPaths:parserPath,variableName:gbVariableName,dataUnit:dataUnit,useVariableMapping:useVariableMapping,deviceType:devType};dataUnit.intfKey&&dataUnit.intfKey.value&&dataUnit.intfKey.schema&&dataUnit.intfKey.name?getIfObjFromCache(dataUnit.intfKey.value,dataUnit.intfKey.schema).then((function(JsonObj){obj3.interfaceValue=JsonObj.name;isNumber?getNumberGoldenBaselineRule(obj3,isRealDev).then((function(result){defer.resolve(result)})):getSingleGoldenBaselineRule(obj3,isRealDev).then((function(result){defer.resolve(result)}))}),(function(err){console.log(err)})):isNumber?getNumberGoldenBaselineRule(obj3,isRealDev).then((function(result){defer.resolve(result)})):getSingleGoldenBaselineRule(obj3,isRealDev).then((function(result){defer.resolve(result)}));return defer.promise},openCommonCompareModal:function(_pOption,_vrfName,_gb,_timePoint){var _pOptionCopy=angular.copy(_pOption);var devNodeData=null;_pOptionCopy.mode===Const.DetailPaneMode.Map&&(devNodeData=getDevNodeData(_pOptionCopy.devKey));_pOptionCopy.devNodeData=devNodeData;!function(pOption,vrfName,gb,timePoint){if(pOption.dataUnit.intfKey&&pOption.dataUnit.intfKey.value&&pOption.dataUnit.intfKey.schema)getIfObjFromCache(pOption.dataUnit.intfKey.value,pOption.dataUnit.intfKey.schema).then((function(JsonObj){var intfFullName=JsonObj.name;var param=buildCompareParam(pOption,vrfName,gb,intfFullName,timePoint);if(param){var option1={mode:param.mode,devices:param.devices,extraInfo:param.extraInfo};compareSrvc.openCommonCompareModal(option1)}}));else{var param=buildCompareParam(pOption,vrfName,gb,null,timePoint);if(param){var option={mode:param.mode,devices:param.devices,extraInfo:param.extraInfo};compareSrvc.openCommonCompareModal(option)}}}(_pOptionCopy,_vrfName,_gb,_timePoint)}};function getDeviceListOnMap(){var devList=[];var devOnMapObj=getAllDevicesOnMapWithMore(!0,!1);var netMapOperator=devOnMapObj.netMapOperator;var devices=devOnMapObj.devices;_.each(devices,(function(item){var devItem={deviceId:item.key,deviceType:item.devType,deviceName:item.hostName,intfNames:[],intfKeys:[]};var dvData=item.dataViewData;var intfObjList=getIntfObjList(item.key,netMapOperator);_.each(intfObjList,(function(intfObj){var dataViewInfo=intfObj.dataViewInfo;if(dvData.dataViewInfo&&dvData.dataViewInfo.dataViewGroupId===dataViewInfo.dataViewGroupId){var intf=intfObj.intfInfo.intf;var intfName=intf&&intf.intfDisplaySchemaObj&&intf.intfDisplaySchemaObj.value;intfName&&devItem.intfNames.push(intfName);var intfSchema=intf&&intf.intfKeyObj&&intf.intfKeyObj.schema;intfSchema&&devItem.intfKeys.push({schema:intfSchema,value:intf.intfKeyObj.value})}}));devList.push(devItem)}));return devList}function convertToServerDataType(valueType,type){var GBVariableType=goldenBaselineConsts.GBVariableType;return type===DataUnitSourceType.uSrcParserLibrary?_.indexOf(stringTypes[0],valueType)>=0?GBVariableType.string:_.indexOf(tableTypes[0],valueType)>=0?GBVariableType.table:valueType===DataUnitType.uInt?GBVariableType.int:valueType===DataUnitType.uFloat?GBVariableType.float:valueType===DataUnitType.uBool?GBVariableType.bool:valueType===DataUnitType.uString?GBVariableType.string:valueType===DataUnitType.uConfigLet?GBVariableType.string:valueType===DataUnitType.uTable?GBVariableType.table:GBVariableType.string:type===DataUnitSourceType.uSrcDeviceData?GBVariableType.string:(DataUnitSourceType.uSrcGDR,GBVariableType.string)}function getDataViewTaskInfoId(dataViewInfo,type,valueType,isForceGet){var dataViewTaskInfoId=null;(type===DataUnitSourceType.uSrcParserLibrary&&isIncludeType(tableTypes,type,valueType)||isForceGet)&&(dataViewTaskInfoId=dataViewInfo&&dataViewInfo.dataViewTaskInfoId?dataViewInfo.dataViewTaskInfoId:null);return dataViewTaskInfoId}function getVariableSourceType(type){var varSrcType=0;type===DataUnitSourceType.uSrcDeviceData?varSrcType=1:type===DataUnitSourceType.uSrcParserLibrary&&(varSrcType=2);return varSrcType}function editGoldenBaselineRuleDialog(gbOrigin,mode,queryParams,dataUnit,dataViewInfo,saveTable){var isFromMap=!!mode&&1===mode;var isDevice=!0;var onMapDevList=[];if(isFromMap){onMapDevList=getDeviceListOnMap();isDevice=!dataUnit.intfKey}else isDevice=!(!dataUnit.intfKey||""!==dataUnit.intfKey.name);var ruleDialogParam={currentUnit:dataUnit,rule:gbOrigin,isFromMap:isFromMap,devParserParams:isFromMap?onMapDevList:queryParams,isEdit:!0,isDevSelect:isDevice,dataViewTaskID:getDataViewTaskInfoId(dataViewInfo,dataUnit.type,dataUnit.valueType),saveTableData:saveTable,varDataType:convertToServerDataType(dataUnit.valueType,DataUnitSourceType.uSrcParserLibrary)};return goldenBaselineSrvc.openGoldenBaselineRuleDialog(ruleDialogParam)}function defineGoldenBaselineRuleDialog(devInfo,gbOrigin,mode,queryParams,dataUnit,dataViewInfo,saveTable){var isFromMap=!!mode&&1===mode;var isDevice=!0;var devList=[];if(isFromMap){devList=getDeviceListOnMap();isDevice=!dataUnit.intfKey}else{var device={deviceId:devInfo.devKey,deviceType:devInfo.devType,deviceName:devInfo.hostName,intfNames:[],intfKeys:[]};devList.push(device);if(!(isDevice=!(!dataUnit.intfKey||""!==dataUnit.intfKey.name))){device.intfNames.push(dataUnit.intfKey.name);device.intfKeys.push({schema:dataUnit.intfKey.schema,value:dataUnit.intfKey.value})}}var ruleDialogParam={currentUnit:dataUnit,rule:gbOrigin,isFromMap:isFromMap,devParserParams:isFromMap?devList:queryParams,isEdit:!0,isDevSelect:isDevice,dataViewTaskID:getDataViewTaskInfoId(dataViewInfo,dataUnit.type,dataUnit.valueType),saveTableData:saveTable,varDataType:convertToServerDataType(dataUnit.valueType,DataUnitSourceType.uSrcParserLibrary)};return goldenBaselineSrvc.openGoldenBaselineRuleDialog(ruleDialogParam)}function formatGbVariableName(varName){return httpDataElementDetailsSrvc.formatGbVariableName(varName)}function getSingleGoldenBaselineRule(obj,isRealDev){var defer=$q.defer();var result=Const.getGoldenBaselineDefinition();if(isRealDev)getParserByPath(obj.parserPaths).then((function(parserData){if(parserData&&0===parserData.supportNodeType){goldenBaselineSrvc.getSingleGoldenBaseline(obj).then((function(gbOrigin){if(gbOrigin&&gbOrigin.ErrorMsg){result.error=!0;result.errorMsg=gbOrigin.ErrorMsg;console.warn(gbOrigin.ErrorMsg,obj.variableName)}else if(gbOrigin){result.origin=gbOrigin;result.rule.displayName=gbOrigin.displayName}defer.resolve(result)}),(function(err){result.error=!0;console.warn(err);defer.resolve(result)}));result.dest.parserData=parserData}else{result.error=!0;defer.resolve(result)}}),(function(){result.error=!0;defer.resolve(result)}));else{result.error=!0;defer.resolve(result)}return defer.promise}function pushArray(lines,arr,color){_.each(arr,(function(val){var item={value:getNumVal(val),color:color};lines.push(item)}))}function getNumVal(val){var retV=0;val.ruleParam?retV=val.ruleParam:isNaN(val)?console.warn("Failed to convert number.",val):retV=val;return retV}function getNumberGoldenBaselineRule(obj,isRealDev){var defer=$q.defer();var result=Const.getGoldenBaselineDefinition();if(isRealDev)getParserByPath(obj.parserPaths).then((function(parserData){if(parserData&&0===parserData.supportNodeType){goldenBaselineSrvc.getSingleGoldenBaseline(obj).then((function(gbOrigin){if(gbOrigin&&gbOrigin.ErrorMsg){result.error=!0;result.errorMsg=gbOrigin.ErrorMsg;console.warn(gbOrigin.ErrorMsg,obj.variableName)}else if(gbOrigin){result.origin=gbOrigin;result.rule.displayName=gbOrigin.displayName;var chartRule=function(gbRule){var chartRule={lines:[],bands:null};if(gbRule&&gbRule.ruleAlgParameter){var rap=gbRule.ruleAlgParameter;if(gbRule.ruleTypeId===goldenBaselineConsts.GBRuleType.intEqual)_.isArray(rap.ruleParam)?pushArray(chartRule.lines,rap.ruleParam,"#facb92"):chartRule.lines.push({value:getNumVal(rap.ruleParam),color:"#facb92"});else if(gbRule.ruleTypeId===goldenBaselineConsts.GBRuleType.intNoEqual)_.isArray(rap.ruleParam)?pushArray(chartRule.lines,rap.ruleParam,"red"):chartRule.lines.push({value:getNumVal(rap.ruleParam),color:"red"});else if(gbRule.ruleTypeId===goldenBaselineConsts.GBRuleType.intGEQ||gbRule.ruleTypeId===goldenBaselineConsts.GBRuleType.intLEQ||gbRule.ruleTypeId===goldenBaselineConsts.GBRuleType.intEnum)_.isArray(rap.ruleParam)?pushArray(chartRule.lines,rap.ruleParam,"#facb92"):chartRule.lines.push({value:getNumVal(rap.ruleParam),color:"#facb92"});else if(gbRule.ruleTypeId===goldenBaselineConsts.GBRuleType.intRange){chartRule.lines.push({value:getNumVal(rap.minValue),color:"#facb92"});chartRule.lines.push({value:getNumVal(rap.maxValue),color:"#facb92"});chartRule.bands={};chartRule.bands.from=getNumVal(rap.minValue);chartRule.bands.to=getNumVal(rap.maxValue);chartRule.bands.color="#fef8f1"}}return chartRule}(gbOrigin);result.rule.lines=chartRule.lines;result.rule.bands=chartRule.bands}defer.resolve(result)}),(function(err){result.error=!0;console.warn(err);defer.resolve(result)}));result.dest.parserData=parserData}else{result.error=!0;defer.resolve(result)}}),(function(){result.error=!0;defer.resolve(result)}));else{result.error=!0;defer.resolve(result)}return defer.promise}function getDataViewShowName(dataViewInfo,mode){if(dataViewInfo&&mode===Const.DetailPaneMode.Map){return getAppliedDataViewInfo().dvName}return""}function buildCompareParam(pOption,vrfName,gb,intfFullName,timePoint){var dataUnit=pOption.dataUnit;var mode=null;var devInfo={devKey:pOption.devKey,hostName:pOption.hostName,devType:pOption.devType};var devices=[{deviceId:devInfo.devKey,deviceType:devInfo.devType,deviceName:devInfo.hostName}];var dataViewTaskInfoId=getDataViewTaskInfoId(pOption.dataViewInfo,pOption.dataUnit.type,pOption.dataUnit.valueType,!0);var extraInfo=null;if(dataUnit.type===DataUnitSourceType.uSrcParserLibrary){mode=NetBrain.Comparison.CommonCompareMode.GoldenBaseline;extraInfo=function(pOption,gb,intfFullName,dataViewTaskInfoId,timePoint){var parserType="";var parserPath;var variableName="";var interfaceName="";var interfaceKey=null;var dataUnit=pOption.dataUnit;var varType=pOption.variableType;varType===Const.VariableType.string?parserType=NetBrain.Comparison.CompareParserType.String:varType===Const.VariableType.table&&(parserType=NetBrain.Comparison.CompareParserType.Table);parserPath=pOption.dataUnit.parserPath;variableName=formatGbVariableName(variableName=getRealVariableName(pOption.dataUnit.uId,null,pOption.dataUnit.valueType));if(pOption.dataUnit.intfKey&&pOption.dataUnit.intfKey.value){interfaceName=intfFullName;interfaceKey=pOption.dataUnit.intfKey.value}return parserType||parserType===NetBrain.Comparison.CompareParserType.Table&&parserPath&&variableName?{goldenBaselineDisplayName:gb.status===Const.GoldenBaselineStatus.NotDefined&&"Undefined"===gb.displayName?"Define Golden Baseline":gb.displayName,parserConfig:{parserType:parserType,parserPath:parserPath,variableName:variableName,interfaceName:interfaceName,interfaceKey:interfaceKey,dataViewTaskId:dataViewTaskInfoId,dataViewName:getDataViewShowName(pOption.dataViewInfo,pOption.mode),dataUnit:dataUnit,generateTime:timePoint?timePoint.executeTime||timePoint.time||timePoint.valueTime:dataUnit.generateTime},gbObjectRule:gb}:null}(pOption,gb,intfFullName,dataViewTaskInfoId,timePoint)}else if(dataUnit.type===DataUnitSourceType.uSrcDeviceData&&dataUnit.valueType===DataUnitType.uConfigFile){mode=NetBrain.Comparison.CommonCompareMode.GoldenBaseline;extraInfo=function(pOption,timePoint,dataViewTaskInfoId){var parserType=NetBrain.Comparison.CompareParserType.String;var dataUnit=pOption.dataUnit;return{parserConfig:{parserType:parserType,dataViewName:getDataViewShowName(pOption.dataViewInfo,pOption.mode),dataUnit:_.extend({},dataUnit,{generateTime:timePoint.executeTime}),dataViewTaskId:dataViewTaskInfoId}}}(pOption,timePoint,dataViewTaskInfoId)}else if(dataUnit.type===DataUnitSourceType.uSrcDeviceData){mode=NetBrain.Comparison.CommonCompareMode.GoldenBaseline;extraInfo=function(pOption,vrfName,timePoint,dataViewTaskInfoId){var parserType="";var dataUnit=pOption.dataUnit;var varType=pOption.variableType;varType===Const.VariableType.string?parserType=NetBrain.Comparison.CompareParserType.String:varType===Const.VariableType.table&&(parserType=NetBrain.Comparison.CompareParserType.Table);return{parserConfig:{parserType:parserType,dataViewName:getDataViewShowName(pOption.dataViewInfo,pOption.mode),dataUnit:dataUnit,vrfName:vrfName,dataViewTaskId:dataViewTaskInfoId,generateTime:timePoint?timePoint.executeTime:dataUnit.generateTime}}}(pOption,vrfName,timePoint,dataViewTaskInfoId)}return extraInfo?{mode:mode,devices:devices,extraInfo:extraInfo}:null}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").factory("nb.dataview.detailDrillDownLabelSrvc",detailDrillDownLabelSrvc);detailDrillDownLabelSrvc.$inject=["$rootScope","nb.ng.nbHttp","$q","$log","$uibModal","$location","nb.networkos.myFilesSrvc","nb.datamodel.httpSiteSrvc","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.uiframework.urlStateMgr","nb.ng.httpAuthSrvc","$timeout","nb.ng.utilitySrvc","nb.ng.sessionSrvc","nb.uiframework.mainUISrvc","nb.networkos.fileSrvc","nb.dataview.httpDataElementDetailsSrvc","nb.runbook.httpRunBookSrvc","nb.topo.httpTopoSrvc","nb.common.nbTipSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.qmap.httpMapLayoutSrvc","nb.qmap.mapManagerSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.dataview.dataElementDetailsSrvc","nb.deviceDetail.httpDeviceDetailSrvc","nb.dataview.httpDataViewSrvc","nb.common.cacheDesignReaderSrvc"];function detailDrillDownLabelSrvc($rootScope,nbHttp,$q,$log,$uibModal,$location,myFilesSrvc,httpSiteSrvc,userSrvc,nbAlertSrvc,httpMapSrvc,urlStateMgr,httpAuthSrvc,$timeout,utilitySrvc,sessionSrvc,mainUISrvc,fileSrvc,httpDataElementDetailsSrvc,runbookMgr,httpTopoSrvc,nbTipSrvc,httpDeviceGroupSrvc,httpMapLayoutSrvc,mapManagerSrvc,deviceTypeMgrSrvc,dataElementDetailsSrvc,httpDeviceDetailSrvc,httpDataViewSrvc,cacheDesignReaderSrvc){var Const=dataElementDetailsSrvc.dataElementConst;function getGbStatus(gbDefinition){var result={needMoreInfo:!1,gbStatus:Const.GoldenBaselineStatus.NotApplicable};gbDefinition&&(gbDefinition.error?result.gbStatus=Const.GoldenBaselineStatus.NotApplicable:gbDefinition.origin&&-1===gbDefinition.origin.ruleTypeId?result.gbStatus=Const.GoldenBaselineStatus.NotDefined:gbDefinition.origin&&gbDefinition.origin.displayName&&(result.needMoreInfo=!0));return result}function getGbStatusByData(data,dataUnit,gbOrigin,gbError){var gbStatus=Const.GoldenBaselineStatus.NotApplicable;gbError?gbStatus=Const.GoldenBaselineStatus.NotApplicable:data&&data.gbStatus?gbStatus=data.gbStatus:gbOrigin&&-1===gbOrigin.ruleTypeId?gbStatus=Const.GoldenBaselineStatus.NotDefined:dataUnit&&(gbStatus=dataUnit.alarm===Const.DataUnitAlarmValue?Const.GoldenBaselineStatus.AlertDetected:Const.GoldenBaselineStatus.NoAlerts);return gbStatus}function convertStringPaneData(gb,rawData,generateTime,gbTimeValue){var result={gbStatus:Const.GoldenBaselineStatus.NotDefined,columnList:null,valueList:[],allRecordCount:0};var tempGbStatus=getGbStatus(gb);if(tempGbStatus.needMoreInfo){var one=_.findIndex(rawData.valueList,{alert:1});var two=_.findIndex(rawData.valueList,{alert:2});result.gbStatus=one>=0||two>=0?Const.GoldenBaselineStatus.AlertDetected:Const.GoldenBaselineStatus.NoAlerts}else result.gbStatus=tempGbStatus.gbStatus;var valueList=[];_.each(rawData.valueList,(function(rawValue){var value=angular.copy(rawValue);var timePoint=new Date(value.timePoint);value.timeText=moment.utc(timePoint).local().format("MM/DD/YYYY hh:mm:ss A");if(generateTime){new Date(generateTime).getTime()===timePoint.getTime()&&(value.currentMapTime=!0)}gbTimeValue&&gbTimeValue===timePoint.getTime()&&(value.isGbTime=!0);valueList.push(value)}));result.valueList=valueList;result.allRecordCount=rawData.allRecordCount;return result}function convertParserTableStrToDataObj(dataStr){var tblName="";var tblType="";var valueList=[];var columnList=[];if(dataStr)if(_.isObject(dataStr)&&dataStr.columns){var tbl1=function(dataStr){var tblName="";var tblType="";var valueList=[];var columnList=[];var data=dataStr;if(data&&data.columns&&data.columns.length>0){tblName=data.name;tblType=data.type;_.each(data.columns,(function(col,index){var colObj={name:col.name,fieldName:"f_"+index,type:col.type,isSelected:col.isSelected};columnList.push(colObj)}));var rowNum=data.rows?data.rows.length:0;for(var i=0;i<rowNum;i++){var row={};for(var j=0;j<data.columns.length;j++)row["f_"+j]=data.rows[i][j]?data.rows[i][j].toString():"";valueList.push(row)}}return{tableName:tblName,tableType:tblType,valueList:valueList,columnList:columnList}}(dataStr);tblName=tbl1.tableName;tblType=tbl1.tableType;valueList=tbl1.valueList;columnList=tbl1.columnList}else{var tbl2=function(dataStr){var tblName="";var tblType="";var valueList=[];var columnList=[];var data=null;try{data=JSON.parse(dataStr)}catch(e){console.log("Failed to convert string to json object.",dataStr)}if(data&&data.column&&data.column.length>0){tblName=data.name;tblType=data.type;_.each(data.column,(function(col,index){var colObj={name:col.name,fieldName:"f_"+index,type:col.type};columnList.push(colObj)}));var rowNum=data.column[0].value.length;for(var i=0;i<rowNum;i++){var row={};for(var j=0;j<data.column.length;j++){var col1=data.column[j];row["f_"+j]=col1.value[i].toString()}valueList.push(row)}}return{tableName:tblName,tableType:tblType,valueList:valueList,columnList:columnList}}(dataStr);tblName=tbl2.tableName;tblType=tbl2.tableType;valueList=tbl2.valueList;columnList=tbl2.columnList}else console.log("There is no data.");return{tableName:tblName,tableType:tblType,valueList:valueList,columnList:columnList}}function convertTablePaneData(gb,rawData,mapUnitAlarm){var result={gbStatus:Const.GoldenBaselineStatus.NotDefined,tableName:"",tableType:"",valueList:[],columnList:[],allRecordCount:0};var tempGbStatus=getGbStatus(gb);tempGbStatus.needMoreInfo?rawData.alert>0||mapUnitAlarm>0?result.gbStatus=Const.GoldenBaselineStatus.AlertDetected:result.gbStatus=Const.GoldenBaselineStatus.NoAlerts:result.gbStatus=tempGbStatus.gbStatus;var pureTableData=convertParserTableStrToDataObj(rawData.table);result.tableName=pureTableData.tableName;result.tableType=pureTableData.tableType;result.valueList=pureTableData.valueList;result.columnList=pureTableData.columnList;result.allRecordCount=rawData.rowCount||rawData.table&&rawData.table.allRowsCount||0;return result}function convertNumberPaneData(gb,numRawData){var result={gbStatus:Const.GoldenBaselineStatus.NotDefined,valueList:[],allRecordCount:0};var tempGbStatus=getGbStatus(gb);if(tempGbStatus.needMoreInfo){var one=_.findIndex(numRawData.valueList,{alert:1});var two=_.findIndex(numRawData.valueList,{alert:2});result.gbStatus=one>=0||two>=0?Const.GoldenBaselineStatus.AlertDetected:Const.GoldenBaselineStatus.NoAlerts}else result.gbStatus=tempGbStatus.gbStatus;result.valueList=numRawData.valueList;result.allRecordCount=numRawData.allRecordCount;return result}function fetchEmptyFunction(){var d=$q.defer();d.resolve(null);return d.promise}function fetchParserTableByFirstTime(pOption,gbOrigin,withGb){var defer=$q.defer();var dataUnit=pOption.dataUnit;var firstTimeObj={isFirstTime:!0,isGbData:!1,rawData:null,firstDataTimeValue:0};var timeUserFilter=Const.getTimeListUserFilter(withGb?Const.TimeListType.timePointerWithGb:Const.TimeListType.timePointer);loadSubPaneTimeList(pOption,null,timeUserFilter).then((function(timeObj){var gbTime=timeObj.gbTime;var timeList=timeObj.timeList;var isGbData=!1;var dataTimeValue=0;var qList=[];if(timeList&&timeList.length>0){var dataLocation=timeList[0].origin.dataLocation;dataTimeValue=timeList[0].timeValue;var dataUserFilter=Const.getDataUserFilter();qList.push(dataElementDetailsSrvc.getDataViewHistoryDataByLocation(dataLocation,dataUnit,gbOrigin,dataUserFilter))}else if(gbTime&&gbTime.origin&&gbOrigin&&-1!==gbOrigin.ruleTypeId){isGbData=!0;qList.push(function(pOption){var defer=$q.defer();var simpleParam={devKey:pOption.devKey,devType:pOption.devType,dataViewInfo:pOption.dataViewInfo,dataUnit:pOption.dataUnit};dataElementDetailsSrvc.getGoldenBaselineDataTime(simpleParam).then((function(rawGbTime){if(rawGbTime){var gbTime=rawGbTime.valueTime;simpleParam.valueTime=gbTime;dataElementDetailsSrvc.getGoldenBaselineData(simpleParam).then((function(rawGbData){rawGbData.gbDataTimeValue=new Date(gbTime).getTime();defer.resolve(rawGbData)}),(function(){defer.resolve(null)}))}else defer.resolve(null)}),(function(){defer.resolve(null)}));return defer.promise}(pOption))}firstTimeObj.isGbData=isGbData;qList.length>0?$q.all(qList).then((function(result){var rawData=result[0];firstTimeObj.rawData=rawData;firstTimeObj.firstDataTimeValue=isGbData?rawData.gbDataTimeValue:dataTimeValue;defer.resolve(firstTimeObj)}),(function(err){console.warn(err);defer.resolve(firstTimeObj)})):defer.resolve(firstTimeObj)}));return defer.promise}function fetchParserLibraryTimeFromGB(pOption){var defer=$q.defer();var gbTimeObj={gbTimeValue:0,gbTime:""};var simpleParam={devKey:pOption.devKey,devType:pOption.devType,dataViewInfo:pOption.dataViewInfo,dataUnit:pOption.dataUnit};dataElementDetailsSrvc.getGoldenBaselineDataTime(simpleParam).then((function(rawGbTime){if(rawGbTime){var gbTime=rawGbTime.valueTime;var gbTimeValue=new Date(gbTime).getTime();gbTimeObj.gbTime=gbTime;gbTimeObj.gbTimeValue=gbTimeValue;defer.resolve(gbTimeObj)}else defer.resolve(null)}),(function(){defer.resolve(null)}));return defer.promise}function fetchParserLibraryData(pOption,duration){var defer=$q.defer();var dataUnit=pOption.dataUnit;var generateTime=dataUnit.generateTime;var varType=pOption.variableType;var obj={gb:null,data:null,frequence:30,isrunning:!1,isGbData:!1,dataTimeValue:0};var needLoadByMap=!1;(function(varType,pOption){var defer=$q.defer();var qList=[];varType===Const.VariableType.number?qList.push(dataElementDetailsSrvc.getGoldenBaseline(pOption,!0)):varType===Const.VariableType.string?qList.push(dataElementDetailsSrvc.getGoldenBaseline(pOption,!1)):varType===Const.VariableType.table?qList.push(dataElementDetailsSrvc.getGoldenBaseline(pOption,!1)):qList.push(fetchEmptyFunction());$q.all(qList).then((function(result){var gb=result[0];gb||(gb=Const.getGoldenBaselineDefinition());defer.resolve(gb)}));return defer.promise})(varType,pOption).then((function(gbResult){var gbOrigin=gbResult?gbResult.origin:null;var gb=gbResult;var dataUserFilter=Const.getDataUserFilter();var qList=[];if(varType===Const.VariableType.string){qList.push(dataElementDetailsSrvc.getDataViewHistoryData(pOption,gbOrigin,null,dataUserFilter));qList.push(fetchParserLibraryTimeFromGB(pOption))}else if(varType===Const.VariableType.number)qList.push(dataElementDetailsSrvc.getDataViewHistoryData(pOption,gbOrigin,duration,dataUserFilter));else if(varType===Const.VariableType.table)if(dataUnit.generateTime&&dataUnit.valueExpr&&dataUnit.valueExpr.guid){needLoadByMap=!0;qList.push(dataElementDetailsSrvc.getParserTableById(dataUnit.valueExpr.guid,0,Const.DefaultPageSize))}else if(pOption.mode===Const.DetailPaneMode.GbManager){qList.push(fetchParserTableByFirstTime(pOption,gbOrigin,!0))}else if(dataUnit.valueExpr&&dataUnit.valueExpr.isRunCommand)qList.push(fetchParserTableByFirstTime(pOption,gbOrigin));else{qList.push(fetchParserTableByFirstTime(pOption,gbOrigin,!0))}var isGbData=!1;var firstDataTimeValue=0;if(qList.length>0)$q.all(qList).then((function(result){if(result&&result.length>0&&result[0]){var rawResult=result[0];var rawGbTime=result[1];var gbTimeValue=rawGbTime?rawGbTime.gbTimeValue:null;var rawData=rawResult;if(rawResult.isFirstTime){isGbData=rawResult.isGbData;firstDataTimeValue=rawResult.firstDataTimeValue;rawData=rawResult.rawData;isGbData&&(rawData={table:rawData.value})}var mapUnitAlarm=null;needLoadByMap&&(mapUnitAlarm=dataElementDetailsSrvc.getUnitAlarm(pOption));if(rawData){obj.frequence=rawData.frequence;obj.isrunning=rawData.isrunning;if(varType===Const.VariableType.string){var strData=convertStringPaneData(gb,rawData,generateTime,gbTimeValue);obj.data=strData;obj.gbTimeValue=rawGbTime?rawGbTime.gbTimeValue:null}else if(varType===Const.VariableType.table){var tableData=convertTablePaneData(gb,rawData,mapUnitAlarm);obj.data=tableData}else if(varType===Const.VariableType.number){var numData=convertNumberPaneData(gb,rawData);obj.data=numData}}obj.gb=gb;obj.gb.rule.status=getGbStatusByData(obj.data,dataUnit,gb.origin,gb.error);obj.isGbData=isGbData;obj.dataTimeValue=firstDataTimeValue;defer.resolve(obj)}else{obj.gb=gb;defer.resolve(obj)}}),(function(err){console.warn("Failed to fetch parser data",dataUnit,err);obj.gb=gb;obj.gb.rule.status=getGbStatusByData(null,dataUnit,gb.origin,gb.error);defer.resolve(obj)}));else{obj.gb=gb;obj.gb.rule.status=getGbStatusByData(null,dataUnit,gb.origin,gb.error);defer.resolve(obj)}}));return defer.promise}function getDeviceDataTableParam(timeOrigin,typeObj,userEvt,uId,hasLocation){var innerGetLocation=function(vrfName1,item){var loc=null;if(vrfName1){var index=item.vrf.indexOf(vrfName1);index>=0&&(loc=item.locations[index])}return loc};var innerGetNctLocation=function(nctName,vrfName1,ncts){var loc=null;if(nctName&&vrfName1){var findNct=_.findWhere(ncts,{nctName:nctName});if(findNct){loc=findNct.locations[0];var findLocation=innerGetLocation(vrfName1,findNct);findLocation&&(loc=findLocation)}}return loc};var origin=timeOrigin;var location=hasLocation;if(!location&&typeObj){if("vrf"===typeObj.type&&origin&&origin.locations&&origin.locations.length>0){location=origin.locations[0];var vrfName=typeObj.vrfName;userEvt&&userEvt.vrfName&&(vrfName=userEvt.vrfName);var findLocation1=innerGetLocation(vrfName,origin);findLocation1&&(location=findLocation1)}if("nct"===typeObj.type&&origin&&origin.ncts&&origin.ncts.length>0&&origin.ncts[0].locations&&origin.ncts[0].locations.length>0){location=origin.ncts[0].locations[0];var findLocation2=innerGetNctLocation(typeObj.nctName,typeObj.vrfName,origin.ncts);findLocation2&&(location=findLocation2);if(userEvt&&userEvt.nctName){var findLocation3=innerGetNctLocation(userEvt.nctName,userEvt.vrfName,origin.ncts);findLocation3&&(location=findLocation3)}}}var param=null;location&&(param={filter:{filterWords:userEvt&&userEvt.filterWords?userEvt.filterWords:"",pageIndex:userEvt&&userEvt.pageIndex?userEvt.pageIndex:0,pageSize:Const.DefaultPageSize,sortColumn:userEvt&&userEvt.sortColumn?userEvt.sortColumn:[],sortDesc:userEvt&&userEvt.sortDesc?userEvt.sortDesc:[]},id:location,tableType:uId?dataElementDetailsSrvc.getDeviceDataType(uId):""});return param}function convertDeviceDataTable(gb,dataUnit,params){var defer=$q.defer();var result={gbStatus:Const.GoldenBaselineStatus.NotDefined,tableName:"",tableType:"",valueList:[],columnList:[],isDataTable:!0};var tempGbStatus=getGbStatus(gb);tempGbStatus.needMoreInfo?result.gbStatus=Const.GoldenBaselineStatus.NotApplicable:result.gbStatus=tempGbStatus.gbStatus;httpDeviceDetailSrvc.getDataTableData(params).then((function(qResult){var data=function(dataResult){var valueList=[];var columnList=[];var endIndex=-1;var isAllLoaded=!0;if(dataResult&&dataResult.columns){_.each(dataResult.columns,(function(col,index){var colObj={name:col,fieldName:"f_"+index,type:""};columnList.push(colObj)}));if(dataResult.rows&&dataResult.rows.length>0)for(var i=0;i<dataResult.rows.length;i++){var row={};for(var j=0;j<dataResult.columns.length;j++)row["f_"+j]=dataResult.rows[i][j]?dataResult.rows[i][j].toString():"";valueList.push(row)}endIndex=dataResult.endIndex;isAllLoaded=dataResult.isAllLoaded}return{valueList:valueList,columnList:columnList,endIndex:endIndex,isAllLoaded:isAllLoaded}}(qResult);result.tableName=dataUnit.value;result.tableType=dataUnit.uId;result.valueList=data.valueList;result.columnList=data.columnList;result.endIndex=data.endIndex;result.isAllLoaded=data.isAllLoaded;result.allRecordCount=NgUtil.getValueFromObjAndPath(params,"id.props.rowCount");defer.resolve(result)}),(function(){defer.resolve(result)}));return defer.promise}function convertDeviceDataConfigFile(gb,dataUnit,devInfo,location){var defer=$q.defer();var result={gbStatus:Const.GoldenBaselineStatus.NotDefined,content:"",isAllLoaded:!1,configTree:{},isConfigFile:!0};var tempGbStatus=getGbStatus(gb);tempGbStatus.needMoreInfo?result.gbStatus=Const.GoldenBaselineStatus.NotApplicable:result.gbStatus=tempGbStatus.gbStatus;var qList=[];location?qList.push(httpDeviceDetailSrvc.getConfigFileData(location)):qList.push(function(){var d=$q.defer();d.resolve(null);return d.promise}());qList.push(cacheDesignReaderSrvc.getData(devInfo.devType));$q.all(qList).then((function(ajaxResult){var data=ajaxResult[0];var argTreeRaw=ajaxResult[1];if(data&&argTreeRaw){var tmpDeviceDetailMgr=new CDeviceDetailMgr;result.configTree=tmpDeviceDetailMgr.parseDesignReaderTree(argTreeRaw);result.content=data?data.content:null;result.isAllLoaded=data?data.isAllLoaded:null}defer.resolve(result)}),(function(){defer.resolve(result)}));return defer.promise}function convertDeviceMetaDataToTimeItem(deviceMetadata){var timeItem=null;if(deviceMetadata&&deviceMetadata.length>0){timeItem={origin:null,timeText:"",timeValue:0,nctList:null,vrfList:null};var nctList=[];var vrfList=[];var origin={executeTime:deviceMetadata[0].time,locations:[],vrf:[]};_.each(deviceMetadata,(function(dataItem,index){var dlTime=new Date(dataItem.time);timeItem.timeText=moment.utc(dlTime).local().format("MM/DD/YYYY hh:mm:ss A");timeItem.timeValue=dlTime.getTime();if(dataItem.param){if(dataItem.param.vrf){origin.vrf.push(dataItem.param.vrf);vrfList.push({label:dataItem.param.vrf,vrfName:dataItem.param.vrf,index:index})}}else if(0===index){origin.vrf.push("'Global'");vrfList.push({label:"'Global'",vrfName:"'Global'",index:index})}var locationItem={id:dataItem.id,location:dataItem.dataLocation,md5:dataItem.md5,props:dataItem.props,sourceType:dataItem.sourceType};origin.locations.push(locationItem)}));timeItem.origin=origin;timeItem.vrfList=vrfList.length>0?vrfList:null;timeItem.nctList=nctList.length>0?nctList:null}return timeItem}function innerGetDeviceDataTableParams(typeObj,userEvt,location){var uId=typeObj.uId;return userEvt?getDeviceDataTableParam(userEvt.timeOrigin,typeObj,userEvt,uId,null):getDeviceDataTableParam(null,null,null,uId,location)}function fetchDeviceData(pOption,duration,userEvt){var defer=$q.defer();var gb=Const.getGoldenBaselineDefinition(!0);var obj={gb:gb,data:null,frequence:30,isrunning:!1,isGbData:!1,dataTimeValue:0};var dataUnit=pOption.dataUnit;var useFirstTime=!1;var qList=[];if(dataUnit&&dataUnit.deviceMetadata)qList.push(fetchEmptyFunction());else{useFirstTime=!0;var timeUserFilter=Const.getTimeListUserFilter(Const.TimeListType.all);qList.push(loadSubPaneTimeList(pOption,null,timeUserFilter))}$q.all(qList).then((function(result){var simpleParam={devKey:pOption.devKey,devType:pOption.devType,dataViewInfo:pOption.dataViewInfo,dataUnit:dataUnit};var firstDataTimeValue=null;var location=null;if(useFirstTime){var firstTimeItem=function(configTimeObj){var location=null;var timeValue=null;if(configTimeObj.dataViewTimeList&&configTimeObj.dataViewTimeList.length>0){var item1=configTimeObj.dataViewTimeList[0];if(item1&&item1.origin){location=item1.origin.locations&&item1.origin.locations.length>0?item1.origin.locations[0]:item1.origin.location;timeValue=item1.timeValue}}else if(configTimeObj.dataEngineTimeList&&configTimeObj.dataEngineTimeList.length>0){var item2=configTimeObj.dataEngineTimeList[0];if(item2&&item2.origin){location=item2.origin.locations&&item2.origin.locations.length>0?item2.origin.locations[0]:item2.origin.location;timeValue=item2.timeValue}}return{location:location,timeValue:timeValue}}(result[0]);location=firstTimeItem.location;firstDataTimeValue=firstTimeItem.timeValue}else location=function(dataUnit,userEvt){var location=null;if(userEvt)userEvt.timeOrigin&&userEvt.timeOrigin.location?location=userEvt.timeOrigin.location:userEvt.timeOrigin&&userEvt.timeOrigin.locations&&(location=userEvt.timeOrigin.locations[0]);else if(dataUnit&&dataUnit.deviceMetadata){var timeItem=convertDeviceMetaDataToTimeItem(dataUnit.deviceMetadata);timeItem&&timeItem.origin&&timeItem.origin.locations&&(location=timeItem.origin.locations[0])}return location}(dataUnit,userEvt);var allowGo=!0;useFirstTime&&null===location&&(allowGo=!1);if(dataUnit.valueType===DataUnitType.uConfigFile&&dataUnit.uId===DeviceDataType.Config&&allowGo)convertDeviceDataConfigFile(gb,0,simpleParam,location).then((function(data){obj.gb=gb;obj.data=data;obj.dataTimeValue=firstDataTimeValue;defer.resolve(obj)}));else if(dataUnit.valueType!==DataUnitType.uTable||dataUnit.uId!==DeviceDataType.ArpTable&&dataUnit.uId!==DeviceDataType.CdpTable&&dataUnit.uId!==DeviceDataType.MacTable&&dataUnit.uId!==DeviceDataType.RouteTable&&dataUnit.uId!==DeviceDataType.StpTable&&dataUnit.uId!==DeviceDataType.BgpNbrTable||!allowGo)if(dataUnit.valueType===DataUnitType.uTable&&dataUnit.uId===DeviceDataType.NctTable&&allowGo){var nctParam=innerGetDeviceDataTableParams({type:"nct",nctName:dataUnit.value,vrfName:"",uId:dataUnit.uId},userEvt,location);convertDeviceDataTable(gb,dataUnit,nctParam).then((function(data){obj.gb=gb;obj.data=data;obj.dataTimeValue=firstDataTimeValue;defer.resolve(obj)}))}else dataUnit.valueType===DataUnitType.uTable&&dataUnit.uId===DeviceDataType.ShowCommand&&allowGo?defer.resolve(obj):dataUnit.valueType===DataUnitType.uTable&&dataUnit.uId===DeviceDataType.SysTable&&allowGo?defer.resolve(obj):(dataUnit.valueType===DataUnitType.uTable&&(dataUnit.uId,DeviceDataType.CMD),defer.resolve(obj));else{var vrfParam=innerGetDeviceDataTableParams({type:"vrf",vrfName:"",uId:dataUnit.uId},userEvt,location);convertDeviceDataTable(gb,dataUnit,vrfParam).then((function(data){obj.gb=gb;obj.data=data;obj.dataTimeValue=firstDataTimeValue;defer.resolve(obj)}))}}),(function(err){console.warn("Failed to fetch device data",dataUnit,err);defer.resolve(obj)}));return defer.promise}function getData(posInfo,pOption){var defer=$q.defer();var dataUnit=pOption.dataUnit;var obj={gb:Const.getGoldenBaselineDefinition(!0,"Not Applicable"),data:{gbStatus:Const.GoldenBaselineStatus.NotApplicable,valueList:[],noHistoryData:!1}};var valueList=[];var columnList=null;var generateTime=new Date(dataUnit.generateTime);var timeText=moment.utc(generateTime).local().format("MM/DD/YYYY hh:mm:ss A");var value={alert:0,timePoint:dataUnit.generateTime,timeText:"",value:dataUnit.value,noCompare:!0};dataElementDetailsSrvc.resetGenerateTime(dataUnit.generateTime);if(dataUnit.type===DataUnitSourceType.uSrcGDR&&dataUnit.valueType===DataUnitType.uList){var gdrList=function(dataUnitValue){var success=!0;var valueList=[];var columnList=null;var valObj=null;try{valObj=JSON.parse(dataUnitValue)}catch(e){success=!1;console.warn("Failed to parse json obj from string.",dataUnitValue)}if(valObj&&valObj.length>0)if(_.isObject(valObj[0])){columnList=[];_.each(valObj,(function(item,i){var index=0;0===i&&_.each(item,(function(val,prop){var colObj={name:prop,fieldName:"f_"+index};columnList.push(colObj);index+=1}));index=0;var row={alert:"0"};_.each(item,(function(val){row["f_"+index]=val?val.toString():Const.NA;index+=1}));valueList.push(row)}))}else{_.each(valObj,(function(item){valueList.push({alert:"0",value:item})}));columnList=[]}return{columnList:columnList,valueList:valueList,success:success}}(dataUnit.value);if(gdrList&&gdrList.success){valueList=gdrList.valueList;columnList=gdrList.columnList}else valueList.push(value)}else if(dataUnit.value&&dataUnit.generateTime){if("0001-01-01T00:00:00"!==dataUnit.generateTime){generateTime.getTime()===generateTime.getTime()&&(value.currentMapTime=!0);value.timeText=timeText}valueList.push(value)}else if(dataUnit.type===DataUnitSourceType.uSrcCustomized&&dataUnit.valueType===DataUnitType.uParagraph){if("0001-01-01T00:00:00"!==dataUnit.generateTime){value.currentMapTime=!0;value.timeText=timeText;value.value=dataUnit.valueExpr.content}valueList.push(value)}obj.data.valueList=valueList;obj.data.columnList=columnList;obj.data.noHistoryData=function(type,valueType){var nothing=!1;type&&type!==DataUnitSourceType.uSrcCustomized||valueType&&valueType!==DataUnitType.uDoc&&valueType!==DataUnitType.uParagraph&&valueType!==Const.TempDataUnitValueType.uTempNote||(nothing=!0);return nothing}(dataUnit.type,dataUnit.valueType);defer.resolve(obj);return defer.promise}function convertDeviceTableTimeList(valueList,typeObj){var getVrfList=function(item){var vrfs=[];_.each(item.vrf,(function(vrfItem,index){var vrf={label:vrfItem,vrfName:vrfItem,index:index};vrfs.push(vrf)}));return vrfs};var timeList=[];_.each(valueList,(function(item){var timeItem={origin:item,timeText:"",timeValue:0,vrfList:null,nctList:null};var time=new Date(item.executeTime);timeItem.timeText=moment.utc(time).local().format("MM/DD/YYYY hh:mm:ss A");timeItem.timeValue=time.getTime();if("vrf"===typeObj.type){timeItem.vrfList=getVrfList(item);timeItem.nctList=null}if("nct"===typeObj.type){timeItem.vrfList=null;timeItem.nctList=function(item){var nctList=[];_.each(item.ncts,(function(nctItem,index){var nct={label:nctItem.nctName,nctName:nctItem.nctName,index:index,vrfList:null};nct.vrfList=getVrfList(nctItem);nctList.push(nct)}));return nctList}(item)}timeList.push(timeItem)}));return timeList}function convertGoldenBaselineTime(gbTime){var timeItem=Const.getTimeItemObj(!0);timeItem.origin=gbTime;if(gbTime&&gbTime.valueTime){var time=new Date(gbTime.valueTime);timeItem.timeText=moment.utc(time).local().format("MM/DD/YYYY hh:mm:ss A");timeItem.timeText+=" (Golden Sample)";timeItem.timeValue=time.getTime()}return timeItem}function convertParserTimeList(rawTime){var timeList=[];rawTime&&rawTime.valueList&&_.each(rawTime.valueList,(function(item){var timeItem=Const.getTimeItemObj(!1);timeItem.origin=item;var time=new Date(item.time);timeItem.timeText=moment.utc(time).local().format("MM/DD/YYYY hh:mm:ss A");timeItem.timeValue=time.getTime();timeList.push(timeItem)}));return timeList}function convertDeviceConfigTimeList(valueList){var timeList=[];_.each(valueList,(function(item){var timeItem=Const.getTimeItemObj(!1);timeItem.origin=item;var time=new Date(item.executeTime);timeItem.timeText=moment.utc(time).local().format("MM/DD/YYYY hh:mm:ss A");timeItem.timeValue=time.getTime();timeList.push(timeItem)}));return timeList}function loadSubPaneTimeList(pOption,duration,userFilter){var defer=$q.defer();var dataUnit=pOption.dataUnit;dataUnit.type===DataUnitSourceType.uSrcParserLibrary?function(pOption,duration,userFilter){var defer=$q.defer();var varType=pOption.variableType;var timeObj=Const.getTimeListResultObj();var simpleParam={devKey:pOption.devKey,devType:pOption.devType,dataViewInfo:pOption.dataViewInfo,dataUnit:pOption.dataUnit};var dataViewTaskInfoId=null;pOption.dataViewInfo&&pOption.dataViewInfo.dataViewTaskInfoId&&(dataViewTaskInfoId=pOption.dataViewInfo.dataViewTaskInfoId);var qList=[];if(varType===Const.VariableType.table)if(userFilter.timeListType===Const.TimeListType.all){qList.push(dataElementDetailsSrvc.getGoldenBaselineDataTime(simpleParam));if(varType===Const.VariableType.table){qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,null));dataViewTaskInfoId&&qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,dataViewTaskInfoId))}}else if(userFilter.timeListType===Const.TimeListType.dataView&&dataViewTaskInfoId)qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,dataViewTaskInfoId));else if(userFilter.timeListType===Const.TimeListType.dataEngine)qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,null));else if(userFilter.timeListType===Const.TimeListType.timePointer){qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,null));dataViewTaskInfoId&&qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,dataViewTaskInfoId))}else if(userFilter.timeListType===Const.TimeListType.timePointerWithGb){qList.push(dataElementDetailsSrvc.getGoldenBaselineDataTime(simpleParam));qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,null));dataViewTaskInfoId&&qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,dataViewTaskInfoId))}else qList.push(fetchEmptyFunction);qList.length>0?$q.all(qList).then((function(result){if(result)if(userFilter.timeListType===Const.TimeListType.all){var rawGbTime=result[0];timeObj.gbTime=convertGoldenBaselineTime(rawGbTime);var rawDataEngineTime=result[1];timeObj.dataEngineTimeList=convertParserTimeList(rawDataEngineTime);timeObj.dataEngineAllRecordCont=rawDataEngineTime?rawDataEngineTime.allRecordCount:0;if(dataViewTaskInfoId){var rawDataViewTime=result[2];timeObj.dataViewTimeList=convertParserTimeList(rawDataViewTime);timeObj.dataViewAllRecordCount=rawDataViewTime?rawDataViewTime.allRecordCount:0}}else if(userFilter.timeListType===Const.TimeListType.timePointerWithGb){var rawGbTimeZ=result[0];var rawDeTimeZ=result[1];var rawDvTimeZ=result[2];timeObj.gbTime=convertGoldenBaselineTime(rawGbTimeZ);if(rawDvTimeZ&&rawDvTimeZ.valueList&&rawDvTimeZ.valueList.length>0){timeObj.timeList=convertParserTimeList(rawDvTimeZ);timeObj.allRecordCount=rawDvTimeZ.allRecordCount}else if(rawDeTimeZ&&rawDeTimeZ.valueList&&rawDeTimeZ.valueList.length>0){timeObj.timeList=convertParserTimeList(rawDeTimeZ);timeObj.allRecordCount=rawDeTimeZ.allRecordCount}}else if(userFilter.timeListType===Const.TimeListType.timePointer){var rawDeTime=result[0];var rawDvTime=result[1];if(rawDvTime&&rawDvTime.valueList&&rawDvTime.valueList.length>0){timeObj.timeList=convertParserTimeList(rawDvTime);timeObj.allRecordCount=rawDvTime.allRecordCount}else if(rawDeTime&&rawDeTime.valueList&&rawDeTime.valueList.length>0){timeObj.timeList=convertParserTimeList(rawDeTime);timeObj.allRecordCount=rawDeTime.allRecordCount}}else{var rawTime=result[0];timeObj.timeList=convertParserTimeList(rawTime);timeObj.allRecordCount=rawTime.allRecordCount}defer.resolve(timeObj)}),(function(err){console.warn("Failed to get golden baseline time and history time.",err);defer.resolve(timeObj)})):defer.resolve(timeObj);return defer.promise}(pOption,duration,userFilter).then((function(obj){defer.resolve(obj)})):dataUnit.type===DataUnitSourceType.uSrcDeviceData?function(pOption,duration,userFilter){var defer=$q.defer();var timeObj=Const.getTimeListResultObj();var dataViewTaskInfoId=pOption.dataViewInfo?pOption.dataViewInfo.dataViewTaskInfoId:null;var qList=[];userFilter.timeListType===Const.TimeListType.all?qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,null)):userFilter.timeListType===Const.TimeListType.dataView&&dataViewTaskInfoId?qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,dataViewTaskInfoId)):userFilter.timeListType===Const.TimeListType.dataEngine?qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,null)):userFilter.timeListType===Const.TimeListType.timePointer?qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,duration,userFilter,null)):qList.push(fetchEmptyFunction);$q.all(qList).then((function(result){if(result){var dataUnit=pOption.dataUnit;if(dataUnit.valueType===DataUnitType.uConfigFile&&dataUnit.uId===DeviceDataType.Config)if(userFilter.timeListType===Const.TimeListType.all){var rawConfigDataEngineTime=result[0];timeObj.dataEngineTimeList=convertDeviceConfigTimeList(rawConfigDataEngineTime.valueList)}else if(userFilter.timeListType===Const.TimeListType.timePointer){var rawConfigDeTime=result[0];rawConfigDeTime&&rawConfigDeTime.valueList&&rawConfigDeTime.valueList.length>0&&(timeObj.timeList=convertDeviceConfigTimeList(rawConfigDeTime.valueList))}else{var rawConfigTime=result[0];timeObj.timeList=convertDeviceConfigTimeList(rawConfigTime.valueList)}else if(dataUnit.valueType!==DataUnitType.uTable||dataUnit.uId!==DeviceDataType.ArpTable&&dataUnit.uId!==DeviceDataType.CdpTable&&dataUnit.uId!==DeviceDataType.MacTable&&dataUnit.uId!==DeviceDataType.RouteTable&&dataUnit.uId!==DeviceDataType.StpTable&&dataUnit.uId!==DeviceDataType.BgpNbrTable)if(dataUnit.valueType===DataUnitType.uTable&&dataUnit.uId===DeviceDataType.NctTable){var nct={type:"nct",nctName:dataUnit.value,vrfName:""};if(userFilter.timeListType===Const.TimeListType.all){var rawDataEngineTime=result[0];timeObj.dataEngineTimeList=convertDeviceTableTimeList(rawDataEngineTime.valueList,nct)}else if(userFilter.timeListType===Const.TimeListType.timePointer){var rawNctDeTime=result[0];rawNctDeTime&&rawNctDeTime.valueList&&rawNctDeTime.valueList.length>0&&(timeObj.timeList=convertDeviceTableTimeList(rawNctDeTime.valueList,nct))}else{var rawNctTime=result[0];timeObj.timeList=convertDeviceTableTimeList(rawNctTime.valueList,nct)}}else dataUnit.valueType===DataUnitType.uTable&&dataUnit.uId===DeviceDataType.ShowCommand||dataUnit.valueType===DataUnitType.uTable&&dataUnit.uId===DeviceDataType.SysTable||dataUnit.valueType===DataUnitType.uTable&&(dataUnit.uId,DeviceDataType.CMD);else{var vrf={type:"vrf",vrfName:""};if(userFilter.timeListType===Const.TimeListType.all){var rawVrfDataEngineTime=result[0];timeObj.dataEngineTimeList=convertDeviceTableTimeList(rawVrfDataEngineTime.valueList,vrf)}else if(userFilter.timeListType===Const.TimeListType.timePointer){var rawVrfDeTime=result[0];rawVrfDeTime&&rawVrfDeTime.valueList&&rawVrfDeTime.valueList.length>0&&(timeObj.timeList=convertDeviceTableTimeList(rawVrfDeTime.valueList,vrf))}else{var rawVrfTime=result[0];timeObj.timeList=convertDeviceTableTimeList(rawVrfTime.valueList,vrf)}}}defer.resolve(timeObj)}),(function(){defer.resolve(timeObj)}));return defer.promise}(pOption,duration,userFilter).then((function(obj){defer.resolve(obj)})):defer.resolve(null);return defer.promise}return{loadSubPaneData:function(pOption,duration,userEvt){var defer=$q.defer();var dataUnit=pOption.dataUnit;pOption.posInfo;if(dataUnit.type===DataUnitSourceType.uSrcParserLibrary)userEvt?function(pOption,duration,userEvt){var defer=$q.defer();var dataUnit=pOption.dataUnit;var varType=pOption.variableType;var obj={gb:null,data:null,frequence:30,isrunning:!1};var qList=[];var gbOrigin=userEvt.gbOrigin;var gbRule=userEvt.gbRule;var gb=Const.getGoldenBaselineDefinition();gbRule&&(gb.rule=gbRule);if(gbOrigin){gb.origin=gbOrigin;gb.rule.displayName=gbOrigin.displayName}var mapUnitAlarm=null;if(userEvt.isGoldenBaselineTime){var simpleParam={devKey:pOption.devKey,devType:pOption.devType,dataViewInfo:pOption.dataViewInfo,dataUnit:dataUnit,valueTime:userEvt.timeOrigin.valueTime};qList.push(dataElementDetailsSrvc.getGoldenBaselineData(simpleParam))}else{userEvt.needLoadByMap&&(mapUnitAlarm=dataElementDetailsSrvc.getUnitAlarm(pOption));if(varType===Const.VariableType.string){qList.push(dataElementDetailsSrvc.getDataViewHistoryData(pOption,gbOrigin,duration,userEvt));qList.push(fetchParserLibraryTimeFromGB(pOption))}else if(varType===Const.VariableType.number)qList.push(dataElementDetailsSrvc.getDataViewHistoryData(pOption,gbOrigin,duration,userEvt));else if(varType===Const.VariableType.table)if(userEvt.needLoadByMap&&dataUnit.valueExpr&&dataUnit.valueExpr.guid)qList.push(dataElementDetailsSrvc.getParserTableById(dataUnit.valueExpr.guid,userEvt.pageIndex,userEvt.pageSize,userEvt.filterWords));else{var dataLocation=userEvt.timeOrigin.dataLocation;qList.push(dataElementDetailsSrvc.getDataViewHistoryDataByLocation(dataLocation,dataUnit,gbOrigin,userEvt))}}$q.all(qList).then((function(result){if(result&&result.length>0&&result[0]){var rawData=result[0];var rawGbTime=result[1];var gbTimeValue=rawGbTime?rawGbTime.gbTimeValue:null;if(rawData){obj.frequence=rawData.frequence;obj.isrunning=rawData.isrunning;if(varType===Const.VariableType.string){var strData=convertStringPaneData(gb,rawData,dataUnit.generateTime,gbTimeValue);obj.data=strData}else if(varType===Const.VariableType.table){var rawTableData=rawData;userEvt.isGoldenBaselineTime&&(rawTableData={table:rawData.value});var tableData=convertTablePaneData(gb,rawTableData,mapUnitAlarm);obj.data=tableData}else if(varType===Const.VariableType.number){var numData=convertNumberPaneData(gb,rawData);obj.data=numData}}obj.gb=gb;obj.gb.rule.status=getGbStatusByData(obj.data,dataUnit,gb.origin,gb.error)}defer.resolve(obj)}),(function(err){console.warn("Failed to refresh data",dataUnit,err);obj.gb=gb;obj.gb.rule.status=getGbStatusByData(null,dataUnit,gb.origin,gb.error);defer.resolve(obj)}));return defer.promise}(pOption,duration,userEvt).then((function(obj){defer.resolve(obj)})):fetchParserLibraryData(pOption,duration).then((function(obj){defer.resolve(obj)}));else if(dataUnit.type===DataUnitSourceType.uSrcDeviceData){var preFetch=null;if(pOption.mode===Const.DetailPaneMode.GbManager){!0;preFetch=fetchEmptyFunction}else preFetch=fetchEmptyFunction;preFetch().then((function(){fetchDeviceData(pOption,0,userEvt).then((function(obj){defer.resolve(obj)}))}))}else getData(0,pOption).then((function(obj){$timeout((function(){defer.resolve(obj)}),700)}));return defer.promise},loadSubPaneTimeList:loadSubPaneTimeList,getVrfLocation:function(userEvt){var vrf={type:"vrf",vrfName:userEvt.vrf};return getDeviceDataTableParam(userEvt.timeOrigin,vrf,userEvt).id},getNctLocation:function(userEvt){var nct={type:"nct",nctName:userEvt.nct,vrfName:userEvt.vrf};return getDeviceDataTableParam(userEvt.timeOrigin,nct,userEvt).id},getParseredLink:function(link,devKey,intfId){return httpDataViewSrvc.getParseredLink(link,devKey,intfId)},getDevInfo:function(pOption){var intfFullName=pOption&&pOption.dataUnit&&pOption.intfKey?pOption.dataUnit.intfKey.name:"";var devInfo={devKey:pOption.devKey,hostName:pOption.hostName,devType:pOption.devType,intfFullName:intfFullName};var intfKey=pOption.dataUnit.intfKey;intfKey&&intfKey.value&&intfKey.schema&&dataElementDetailsSrvc.getIfObjFromCache(intfKey.value,intfKey.schema).then((function(JsonObj){devInfo.intfFullName=JsonObj.name}));return devInfo},getParserPathParam:function(pOption){var vlan10="";if(pOption&&pOption.dataUnit&&pOption.dataUnit.parserPath){var key=pOption.dataUnit.parserPath.replace(/\./g,"@")+Const.parserParamKeySuffix;pOption.dataUnit[key]&&(_.isObject(pOption.dataUnit[key])?vlan10=JSON.stringify(pOption.dataUnit[key]):_.isString(pOption.dataUnit[key])?vlan10=pOption.dataUnit[key]:console.log("Failed to get parser param."))}return vlan10},loadTableRowCount:function(pOption,duration,userEvt){var defer=$q.defer();dataElementDetailsSrvc.getTableCountHistoryData(pOption,duration,userEvt).then((function(data){defer.resolve(data)}),(function(){defer.resolve(null)}));return defer.promise},getY:function(y){var yy=isNaN(y)?"N/A":y;if("N/A"!==yy){yy=/^-?\d+$/.test(y.toString())?Math.round(yy):/^(-?\d+)(\.\d+)?$/.test(y.toString())?yy.toFixed(2):"N/A"}return yy},getRightPlaceIndex:function(arr,val){var index=-1;if(arr&&arr.length>0&&val>=arr[0][0]&&val<=arr[arr.length-1][0]){var first=0;var last=arr.length-1;for(;first<last;){var mid=first+Math.floor((last-first)/2);arr[mid][0]<val?first=mid+1:last=mid}index=first}return index},getCustomizedPositioner:function(max,min){var positions=[];var increment=Math.ceil((max-min)/4);increment<10&&(increment=10);var tick;if(min>=0){(tick=min-increment)<0&&(tick=0);if(null!==max&&null!==min){for(;tick-increment<=max;tick+=increment)positions.push(Math.ceil(tick));positions.push(Math.ceil(tick))}}else if(max>0){if(null!==max&&null!==min){for(tick=0;tick+increment>=min;tick-=increment)positions.push(Math.ceil(tick));positions.push(Math.ceil(tick));for(tick=0;tick-increment<=max;tick+=increment)positions.push(Math.ceil(tick));positions.push(Math.ceil(tick))}}else{(tick=max+increment)>0&&(tick=0);if(null!==max&&null!==min){for(;tick+increment>=min;tick-=increment)positions.push(Math.ceil(tick));positions.push(Math.ceil(tick))}}return positions=_.sortBy(_.uniq(positions))},getDataMin:function(valueList){if(valueList&&valueList.length>0){var floatValueList=[];_.each(valueList,(function(item){var val=!item.value||isNaN(parseFloat(item.value))?null:parseFloat(item.value);if(val||0===val){var floatItem={timePoint:item.timePoint,value:val};floatValueList.push(floatItem)}}));if(floatValueList.length>0){var minItem=_.min(floatValueList,"value");if(minItem)return minItem.value}return 0}return 0},convertDeviceMetaDataToTimeItem:convertDeviceMetaDataToTimeItem}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").factory("nb.dataview.detailCompareSrvc",detailCompareSrvc);detailCompareSrvc.$inject=["$rootScope","nb.ng.nbHttp","$q","$log","$uibModal","$location","nb.networkos.myFilesSrvc","nb.datamodel.httpSiteSrvc","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.uiframework.urlStateMgr","nb.ng.httpAuthSrvc","$timeout","nb.ng.utilitySrvc","nb.ng.sessionSrvc","nb.uiframework.mainUISrvc","nb.networkos.fileSrvc","nb.dataview.httpDataElementDetailsSrvc","nb.runbook.httpRunBookSrvc","nb.topo.httpTopoSrvc","nb.common.nbTipSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.qmap.httpMapLayoutSrvc","nb.qmap.mapManagerSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.dataview.dataElementDetailsSrvc"];function detailCompareSrvc($rootScope,nbHttp,$q,$log,$uibModal,$location,myFilesSrvc,httpSiteSrvc,userSrvc,nbAlertSrvc,httpMapSrvc,urlStateMgr,httpAuthSrvc,$timeout,utilitySrvc,sessionSrvc,mainUISrvc,fileSrvc,httpDataElementDetailsSrvc,runbookMgr,httpTopoSrvc,nbTipSrvc,httpDeviceGroupSrvc,httpMapLayoutSrvc,mapManagerSrvc,deviceTypeMgrSrvc,dataElementDetailsSrvc){dataElementDetailsSrvc.dataElementConst;return{loadStringCompareData:function(pOption,startTime,endTime){var defer=$q.defer();var devKey=pOption.devKey;var intfKeyObj=pOption.intfKeyObj;var dataUnit=pOption.dataUnit;var obj={value2:null,goldenBaselineTime:null,timeList:null};var qList=[];var intfKeyName=intfKeyObj&&intfKeyObj.name?intfKeyObj.name:null;var parserPath=dataUnit.parserPath;var variableName=pOption.variableName;qList.push(dataElementDetailsSrvc.getGoldenBaselineStringData(devKey,intfKeyName,parserPath,variableName,null,null));qList.push(dataElementDetailsSrvc.getDataViewHistoryDataTimeList(pOption,startTime,endTime));$q.all(qList).then((function(result){var value2="";var timeList=result[1];if(result[0]&&result[0].length>0){value2="";""}obj.value2=value2;obj.timeList=timeList;defer.resolve(obj)}),(function(err){defer.resolve(obj)}));return defer.promise},convertStringCompareDataToGridObj:function(compareResult){var obj={leftData:[],rightData:[]};if(compareResult){var value1Lines=compareResult.oldTextLines;var value2Lines=compareResult.newTextLines;var len=compareResult.oldTextLines.length;var leftData=[];var rightData=[];for(var i=0;i<len;i++){var value1=value1Lines[i];var text1=value1.text?value1.text:"";var leftValue={type:3!==value1.type?value1.type:3!==value2.type?value2.type:0,text:text1,position:value1.position?value1.position:0};leftData.push(leftValue);var value2=value2Lines[i];var text2=value2.text?value2.text:"";var rightValue={type:3!==value2.type?value2.type:3!==value1.type?value1.type:0,text:text2,position:value2.position?value2.position:0};rightData.push(rightValue)}obj.leftData=leftData;obj.rightData=rightData}return obj},test:function(mapIdList){}}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").factory("nb.dataview.detailPaneSrvc",detailPaneSrvc);detailPaneSrvc.$inject=["$rootScope","nb.ng.nbHttp","$q","$log","$uibModal","$location","nb.networkos.myFilesSrvc","nb.datamodel.httpSiteSrvc","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.uiframework.urlStateMgr","nb.ng.httpAuthSrvc","$timeout","nb.ng.utilitySrvc","nb.ng.sessionSrvc","nb.uiframework.mainUISrvc","nb.networkos.fileSrvc","nb.runbook.httpRunBookSrvc","nb.topo.httpTopoSrvc","nb.common.nbTipSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.qmap.httpMapLayoutSrvc","nb.qmap.mapManagerSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.dataview.httpDataElementDetailsSrvc"];function detailPaneSrvc($rootScope,nbHttp,$q,$log,$uibModal,$location,myFilesSrvc,httpSiteSrvc,userSrvc,nbAlertSrvc,httpMapSrvc,urlStateMgr,httpAuthSrvc,$timeout,utilitySrvc,sessionSrvc,mainUISrvc,fileSrvc,runbookMgr,httpTopoSrvc,nbTipSrvc,httpDeviceGroupSrvc,httpMapLayoutSrvc,mapManagerSrvc,deviceTypeMgrSrvc,httpDataElementDetailsSrvc){var EventType=NetBrain.DataView.ElementConst.EventType;function openShowVariableSample(data){$uibModal.open({templateUrl:"modules/nbDataView/dataElementDetails/views/dataElementVariableSample.html",controller:"nb.dataview.dataElementVariableSample",windowClass:"data-element-variable-sample-box",backdrop:"static",size:"sm",resolve:{dataHandler:function(){return{getData:function(){return data}}}}}).result.then((function(result){result.export}),(function(){}))}return{closeDetailPane:function(dvtPath){$rootScope.$emit(EventType.CLOSE_DATA_ELEMENT_PANE,"",dvtPath)},showVariableSample:function(variableFullName,parserPath,title,deviceId,currentUnit){if(parserPath&&variableFullName){var data={title:title||variableFullName,parserPath:parserPath,variableFullName:variableFullName,parserId:null};openShowVariableSample(data)}}}}}(NetBrain);!function(netbrain){angular.module("nb.dataview").factory("nb.dataview.httpDataElementDetailsSrvc",httpDataElementDetailsSrvc);httpDataElementDetailsSrvc.$inject=["$rootScope","nb.ng.nbHttp","$q"];function httpDataElementDetailsSrvc($rootScope,nbHttp,$q){function ajax(url,method,request,options){return nbHttp[method.toLowerCase()](url,request,options)}function post(url,request){return ajax(url,"POST",request)}function formatGbVariableName(varName){return varName?varName.replace(/\$/g,""):varName}return{getDataViewHistoryData:function(data){return post("dataviewhistory/getDataViewHistoryData",data)},getDataViewHistoryDataTimeList:function(data){return post("dataviewhistory/getDataViewHistoryTimePoints",data)},getDataViewHistoryDataByLocation:function(data){return post("dataviewhistory/getDataByDataLocation",data)},compareWithGoldenBaseLine:function(dataType,item1,item2){return post("dataviewhistory/compareWithGoldenBaseLine",{dataType:dataType,item1:item1,item2:item2})},getGoldenBaselineData:function(obj){var defer=$q.defer();obj.variablename=formatGbVariableName(obj.variablename);var valueObj={};post("goldenBaseline/gbDataEngine/getData",obj).then((function(data){data&&(valueObj={id:data.id,deviceName:data.deviceName,interfacePath:data.interfacePath,interfaceValue:data.interfaceValue,nodeId:data.nodeId,nbNodePathSchema:data.nbNodePathSchema,variableName:data.variableName,variableSource:data.variableSource,variableSourceType:data.variableSourceType,ruleTypeId:data.ruleTypeId,structureId:data.structureId,param:data.param,value:data.value,valueTime:data.valueTime});defer.resolve(valueObj)}),(function(){defer.resolve(valueObj)}));return defer.promise},getMappingAfterVariable:function(data){return post("dataviewhistory/getMappingAfterVariable",data)},getTableCountHistoryData:function(data){return post("dataviewhistory/getTableCountHistoryData",data)},getParserTableById:function(data){return post("actionTask/otherwrapper/parserTable",data)},getHistoryMetaDataList:function(data){return post("actionTask/otherwrapper/getHistoryMetaDataList",data)},formatGbVariableName:formatGbVariableName}}}(NetBrain);!function(NetBrain){var consts=NetBrain.ns("DataView.ElementConst");consts.NS_NAME="nb.dataview.element";consts.EventType={SHOW_DATA_ELEMENT_PANE:"ShowDataElementDetailPane",CLOSE_DATA_ELEMENT_PANE:"CloseDataElementDetailPane",REFRESH_DATA_ELEMENT_PANE:"refreshDataElementDetailPane",DEVICE_CHANGED_DATA_ELEMENT_PANE:"DeviceChangedDataElementDetailPane"}}(NetBrain);!function(netbrain){angular.module("nb.dataview").directive("nbDataElementNumberPaneDirective",Directive);Directive.$inject=["$document","$rootScope","nb.dataview.dataElementDetailsSrvc","nb.dataview.detailDrillDownLabelSrvc","nb.qmap.historyChartSrvc","$timeout","$q"];function Directive($document,$rootScope,dataElementDetailsSrvc,detailDrillDownLabelSrvc,historyChartSrvc,$timeout,$q){var directive={restrict:"EA",templateUrl:"modules/nbDataView/dataElementDetails/views/nbDataElementNumberPaneDirective.html",controller:controller,replace:!0,scope:{paneOption:"="},link:function($scope,$element,attrs,ctrls){var getY=detailDrillDownLabelSrvc.getY;var getCustomizedPositioner=detailDrillDownLabelSrvc.getCustomizedPositioner;var Const=dataElementDetailsSrvc.dataElementConst;var option=null;var chartDiv=null;var chart=null;$scope.Wording={noDataText:Const.Wording.noDataText};$scope.viewModel={mainDivId:"",Title:"",noData:!1,parserPathParam:"",parserPath:"",variableIconClass:"icon_nb_String_12",mode:0,gb:{status:Const.GoldenBaselineStatus.NotDefined,displayName:"Define Golden Baseline",gbDefinition:null,dataUnit:null,devInfo:null,mode:0,queryParams:null,dataViewInfo:null,showChartPrefix:!0},chartRangeSelector:[],loading:!0,inited:!1,isShowLeftButton:!0,isShowRightButton:!1,moreLoading:!1,sampleText:""};var generateTimeValue=null;var duration={value:30};var mPageIndex=0;var mPageSize=Const.DefaultPageSize;var mChartData=null;function safeChartGet(id){try{if(chart){return chart.get(id)}return null}catch(e){return null}}function setExtremes(){$timeout((function(){var xAxis=safeChartGet("xAxis");var pilot=safeChartGet("nav");if(xAxis&&pilot){var series=xAxis.series[0];var min=series.xData[0];var max=series.xData[series.xData.length-1];xAxis.setExtremes(min,max,!0)}}),50)}$scope.onChartRangeSelectorClick=function(item){for(var i=0;i<$scope.viewModel.chartRangeSelector.length;i++){$scope.viewModel.chartRangeSelector[i].selected=!1}item.selected=!0;"all"===item.type?duration.value=null:30===item.count?duration.value=30:7===item.count?duration.value=7:5===item.count?duration.value=5:1===item.count&&(duration.value=1);mPageIndex=0;refreshData();$scope.viewModel.isShowRightButton=!1};$scope.onChartLeftClick=function(){mPageIndex+=1;refreshData().then((function(noData){noData&&(mPageIndex-=1);$scope.viewModel.isShowRightButton=0!==mPageIndex}))};$scope.onChartRightClick=function(){mPageIndex=mPageIndex<=0?0:mPageIndex-1;refreshData().then((function(noData){noData&&(mPageIndex+=1);$scope.viewModel.isShowRightButton=0!==mPageIndex}))};$scope.variableSampleClick=function(){if(option&&option.dataUnit&&option.dataUnit.parserPath){var parserPath=option.dataUnit.parserPath;var varName=option.dataUnit.varName;var title=$scope.viewModel.Title;var deviceId=option.devKey;var dataUnit=option.dataUnit;dataElementDetailsSrvc.showVariableSample(varName,parserPath,title,deviceId,dataUnit)}};function seriesList(unit,chartData,rule){if(chart){var percentY=chart.get("percentY");var numberY=chart.get("numberY");percentY&&percentY.remove(!1);numberY&&numberY.remove(!1);var gbRule=rule;var normalData=chartData.normalData;var alertData=chartData.alertData;var nullData=chartData.nullData;var yAxis=function(index,unit,metricLength,allValueList){var axisUnit;var axisId;axisUnit=metricLength>1&&unit&&"%"!==unit.unit?"":unit&&unit.unit||"";var axis={id:axisId="%"===(unit&&unit.unit)?"percentY":"numberY",title:{text:""},lineWidth:1,opposite:!(1===metricLength||unit&&"%"===unit.unit),labels:{formatter:function(){var retValue=this.value;return null==retValue||isNaN(retValue)?"N/A":retValue+axisUnit}}};if("percentY"===axisId){axis.min=0;axis.max=100;axis.tickPositions=[0,20,40,60,80,100]}var containsAnalysisValue=[];if(1===metricLength){axis.plotLines=[];if(unit&&unit.analysisList&&angular.isArray(unit.analysisList)&&unit.analysisList.length>0){_.each(unit.analysisList,(function(each){var threshold=JSON.parse(each.threshold);var thresholdValue=parseFloat(threshold.value);if(!isNaN(thresholdValue)){containsAnalysisValue.push(thresholdValue);axis.plotLines.push({value:thresholdValue,color:"red",dashStyle:"shortdash",width:2})}}));var minA=_.find(axis.plotLines,(function(p){return p.value===Math.min.apply(this,containsAnalysisValue)}));minA&&(minA.color="#ffcc2b")}}axis.tickPositioner=function(){return unit.valueType===DataUnitType.uCompoundVar?[-1,0,1,2]:unit.valueType===DataUnitType.uBool?[0,1,2]:getCustomizedPositioner(this.dataMax,this.dataMin)};if("uCompoundVar"===unit.valueType){axis.max=2;axis.min=-1;axis.labels.formatter=function(){return historyChartSrvc.formatForCompound(this.value)}}if(containsAnalysisValue.length>0){var allValue=[];_.each(allValueList,(function(item){item[1]&&allValue.push(item[1])}));allValue=allValue.concat(containsAnalysisValue);var maxv=Math.max.apply(Math,allValue);var minv=Math.min.apply(Math,allValue);axis.max=maxv;axis.min=minv}return axis}(0,option.dataUnit,1,normalData);chart.get(yAxis.id)||chart.addAxis(yAxis,!1,!1);var axisId=unit&&"%"===unit.unit?"percentY":"numberY";var seriesNormal={animation:!0,color:Const.LEGEND_COLOR[0],data:normalData,id:unit.uId,lineWidth:1,marker:{radius:3,symbol:"circle"},name:unit?unit.displayName:"",yAxis:axisId,title:{text:null},plotOptions:{line:{connectNulls:!0}},states:{hover:{enabled:!1}}};var axis=chart.get(axisId);if(axis&&axis.options){if(gbRule&&gbRule.lines&&gbRule.lines.length>0){axis.options.plotLines=[];_.each(gbRule.lines,(function(line){var pl={value:line.value,color:line.color,dashStyle:"solid",width:2,zIndex:1};axis.options.plotLines.push(pl)}))}if(gbRule&&gbRule.bands){axis.options.plotBands=[];axis.options.plotBands.push({from:gbRule.bands.from,to:gbRule.bands.to,color:gbRule.bands.color})}}if(generateTimeValue){var xaxis=chart.get("xAxis");if(xaxis&&xaxis.options){var index=detailDrillDownLabelSrvc.getRightPlaceIndex(normalData,generateTimeValue);if(-1!==index){xaxis.options.plotLines[0].value=generateTimeValue;index>=normalData.length/2?xaxis.options.plotLines[0].label.x=-104:xaxis.options.plotLines[0].label.x=3}}}chart.addSeries(seriesNormal,!1);var seriesAlert={data:alertData,enableMouseTracking:!1,lineWidth:0,marker:{fillColor:"#ee3124",height:6,radius:3,symbol:"circle",width:6,states:{hover:{enabled:!1}}},name:"warning",tooltip:{enabled:!1,formatter:function(){return!1}},title:{text:null},yAxis:axisId,states:{hover:{enabled:!1}}};chart.addSeries(seriesAlert,!1);var seriesNull={data:nullData,lineWidth:0,marker:{fillColor:"#666",height:6,radius:3,symbol:"circle",width:6,states:{hover:{enabled:!1}}},name:"warning",tooltip:{enabled:!0,useHTML:!0,zIndex:12,formatter:function(evt){var timeValue=new Date(this.x);return'<div><span style="width: 95px;text-align: left;display: inline-block;margin-right: 6px;">Date: </span><span>'+moment.utc(timeValue).local().format("MM/DD/YYYY hh:mm:ss A")+'</span><br/><span style="width: 95px;text-align: left;display: inline-block;margin-right: 6px;">Actual Value: </span><span style="color: #d1021b;">Failed to get data</span><br/></div>'}},title:{text:null},yAxis:axisId,states:{hover:{enabled:!1}}};chart.addSeries(seriesNull,!1);var nav=chart.get("nav");nav&&nav.setData(normalData,!1);chart.redraw()}}function getChartOption(data){Highcharts.setOptions({global:{useUTC:!1}});return{credits:{enabled:!1},rangeSelector:{inputEnabled:!1,allButtonsEnabled:!0,buttons:Const.chartRangeSelector,selected:2,enabled:!1},lang:{noData:Const.Wording.noDataText},legend:{enabled:!1},scrollbar:{liveRedraw:!1},xAxis:{minPadding:0,maxPadding:0,id:"xAxis",type:"datetime",dateTimeLabelFormats:Const.chartDateTimeLabelFormats,minRange:6e4,events:{afterSetExtremes:function(){},setExtremes:function(e){}},plotLines:[{color:"#000",value:null,width:1,label:{useHTML:!0,className:"numPaneChart",text:'<span class="numPaneChart"> Map Data Time</span>',rotation:0,align:"top",y:16,zIndex:2},zIndex:2}],title:{text:null}},yAxis:{title:{text:null}},series:[],plotOptions:{series:{marker:{enabled:!0,radius:6,symbol:"circle"},point:{events:{click:function(evt,a){}}}},line:{connectNulls:!0}},tooltip:{useHTML:!0,zIndex:11,backgroundColor:"rgba(255,255,255,1)",shadow:!1,formatter:function(evt){var timeValue=new Date(this.x);var isNull=function(timeValue){var isInNull=!1;_.each(mChartData.nullData,(function(item){if(timeValue===item[0]){isInNull=!0;return!1}return!0}));return isInNull}(this.x);var html='<div><span style="width: 95px;text-align: left;display: inline-block;margin-right: 6px;">Date: </span><span>'+moment.utc(timeValue).local().format("MM/DD/YYYY hh:mm:ss A")+"</span><br/>";var content='<span style="width: 95px;text-align: left;display: inline-block;margin-right: 6px;">Actual Value: </span><span>'+getY(this.y)+'</span><br/><span style="width: 95px;text-align: left;display: inline-block;margin-right: 6px;">Golden Baseline: </span><span>'+$scope.viewModel.gb.displayName+"</span>";isNull&&(content='<span style="width: 95px;text-align: left;display: inline-block;margin-right: 6px;">Actual Value: </span><span style="color: #d1021b;">Failed to get data</span><br/>');return html+content+"</div>"}},navigator:{enabled:!0,adaptToUpdateData:!1,series:{id:"nav",type:"areaspline",color:"#4572a7",fillOpacity:.1},xAxis:{id:"nav_xAxis",type:"datetime",dateTimeLabelFormats:Const.chartDateTimeLabelFormats}},title:{text:null}}}function initChart(){chart&&chart.destroy();Highcharts.wrap(Highcharts.Axis.prototype,"getPlotLinePath",(function(proceed){var path=proceed.apply(this,Array.prototype.slice.call(arguments,1));path&&(path.flat=!1);return path}));chartDiv=$element.find("#chartDiv1");chart=Highcharts.chart("chartDiv1",getChartOption())}!function(){$scope.viewModel.mainDivId=NgUtil.getUniqueStr();$scope.viewModel.chartRangeSelector=Const.chartRangeSelector}();function refreshData(){var defer=$q.defer();$scope.viewModel.moreLoading=!0;var gbOrigin=null;var gbRule=null;if($scope.viewModel.gb.gbDefinition&&$scope.viewModel.gb.gbDefinition.origin){gbOrigin=$scope.viewModel.gb.gbDefinition.origin;gbRule=$scope.viewModel.gb.gbDefinition.rule}var tempUserEvt={gbOrigin:gbOrigin,gbRule:gbRule,pageIndex:mPageIndex,pageSize:mPageSize};var noData=!1;detailDrillDownLabelSrvc.loadSubPaneData(option,duration,tempUserEvt).then((function(obj){if(obj||obj.data||obj.data.valueList||obj.data.valueList.length>0)showData(obj);else{noData=!0;$scope.viewModel.moreLoading=!1;$scope.viewModel.isShowRightButton=!1}defer.resolve(noData)}));return defer.promise}function showData(pData){if(option){if(pData&&pData.gb&&pData.gb.rule){$scope.viewModel.gb.displayName=pData.gb.rule.displayName;$scope.viewModel.gb.gbDefinition=pData.gb;$scope.viewModel.gb.status=pData.gb.rule.status}$scope.viewModel.gb.dataUnit=option.dataUnit;$scope.viewModel.gb.devInfo=detailDrillDownLabelSrvc.getDevInfo(option);$scope.viewModel.gb.mode=$scope.viewModel.mode;$scope.viewModel.gb.queryParams=option.queryParams;$scope.viewModel.gb.dataViewInfo=option.dataViewInfo;$scope.viewModel.parserPathParam=detailDrillDownLabelSrvc.getParserPathParam(option);$scope.viewModel.parserPath=option.dataUnit.parserPath;if(pData&&pData.data){var data=pData.data;var chartData=function(valueList){var alertData=[];var normalData=[];var nullData=[];if(valueList){var min=detailDrillDownLabelSrvc.getDataMin(valueList);for(var i=0;i<valueList.length;i++){var value=!valueList[i].value||isNaN(parseFloat(valueList[i].value))?null:parseFloat(valueList[i].value);var time=new Date(valueList[i].timePoint).getTime();valueList[i].alert>0&&alertData.push([time,value]);null===value&&nullData.push([time,min]);normalData.push([time,value])}normalData=_.sortBy(normalData,(function(it){return it[0]}));alertData=_.sortBy(alertData,(function(it){return it[0]}));nullData=_.sortBy(nullData,(function(it){return it[0]}))}return{normalData:normalData,alertData:alertData,nullData:nullData}}(data.valueList);mChartData=chartData;$scope.viewModel.isShowLeftButton=(mPageIndex+1)*Const.DefaultPageSize<data.allRecordCount;initChart();if(chart){var rule=null;$scope.viewModel.gb.gbDefinition&&(rule=$scope.viewModel.gb.gbDefinition.rule);seriesList(option.dataUnit,chartData,rule);setExtremes()}}pData&&pData.data&&pData.data.valueList&&0!==pData.data.valueList.length?$scope.viewModel.noData=!1:$scope.viewModel.noData=!0;$scope.viewModel.inited=!0;$scope.viewModel.loading=!1;$scope.viewModel.moreLoading=!1}}var setOptionEvent=$scope.$on(Const.Event.INIT_VARIABLE_PANE,(function(event,pOption){setHasDataPaneVisible(!0);!function(pOption){generateTimeValue=null;option=pOption;$scope.viewModel.Title=dataElementDetailsSrvc.getVariableTitle(pOption.dataUnit.prefix,pOption.dataUnit.displayName,pOption.unitShowName);$scope.viewModel.hostName=pOption.hostName;$scope.viewModel.devKey=pOption.devKey;$scope.viewModel.mode=pOption.mode;try{pOption.dataUnit.generateTime&&(generateTimeValue=new Date(pOption.dataUnit.generateTime).getTime())}catch(e){}chart||initChart();pOption.mode===Const.DetailPaneMode.GbManager&&($scope.viewModel.sampleText="View Sample");$scope.viewModel.variableIconClass=dataElementDetailsSrvc.getVariableIcon(!1,pOption.dataUnit.type,pOption.dataUnit.valueType,!0);$scope.viewModel.isShowRightButton=!1}(pOption);for(var i=0;i<$scope.viewModel.chartRangeSelector.length;i++){$scope.viewModel.chartRangeSelector[i].selected=!1}$scope.viewModel.chartRangeSelector[3].selected=!0}));var setOptionLoading=$scope.$on(Const.Event.SHOW_VARIABLE_LOADING,(function(){$scope.viewModel.loading=!0}));var setOptionData=$scope.$on(Const.Event.SHOW_VARIABLE_DATA,(function(event,pData){mPageIndex=0;duration.value=30;showData(pData)}));var watchDetailPaneResizeEvent=$rootScope.$on(Const.Event.DETAIL_PANE_RESIZE_EVENT,(function(event){if(chartDiv){var width=chartDiv.width();var height=chartDiv.height();chart&&chart.setSize(width,height,!1)}}));var watchResizeHeightFunction=$scope.$watch((function(){return angular.element(chartDiv).height()}),(function(val,height){if(height&&val&&chart&&val>0&&height>0&&height!==val){var chartHeight=angular.element(chartDiv).height();var chartWidth=angular.element(chartDiv).width();chart.setSize(chartWidth,chartHeight,!1)}}));var watchResizeWidthFunction=$scope.$watch((function(){return angular.element(chartDiv).width()}),(function(val,width){if(width&&val&&chart&&val>0&&width>0&&width!==val){var chartHeight=angular.element(chartDiv).height();var chartWidth=angular.element(chartDiv).width();chart.setSize(chartWidth,chartHeight,!1)}}));var watchNoDataFunction=$scope.$watch((function(){return $scope.viewModel.noData}),(function(val1,val2){val1!==val2&&setHasDataPaneVisible(!val1)}));function setHasDataPaneVisible(isShow){isShow?$element.find(".has-data").show():$element.find(".has-data").hide()}$scope.$on("$destroy",(function(){setOptionEvent();setOptionLoading();setOptionData();watchDetailPaneResizeEvent();watchResizeHeightFunction();watchResizeWidthFunction();chart&&chart.destroy();watchNoDataFunction()}))}};controller.$inject=["$compile","$scope","$document","$element","$attrs"];function controller($compile,$scope,$document,element,attr){}return directive}}(NetBrain);!function(netbrain){angular.module("nb.dataview").directive("nbGoldenBaselineDisplayNameDirective",Directive);Directive.$inject=["$document"];function Directive($document){var directive={restrict:"EA",templateUrl:"modules/nbDataView/dataElementDetails/views/nbGoldenBaselineDisplayNameDirective.html",controller:controller,replace:!0,scope:{gbObj:"="},link:function($scope,$element,attrs,ctrls){}};controller.$inject=["$compile","$scope","$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.netbrain.httpDeviceSrvc","nb.common.nbTipSrvc","nb.ng.permissionSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","uiGridTreeBaseService","$uibModal","nb.common.nbDragDropSrvc","nb.uiframework.urlStateMgr","nb.dataview.dataElementDetailsSrvc"];function controller($compile,$scope,element,attr,$timeout,$rootScope,$q,mapManagerSrvc,httpDeviceSrvc,nbTipSrvc,permissionSrvc,mapContextMenuManager,updateMapSrvc,uiGridTreeBaseService,$uibModal,nbDragDropSrvc,urlStateMgr,dataElementDetailsSrvc){var hasManualDefinitionPerm=permissionSrvc.anyPermission(NetBrain.NG.Permissions.GBManualDefinition);var Const=dataElementDetailsSrvc.dataElementConst;$scope.viewModel={gb:{},isTablePane:!1,canEdit:hasManualDefinitionPerm};function setGoldenBaselineValue(ruleResult){if(ruleResult){$scope.viewModel.gb.gbDefinition.origin=ruleResult.ruleObject;$scope.viewModel.gb.displayName=ruleResult.ruleObject.displayName}}$scope.onGoldenBaselineViewClick=function(){var gb=$scope.viewModel.gb;var gbOrigin=gb.gbDefinition?gb.gbDefinition.origin:null;dataElementDetailsSrvc.viewGoldenBaselineRuleDialog(gbOrigin,gb.mode,gb.queryParams,gb.dataUnit,gb.dataViewInfo).then((function(ruleResult){setGoldenBaselineValue(ruleResult)}))};$scope.onGoldenBaselineEditClick=function(){var gb=$scope.viewModel.gb;var gbOrigin=gb.gbDefinition?gb.gbDefinition.origin:null;dataElementDetailsSrvc.editGoldenBaselineRuleDialog(gbOrigin,gb.mode,gb.queryParams,gb.dataUnit,gb.dataViewInfo,null).then((function(ruleResult){setGoldenBaselineValue(ruleResult)}))};$scope.onDefineGoldenBaselineClick=function(){var gb=$scope.viewModel.gb;var gbOrigin=gb.gbDefinition?gb.gbDefinition.origin:null;dataElementDetailsSrvc.defineGoldenBaselineRuleDialog(gb.devInfo,gbOrigin,gb.mode,gb.queryParams,gb.dataUnit,gb.dataViewInfo,null).then((function(ruleResult){setGoldenBaselineValue(ruleResult)}))};!function(){if($scope.gbObj){var isTablePane=!1;var dataUnit=$scope.gbObj.dataUnit;if(dataUnit){var varPaneType=dataElementDetailsSrvc.getVariablePaneType(dataUnit.type,dataUnit.valueType,dataUnit.uId);varPaneType!==Const.VariablePaneType.parserTable&&varPaneType!==Const.VariablePaneType.deviceTable||(isTablePane=!0)}$scope.viewModel.gb=$scope.gbObj;$scope.viewModel.isTablePane=isTablePane}}();$scope.$on("$destroy",(function(){}))}return directive}}(NetBrain);!function(netBrain){angular.module("nb.dataview").directive("nbGoldenBaselineAnalysisDirective",Directive);Directive.$inject=["$document","nb.dataview.dataElementDetailsSrvc"];function Directive($document,dataElementDetailsSrvc){var directive={restrict:"EA",templateUrl:"modules/nbDataView/dataElementDetails/views/nbGoldenBaselineAnalysisDirective.html",controller:controller,replace:!0,scope:{gbObj:"="},link:function($scope,$element,attrs,ctrls){}};controller.$inject=["$compile","$scope","$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.netbrain.httpDeviceSrvc","nb.common.nbTipSrvc","nb.qmap.mapContextMenuManager","nb.qmap.updateMapSrvc","uiGridTreeBaseService","$uibModal","nb.common.nbDragDropSrvc","nb.uiframework.urlStateMgr"];function controller($compile,$scope,element,attr,$timeout,$rootScope,$q,mapManagerSrvc,httpDeviceSrvc,nbTipSrvc,mapContextMenuManager,updateMapSrvc,uiGridTreeBaseService,$uibModal,nbDragDropSrvc,urlStateMgr){$scope.viewModel={gb:{}};$scope.gbObj&&($scope.viewModel.gb=$scope.gbObj);$scope.$on("$destroy",(function(){}))}return directive}}(NetBrain);!function(netbrain){angular.module("nb.dataview").directive("nbHistoryDataTimeListDirective",Directive);Directive.$inject=["$document"];function Directive($document){var directive={restrict:"EA",templateUrl:"modules/nbDataView/dataElementDetails/views/nbHistoryDataTimeListDirective.html",controller:controller,replace:!0,scope:{option:"="},link:function($scope,$element,attrs,ctrls){}};controller.$inject=["$compile","$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.netbrain.httpDeviceSrvc","nb.common.nbTipSrvc","nb.qmap.updateMapSrvc","uiGridTreeBaseService","$uibModal","$scope","nb.dataview.dataElementDetailsSrvc","nb.dataview.detailDrillDownLabelSrvc"];function controller($compile,element,attr,$timeout,$rootScope,$q,mapManagerSrvc,httpDeviceSrvc,nbTipSrvc,updateMapSrvc,uiGridTreeBaseService,$uibModal,$scope,dataElementDetailsSrvc,detailDrillDownLabelSrvc){var emptyTimeItem={origin:null,timeText:"Select a time point",timeValue:null};var Const=dataElementDetailsSrvc.dataElementConst;var timePointChanged=null;var timePointInited=null;var dataViewTimePageIndex=0;var dataEngineTimePageIndex=0;var getVirtualTimeItem=function(timeValue){var time=new Date(timeValue);return{origin:null,timeText:Const.formatDateTime(time),timeValue:timeValue}};function initMember(){$scope.viewModel={divId:"",selectedTimeItem:emptyTimeItem,baselineTimeList:[],dataViewTimeList:[],dataEngineTimeList:[],showDataViewMore:!0,showDataEngineMore:!0,dataViewName:"Interface Errors - Result 1",showDataViewGroup:!0,dropdownMenuStyle:{},isShow:!1,status:{isopen:!1}};timePointChanged=null;timePointInited=null;[];[]}function currentTimeItemChanged(timeValue,isGbTime,needLoadInit){var findItem=null;if(isGbTime&&$scope.viewModel.baselineTimeList&&$scope.viewModel.baselineTimeList.length>0)findItem=$scope.viewModel.baselineTimeList[0];else{var index=_.findIndex($scope.viewModel.dataEngineTimeList,{timeValue:timeValue});index>=0&&(findItem=$scope.viewModel.dataEngineTimeList[index]);(index=_.findIndex($scope.viewModel.dataViewTimeList,{timeValue:timeValue}))>=0&&(findItem=$scope.viewModel.dataViewTimeList[index])}$scope.viewModel.selectedTimeItem=findItem||getVirtualTimeItem(timeValue);if(needLoadInit&&findItem){var userEvt={timeOrigin:findItem.origin,isGoldenBaselineTime:findItem.isGoldenBaselineTime,timeItem:findItem};timePointInited(userEvt,!0)}}$scope.onTimePointDropdownMenuItemClick=function(timeItem){!function(timeItem){var userEvt={timeOrigin:timeItem.origin,isGoldenBaselineTime:timeItem.isGoldenBaselineTime,vrfList:timeItem.vrfList,nctList:timeItem.nctList,timeItem:timeItem};timePointChanged(userEvt);$scope.viewModel.selectedTimeItem=timeItem}(timeItem)};$scope.onDataViewTitleClick=function(){event.stopPropagation()};$scope.onDataViewMoreClick=function(event){var userFilter=Const.getTimeListUserFilter();userFilter.pageIndex=dataViewTimePageIndex;userFilter.timeListType=Const.TimeListType.dataView;detailDrillDownLabelSrvc.loadSubPaneTimeList($scope.option.pOption,null,userFilter).then((function(obj){refresh(_.extend({generateTime:$scope.option.generateTime},obj,{gbTime:$scope.option.gbTime}),Const.TimeListType.dataView)}));event.stopPropagation()};$scope.onDataEngineMoreClick=function(event){var userFilter=Const.getTimeListUserFilter();userFilter.pageIndex=dataEngineTimePageIndex;userFilter.timeListType=Const.TimeListType.dataEngine;detailDrillDownLabelSrvc.loadSubPaneTimeList($scope.option.pOption,null,userFilter).then((function(obj){refresh(_.extend({generateTime:$scope.option.generateTime},obj,{gbTime:$scope.option.gbTime}),Const.TimeListType.dataEngine)}));event.stopPropagation()};function getCurrentMapTimeText(timeText){var currentMapTimeText=timeText;timeText.indexOf(" (Map Data Time)")<0&&(currentMapTimeText=timeText+" (Map Data Time)");return currentMapTimeText}function load(){$scope.option.currentTimeItemChanged=currentTimeItemChanged;$scope.option.dropdownMenuStyle&&($scope.viewModel.dropdownMenuStyle=$scope.option.dropdownMenuStyle);refresh($scope.option,null,!0);$scope.viewModel.dataViewName=$scope.option.dataViewShowName;$scope.option.timePointChanged&&(timePointChanged=$scope.option.timePointChanged);if($scope.option.timePointInited){timePointInited=$scope.option.timePointInited;var generateTime=$scope.option.generateTime;if(generateTime){var timeValue=new Date(generateTime).getTime();$scope.viewModel.selectedTimeItem.timeValue!==timeValue&&($scope.viewModel.selectedTimeItem=getVirtualTimeItem(timeValue));timeItem=$scope.viewModel.selectedTimeItem,userEvt={timeOrigin:timeItem.origin,isGoldenBaselineTime:timeItem.isGoldenBaselineTime,timeItem:timeItem},timePointInited(userEvt)}}var timeItem,userEvt;0===$scope.viewModel.baselineTimeList.length&&0===$scope.viewModel.dataViewTimeList.length&&0===$scope.viewModel.dataEngineTimeList.length?$scope.viewModel.isShow=!1:$scope.viewModel.isShow=!0}function refresh(paneOption,timeListType,needSetSelected){$scope.viewModel.timeList=paneOption.timeList;var generateTime=paneOption.generateTime;var onlyShowMapDataTimeInDataView=!1;var dataUnit=$scope.option.pOption?$scope.option.pOption.dataUnit:null;dataUnit&&dataUnit.type===DataUnitSourceType.uSrcDeviceData&&(onlyShowMapDataTimeInDataView=!0);var timeItem=function(timeList,gbTime,dataViewTimeList,dataEngineTimeList,generateTime,onlyShowMapDataTimeInDataView){var findItem=null;var _timeList=[];var _dataViewTimeList=[];var _dataEngineTimeList=[];var _baselineTimeList=[];var generateTimeValue=new Date(generateTime).getTime();_.each(timeList,(function(timeItem){if(generateTimeValue===timeItem.timeValue){findItem=timeItem;timeItem.timeText=getCurrentMapTimeText(timeItem.timeText)}_timeList.push(timeItem)}));_.each(dataEngineTimeList,(function(timeItem){if(generateTimeValue===timeItem.timeValue){findItem=timeItem;timeItem.timeText=getCurrentMapTimeText(timeItem.timeText)}_dataEngineTimeList.push(timeItem)}));_.each(dataViewTimeList,(function(timeItem){if(generateTimeValue===timeItem.timeValue){findItem=timeItem;timeItem.timeText=getCurrentMapTimeText(timeItem.timeText);onlyShowMapDataTimeInDataView&&_dataViewTimeList.push(timeItem)}onlyShowMapDataTimeInDataView||_dataViewTimeList.push(timeItem)}));gbTime&&gbTime.isGoldenBaselineTime&&gbTime.timeText&&_baselineTimeList.push(gbTime);return{findItem:findItem,timeList:_timeList,dataViewTimeList:_dataViewTimeList,dataEngineTimeList:_dataEngineTimeList,baselineTimeList:_baselineTimeList}}(paneOption.timeList,paneOption.gbTime,paneOption.dataViewTimeList,paneOption.dataEngineTimeList,generateTime,onlyShowMapDataTimeInDataView);var dataViewTimeList=timeItem.dataViewTimeList;timeListType===Const.TimeListType.dataView&&timeItem.timeList&&timeItem.timeList.length>0&&(dataViewTimeList=timeItem.timeList);var dataEngineTimeList=timeItem.dataEngineTimeList;timeListType===Const.TimeListType.dataEngine&&timeItem.timeList&&timeItem.timeList.length>0&&(dataEngineTimeList=timeItem.timeList);!function(dataViewTimeList,allRecordCount){dataViewTimePageIndex+=1;_.each(dataViewTimeList,(function(item){$scope.viewModel.dataViewTimeList.push(item);$scope.viewModel.selectedTimeItem&&$scope.viewModel.selectedTimeItem.timeValue===item.timeValue&&($scope.viewModel.selectedTimeItem=item)}));$scope.viewModel.showDataViewMore=!0;(allRecordCount&&dataViewTimePageIndex*Const.TimeListPageSize>=allRecordCount||dataViewTimeList.length<Const.TimeListPageSize)&&($scope.viewModel.showDataViewMore=!1);$scope.viewModel.showDataViewGroup=!1;$scope.viewModel.dataViewTimeList&&$scope.viewModel.dataViewTimeList.length>0&&($scope.viewModel.showDataViewGroup=!0)}(dataViewTimeList);!function(dataEngineTimeList,allRecordCount){dataEngineTimePageIndex+=1;_.each(dataEngineTimeList,(function(item){$scope.viewModel.dataEngineTimeList.push(item);$scope.viewModel.selectedTimeItem&&$scope.viewModel.selectedTimeItem.timeValue===item.timeValue&&($scope.viewModel.selectedTimeItem=item)}));$scope.viewModel.showDataEngineMore=!0;(allRecordCount&&dataEngineTimePageIndex*Const.TimeListPageSize>=allRecordCount||dataEngineTimeList.length<Const.TimeListPageSize)&&($scope.viewModel.showDataEngineMore=!1)}(dataEngineTimeList);$scope.viewModel.baselineTimeList=timeItem.baselineTimeList;timeItem.findItem&&needSetSelected?$scope.viewModel.selectedTimeItem=timeItem.findItem:$scope.viewModel.timeList&&$scope.viewModel.timeList.length}!function(){initMember();$scope.viewModel.dropDownMenuDivId=NgUtil.getUniqueStr();load()}();var watchRefreshFunction=$scope.$watch("option.refresh",(function(value){if(!0===value){initMember();load()}}));$scope.$on("$destroy",(function(){watchRefreshFunction()}))}return directive}}(NetBrain);!function(){angular.module("nb.dataview").directive("nbDataElementTableRowCountDirective",Directive);Directive.$inject=["$document","$rootScope","$timeout","$q","nb.dataview.dataElementDetailsSrvc","nb.dataview.detailDrillDownLabelSrvc","nb.qmap.historyChartSrvc"];function Directive($document,$rootScope,$timeout,$q,dataElementDetailsSrvc,detailDrillDownLabelSrvc,historyChartSrvc){var directive={restrict:"EA",templateUrl:"modules/nbDataView/dataElementDetails/views/nbDataElementTableRowCountDirective.html",replace:!0,scope:{paneOption:"="},controller:controller,link:function($scope,$element,attrs,ctrls){var getY=detailDrillDownLabelSrvc.getY;var getCustomizedPositioner=detailDrillDownLabelSrvc.getCustomizedPositioner;var Const=dataElementDetailsSrvc.dataElementConst;var option=$scope.paneOption;var chartDiv=null;var chart=null;$scope.Wording={noDataText:Const.Wording.noDataText};$scope.viewModel={mainDivId:"",noData:!1,isShowPopover:!1,dataDateTimeText:"",dataDateTime:"",dataValue:"",chartRangeSelector:[],loading:!0,inited:!1,isShowLeftButton:!0,isShowRightButton:!1};var noTooltip=!1;var generateTimeValue=0;var duration={value:30};var m_pageIndex=0;var m_pageSize=Const.DefaultPageSize;var tableRowList=[];$scope.onChartRangeSelectorClick=function(item){clearInterval(setThirtySecond);for(var i=0;i<$scope.viewModel.chartRangeSelector.length;i++){$scope.viewModel.chartRangeSelector[i].selected=!1}item.selected=!0;"all"===item.type?duration.value=null:30===item.count?duration.value=30:7===item.count?duration.value=7:5===item.count?duration.value=5:1===item.count&&(duration.value=1);m_pageIndex=0;refreshData();$scope.viewModel.isShowRightButton=!1};$scope.onChartLeftClick=function(){m_pageIndex++;refreshData().then((function(noData){noData&&m_pageIndex--;$scope.viewModel.isShowRightButton=0!==m_pageIndex}))};$scope.onChartRightClick=function(){m_pageIndex=m_pageIndex<=0?0:m_pageIndex-1;refreshData().then((function(noData){noData&&m_pageIndex++;$scope.viewModel.isShowRightButton=0!==m_pageIndex}))};function refreshData(){var defer=$q.defer();$scope.viewModel.loading=!0;if(_.isFunction(option.refreshRowCountData)){var userEvt={pageIndex:m_pageIndex,pageSize:m_pageSize};var noData=!1;setHasDataPaneVisible(!0);option.refreshRowCountData(duration,userEvt).then((function(resultOption){showData({data:resultOption.data,generateTime:resultOption.generateTime});resultOption&&resultOption.data&&resultOption.data.valueList&&resultOption.data.valueList.length>0||(noData=!0);defer.resolve(noData)}))}else defer.resolve(!0);return defer.promise}function seriesList(unit,chartData,rule){if(chart){var percentY=chart.get("percentY");var numberY=chart.get("numberY");percentY&&percentY.remove(!1);numberY&&numberY.remove(!1);var gbRule=rule;var data=chartData.normalData;var alertData=chartData.alertData;var yAxis=function(index,unit,metricLength,allValueList){var axisUnit;var axisId;axisUnit=metricLength>1&&unit&&"%"!==unit.unit?"":unit&&unit.unit||"";var axis={id:axisId="%"===(unit&&unit.unit)?"percentY":"numberY",title:{text:null},lineWidth:1,opposite:!(1===metricLength||"%"===(unit&&unit.unit)),labels:{formatter:function(){var retValue=this.value;return null==retValue||isNaN(retValue)?"N/A":retValue+axisUnit}}};if("percentY"===axisId){axis.min=0;axis.max=100;axis.tickPositions=[0,20,40,60,80,100]}var containsAnalysisValue=[];if(1===metricLength){axis.plotLines=[];if(unit&&unit.analysisList&&angular.isArray(unit.analysisList)&&unit.analysisList.length>0){_.each(unit.analysisList,(function(each){var threshold=JSON.parse(each.threshold);var thresholdValue=parseFloat(threshold.value);if(!isNaN(thresholdValue)){containsAnalysisValue.push(thresholdValue);axis.plotLines.push({value:thresholdValue,color:"red",dashStyle:"shortdash",width:2})}}));var minA=_.find(axis.plotLines,(function(p){return p.value===Math.min.apply(this,containsAnalysisValue)}));minA&&(minA.color="#ffcc2b")}}axis.tickPositioner=function(){return unit.valueType===DataUnitType.uCompoundVar?[-1,0,1,2]:unit.valueType===DataUnitType.uBool?[0,1,2]:getCustomizedPositioner(this.dataMax,this.dataMin)};if(unit&&"uCompoundVar"===unit.valueType){axis.max=2;axis.min=-1;axis.labels.formatter=function(){return historyChartSrvc.formatForCompound(this.value)}}if(containsAnalysisValue.length>0){var allValue=[];_.each(allValueList,(function(item){item[1]&&allValue.push(item[1])}));allValue=allValue.concat(containsAnalysisValue);var maxv=Math.max.apply(Math,allValue);var minv=Math.min.apply(Math,allValue);axis.max=maxv;axis.min=minv}return axis}(0,unit,1,data);chart.get(yAxis.id)||chart.addAxis(yAxis,!1,!1);var axisId=unit&&"%"===unit.unit?"percentY":"numberY";var series={animation:!0,color:Const.LEGEND_COLOR[0],data:data,id:unit.uId,lineWidth:1,marker:{radius:3,symbol:"circle"},name:unit&&unit.displayName?unit.displayName:"trc",yAxis:axisId,tooltip:{enabled:!1,formatter:function(){return!1}},title:{text:null},plotOptions:{line:{connectNulls:!0}},states:{hover:{enabled:!1}},cursor:"pointer"};var axis=chart.get(axisId);if(axis&&axis.options){if(gbRule&&gbRule.bands){axis.options.plotBands=[];axis.options.plotBands.push({from:gbRule.bands.from,to:gbRule.bands.to,color:"rgba(68, 170, 213, 0.2)"})}if(gbRule&&gbRule.lines&&gbRule.lines.length>0){axis.options.plotLines=[];_.each(gbRule.lines,(function(line){var pl={value:line.value,color:line.color,dashStyle:"solid",width:2};axis.options.plotLines.push(pl)}))}}if(generateTimeValue){var xaxis=chart.get("xAxis");if(xaxis&&xaxis.options){var index=detailDrillDownLabelSrvc.getRightPlaceIndex(data,generateTimeValue);if(-1!==index){xaxis.options.plotLines[0].value=generateTimeValue;index>=data.length/2?xaxis.options.plotLines[0].label.x=-104:xaxis.options.plotLines[0].label.x=3}}}chart.addSeries(series,!1).tooltipOptions.enabled=!1;var seriesAlert={data:alertData,enableMouseTracking:!1,lineWidth:0,marker:{fillColor:"#ee3124",height:6,radius:3,symbol:"circle",width:6,states:{hover:{enabled:!1}}},name:"warning",tooltip:{enabled:!1,formatter:function(){return!1}},title:{text:null},yAxis:axisId,states:{hover:{enabled:!1}},cursor:"pointer"};chart.addSeries(seriesAlert,!1);var nav=chart.get("nav");nav&&nav.setData(data,!1);chart.redraw()}}window.viewTableDetails=function(){var ctt=currentToolTip;ctt&&ctt.x&&console.log(ctt.x,new Date(ctt.x))};function getChartOption(data){Highcharts.setOptions({global:{useUTC:!1}});return{credits:{enabled:!1},rangeSelector:{inputEnabled:!1,allButtonsEnabled:!0,buttons:Const.chartRangeSelector,selected:2,enabled:!1},lang:{noData:Const.Wording.noDataText},legend:{enabled:!1},scrollbar:{liveRedraw:!1},xAxis:{minPadding:0,maxPadding:0,id:"xAxis",type:"datetime",dateTimeLabelFormats:Const.chartDateTimeLabelFormats,minRange:6e4,events:{afterSetExtremes:function(){},setExtremes:function(e){}},plotLines:[{color:"#000",value:null,width:1,label:{useHTML:!0,className:"numPaneChart",text:'<span class="numPaneChart"> Map Data Time</span>',rotation:0,align:"top",y:16,zIndex:2},zIndex:2}],title:{text:null}},yAxis:{title:{text:null}},series:[],plotOptions:{series:{marker:{enabled:!0,radius:4,symbol:"circle"},point:{events:{click:function(evt,a){!function(timeValue){if(tableRowList&&tableRowList.length>0){var index=_.findIndex(tableRowList,{timeValue:timeValue});if(index>=0){var timeText=tableRowList[index].timeText;_.isFunction(option.tableRowCountChanged)&&option.tableRowCountChanged(timeText,timeValue)}}}(evt.point.x)}}}},line:{connectNulls:!0}},tooltip:{useHTML:!0,zIndex:11,backgroundColor:"rgba(255,255,255,1)",shadow:!1,formatter:function(evt){if(noTooltip)return!1;var timeValue=new Date(this.x);return'<div><span style="width: 75px;text-align: left;display: inline-block;margin-right: 6px;">Date: </span><span>'+moment.utc(timeValue).local().format("MM/DD/YYYY hh:mm:ss A")+'</span><br/><span style="width: 75px;text-align: left;display: inline-block;margin-right: 6px;">Actual Value: </span><span>'+getY(this.y)+"</span><br/></div>"}},navigator:{enabled:!0,adaptToUpdateData:!1,series:{id:"nav",type:"areaspline",color:"#4572a7",fillOpacity:.1},xAxis:{id:"nav_xAxis",type:"datetime",dateTimeLabelFormats:Const.chartDateTimeLabelFormats}},title:{text:null}}}var currentToolTip={x:null,cloneToolTip:null,cloneToolTip2:null};function initChart(){chart&&chart.destroy();Highcharts.wrap(Highcharts.Axis.prototype,"getPlotLinePath",(function(proceed){var path=proceed.apply(this,Array.prototype.slice.call(arguments,1));path&&(path.flat=!1);return path}));chartDiv=$element.find("#chartDiv1");chart=Highcharts.chart("chartDiv1",getChartOption())}!function(){$scope.viewModel.mainDivId=NgUtil.getUniqueStr();$scope.viewModel.chartRangeSelector=Const.chartRangeSelector;$scope.viewModel.loading=!0;chart||initChart();chart&&showData(option);$element.parent().css("overflow","visible")}();function showData(pageOption){var data=pageOption.data;var valueList=pageOption.data.valueList;var generateTime=pageOption.generateTime;var chartData=function(valueList){var alertData=[];var normalData=[];var nullData=[];if(valueList){var min=detailDrillDownLabelSrvc.getDataMin(valueList);for(var i=0;i<valueList.length;i++){var value=!valueList[i].value||isNaN(parseFloat(valueList[i].value))?null:parseFloat(valueList[i].value);var time=new Date(valueList[i].timePoint).getTime();valueList[i].alert>0&&alertData.push([time,value]);null===value&&nullData.push([time,min]);normalData.push([time,value]);tableRowList.push({timeValue:time,timeText:valueList[i].timePoint})}normalData=_.sortBy(normalData,(function(it){return it[0]}));alertData=_.sortBy(alertData,(function(it){return it[0]}));nullData=_.sortBy(nullData,(function(it){return it[0]}))}return{normalData:normalData,alertData:alertData,nullData:nullData}}(valueList);generateTimeValue=new Date(generateTime).getTime();$scope.viewModel.isShowLeftButton=(m_pageIndex+1)*Const.DefaultPageSize<data.allRecordCount;initChart();if(chart){seriesList({uId:"rowCount"},chartData,{})}if(valueList&&valueList.length>0&&!function(a,b){if(a.length===b.length){for(var i=0;i<a.length;i++)if(a[i][0]!==b[i][0]&&a[i][1]!==b[i][1])return!1;return!0}return!1}(chartData.normalData,chartData.nullData))$scope.viewModel.noData=!1;else{$scope.viewModel.noData=!0;setHasDataPaneVisible(!1)}$scope.viewModel.inited=!0;$scope.viewModel.loading=!1}var watchDetailPaneResizeEvent=$rootScope.$on(Const.Event.DETAIL_PANE_RESIZE_EVENT,(function(event){if(chartDiv){var width=chartDiv.width();var height=chartDiv.height();chart&&chart.setSize(width,height,!1)}}));var watchResizeHeightFunction=$scope.$watch((function(){return angular.element(chartDiv).height()}),(function(val,height){if(height&&val&&chart&&val>0&&height>0&&height!==val){var chartHeight=angular.element(chartDiv).height();var chartWidth=angular.element(chartDiv).width();chart.setSize(chartWidth,chartHeight,!1)}}));var watchResizeWidthFunction=$scope.$watch((function(){return angular.element(chartDiv).width()}),(function(val,width){if(width&&val&&chart&&val>0&&width>0&&width!==val){var chartHeight=angular.element(chartDiv).height();var chartWidth=angular.element(chartDiv).width();chart.setSize(chartWidth,chartHeight,!1)}}));function setHasDataPaneVisible(isShow){isShow?$element.find(".has-data").show():$element.find(".has-data").hide()}$scope.$on("$destroy",(function(){watchDetailPaneResizeEvent();watchResizeHeightFunction();watchResizeWidthFunction();chart&&chart.destroy();$element.parent().css("overflow","")}));var setThirtySecond=null}};controller.$inject=["$compile","$scope","$document","$element","$attrs","$timeout","$rootScope","$q","nb.qmap.mapManagerSrvc","nb.netbrain.httpDeviceSrvc","nb.common.nbTipSrvc"];function controller($compile,$scope,$document,element,attr,$timeout,$rootScope,$q,mapManagerSrvc,httpDeviceSrvc,nbTipSrvc){}return directive}}(NetBrain);function CDataUnit(jsData){this._data={type:null,uId:null,displayName:null,value:null,valueType:null,prefix:null,unit:null,isRefLink:null,valueExpr:null};if(jsData){this._data=jsData;if(jsData.type!==window.DataUnitSourceType.uSrcQapp&&jsData.valueExpr){this._data.valueType===window.DataUnitType.uObject&&(this._data.valueExpr=new window.CDataUnitValueExpr_schema_object_type(jsData.valueExpr).toJson());this._data.valueType!==window.DataUnitType.uList_object_subtype&&this._data.valueType!==window.DataUnitType.uList_primitive_subtype||(this._data.valueExpr=new window.CDataUnitValueExpr_schema_list_type(jsData.valueExpr).toJson());this._data.valueType!==window.DataUnitType.uTable&&this._data.valueType!==window.DataUnitType.uConfigFile||(this._data.valueExpr=new window.CDataUnitValueExpr_deviceData(jsData.valueExpr).toJson());(this._data.valueType===window.DataUnitType.uHyperLink||this._data.valueType===window.DataUnitType.uString&&this._data.type===window.DataUnitSourceType.uSrcCustomized)&&(this._data.valueExpr=new window.CDataUnitValueExpr_label_or_hyperlink(jsData.valueExpr).toJson());this._data.valueType===window.DataUnitType.uParagraph&&(this._data.valueExpr=new window.CDataUnitValueExpr_formatNote(jsData.valueExpr).toJson());this._data.valueType===window.DataUnitType.uDoc&&(this._data.valueExpr=new window.CDataUnitValueExpr_attachment(jsData.valueExpr).toJson())}}}CDataUnit.prototype={constructor:CDataUnit,fromJson:function(jsData){this._data=jsData;this._data.valueExpr=null;if(jsData.type!==window.DataUnitSourceType.uSrcQapp&&jsData.valueExpr){this._data.valueType!==window.DataUnitType.uTable&&this._data.valueType!==window.DataUnitType.uConfigFile||(this._data.valueExpr=new window.CDataUnitValueExpr_deviceData(jsData.valueExpr).toJson());this._data.valueType===window.DataUnitType.uHyperLink&&(this._data.valueExpr=new window.CDataUnitValueExpr_label_or_hyperlink(jsData.valueExpr).toJson());this._data.valueType===window.DataUnitType.uParagraph&&(this._data.valueExpr=new window.CDataUnitValueExpr_formatNote(jsData.valueExpr).toJson());this._data.valueType===window.DataUnitType.uDoc&&(this._data.valueExpr=new window.CDataUnitValueExpr_attachment(jsData.valueExpr).toJson());this._data.valueType===window.DataUnitType.uObject&&(this._data.valueExpr=new window.CDataUnitValueExpr_schema_object_type(jsData.valueExpr).toJson());this._data.valueType!==window.DataUnitType.uList_object_subtype&&this._data.valueType!==window.DataUnitType.uList_primitive_subtype||(this._data.valueExpr=new window.CDataUnitValueExpr_schema_list_type(jsData.valueExpr).toJson())}},toJson:function(){var jsValue=angular.copy(this._data);var valueExprJson=jsValue.valueExpr&&"string"==typeof jsValue.valueExpr?JSON.parse(jsValue.valueExpr):jsValue.valueExpr;delete jsValue.valueExpr;valueExprJson&&(jsValue.valueExpr=valueExprJson.toJson?valueExprJson.toJson():valueExprJson);return jsValue},getData:function(){return this._data},setData:function(data){this._data=data},isEmpty:function(){return!this._data.uId&&!this._data.value},getUId:function(){return this._data.uId},getSourceType:function(){return this._data.type},getDisplayName:function(){return this._data.displayName?this._data.displayName:""},getValueType:function(){return this._data.valueType},getValue:function(){return this._data.value},getValueExpr:function(){return this._data.valueExpr},getPrefix:function(){return this._data.prefix},getUnit:function(){return this._data.unit},setValueExpr:function(valueExpr){return this._data.valueExpr=valueExpr},setDataUnit_schema:function(argSourceType,argUId,argDisplayName,argValueType,argValue,argPrefix,argUnit){this._data.type=argSourceType;this._data.uId=argUId;this._data.displayName=argDisplayName;this._data.valueType=argValueType;this._data.value=argValue;this._data.valueExpr=null;this._data.prefix=argPrefix;this._data.unit=argUnit||null},setDataUnit_schema_object_type:function(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue){this._data.type=argSourceType;this._data.uId=argSchemaId;this._data.displayName=argSchemaDisplayName;this._data.valueType=window.DataUnitType.uObject;this._data.value=argSchemaDisplayName;this._data.prefix=null;this._data.unit=null;var valueExprSchemaObjectType=new window.CDataUnitValueExpr_schema_object_type;valueExprSchemaObjectType.fromParams(argDeviceId,argSchemaId,argIntfKeySchema,argIntfKeySchemaValue);this._data.valueExpr=valueExprSchemaObjectType.toJson()},setDataUnit_schema_list_type:function(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue,argDataUnitType){this._data.type=argSourceType;this._data.uId=argSchemaId;this._data.displayName=argSchemaDisplayName;this._data.valueType=argDataUnitType;this._data.value=argSchemaDisplayName;this._data.prefix=null;this._data.unit=null;var valueExprSchemaListType=new window.CDataUnitValueExpr_schema_list_type;valueExprSchemaListType.fromParams(argDeviceId,argSchemaId,argIntfKeySchema,argIntfKeySchemaValue);this._data.valueExpr=valueExprSchemaListType.toJson()},setDataUnit_table:function(argSourceType,argDisplayName,argDeviceId,argTableType,argTableName,argVrf){this._data.type=argSourceType;this._data.uId=argTableType;this._data.displayName=argDisplayName;this._data.value=null;switch(argTableType){case window.DeviceDataType.RouteTable:case window.DeviceDataType.ArpTable:this._data.value=argDisplayName;break;case window.DeviceDataType.MacTable:this._data.value="MAC Table";break;case window.DeviceDataType.CdpTable:this._data.value="NDP Table";break;case window.DeviceDataType.StpTable:this._data.value="STP Table";break;case window.DeviceDataType.NctTable:this._data.value=argTableName}this._data.valueType=window.DataUnitType.uTable;if(argSourceType!==window.DataUnitSourceType.uSrcQapp){var valueExprTable=new window.CDataUnitValueExpr_deviceData;valueExprTable.fromParams(argDeviceId,argTableType,argTableName||"",argVrf||"");this._data.valueExpr=valueExprTable.toJson()}this._data.prefix=null;this._data.unit=null},setDataUnit_ParserTable:function(argDisplayName,argUId,argValue,argValueExpr){this._data.type=DataUnitSourceType.uSrcParserLibrary;this._data.valueType=DataUnitType.uParserTable;this._data.uId=argUId;this._data.displayName=argDisplayName;this._data.value=argValue;this._data.valueExpr=argValueExpr},setDataUnit_configFile:function(argSourceType,argDeviceId,argDisplayName){this._data.type=argSourceType;this._data.uId="config";this._data.displayName=argDisplayName;this._data.value="Config File";this._data.valueType=window.DataUnitType.uConfigFile;if(argSourceType!==window.DataUnitSourceType.uSrcQapp){var valueExprConfig=new window.CDataUnitValueExpr_deviceData;valueExprConfig.fromParams(argDeviceId,"config","",null);this._data.valueExpr=valueExprConfig.toJson()}this._data.prefix=null;this._data.unit=null},setDataUnit_label_or_hyperlink:function(argSourceType,argDisplayName,argLabel,argHyperlink){this._data.type=argSourceType;this._data.displayName=argDisplayName;this._data.uId="";this._data.value=argLabel;this._data.valueType=argHyperlink?window.DataUnitType.uHyperLink:window.DataUnitType.uString;if(argSourceType!==window.DataUnitSourceType.uSrcQapp){var valueExprLabelOrHyperlink=new window.CDataUnitValueExpr_label_or_hyperlink;valueExprLabelOrHyperlink.fromParams(argLabel,argHyperlink);this._data.valueExpr=valueExprLabelOrHyperlink.toJson()}this._data.prefix=null;this._data.unit=null},setDataUnit_formatNote:function(argSourceType,argDisplayName,argTitle,argTitleOrigText,argContent,argContentOrigText){this._data.type=argSourceType;this._data.uId="";this._data.displayName=argDisplayName;this._data.value=argTitleOrigText;this._data.valueType=window.DataUnitType.uParagraph;if(argSourceType!==window.DataUnitSourceType.uSrcQapp){var valueExprFormatNote=new window.CDataUnitValueExpr_formatNote;valueExprFormatNote.fromParams(argTitle,argTitleOrigText,argContent,argContentOrigText);this._data.valueExpr=valueExprFormatNote.toJson()}this._data.prefix=null;this._data.unit=null},setDataUnit_attachment:function(argSourceType,argDisplayName,argFileName,argFileType,argFileGuid){this._data.type=argSourceType;this._data.uId=argFileGuid;this._data.displayName=argDisplayName;this._data.value=argDisplayName;this._data.valueType=window.DataUnitType.uDoc;if(argSourceType!==window.DataUnitSourceType.uSrcQapp){var valueExprAttachment=new window.CDataUnitValueExpr_attachment;valueExprAttachment.fromParams(argFileName,argFileType,argFileGuid);this._data.valueExpr=valueExprAttachment.toJson()}this._data.prefix=null;this._data.unit=null},setDataUnit_fromQapp:function(sourceType,uId,value,valueType,prefix,unit,dataSource,displayName){this._data={type:sourceType,uId:uId,displayName:displayName,value:value,valueType:valueType,prefix:prefix,unit:unit}}};function CDataUnitValueExpr_deviceData(argJson){this._data={};argJson&&(argJson._data?this._data=argJson._data:this._data=argJson)}CDataUnitValueExpr_deviceData.prototype={constructor:CDataUnitValueExpr_deviceData,fromJson:function(argJsonData){this._data=argJsonData},fromParams:function(argDevId,argDataType,argDataName,argVrf){this._data.deviceId=argDevId;this._data.dataType=argDataType;this._data.dataName=argDataName;this._data.vrf=argVrf||""},toJson:function(){return this._data}};function CDataUnitValueExpr_schema_object_type(argJson){this._data={};argJson._data?this._data=argJson._data:this._data=argJson}CDataUnitValueExpr_schema_object_type.prototype={constructor:CDataUnitValueExpr_schema_object_type,fromJson:function(argJsonData){this._data=argJsonData},fromParams:function(argDeviceId,argSchemaId,argIntfKeySchema,argIntfKeySchemaValue){this._data.deviceId=argDeviceId;this._data.schemaId=argSchemaId;this._data.intfKeySchema=argIntfKeySchema;this._data.intfKeySchemaValue=argIntfKeySchemaValue},toJson:function(){return this._data}};function CDataUnitValueExpr_schema_list_type(argJson){this._data={};argJson&&(argJson._data?this._data=argJson._data:this._data=argJson)}CDataUnitValueExpr_schema_list_type.prototype={constructor:CDataUnitValueExpr_schema_list_type,fromJson:function(argJsonData){this._data=argJsonData},fromParams:function(argDeviceId,argSchemaId,argIntfKeySchema,argIntfKeySchemaValue){this._data.deviceId=argDeviceId;this._data.schemaId=argSchemaId;this._data.intfKeySchema=argIntfKeySchema;this._data.intfKeySchemaValue=argIntfKeySchemaValue},toJson:function(){return this._data}};function CDataUnitValueExpr_label_or_hyperlink(argJson){this._data={};argJson&&(argJson._data?this._data=argJson._data:this._data=argJson)}CDataUnitValueExpr_label_or_hyperlink.prototype={constructor:CDataUnitValueExpr_label_or_hyperlink,fromJson:function(argJsonData){this._data=argJsonData},fromParams:function(argLabel,argHyperlink){this._data.label=argLabel;this._data.hyperlink=argHyperlink},getLabel:function(){return this._data.label},getLink:function(){return this._data.hyperlink},toJson:function(){return this._data}};function CDataUnitValueExpr_formatNote(argJson){this._data={};argJson&&(argJson._data?this._data=argJson._data:this._data=argJson)}CDataUnitValueExpr_formatNote.prototype={constructor:CDataUnitValueExpr_formatNote,fromJson:function(argJsonData){this._data=argJsonData},fromParams:function(argTitle,argTitleOrigText,argContent,argContentOrigText){this._data.title=argTitle;this._data.titleOrigText=argTitleOrigText;this._data.content=argContent;this._data.contentOrigText=argContentOrigText},getTitle:function(){return this._data.title},getTitleOrigText:function(){return this._data.titleOrigText},getContent:function(){return this._data.content},getContentOrigText:function(){return this._data.contentOrigText},toJson:function(){return this._data}};function CDataUnitValueExpr_attachment(argJson){this._data={};argJson&&(argJson._data?this._data=argJson._data:this._data=argJson)}CDataUnitValueExpr_attachment.prototype={constructor:CDataUnitValueExpr_attachment,fromJson:function(argJsonData){this._data=argJsonData},fromParams:function(argFileName,argFileType,argFileGuid){this._data.name=argFileName;this._data.type=argFileType;this._data.guid=argFileGuid},getFileName:function(){return this._data.name},getFileType:function(){return this._data.type},getFileGuid:function(){return this._data.guid},toJson:function(){return this._data}};function CDataViewLabelPosInfo(posInfoJson){this.dataUnitObj=new CDataUnit;this._data={dataUnitList:[this.dataUnitObj],isCustomize:null,displayTemplate:null,isLock:null,displayInfo:null};var self=this;if(posInfoJson){var lsDataUnitObj=[];var lsDataUnitJson=posInfoJson.dataUnitList;lsDataUnitJson&&(lsDataUnitObj=lsDataUnitJson.map((function(dataUnitJson){_.isObject(dataUnitJson)&&(dataUnitJson=angular.copy(dataUnitJson));self.dataUnitObj=new CDataUnit(dataUnitJson);return self.dataUnitObj})));lsDataUnitObj&&lsDataUnitObj.length>0&&(this._data.dataUnitList=lsDataUnitObj);posInfoJson.isCustomize&&(this._data.isCustomize=posInfoJson.isCustomize);posInfoJson.displayTemplate&&(this._data.displayTemplate=posInfoJson.displayTemplate);posInfoJson.isLock&&(this._data.isLock=posInfoJson.isLock);posInfoJson.displayInfo&&(this._data.displayInfo=posInfoJson.displayInfo)}}CDataViewLabelPosInfo.prototype={constructor:CDataViewLabelPosInfo,fromJson:function(posInfoJson){this._data={dataUnitList:[new CDataUnit],isCustomize:null,displayTemplate:null,isLock:null,displayInfo:null};var lsDataUnitObj=[];var lsDataUnitJson=posInfoJson.dataUnitList;lsDataUnitJson&&(lsDataUnitObj=lsDataUnitJson.map((function(dataUnitJson){return new CDataUnit(dataUnitJson)})));this._data.dataUnitList=lsDataUnitObj;posInfoJson.isCustomize&&(this._data.isCustomize=posInfoJson.isCustomize);posInfoJson.displayTemplate&&(this._data.displayTemplate=posInfoJson.displayTemplate);posInfoJson.isLock&&(this._data.isLock=posInfoJson.isLock);posInfoJson.displayInfo&&(this._data.displayInfo=posInfoJson.displayInfo)},toJson:function(){return{dataUnitList:this._data.dataUnitList.map((function(dataUnitObj){return dataUnitObj.toJson()})),isCustomize:this.isCustomized(),displayTemplate:this.getDisplayTemplate(),isLock:this.isLocked(),displayInfo:this.getDisplayInfo()}},setData:function(data){var dataUnitData=data.dataUnitList[0];delete data.dataUnitList;this.dataUnitObj.setData(dataUnitData);_.extend(this._data,data)},getData:function(){return this._data},isEmpty:function(){return!this._data.dataUnitList||0===this._data.dataUnitList.length||this._data.dataUnitList[0].isEmpty()},isLocked:function(){return!!this._data.isLock&&this._data.isLock},setLock:function(argStatus){this._data.isLock=argStatus;this.changeCustomized(!0)},isCustomized:function(){return this._data.isCustomize},changeCustomized:function(isCustomized){this._data.isCustomize=isCustomized},getDisplayName:function(){return this._data.dataUnitList[0].getDisplayName()},setDataUnit_schema:function(argSourceType,argUId,argDisplayName,argValueType,argValue,argPrefix,argUnit){this.dataUnitObj.setDataUnit_schema(argSourceType,argUId,argDisplayName,argValueType,argValue,argPrefix,argUnit);this._data.dataUnitList=[];this._data.dataUnitList.push(this.dataUnitObj);this.changeCustomized(!0);var displayTemplate="";argPrefix&&(-1!==argPrefix.indexOf(":")?displayTemplate+=argPrefix:displayTemplate+=argPrefix+": ");displayTemplate+="$"+argDisplayName;argUnit&&(displayTemplate+=" "+argUnit);this.setDisplayTemplate(displayTemplate);var displayInfo="";_.isUndefined(argValue)&&(argValue="N/A");if(null!=argValue){argPrefix&&(-1!==argPrefix.indexOf(":")?displayInfo+=argPrefix:displayInfo+=argPrefix+": ");displayInfo+=argValue;argUnit&&(displayInfo+=" "+argUnit)}this.setDisplayInfo(displayInfo)},setDataUnit_schema_object_type:function(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue){this.dataUnitObj.setDataUnit_schema_object_type(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue);this.changeCustomized(!0);this.setDisplayInfo(this.dataUnitObj.getValue());this.setDisplayTemplate(null)},setDataUnit_schema_list_type:function(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue,argDataUnitType){this.dataUnitObj.setDataUnit_schema_list_type(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue,argDataUnitType);this.changeCustomized(!0);this.setDisplayInfo(this.dataUnitObj.getValue());this.setDisplayTemplate(null)},setDataUnit_table:function(argSourceType,argDisplayName,argDeviceId,argTableType,argTableName,argVrf){this.dataUnitObj.setDataUnit_table(argSourceType,argDisplayName,argDeviceId,argTableType,argTableName,argVrf);this.changeCustomized(!0);this.setDisplayInfo(this.dataUnitObj.getValue());this.setDisplayTemplate(null)},setDataUnit_ParserTable:function(argDisplayName,argUId,argValue,argValueExpr){var tableDataUnit=new CDataUnit;tableDataUnit.setDataUnit_ParserTable(argDisplayName,argUId,argValue,argValueExpr);this._data.dataUnitList=[];this._data.dataUnitList.push(tableDataUnit);this.changeCustomized(!0);this.setDisplayInfo(tableDataUnit.getValue());this.setDisplayTemplate(null)},setDataUnit_configFile:function(argSourceType,argDeviceId,argDisplayName){this.dataUnitObj.setDataUnit_configFile(argSourceType,argDeviceId,argDisplayName);this.changeCustomized(!0);this.setDisplayInfo(this.dataUnitObj.getValue());this.setDisplayTemplate(null)},setDataUnit_label_or_hyperlink:function(argSourceType,argDisplayName,argLabel,argLink){var hyperlinkDataUnit=new CDataUnit;hyperlinkDataUnit.setDataUnit_label_or_hyperlink(argSourceType,argDisplayName,argLabel,argLink);this._data.dataUnitList=[];this._data.dataUnitList.push(hyperlinkDataUnit);this.changeCustomized(!0);this.setDisplayInfo(hyperlinkDataUnit.getValue());this.setDisplayTemplate(null)},setDataUnit_formatNote:function(argSourceType,argDisplayName,argTitle,argTitleOrigText,argContent,argContentOrigText){this.dataUnitObj.setDataUnit_formatNote(argSourceType,argDisplayName,argTitle,argTitleOrigText,argContent,argContentOrigText);this.changeCustomized(!0);this.setDisplayInfo(this.dataUnitObj.getValue());this.setDisplayTemplate(null)},setDataUnit_attachment:function(argSourceType,argDisplayName,argFileName,argFileType,argFileGuid){this.dataUnitObj.setDataUnit_attachment(argSourceType,argDisplayName,argFileName,argFileType,argFileGuid);this.changeCustomized(!0);this.setDisplayInfo(this.dataUnitObj.getValue());this.setDisplayTemplate(null)},setDataUnit_fromQapp:function(sourceType,uId,value,valueType,prefix,unit,dataSource,displayName){var dataUnitFromQapp=new CDataUnit;dataUnitFromQapp.setDataUnit_fromQapp(sourceType,uId,value,valueType,prefix,unit,dataSource,displayName);this._data.dataUnitList=[];this._data.dataUnitList.push(dataUnitFromQapp);this.changeCustomized(!0);var displayTemplate="";prefix&&(displayTemplate+=prefix+": ");displayTemplate+=uId;unit&&(displayTemplate+=" "+unit);this.setDisplayTemplate(displayTemplate);var displayInfo="";prefix&&(-1!==prefix.indexOf(":")?displayInfo+=prefix:displayInfo+=prefix+": ");displayInfo+=value;unit&&(displayInfo+=" "+unit);if(valueType===DataUnitType.uTable||valueType===DataUnitType.uConfigFile){displayInfo=displayName;this.getDataUnits()[0].setValueExpr({dataName:"QappTable",content:value})}this.setDisplayInfo(displayInfo)},setDisplayTemplate:function(argTemplate){this._data.displayTemplate=argTemplate},getDisplayTemplate:function(){return this._data.displayTemplate},setDisplayInfo:function(argTxt){this._data.displayInfo=argTxt},getDisplayInfo:function(){return this._data.displayInfo||""},getPrefix:function(){var lsDataUnit=this._data.dataUnitList;return lsDataUnit&&0!==lsDataUnit.length?lsDataUnit[0].getPrefix():null},getValue:function(){var lsDataUnit=this._data.dataUnitList;return lsDataUnit&&0!==lsDataUnit.length?lsDataUnit[0].getValue():null},getDataUnitType:function(){var lsDataUnit=this._data.dataUnitList;return lsDataUnit&&0!==lsDataUnit.length?lsDataUnit[0].getValueType():null},getDataUnitSourceType:function(){var lsDataUnit=this._data.dataUnitList;return lsDataUnit&&0!==lsDataUnit.length?lsDataUnit[0].getSourceType():null},getDataUnits:function(){return this._data.dataUnitList}};function CDataViewLabelPosData(posJson){this._isModified=!1;this.posInfoObj=new CDataViewLabelPosInfo;this._data={dataViewId:null,posName:null,labelNote:null,tagList:null,posInfo:this.posInfoObj};if(posJson){posJson.labelGraphicInfo&&(this._data.labelGraphicInfo=posJson.labelGraphicInfo);var posInfoJson=posJson.posInfo;this._data.dataViewId=posJson.dataViewId;this.posInfoObj=this._data.posInfo=new CDataViewLabelPosInfo(posInfoJson);this._data.posName=posJson.posName;posJson.labelNote&&(this._data.labelNote=posJson.labelNote);posJson.tagList&&(this._data.tagList=posJson.tagList)}}CDataViewLabelPosData.prototype={constructor:CDataViewLabelPosData,fromJson:function(posJson){this._data={dataViewId:null,posName:null,labelNote:null,tagList:null,posInfo:new CDataViewLabelPosInfo};posJson.labelGraphicInfo&&(this._data.labelGraphicInfo=posJson.labelGraphicInfo);var posInfoJson=posJson.posInfo;this._data.dataViewId=posJson.dataViewId;this._data.posInfo=new CDataViewLabelPosInfo(posInfoJson);this._data.posName=posJson.posName;posJson.labelNote&&(this._data.labelNote=posJson.labelNote);posJson.tagList&&(this._data.tagList=posJson.tagList);this.setModified(!0)},toJson:function(){var ret={};ret.dataViewId=this.getDataViewId();ret.posName=this.getPosName();ret.posInfo=this.getPosInfo().toJson();this.getLabelNote()&&(ret.labelNote=this.getLabelNote());this.getTagList()&&(ret.tagList=this.getTagList());this._data.labelGraphicInfo&&(ret.labelGraphicInfo=this._data.labelGraphicInfo);return ret},setData:function(){},isEmpty:function(){return this._data.posInfo.isEmpty()},setEmpty:function(){this._data.labelNote=null;this._data.tagList=null;this.posInfoObj.setData({dataUnitList:[{type:null,uId:null,displayName:null,value:null,valueType:null,prefix:null,unit:null,isRefLink:null,valueExpr:null}],isCustomize:null,displayTemplate:null,isLock:null,displayInfo:null});this.setModified(!0)},setModified:function(argBool){this._isModified=argBool},isModified:function(){return this._isModified},setDataViewId:function(dataViewId){this._data.dataViewId=dataViewId},getDataViewId:function(){return this._data.dataViewId},setPosName:function(argName){this._data.posName=argName},getPosName:function(){return this._data.posName},getDisplayName:function(){return this.isEmpty()?"":this.getPosInfo().getDisplayName()},setDataUnit_schema:function(argSourceType,schemaId,argDisplayName,schemaType,argValue,argPrefix,argUnit){this._data.posInfo.setDataUnit_schema(argSourceType,schemaId,argDisplayName,schemaType,argValue,argPrefix,argUnit);this.setModified(!0);this.setLock(!0)},setDataUnit_schema_object_type:function(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue){this._data.posInfo.setDataUnit_schema_object_type(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue);this.setModified(!0);this.setLock(!0)},setDataUnit_schema_list_type:function(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue,argDataUnitType){this._data.posInfo.setDataUnit_schema_list_type(argSourceType,argDeviceId,argSchemaId,argSchemaDisplayName,argIntfKeySchema,argIntfKeySchemaValue,argDataUnitType);this.setModified(!0);this.setLock(!0)},setDataUnit_table:function(argSourceType,argDisplayName,argDeviceId,argTableType,argTableName,argVrf){this._data.posInfo.setDataUnit_table(argSourceType,argDisplayName,argDeviceId,argTableType,argTableName,argVrf);this.setModified(!0);this.setLock(!0)},setDataUnit_ParserTable:function(argDisplayName,argUId,argValue,argValueExpr){this._data.posInfo.setDataUnit_ParserTable(argDisplayName,argUId,argValue,argValueExpr);this.setModified(!0);this.setLock(!0)},setDataUnit_configFile:function(argSourceType,argDeviceId,argDisplayName){this._data.posInfo.setDataUnit_configFile(argSourceType,argDeviceId,argDisplayName);this.setModified(!0);this.setLock(!0)},setDataUnit_label_or_hyperlink:function(argSourceType,argDisplayName,argLabel,argLink){this._data.posInfo.setDataUnit_label_or_hyperlink(argSourceType,argDisplayName,argLabel,argLink);this.setModified(!0);this.setLock(!0)},setDataUnit_formatNote:function(argSourceType,argDisplayName,argTitle,argTitleOrigText,argContent,argContentOrigText){this._data.posInfo.setDataUnit_formatNote(argSourceType,argDisplayName,argTitle,argTitleOrigText,argContent,argContentOrigText);this.setModified(!0);this.setLock(!0)},setDataUnit_attachment:function(argSourceType,argDisplayName,argFileName,argFileType,argFileGuid){this._data.posInfo.setDataUnit_attachment(argSourceType,argDisplayName,argFileName,argFileType,argFileGuid);this.setModified(!0);this.setLock(!0)},setDataUnit_fromQapp:function(sourceType,uId,value,valueType,prefix,unit,dataSource,displayName){this._data.posInfo.setDataUnit_fromQapp(sourceType,uId,value,valueType,prefix,unit,dataSource,displayName);this.setModified(!0);this.setLock(!0)},setPosInfo:function(data){data.dataUnitList[0].uId=NgUtil.getGUID();data.isCustomize=!0;data.isLock=!0;this.posInfoObj.setData(data);this.setModified(!0)},setPosInfoHyperlink:function(link){this.posInfoObj.dataUnitObj.getData().link=link;var posInfo=this.posInfoObj.getData();posInfo.isCustomize=!0;posInfo.isLock=!0;this.setModified(!0)},isLocked:function(){return this._data.posInfo.isLocked()},setLock:function(argStatus){this._data.posInfo.setLock(argStatus);this.setModified(!0)},getDisplayInfo:function(){return this._data.posInfo.getDisplayInfo()},getPrefix:function(){return this._data.posInfo.getPrefix()},getValue:function(){return this._data.posInfo.getValue()},getDataUnitType:function(){return this._data.posInfo.getDataUnitType()},getDataUnitSourceType:function(){return this._data.posInfo.getDataUnitSourceType()},getDataUnits:function(){return this._data.posInfo.getDataUnits()},getLabelNote:function(){return this._data.labelNote},getTagList:function(){return this._data.tagList},getPosInfo:function(){return this._data.posInfo},getData:function(){return this._data}};!function(global){function NetMapDVInfoHelper(){this.virtualCompoundTree={global:{},map:{}};this.virtualDataViewGroupTree={global:{},map:{}};this.dataViewGroupInfos=[];this.recentDataViewInfos=[];this.applyDataViewListeners=[];this.listeners=[]}angular.extend(NetMapDVInfoHelper.prototype,{});global.NetMapDVInfoHelper=NetMapDVInfoHelper}(window);!function(netBrain){angular.module("nb.dataview").factory("nb.dataview.dataViewEditMgr",DataViewEditMgr);DataViewEditMgr.$inject=["$http","$compile","$timeout","$log","$templateCache","nb.systemmodel.deviceSchemaMgrSrvc","nb.uiframework.mainUISrvc"];function DataViewEditMgr($http,$compile,$timeout,$log,$templateCache,deviceSchemaMgrSrvc,mainUISrvc){var service={isInEditMode:_isInEditMode,canOnlySaveAsNew:_canOnlySaveAsNew,editingDataView:_editingDataView,editingDataViewDevice:_editingDataViewDevice,editingDataViewLink:_editingDataViewLink,editingDeviceList:_editingDeviceList,enableDataViewEditMode:function(scope,netmap,element){maximizeMainUI();var htmlInCache=$templateCache.get("modules/nbQmap/views/nbDataViewEditModeView.html");if(htmlInCache){var html=$compile(htmlInCache)(scope);angular.element(document.body).append(html);netmap._diagram.startTransaction("enableDataViewEditMode");netmap._diagram.updateAllTargetBindings();netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction("enableDataViewEditMode");$timeout((function(){netmap.removeAllLinkHighlightFlag()}))}else $http.get("modules/nbQmap/views/nbDataViewEditModeView.html").then((function(data){var html=$compile(data.data)(scope);angular.element(document.body).append(html);netmap._diagram.startTransaction("enableDataViewEditMode");netmap._diagram.updateAllTargetBindings();netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction("enableDataViewEditMode");$timeout((function(){netmap.removeAllLinkHighlightFlag()}))}))},disableDataViewEditMode:function(element){var ele=document.querySelector(".dataViewEditorMode");angular.element(ele).remove()},doSaveOnEditMode:function(netmap){var json=netmap.toJson();var nodeDataArray=netmap._model.nodeDataArray;var linkDataArray=netmap._model.linkDataArray;for(var i=0;i<nodeDataArray.length;i++)delete nodeDataArray[i]._netmap;for(var j=0;j<linkDataArray.length;j++)delete linkDataArray[j]._netmap;json.nodeDataArray=nodeDataArray;json.linkDataArray=linkDataArray;$timeout((function(){backupNetmap({netMapJsWrapper:json});netmap.removeAllLinkHighlightFlag()}))},doRecoverOnEditMode:function(netmap){var jsData=backupNetmap().netMapJsWrapper;if(null==jsData)return!1;netmap._diagram.startTransaction("doRecoverOnEditMode");if(null!=netmap._model){netmap._model.nodeDataArray=[];var nodeList=jsData.nodeDataArray;_.each(_clonedNodeDataList,(function(val){var n=_.findIndex(nodeList,(function(node){return node.key===val.key}));if(n>=0){var tmpLoc=nodeList[n].location;nodeList[n]=val;nodeList[n].location=tmpLoc}}));_clonedNodeDataList={};_.each(_clonedDeviceDataViewData,(function(val){var compDevice=val.device;compDevice&&(compDevice.dataViewData.intfInfoList=val.intfInfoList)}));_clonedDeviceDataViewData={};if(null!=nodeList){var newNodeList=[];for(var i=0;i<nodeList.length;i++){(temp=nodeList[i])._netmap=netmap;netBrain.Map.CompPrototypeFactory.buildCompPrototype(temp);newNodeList.push(temp)}netmap._model.addNodeDataCollection(newNodeList)}var linkList=jsData.linkDataArray;_.each(_clonedLinkDataList,(function(val){var n3=_.findIndex(linkList,(function(link){return link.intfSrc.intfInfo.intf&&val.intfSrc.intfInfo?link.intfSrc.intfInfo.intf.intfKeyObj.value===val.intfSrc.intfInfo.intf.intfKeyObj.value:-1}));n3>=0&&(linkList[n3]=val)}));_clonedLinkDataList={};if(null!=linkList){netmap._model.linkDataArray=[];var newLinkList=[];for(var k=0;k<linkList.length;k++){var temp;(temp=linkList[k])._netmap=netmap;netBrain.Map.CompPrototypeFactory.buildCompPrototype(temp);newLinkList.push(temp)}netmap._model.addLinkDataCollection(newLinkList)}if(null!=netmap._diagram){var space=netmap._netmapJsWrapper.getSpace();null!=space&&(netmap._diagram.commandHandler.space=space)}jsData.nodeDataArray=netmap._model.nodeDataArray;jsData.linkDataArray=netmap._model.linkDataArray;jsData.l2Style=netmap.isL2MapStyle();netmap._netmapJsWrapper.resetJsData(jsData)}netmap.setBackColor(netmap.getBackColor());netmap._resetDiagramReadModel();netmap.getCurrentScope().notifyHighlightChanged();netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction("doRecoverOnEditMode");return!0},doRecoverOnSaveAs:function(netmap){netmap._diagram.startTransaction("doRecoverOnEditMode");if(null!=netmap._model){var nodeArray=netmap._model.nodeDataArray;netmap._model.nodeDataArray=[];netmap._model.nodeDataArray=nodeArray;var linkArray=netmap._model.linkDataArray;netmap._model.linkDataArray=[];netmap._model.linkDataArray=linkArray}netmap.setBackColor(netmap.getBackColor());netmap._resetDiagramReadModel();netmap.getCurrentScope().notifyHighlightChanged();netmap.refreshMapViewOptionVisible();netmap._diagram.commitTransaction("doRecoverOnEditMode");netmap.removeAllLinkHighlightFlag();return!0},backupNetmap:backupNetmap,backupNodeData:function(nodeData){if(_clonedNodeDataList[nodeData.key])return;var nd=_.find(_backupNetmap.netMapJsWrapper.nodeDataArray,{key:nodeData.key});var newNodeData=angular.copy(nd);_clonedNodeDataList[nodeData.key]=newNodeData},backupLinkData:function(linkData){if(_clonedLinkDataList[linkData.intfSrc.intfInfo.intf.intfKeyObj.value])return;var ld=_.filter(_backupNetmap.netMapJsWrapper.linkDataArray,(function(d){if(d.intfSrc&&d.intfSrc.intfInfo&&d.intfSrc.intfInfo.intf)return d.intfSrc.intfInfo.intf.intfKeyObj.value===linkData.intfSrc.intfInfo.intf.intfKeyObj.value}));if(ld=ld.length>0?ld[0]:void 0){var newLinkData=angular.copy(ld);_clonedLinkDataList[linkData.intfSrc.intfInfo.intf.intfKeyObj.value]=newLinkData}},backupDeviceDataViewData:function(compDevice){if(!compDevice)return;if(_clonedDeviceDataViewData[compDevice.key])return;_clonedDeviceDataViewData[compDevice.key]={device:compDevice,intfInfoList:angular.copy(compDevice.dataViewData.intfInfoList)}},addToUpdatedDevPosList:function(argDevObj){_lsUpdatedDevicePosList||(_lsUpdatedDevicePosList=[]);for(var i=0;i<_lsUpdatedDevicePosList.length;i++)if(_lsUpdatedDevicePosList[i].deviceId===argDevObj.deviceId&&_lsUpdatedDevicePosList[i].dataViewGroupId===argDevObj.dataViewGroupId&&(_lsUpdatedDevicePosList[i].dataViewTaskInfoId=argDevObj.dataViewTaskInfoId)){_lsUpdatedDevicePosList.splice(i,1);break}_lsUpdatedDevicePosList.push(argDevObj)},getUpdatedDevicePosList:function(){return _lsUpdatedDevicePosList},addToUpdatedIntfPosList:function(argIntfPosList){_lsUpdatedIntfsPosList||(_lsUpdatedIntfsPosList=[]);for(var i=0;i<_lsUpdatedIntfsPosList.length;i++)if(_lsUpdatedIntfsPosList[i].deviceId===argIntfPosList.deviceId&&_lsUpdatedIntfsPosList[i].dataViewGroupId===argIntfPosList.dataViewGroupId&&_lsUpdatedIntfsPosList[i].intfKeyObj.schema===argIntfPosList.intfKeyObj.schema&&_lsUpdatedIntfsPosList[i].intfKeyObj.value===argIntfPosList.intfKeyObj.value){_lsUpdatedIntfsPosList.splice(i,1);break}_lsUpdatedIntfsPosList.push(argIntfPosList)},getUpdatedIntfPosList:function(){return _lsUpdatedIntfsPosList},clearUpdatedPosLists:function(){_lsUpdatedDevicePosList=null;_lsUpdatedIntfsPosList=null;_backupEditingDeviceDataViewNotes={};_backupEditingIntfDataViewNotes={};!function(){_clonedNodeDataList={};_clonedLinkDataList={};_clonedDeviceDataViewData={}}()},compareDataViewName:function(a,b){if(a.name.toUpperCase()<b.name.toUpperCase())return-1;if(a.name.toUpperCase()>b.name.toUpperCase())return 1;return 0},maximizeMainUI:maximizeMainUI,isLegacyNodeSchema:function(schema){var bResult=null!=schema&&0==schema.indexOf(NetBrain.Common.Const.LegacySchema.Legacy);if(!bResult){deviceSchemaMgrSrvc.getSchemaObjByKey(schema)&&(bResult=!0)}return bResult},prepareEditDataviewParams:function(diagram){var ptConvert=diagram.transformDocToView(diagram.firstInput.documentPoint);var clickXPos=ptConvert.x;var clickYPos=ptConvert.y;var vpBounds=diagram.viewportBounds;var vpHeight=vpBounds.height;var vpWidth=vpBounds.width;var targetPos={x:clickXPos,y:clickYPos};vpWidth-clickXPos<450&&(targetPos.x-=450-(vpWidth-clickXPos));vpHeight-clickYPos<550&&(targetPos.y-=550-(vpHeight-clickYPos));return targetPos},updatePosListSuccessCallback:function(netmap,lsDevs,lsLinks){if(lsDevs){var devIds=_.pluck(lsDevs,"deviceId");netmap.enableNodes(devIds)}if(lsLinks){var linkInfoObj={};_.each(lsLinks,(function(info){var deviceId=info.deviceId;var arr=linkInfoObj[deviceId]||[];arr.push(info.intf.intfKeyObj.value);linkInfoObj[deviceId]=arr}));_.each(linkInfoObj,(function(intfValues,deviceId){netmap.enableLinksByDeviceIdAndIntfs(deviceId,intfValues)}))}},setBackupEditingDeviceDataViewNotes:function(notes){var backNotes=angular.copy(notes);_backupEditingDeviceDataViewNotes=backNotes},getBackupEditingDeviceDataViewNotes:function(){return _backupEditingDeviceDataViewNotes},setBackupEditingIntfDataViewNotes:function(notes){var backNotes=angular.copy(notes);_backupEditingIntfDataViewNotes=backNotes},getBackupEditingIntfDataViewNotes:function(){return _backupEditingIntfDataViewNotes},setIntfPosListChangeState:function(bool){_intfPosListChanged=bool},getIntfPosListChangeState:function(){return _intfPosListChanged}};var _isInEditMode=!1;var _canOnlySaveAsNew=!1;var _editingDataView=null;var _editingDataViewDevice=null;var _editingDataViewLink=null;var _backupNetmap={};var _editingDeviceList=[];var _lsUpdatedDevicePosList=null;var _lsUpdatedIntfsPosList=null;var _clonedNodeDataList={};var _clonedLinkDataList={};var _clonedDeviceDataViewData={};var _backupEditingIntfDataViewNotes={};var _backupEditingDeviceDataViewNotes={};var _intfPosListChanged=!1;function maximizeMainUI(){mainUISrvc.maximizeMainUI("map")}function backupNetmap(newNetmapData){if(!newNetmapData)return _backupNetmap;_backupNetmap=newNetmapData}return service}}(NetBrain);!function(netBrain){angular.module("nb.dataview").factory("nb.dataview.dataViewInfoMgr",DataViewInfoMgr);DataViewInfoMgr.$inject=["$q","$timeout","nb.dataview.httpDataViewInfoMgrSrvc","nb.qmap.mapManagerSrvc","nb.netbrain.dataViewCacheSrvc","nb.runbook.actionTaskForDataViewSrvc","nb.common.nbAlertSrvc","nb.dataview.applyDataViewSrvc"];function DataViewInfoMgr($q,$timeout,httpDataViewInfoMgrSrvc,mapManagerSrvc,dataViewCacheSrvc,actionTaskForDataViewSrvc,nbAlertSrvc,applyDataViewSrvc){function applyDataViewInfo(page,type,dvgId,devId,activeDvgId,isForceApply,isIgnoreOthers,dataViewGroupInfo){var deferred=$q.defer();var netmapOperator=page.getNetmapOperator();page.dataViewInfo||deferred.reject();var dataViewGroupInfos=page.dataViewInfo.dataViewGroupInfos;dataViewGroupInfos.length<=0&&(dataViewGroupInfos=[dataViewGroupInfo]);var applyInfoObj=getApplyDataViewInfoObj(type,dvgId,dataViewGroupInfos,activeDvgId);if("compoundDVApply"===applyInfoObj.applyType){_.find(applyInfoObj.compoundDataViewInfo.dataViewGroupList,{isSelected:!0})||(applyInfoObj.compoundDataViewInfo.dataViewGroupList[0].isSelected=!0)}var promise=netmapOperator.applyDataView(dataViewCacheSrvc,applyInfoObj,devId,isForceApply,isIgnoreOthers,applyDataViewSrvc);null!=promise&&promise.then((function(){deferred.resolve()}),(function(){deferred.reject()}));return deferred.promise}function getApplyDataViewInfoObj(type,dvgId,dvgInfos,activeDvgId){var applyInfoObj=new ApplyDataViewInfo;switch(type){case"multiple":case"single":var dvg=_.findWhere(dvgInfos,{ID:dvgId});if(dvg){var dataViewInfo=new DataViewGroupInfo;dataViewInfo.setDataViewGroupId(dvg.ID);dataViewInfo.setName(dvg.name);dataViewInfo.setPath(dvg.path||"");var newDvg=angular.copy(dvg);dataViewInfo.setDataViewGroup(newDvg);applyInfoObj.setDataViewInfo(dataViewInfo);applyInfoObj.setApplyType(DataViewApplyType.dvgApply)}else nbAlertSrvc.warning({message:"The data view doesn't exist anymore."});break;case"compound":var compoundObj={};var finded=!1;_.each(dvgInfos,(function(item){var matchCompound=_.findWhere(item.relatedCompoundDataViews,{ID:dvgId});if(matchCompound){if(!finded){compoundObj.name=matchCompound.name;compoundObj.compoundDataViewId=matchCompound.ID;compoundObj.dataViewGroupList=[];finded=!0}compoundObj.dataViewGroupList.push({dataViewGroupId:item.ID,name:item.name,path:"",isDefault:item.ID===matchCompound.defaultDataViewGroup,isSelected:void 0===activeDvgId?item.ID===matchCompound.defaultDataViewGroup:item.ID===activeDvgId})}}));applyInfoObj.setCompoundDataViewInfo(compoundObj);applyInfoObj.setApplyType(DataViewApplyType.compoundDVApply)}return applyInfoObj}function notifyApplyDataViewListener(netmap,isRemoved,callbackFn){netmap&&netmap.dataViewInfo&&(callbackFn?$timeout((function(){callbackFn(isRemoved)})):angular.forEach(netmap.dataViewInfo.applyDataViewListeners,(function(listener,index){$timeout((function(){listener.callbackFn(isRemoved)}))})));netmap&&netmap._netmapOperator&&netmap._netmapOperator.getAppliedDynamicDataViewGroupList().length>0&&(netmap._cmdTarget._scope.viewDataFlag=!0)}function notifyListener(listenerFn,netmap){if(netmap){var data=netmap.dataViewInfo.dataViewGroupInfos;var recentData=netmap.dataViewInfo.recentDataViewInfos;"function"==typeof listenerFn?listenerFn(data,recentData):angular.forEach(netmap.dataViewInfo.listeners,(function(item){"function"==typeof item.callbackFn&&$timeout((function(){item.callbackFn(data,recentData)}))}))}}return{applyDataViewInfo:applyDataViewInfo,applyDataViewInfoByDataView:function(page,type,dataview){_.find(page.dataViewInfo.dataViewGroupInfos,{ID:dataview.ID})||page.dataViewInfo.dataViewGroupInfos.push(dataview);return applyDataViewInfo(page,type,dataview.ID,null,null,!0,!1)},addRecentDataView:function(dataViewObj,netmap){if(netmap&&netmap.dataViewInfo){var recentDataViewInfos=netmap.dataViewInfo.recentDataViewInfos;var ix=-1;_.filter(recentDataViewInfos,(function(v,k){if(v.name===dataViewObj.name){if((!dataViewObj.path||""===dataViewObj.path.trim())&&dataViewObj.ID===v.ID){ix=k;return!0}var spath=""===v.path?" ":v.path||v.dataViewGroup.path||" ";var dpath=dataViewObj.path&&""!==dataViewObj.path.trim()&&(dataViewObj.path||dataViewObj.dataViewGroup.path)||" ";if(spath.replace(/>/g,"").trim()===dpath.replace(/>/g,"").trim()){ix=k;return!0}}return!1}));ix>=0&&netmap.dataViewInfo.recentDataViewInfos.splice(ix,1);var recentDataView=angular.copy(dataViewObj);recentDataViewInfos.unshift(recentDataView);recentDataViewInfos.length>4&&(recentDataViewInfos.length=4);notifyListener(null,netmap)}},getVirtualCompoundTree:function(netmap){return netmap&&netmap.dataViewInfo?netmap.dataViewInfo.virtualCompoundTree:null},unRegisterMapDataViewInfos:function(netmap){netmap&&netmap.dataViewInfo&&delete netmap.dataViewInfo},registerListener:function(netmap,scopeId,callbackFn){if(netmap&&netmap.dataViewInfo){var isExsited=!1;angular.forEach(netmap.dataViewInfo.listeners,(function(item){if(item.scopeId===scopeId){item.callbackFn=callbackFn;isExsited=!0}}));isExsited||netmap.dataViewInfo.listeners.push({scopeId:scopeId,callbackFn:callbackFn});notifyListener(callbackFn,netmap)}},unRegisterListener:function(netmap,scopeId){netmap&&netmap.dataViewInfo&&angular.forEach(netmap.dataViewInfo.listeners,(function(item,index){item.scopeId===scopeId&&netmap.dataViewInfo.listeners.splice(index,1)}))},unRegisterApplyDataViewListener:function(netmap,scopeId){netmap&&netmap.dataViewInfo&&angular.forEach(netmap.dataViewInfo.applyDataViewListeners,(function(item,index){item.scopeId===scopeId&&netmap.dataViewInfo.applyDataViewListeners.splice(index,1)}))},registerApplyDataViewListener:function(netmap,scopeId,callbackFn){if(netmap&&netmap.dataViewInfo){var isExsited=!1;angular.forEach(netmap.dataViewInfo.applyDataViewListeners,(function(item){if(item.scopeId===scopeId){item.callbackFn=callbackFn;isExsited=!0}}));isExsited||netmap.dataViewInfo.applyDataViewListeners.push({scopeId:scopeId,callbackFn:callbackFn});notifyApplyDataViewListener(netmap,null,callbackFn)}},notifyApplyDataViewListener:notifyApplyDataViewListener,notifyListener:notifyListener,applyDataViewInfoForSingle:function(page,type,dvgId,devId,devDvgList,activeDvgId,isForceApply,isIgnoreOthers){var deferred=$q.defer();var netmapOperator=page.getNetmapOperator();page.dataViewInfo||deferred.reject();var applyInfoObj=getApplyDataViewInfoObj(type,dvgId,devDvgList,activeDvgId);var promise=netmapOperator.applyDataView(dataViewCacheSrvc,applyInfoObj,devId,isForceApply,isIgnoreOthers,applyDataViewSrvc);null!=promise&&promise.then((function(){deferred.resolve()}),(function(){deferred.reject()}));return deferred.promise},applyDataViewGroup:function(page,dvgId,isForceApply,time){page.getNetmapOperator().applyDataViewGroup(dataViewCacheSrvc,dvgId,isForceApply,time)}}}}(NetBrain);var DefaultDataViewInfo={defaultDevTemplateId:"00000000-0000-0000-0000-000000000000",defaultDevDVGId:"00000000-0000-0000-0000-000000000000",defaultDevTaskInfId:"00000000-0000-0000-0000-000000000000"};var DataViewGroupScope={dvgScopeGlobal:"dvgScopeGlobal",dvgScopeMap:"dvgScopeMap",dvgScopeALog:"dvgScopeALog"};var CompoundDataViewGroupScope={cdvgScopeGlobal:"cdvgScopeGlobal",cdvgScopeMap:"cdvgScopeMap"};var DataViewType={dvDynamic:"dvDynamic",dvStatic:"dvStatic",dvManual:"dvManual",dvDefault:"dvDefault",dvGraphic:"dvGraphic",dvTemporary:"dvTemporary",dvTemplate:"dvTemplate"};var DataViewGroupStatus={dvgStatusShareWithMap:"dvgStatusShareWithMap"};var TmplDataSourceType={tmplSrcSystemDefault:"tmplSrcSystemDefault",tmplSrcQapp:"tmplSrcQapp"};var DataUnitSourceType={uSrcGDR:"uSrcGDR",uSrcQapp:"uSrcQapp",uSrcCustomized:"uSrcCustomized",uSrcParserLibrary:"uSrcParserLibrary",uSrcDeviceData:"uSrcDeviceData",uSrcAPI:"uSrcAPI",uSrcInputVar:"uSrcInputVar",uSrcCompoundVar:"uSrcCompoundVar"};var DataUnitBelongTo={devLevel:"devLevel",intfLevel:"intfLevel"};var DataUnitType={uString:"uString",uFloat:"uFloat",uBool:"uBool",uInt:"uInt",uParagraph:"uParagraph",uConfigLet:"uConfigLet",uTable:"uTable",uObject:"uObject",uList_primitive_subtype:"uList_primitive_subtype",uList_object_subtype:"uList_object_subtype",uConfigFile:"uConfigFile",uHyperLink:"uHyperLink",uDoc:"uDoc",uCompoundVar:"uCompoundVar",uPercent:"uPercent",uParserTable:"uParserTable",uList:"uList"};var DataUnitTypeHelper={canEditDataUnit:function(duType){var canEditList=[DataUnitType.uParagraph,DataUnitType.uDoc,DataUnitType.uString,DataUnitType.uBool,DataUnitType.uInt,DataUnitType.uFloat];return!DataUnitType[duType]||_.contains(canEditList,duType)}};var DataViewApplyType={dvgApply:"dvgApply",compoundDVApply:"compoundDVApply"};var DataUnitDisplayTmplPrefix={prefix:"$"};var DataViewPosName={devPos1:"devPos1",devPos2:"devPos2",devPos3:"devPos3",devPos4:"devPos4",overflowPos:"overflowPos",otherDrawShapes:"otherDrawShapes",intfPos0:"intfPos0",intfPos1:"intfPos1",intfPos2:"intfPos2",intfPos3:"intfPos3",intfPos4:"intfPos4",intfPos5:"intfPos5",intfPos6:"intfPos6",intfPos7:"intfPos7",intfPos8:"intfPos8",overflowPos1:"overflowPos1",overflowPos2:"overflowPos2",overflowPos3:"overflowPos3",overflowPos4:"overflowPos4",overflowPos5:"overflowPos5",overflowPos6:"overflowPos6",overflowPos7:"overflowPos7",overflowPos8:"overflowPos8",overflowPos9:"overflowPos9",overflowPos10:"overflowPos10",overflowPos11:"overflowPos11",overflowPos12:"overflowPos12",overflowPos13:"overflowPos13",overflowPos14:"overflowPos14",overflowPos15:"overflowPos15",overflowPos16:"overflowPos16",overflowPos17:"overflowPos17",overflowPos18:"overflowPos18",overflowPos19:"overflowPos19",overflowPos20:"overflowPos20"};var DataViewNodeType={Folder:0,Leaf:1};var DataViewTreeType={GlobalDataView:"GlobalDataView",MapDataView:"MapDataView",ALog:"ALog",Unknown:"Unknown"};var DataUnitAlarm={unknown:-1,normal:0,warning:1,error:2};var DataViewGroupSource={dvgSrcBenchmarkQapp:"Qapp Operation",dvgSrcBenchmarkTemplate:"Run Data View Template",dvgSrcManual:"Manual"};function DataViewsSegment(){}DataViewsSegment.prototype=new DataViewsSegment;DataViewsSegment.prototype.isValid=function(){return null!=this.devDataViewSegmentList&&this.devDataViewSegmentList.length>0||null!=this.intfDataViewSegmentList&&this.intfDataViewSegmentList.length>0};DataViewsSegment.prototype.getDevDataViewSegmentList=function(){return this.devDataViewSegmentList};DataViewsSegment.prototype.getDevSegmentDevId=function(devDataViewSegment){return null==devDataViewSegment?null:devDataViewSegment.devId};DataViewsSegment.prototype.getDevSegmentDevDataView=function(devDataViewSegment){return null==devDataViewSegment?null:devDataViewSegment.devDataView};DataViewsSegment.prototype.getDevSegmentDevDataViewByDevId=function(devId){if(null==devId)return devId;if(null==this.devDataViewSegmentList)return null;for(var i=0;i<this.devDataViewSegmentList.length;i++){var devDataViewSegment=this.devDataViewSegmentList[i];if(devDataViewSegment.devId===devId)return devDataViewSegment.devDataView}return null};DataViewsSegment.prototype.addDev=function(devId,ptLocation,isMPLSCloud,devNodeData){if(null==devId)return devId;null==this.devDataViewSegmentList&&(this.devDataViewSegmentList=[]);for(var i=0;i<this.devDataViewSegmentList.length;i++){if(this.devDataViewSegmentList[i].devId===devId)return}var devObj={devId:devId,ptLocation:ptLocation,isMPLSCloud:isMPLSCloud,devNodeData:devNodeData};this.devDataViewSegmentList.push(devObj);return null};DataViewsSegment.prototype.getIntfDataViewSegmentList=function(){return this.intfDataViewSegmentList};DataViewsSegment.prototype.getIntfSegmentIntfDataViewSegment=function(devId,intfKey,topoType){if(null==this.intfDataViewSegmentList)return null;if(null==devId||null==intfKey||null==topoType)return null;if(null==this.intfDataViewSegmentList)return null;for(var i=0;i<this.intfDataViewSegmentList.length;i++){var intfDataViewSegment=this.intfDataViewSegmentList[i];if(intfDataViewSegment.devId===devId&&intfDataViewSegment.topoType===topoType&&null!=intfDataViewSegment.intfKey&&intfDataViewSegment.intfKey.value===intfKey.value&&intfDataViewSegment.intfKey.schema===intfKey.schema)return intfDataViewSegment}return null};DataViewsSegment.prototype.getIntfSegmentDevId=function(intfDataViewSegment){return null==intfDataViewSegment?null:intfDataViewSegment.devId};DataViewsSegment.prototype.getIntfSegmentIntfKey=function(intfDataViewSegment){return null==intfDataViewSegment?null:intfDataViewSegment.intfKey};DataViewsSegment.prototype.getIntfSegmentIntfKeySchema=function(intfDataViewSegment){return null==intfDataViewSegment||null==intfDataViewSegment.intfKey?null:intfDataViewSegment.intfKey.schema};DataViewsSegment.prototype.getIntfSegmentIntfKeyValue=function(intfDataViewSegment){return null==intfDataViewSegment||null==intfDataViewSegment.intfKey?null:intfDataViewSegment.intfKey.value};DataViewsSegment.prototype.getIntfSegmentIntfTopoType=function(intfDataViewSegment){return null==intfDataViewSegment?null:intfDataViewSegment.topoType};DataViewsSegment.prototype.getIntfSegmentIntfDataView=function(intfDataViewSegment){return null==intfDataViewSegment?null:intfDataViewSegment.intfDataView};DataViewsSegment.prototype.getIntfSegmentIntfDataViewInfo=function(intfDataViewSegment){return null==intfDataViewSegment||null==intfDataViewSegment.intfDataView?null:intfDataViewSegment.intfDataView.dataViewInfo};DataViewsSegment.prototype.getIntfSegmentIntfInfo=function(intfDataViewSegment){return null==intfDataViewSegment||null==intfDataViewSegment.intfDataView?null:intfDataViewSegment.intfDataView.intfInfo};DataViewsSegment.prototype.addIntf=function(devId,intfKey,topoType,intfNodeData){if(null==devId||null==intfKey||null==topoType)return null;null==this.intfDataViewSegmentList&&(this.intfDataViewSegmentList=[]);for(var i=0;i<this.intfDataViewSegmentList.length;i++){var intfDataViewSegment=this.intfDataViewSegmentList[i];if(intfDataViewSegment.devId==devId&&intfDataViewSegment.topoType==topoType&&null!=intfDataViewSegment.intfKey&&intfDataViewSegment.intfKey.value==intfKey.value&&intfDataViewSegment.intfKey.schema===intfKey.schema&&(null==intfDataViewSegment.intfNodeData||null==intfDataViewSegment.intfNodeData.visualSpaceInfo&&null==intfNodeData.visualSpaceInfo||intfDataViewSegment.intfNodeData.visualSpaceInfo.visualSpaceInstanceId==intfNodeData.visualSpaceInfo.visualSpaceInstanceId))return}var intfObj={devId:devId,intfKey:intfKey,topoType:topoType,intfNodeData:intfNodeData};this.intfDataViewSegmentList.push(intfObj);return null};function folderMgr(){this._tree={};this._list=[];this._crumb=[]}folderMgr.prototype={constructor:folderMgr,setNodeScope:function(node,scope){node.selected=!1;node.menuSelected=!1;node.editMode=!1;node.systemFolder?Array.isArray(scope.treeActionMenu)&&scope.treeActionMenu.length>0&&(node.treeActionMenu=[scope.treeActionMenu[0]]):node.treeActionMenu||(node.treeActionMenu=scope.treeActionMenu);node.selectMenu||(node.selectMenu=scope.selectMenu);node.selectAction||(node.selectAction=scope.selectAction);node.renameFolder=scope.renameFolder;scope.treeLeafActions&&!node.treeLeafActions&&(node.treeLeafActions=scope.treeLeafActions);scope.selectLeafAction&&(node.selectLeafAction=scope.selectLeafAction)},resetData:function(tree){if(tree){tree.selected=!1;this._tree=tree;tree.editMode=!1;this._crumb=[];this._crumb.push(tree)}},getSelectNodeList:function(){return this._list},openTreeNodes:function(node){if(node.ID){var selectedNode=null;!function myself(node,traverseNode){traverseNode.show=!0;if(node.ID===traverseNode.ID){traverseNode.selected=!0;selectedNode=traverseNode;return!0}angular.forEach(traverseNode.child,(function(child){if(!0===myself(node,child)){traverseNode.show=!0;return!0}}))}(node,this._tree);this.setSelectedList(selectedNode)}},updateBrowseFolder:function(folderId,nodes){if(folderId){var selectedNode;!function myself(folderId,traverseNode,nodes){if(folderId===traverseNode.ID){traverseNode.child=[];traverseNode.child=nodes;traverseNode.selected=!0;traverseNode.show=!0;selectedNode=traverseNode;return!0}traverseNode.selected=!1;angular.forEach(traverseNode.child,(function(child,key){myself(folderId,child,nodes)}))}(folderId,this._tree,nodes);this.setSelectedList(selectedNode)}},renameBrowseFolder:function(parentFolderId,folderId,newName){if(folderId){var parentFolder;!function myself(parentFolderId,folderId,newName,traverseNode){if(folderId===traverseNode.ID){traverseNode.name=newName;return!0}angular.forEach(traverseNode.child,(function(child,key){!0!==myself(parentFolderId,folderId,newName,child)||(parentFolder=traverseNode)}))}(parentFolderId,folderId,newName,this._tree);this.setSelectedList(parentFolder)}},deleteBrowseNode:function(nodeId){if(nodeId){var selectedNode;!function myself(nodeId,traverseNode){if(nodeId===traverseNode.ID)return!0;angular.forEach(traverseNode.child,(function(child,key){if(!0===myself(nodeId,child)){traverseNode.child.splice(key,1);selectedNode=traverseNode}return!1}))}(nodeId,this._tree);this.setSelectedList(selectedNode)}},getTreeParentNode:function(nodeId){if(nodeId){var parentNode=null;!function myself(nodeId,traverseNode){if(nodeId===traverseNode.ID)return!0;angular.forEach(traverseNode.child,(function(child){!0===myself(nodeId,child)&&(parentNode=traverseNode);return!1}))}(nodeId,this._tree);return parentNode}},getTreeNode:function(nodeId){if(nodeId){var node=null;!function myself(nodeId,traverseNode){if(nodeId===traverseNode.ID){node=traverseNode;return!0}angular.forEach(traverseNode.child,(function(child){if(!0===myself(nodeId,child))return!0}))}(nodeId,this._tree);return node}},getTreeNodeByDocId:function(docId){if(docId){var node=null;!function myself(docId,traverseNode){if(docId===traverseNode.docId){node=traverseNode;return!0}angular.forEach(traverseNode.child,(function(child){if(!0===myself(docId,child))return!0}))}(docId,this._tree);return node}},checkValidFolder:function(nodeId){var selectedNode=this.getTreeNodeById(nodeId);if(selectedNode)return!selectedNode.systemFolder},checkNetBrainFolder:function(nodeId){var selectedNode=this.getTreeNodeById(nodeId);if(selectedNode)return"NetBrain"===selectedNode.name},getTreeNodeById:function(nodeId){if(nodeId){var selectedNode=null;!function myself(nodeId,traverseNode){if(nodeId===traverseNode.ID){selectedNode=traverseNode;return!0}var found=!1;angular.forEach(traverseNode.child,(function(child){!0===myself(nodeId,child)&&(found=!0)}));if(!0===found)return!0}(nodeId,this._tree);return selectedNode}},getChildNodeIds:function(folderId){var idList=[];var folder=this.getTreeNodeById(folderId);folder.child&&angular.forEach(folder.child,(function(child){idList.push(child.ID)}));return idList},setSelectedList:function(selectedNode){this._list=[];angular.forEach(selectedNode.child,(function(node){this.push(node)}),this._list)},unselectAllTreeNodes:function myself(traverseNode){traverseNode.selected=!1;angular.forEach(traverseNode.child,(function(child){traverseNode.selected=!1;myself(child)}));traverseNode.selected=!1},getSelectedNodeInTree:function(){var selectedNode;!function myself(traverseNode){if(!0===traverseNode.selected){selectedNode=traverseNode;return!0}angular.forEach(traverseNode.child,(function(child){if(!0===myself(child))return!0}))}(this._tree);return selectedNode},setSelectNodeTreeById:function(selectedNodeId){if(selectedNodeId){var selectedNode=null;this._crumb=[];!function myself(selectedNodeId,traverseNode,crumb){if(selectedNodeId===traverseNode.ID){traverseNode.selected=!0;crumb.splice(0,0,traverseNode);selectedNode=traverseNode;return!0}var found=!1;angular.forEach(traverseNode.child,(function(child){if(!0===myself(selectedNodeId,child,crumb)){child.show=!0;found=!0}}));if(!0===found){crumb.splice(0,0,traverseNode);return!0}}(selectedNodeId,this._tree,this._crumb);this.setSelectedList(selectedNode)}},setSelectNodeTree:function(selectedNode){null!=selectedNode&&this.setSelectNodeTreeById(selectedNode.ID)},setSelectNodeList:function(selectedNode){if(selectedNode){this.unselectAllTreeNodes(this._tree);this.setSelectedList(selectedNode);this._crumb=[];!function myself(selectedNode,traverseNode,crumb){if(selectedNode===traverseNode){traverseNode.selected=!0;traverseNode.show=!traverseNode.show;crumb.splice(0,0,traverseNode);return!0}var found=!1;angular.forEach(traverseNode.child,(function(child){if(!0===myself(selectedNode,child,crumb)){traverseNode.show=!0;found=!0}}));if(!0===found){crumb.splice(0,0,traverseNode);return!0}}(selectedNode,this._tree,this._crumb)}},setSelectNodeListForTree:function(selectedNode){if(selectedNode){this.unselectAllTreeNodes(this._tree);this.setSelectedList(selectedNode);this._crumb=[];!function traverseTreeChildren(selectedNode,traverseNode){if(selectedNode===traverseNode){traverseNode.selected=!0;traverseNode.show=!traverseNode.show;return!0}var found=!1;angular.forEach(traverseNode.child,(function(child){if(!0===traverseTreeChildren(selectedNode,child)){traverseNode.show=!0;found=!0}}));if(!0===found)return!0}(selectedNode,this._tree)}},getTree:function(){return this._tree},getCrumb:function(){return this._crumb}};function MediaInfosSegment(){}MediaInfosSegment.prototype.getMediaInfoById=function(mediaId){if(null==mediaId)return null;if(null==this.mediaInfosSegmentList)return null;for(var i=0;i<this.mediaInfosSegmentList.length;i++){var mediaInfosSegment=this.mediaInfosSegmentList[i];if(mediaInfosSegment.ID===mediaId)return mediaInfosSegment}return null};function ApplyDataViewInfo(){}ApplyDataViewInfo.prototype=new ApplyDataViewInfo;ApplyDataViewInfo.prototype.getApplyType=function(){return this.applyType};ApplyDataViewInfo.prototype.setApplyType=function(obj){this.applyType=obj};ApplyDataViewInfo.prototype.getDataViewInfo=function(){return this.dataViewInfo};ApplyDataViewInfo.prototype.setDataViewInfo=function(obj){this.dataViewInfo=obj};ApplyDataViewInfo.prototype.getDataViewGroupId=function(){return null==this.dataViewInfo?null:this.dataViewInfo.dataViewGroupId};ApplyDataViewInfo.prototype.getCompoundDataViewInfo=function(){return this.compoundDataViewInfo};ApplyDataViewInfo.prototype.setCompoundDataViewInfo=function(obj){this.compoundDataViewInfo=obj};ApplyDataViewInfo.prototype.getDataViewGroupList=function(){return null==this.compoundDataViewInfo?null:this.compoundDataViewInfo.dataViewGroupList};ApplyDataViewInfo.prototype.setDataViewGroupList=function(obj){if(null!=obj){null==this.compoundDataViewInfo&&(this.compoundDataViewInfo={dataViewGroupList:obj});this.compoundDataViewInfo.dataViewGroupList=obj}};ApplyDataViewInfo.prototype.addDataViewGroupInfo=function(obj){if(null!=obj){null==this.compoundDataViewInfo&&(this.compoundDataViewInfo={dataViewGroupList:[obj]});this.compoundDataViewInfo.dataViewGroupList.push(obj)}};ApplyDataViewInfo.prototype.removeDataViewGroupInfo=function(obj){if(null!=obj&&null!=this.compoundDataViewInfo)for(var i=0;i<this.compoundDataViewInfo.dataViewGroupList.length;i++){if(this.compoundDataViewInfo.dataViewGroupList[i].dataViewGroupId===obj.obdataViewGroupIdj){this.compoundDataViewInfo.dataViewGroupList.splice(i,1);return}}};ApplyDataViewInfo.prototype.getCompoundDataViewId=function(){return null==this.compoundDataViewInfo?null:this.compoundDataViewInfo.compoundDataViewId};ApplyDataViewInfo.prototype.getCompoundDataViewName=function(){return null==this.compoundDataViewInfo?null:this.compoundDataViewInfo.name};ApplyDataViewInfo.prototype.getSelectedDataView=function(){if(null==this.compoundDataViewInfo)return null;if(null==this.compoundDataViewInfo.dataViewGroupList)return null;for(var i=0;i<this.compoundDataViewInfo.dataViewGroupList.length;i++){var dataViewGroupInfo=this.compoundDataViewInfo.dataViewGroupList[i];if(dataViewGroupInfo.isSelected)return dataViewGroupInfo}return null};ApplyDataViewInfo.prototype.getSelectedDataViewId=function(){if(null==this.compoundDataViewInfo)return null;if(null==this.compoundDataViewInfo.dataViewGroupList)return null;for(var i=0;i<this.compoundDataViewInfo.dataViewGroupList.length;i++){var dataViewGroupInfo=this.compoundDataViewInfo.dataViewGroupList[i];if(dataViewGroupInfo.isSelected)return dataViewGroupInfo.dataViewGroupId}return null};function DataViewGroupInfo(){}DataViewGroupInfo.prototype=new DataViewGroupInfo;DataViewGroupInfo.prototype.getDataViewGroupId=function(){return this.dataViewGroupId};DataViewGroupInfo.prototype.setDataViewGroupId=function(obj){this.dataViewGroupId=obj};DataViewGroupInfo.prototype.getName=function(){return this.name};DataViewGroupInfo.prototype.setName=function(obj){this.name=obj};DataViewGroupInfo.prototype.getPath=function(){return this.path};DataViewGroupInfo.prototype.setPath=function(obj){this.path=obj};DataViewGroupInfo.prototype.getIsDefault=function(){return this.isDefault};DataViewGroupInfo.prototype.setIsDefault=function(obj){this.isDefault=obj};DataViewGroupInfo.prototype.getIsSelected=function(){return this.isSelected};DataViewGroupInfo.prototype.setIsSelected=function(obj){this.isSelected=obj};DataViewGroupInfo.prototype.getDataViewGroup=function(){return this.dataViewGroup};DataViewGroupInfo.prototype.setDataViewGroup=function(obj){this.dataViewGroup=obj};!function(netBrain){function MapNoteCondition(name){this.name=name;this.noteInfo={title:"",content:"",isCompound:!1};this.renamable=!1}MapNoteCondition.prototype.getName=function(){return this.name};MapNoteCondition.prototype.setName=function(name){this.name=name};MapNoteCondition.prototype.getNoteInfo=function(){return this.noteInfo};MapNoteCondition.prototype.setNoteInfo=function(noteInfo){this.noteInfo=noteInfo};MapNoteCondition.prototype.toJSON=function(){var noteInfo=this.getNoteInfo();return{title:noteInfo.title,content:noteInfo.content}};MapNoteCondition.prototype.diableRename=function(){this.renamable=!1};MapNoteCondition.prototype.enableRename=function(name){this.renamable=!0};netBrain.DataView=netBrain.DataView||{};netBrain.DataView.MapNoteCondition=MapNoteCondition}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.nbDataViewDisplayModeModalCtrl",DataViewDisplayModeModalCtrl);DataViewDisplayModeModalCtrl.$inject=["$scope","$uibModalInstance","currentPage","nb.topo.httpExternNbrSrvc"];function DataViewDisplayModeModalCtrl(self,$uibModalInstance,currentPage,httpExternNbrSrvc){var scopeObj={switchMode:netBrain.Map.Const.NetmapDisplayMode.switchMode,pinMode:netBrain.Map.Const.NetmapDisplayMode.pinMode,activePage:currentPage,closeDialog:function(){$uibModalInstance.dismiss()},onConfirm:function(){$uibModalInstance.close(self);if(null!=self.activePage){self.activePage.setDisplayMode(self.pageDataViewDisplayMode.value);self.activePage.getNetmapOperator().makeNeatMap(httpExternNbrSrvc,self.isNeatUp)}},pageDataViewDisplayMode:{value:self.switchMode}};angular.extend(self,scopeObj);if(null!=self.activePage){self.pageDataViewDisplayMode.value=self.activePage.getDisplayMode();self.isNeatUp=self.activePage.getIsNeatUp()}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.nbDataViewTreeModalCtrl",nbDataViewTreeModalCtrl);nbDataViewTreeModalCtrl.$inject=["$scope","$uibModalInstance","$log","$timeout","ivhTreeviewMgr","nb.dataview.httpDataViewManagerSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","dialogOption","$q","nb.ng.nbValidationSrvc"];function nbDataViewTreeModalCtrl($scope,$uibModalInstance,$log,$timeout,ivhTreeviewMgr,httpDataViewManagerSrvc,nbAlertSrvc,utilitySrvc,dialogOption,$q,nbValidationSrvc){var self=$scope;self.newFolderNode={name:"Unnamed Folder",description:"A dataview folder",nodeType:DataViewNodeType.Folder,editable:!0};$scope.currParentNode=null;$scope.isInvokedFromDataViewMgr=!1;$scope.childrenFolderIDs=[];$scope.isNewFolder=!0;self.editMode=!1;self.editingNode=null;angular.isDefined(dialogOption)&&angular.isDefined(dialogOption.dataViewTree)&&($scope.isInvokedFromDataViewMgr=!0);self.treeNodeSelectNew=function(folder,trvw){self.editMode||(self.selectedDataViewFolder=folder)};self.ivhTreeOptions={defaultSelectedState:!1,validate:!0,expandToDepth:1,labelAttribute:"name",idAttribute:"ID",childrenAttribute:"child",expandedAttribute:"expanded",selectedAttribute:"selected",editableAttribute:"editMode",enableMultipleSelect:!1,nodeClickCallback:self.treeNodeSelectNew,iconTemplate:function(node,trvw){return'<div class="icon_nb_folder"></div>'},checkTreeNodeVisible:function(node,trvw){return node.nodeType===DataViewNodeType.Folder},enableNodeDropdown:{isDisplay:function(node,trvw){return!node.editMode},dropdownItems:function(node,trvw){return node.nodeType!==DataViewNodeType.Folder||node.parentId?$scope.treeActionMenu:$scope.treeRootActionMenu}},editableCallback:function(node,trvw,text){return self.doneEditing(node,text)}};self.selectedDataViewFolder=null;self.dataViewTree=[];self.treeRootActionMenu=[{template:"New Folder",action:function(node,trvw,event){self.addSubFolderNew(node,trvw)}}];self.treeActionMenu=[{template:"New Folder",action:function(node,trvw,event){self.addSubFolderNew(node,trvw)}},{template:"Rename Folder",action:function(node,trvw,event){self.renameFolderNew(node,trvw)}},{template:"Delete Folder",action:function(node,trvw,event){self.deleteFolderNew(node,trvw)}}];self.generateDataViewTreeNew=function(){if($scope.isInvokedFromDataViewMgr){self.dataViewTree=angular.copy(dialogOption.dataViewTree);self.selectedDataViewFolder=angular.copy(dialogOption.dataViewTree)}else{var dataViewTreeType=DataViewTreeType.GlobalDataView;httpDataViewManagerSrvc.getDataViewTreeRoot(null,dataViewTreeType,null).then((function(root){if(root){if(dialogOption&&dialogOption.option&&dialogOption.option.filterSchedulerId&&root.child)for(var i=0;i<root.child.length;i++)if(root.child[i].ID==dialogOption.option.filterSchedulerId){root.child.splice(i,1);i--}self.dataViewTree=root;self.selectedDataViewFolder=root}}))}};self.generateDataViewTreeNew();function resetEditingNode(){if(null!==self.editingNode){if(!0===self.editingNode.isNew){var index=_.findIndex(self.editingNode.parentNode.child,{editable:!0});index>=0&&self.editingNode.parentNode.child.splice(index,1)}else{self.editingNode.currentNode.name=self.editingNode.oldName;self.editingNode.currentNode.editable=!1;self.editingNode.currentNode.editMode=!1;self.editingNode.currentNode.selected=!1}self.editingNode=null;self.editMode=!1;$(document.body).unbind("click.nbTreeDocClickHandler");$("span.row-menu-no-display").removeClass("row-menu-no-display")}}self.addSubFolderNew=function(node,trvw){resetEditingNode();$scope.currParentNode=node;$scope.isNewFolder=!0;var newFolder=angular.copy(self.newFolderNode);newFolder.parentId=node.ID;newFolder.editMode=!0;node.child||(node.child=[]);node.child.push(newFolder);self.selectedDataViewFolder=node;self.selectedDataViewFolder.expanded=!0;self.editMode=!0;self.editingNode={};self.editingNode.currentNode=newFolder;self.editingNode.oldName=newFolder.name;self.editingNode.isNew=!0;self.editingNode.parentNode=node};self.renameFolderNew=function(node,trvw){$scope.currParentNode=findParent(node.ID);resetEditingNode();$scope.editingNode={};$scope.editingNode.currentNode=node;$scope.editingNode.oldName=node.name;$scope.editingNode.isNew=!1;$scope.editingNode.parentNode=$scope.currParentNode;node.editMode=!0;$scope.isNewFolder=!1;self.editMode=!0};self.deleteFolderNew=function(folder,trvw){resetEditingNode();var folderId=folder.ID;nbAlertSrvc.confirm({message:"Deleting a folder will delete all sub folders and included data views, which is irreversible. Do you want to delete this folder anyway?"}).then((function(){httpDataViewManagerSrvc.deleteDataViewTreeNodes(null,[folderId]).then((function(){var children=findParent(folderId).child;var childIdx=_.indexOf(children,folder);dialogOption.deleteTreeCallback&&dialogOption.deleteTreeCallback.call(self,folderId);children.splice(childIdx,1);ivhTreeviewMgr.validate(self.dataViewTree,self.ivhTreeOptions)}))}))};function findParent(nodeId){if(nodeId){var parentNode=null;!function myself(nodeId,traverseNode){if(nodeId===traverseNode.ID)return!0;angular.forEach(traverseNode.child,(function(child){!0===myself(nodeId,child)&&(parentNode=traverseNode);return!1}))}(nodeId,self.dataViewTree);return parentNode}}self.doneEditing=function(node,text){var defer=$q.defer();(function(editingFolder,newName){if(0===newName.length)return showErrorDialog("Please enter a unique folder name.","");if(newName.length>128)return showErrorDialog("A folder name can't exceed 128 characters.","");if(!nbValidationSrvc.getValidator("generalForbidChars")(newName))return nbAlertSrvc.warning({message:"Name cannot contain special characters."});if(angular.isDefined($scope.currParentNode)){var childNodes=$scope.currParentNode.child;if(angular.isDefined(childNodes)&&childNodes.length>0)for(var i=0;i<childNodes.length;i++)if((!editingFolder.ID||editingFolder.ID!==childNodes[i].ID||editingFolder.name!==childNodes[i].name)&&angular.isDefined(childNodes[i].ID)&&0===childNodes[i].nodeType&&childNodes[i].name.toUpperCase()===newName.toUpperCase())return showErrorDialog("A folder with the same name already exists in the folder.","")}var defer=$q.defer();defer.resolve(!0);return defer.promise})(node,text).then((function(result){if(!0!==result)defer.resolve(!1);else{node.name=text;0===node.nodeType&&httpDataViewManagerSrvc.upInsertDataViewTreeNode(null,node).then((function(newNode){if(2===newNode.nodeStatus)showErrorDialog("A folder with the same name already exists in the folder.","").then((function(){self.generateDataViewTreeNew();defer.resolve(!1)}));else if(3===newNode.nodeStatus)showErrorDialog("Cannot save the folder, The folder has been deleted.","").then((function(){self.generateDataViewTreeNew();defer.resolve(!1)}));else if($scope.isNewFolder){var newChildList=_.reject(self.selectedDataViewFolder.child,(function(childNode){return angular.isUndefined(childNode.ID)}));newChildList.push(newNode);self.selectedDataViewFolder.child=newChildList;self.selectedDataViewFolder=newNode;self.editMode=!1;node.editMode=!1;node.editable=!1;ivhTreeviewMgr.deselectAll(self.dataViewTree,self.ivhTreeOptions);ivhTreeviewMgr.validate(self.dataViewTree,self.ivhTreeOptions);self.selectedDataViewFolder.selected=!0;defer.resolve(!0)}else{var parentNode=findParent(newNode.ID);var children=parentNode.child;_.reject(children,(function(childNode){return childNode.ID===newNode.ID})).push(newNode);self.selectedDataViewFolder=_.find(parentNode.child,(function(child){return child.ID===newNode.ID}));self.editMode=!1;node.editMode=!1;node.editable=!1;ivhTreeviewMgr.deselectAll(self.dataViewTree,self.ivhTreeOptions);ivhTreeviewMgr.validate(self.dataViewTree,self.ivhTreeOptions);self.selectedDataViewFolder.selected=!0;defer.resolve(!0)}}),(function(reason){showErrorDialog(utilitySrvc.getErrorMessage(reason),"");$log.debug(utilitySrvc.getErrorMessage(reason))}))}}));return defer.promise};self.onOK=function(){if($scope.isInvokedFromDataViewMgr){if(function(){var beingMovedItem=dialogOption.beingMovedNode;if(angular.isDefined(beingMovedItem)&&beingMovedItem.ID===self.selectedDataViewFolder.ID){showErrorDialog("Cannot move a folder to itself!","");return!1}if(angular.isDefined(beingMovedItem)&&beingMovedItem.parentId===self.selectedDataViewFolder.ID){showErrorDialog("There is no point to move to its own parent folder!","");return!1}!function buildDescendantFolderIDs(treeNode){if(angular.isUndefined(treeNode.child))return;for(var i=0;i<treeNode.child.length;i++){$scope.childrenFolderIDs.push(treeNode.child[i].ID);buildDescendantFolderIDs(treeNode.child[i])}}(beingMovedItem);if(-1!==_.indexOf($scope.childrenFolderIDs,self.selectedDataViewFolder.ID)){showErrorDialog("Cannot move a folder to its descendant folder!","");return!1}return!0}()){var result={dataViewTree:self.dataViewTree,selectedDataViewFolder:self.selectedDataViewFolder};$uibModalInstance.close(result)}}else $uibModalInstance.close(self.selectedDataViewFolder)};self.onCancel=function(){resetEditingNode();$uibModalInstance.dismiss("Cancel Button Clicked!")};function showErrorDialog(message,detail){return nbAlertSrvc.error({message:message})}}}(NetBrain);!function(netBrain){angular.module("nb.miniTask").controller("nb.dataview.parserLibraryDataTableCtrl",parserTableController);parserTableController.$inject=["$scope","$log","$uibModal","$rootScope","$timeout","$filter","$uibModalInstance","uiGridConstants","nb.ng.utilitySrvc","nb.dataview.httpDataViewSrvc","nb.qapp.httpQappResultSrvc","args"];function parserTableController($scope,$log,$uibModal,$rootScope,$timeout,$filter,$uibModalInstance,uiGridConstants,utilitySrvc,httpDatcaViewSrvc,httpQappResultSrvc,args){$scope.dataTimeValidMsg="Please select the date time.";var timePoint=DateUtil.format(new Date(args.dataUnitObj.generateTime),"MM/DD/YYYY HH:mm tt");$scope.showChangeTime=!1;$scope.dataModel={table:{},name:(args.device.hostName?args.device.hostName+":":"")+args.dataUnitObj.displayName,timePoint:timePoint,dataIndex:[],tableDetail:{},curTable:{id:void 0},grid:{search:"",data:[],column:[],gridDef:{data:[],columnDefs:[],enableColumnResizing:!0,enableColumnResize:!0,multiSelect:!1,enableFullRowSelection:!0,enableRowHeaderSelection:!1,modifierKeysToMultiSelect:!1,enableColumnMenus:!1,rowTemplate:'<div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell></div>',onReady:function(event){event.api.sizeColumnsToFit()},onRegisterApi:function(gridApi){$scope.dataModel.grid.gridDef.gridApi=gridApi},gridApi:null}}};var initFirstChangeTimePoint=!0;$scope.changeTimePoint=function(){if(initFirstChangeTimePoint)initFirstChangeTimePoint=!1;else if($scope.dataModel.timePoint){$scope.startShowDateError=!1;args.dataUnitObj.varType="table";var requestOption={timePoint:$scope.dataModel.timePoint,devId:args.device.key,devType:args.device.devType,dataUnit:args.dataUnitObj};httpDatcaViewSrvc.getDataTableByTimePoint(requestOption).then((function(data){generateTable(data)}))}else $scope.startShowDateError=!0};function refresh(){var dataModel=$scope.dataModel;var grid=dataModel.grid;var gridDef=dataModel.grid.gridDef;!function(){var dataModel=$scope.dataModel;var grid=dataModel.grid;var tbl=dataModel.table;grid.data=[];grid.column=[];var rowNum=0;if(tbl&&tbl.columns){tbl.columns.forEach((function(ele,index){grid.column.push({minWidth:100,field:"c"+index,displayName:ele.name,headerTooltip:ele.name})}));rowNum=tbl.rows?tbl.rows.length:0;for(var index=0;index<rowNum;index++){var row={};for(var col=0;col<tbl.columns.length;col++)row["c"+col]=tbl.rows[index][col];grid.data.push(row)}}else if(tbl&&tbl.column&&tbl.column.length>0){tbl.column.forEach((function(ele,i){grid.column.push({minWidth:100,field:"c"+i,displayName:ele.name,headerTooltip:ele.name})}));rowNum=tbl.column[0].value.length;for(var i=0;i<rowNum;i++){var r={};for(var c=0;c<tbl.column.length;c++)r["c"+c]=tbl.column[c].value[i];grid.data.push(r)}}}();gridDef.columnDefs=grid.column;gridDef.data=grid.data;gridDef.gridApi&&gridDef.gridApi.core.notifyDataChange(uiGridConstants.dataChange.ALL)}function generateTable(tableContent){!function(data){if(data&&data.dataViewId&&data.device&&data.device.dataViewData){var dvs=data.device.dataViewData.dataViewInfos||[data.device.dataViewData.dataViewInfo];if(dvs){_.find(dvs,(function(d){return d&&d.dataViewGroupId===data.dataViewId&&"dvTemplate"===d.dataViewType}))&&($scope.showChangeTime=!0)}}}(args);if(tableContent){var tableJson=JSON.parse(tableContent);$scope.dataModel.table=tableJson;refresh()}else{$scope.dataModel.table={};refresh()}}$scope.onCancel=function(){$uibModalInstance.close("Cancel")};args.dataUnitObj.valueExpr.guid&&""===args.dataUnitObj.valueExpr.contentOrigText?httpQappResultSrvc.getQappMonitorDataDataTable(args.dataUnitObj.valueExpr.guid).then((function(data){generateTable(JSON.stringify(data.table))}),(function(err){console.error(err);generateTable("")})):generateTable(args.dataUnitObj.valueExpr.contentOrigText)}}(NetBrain);!function(){angular.module("nb.dataview").directive("nbDataViewPositionLabelDirective",DataViewPositionLabelDirective);DataViewPositionLabelDirective.$inject=["$uibModal","$log","$q","$timeout","nb.systemmodel.httpDeviceSchemaSrvc","nb.dataview.httpDataViewSrvc","nb.dataview.dataViewEditMgr","nb.sdn.httpSdnSrvc","nb.systemmodel.deviceSchemaMgrSrvc","nb.common.nbSelectPropertyModalSrvc","nb.common.nbAlertSrvc","nb.dataview.editDataViewSrvc"];function DataViewPositionLabelDirective($uibModal,$log,$q,$timeout,httpDeviceSchemaSrvc,httpDataViewSrvc,dataViewEditMgr,httpSdnSrvc,deviceSchemaMgrSrvc,nbSelectPropertyModalSrvc,nbAlertSrvc,editDataViewSrvc){return{restrict:"AE",scope:{isInterfaceLabel:"=?",showSchemaOrValue:"@",disableNum:"@",posObj:"=",deviceJson:"=?",lsDataUnitFromQapp:"=",nodeIdentify:"=",deviceId:"=",deviceType:"=",groupId:"=",taskInfoId:"=",intfKeySchema:"=?",intfKeySchemaValue:"=?",needsToUseFixedPosition:"=?"},templateUrl:"modules/nbDataView/views/EditDataView/nbDataViewPositionLabelDirective.html",link:function(scope,ele){if(scope.posObj){!function(){scope.posData=scope.posObj.getData();scope.posInfoData=scope.posObj.posInfoObj.getData();scope.selectedNodeType={curNodeType:{id:VisualSpaceConstant.legacySchemaKeyword},isLegacyDevice:!0};if(scope.nodeIdentify){scope.isLegacyDevice=dataViewEditMgr.isLegacyNodeSchema(scope.nodeIdentify.nbPathSchema);scope.isLegacyDevice||(scope.selectedNodeType={curNodeType:{id:scope.nodeIdentify.nbPathSchema},isLegacyDevice:!1})}}();var isLeaveDataUnit=!0;var lastDataUnit;scope.$on("change-model-by-link",(function(){}));scope.$on("edit-data-view-device-data-unit-edit-mode",(function(event,posData){posData.posName===scope.posObj.getPosName()&&scope.showDataUnitEditMode()}));scope.$on("edit-data-view-link-data-unit-edit-mode",(function(event,posData){posData.posName===scope.posObj.getPosName()&&scope.showDataUnitEditMode()}));scope.showDataUnitEditMode=function(){var dataUnitDataType=scope.posObj.posInfoObj.dataUnitObj.getValueType();if("uParagraph"!==_.property(dataUnitDataType)(window.DataUnitType))if("uDoc"!==_.property(dataUnitDataType)(window.DataUnitType))if(window.DataUnitType[dataUnitDataType]&&"uString"!==_.property(dataUnitDataType)(window.DataUnitType)&&"uBool"!==_.property(dataUnitDataType)(window.DataUnitType)&&"uInt"!==_.property(dataUnitDataType)(window.DataUnitType)&&"uFloat"!==_.property(dataUnitDataType)(window.DataUnitType))nbAlertSrvc.alert("These types of data units are not supported to be straightly modified: Table,Configlet and List.");else{scope.showEditMode=!0;lastDataUnit=angular.copy(scope.posObj.posInfoObj.dataUnitObj._data);$timeout((function(){jQuery(ele).find(".prefix-dunit").focus()}))}else scope.onAddAttachment();else scope.onFormatNote()};scope.limitLen=function(num,data,key){data[key]=data[key].slice(0,num)};scope.$on("execLeaveDataUnitFuncNow",(function(){if(!isLeaveDataUnit){scope.timePromise&&$timeout.cancel(scope.timePromise);scope.leaveDataUnitEditMode()}}));scope.leaveDataUnitEditMode=function(){scope.showEditMode=!1;if(lastDataUnit){var unitData=scope.posObj.posInfoObj.dataUnitObj._data;var displayInfo="";var isChanged=!1;isLeaveDataUnit=!0;unitData.prefix&&(displayInfo+=unitData.prefix);displayInfo+=unitData.value?unitData.value:"";unitData.unit&&(displayInfo+=unitData.unit);unitData.prefix!==lastDataUnit.prefix&&(unitData.prefix||lastDataUnit.prefix)&&(isChanged=!0);unitData.value!==lastDataUnit.value&&(unitData.value||lastDataUnit.value)&&(isChanged=!0);unitData.unit!==lastDataUnit.unit&&(unitData.unit||lastDataUnit.unit)&&(isChanged=!0);unitData.uId||(unitData.uId=NgUtil.getGUID());if(isChanged){scope.posObj.setModified(!0);scope.posObj.setLock(!0);scope.posObj.posInfoObj.setDisplayInfo(displayInfo);scope.posObj.posInfoObj.changeCustomized(!0)}}};scope.preLeave=function(){isLeaveDataUnit=!1;scope.timePromise=$timeout((function(){scope.leaveDataUnitEditMode()}),200)};scope.reEnter=function(){scope.timePromise&&$timeout.cancel(scope.timePromise);scope.showEditMode=!0};scope.getLabelType=function(){var nType=-1;var lsDataUnits=scope.posObj.getDataUnits();if(null==lsDataUnits||lsDataUnits.length<=0)return nType;scope.posObj.getDataUnitType()===window.DataUnitSourceType.uSrcGDR?nType=0:lsDataUnits[0].getValueType()===window.DataUnitType.uTable||lsDataUnits[0].getValueType()===window.DataUnitType.uList_object_subtype||lsDataUnits[0].getValueType()===window.DataUnitType.uParserTable?nType=1:lsDataUnits[0].getValueType()===window.DataUnitType.uConfigFile?nType=2:lsDataUnits[0].getValueType()===window.DataUnitType.uHyperLink?nType=3:lsDataUnits[0].getValueType()===window.DataUnitType.uParagraph?nType=4:lsDataUnits[0].getValueType()===window.DataUnitType.uDoc&&(nType=5);return nType};scope.onChangeLockStatus=function(){scope.posObj.setLock(!scope.posObj.isLocked())};scope.onClickDropdownToggle=function(event){if(scope.needsToUseFixedPosition){var button=$(event.target);"single-button"!==button.attr("id")&&(button=$(event.target).parents("#single-button"));var dropdown=button.siblings(".dropdown-menu");if(dropdown){var dropDownTop=button.offset().top+button.outerHeight();var dropDownLeft=button.offset().left;dropdown.css("top",dropDownTop+"px");dropdown.css("left",dropDownLeft+"px")}}};scope.getGdrDataPromise=function(){var deferred=$q.defer();scope.nodeIdentify&&!scope.allDeviceGenericSchemaDisplayNames?dataViewEditMgr.isLegacyNodeSchema(scope.nodeIdentify.nbPathSchema)?deferred.resolve():httpSdnSrvc.getGenericSchemaTreeStructure(scope.nodeIdentify.nbPathSchema).then((function(data){if(data&&"result"in data){scope.allDeviceGenericSchemaDisplayNames={};scope.allDeviceGenericSchemaDisplayNames[scope.nodeIdentify.nbPathSchema]=data.result;deferred.resolve()}else deferred.reject("Error in data of GenericSchemaTree for this node")}),(function(reason){deferred.reject(reason)})):deferred.resolve();return deferred.promise};scope.onSelectGDRData=function(){scope.getGdrDataPromise().then((function(){var modalParam={isDeviceProperty:!scope.isInterfaceLabel,isInterfaceProperty:scope.isInterfaceLabel,nodeIdentify:scope.nodeIdentify,deviceId:scope.deviceId,deviceType:scope.deviceType,allDeviceGenericSchemaDisplayNames:scope.allDeviceGenericSchemaDisplayNames,selectedNodeType:scope.selectedNodeType};modalParam.isInterfaceProperty&&(dataViewEditMgr.isLegacyNodeSchema(scope.nodeIdentify.nbPathSchema)?modalParam.intfSchemaId=window.DeviceTableProcessor.getFirstPartBeforeDot(scope.intfKeySchema):modalParam.intfSchemaId=scope.nodeIdentify.nbPathSchema);if(!scope.posObj.isEmpty()){var du=scope.posObj.getDataUnits()[0];var lsPreSelectedId=null;lsPreSelectedId=du.getUId()!==window.DeviceDataType.RouteTable&&du.getUId()!==window.DeviceDataType.ArpTable&&du.getUId()!==window.DeviceDataType.NctTable?[du.getUId()]:[du.getValue()];modalParam.preSelectedPropertyId=lsPreSelectedId}nbSelectPropertyModalSrvc.showModal(modalParam).then((function(property){var isLegacyNodeSchema=dataViewEditMgr.isLegacyNodeSchema(property.ID);var isTableOrConfigFile=property.isTable||property.isConfigFile;if(!isLegacyNodeSchema&&!isTableOrConfigFile){var argUId=property.ID;var argSrcType=DataUnitSourceType.uSrcGDR;var argDisplayName=property.displayName;var argPrefix=property.prefixLabelOnMap?property.prefixLabelOnMap:property.shortDisplayName?property.shortDisplayName:property.shortDisplayname;var argUnit=property.unit;httpDataViewSrvc.getSdnDataUnitValueByTemplate(!scope.isInterfaceLabel,scope.nodeIdentify,argUId,argSrcType,property.isRefLink).then((function(duVal){var argValue=null;var argValueExpr=null;if(duVal&&void 0!==duVal.value&&null!==duVal.value&&""!==duVal.value){duVal||$log.warn("No data for generic schema "+argUId);if(duVal){argValue=duVal.value;argValueExpr=duVal.valueExpr}if(duVal&&duVal.valueType===DataUnitType.uParserTable)scope.posObj.setDataUnit_ParserTable(argDisplayName,argUId,argValue,argValueExpr);else{var valueType=null;valueType=property.type.toLowerCase().indexOf("int")>=0?DataUnitType.uInt:property.type.toLowerCase().indexOf("float")>=0?DataUnitType.uFloat:property.type.toLowerCase().indexOf("double")>=0?DataUnitType.uFloat:property.type.toLowerCase().indexOf("bool")>=0?DataUnitType.uBool:DataUnitType.uString;scope.posObj.setDataUnit_schema(argSrcType,argUId,argDisplayName,valueType,argValue,argPrefix,argUnit)}}else nbAlertSrvc.notification({message:'Unable to obtain "'+property.displayName+'" from the database.'})}),(function(reason){$log.error(reason)}))}else{if(property.isSchema){var schemaObj=deviceSchemaMgrSrvc.getSchemaObjByKey(property.ID);var schemaUnit=schemaObj.getUnit();if(scope.isInterfaceLabel)httpDeviceSchemaSrvc.getInterfaceSchemaValue(null,scope.intfKeySchema,scope.intfKeySchemaValue,scope.deviceId,property.ID).then((function(re){var result=re.result;if(result&&void 0!==result.value&&null!==result.value&&""!==result.value){var value=result&&result.value&&result.value.length>0?result.value:"N/A";var valueType=null;if("object"===schemaObj.getType())scope.posObj.setDataUnit_schema_object_type(window.DataUnitSourceType.uSrcGDR,scope.deviceId,property.ID,property.displayName,scope.intfKeySchema,scope.intfKeySchemaValue);else if("list"===schemaObj.getType()){valueType="object"===schemaObj.getSubtype()?window.DataUnitType.uList_object_subtype:window.DataUnitType.uList_primitive_subtype;scope.posObj.setDataUnit_schema_list_type(window.DataUnitSourceType.uSrcGDR,scope.deviceId,property.ID,property.displayName,scope.intfKeySchema,scope.intfKeySchemaValue,valueType)}else{var schemaType=null;valueType=(schemaType=result&&0!=Object.keys(result).length?result.valueType:schemaObj.getType()).toLowerCase().indexOf("int")>=0?window.DataUnitType.uInt:schemaType.toLowerCase().indexOf("float")>=0?window.DataUnitType.uFloat:schemaType.toLowerCase().indexOf("double")>=0?window.DataUnitType.uFloat:schemaType.toLowerCase().indexOf("bool")>=0?window.DataUnitType.uBool:window.DataUnitType.uString;scope.posObj.setDataUnit_schema(window.DataUnitSourceType.uSrcGDR,property.ID,property.displayName,valueType,value,schemaObj.getShortDisplayName(),schemaUnit)}}else nbAlertSrvc.notification({message:'Unable to obtain "'+property.displayName+'" from the database.'})}),(function(reason){$log.error(reason)}));else if("object"===schemaObj.getType())scope.posObj.setDataUnit_schema_object_type(window.DataUnitSourceType.uSrcGDR,scope.deviceId,property.ID,property.displayName,null,null);else if("list"===schemaObj.getType())scope.posObj.setDataUnit_schema_list_type(window.DataUnitSourceType.uSrcGDR,scope.deviceId,property.ID,property.displayName,null,null,"object"===schemaObj.getSubtype()?window.DataUnitType.uList_object_subtype:window.DataUnitType.uList_primitive_subtype);else{var schemaType=schemaObj.getType();var valueType=null;valueType=schemaType.toLowerCase().indexOf("int")>=0?window.DataUnitType.uInt:schemaType.toLowerCase().indexOf("float")>=0?window.DataUnitType.uFloat:schemaType.toLowerCase().indexOf("double")>=0?window.DataUnitType.uFloat:schemaType.toLowerCase().indexOf("bool")>=0?window.DataUnitType.uBool:window.DataUnitType.uString;var selectedVarPrefix=property.prefixLabelOnMap?property.prefixLabelOnMap:property.shortDisplayName?property.shortDisplayName:property.shortDisplayname;if(!scope.deviceJson||void 0===scope.deviceJson[property.ID]||null===scope.deviceJson[property.ID]||""===scope.deviceJson[property.ID]){nbAlertSrvc.notification({message:'Unable to obtain "'+property.displayName+'" from the database.'});return}scope.posObj.setDataUnit_schema(window.DataUnitSourceType.uSrcGDR,property.ID,property.displayName,valueType,scope.deviceJson[property.ID],selectedVarPrefix,schemaUnit)}}property.isTable&&scope.posObj.setDataUnit_table(window.DataUnitSourceType.uSrcGDR,property.displayName,scope.deviceId?scope.deviceId:scope.deviceJson._id,property.dataType,property.dataName,property.vrf);property.isConfigFile&&scope.posObj.setDataUnit_configFile(window.DataUnitSourceType.uSrcGDR,scope.deviceId?scope.deviceId:scope.deviceJson._id,property.displayName)}}))}),(function(reason){$log.error(reason)}))};scope.onSelectDataUnitFromQapp=function(){var dataUnitDatas=function(){var dataUnitDatas=[];if(scope.isInterfaceLabel){var linkData=dataViewEditMgr.editingDataViewLink;var intfDataView=linkData.fromPort===scope.intfKeySchemaValue?linkData.intfSrc:linkData.intfDest;intfDataView&&intfDataView.intfInfo&&intfDataView.intfInfo.intfPosList&&(dataUnitDatas=intfDataView.intfInfo.intfPosList)}else{dataUnitDatas=dataViewEditMgr.editingDataViewDevice.dataViewData.devPosList}var result=[];_.each(dataUnitDatas,(function(dataUnit){dataUnit.extraData?_.each(dataUnit.extraData.overflowList,(function(overflow){overflow.posInfo&&overflow.posInfo.displayInfo&&overflow.posInfo.dataUnitList&&overflow.posInfo.dataUnitList.length&&result.push(overflow)})):dataUnit.posInfo&&dataUnit.posInfo.displayInfo&&dataUnit.posInfo.dataUnitList&&dataUnit.posInfo.dataUnitList.length&&result.push(dataUnit)}));return result}();editDataViewSrvc.selectDataUnitModal({lsDataUnitFromQapp:dataUnitDatas}).then((function(property){scope.posObj.setPosInfo(property.posInfo)}))};scope.onAddLabelLink=function(){$uibModal.open({templateUrl:"modules/nbDataViewTemplate/views/nbDataViewTemplateInsertLinkModal.html",controller:"nb.dataviewtemplate.dataViewTemplateInsertLinkCtrl",windowClass:"dataViewTemplateInsertLinkModal",backdrop:"static",resolve:{selectedNode:function(){return{positionInfo:{link:scope.posObj.posInfoObj.dataUnitObj._data.link}}}}}).result.then((function(link){scope.posObj.setPosInfoHyperlink(link)}))};scope.onClearPos=function(){scope.posObj.setEmpty()};scope.onFormatNote=function(){$uibModal.open({templateUrl:"modules/nbDataView/views/EditDataView/formatNotePopup.html",controller:"nb.dataview.formatNotePopupCtrl",windowClass:"formatNotePopup",backdrop:"static",keyboard:!1,resolve:{args:function(){var lsDataUnits=scope.posObj.getDataUnits();var titleOrigText=null;var content=null;if(lsDataUnits&&lsDataUnits.length>0){var dataUnitObj=lsDataUnits[0];if(dataUnitObj.getSourceType()!==window.DataUnitSourceType.uSrcQapp&&dataUnitObj.getValueType()===window.DataUnitType.uParagraph){var valueExprObj=dataUnitObj.getValueExpr();titleOrigText=valueExprObj&&valueExprObj.getTitleOrigText?valueExprObj.getTitleOrigText():valueExprObj.titleOrigText;content=valueExprObj&&valueExprObj.getContent?valueExprObj.getContent():valueExprObj.contentOrigText}}return{isEditMode:!0,title:titleOrigText,content:content}}}}).result.then((function(objParam){scope.posObj.setDataUnit_formatNote(window.DataUnitSourceType.uSrcCustomized,objParam.title,objParam.title,objParam.title,objParam.content,objParam.contentOrigText)}))};scope.onAddAttachment=function(){$uibModal.open({templateUrl:"modules/nbDataView/views/EditDataView/addAttachmentPopup.html",controller:"nb.dataview.addAttachmentPopupCtrl",windowClass:"addAttachmentPopup",backdrop:"static",keyboard:!1,resolve:{args:function(){var lsDataUnits=scope.posObj.getDataUnits();var displayName=null;var fileName=null;var fileType=null;var fileGuid=null;if(lsDataUnits&&lsDataUnits.length>0){var dataUnitObj=lsDataUnits[0];if(dataUnitObj.getSourceType()!==window.DataUnitSourceType.uSrcQapp&&dataUnitObj.getValueType()===window.DataUnitType.uDoc){displayName=dataUnitObj?dataUnitObj.getDisplayName():null;var valueExprObj=dataUnitObj.getValueExpr();fileName=valueExprObj&&valueExprObj.getFileName?valueExprObj.getFileName():null;fileType=valueExprObj&&valueExprObj.getFileType?valueExprObj.getFileType():null;fileGuid=valueExprObj&&valueExprObj.getFileGuid?valueExprObj.getFileGuid():null}}return{displayName:displayName||null,fileName:fileName||null,fileType:fileType||null,fileGuid:fileGuid||null,dvgId:scope.groupId}}}}).result.then((function(obj){scope.posObj.setDataUnit_attachment(window.DataUnitSourceType.uSrcCustomized,obj.displayName,obj.fileName,obj.fileType,obj.fileGuid)}))};scope.canEditManually=function(){var dataUnitDataType=scope.posObj.posInfoObj.dataUnitObj.getValueType();return DataUnitTypeHelper.canEditDataUnit(dataUnitDataType)}}else scope.disableInterface=!0}}}}();!function(){angular.module("nb.dataview").directive("nbDataViewBrowserTreeLeafDirective",DataViewBrowserTreeLeafDirective);DataViewBrowserTreeLeafDirective.$inject=[];function DataViewBrowserTreeLeafDirective(){return{restrict:"A",require:"^ivhTreeview",template:'<div><div ng-if="node.nodeType == 0" class="ivh-tree-node" ng-class="{nodeSelected: node.selected}" ng-mouseleave="node.menuSelected = false;" ng-click="selectNode($event, node)"><span ivh-treeview-toggle><span ng-if="node.expended"><span class="fa fa-minus-square" ng-style="{\'opacity\': (node.childNumber > 0) ? 1 : 0}"></span><img src="img/folder.png" style="margin: -5px 2px 0 5px;"/></span><span ng-if="!node.expended"><span class="fa fa-plus-square" ng-style="{\'opacity\': (node.childNumber > 0) ? 1 : 0}"></span><img src="img/folder-closed.png" style="margin: -5px 2px 0 5px;"/></span></span><span contenteditable="{{true == node.editMode}}" class="ivh-treeview-node-label" ng-class="{\'editHighlight\': node.editMode}" ng-model="node.name" nb-ivh-treeview-edit-directive spellcheck="false">{{trvw.label(node)}}</span></div><div ng-if="node.nodeType == 1" class="ivh-tree-node"  ng-class="{nodeSelected: node.selected}" ng-click="selectNode($event, node)"><i class="fa" ng-class="node.dataViewGroupList ? \'fa-files-o\' : \'fa-file-o\'" style="margin: -5px 5px 0 14px;"></i><span class="ivh-treeview-node-label" title="{{node.name}}" >{{trvw.label(node)}}</span></div></div>',replace:!0,link:function(scope,elm,attrs,ivhTreeview){scope.selectNode=function(event,node){var ele=angular.element(event.target);(ele.hasClass("ivh-tree-node")||ele.hasClass("ivh-treeview-node-label"))&&ivhTreeview.onNodeClick(node)};scope.nbIvhRootNode=attrs.nbDataViewBrowserTreeLeafDirective}}}}();!function(netBrain){angular.module("nb.dataview").directive("nbOverflowDataDialogDirective",OverflowDataDialogDirective);OverflowDataDialogDirective.$inject=["$document"];function OverflowDataDialogDirective($document){var directive={restrict:"EA",templateUrl:"modules/nbDataView/views/nbOverflowDataDialogDirective.html",controller:controller,replace:!0,scope:{},link:function(){}};controller.$inject=["$scope","$sce","$element","nb.qmap.mapManagerSrvc"];function controller($scope,$sce,$element,mapManagerSrvc){var self=$scope;self.overflowData=[];self.hostName="";self.dataViewGroupName="";self.dialogStyle={top:0,left:0,display:"block",visibility:"hidden"};self.dataUnitType=[window.DataUnitType.uTable,window.DataUnitType.uParserTable,window.DataUnitType.uDoc,window.DataUnitType.uHyperLink,window.DataUnitType.uConfigFile,window.DataUnitType.uList_object_subtype,window.DataUnitType.uParagraph,window.DataUnitType.uList];self.dialogClosed=!0;self.isLoading=!0;self.theLinkIsFrom=!1;self.setOverflowDataClass=function(item){return _.contains(self.dataUnitType,item.getDataUnitType())||self.setDisplayInfoBlueClass(item)};self.setDisplayInfoBlueClass=function(item){if(!0===isGdrBaseType(item))return!1;var posObj=item.toJson();posObj.posName="";var otherInfoForTimeLine=bindOtherInfoForTimeLine(posObj,""!==self.interfaceId,self.deviceId,self.interfaceId);var isDyAndNumTypes=_.contains(self.numberTypes,item.getDataUnitType())&&isDynamic(self,item);var isParserAndNumTypes=_.contains(self.numberTypes,item.getDataUnitType())&&item.getDataUnitSourceType()===window.DataUnitSourceType.uSrcParserLibrary&&otherInfoForTimeLine;return isDyAndNumTypes||isParserAndNumTypes};function isGdrBaseType(item){var srcType=item.getDataUnitSourceType();var type=item.getDataUnitType();return(type===window.DataUnitType.uFloat||type===window.DataUnitType.uBool||type===window.DataUnitType.uInt||type===window.DataUnitType.uPercent)&&srcType===window.DataUnitSourceType.uSrcGDR}function isDynamic(selves,item){var flag=!1;if(netBrain.Map.CategoryMgr.isTopolink(selves.target.getCategory())){flag=(self.theLinkIsFrom?selves.target.getDataViewTypeSrc(item.getDataViewId()):selves.target.getDataViewTypeDest(item.getDataViewId()))===window.DataViewType.dvDynamic}else flag=selves.target.getDataViewType(item.getDataViewId())===window.DataViewType.dvDynamic;return flag}function getDataViewInfo(selves,item){if(netBrain.Map.CategoryMgr.isTopolink(selves.target.category)){return null!=selves.target.intfSrc?selves.target.getViewInfoSrc(item.getDataViewId()):selves.target.getViewInfoDest(item.getDataViewId())}try{var dvInfo=selves.target.getDataViewInfo(item.getDataViewId());return dvInfo||selves.dataViewInfo}catch(e){console.warn(e);return selves.dataViewInfo}}self.getDisplayInfoTitle=function(item){return item.getDataUnitType()===window.DataUnitType.uCompoundVar?item.getDisplayName():item.getDisplayInfo()};self.getValueColor=function(value,needNormal){var valueColor=null;value===window.DataUnitAlarm.warning?valueColor=NetBrain.Map.Const.Color.Warning:value===window.DataUnitAlarm.error?valueColor=NetBrain.Map.Const.Color.Error:value===window.DataUnitAlarm.normal&&needNormal?valueColor=NetBrain.Map.Const.Color.Normal:value===window.DataUnitAlarm.unknown&&(valueColor=NetBrain.Map.Const.Color.Unknown);return valueColor};self.getUnderLineClass=function(item){if(item&&item.posInfoObj&&item.posInfoObj.dataUnitObj&&item.posInfoObj.dataUnitObj.getData()&&item.posInfoObj.dataUnitObj.getData().link)return"underLine"};self.getDisplayInfo=function(item){var valueType=item.getDataUnitType();var retStr;if(valueType===window.DataUnitType.uCompoundVar){var value=item.getValue();var valueColor=self.getValueColor(value,!0);retStr=valueColor?'<span class="compoundBlock" style="background-color:'+NetBrain.Map.randomColorSrvc.parseColor(valueColor)+'"></span>':"<span></span>"}else{if(item.getPosInfo().getData().dataUnitList[0]){var alarm=item.getPosInfo().getData().dataUnitList[0].getData();item.getPosInfo()&&item.getPosInfo().getData()&&item.getPosInfo().getData().dataUnitList[0]&&item.getPosInfo().getData().dataUnitList[0].getData()&&(alarm=item.getPosInfo().getData().dataUnitList[0].getData().alarm);var alarmColor=self.getValueColor(alarm,!1);retStr=alarmColor?'<span style="background-color:'+NetBrain.Map.randomColorSrvc.parseColor(alarmColor)+(alarm===DataUnitAlarm.error?";color:"+NetBrain.Map.Const.TemplateAlarmColor.Error.font:"")+'">{0}</span>':"<span>{0}</span>"}else retStr="<span>{0}</span>";var displayText=item.getDisplayInfo();var iconString=function(valueType){var iconString="";switch(valueType){case window.DataUnitType.uList_primitive_subtype:case window.DataUnitType.uList_object_subtype:case window.DataUnitType.uParserTable:case window.DataUnitType.uTable:iconString=NetBrain.Map.CCompLabel.LabelIconSvg.table;break;case window.DataUnitType.uDoc:iconString=NetBrain.Map.CCompLabel.LabelIconSvg.attachment;break;case window.DataUnitType.uHyperLink:iconString=NetBrain.Map.CCompLabel.LabelIconSvg.link;break;case window.DataUnitType.uConfigFile:iconString=NetBrain.Map.CCompLabel.LabelIconSvg.file;break;case window.DataUnitType.uObject:iconString=NetBrain.Map.CCompLabel.LabelIconSvg.list;break;case window.DataUnitType.uParagraph:iconString=NetBrain.Map.CCompLabel.LabelIconSvg.formatNote;break;case window.DataUnitType.uList:iconString=NetBrain.Map.CCompLabel.LabelIconSvg.gdrList}return iconString}(valueType);iconString&&(item.iconString=iconString);retStr=retStr.replace(/\{0\}/,displayText)}return retStr};self.overflowItemClick=function(item,allUnit){var unitList=[];try{_.each(allUnit,(function(unitItem){unitItem._data.posInfo._data.dataUnitList[0]._data&&_.contains(self.numberTypes,unitItem._data.posInfo._data.dataUnitList[0]._data.valueType)&&unitList.push(unitItem._data.posInfo._data.dataUnitList[0]._data)}))}catch(e){}if(isDynamic(self,item)){var clickUnit=item.getDataUnits()[0]._data;var clickUnitType=item.getDataUnitType();var isGdrType=isGdrBaseType(item);if(!_.contains($scope.numberTypes,clickUnitType)||!0===isGdrType)return;var info={mapPageId:self.netmap.getDocId(),dataViewInfo:getDataViewInfo(self,item),deviceId:self.deviceId,titleName:self.titleName,interfaceId:self.interfaceId,unitList:unitList,currentUnit:clickUnit};info.onlyKey=info.interfaceId?info.deviceId+"-"+info.interfaceId:info.deviceId;info.titleType=info.interfaceId?"Interface":"Device";self.$root.$broadcast("changeHistoryChartPanelEvent",info)}};self.isDefinedDrillDownAction=function(item){return!!(item&&item.posInfoObj&&item.posInfoObj.dataUnitObj&&item.posInfoObj.dataUnitObj._data)&&item.posInfoObj.dataUnitObj._data.definedDrillDownAction};function bindOtherInfoForTimeLine(posObj,isLinkLabel,deviceId,interfaceId){return isLinkLabel?function(posObj,deviceId,interfaceId){var otherInfoForTimeLine=null;var netMapOperator=mapManagerSrvc.getActivePage()._netmapOperator;var compL3Device=netMapOperator._netmap._getGraphDeviceByKey(deviceId);var goTarget=netMapOperator.getLinkFromDeviceIntfValue(compL3Device,interfaceId);if(!goTarget)return otherInfoForTimeLine;var linkline=goTarget.part.data;var dataUnitListSrc=linkline.getDataUnitListSrc();var dataUnitListDest=linkline.getDataUnitListDest();var linkLabelObjIsFrom=function(interfaceId,linkline){var result=!1;interfaceId===linkline.fromPort&&(result=!0);interfaceId===linkline.toPort&&(result=!1);return result}(interfaceId,linkline);var dataUnitList=linkLabelObjIsFrom?dataUnitListSrc:dataUnitListDest;dataUnitList=[];try{_.each(self.overflowData,(function(unitItem){var unitData=unitItem.getDataUnits()[0];if(unitData&&_.contains(self.numberTypes,unitData.getValueType())){var item=unitData.toJson();dataUnitList.push(item)}}))}catch(e){console.warn(e)}var titleName=linkLabelObjIsFrom?linkline.intfSrc.intfInfo.intf.intfDisplaySchemaObj.value:linkline.intfDest.intfInfo.intf.intfDisplaySchemaObj.value;var dataViewInfo=linkLabelObjIsFrom?linkline.getViewInfoSrc(posObj&&posObj.dataViewId):linkline.getViewInfoDest(posObj&&posObj.dataViewId);if(dataViewInfo.dataViewType===DataViewType.dvDefault)return otherInfoForTimeLine;var fullTitleName=titleName;var dataViewData=null;if(compL3Device&&compL3Device.data&&_.isFunction(compL3Device.data.getHostname)&&compL3Device.data.getHostname()){fullTitleName=compL3Device.data.getHostname()+" . "+titleName;dataViewData=compL3Device.data.getDataViewData()}var intfKey=function(linkLabelObjIsFrom,linkline){return linkLabelObjIsFrom?{schema:linkline.intfSrc.intfInfo.intf.intfKeyObj.schema,value:linkline.intfSrc.intfInfo.intf.intfKeyObj.value,name:linkline.intfSrc.intfInfo.intf.intfDisplaySchemaObj.value}:{schema:linkline.intfDest.intfInfo.intf.intfKeyObj.schema,value:linkline.intfDest.intfInfo.intf.intfKeyObj.value,name:linkline.intfDest.intfInfo.intf.intfDisplaySchemaObj.value}}(linkLabelObjIsFrom,linkline);posObj&&posObj.posInfo&&posObj.posInfo.dataUnitList&&posObj.posInfo.dataUnitList[0]&&(otherInfoForTimeLine={dataUnitList:dataUnitList,dataUnitBelongTo:DataUnitBelongTo.intfLevel,titleName:fullTitleName,deviceId:deviceId,interfaceId:interfaceId,dataViewData:dataViewData,dataViewInfo:dataViewInfo,deviceCom:compL3Device?compL3Device.data:null,intfKey:intfKey});return otherInfoForTimeLine}(posObj,deviceId,interfaceId):function(posObj,deviceId){var otherInfoForTimeLine=null;var dev=mapManagerSrvc.getActivePage()._netmapOperator.getCompDeviceByKey(deviceId);var compDevice=mapManagerSrvc.getActivePage()._netmapOperator.getDeviceByHostName(dev.hostName)[0];var dataViewData=dev.getDataViewData();var dataUnitList=[];try{_.each(self.overflowData,(function(unitItem){var unitData=unitItem.getDataUnits()[0];if(unitData&&_.contains(self.numberTypes,unitData.getValueType())){var item=unitData.toJson();dataUnitList.push(item)}}))}catch(e){console.warn(e)}posObj.posInfo&&posObj.posInfo.dataUnitList&&posObj.posInfo.dataUnitList[0]&&(otherInfoForTimeLine={dataUnitList:dataUnitList,dataUnitBelongTo:DataUnitBelongTo.devLevel,titleName:dev.hostName,deviceId:dev.key,dataViewData:dataViewData,dataViewInfo:compDevice.getDataViewInfo(posObj.dataViewId),deviceCom:compDevice});return otherInfoForTimeLine}(posObj,deviceId)}self.overflowDrillDown=function(item,event){_.contains(self.dataUnitType,item.getDataUnitType());var posObj=item.toJson();var isLinkLabel=""!==self.interfaceId;var otherInfoForTimeLine=bindOtherInfoForTimeLine(posObj,isLinkLabel,self.deviceId,self.interfaceId);var deviceCom=otherInfoForTimeLine.deviceCom;delete otherInfoForTimeLine.deviceCom;self.$parent.drillDownLabel(posObj,event,!isLinkLabel,isLinkLabel,self.target,self.deviceId,self.interfaceId,otherInfoForTimeLine,deviceCom);_close()};self.onDevIntfDrillDownIconClick=function(item,event){try{var drillDownActionSrvc=angular.element(document).injector().get("nb.dataviewtemplate.drillDownActionSrvc");var devKey;var intfKey;var posInfo=nbPLM.Common.clone(item._data);if(!posInfo.posInfo.dataUnitList&&posInfo.posInfo._data&&posInfo.posInfo._data.dataUnitList){posInfo.posInfo.dataUnitList=[];posInfo.posInfo._data.dataUnitList.forEach((function(ele){posInfo.posInfo.dataUnitList.push(ele._data)}))}devKey=self.deviceId;intfKey=self.interfaceId;var mapPageObj=mapManagerSrvc.getActivePage();drillDownActionSrvc.openVarActionRunningPanel(posInfo,devKey,"",{mapPageObj:mapPageObj,dataViewGroupId:posInfo.dataViewId,targetData:null,targetInfo:{devKey:devKey,intfKey:intfKey},posInfo:posInfo},event)}catch(ex){console.warn(ex)}};self.$on(window.netMapEvent.displayOverflowData,(function(event,deviceData,diagramEvent,target,netmap){self.isLoading=!0;event.preventDefault();diagramEvent.stopImmediatePropagation();var diagram=netmap.getGoJsDiagram();self.target=target;self.netmap=netmap;self.overflowData=[];self.titleName="";self.dataViewInfo="";self.deviceId="";self.interfaceId="";if(netBrain.Map.CategoryMgr.isTopolink(target.getCategory())){var isFrom=!(posInfo=deviceData,data=target,intfDestPostList=data.getIntfPosListDest(),-1!==_.findIndex(intfDestPostList,(function(destPosInfo){return destPosInfo===posInfo})));self.theLinkIsFrom=isFrom;self.deviceId=isFrom?target.getDevIdSrc():target.getDevIdDest();var interfaceName=isFrom?self.target.intfSrc.intfInfo.intf.intfDisplaySchemaObj.value:self.target.intfDest.intfInfo.intf.intfDisplaySchemaObj.value;self.titleName=self.netmap._diagram.findNodeForKey(self.deviceId).data.getHostname()+" . "+interfaceName;self.dataViewInfo=isFrom?self.target.getIntfSrc().dataViewInfo:self.target.getIntfDest().dataViewInfo;self.interfaceId=isFrom?self.target.intfSrc.intfInfo.intf.intfKeyObj.value:self.target.intfDest.intfInfo.intf.intfKeyObj.value}else if(netBrain.Map.CategoryMgr.isNetworkDevice(target.getCategory())){self.titleName=target.getHostname();self.deviceId=target.getKey();self.dataViewInfo=self.target.getDataViewInfo()}var posInfo,data,intfDestPostList;var existOverflowPosIndexes=[];var existOverflowPoses=[];_.each(deviceData.extraData.overflowList,(function(data){existOverflowPosIndexes.push(parseInt(data.posName.replace("overflowPos","")));existOverflowPoses.push(data)}));var maxIndex=_.max(existOverflowPosIndexes);var needAddOverflowIndexes=_.difference(_.range(1,maxIndex+1),existOverflowPosIndexes);_.each(needAddOverflowIndexes,(function(index){existOverflowPoses.push({posName:"overflowPos"+index,posInfo:{displayInfo:""}})}));existOverflowPoses.sort((function(a,b){return parseInt(a.posName.replace("overflowPos",""))-parseInt(b.posName.replace("overflowPos",""))}));_.each(existOverflowPoses,(function(data){!1!==NgUtil.getValueFromObjAndPath(data,"posInfo.dataUnitList.0.valueEx.isVisiable")&&self.overflowData.push(new window.CDataViewLabelPosData(data))}));!function(position){var doc=$document[0].documentElement;var pageDiv=mapManagerSrvc.getCurrentMapPageDiv();var docLeft=(window.pageXOffset||doc.scrollLeft)-(doc.clientLeft||0),docTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0),elementWidth=$element[0].scrollWidth,elementHeight=$element[0].scrollHeight;var docWidth=doc.clientWidth+docLeft,docHeight=doc.clientHeight+docTop,left=(position.x,position.y,Math.max(position.x-docLeft,0)),top=Math.max(position.y-docTop,0);var leftSideBarWidth=angular.element(document.querySelector(".netbrain-top-left-side-bar")).width();var mainPaneLeft=angular.element(pageDiv).find(".box-main-pane-container").position().left;left+$element.width()>docWidth-leftSideBarWidth-mainPaneLeft&&(left=left-$element.width()-30);top+$element.height()>docHeight-70&&(top=top-$element.height()-30);self.dialogStyle.top=top;self.dialogStyle.left=left;self.dialogStyle.visibility="visible";self.dialogClosed=!1}(diagram.transformDocToView(diagram.lastInput.documentPoint))}));self.$on(window.netMapEvent.closeOverflowDialog,(function(event){event.preventDefault();_close()}));self.closeOverflowWindow=function(){self.isLoading?self.isLoading=!1:_close()};function _close(){self.dialogClosed=!0;self.dialogStyle.visibility="hidden"}var rootScopeOnCloseAllTip=self.$root.$on(NetBrain.Map.Event.CloseAllTip,(function(e){e.preventDefault();_close()}));var rootScopeOnDataViewChanged=self.$root.$on(NetBrain.Map.Event.DataViewChanged,(function(e){e.preventDefault();_close()}));self.$on("$destroy",(function(){rootScopeOnDataViewChanged();rootScopeOnCloseAllTip()}));$scope.numberTypes=NetBrain.Map.Const.SuportChartValueType}return directive}}(NetBrain);!function(){angular.module("nb.dataview").directive("nbMultiConditionDirective",MultiConditionDirective);MultiConditionDirective.$inject=["$document","nb.common.nbAlertSrvc"];function MultiConditionDirective($document,nbAlertSrvc){return{restrict:"AE",scope:{conditionInfo:"="},templateUrl:"modules/nbDataView/views/EditDataView/nbMultiConditionDirective.html",link:function(scope,ele){scope.selectCondition=function(con){scope.currCondition=con;scope.$emit("multi-condition-selected",con)};scope.renameConditionName=function(condition,event){null!=event&&event.stopPropagation();var refCurrCondition=condition||scope.currCondition;refCurrCondition.name=scope.curConditionName;if(refCurrCondition.name&&refCurrCondition.name.length>64){var selector="."+event.target.classList[0];scope.focusConditionNameInput(refCurrCondition,selector,event)}else{var isErrorExist=!1;var strNewName=event.target.value;if(!strNewName||0===strNewName.length){nbAlertSrvc.warning({message:"condition name can not be empty!"});isErrorExist=!0}if(strNewName.length>64){event.preventDefault();isErrorExist=!0}else{if(condition){if(strNewName===condition.name){condition.isEditing=!1;return}}else if(strNewName===scope.currCondition.name){scope.isEditingConditionName=!1;return}if(_.pluck(scope.conditionList,"name").indexOf(strNewName)>=0){nbAlertSrvc.warning({message:"A condition with the name "+strNewName+" already exists. Please enter another name."});isErrorExist=!0}if(condition){isErrorExist||(condition.name=event.target.value);condition.isEditing=!1}else{isErrorExist||(scope.currCondition.name=event.target.value);scope.isEditingConditionName=!1}}}};scope.focusConditionNameInput=function(condition,argSelector,event){event.stopPropagation();var input=angular.element($document[0].querySelectorAll(argSelector));var conName=condition.name;input.val(conName);scope.curConditionName=conName;Utility.setCursorPosition(input[0])};scope.deleteCondition=function(condition){nbAlertSrvc.confirm({message:"Are you sure you want to delete the note condition?"}).then((function(){var conditionList=scope.conditionList;for(var i=0;i<conditionList.length;i++)if(conditionList[i].name===condition.name){conditionList.splice(i,1);scope.currCondition.name===condition.name&&(scope.currCondition=conditionList.length>0?conditionList[0]:null);return}}))};scope.addCondition=function(){var nDefaultNameIndex=1;var strDefaultNamePrefix=scope.conditionInfo.defaultConditionName;var numList=_.map(scope.conditionList,(function(condition){if(0===condition.name.indexOf(strDefaultNamePrefix)){var strIndex=condition.name.substring(strDefaultNamePrefix.length);if(!isNaN(strIndex))return Number.parseInt(strIndex)}}));for(;_.indexOf(numList,nDefaultNameIndex)>=0;)nDefaultNameIndex++;var strNewName=strDefaultNamePrefix+nDefaultNameIndex;var newCon=scope.conditionInfo.buildConditionFun(strNewName);scope.conditionList.push(newCon);scope.selectCondition(newCon)};!function(){var conditionInfo=scope.conditionInfo;scope.conditionList=conditionInfo.conditionList;conditionInfo.conditionList.length>0?scope.currCondition=conditionInfo.conditionList[conditionInfo.initConditionIndex||0]:scope.addCondition();scope.addBtnLabel=conditionInfo.addConditionBtnLabel;scope.conditionNameValidator={method:"watch",rules:[{ruleId:"maxLength",params:{length:64},errorMessage:"The field should be less than 64 characters."}]};scope.$emit("multi-condition-init-completed",scope.currCondition)}()}}}}();angular.module("nb.dataview").filter("nbDataViewSourceFilter",[function(){return function(colText,dataView){var sourceText="";var scopeInfo=dataView.scopeInfo||dataView.dataViewGroup.scopeInfo;if(dataView&&scopeInfo){sourceText="Global>";scopeInfo.type!==window.DataViewGroupScope.dvgScopeMap&&scopeInfo.type!==window.DataViewGroupScope.dvgScopeALog&&scopeInfo.type!==window.CompoundDataViewGroupScope.cdvgScopeMap||(sourceText="Map>");dataView.path&&dataView.path.length>0?sourceText+=dataView.path:angular.isDefined(dataView.docType)&&"CompoundDataView"===dataView.docType&&(sourceText+="Compound Data Views");dataView.fullPath=sourceText}return sourceText}}]).filter("nbDataViewCompoundSourceFilter",[function(){return function(colText,dataView){var sourceText="";if(dataView&&dataView.scopeInfo){sourceText="";dataView.path&&dataView.path.length>0&&(sourceText+=dataView.path);dataView.scopeInfo.type===window.DataViewGroupScope.dvgScopeALog&&(sourceText=sourceText+"> "+dataView.scopeInfo.alogName);dataView.fullPath=sourceText}return sourceText}}]);!function(netBrain){var randomColorType=-1;var defaultColorType=-2;var dataViewNote=2;angular.module("nb.dataview").factory("nb.dataview.editDataViewSrvc",EditDataViewSrvc);EditDataViewSrvc.$inject=["$rootScope","$q","$timeout","$uibModal","nb.dataview.dataViewEditMgr","nb.dataview.httpDataViewSrvc","nb.common.nbAlertSrvc","nb.qmap.mapManagerSrvc"];function EditDataViewSrvc($rootScope,$q,$timeout,$uibModal,dataViewEditMgr,httpDataViewSrvc,nbAlertSrvc,mapManagerSrvc){var service={selectDataUnitModal:function(argParamsObj){var modalOptions={backdrop:"static",windowClass:"selectPropertyPopup select-data-unit-modal",templateUrl:"modules/nbDataView/views/EditDataView/selectDataUnitModal.html",controller:"nb.dataview.selectDataUnitModalCtrl"};modalOptions.resolve={args:function(){return argParamsObj}};return $uibModal.open(modalOptions).result},saveDataView:function(){var lsDevs=dataViewEditMgr.getUpdatedDevicePosList();var lsLinks=dataViewEditMgr.getUpdatedIntfPosList();var editingDataView=dataViewEditMgr.editingDataView;var dataViewGroupId=editingDataView.dataViewGroupId||editingDataView.ID;var deferred=$q.defer();lsDevs||lsLinks?httpDataViewSrvc.updatePosList(lsDevs,lsLinks,dataViewGroupId).then((function(){nbAlertSrvc.notification("Successfully saved the data view.");var netMap=mapManagerSrvc.getActivePage();dataViewEditMgr.updatePosListSuccessCallback(netMap,lsDevs,lsLinks);deferred.resolve(dataViewGroupId)}),(function(reason){deferred.reject();310221===reason.ResultCode?nbAlertSrvc.notification({message:"Failed to save the data view: it has been deleted."}):nbAlertSrvc.error("Failed to save the data view to the server. "+reason.ResultDesc)})):$timeout((function(){deferred.resolve(dataViewGroupId)}));dataViewEditMgr.clearUpdatedPosLists();return deferred.promise},updateDataViewNote:function(note,noteLinkedInfos,oldTitle){var editingDataView=dataViewEditMgr.editingDataView;var dataViewGroupId=editingDataView.dataViewGroupId||editingDataView.ID;noteLinkedInfos=_.map(noteLinkedInfos,(function(item){return{deviceId:item.deviceKey,intfId:item.portId}}));var dvNote=function(noteData,oldTitle){var fontObj=new FontParser;fontObj.fromString(noteData.font);var note={oldTitle:oldTitle,noteContent:[{content:noteData.noteContent,fontColor:noteData.stroke===randomColorType?defaultColorType:noteData.stroke,timeStamp:noteData.modifyTime}],title:noteData.noteTitle,fontSize:parseInt(fontObj.fontSize),fontAlign:noteData.textAlign,fontColor:noteData.stroke===randomColorType?defaultColorType:noteData.stroke,backgroundColor:noteData.bgColor===randomColorType?defaultColorType:noteData.bgColor,timeStamp:noteData.modifyTime,isCompound:noteData.isCompound,type:noteData.noteFromType};noteData.refVariables&&(note.refVariables=noteData.refVariables);return note}(note,oldTitle);httpDataViewSrvc.updateDataViewNote(dvNote,dataViewGroupId,noteLinkedInfos).then((function(){mapManagerSrvc.getActivePage().getNetmapOperator().updateDataViewNoteInfoByLinkedInfos(dvNote,noteLinkedInfos)}))}};function hasThisDataview(dataViewData,dataviewGroupId){if(!dataViewData||!dataviewGroupId)return!1;var dataViewInfos=dataViewData.dataViewInfos||[dataViewData.dataViewInfo];return _.some(dataViewInfos,{dataViewGroupId:dataviewGroupId})}$rootScope.$on(netMapEvent.leaveDataViewEdit,(function(event){var netMap=netBrain.Map.currentActiveMap.getActiveNetmap();netMap.enableWholeMapOnce();netMap.enableMapOperator()}));$rootScope.$on(netMapEvent.enterDataViewEdit,(function(event,dataview){var netMap=netBrain.Map.currentActiveMap.getActiveNetmap();var nodeDataArray=netMap._model.nodeDataArray;var linkDataArray=netMap._model.linkDataArray;netMap.getNetmapOperator();var nodeDatas=function(nodeDatas,dataViewGroup){return _.filter(nodeDatas,(function(nodeData){return hasThisDataview(nodeData.dataViewData,dataViewGroup.ID)||nodeData.noteFromType===dataViewNote}))}(nodeDataArray,dataview);var nodeData=_.find(nodeDatas,(function(nodeData){return!nodeData.noteFromType}));nodeData&&netMap._centerNode(nodeData);netMap.enableMapOnceByParams(_.map(nodeDatas,(function(item){return item.key})),function(linkDatas,dataViewGroup){var links=[];_.each(linkDatas,(function(linkData){var srcHasDataview=hasThisDataview(linkData.intfSrc,dataViewGroup.ID);var destHasDataview=hasThisDataview(linkData.intfDest,dataViewGroup.ID);if(srcHasDataview||destHasDataview){var seg=0;seg=srcHasDataview&&destHasDataview?0:srcHasDataview?1:2;links.push({data:linkData,seg:seg})}}));return links}(linkDataArray,dataview));netMap.disableMapOperator()}));return service}}(NetBrain);!function(){angular.module("nb.dataview").controller("nb.dataview.selectDataUnitModalCtrl",SelectDataUnitModalCtrl);SelectDataUnitModalCtrl.$inject=["$scope","$rootScope","$timeout","$uibModal","$uibModalInstance","nb.common.nbSelectPropertyMgr","args"];function SelectDataUnitModalCtrl($scope,$rootScope,$timeout,$uibModal,$uibModalInstance,nbSelectPropertyMgr,args){$scope.lsDataUnitFromQapp=angular.copy(args.lsDataUnitFromQapp);!function(){$scope.DataUnitType=DataUnitType;_.each($scope.lsDataUnitFromQapp,(function(item){item.name=item.posInfo.displayInfo;item.valueType=item.posInfo.dataUnitList[0].valueType}))}();$scope.lsSelectedProperty=[];$scope.onSelected=function(){$timeout((function(){_.isEmpty($scope.lsSelectedProperty)||$scope.onOK()}),1)};$scope.filterTarget={filterText:"",searchText:""};$scope.onFilterFired=function(){$scope.filterTarget.filterText=$scope.filterTarget.searchText.trim()};$scope.onOK=function(){console.warn("last result exec");$uibModalInstance.close($scope.lsSelectedProperty[0])};$scope.onCancel=function(){$uibModalInstance.dismiss()}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").service("nb.dataview.dataViewPanelHttpSrvc",nbService);nbService.$inject=["$uibModal","$filter","$q","$timeout","nb.ng.nbHttp","nb.dataviewtemplate.httpDataViewTemplateSrvc","nb.dataview.httpDataViewInfoMgrSrvc","nb.dataview.httpDataViewManagerSrvc","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.dataview.httpDataViewSrvc"];function nbService($uibModal,$filter,$q,$timeout,nbHttp,httpDataViewTemplateSrvc,httpDataViewInfoMgrSrvc,httpDataViewManagerSrvc,utilitySrvc,httpAuthSrvc,httpDataViewSrvc){var me=this;this.Const={bTest:!0,PathPrefix:">>Data View Templates>",PathSplit:">",DvtFolderIndexMap:{"Built-in Data View Templates":1,"Shared Templates in Tenant":2,"My Templates":3},DefaultDataView:{sid:"default-data-view",ID:"default-data-view",name:"Default Data View",psid:"",parentId:"",isDefault:!0,isFolder:!1},rootNodes:[]};this.upInsertDataViewFolder=function(nodeData){return httpDataViewManagerSrvc.upInsertDataViewTreeNode(null,nodeData)};this.deleteDataViewNodes=function(ids){return httpDataViewManagerSrvc.deleteDataViewTreeNodes(null,ids)};this.moveDataViewTreeNode=function(id,pid){return httpDataViewManagerSrvc.moveDataViewTreeNode(null,pid,id)};this.refreshDataViewOld=function(id){return httpDataViewManagerSrvc.getDeviceDataViewsInPage(null,id,30,1,["hostName","devPos"],"",!0,"","",!0)};this.refreshDataView=function(id){var defer=$q.defer();httpDataViewManagerSrvc.getDeviceDataViewsInPage(null,id,2,1,["hostName","devPos"],"",!0,"","",!0).then((function(data){data&&data.dataViewGroup?httpDataViewSrvc.getDevicesInGroup(id).then((function(devices){devices&&(data.deviceList=devices.map((function(eleId){return{ID:eleId}})));defer.resolve(data)}),(function(err){defer.resolve(data)})):defer.reject({ResultCode:0,ResultDesc:"Data View doesn't exist."})}),(function(err){defer.reject(err)}));return defer.promise};function transfer(node,context){var nodeChild=node.child;node.child=void 0;0!=node.nodeType&&(node.$del=!0);if(node.isRoot){node.isFolder=!0;context.rootNode=node}else if(0==node.nodeType){node.isFolder=!0;context.folderNodes.push(node)}else context.leafNodes.push(node);context.mapNode[node.ID]=node;context.mapNode[node.path+">"+node.name]=node;if(nodeChild)for(var i=0;i<nodeChild.length;i++)transfer(nodeChild[i],context)}this.getStaticDataView=function(mapInfo){var defer=$q.defer();httpDataViewManagerSrvc.getDataViewTreeRoot(null,"GlobalDataView",null).then((function(data){httpDataViewInfoMgrSrvc.getDataViewPanelData(mapInfo.devIdList,mapInfo.mapPageId).then((function(data2){var context={rootNode:null,folderNodes:[],leafNodes:[],mapNode:{}};data.isRoot=!0;transfer(data,context);var context2={rootNode:null,folderNodes:[],leafNodes:[],mapNode:{}};if(data2.globalDataViews){data2.globalDataViews.isRoot=!0;transfer(data2.globalDataViews,context2)}context2.leafNodes.forEach((function(ele){var node=context.mapNode[ele.path+">"+ele.name];if(node){node.lastUpdateTime=ele.lastUpdateTime;node.name=ele.name;node.dataViewInfo={ID:ele.ID||ele.docId,name:ele.name,isCompoundDataView:"CompoundDataView"===ele.docType,dataViewGroup:ele};node.$del=!1}}));for(var i=0;i<context.leafNodes.length;i++)if(context.leafNodes[i].$del){context.leafNodes.splice(i,1);i--}var arrNodes=[];arrNodes.push(nbPLM.Common.clone(me.Const.DefaultDataView));context.rootNode;context.folderNodes.forEach((function(ele){arrNodes.push(ele)}));context.leafNodes.forEach((function(ele){arrNodes.push(ele)}));defer.resolve(arrNodes)}),(function(err){console.warn(err);defer.reject(err)}))}),(function(err){console.warn(err);defer.reject(err)}));return defer.promise};this.getDvtById=function(id){var defer=$q.defer();nbHttp.get("DataViewTemplate/Template/"+id).then((function(data){me.preProcessDvt2(data);defer.resolve(data)}),(function(err){defer.reject(err)}));return defer.promise};this.preProcessDvt2=function(dvtData){if(dvtData&&dvtData.lastScheduleTimes){var domainGuid=httpAuthSrvc.getDataSrc(utilitySrvc).DomainGuid;dvtData.lastScheduleTime=dvtData.lastScheduleTimes[domainGuid]}};this.preProcessDvt=function(dvtData,domainGuid){dvtData&&dvtData.lastScheduleTimes&&(dvtData.lastScheduleTime=dvtData.lastScheduleTimes[domainGuid])};this.getRecommendDvTemplate=function(devices){var defer=$q.defer();me.getDvtNodes().then((function(dvtTree){var rootNodes=dvtTree&&dvtTree.child?dvtTree.child.map((function(eleNode){return{ID:eleNode.ID,name:eleNode.name,path:eleNode.path,spath:eleNode.path+">"+eleNode.name}})):me.Const.rootNodes;rootNodes&&rootNodes.length&&(me.Const.rootNodes=rootNodes);httpDataViewTemplateSrvc.getRecommendDvTemplate(devices).then((function(dvts){if(rootNodes.length){var domainGuid=httpAuthSrvc.getDataSrc(utilitySrvc).DomainGuid;for(var i=0;i<dvts.length;i++)if(dvts[i]){me.preProcessDvt(dvts[i],domainGuid);if(dvts[i].path){dvts[i].path=dvts[i].path.trim();if(!rootNodes.some((function(eleRoot){if(0==dvts[i].path.indexOf(eleRoot.spath+">"))return!0}))){dvts.splice(i,1);i--}}else{dvts.splice(i,1);i--}}else{dvts.splice(i,1);i--}}defer.resolve(dvts)}),(function(err){console.warn(err);defer.resolve([])}))}),(function(err){console.warn(err);defer.resolve([])}));return defer.promise};this.transformPath=function(path){var sPath=path;0==sPath.indexOf(me.Const.PathPrefix)&&(sPath=sPath.substr(me.Const.PathPrefix.length));var iQuestionMark=sPath.indexOf("?");iQuestionMark>=0&&(sPath=sPath.substr(0,iQuestionMark));var arrPath=sPath.split(me.Const.PathSplit);for(var i=0;i<arrPath.length;i++){arrPath[i]=arrPath[i].trim();if(!arrPath[i]){arrPath.splice(i,1);i--}}return arrPath};this.transformId=function(pid,name,index){return pid?pid+this.Const.PathSplit+name:name};this.filterDvtInner=function(data){var nodeDatas=[];if(data&&data.length){var folderMap={};data.forEach((function(ele){var arrPath=me.transformPath(ele.path);if(arrPath.length>1){var arrNodes=[];for(var i=0;i<arrPath.length;i++)0==i?arrNodes.push({sid:me.transformId("",arrPath[i],i),name:arrPath[i],psid:"",isFolder:!0,index4Sort:me.Const.DvtFolderIndexMap[arrPath[i]]?me.Const.DvtFolderIndexMap[arrPath[i]]:void 0}):i==arrPath.length-1?arrNodes.push(nbPLM.Common.merge(ele,{sid:me.transformId(arrNodes[i-1].sid,arrPath[i],i),sname:arrPath[i],psid:arrNodes[i-1].sid,isFolder:!1})):arrNodes.push({sid:me.transformId(arrNodes[i-1].sid,arrPath[i],i),name:arrPath[i],psid:arrNodes[i-1].sid,isFolder:!0});arrNodes.forEach((function(eleNode){if(!folderMap[eleNode.sid]){nodeDatas.push(eleNode);folderMap[eleNode.sid]=1}}))}}));return nodeDatas}return nodeDatas};this.filterDvt=function(data){var nodeDatas=[];nodeDatas.push(nbPLM.Common.clone(me.Const.DefaultDataView));try{me.filterDvtInner(data).forEach((function(ele){nodeDatas.push(ele)}))}catch(ex){console.warn(ex)}return nodeDatas};this.getDvtNodes=function(){return me.Const.rootNodes&&me.Const.rootNodes.length?$q.when(null):nbHttp.get("dataViewTemplate/tree/getTree")};this.getLastDvtNodesByRunbookPath=function(rbtId,dvtPath){var bTest=me.Const.bTest;var curDate=new Date;var iCurDate=curDate.getTime();iCurDate-=72e5;curDate.setTime(iCurDate);return bTest?$q.when([{nodeId:"1",time:"2019-03-04T05:49:21.272Z",name:""},{nodeId:"2",time:"2019-03-03T05:49:21.272Z",name:""}]):nbHttp.get(nbPLM.Common.sprintf("runbook/dvtResult?runbookId={0}&beginTime={1}&path={2}",rbtId,curDate.toISOString(),encodeURIComponent(dvtPath)))};this.getDvtApplyCondition=function(rbtId,dvtPath){var defer=$q.defer();var ret=[{nodeId:-1,time:"",name:"Create New Runbook Node"}];me.getLastDvtNodesByRunbookPath(rbtId,dvtPath).then((function(data){if(data&&data.length){data.forEach((function(ele){ele.name=$filter("nbDateTime")(ele.time);ret.push(ele)}));defer.resolve(ret)}}),(function(err){defer.resolve(ret)}));return defer.promise};this.updateDataViewName=function(dvId,name){return nbHttp.post("dataviewtree/rename",{dataViewNodeId:dvId,name:name})}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").service("nb.dataview.dataViewPanelSrvc",nbService);nbService.$inject=["$uibModal","$rootScope","$filter","$q","$timeout","nb.ng.nbHttp","nb.qmap.updateMapSrvc","nb.netbrain.dataViewCacheSrvc","nb.dataview.applyDataViewSrvc","nb.dataview.httpDataViewSrvc","nb.common.nbAlertSrvc","nb.dataview.httpDataViewInfoMgrSrvc","nb.qmap.mapManagerSrvc","nb.runbook.dataviewTemplateTaskNodeSrvc","dialogService","nb.dataview.dataViewPanelHttpSrvc"];function nbService($uibModal,$rootScope,$filter,$q,$timeout,nbHttp,updateMapSrvc,dataViewCacheSrvc,applyDataViewSrvc,httpDataViewSrvc,nbAlertSrvc,httpDataViewInfoMgrSrvc,mapManagerSrvc,dataviewTemplateTaskNodeSrvc,dialogService,dataViewPanelHttpSrvc){var me=this;this.Const={name:"Hello data view panel",DataViewStatus:{bShowOld:!1},DataViewOp:{index:0,event:"onSaveDV",arg:null},FilterDevTypes:[1024,1037],DataViewType:{alog:"alog",global:"global",map:"map",temporary:"temporary"},fnSortNode:function(node1,node2){return node1.data.isDefault&&node2.data.isDefault?node1.data.name.toLowerCase()>node2.data.name.toLowerCase()?1:-1:node1.data.isDefault&&!node2.data.isDefault?-1:!node1.data.isDefault&&node2.data.isDefault?1:node1.data.isFolder&&node2.data.isFolder?node1.data.isRootScheduler?-1:node2.data.isRootScheduler?1:node1.data.hasOwnProperty("index4Sort")&&node2.data.hasOwnProperty("index4Sort")&&node1.data.index4Sort!=node2.data.index4Sort?node1.data.index4Sort>node2.data.index4Sort?1:-1:node1.data.name.toLowerCase()>node2.data.name.toLowerCase()?1:-1:node1.data.isFolder&&!node2.data.isFolder?-1:!node1.data.isFolder&&node2.data.isFolder?1:node1.data.isFolder||node2.data.isFolder?-1:node1.data.name.toLowerCase()>node2.data.name.toLowerCase()?1:-1},ErrDVNotExist:"The data view has been deleted.<br/>The Data View Panel will be refreshed after you click OK.",ErrDVNotMatch:"The matched devices with this Data View have been deleted from this map.<br/>The Data View Panel will be refreshed after you click OK.",ErrDVTNotExist:'The data view template "{0}" cannot be found.'};this.onSwitchTab=function(dm,tab){dm.tabGroup.current=tab.name};this.onDataViewOp=function(dm,dmDv){dmDv.getActivePage().getDocId()==dmDv.mapInfo.mapPageId&&"onSaveDV"==dm.dataViewOp.event&&me.saveAsNewDataViewGroup(dmDv)};this.getCurRunbookId=function(dmDv){return dmDv.getCurRunbookId()};this.onClearAllDataView=function(dmDv){me.clearAllDataViews(dmDv,!1,null).then((function(){me.refreshDataViewConsolePane()}))};this.onSaveAsDataView=function(dmDv,dataWrapper){me.saveAsNewDataViewGroup(dmDv).then((function(){dataWrapper.staticOne.bDeviceChange=!0;dataWrapper.staticOne.index++}))};this.isCurrentPage=function(dmDv){var activeMap=mapManagerSrvc.getActiveMap();return!!activeMap&&dmDv.mapInfo.mapPageId===activeMap.getActiveNetmap().getDocId()};this.getCurrentPageId=function(dmDv){var activeMap=mapManagerSrvc.getActiveMap();return activeMap?activeMap.getActiveNetmap().getDocId():""};this.getAllDevicesBriefInPage=function(dmDv){var arrDrawObject=dmDv.getActivePage()._getAllDrawObjectsByFilter((function(objDrawObject){return netBrain.Map.CategoryMgr.isNetworkDevice(objDrawObject.getCategory())&&!netBrain.Map.gMediaTypeMgr.isMediaType(objDrawObject.getDevType())}));return _.map(_.filter(arrDrawObject,(function(item){return-1===me.Const.FilterDevTypes.indexOf(item.devType)})),(function(device){return{id:device.key,name:device.getHostname(),devType:device.devType,nodeIdentify:device.devNodeData?device.devNodeData.nodeIdentify:null}}))};this.clearAppliedDataViewTemplate=function(dmDv){dmDv.getActivePage().clearDataViewTemplate();dmDv.arrDvts.forEach((function(ele){ele.isSelected=!1}))};this.getAllDevicesInPage=function(dmDv){return _.map(dmDv.getActivePage()._getAllDevices(),(function(item){return item.getKey()}))};this.filterRelativeDevices=function(dmDv,devices){var allDevicesInPage=me.getAllDevicesInPage(dmDv);return _.intersection(devices,allDevicesInPage)};this.addtoDataviewDevicesMapping=function(dmDv,obj){var dvmapping=_.find(dmDv.dataViewDeviceMapping,(function(dm){return dm.id===obj.id}));dvmapping?dvmapping.devices=obj.devices:dmDv.dataViewDeviceMapping.push(obj)};this.getDeviceInGroup=function(dmDv,nodeData,dataViewGroup){model=nodeData,httpDataViewSrvc.getDevicesInGroups(dataViewGroup.dataViewGroupList).then((function(devices){model.dataViewInfo.dataViewGroup.relativeDevices=me.filterRelativeDevices(dmDv,devices);model.deviceCount=model.dataViewInfo.dataViewGroup.relativeDevices.length;me.addtoDataviewDevicesMapping(dmDv,{id:model.dataViewInfo.ID,devices:model.dataViewInfo.dataViewGroup.relativeDevices})}));var model};this.wrapDvNodeData=function(dmDv,nodeData){nodeData.deviceCount=nodeData.dataViewInfo.dataViewGroup.relativeDevices?nodeData.dataViewInfo.dataViewGroup.relativeDevices.length:0;nodeData.applied=!1;"CompoundDataView"===nodeData.docType&&nodeData.dataViewGroupList.length>0&&me.getDeviceInGroup(dmDv,nodeData,nodeData.dataViewInfo.dataViewGroup)};this.getDataViewInfoId=function(dataView){if(!dataView)return null;var id=null;dataView.dataViewInfo&&(id=dataView.dataViewInfo.ID||dataView.dataViewInfo.dataViewGroupId||dataView.dataViewInfo._id);!id&&dataView.compoundDataViewInfo&&(id=dataView.compoundDataViewInfo.compoundDataViewId);!id&&dataView.dataViewInfo&&dataView.dataViewInfo.dataViewGroup&&(id=dataView.dataViewInfo.dataViewGroup._id||dataView.dataViewInfo.dataViewGroup.ID||dataView.dataViewInfo.dataViewGroup.docId);return id};this.getAllDataviews=function(dmDv){return dmDv.dataViewList};this.appendToDataList=function(dmDv,model){var matched=_.findIndex(dmDv.dataViewList,(function(d){return me.getDataViewInfoId(d)===me.getDataViewInfoId(model)}));matched>=0?dmDv.dataViewList.splice(matched,1,model):dmDv.dataViewList.push(model)};this.clearSelected=function(dmDv,applyId){dmDv.getJsWrapper().removeAllAppliedDataViewInfosExceptById(applyId);var arr=me.getAllDataviews(dmDv);for(var j=0;j<arr.length;j++)if(!applyId||me.getDataViewInfoId(arr[j])!==applyId){arr[j].applied=!1;arr[j].isPreview=!1}dmDv.temporaryDataView&&me.getDataViewInfoId(dmDv.temporaryDataView)!==applyId&&(dmDv.temporaryDataView.applied=!1)};this.clearAllDataViews=function(dmDv,isNotEmitDataViewChanged,exceptDvgId){var deferred=$q.defer();var activePage=dmDv.getActivePage();$rootScope.$emit("closeCacheLiveRunBox");updateMapSrvc.canUpdateCurrentMap().then((function(){me.clearSelected(dmDv,exceptDvgId);isNotEmitDataViewChanged||$rootScope.$emit(NetBrain.Map.Event.DataViewChanged);activePage.getNetmapOperator().resetDefaultDataView(dataViewCacheSrvc,!1,exceptDvgId).then((function(){me.clearAppliedDataViewTemplate(dmDv);activePage.setModify(!0);deferred.resolve()}),(function(){deferred.reject()}))}),(function(){deferred.reject()}));return deferred.promise};this.removeAppliedDataViews=function(dmDv){var deferred=$q.defer();var activePage=dmDv.getActivePage();var appliedDataviews=activePage.getNetMapJsWrapper().getAllAppliedDataViews();if(!(appliedDataviews&&appliedDataviews.length>0))return $q.resolve();me.clearAllDataViews(dmDv,!1,null).then((function(){activePage.clearDataViewTemplate();deferred.resolve()}),(function(error){deferred.reject(error)}));return deferred.promise};this.getSelectedTemplates=function(dmDv){return dmDv.arrDvts.filter((function(ele){return ele.isSelected}))};this.applyDVTemplate=function(dmDv){var activePage=dmDv.getActivePage();me.getSelectedTemplates(dmDv).forEach((function(template){template.dataSource=me.getDataSource();activePage.setApplyDataViewTemplate({ID:template.ID,dataSource:me.getDataSource(),name:template.name})}));var deviceBriefs=me.getAllDevicesBriefInPage(dmDv);var deviceList=_.map(deviceBriefs,(function(item){return item.id}));return applyDataViewSrvc.applyDataviewsOnDevicesWithPermissionAlert(deviceList).then((function(){}),(function(){nbAlertSrvc.notification("The selected Data View Template no longer exists.")}))};this.applyDVT=function(dmDv,template){var activePage=dmDv.getActivePage();var tmpls=activePage.getApplyDataViewTemplate()||[];me.removeAppliedDataViews(dmDv).then((function(){if(tmpls&&me.isDVTApplied(dmDv,template)){template.isSelected=!1;activePage.removeApplyDataViewTemplate(template);tmpls.length>1?me.applyDVTemplate(dmDv):me.clearAllDataViews(dmDv,!1,null).then((function(){me.refreshDataViewConsolePane()}),(function(){me.refreshDataViewConsolePane()}))}else{template.isSelected=!0;activePage.setApplyDataViewTemplate({ID:template.ID,dataSource:me.getDataSource(),name:template.name});me.applyDVTemplate(dmDv)}}))};this.addDataViewToPage=function(dmDv,dv){me.addDataViewToPageAndChangeProp(dmDv,dv,(function(d){d.isPreview=!1}))};this.addDataViewToPageAndChangeProp=function(dmDv,dv,changePropAction){var dataview=nbPLM.Common.clone(dv);changePropAction&&changePropAction(dataview);me.setApplyDataViewInfo(dmDv,dataview)};this.setApplyDataViewInfo=function(dmDv,dataview){me.removeDataViewId(dataview);var page=dmDv.getActivePage();var dataViewInfo={dataViewId:dataview.ID,dataViewName:dataview.name,dataViewGroupScope:dataview.dataViewInfo.dataViewGroup.scopeInfo.type,lastUpdateTime:dataview.dataViewInfo.dataViewGroup.lastUpdateTime};applyDataViewSrvc.setMapExtendData(page,dataViewInfo,null,null)};this.removeDataViewId=function(dataview){dataview.dataViewInfo&&dataview.dataViewInfo.ID&&dataview.dataViewInfo._id&&delete dataview._id;dataview.dataViewInfo&&dataview.dataViewInfo.dataViewGroup&&dataview.dataViewInfo.dataViewGroup._id&&dataview.dataViewInfo.dataViewGroup.ID&&delete dataview.dataViewInfo.dataViewGroup._id};this.isPreview=function(dmDv,id){return me.getAllDataviews(dmDv).some((function(d){return me.getDataViewInfoId(d)===id&&!0===d.isPreview}))};this.isTemporaryDataView=function(dmDv,dv){return me.getAllDataviews(dmDv).some((function(d){return me.getDataViewInfoId(d)===dv&&"temporary"===d.type}))};this.getLastAppliedDataViewExceptById=function(dmDv,dvgId){var arr=me.getAllDataviews(dmDv);var appliedDv=dmDv.getJsWrapper().getExtendDataViewData();var dvs=arr.filter((function(dv){return me.getDataViewInfoId(dv)!==dvgId&&appliedDv.dataViewId===me.getDataViewInfoId(dv)}));return dvs.length?dvs[dvs.length-1]:null};this.getDataViewInfoById=function(dmDv,dvgId){var dvs=me.getAllDataviews(dmDv).filter((function(d){return me.getDataViewInfoId(d)===dvgId}));return dvs.length?dvs[0]:null};this.isPinMode=function(dmDv){return"pinMode"===dmDv.getActivePage().getDisplayMode()};this.unPreviewOthers=function(dmDv,exceptDV){var arr=me.getAllDataviews(dmDv);_.each(arr,(function(dv){me.getDataViewInfoId(dv)!==me.getDataViewInfoId(exceptDV)&&(dv.isPreview=!1)}))};this.removePreviewStatus=function(dmDv){var arr=me.getAllDataviews(dmDv);_.each(arr,(function(dv){if(dv.isPreview){dv.isPreview=!1;dv.applied=!0}}))};this.checkIsDataViewExist=function(dvGroupId){return httpDataViewSrvc.doesDataViewGroupExist(null,dvGroupId)};this.selectItemById=function(dmDv,id){var arr=me.getAllDataviews(dmDv);for(var i=0;i<arr.length;i++)if(id===me.getDataViewInfoId(arr[i])){if(arr[i].isPreview&&!arr[i].isSelectForce)continue;arr[i].isSelectForce=!1;arr[i].applied=!0;me.addDataViewToPage(dmDv,arr[i])}};this.removeDataViewAndRecoverLastSelectedDv=function(dmDv,data,isExist,lastSelectId){me.isPinMode(dmDv)&&!isExist&&dmDv.getJsWrapper().removeAppliedDataViewInfo(data);data.applied=!1;data.isPreview=!1;lastSelectId?me.selectItemById(dmDv,lastSelectId):dmDv.getJsWrapper().setApplyDataViewInfo(null);isExist?nbAlertSrvc.error(me.Const.ErrDVNotMatch).then((function(){$rootScope.$emit("nbGEventRefreshDataView",{sdv:1})})):nbAlertSrvc.error(me.Const.ErrDVNotExist).then((function(){$rootScope.$emit("nbGEventRefreshDataView",{sdv:1})}))};this.applyDataView=function(dmDv,d,additionalDevices){if(!d)return $q.reject();var sourceData=d.value||d;var page=dmDv.getActivePage();var data={};var dataViewInfo={dataViewId:me.getDataViewInfoId(d),dataViewName:d.name,dataViewGroupScope:d.dataViewInfo.dataViewGroup.scopeInfo.type,lastUpdateTime:d.dataViewInfo.dataViewGroup.lastUpdateTime};(data=sourceData.dataViewInfo.dataViewGroup?sourceData:me.getDataViewInfoById(dmDv,me.getDataViewInfoId(sourceData))).dataViewInfo.dataViewGroup._id=me.getDataViewInfoId(dmDv.data);var lastSelectId;var arr=me.getAllDataviews(dmDv);lastSelectId=me.getDataViewInfoId(_.find(arr,(function(p){return!0===p.applied})));var relativeDevices=data.dataViewInfo.dataViewGroup.relativeDevices;if(me.isPinMode(dmDv)){if(additionalDevices&&_.isArray(additionalDevices))for(var j=0;j<additionalDevices.length;j++)_.contains(relativeDevices,additionalDevices[j])||relativeDevices.push(additionalDevices[j])}else for(var i=arr.length-1;i>=0;i--)me.getDataViewInfoId(data)!==me.getDataViewInfoId(arr[i])&&(arr[i].applied=!1);data.dataViewInfo.ID=me.getDataViewInfoId(data);return applyDataViewSrvc.applyDataviewsOnDevicesWithPermissionAlert(data.dataViewInfo.dataViewGroup.relativeDevices).then((function(){applyDataViewSrvc.setMapExtendData(page,dataViewInfo,null,null);dmDv.getActivePage().setApplyDataViewInfo(data);if(data.isPreview&&!data.isSelectForce){me.unPreviewOthers(dmDv,data);data.applied=!1;data.isSelectForce=!1}else{me.removePreviewStatus(dmDv);data.applied=!0}dmDv.getActivePage().refreshMapViewOptionVisible()}),(function(reazon){console.error(reazon);me.removeDataViewFromPage(dmDv,data);me.checkIsDataViewExist(data.dataViewInfo.ID).then((function(result){me.removeDataViewAndRecoverLastSelectedDv(dmDv,data,result,lastSelectId)}))}))};this.getDvgId=function(mapPageObj){var ret="";if(mapPageObj&&mapPageObj.newNodeList&&mapPageObj.newNodeList.length){mapPageObj.newNodeList.some((function(ele){if(ele.dataViewData&&ele.dataViewData.dataViewInfos&&ele.dataViewData.dataViewInfos.length)return ele.dataViewData.dataViewInfos.some((function(eleDv){if(eleDv.dataViewGroupId){ret=eleDv.dataViewGroupId;return!0}return!1}));if(ele.dataViewData&&ele.dataViewData.dataViewInfo&&ele.dataViewData.dataViewInfo.dataViewGroupId){ret=ele.dataViewData.dataViewInfo.dataViewGroupId;return!0}return!1}))}return ret};this.removeDataView=function(dmDv,data){if(!data)return $q.reject();var deferred=$q.defer();updateMapSrvc.canUpdateCurrentMap().then((function(){if(me.getDvgId(dmDv.getActivePage())!=data.ID)deferred.resolve();else{me.onSelectDefaultDataView(dmDv);deferred.resolve()}}),(function(){deferred.reject()}));return deferred.promise};this.removeDataViewOld=function(dmDv,data){if(!data)return $q.reject();var deferred=$q.defer();var fixedData=data.value||data;updateMapSrvc.canUpdateCurrentMap().then((function(){var netmapOperator=dmDv.getActivePage().getNetmapOperator();var lastDv=me.getLastAppliedDataViewExceptById(dmDv,me.getDataViewInfoId(fixedData));dmDv.getJsWrapper().removeAppliedDataViewInfo(fixedData);fixedData.applied=!1;var removedDevices=fixedData.dataViewInfo.dataViewGroup.relativeDevices;netmapOperator.resetDefaultDataView(dataViewCacheSrvc,!1,null,!0).then((function(){lastDv?netmapOperator.applyDv(null,lastDv,(function(event,d,additionalDevices){return me.applyDataView(dmDv,d,additionalDevices)}),removedDevices).then((function(){deferred.resolve()}),(function(){deferred.resolve()})):deferred.resolve()}),(function(){deferred.reject()}))}),(function(){deferred.reject()}));return deferred.promise};this.removeDataViewFromPage=function(dmDv,dv){dmDv.getJsWrapper().removeAppliedDataViewInfo(dv)};this.clearTemporaryDataView=function(dmDv){dmDv.temporaryDataView.applied=!1;dmDv.temporaryDataView.dataViewInfo&&me.removeDataViewFromPage(dmDv,$scope.temporaryDataView)};this.unPreviewInAppliedDataViews=function(dmDv,dvgId){if(dvgId){dmDv.getJsWrapper().getAllAppliedDataViews().filter((function(d){return me.getDataViewInfoId(d)===dvgId})).forEach((function(ele){ele.isPreview=!1}))}};this.setPinMode=function(dmDv){dmDv.getActivePage().setDisplayMode("pinMode")};this.applyDv=function(dmDv,data){if((data=data.value||data).type===me.Const.DataViewType.temporary)return $q.resolve();me.clearTemporaryDataView(dmDv);if(data.isPreview){data.isPreview=!1;data.isSelectForce=!0;me.unPreviewInAppliedDataViews(dmDv,me.getDataViewInfoId(data))}me.setPinMode(dmDv);return dmDv.getActivePage().getNetmapOperator().applyDv(null,data,(function(event,d,additionalDevices){return me.applyDataView(dmDv,d,additionalDevices)}))};this.applyDataViewForSelectItem=function(dmDv,data){var lastDV=dmDv.getJsWrapper().getExtendDataViewData().dataViewId;var promise=null;if(lastDV&&me.isPreview(dmDv,lastDV)||me.isTemporaryDataView(dmDv,lastDV)){me.addDataViewToPage(dmDv,data);promise=me.clearAllDataViews(!1,me.getDataViewInfoId(data))}data.applied=!1;if(!0===data.applied){data.applied=!1;data.isPreview=!1;me.removeDataView(dmDv,data).then((function(){me.refreshDataViewConsolePane()}))}else if(promise)promise.then((function(){data.applied=!0;me.addDataViewToPage(dmDv,data);me.applyDv(dmDv,data)}),(function(){removeDataViewFromPage(data)}));else{data.applied=!0;me.addDataViewToPage(dmDv,data);me.applyDv(dmDv,data)}$rootScope.$emit(NetBrain.Map.Event.DataViewChanged)};this.closeAlertMessageConsolePane=function(dmDv){var activePage=dmDv.getActivePage();if(activePage&&activePage.getCurrentScope){var consolePaneEvent=netBrain.Runbook.AlertMes.ConsolePaneEvent;activePage.getCurrentScope().$emit(consolePaneEvent.onCloseAllAlertMessage)}$rootScope.$emit(netBrain.Map.Event.CloseAllFloatDialog)};this.makeSureDVApplied=function(dmDv,data){var deferred=$q.defer();me.clearAllDataViews(dmDv,!0,me.getDataViewInfoId(data)).then((function(){me.addDataViewToPage(dmDv,data);me.applyDv(dmDv,data).then((function(){deferred.resolve()}),(function(reason){deferred.reject(reason)}))}));return deferred.promise};this.tryEntryEditMode=function(dmDv,data){dmDv.emitMinPanel();var netmap=dmDv.getActivePage();var netmapCtrl=netmap.getCurrentScope();var enabledDevList=[];_.each(netmap._getAllDevices(!0),(function(device){_.contains(data.dataViewInfo.dataViewGroup.relativeDevices,device.getKey())&&device.isContainsDataViewId(me.getDataViewInfoId(data))&&enabledDevList.push(device.getKey())}));netmapCtrl.enterDataViewEditMode(data.dataViewInfo,data.dataViewInfo.dataViewGroup.relativeDevices,enabledDevList)};this.getAppliedDataViews=function(dmDv){return _.filter(dmDv.dataList,(function(d){return!(!d.applied&&!d.isPreview)}))};this.consoleDataView=function(dmDv,dv){var activePage=dmDv.getActivePage();var dvs=me.getAppliedDataViews(dmDv);var dataViewTabData={};0==dvs.length&&dvs.push(dv);dvs&&dvs.length>0&&(dataViewTabData=_.map(dvs,(function(d){return{id:me.getDataViewInfoId(d),name:d.name,type:2}})));var consolePaneEvent=netBrain.Runbook.AlertMes.outputConsolePaneEvent;activePage.getCurrentScope().$emit(consolePaneEvent.onShowOutputConsoleMessage,{onlyShowDataview:!0,actionTaskTitle:"All Apply Data Views",dataviewTabs:dataViewTabData})};this.getDataViewPanelData=function(dmDv){var deferred=$q.defer();var mapId=dmDv.getActivePage().getDocId();var devIdList=dmDv.getActivePage()._getAllDevices(!0).map((function(item){return item.getKey()}));httpDataViewInfoMgrSrvc.getDataViewPanelData(devIdList,mapId).then((function(data){deferred.resolve()}));return deferred.promise};this.saveAsNewDataViewGroup=function(dmDv){var defer=$q.defer();var activeMap=dmDv.getActivePage();var devices=activeMap._getAllDevices();devices.forEach((function(device){device._netmap&&delete device._netmap}));var _mapInfo={mapId:activeMap.getDocId(),devices:devices};_mapInfo.saveWithData=!0;$uibModal.open({templateUrl:"modules/nbDataView/views/EditDataView/createMapDataViewDialog.html",controller:"nb.dataview.createMapDataViewDialogCtrl",windowClass:"dataview-definition-dialog-modal",backdrop:"static",resolve:{mapInfo:function(){return _mapInfo}}}).result.then((function(savedDataView){defer.resolve(!0)}),(function(){defer.reject()}));return defer.promise};this.onHighLightDevices=function(dmDv,data){dmDv.getActivePage().getNetmapOperator().highLightDevices(null,data)};this.onConsoleDataView=function(dmDv,data){me.closeAlertMessageConsolePane(dmDv);updateMapSrvc.canUpdateCurrentMap().then((function(){me.makeSureDVApplied(dmDv,data).then((function(){me.consoleDataView(dmDv,data)}),(function(reason){console.error(reason)}))}))};this.onEditDataView=function(dmDv,data){me.closeAlertMessageConsolePane(dmDv);updateMapSrvc.canUpdateCurrentMap().then((function(){me.makeSureDVApplied(dmDv,data).then((function(){me.tryEntryEditMode(dmDv,data)}),(function(reason){console.error(reason)}))}))};this.onSelectDefaultDataView=function(dmDv){me.clearAllDataViews(dmDv,!1,null).then((function(){me.refreshDataViewConsolePane()}))};this.checkDataView=function(dmDv,data){var defer=$q.defer();dataViewPanelHttpSrvc.refreshDataView(data.ID,1e3).then((function(objDv){if(objDv&&objDv.dataViewGroup){var devIdMap={};dmDv.getActivePage()._getAllDevices(!0).map((function(item){return item.getKey()})).forEach((function(eleId){devIdMap[eleId]=1}));objDv.deviceList&&objDv.deviceList.some((function(ele){return devIdMap[ele.ID]}))?defer.resolve(!0):defer.reject(me.Const.ErrDVNotMatch)}else defer.reject(me.Const.ErrDVNotExist)}),(function(err){defer.reject(me.Const.ErrDVNotExist)}));return defer.promise};this.onSelectDataView=function(dmDv,data){if(!data.isProcessing){data.isProcessing=!0;$timeout((function(){data.isProcessing=!1}),500);me.checkDataView(dmDv,data).then((function(){me.onSelectDataViewInner(dmDv,data)}),(function(err){nbAlertSrvc.error(err).then((function(){$rootScope.$emit("nbGEventRefreshDataView",{sdv:1})}))}))}};this.onSelectDataViewInner=function(dmDv,data){if(me.getDvgId(dmDv.getActivePage())!=data.ID){$rootScope.$emit("closeCacheLiveRunBox");updateMapSrvc.canUpdateCurrentMap().then((function(){dmDv.getActivePage().getNetmapOperator().resetDefaultDataView(dataViewCacheSrvc,!1,null).then((function(){me.applyDataViewForSelectItem(dmDv,data)}),(function(){}))}))}};this.onSelectDVTemplate=function(dmDv,_template,option){if(me.runApplyDVT)setTimeout((function(){me&&(me.runApplyDVT=!1)}),500);else{me.runApplyDVT=!0;setTimeout((function(){me&&(me.runApplyDVT=!1)}),500);me.goApplyDVTemplate(_template,option)}};this.goApplyDVTemplate=function(_template,option){dataViewPanelHttpSrvc.getDvtById(_template.ID).then((function(template){if(template)if(!0!==window.isInIframe||1!==template.defaultDataSource.type)if(_.some(template.variables,(function(v){return 5===v.type})))dataviewTemplateTaskNodeSrvc.openInputOptionDialog(template).then((function(dvt){option&&nbPLM.Common.isObject(option)&&nbPLM.Common.merge(dvt,option);$rootScope.$broadcast("getDataViewFromDVT",dvt)}));else{option&&nbPLM.Common.isObject(option)&&nbPLM.Common.merge(template,option);$rootScope.$broadcast("getDataViewFromDVT",template)}else nbAlertSrvc.embedMapAlert("Cannot apply this Data View template via live network. You can change the template Data Source to cache data and apply again.");else nbAlertSrvc.error(nbPLM.Common.sprintf(me.Const.ErrDVTNotExist,template.name))}),(function(err){nbAlertSrvc.error(nbPLM.Common.sprintf(me.Const.ErrDVTNotExist,_template.name))}))};this.isDVTApplied=function(dmDv,dvt){return(dmDv.getActivePage().getApplyDataViewTemplate()||[]).some((function(eleTmpl){return eleTmpl.ID===dvt.ID||eleTmpl._id===dvt.ID}))};this.getDataSource=function(){var dataSource={};dataSource.DataPoint=new Date;dataSource.SourceType="0";return dataSource};this.refreshDataViewConsolePane=function(){$rootScope.$broadcast(ConsolePaneEvent.REFRESH_DATA_VIEW_CONSOLE_PANE)};this.getMaxTime=function(dt1,dt2){if(dt1&&dt2){return new Date(dt1).getTime()>new Date(dt2).getTime()?dt1:dt2}return dt1||dt2};this.openModelessPreview=function(node,type,context,event){var gid="modelessPreview"+nbPLM.nbParserLibCM.getGUID();var data={node:node,nodeData:node.data,context:context,type:type,gid:gid,dispEmbedded:!0};dialogService.open(data.gid,"dataViewModelessPreview.html",{data:data,scope:{}},{minWidth:464,autoOpen:!1,resizable:!1,position:{my:"left top",at:"right top",of:event},appendTo:"body",draggable:{handle:".modal-header",containment:".main-ui-container .container-body",cancel:".dataview-preview-popup-inner"},close:function(_gid){me.closeModelessPreview(_gid)}})};this.closeModelessPreview=function(gid){gid&&dialogService.close(gid)}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dataViewPanelCtrl",nbController);nbController.$inject=["$q","$interval","$scope","$filter","$uibModal","$document","$timeout","$rootScope","$compile","nb.dataview.dataViewPanelSrvc","nb.qmap.mapManagerSrvc","nb.dataview.dataViewPanelHttpSrvc","nb.qapp.qappResultSrvc"];function nbController($q,$interval,$scope,$filter,$uibModal,$document,$timeout,$rootScope,$compile,dataViewPanelSrvc,mapManagerSrvc,dataViewPanelHttpSrvc,qappResultSrvc){$scope.dataWrapper={dynamicOne:{bDeviceChange:!1,index:0,data:null},staticOne:{bDeviceChange:!1,index:0,data:null}};$scope.dmDv={dynamicOne:{iSign:0,id:""},staticOne:{iSign:0,id:""},temporaryDataView:{applied:!1,show:!1,dataViewInfo:null,type:"temporary",name:"Temporary"},updatedDvg:{},dataViewList:[],dataViewDeviceMapping:[],mapInfo:{mapId:"",mapPageId:"",jswrapper:null,activePage:null},arrDvts:[],devIdList:[],getActivePage:getActivePage,getJsWrapper:getJsWrapper,prepareStaticDV:prepareStaticDV,getCurRunbookId:function(){var qMap=$scope.mapPageObj?$scope.mapPageObj.getParentQmap():null;return qMap?qMap.currentRunbook?qMap.currentRunbook._id:qMap.getDocId():void 0},emitMinPanel:function(){$scope.$parent.minPanel()}};$scope.dataModel={name:dataViewPanelSrvc.Const.name,dataViewOp:dataViewPanelSrvc.Const.DataViewOp,tabGroup:{current:"dynamic",data:[{name:"dynamic",dispName:"Dynamic Data View"},{name:"static",dispName:"Static Data View",iSign:0,id:""}]},bDisableAutoRefresh:!1};$scope.$watch("dataModel.dataViewOp.index",(function(newVal,oldVal){newVal>0&&newVal!=oldVal&&dataViewPanelSrvc.onDataViewOp($scope.dataModel,$scope.dmDv)}));$scope.onSwitchTab=function(tab){dataViewPanelSrvc.onSwitchTab($scope.dataModel,tab)};$scope.getAllDevicesBriefInPage=function(){return dataViewPanelSrvc.getAllDevicesBriefInPage($scope.dmDv)};$scope.prepareStaticDV=function(){return prepareStaticDV()};function prepareStaticDV(){var mapPageId=getActivePage().getDocId();var devIdList=getActivePage()._getAllDevices(!0).map((function(item){return item.getKey()}));$scope.dmDv.devIdList=devIdList;return{mapPageId:mapPageId,devIdList:devIdList}}function getActivePage(){return mapManagerSrvc.getActivePage()}function getJsWrapper(){return mapManagerSrvc.getActivePage().getNetMapJsWrapper()}var updateStaticDataView=$rootScope.$on("nbGEventUpdateDataView",(function(event,dvgId){dvgId?dataViewPanelHttpSrvc.refreshDataView(dvgId).then((function(data){if(data&&data.dataViewGroup&&data.dataViewGroup.lastUpdateTime){$scope.dmDv.updatedDvg[dvgId]=data.dataViewGroup.lastUpdateTime;$scope.$broadcast("nbEventUpdateDataView");dataViewPanelSrvc.isCurrentPage($scope.dmDv)&&refreshDataview(dvgId,data.dataViewGroup.name,data.dataViewGroup.lastUpdateTime)}})):dataViewPanelSrvc.isCurrentPage($scope.dmDv)&&refreshDataview()}));function refreshDataview(dvgId,dvgName,lastUpdateTime){var extendData=mapManagerSrvc.getActivePage().getNetMapJsWrapper().getExtendData();if(extendData&&extendData.extendDataViewData&&extendData.extendDataViewData.dataViewId)if(dvgId&&dvgId==extendData.extendDataViewData.dataViewId){extendData.extendDataViewData.dataViewName=dvgName;extendData.extendDataViewData.lastUpdateTime=lastUpdateTime;$rootScope.$emit(NetBrain.Map.Event.DataViewChanged)}else dvgId||dataViewPanelHttpSrvc.refreshDataView(extendData.extendDataViewData.dataViewId).then((function(data){if(data&&data.dataViewGroup&&data.dataViewGroup.lastUpdateTime){extendData.extendDataViewData.dataViewName=data.dataViewGroup.name;extendData.extendDataViewData.lastUpdateTime=data.dataViewGroup.lastUpdateTime;$rootScope.$emit(NetBrain.Map.Event.DataViewChanged)}}))}var maxPanel=$rootScope.$on(MapTabEvent.MAX_PANEL,(function(event,option){if("Data View"===option.key){netBrain.Map.currentActiveMap.setInstantRunbookOpend(!1);netBrain.Map.currentActiveMap.setRBAOpend(!1);netBrain.Map.currentActiveMap.setDataViewOpend(!0);netBrain.Map.currentActiveMap.setInstantQappOpend(!1)}}));function cancelRefreshDV(){var dm=$scope.dataModel;if(dm.tmDelay){$timeout.cancel(dm.tmDelay);dm.tmDelay=null}}function prepareRefreshDV(indexFrom){var dm=$scope.dataModel;if(!$scope.dataModel.bDisableAutoRefresh&&dataViewPanelSrvc.isCurrentPage($scope.dmDv)){cancelRefreshDV();dm.tmDelay=$timeout((function(){!function(indexFrom){$scope.dataWrapper.dynamicOne.bDeviceChange=!0;$scope.dataWrapper.dynamicOne.index++;$scope.dataWrapper.dynamicOne.indexFrom=indexFrom;$scope.dataWrapper.staticOne.bDeviceChange=!0;$scope.dataWrapper.staticOne.index++;cancelRefreshDV()}(indexFrom)}),500)}}var beginPathCalc=$scope.$on("beginPathCalc",(function(event,data){dataViewPanelSrvc.isCurrentPage($scope.dmDv)&&($scope.dataModel.bDisableAutoRefresh=!0)}));var endPathCalc=$scope.$on("endPathCalc",(function(event,data){if(dataViewPanelSrvc.isCurrentPage($scope.dmDv)){$scope.dataModel.bDisableAutoRefresh=!1;prepareRefreshDV("endPathCalc")}}));var pathSearchStop=$scope.$on("pathSearchStop",(function(event,data){if(dataViewPanelSrvc.isCurrentPage($scope.dmDv)){$scope.dataModel.bDisableAutoRefresh=!1;prepareRefreshDV("pathSearchStop")}}));var refreshDataViewList_token=$rootScope.$on(NetBrain.Map.Event.ModelDataArrayChanged,(function(event,isrefresh){prepareRefreshDV("ModelDataArrayChanged")}));var refreshDataViewList_token2=$rootScope.$on("nbGEventRefreshDataView",(function(event,arg){if(!$scope.dataModel.bDisableAutoRefresh&&dataViewPanelSrvc.isCurrentPage($scope.dmDv)){if(!arg||arg.dvt){$scope.dataWrapper.dynamicOne.bDeviceChange=!0;$scope.dataWrapper.dynamicOne.index++;$scope.dataWrapper.dynamicOne.indexFrom=void 0}if(!arg||arg.sdv){$scope.dataWrapper.staticOne.bDeviceChange=!0;$scope.dataWrapper.staticOne.index++}}}));var clearAllDataViews_token=$rootScope.$on("clearAllDataViews",(function(){dataViewPanelSrvc.isCurrentPage($scope.dmDv)&&dataViewPanelSrvc.onClearAllDataView($scope.dmDv)}));var saveAsDataView_token=$rootScope.$on("saveAsDataView",(function(){dataViewPanelSrvc.isCurrentPage($scope.dmDv)&&dataViewPanelSrvc.onSaveAsDataView($scope.dmDv,$scope.dataWrapper)}));$scope.$on("$destroy",(function(){updateStaticDataView();maxPanel();refreshDataViewList_token();refreshDataViewList_token2();clearAllDataViews_token();saveAsDataView_token();beginPathCalc();endPathCalc();pathSearchStop();cancelRefreshDV()}));window.nbPLM.Common.delayRun((function(arg){if(arg.scope.mapPageObj){var dmDv=arg.scope.dmDv;var qmap=arg.scope.mapPageObj.getParentQmap();dmDv.mapInfo.mapId=qmap.getDocId();dmDv.mapInfo.mapPageId=arg.scope.mapPageObj.getDocId();getActivePage();getJsWrapper();if(dataViewPanelSrvc.isCurrentPage($scope.dmDv)){var dm=arg.scope.dataModel;var objUrl=qappResultSrvc.parseURL(window.document.URL);var rbaId=objUrl&&objUrl.params.rba||"";var dvtId=objUrl&&objUrl.params.dsdvt||"";var dvgId=objUrl&&objUrl.params.dsdvg||"";arg.scope.defaultSelectedDataViewTemplateId&&(dvtId=arg.scope.defaultSelectedDataViewTemplateId);arg.scope.defaultSelectedDataViewGroupId&&(dvgId=arg.scope.defaultSelectedDataViewGroupId);if(rbaId||netBrain.Map.MapArgs&&netBrain.Map.MapArgs.hideDataViewTab){if(dvtId){dm.tabGroup.current="dynamic";dmDv.dynamicOne.iSign++;dmDv.dynamicOne.id=dvtId;dmDv.dynamicOne.apply=!0}else if(dvgId){dm.tabGroup.current="static";dmDv.staticOne.iSign++;dmDv.staticOne.id=dvgId;dmDv.staticOne.apply=!0}}else{if(dvtId){dm.tabGroup.current="dynamic";dmDv.dynamicOne.iSign++;dmDv.dynamicOne.id=dvtId;dmDv.dynamicOne.apply=!0}else if(dvgId){dm.tabGroup.current="static";dmDv.staticOne.iSign++;dmDv.staticOne.id=dvgId;dmDv.staticOne.apply=!0}else if(arg.scope.mapPageObj._netmapJsWrapper){var extendData=arg.scope.mapPageObj._netmapJsWrapper.getExtendData();if(extendData.extendDataViewTemplateData&&extendData.extendDataViewTemplateData.dataViewTemplateId){dm.tabGroup.current="dynamic";dmDv.dynamicOne.iSign++;dmDv.dynamicOne.id=extendData.extendDataViewTemplateData.dataViewTemplateId}else if(extendData.extendDataViewData&&extendData.extendDataViewData.dataViewId&&"dvgScopeGlobal"==extendData.extendDataViewData.dataViewGroupScope){dm.tabGroup.current="static";dmDv.staticOne.iSign++;dmDv.staticOne.id=extendData.extendDataViewData.dataViewId}}$scope.onOpenTab("Data View")}netBrain.Map.MapArgs&&delete netBrain.Map.MapArgs.hideDataViewTab}return!0}return!1}),{scope:$scope},20,20)}}(NetBrain);!function(netBrain){angular.module("nb.dataview").service("nb.dataview.dynamicDataViewSrvc",nbService);nbService.$inject=["$uibModal","$filter","$q","$timeout","nb.ng.nbHttp","nb.dataview.dataViewPanelHttpSrvc","nb.dataview.dataViewPanelSrvc","nb.netbrain.httpSystemSettingSrvc"];function nbService($uibModal,$filter,$q,$timeout,nbHttp,dataViewPanelHttpSrvc,dataViewPanelSrvc,httpSystemSettingSrvc){var me=this;this.Const={Dvt:[{mapId:"",appliedDvts:[]}],doNothing:function(){}};me.BuiltInCollapseStatus=null;this.hasAppliedDvt=function(mapPageObj,dvtId){var dvtRunbookNodeMgrSrvc=null;try{dvtRunbookNodeMgrSrvc=angular.element(document).injector().get("nb.runbook.dvtRunbookNodeMgrSrvc")}catch(ex){console.warn(ex)}var bRet=!1;var qmap=mapPageObj.getParentQmap();var mapId=qmap.getDocId();var curRunbook=qmap.currentRunbook;var rbId=curRunbook&&curRunbook._id?curRunbook._id:mapId;if(dvtRunbookNodeMgrSrvc){bRet=dvtRunbookNodeMgrSrvc.getRunbookNodeId(dvtId,rbId);if(nbPLM.Common.isObject(bRet)){bRet.runbookId=rbId;bRet.dvtId=dvtId}}return bRet};this.hasAppliedDvtEx=function(mapPageObj,dvtId){var bRet=!1;var qmap=mapPageObj.getParentQmap();var mapId=qmap.getDocId();var curRunbook=qmap.currentRunbook;var rbId=curRunbook&&curRunbook._id?curRunbook._id:mapId;var curMap=null;me.Const.Dvt.some((function(ele){if(ele.mapId==mapId){curMap=ele;return!0}}));curMap&&curMap.appliedDvts.some((function(ele){if(ele.dvtId==dvtId&&ele.rbId==rbId){bRet=ele;return!0}}));return bRet};this.addAppliedDvt=function(mapPageObj,dvtId,argData){return null};this.clearAppliedDvt=function(){me.Const.Dvt=[]};this.onInit=function(dm,dataWrapper){if(!dataWrapper.dynamicOne.bDeviceChange&&dataWrapper.dynamicOne.data)me.initFromLocal(dm,dataWrapper);else{dataWrapper.dynamicOne.bDeviceChange=!1;me.initTree(dm,dataWrapper)}};this.onSearch=function(dm,bForce){var iMaxLevel=0;var expendMap={};if(dm.filter.search1){var strSearch=dm.filter.search1.trim().toLowerCase();dm.treeMgr.tranverse((function(node,arg){node.data.isDefault?node.bHide=!1:node.data.name.toLowerCase().indexOf(strSearch)>=0?node.bHide=!1:node.bHide=!0}),dm);dm.treeMgr.tranverse((function(node,arg){if(node.level>=1&&!node.bHide){var curNode=node;var iCC=0;for(;iCC<30&&curNode;){curNode.bHide=!1;curNode.child&&(curNode.expended=!0);curNode=dm.treeMgr.getParent(curNode);iCC++}}}),dm)}else{dm.treeMgr.tranverse((function(node,arg){node.bHide=!1}),dm);dm.treeMgr.tranverse((function(node,arg){if(node.level>=1&&!node.bHide){var curNode=node;var iCC=0;for(;iCC<30&&curNode;){curNode.bHide=!1;curNode.child&&bForce&&(curNode.expended=!0);curNode=dm.treeMgr.getParent(curNode);iCC++}}}),dm)}dm.treeMgr.tranverse((function(node,arg){if(node.expended&&!node.bHide){expendMap[node.id]=!0;node.level>iMaxLevel&&(iMaxLevel=node.level)}}),dm);$timeout((function(){nbPLM.Common.tryNTimes($timeout,iMaxLevel,(function(nTimes){dm.treeMgr.tranverse((function(node){node.level==iMaxLevel-nTimes&&(node.expended=expendMap[node.id]||!1)}))}))}));dm.treeMgr.tree.length<=1||dm.treeMgr.tree.filter((function(ele){return!ele.bHide})).length<=1?dm.refData.noData=!0:dm.refData.noData=!1};this.onRefresh=function(dm,option){me.initTree(dm,dm.dataWrapper,option)};this.wrapNode=function(dm,node){node.fn=dm.tree.fn;node.refVars=dm.tree.refVars;node.refVars.dm=dm;node.tree=dm.tree;return node};this.onSelectNode=function(dm,node,event,bNoApply){dm.refData.selNode=node;dm.treeMgr.expend(dm.treeMgr.getParent(node));dm.tree.selNodeData=node.data;if(!bNoApply)if(node.data.isDefault){me.hidePreview(dm);dataViewPanelSrvc.onSelectDefaultDataView(dm.dmDv)}else node.data.isFolder?me.hidePreview(dm):me.showPreview(dm,node,event)};this.showPreview=function(dm,node,event){if(!dm.tmDelay&&event&&event.target){var $node=null;$node=nbPLM.Common.ancestorHasClass($(event.target),"ivh-treeview-node-leaf",10);var $anchor=$("#"+dm.gidAnchor);var top=$node.offset().top-$node.offsetParent().offset().top;$anchor.css("top",top);dm.tmDelay=$timeout((function(){dataViewPanelSrvc.openModelessPreview(node,"dvt",{mapPageObj:dm.dmDv.getActivePage(),dmDv:dm.dmDv},$anchor);dm.tmDelay=null}),500)}};this.hidePreview=function(dm){if(dm.tmDelay){$timeout.cancel(dm.tmDelay);dm.tmDelay=null}dm.isShowPreview=!1};this.onDblClickNode=function(dm,node){if(node.data.isDefault){me.hidePreview(dm);dataViewPanelSrvc.onSelectDefaultDataView(dm.dmDv)}else if(node.data.isFolder)me.hidePreview(dm);else{me.hidePreview(dm);dataViewPanelHttpSrvc.getDvtApplyCondition(dataViewPanelSrvc.getCurRunbookId(dm.dmDv),node.data.path).then((function(data){dataViewPanelSrvc.onSelectDVTemplate(dm.dmDv,node.data,me.hasAppliedDvt(dm.dmDv.getActivePage(),node.data.ID))}));me.addAppliedDvt(dm.dmDv.getActivePage(),node.data.path)}};this.sortAll=function(treeMgr){treeMgr.sortAll(dataViewPanelSrvc.Const.fnSortNode)};this.sortNode=function(treeMgr,node){treeMgr.sortChild(node,dataViewPanelSrvc.Const.fnSortNode)};this._initTree=function(dm,bForce){dm.tree.browseTree=dm.treeMgr.tree;dm.treeMgr.tranverse((function(node,arg){me.wrapNode(arg,node)}),dm);me.sortAll(dm.treeMgr);var pNode=null;if(dm.dmDv&&1==dm.dmDv.dynamicOne.iSign){dm.dmDv.dynamicOne.id&&(pNode=dm.treeMgr.getNodeByFn((function(eleNode){return eleNode.data.ID===dm.dmDv.dynamicOne.id})));pNode&&dm.dmDv.dynamicOne.apply&&me.onDblClickNode(dm,pNode);dm.dmDv.dynamicOne.iTryTimes>=1?dm.dmDv.dynamicOne.iTryTimes++:dm.dmDv.dynamicOne.iTryTimes=1;if(!pNode&&dm.dmDv.dynamicOne.apply&&dm.dmDv.dynamicOne.iTryTimes<=2)me.Const.doNothing();else{dm.dmDv.dynamicOne.apply=!1;dm.dmDv.dynamicOne.iSign=2}}pNode||(pNode=dm.refData.selNode&&dm.treeMgr.getNodeByFn((function(eleNode){return eleNode.data.sid===dm.refData.selNode.data.sid}))||null);if(pNode){me.onSelectNode(dm,pNode,null,!0);var nodeArr=dm.treeMgr.getPath(pNode.id);var iMaxLevel=nodeArr.length;nbPLM.Common.tryNTimes($timeout,iMaxLevel,(function(nTimes){nodeArr.length>=2&&(nodeArr.shift().expended=!0)}))}else me.onSelectNode(dm,dm.treeMgr.tree[0],null,!0);me.onSearch(dm,bForce)};this.initFromLocal=function(dm,dataWrapper){dm.treeMgr=dataWrapper.dynamicOne.data.treeMgr;dm.refData=dataWrapper.dynamicOne.data.refData;dm.filter=dataWrapper.dynamicOne.data.filter;me._initTree(dm)};this.initTree=function(dm,dataWrapper,option){if(dataWrapper.dynamicOne.data){dm.refData=dataWrapper.dynamicOne.data.refData;dm.filter=dataWrapper.dynamicOne.data.filter}var devBrief=dataViewPanelSrvc.getAllDevicesBriefInPage(dm.dmDv);var dtNow=(new Date).getTime();if(!(dataWrapper.dynamicOne.devBrief&&option&&option.indexFrom&&dataWrapper.dynamicOne.mdtLastGet&&dtNow-dataWrapper.dynamicOne.mdtLastGet<6e4&&devBrief&&JSON.stringify(dataWrapper.dynamicOne.devBrief)==JSON.stringify(devBrief))){dataWrapper.dynamicOne.devBrief=devBrief;dataWrapper.dynamicOne.mdtLastGet=dtNow;dataViewPanelHttpSrvc.getRecommendDvTemplate(devBrief).then((function(data){var tData=dataViewPanelHttpSrvc.filterDvt(data);if(option&&option.bTrigger){var curArr=[];dm.treeMgr.tranverse((function(node,arg){curArr.push({sid:node.data.sid,psid:node.data.psid,name:node.data.name,lastScheduleTime:node.data.lastScheduleTime||void 0})}),dm);var newArr=[];tData.forEach((function(nodeData){newArr.push({sid:nodeData.sid,psid:nodeData.psid,name:nodeData.name,lastScheduleTime:nodeData.lastScheduleTime||void 0})}));if(newArr.length==curArr.length){newArr.sort((function(ele1,ele2){return ele1.sid>ele2.sid?1:-1}));curArr.sort((function(ele1,ele2){return ele1.sid>ele2.sid?1:-1}));if(JSON.stringify(newArr)==JSON.stringify(curArr))return}}dm.treeMgr=new window.nbPLM.TreeManager(tData,{idName:"sid",pidName:"psid",childName:"child",isArray:!0});dataWrapper.dynamicOne.data={};dataWrapper.dynamicOne.data.refData=dm.refData;dataWrapper.dynamicOne.data.filter=dm.filter;dataWrapper.dynamicOne.data.treeMgr=dm.treeMgr;me._initTree(dm,!0);null===me.BuiltInCollapseStatus?httpSystemSettingSrvc.getSystemSetting("BuildInDVTcollapseStatus").then((function(status){me.BuiltInCollapseStatus="true"===status}),(function(reason){console.warn(reason)})).then((function(){collapseBuildInFolder(dm.tree.browseTree)})):collapseBuildInFolder(dm.tree.browseTree)}),(function(err){console.warn(err)}))}};function collapseBuildInFolder(tree){me.BuiltInCollapseStatus&&$timeout((function(){var builtInTreeNode=_.find(tree,(function(t){return"Built-in Data View Templates"===t.data.name}));builtInTreeNode&&(builtInTreeNode.expended=!1)}))}}}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dynamicDataViewCtrl",nbController);nbController.$inject=["$q","$interval","$scope","$filter","$uibModal","$document","$timeout","$rootScope","$compile","nb.dataview.dynamicDataViewSrvc","nb.dataviewtemplate.drillDownActionCommonSrvc","nb.dataview.dataViewPanelSrvc","nb.common.nbAlertSrvc","nb.uiframework.urlStateMgr"];function nbController($q,$interval,$scope,$filter,$uibModal,$document,$timeout,$rootScope,$compile,dynamicDataViewSrvc,drillDownActionCommonSrvc,dataViewPanelSrvc,nbAlertSrvc,urlStateMgr){var strGid=nbPLM.nbParserLibCM.getGUID();$scope.dataModel={bInit:!1,dmDv:$scope.dmDv,dataWrapper:$scope.dataWrapper,filter:{search:"",search1:""},treeMgr:null,gidTree:strGid+"-tree",gidAnchor:strGid+"-anchor",gidAnchor2:strGid+"-anchor2",refData:{noData:!1,selNode:null},tree:{nodeEditPrefix:strGid,browseTree:[],selNodeData:null,ivhTreeOptions:{defaultSelectedState:!1,validate:!0,expandToDepth:0,idAttribute:"id",childrenAttribute:"child",expandedAttribute:"expended",useCheckboxes:!0,twistieLeafTpl:""},fn:{onSelectNode:function(node,e){e&&e.target&&nbPLM.Common.ancestorHasClass($(e.target),"nb-tree-node-open-close-toggle",5)&&(node.expended=!node.expended);dynamicDataViewSrvc.onSelectNode($scope.dataModel,node,e,!1)},onDblClick:function(node,e){dynamicDataViewSrvc.onDblClickNode($scope.dataModel,node)},onAsyncShowTip:function(node,isShow,e){var dm=$scope.dataModel;var $node=null;$node=nbPLM.Common.ancestorHasClass($(e.target),"ivh-treeview-node-leaf",10);var $anchor=$("#"+dm.gidAnchor2);var top=$node.offset().top-$node.offsetParent().offset().top;$anchor.css("top",top);if(isShow&&!node.data.lastScheduleTime){dm.popMgr.asyncShow(node.data,1800);dm.previewPop.placement="right"}else dm.popMgr.hide(node.data)},onShowTip:function(node,isShow){var dm=$scope.dataModel;isShow&&!node.data.lastScheduleTime?dm.popMgr.show(node.data):dm.popMgr.hide(node.data)},onPreview:function(e,node){drillDownActionCommonSrvc.openPreviewResource({path:node.data.path},"dvt","Preview - "+node.data.name)}},refVars:{dm:$scope.dataModel}},popMgr:new nbPLM.MouseOverPopupManager({nShow:"isShowPreview",nId:"sid",onShow:function(){$timeout()},onHide:function(){$timeout()}}),previewPop:{tmpl:"dynamicDateViewPreviewPop.html",placement:"bottom-left",data:{actionMenu:[]}},isShowPreview:!1,tmDelay:null};$scope.onPressEnter=function(e){var dm=$scope.dataModel;if(13===e.keyCode){dm.filter.search1=dm.filter.search;dynamicDataViewSrvc.onSearch($scope.dataModel,!0)}};$scope.openDVTManager=function(event){urlStateMgr.switchTabOrOpenNewTab(NetBrain.NG.Const.PageType.DataViewTemplate,NetBrain.NG.Const.PageType.DataViewTemplate,(function(){urlStateMgr.openNewTab(NetBrain.NetworkOS.Const.UIFramework.UrlTemplate.DataViewTemplate,"_blank")}))};$scope.onChangeFilter=function(){var dm=$scope.dataModel;if(!dm.filter.search&&dm.filter.search1!=dm.filter.search){dm.filter.search1=dm.filter.search;dynamicDataViewSrvc.onSearch($scope.dataModel,!0)}};$scope.onClearSearch=function(){var dm=$scope.dataModel;dm.filter.search="";if(dm.filter.search1!=dm.filter.search){dm.filter.search1=dm.filter.search;dynamicDataViewSrvc.onSearch($scope.dataModel,!0)}};$scope.onRefresh=function(){$scope.$parent&&$scope.$parent.dataModel&&($scope.$parent.dataModel.bDisableAutoRefresh=!1);dynamicDataViewSrvc.onRefresh($scope.dataModel)};$scope.$watch("dataWrapper.dynamicOne.index",(function(newVal,oldVal){if(newVal&&newVal!=oldVal&&$scope.dataWrapper.dynamicOne.bDeviceChange){$scope.dataWrapper.dynamicOne.bDeviceChange=!1;var indexFrom=$scope.dataWrapper.dynamicOne.indexFrom;$scope.dataWrapper.dynamicOne.indexFrom=void 0;dynamicDataViewSrvc.onRefresh($scope.dataModel,{bTrigger:!0,indexFrom:indexFrom})}}));$scope.$on("$destroy",(function(){var dm=$scope.dataModel;dm.dmDv=null;dm.dataWrapper=null;dm.popMgr.clearEvent();dm.tmDelay&&$timeout.cancel(dm.tmDelay)}));$scope.$watch((function(){return dataViewPanelSrvc.getCurrentPageId($scope.dmDv)}),(function(newVal,oldVal){if(!$scope.dataModel.bInit&&newVal&&newVal==$scope.dmDv.mapInfo.mapPageId){dynamicDataViewSrvc.onInit($scope.dataModel,$scope.dataWrapper);$scope.dataModel.bInit=!0}}));window.nbPLM.Common.delayRun((function(arg){if(arg.scope.dmDv.mapInfo.mapPageId){if(dataViewPanelSrvc.isCurrentPage(arg.scope.dmDv)){dynamicDataViewSrvc.onInit($scope.dataModel,$scope.dataWrapper);$scope.dataModel.bInit=!0}return!0}return!1}),{scope:$scope},20,20)}angular.module("nb.dataview").controller("nb.dataview.dynamicDataViewPreviewWrapperCtrl",["$q","$scope","$filter","$document","$timeout","nb.dataview.dataViewPanelSrvc","nb.dataview.dynamicDataViewSrvc","nb.common.nbAlertSrvc",function($q,$scope,$filter,$document,$timeout,dataViewPanelSrvc,dynamicDataViewSrvc,nbAlertSrvc){$scope.dmPreview={selects:[],selNode:""};function init(){var dmPreview=$scope.dmPreview;var dmModelData=$scope.model.data;if(dmModelData.nodeData&&dmModelData.nodeData.ID){var hasApplied=dynamicDataViewSrvc.hasAppliedDvt(dmModelData.context.mapPageObj,dmModelData.nodeData.ID);dmPreview.selects=[{nodeId:1,name:"Create New Runbook Node"}];hasApplied&&dmPreview.selects.unshift({nodeId:2,name:"Use Last Runbook Result",data:hasApplied});dmPreview.selNode=dmPreview.selects[0]}}$scope.onSelectNode=function(eleNode){$scope.dmPreview.selNode=eleNode};$scope.$watch("dataModel.tree.selNodeData.path",(function(newVal,oldVal){newVal&&init()}));$scope.onApplyDvt=function(){var dmModelData=$scope.model.data;var dmPreview=$scope.dmPreview;if(dmModelData.nodeData&&dmModelData.nodeData.ID){dataViewPanelSrvc.onSelectDVTemplate(dmModelData.context.dmDv,dmModelData.nodeData,dmPreview.selNode?dmPreview.selNode.data:null);dynamicDataViewSrvc.addAppliedDvt(dmModelData.context.mapPageObj,dmModelData.nodeData.ID)}$scope.onCancel&&$scope.onCancel()};init()}])}(NetBrain);!function(netBrain){angular.module("nb.dataview").service("nb.dataview.staticDataViewSrvc",nbService);nbService.$inject=["$uibModal","$filter","$q","$timeout","$rootScope","nb.ng.nbHttp","nb.dataview.dataViewPanelHttpSrvc","nb.dataview.dataViewPanelSrvc","nb.ng.nbValidationSrvc","nb.common.nbAlertSrvc","nb.dataview.httpDataViewManagerSrvc","nb.ng.deviceAccessCacheSrvc"];function nbService($uibModal,$filter,$q,$timeout,$rootScope,nbHttp,dataViewPanelHttpSrvc,dataViewPanelSrvc,nbValidationSrvc,nbAlertSrvc,httpDataViewManagerSrvc,deviceAccessCacheSrvc){var me=this;this.Const={doNothing:function(){},actionMenu:[{title:"New Folder",action:"opNewFolder",show:!0},{title:"Rename",action:"opRenameFolder",show:!0},{title:"Move to...",action:"opMoveFolder",show:!0},{title:"Delete",action:"opDeleteFolder",show:!0},{title:"Edit",action:"opEditFile",show:!0},{title:"Rename",action:"opRenameFile",show:!0},{title:"Move to...",action:"opMoveFile",show:!0},{title:"Open Data View Console",action:"opOpenConsoleFile",show:!0},{title:"Delete",action:"opDeleteFile",show:!0},{title:"",action:"opAddFolder",show:!1},{title:"",action:"opChangeNameFolder",show:!1},{title:"",action:"opMoveFolderTo",show:!1},{title:"",action:"opChangeNameFile",show:!1},{title:"",action:"opMoveFileTo",show:!1}],rootFolderOp:[],folderOp:["opRenameFolder","opMoveFolder"],dataviewOp:["opEditFile","opRenameFile","opMoveFile","opDeleteFile"],deleteOp:["opDeleteFolder"],schedulerId:"907d6a11-3607-4d1e-a173-f10edf585022"};this.onInit=function(dm,dataWrapper){if(!dataWrapper.staticOne.bDeviceChange&&dataWrapper.staticOne.data)me.initFromLocal(dm,dataWrapper);else{dataWrapper.staticOne.bDeviceChange=!1;me.initTree(dm,dataWrapper)}};this.onSearch=function(dm,bForce){var iMaxLevel=0;var expendMap={};dm.treeMgr.tranverse((function(node,arg){if(node.level>=0&&!node.data.isDefault&&!node.data.isFolder){var curNode=node;var iCC=0;for(;iCC<30&&curNode&&!curNode.bMayShow;){curNode.bMayShow=!0;curNode=dm.treeMgr.getParent(curNode);iCC++}}}),dm);if(dm.filter.search1){var strSearch=dm.filter.search1.trim().toLowerCase();dm.treeMgr.tranverse((function(node,arg){node.data.isDefault?node.bHide=!1:node.bMayShow&&node.data.name.toLowerCase().indexOf(strSearch)>=0?node.bHide=!1:node.bHide=!0}),dm);dm.treeMgr.tranverse((function(node,arg){if(node.level>=0&&!node.bHide){var curNode=node;var iCC=0;for(;iCC<30&&curNode;){curNode.bHide=!1;curNode.child&&(curNode.expended=!0);curNode=dm.treeMgr.getParent(curNode);iCC++}}}),dm)}else{dm.treeMgr.tranverse((function(node,arg){node.data.isDefault?node.bHide=!1:node.data.isFolder?node.bHide=!0:node.bHide=!1}),dm);dm.treeMgr.tranverse((function(node,arg){if(node.level>=0&&!node.bHide){var curNode=node;var iCC=0;for(;iCC<30&&curNode;){curNode.bHide=!1;curNode.child&&bForce&&(curNode.expended=!0);curNode=dm.treeMgr.getParent(curNode);iCC++}}}),dm)}dm.treeMgr.tranverse((function(node,arg){if(node.expended&&!node.bHide){expendMap[node.id]=!0;node.level>iMaxLevel&&(iMaxLevel=node.level)}}),dm);$timeout((function(){nbPLM.Common.tryNTimes($timeout,iMaxLevel,(function(nTimes){dm.treeMgr.tranverse((function(node){node.level==iMaxLevel-nTimes&&(node.expended=expendMap[node.id]||!1)}))}))}));dm.treeMgr.tree.length<=1||dm.treeMgr.tree.filter((function(ele){return!ele.bHide})).length<=1?dm.refData.noData=!0:dm.refData.noData=!1};this.onRefresh=function(dm,option){me.initTree(dm,dm.dataWrapper,option)};this.onRefreshNodeData=function(dm,node){node.isDirt=void 0};this.onHighLightDevices=function(dm,node){dataViewPanelSrvc.onHighLightDevices(dm.dmDv,node.data)};this.onNodeOpClick=function(dm,node,op,args){me.preOpCheck(node,op,node.data.accessType,args).then((function(ret){if(ret){var newNode;var pNode;if("opNewFile"===op){newNode=me.newFile(dm,node,args&&args.op||{ext:""});node.expended=!0;newNode.data.accessType=node.data.accessType;newNode.isEdit=!0;newNode.opNext="opAddFile";window.nbPLM.Common.delayRun((function(arg){var ele=document.getElementById(arg.name);if(ele){me.onSelectNode(dm,newNode);ele.focus();return!0}return!1}),{name:dm.tree.nodeEditPrefix+newNode.data.sid},20,20)}else if("opNewFolder"===op){newNode=me.newFolder(dm,node);node.expended=!0;newNode.isEdit=!0;newNode.opNext="opAddFolder";newNode.fileCount=0;window.nbPLM.Common.delayRun((function(arg){var ele=document.getElementById(arg.name);if(ele){me.onSelectNode(dm,newNode);ele.focus();return!0}return!1}),{name:dm.tree.nodeEditPrefix+newNode.data.sid},20,20)}else if("opAddFolder"===op){pNode=dm.treeMgr.getParent(node);try{me.validateNodeName(node,pNode,dm.treeMgr);dataViewPanelHttpSrvc.upInsertDataViewFolder(node.data).then((function(data){node.isEdit=!1;node.opNext=void 0;data&&nbPLM.Common.merge(node.data,data);me.sortNode(dm.treeMgr,dm.treeMgr.getParent(node))}),(function(errMsg){nbAlertSrvc.warning(errMsg.ResultDesc).then((function(){var curEle=document.getElementById(dm.tree.nodeEditPrefix+node.data.sid);if(curEle){curEle.value=curEle.nbOldValue;node.data.name=curEle.value;curEle.focus()}}))}))}catch(ex){nbAlertSrvc.warning(ex).then((function(){var curEle=document.getElementById(dm.tree.nodeEditPrefix+node.data.sid);if(curEle){curEle.value=curEle.nbOldValue;node.data.name=curEle.value;curEle.focus()}}))}}else if("opAddFile"===op)me.checkNewFileName(dm,node.data.name,node).then((function(){node.isEdit=!1;node.opNext=void 0;me.sortNode(dm.treeMgr,dm.treeMgr.getParent(node));node.fn.onSelectNode(node)}),(function(errMsg){nbAlertSrvc.error(errMsg.ResultDesc||errMsg).then((function(){var curEle=document.getElementById(dm.tree.nodeEditPrefix+node.data.sid);if(curEle){curEle.value=curEle.nbOldValue;node.data.name=curEle.value;curEle.focus()}}))}));else if("opRenameFolder"===op||"opRenameFile"===op){node.isEdit=!0;node.opNext="opRenameFile"===op?"opChangeNameFile":"opChangeNameFolder";window.nbPLM.Common.delayRun((function(arg){var ele=document.getElementById(arg.name);if(ele){ele.focus();return!0}return!1}),{name:dm.tree.nodeEditPrefix+node.data.sid},20,20)}else if("opChangeNameFolder"===op){pNode=dm.treeMgr.getParent(node);try{me.validateNodeName(node,pNode,dm.treeMgr);dataViewPanelHttpSrvc.upInsertDataViewFolder(node.data).then((function(){node.isEdit=!1;node.opNext=void 0;node.data.$name=node.data.name;me.sortNode(dm.treeMgr,dm.treeMgr.getParent(node))}),(function(errMsg){nbAlertSrvc.warning(errMsg.ResultDesc).then((function(){var curEle=document.getElementById(dm.tree.nodeEditPrefix+node.data.sid);if(curEle){curEle.value=curEle.nbOldValue;node.data.name=curEle.value;curEle.focus()}}))}))}catch(ex){nbAlertSrvc.warning(ex).then((function(){var curEle=document.getElementById(dm.tree.nodeEditPrefix+node.data.sid);if(curEle){curEle.value=curEle.nbOldValue;node.data.name=curEle.value;curEle.focus()}}))}}else if("opChangeNameFile"===op)node.data.name&&node.data.name.trim()?dataViewPanelHttpSrvc.updateDataViewName(node.data.ID,node.data.name).then((function(){node.isEdit=!1;node.data.$name=node.data.name;node.opNext=void 0;me.sortNode(dm.treeMgr,dm.treeMgr.getParent(node));$rootScope.$broadcast("nbGEventUpdateDataView",node.data.ID)}),(function(errMsg){errMsg&&100001==errMsg.ResultCode&&(errMsg.ResultDesc="Name cannot contain special characters.");nbAlertSrvc.warning(errMsg.ResultDesc).then((function(){var curEle=document.getElementById(dm.tree.nodeEditPrefix+node.data.sid);if(curEle){curEle.value=curEle.nbOldValue;node.data.name=curEle.value;curEle.focus()}}))})):nbAlertSrvc.warning("The data view name cannot be empty.").then((function(){var curEle=document.getElementById(dm.tree.nodeEditPrefix+node.data.sid);if(curEle){curEle.value=curEle.nbOldValue;node.data.name=curEle.value;curEle.focus()}}));else if("opDeleteFolder"===op)dataViewPanelHttpSrvc.deleteDataViewNodes([node.data.ID]).then((function(){$timeout((function(){pNode=dm.treeMgr.getParent(node);dm.treeMgr.deleteNode(node);me.onSelectNode(dm,pNode);me.calculateCountAll(dm.treeMgr)}))}),(function(errMsg){nbAlertSrvc.error(errMsg.ResultDesc)}));else if("opDeleteFile"===op){var confirmOp={message:"Are you sure you want to delete this static data view?",buttons:[{id:NB_CONFIRM_YES,label:"Delete for this Map Only"},{id:NB_CONFIRM_NO,label:"Delete for All Devices"},{id:NB_CONFIRM_CANCEL,label:"Cancel"}]};nbAlertSrvc.confirm(confirmOp).then((function(){httpDataViewManagerSrvc.deleteDeviceDataViewsForDevices(null,node.data.ID,node.data.dataViewInfo.dataViewGroup.relativeDevices).then((function(){dataViewPanelSrvc.removeDataView(dm.dmDv,node.data).then((function(){dataViewPanelSrvc.refreshDataViewConsolePane()}));$timeout((function(){pNode=dm.treeMgr.getParent(node);dm.treeMgr.deleteNode(node);dm.refData.selNode==node&&me.onSelectNode(dm,pNode);me.calculateCountAll(dm.treeMgr);me.onSearch(dm)}))}))}),(function(ret2){2===ret2&&dataViewPanelHttpSrvc.deleteDataViewNodes([node.data.ID]).then((function(){$timeout((function(){pNode=dm.treeMgr.getParent(node);dm.treeMgr.deleteNode(node);dm.refData.selNode==node&&me.onSelectNode(dm,pNode);me.calculateCountAll(dm.treeMgr);me.onSearch(dm)}))}),(function(errMsg){nbAlertSrvc.error(errMsg.ResultDesc)}))}))}else if("opMoveFolder"===op)me.moveNode(dm,node,dm.treeMgr);else if("opMoveFile"===op)me.moveNode(dm,node,dm.treeMgr);else if("opEditFile"===op){me.onSelectNode(dm,node,null,!0);node.isDirt=!0;dataViewPanelSrvc.onEditDataView(dm.dmDv,node.data)}else if("opOpenConsoleFile"===op){me.onSelectNode(dm,node,null,!0);dataViewPanelSrvc.onConsoleDataView(dm.dmDv,node.data)}}}))};this.validateNodeName=function(node,pNode,treeMgr){if(!node.data.name)throw new Error("Please enter a unique folder name.");if(node.data.name.length>128)throw new Error("A folder name can't exceed 128 characters.");if(!nbValidationSrvc.getValidator("generalForbidChars")(node.data.name))throw new Error("Name cannot contain special characters.");var sameNameNode=null;if((pNode?pNode.child:treeMgr.tree).some((function(eleNode){if(eleNode.id!=node.id&&eleNode.data.name==node.data.name){sameNameNode=eleNode;return!0}})))throw new Error(nbPLM.Common.sprintf("A {0} with the same name already exists in the folder.",sameNameNode.data.isFolder?"folder":"file"))};this.moveNode=function(dm,node,treeMgr){var dialogOption={showMenu:!0,beingMovedNode:nbPLM.Common.clone(node.data),option:{filterSchedulerId:me.Const.schedulerId}};return $uibModal.open({templateUrl:"modules/nbDataView/views/nbDataViewTreeModal.html",controller:"nb.dataview.nbDataViewTreeModalCtrl",windowClass:"dataViewTreeModalDialog",backdrop:"static",resolve:{dialogOption:dialogOption}}).result.then((function(data){if(data)if(data.ID==node.data.parentId)nbAlertSrvc.error("There is no point to move to its own parent folder!");else if(node.data.isFolder&&data.ID==node.data.ID)nbAlertSrvc.error("Cannot move a folder to itself!");else{var targetPath=data.path+">"+data.name;var curPath=node.data.path+">"+node.data.name;!node.data.isFolder||targetPath!=curPath&&0!=targetPath.indexOf(curPath+">")?dataViewPanelHttpSrvc.moveDataViewTreeNode(node.data.ID,data.ID).then((function(){var folderNode=treeMgr.getNodeByFn((function(_node){return _node.data.ID==data.ID}));if(folderNode){dm.treeMgr.deleteNode(node);me.refreshNode(dm,treeMgr,folderNode)}else me.onRefresh(dm);$rootScope.$broadcast("nbGEventUpdateDataView",null)}),(function(err){nbAlertSrvc.error(err.ResultDesc)})):nbAlertSrvc.error("Cannot move a folder to its descendant folder!")}}),(function(err){console.warn(err)}))};this.newFolder=function(dm,node){var nodeArr=dm.treeMgr.getPath(node.id);var newNode={name:"Folder",sid:window.nbPLM.nbParserLibCM.getGUID(),isFolder:!0,parentId:node.data.ID,path:">>"+nodeArr.map((function(eleNode){return eleNode.data.name})).join(">"),nodeType:0,child:[],editable:!0,expanded:!1};var index=1;var name;var nameMap={};node.child&&node.child.forEach((function(eleNode){nameMap[eleNode.data.name]=!0}));for(;;){name=newNode.name+index;if(!nameMap[name])break;index++}newNode.name=name;index=-1;if(node.child)for(var i=0;i<node.child.length;i++)if(!node.child[i].data.isFolder){index=i;break}return this.wrapNode(dm,dm.treeMgr.addNode(newNode,node,index))};this.preOpCheck=function(node,op,accessType,args){var ret=!0;me.Const.deleteOp.indexOf(op)>=0&&(ret=nbAlertSrvc.confirm(nbPLM.Common.sprintf("Are you sure you want to delete the {0}?",node.data.isFolder?"folder":"file")).then((function(){return!0}),(function(){return!1})));return $q.when(ret)};this.refreshNode=function(dm,treeMgr,curNode){dataViewPanelHttpSrvc.getStaticDataView(dm.dmDv.prepareStaticDV()).then((function(data){if(data){var tmpTreeMgr=new window.nbPLM.TreeManager(data,{idName:"ID",pidName:"parentId",childName:"child",isArray:!0,startIndex:treeMgr.getNO()});var curNodeInTmp=tmpTreeMgr.getNodeByFn((function(node){return node.data.ID==curNode.data.ID}));curNodeInTmp&&(tmpTreeMgr=tmpTreeMgr.getSubTree(curNodeInTmp));tmpTreeMgr.tranverse((function(node,arg){me.wrapNode(arg,node)}),dm);tmpTreeMgr.tree[0].pid=curNode.pid;var pNode=dm.treeMgr.getParent(curNode);dm.treeMgr.deleteNode(curNode);tmpTreeMgr.tranverse((function(node){treeMgr.map[node.id]=node}),dm);pNode?pNode.child.push(tmpTreeMgr.tree[0]):treeMgr.tree.push(tmpTreeMgr.tree[0]);treeMgr.setNO(tmpTreeMgr.getNO());me.sortAll(treeMgr);me.calculateCountAll(treeMgr);treeMgr.refreshLevel();me.onSearch(dm);return curNode}return curNode}),(function(errMsg){nbAlertSrvc.error(errMsg.ResultDesc);return!1}));return!1};this.refreshNodeUpdatedTime=function(dm,node){if(!node.data.isFolder&&!node.data.isDefault&&dm.dmDv.updatedDvg[node.data.ID]){var oldDt=dm.dmDv.updatedDvg[node.data.ID];var dt=dataViewPanelSrvc.getMaxTime(oldDt,node.data.lastUpdateTime);dt!=oldDt&&(dm.dmDv.updatedDvg[node.data.ID]=dt);node.data.dataViewInfo.dataViewGroup.lastUpdateTime=dt;node.data.lastUpdateTime=dt}};this.refreshUpdatedTime=function(dm){dm.treeMgr.tranverse((function(node,arg){me.refreshNodeUpdatedTime(dm,node)}),dm)};this.wrapNode=function(dm,node){var dmDv=dm.dmDv;node.fn=dm.tree.fn;node.refVars=dm.tree.refVars;node.refVars.dm=dm;node.tree=dm.tree;node.data.sid||(node.data.sid=node.data.ID);node.data.isDefault||node.data.isScheduler?node.data.actionMenu=[]:node.data.isRoot?node.data.actionMenu=me.Const.actionMenu.filter((function(eleOp){return me.Const.rootFolderOp.indexOf(eleOp.action)>=0})):node.data.isFolder?node.data.actionMenu=me.Const.actionMenu.filter((function(eleOp){return me.Const.folderOp.indexOf(eleOp.action)>=0})):node.data.actionMenu=me.Const.actionMenu.filter((function(eleOp){return me.Const.dataviewOp.indexOf(eleOp.action)>=0}));if(!node.data.isFolder&&!node.data.isDefault){dataViewPanelSrvc.wrapDvNodeData(dmDv,node.data);dataViewPanelSrvc.appendToDataList(dmDv,node.data);me.refreshNodeUpdatedTime(dm,node)}return node};this.onSelectNode=function(dm,arg_node,event,bNoApply){var dmDv=dm.dmDv;var node=arg_node;node||(node=dm.treeMgr.tree[0]);if(node){dm.refData.selNode=node;dm.treeMgr.expend(dm.treeMgr.getParent(node));dm.tree.selNodeData=node.data;if(!bNoApply&&!node.isEdit)if(node.data.isDefault){me.hidePreview(dm);dataViewPanelSrvc.onSelectDefaultDataView(dmDv)}else node.data.isFolder?me.hidePreview(dm):me.showPreview(dm,node,event)}};this.checkPriviligePermission=function(dataViewGroup){var devices=dataViewGroup.relativeDevices;return deviceAccessCacheSrvc.getDAPArray(devices,[1]).then((function(res){if(_.some(res,(function(item){return!1===item}))){$rootScope.$emit("GEVENT_MapFloatMessage","The data view of some qualified devices cannot be displayed due to restricted privileges.");dataViewGroup.relativeDevices=_.filter(dataViewGroup.relativeDevices,(function(item,index){return res[index]}))}}),(function(){}))};this.showPreview=function(dm,node,event){if(!dm.tmDelay&&event&&event.target){var $node=null;$node=nbPLM.Common.ancestorHasClass($(event.target),"ivh-treeview-node-leaf",10);var $anchor=$("#"+dm.gidAnchor);var top=$node.offset().top-$node.offsetParent().offset().top;$anchor.css("top",top);dm.tmDelay=$timeout((function(){dataViewPanelSrvc.openModelessPreview(node,"dv",{mapPageObj:dm.dmDv.getActivePage(),dmDv:dm.dmDv},$anchor);dm.tmDelay=null}),500)}};this.hidePreview=function(dm){if(dm.tmDelay){$timeout.cancel(dm.tmDelay);dm.tmDelay=null}dm.isShowPreview=!1};this.onDblClickNode=function(dm,node){if(node&&!node.isEdit)if(node.data.isDefault)me.hidePreview(dm);else if(node.data.isFolder)me.hidePreview(dm);else{me.hidePreview(dm);me.checkPriviligePermission(node.data.dataViewInfo.dataViewGroup).then((function(){dataViewPanelSrvc.onSelectDataView(dm.dmDv,node.data)}))}};this.sortAll=function(treeMgr){treeMgr.sortAll(dataViewPanelSrvc.Const.fnSortNode)};this.sortNode=function(treeMgr,node){treeMgr.sortChild(node,dataViewPanelSrvc.Const.fnSortNode)};this.calculateCountAll=function(treeMgr){treeMgr.tranverse((function(node){node.data.isFolder&&(node.fileCount=0)}));treeMgr.tranverse((function(node){me.calculateCountNode(treeMgr,node)}))};this.calculateCountNode=function(treeMgr,node){if(!node.data.isFolder){var curNode=node;for(;curNode;){curNode.data.isFolder&&(curNode.fileCount=curNode.fileCount?curNode.fileCount+1:1);curNode=treeMgr.getParent(curNode)}}};this._initTree=function(dm,bForce){dm.tree.browseTree=dm.treeMgr.tree;var rootSchedulerNode=dm.treeMgr.getNodeByFn((function(node){return node.data.ID==me.Const.schedulerId}))||null;if(rootSchedulerNode){rootSchedulerNode.data.isScheduler=!0;rootSchedulerNode.data.isRootScheduler=!0;dm.treeMgr.tranverse((function(node,arg){dm.treeMgr.isAncestor(node,rootSchedulerNode)&&(node.data.isScheduler=!0)}),dm)}dm.treeMgr.tranverse((function(node,arg){me.wrapNode(arg,node)}),dm);me.sortAll(dm.treeMgr);var pNode=null;if(dm.dmDv&&1==dm.dmDv.staticOne.iSign){dm.dmDv.staticOne.id&&(pNode=dm.treeMgr.getNodeByFn((function(eleNode){return eleNode.data.ID===dm.dmDv.staticOne.id})));pNode&&dm.dmDv.staticOne.apply&&me.onDblClickNode(dm,pNode);dm.dmDv.staticOne.iTryTimes>=1?dm.dmDv.staticOne.iTryTimes++:dm.dmDv.staticOne.iTryTimes=1;if(!pNode&&dm.dmDv.staticOne.apply&&dm.dmDv.staticOne.iTryTimes<=2)me.Const.doNothing();else{dm.dmDv.staticOne.apply=!1;dm.dmDv.staticOne.iSign=2}}pNode||(pNode=dm.refData.selNode&&dm.treeMgr.getNodeByFn((function(node){return node.data.sid===dm.refData.selNode.data.sid}))||null);if(pNode){me.onSelectNode(dm,pNode,null,!0);var nodeArr=dm.treeMgr.getPath(pNode.id);var iMaxLevel=nodeArr.length;nbPLM.Common.tryNTimes($timeout,iMaxLevel,(function(nTimes){nodeArr.length>=2&&(nodeArr.shift().expended=!0)}))}else me.onSelectNode(dm,dm.treeMgr.tree[0],null,!0);me.onSearch(dm,bForce)};this.initFromLocal=function(dm,dataWrapper){dm.treeMgr=dataWrapper.staticOne.data.treeMgr;dm.refData=dataWrapper.staticOne.data.refData;dm.filter=dataWrapper.staticOne.data.filter;me._initTree(dm)};this.initTree=function(dm,dataWrapper,option){if(dataWrapper.staticOne.data){dm.refData=dataWrapper.staticOne.data.refData;dm.filter=dataWrapper.staticOne.data.filter}dm.dmDv.updatedDvg={};dataViewPanelHttpSrvc.getStaticDataView(dm.dmDv.prepareStaticDV()).then((function(data){if(option&&option.bTrigger){var curArr=[];dm.treeMgr.tranverse((function(node,arg){curArr.push({sid:node.data.ID,psid:node.data.parentId,name:node.data.name,lastUpdateTime:node.data.lastUpdateTime||void 0})}),dm);var newArr=[];data.forEach((function(nodeData){newArr.push({sid:nodeData.ID,psid:nodeData.parentId,name:nodeData.name,lastUpdateTime:nodeData.lastUpdateTime||void 0})}));if(newArr.length==curArr.length){newArr.sort((function(ele1,ele2){return ele1.sid>ele2.sid?1:-1}));curArr.sort((function(ele1,ele2){return ele1.sid>ele2.sid?1:-1}));if(JSON.stringify(newArr)==JSON.stringify(curArr))return}}dm.treeMgr=new window.nbPLM.TreeManager(data,{idName:"ID",pidName:"parentId",childName:"child",isArray:!0});dataWrapper.staticOne.data={};dataWrapper.staticOne.data.refData=dm.refData;dataWrapper.staticOne.data.filter=dm.filter;dataWrapper.staticOne.data.treeMgr=dm.treeMgr;me._initTree(dm,!0)}),(function(err){console.warn(err)}))}}angular.module("nb.dataview").filter("staticDataViewDateFormate",(function(){return function(date,format){var tmNow=new Date;var tm=new Date(date);var mmm=moment(date);return tm.getFullYear()==tmNow.getFullYear()&&tm.getMonth()==tmNow.getMonth()&&tm.getDate()==tmNow.getDate()?mmm.format(format||"HH:mm:ss"):mmm.format(format||"MM/DD/YY")}}))}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.staticDataViewCtrl",nbController);nbController.$inject=["$q","$interval","$scope","$filter","$uibModal","$document","$timeout","$rootScope","$compile","nb.dataview.staticDataViewSrvc","nb.dataview.dataViewPanelSrvc"];function nbController($q,$interval,$scope,$filter,$uibModal,$document,$timeout,$rootScope,$compile,staticDataViewSrvc,dataViewPanelSrvc){var strGid=nbPLM.nbParserLibCM.getGUID();$scope.dataModel={bInit:!1,dmDv:$scope.dmDv,dataWrapper:$scope.dataWrapper,filter:{search:"",search1:""},treeMgr:null,gidTree:strGid+"-tree",gidAnchor:strGid+"-anchor",refData:{noData:!1,selNode:null},tree:{nodeEditPrefix:strGid,browseTree:[],ivhTreeOptions:{defaultSelectedState:!1,validate:!0,expandToDepth:0,idAttribute:"id",childrenAttribute:"child",expandedAttribute:"expended",useCheckboxes:!0,twistieLeafTpl:""},fn:{onSelectNode:function(node,e){if(e&&e.target)if(nbPLM.Common.ancestorHasClass($(e.target),"nb-tree-node-open-close-toggle",8))node.expended=!node.expended;else if(nbPLM.Common.ancestorHasClass($(e.target),"tree-node-drop-op",8)||nbPLM.Common.ancestorHasClass($(e.target),"tree-node-op-popover",8))return;staticDataViewSrvc.onSelectNode($scope.dataModel,node,e,!1)},onDblClick:function(node,e){e&&e.target&&(nbPLM.Common.ancestorHasClass($(e.target),"tree-node-drop-op",8)||nbPLM.Common.ancestorHasClass($(e.target),"tree-node-op-popover",8))||staticDataViewSrvc.onDblClickNode($scope.dataModel,node)},onMouseLeaveNode:function(){$(document).click()},onNodeOpClick:function(node,op){$(document).click();staticDataViewSrvc.onNodeOpClick($scope.dataModel,node,op.action,{op:op})},onUpdateName:function(node,nbTextChanged,nbOldValue){var op="";node.opNext&&(op=node.opNext);staticDataViewSrvc.onNodeOpClick($scope.dataModel,node,op,{textChanged:nbTextChanged,oldValue:nbOldValue})},onClickOp:function(e,node){var dm=$scope.dataModel;var docHeight=$(document).height();var clickY=e.pageY;var nShow=0;dm.opPop.data.actionMenu=node.data.actionMenu;dm.opPop.data.actionMenu.forEach((function(eleOp){eleOp.show&&nShow++}));dm.opPop.placement=docHeight-clickY>26*(nShow+1)+30?"bottom-left":"top-left"},onAsyncShowTip:function(node,isShow,e){var dm=$scope.dataModel;if(isShow){node.isDirt&&staticDataViewSrvc.onRefreshNodeData(dm,node);dm.popMgr.asyncShow(node.data,500);var docHeight=$(document).height();var clickY=e.pageY;dm.previewPop.placement=docHeight-clickY>150?"bottom-left":"top-left"}else dm.popMgr.asyncHide(node.data,10)},onShowTip:function(node,isShow){var dm=$scope.dataModel;isShow?dm.popMgr.show(node.data):dm.popMgr.hide(node.data)},onHighLightDevices:function(node){staticDataViewSrvc.onHighLightDevices($scope.dataModel,node)}},refVars:{dm:$scope.dataModel}},opPop:{gid:window.nbPLM.nbParserLibCM.getGUID(),tmpl:"staticDateViewTreeOpPop.html",placement:"bottom-left",data:{actionMenu:[]}},popMgr:new nbPLM.MouseOverPopupManager({nShow:"isShowPreview",nId:"sid",onShow:function(){$timeout()},onHide:function(){$timeout()}}),previewPop:{tmpl:"staticDateViewPreviewPop.html",placement:"bottom-left",data:{actionMenu:[]}},isShowPreview:!1,tmDelay:null};$scope.onCancel=function(){$scope.dataModel.isShowPreview=!1};$scope.onApplyDv=function(){var dm=$scope.dataModel;dataViewPanelSrvc.onSelectDataView(dm.dmDv,$scope.dataModel.tree.selNodeData);$scope.dataModel.isShowPreview=!1};$scope.onPressEnter=function(e){var dm=$scope.dataModel;if(13===e.keyCode){dm.filter.search1=dm.filter.search;staticDataViewSrvc.onSearch($scope.dataModel,!0)}};$scope.onChangeFilter=function(){var dm=$scope.dataModel;if(!dm.filter.search&&dm.filter.search1!=dm.filter.search){dm.filter.search1=dm.filter.search;staticDataViewSrvc.onSearch($scope.dataModel,!0)}};$scope.onClearSearch=function(){var dm=$scope.dataModel;dm.filter.search="";if(dm.filter.search1!=dm.filter.search){dm.filter.search1=dm.filter.search;staticDataViewSrvc.onSearch($scope.dataModel,!0)}};$scope.onRefresh=function(){$scope.$parent&&$scope.$parent.dataModel&&($scope.$parent.dataModel.bDisableAutoRefresh=!1);staticDataViewSrvc.onRefresh($scope.dataModel)};$scope.$watch("dataWrapper.staticOne.index",(function(newVal,oldVal){if(newVal&&newVal!=oldVal&&$scope.dataWrapper.staticOne.bDeviceChange){$scope.dataWrapper.staticOne.bDeviceChange=!1;staticDataViewSrvc.onRefresh($scope.dataModel,{bTrigger:!0})}}));$scope.$on("nbEventUpdateDataView",(function(){staticDataViewSrvc.refreshUpdatedTime($scope.dataModel)}));$scope.$on("$destroy",(function(){var dm=$scope.dataModel;dm.dmDv=null;dm.dataWrapper=null;dm.popMgr.clearEvent();dm.tmDelay&&$timeout.cancel(dm.tmDelay)}));$scope.$watch((function(){return dataViewPanelSrvc.getCurrentPageId($scope.dmDv)}),(function(newVal,oldVal){if(!$scope.dataModel.bInit&&newVal&&newVal==$scope.dmDv.mapInfo.mapPageId){staticDataViewSrvc.onInit($scope.dataModel,$scope.dataWrapper);$scope.dataModel.bInit=!0}}));window.nbPLM.Common.delayRun((function(arg){if(arg.scope.dmDv.mapInfo.mapPageId){if(dataViewPanelSrvc.isCurrentPage(arg.scope.dmDv)){staticDataViewSrvc.onInit($scope.dataModel,$scope.dataWrapper);$scope.dataModel.bInit=!0}return!0}return!1}),{scope:$scope},20,20)}angular.module("nb.dataview").controller("nb.dataview.staticDataViewPreviewWrapperCtrl",["$q","$scope","$filter","$document","$timeout","nb.dataview.staticDataViewSrvc","nb.dataview.dataViewPanelSrvc",function($q,$scope,$filter,$document,$timeout,staticDataViewSrvc,dataViewPanelSrvc){$scope.dmPreview={selects:[],selNode:""};$scope.onApplyDv=function(){var dmModelData=$scope.model.data;staticDataViewSrvc.checkPriviligePermission(dmModelData.nodeData.dataViewInfo.dataViewGroup).then((function(){dataViewPanelSrvc.onSelectDataView(dmModelData.context.dmDv,dmModelData.nodeData);$scope.onCancel&&$scope.onCancel()}))}}])}(NetBrain);!function(netBrain){angular.module("nb.dataview").controller("nb.dataview.dynamicDataViewPreviewCtrl",nbController);nbController.$inject=["$q","$interval","$scope","$filter","$uibModal","$document","$timeout","$rootScope","$compile","nb.dataview.dataViewPanelHttpSrvc","nb.dataview.dataViewPanelSrvc","nb.dataview.dynamicDataViewSrvc"];function nbController($q,$interval,$scope,$filter,$uibModal,$document,$timeout,$rootScope,$compile,dataViewPanelHttpSrvc,dataViewPanelSrvc,dynamicDataViewSrvc){$scope.dmPreview={selects:[],selNode:""};function init(){var dmPreview=$scope.dmPreview;if($scope.dataModel.tree.selNodeData&&$scope.dataModel.tree.selNodeData.ID){var hasApplied=dynamicDataViewSrvc.hasAppliedDvt($scope.dmDv.getActivePage(),$scope.dataModel.tree.selNodeData.ID);dmPreview.selects=[{nodeId:1,name:"Create New Runbook Node"}];hasApplied&&dmPreview.selects.unshift({nodeId:2,name:"Use Last Runbook Result",data:hasApplied});dmPreview.selNode=dmPreview.selects[0]}}$scope.onSelectNode=function(eleNode){$scope.dmPreview.selNode=eleNode};$scope.onCancel=function(){$scope.dataModel.isShowPreview=!1};$scope.$watch("dataModel.tree.selNodeData.path",(function(newVal,oldVal){newVal&&init()}));$scope.onApplyDvt=function(){var dm=$scope.dataModel;var dmPreview=$scope.dmPreview;if($scope.dataModel.tree.selNodeData&&$scope.dataModel.tree.selNodeData.ID){dataViewPanelSrvc.onSelectDVTemplate(dm.dmDv,$scope.dataModel.tree.selNodeData,dmPreview.selNode?dmPreview.selNode.data:null);dynamicDataViewSrvc.addAppliedDvt($scope.dmDv.getActivePage(),$scope.dataModel.tree.selNodeData.ID)}$scope.dataModel.isShowPreview=!1};init()}}(NetBrain);!function(netBrain){angular.module("nb.dataview").directive("nbDataViewPreviewDirective",nbDirective);nbDirective.$inject=["$compile","$filter","$log","$document","$timeout","$sce","$rootScope","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.uiframework.urlStateMgr","nb.ng.nbHttp","nb.dataview.dataViewPanelHttpSrvc"];function nbDirective($compile,$filter,$log,$document,$timeout,$sce,$rootScope,nbAlertSrvc,utilitySrvc,httpAuthSrvc,urlStateMgr,nbHttp,dataViewPanelHttpSrvc){return{restrict:"EA",scope:{nbDataId:"=nbDataId",nbDataPath:"=nbDataPath",nbOptions:"=nbOptions"},templateUrl:"modules/nbDataView/dataViewPanel/views/nbDataViewPreviewDirective.html",replace:!0,link:function(scope){scope.dataModel={id:"",path:"",bExist:!0,data:{name:"",descState:0,desc:"",samplePicture:"",author:"",opTime:"",version:""},loaded:!1,descLines:[],matchedCount:0,innerClass:"dispEmbedded-3",dispEmbedded:!0,uncomplete:!1,Font12:'13px "open sans"',Width:418,zz_last:null};scope.$watch("nbDataId",(function(newVal,oldVal){var dm=scope.dataModel;dm.id=newVal;dm.id&&refreshPreview()}));scope.$watch("nbDataPath",(function(newVal,oldVal){var dm=scope.dataModel;dm.path=newVal;dm.path&&refreshPreview()}));scope.onShowMore=function(bMore){var dm=scope.dataModel;dm.uncomplete&&(dm.dispEmbedded=!bMore);scope.$parent.model&&scope.$parent.model.data&&(scope.$parent.model.data.dispEmbedded=dm.dispEmbedded)};function refreshPreview(){var dm=scope.dataModel;if(dm.id||dm.path){dm.bExist=!0;dm.id&&function(id){var dm=scope.dataModel;var matchedDevice=scope.nbOptions.data.dataViewInfo.dataViewGroup.relativeDevices.length;dm.matchedCount=matchedDevice;dataViewPanelHttpSrvc.refreshDataView(id).then((function(data){if(data){dm.data=data.dataViewGroup;dm.data.deviceList=data.deviceList;if(dm.data.deviceList&&dm.data.deviceList.length&&scope.nbOptions&&scope.nbOptions.refVars&&scope.nbOptions.refVars.dm&&scope.nbOptions.refVars.dm.dmDv){var deviceIdMap={};scope.nbOptions.refVars.dm.dmDv.getActivePage()._getAllDevices(!0).map((function(item){deviceIdMap[item.getKey()]=1}));var iCount=0;dm.data.deviceList.forEach((function(ele){deviceIdMap[ele.ID]&&iCount++}));dm.matchedCount=iCount}dm.data.total=Math.max(data.total,matchedDevice);dm.data.desc=dm.data.description?$filter("nbDvtTextTransferSequenceSpace")(dm.data.description):"";if(dm.data.desc){var lineInfo=nbPLM.OpBaseRule.getLinesWithRestrict(dm.data.desc,dm.Font12,dm.Width,3,60);dm.uncomplete=lineInfo.uncomplete;dm.descLines=lineInfo.lines}else dm.descLines=[];if(scope.nbOptions&&scope.nbOptions.data&&dm.data.lastUpdateTime){scope.nbOptions.data.dataViewInfo.dataViewGroup.lastUpdateTime=dm.data.lastUpdateTime;scope.nbOptions.data.lastUpdateTime=dm.data.lastUpdateTime}}dm.loaded=!0}),(function(err){console.warn(err);dm.loaded=!0}))}(dm.id)}else dm.bExist=!1}}}}}(window.NetBrain);!function(netbrain){angular.module("nb.dataview").controller("nb.dataview.dataViewModelessPreviewCtrl",nbController);nbController.$inject=["$scope","$filter","$timeout","$interval","nb.dataview.dataViewPanelSrvc"];function nbController($scope,$filter,$timeout,$interval,dataViewPanelSrvc){$scope.dataModel={title:"Preview",icon:"",nodeData:null,ctnId:"",zz_last:null};$scope.$on("nbDataViewTemplatePreviewDirective.Emit.Data",(function(event,data){var dm=$scope.dataModel;data&&data.lastScheduleTime?dm.icon="action_node_dynamic_dataview_14":dm.icon="action_node_dataview_no_data_14"}));$scope.onCancel=function(arg){dataViewPanelSrvc.closeModelessPreview($scope.model.data.gid)};!function(){var data=$scope.model.data;var dm=$scope.dataModel;dm.ctnId=data.gid+"-preview";"dvt"==data.type?dm.title="Preview - Data View Template":"dv"==data.type&&(dm.title="Preview - Data View");dm.nodeData=data.nodeData}();function onDocClick(e){var dm=$scope.dataModel;e&&e.target?null===nbPLM.Common.ancestorHasId($(e.target),dm.ctnId,30)&&e.target!=document&&dataViewPanelSrvc.closeModelessPreview($scope.model.data.gid):dataViewPanelSrvc.closeModelessPreview($scope.model.data.gid)}$(document).bind("click",onDocClick);$scope.$on("$destroy",(function(){$(document).unbind("click",onDocClick)}))}}(NetBrain);!function(){angular.module("nb.dataview").controller("nb.dataview.defineSpogCtrl",defineSpogCtrl);defineSpogCtrl.$inject=["$scope","$rootScope","$timeout","nb.dataview.defineSpogSrvc","nb.ng.permissionSrvc"];function defineSpogCtrl($scope,$rootScope,$timeout,defineSpogSrvc,permissionSrvc){$scope.viewModel={tabType:{pageLink:"page-link",genericVar:"generic-variable"},currentTab:{name:"Page Link",type:"page-link",id:"pageLink"},spogTabs:[{name:"Page Link",type:"page-link",id:"pageLink"},{name:"Generic Variable",type:"generic-variable",id:"genericVariable"}]};$scope.init=function(){$scope.hasManageSpogUrl=!1;permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.ManageSPOGURL)&&($scope.hasManageSpogUrl=!0)};$scope.init();$scope.onClickTab=function(tab){$scope.viewModel.currentTab=tab};$rootScope.$on(systemEvent.changedDomain,(function(){$scope.init()}));$rootScope.$on(systemEvent.changedTenant,(function(){$scope.init()}))}}(NetBrain);!function(netBrain){angular.module("nb.dataview").factory("nb.dataview.defineSpogSrvc",defineSpogSrvc);defineSpogSrvc.$inject=["$uibModal","$document","$rootScope","$timeout","nb.ng.utilitySrvc","nb.dataview.httpDefineSpogSrvc","nb.ng.permissionSrvc","nb.common.nbAlertSrvc"];function defineSpogSrvc($uibModal,$document,$rootScope,$timeout,utilitySrvc,httpDefineSpogSrvc,permissionSrvc,nbAlertSrvc){function _resolveVars(quillContents){var vars=[];var varHash={};var varIndex=0;for(var i=0;i<quillContents.ops.length;i++){var item=quillContents.ops[i];if(item.insert&&item.insert.mention&&item.insert.mention.dataunitdata){var dataUnitData=JSON.parse(item.insert.mention.dataunitdata);if("string"==typeof dataUnitData)throw"dataUnitData is not valid";var varModel={varText:item.insert.mention.name,sourceType:dataUnitData.type,uid:"uSrcGenericVariable"===dataUnitData.type||"uSrcCustomizedVariable"===dataUnitData.type?dataUnitData.name:dataUnitData.uId,parserPath:"uSrcParserLibrary"===dataUnitData.type?dataUnitData.parserPath:null,dataType:"uSrcGenericVariable"===dataUnitData.type?"string":dataUnitData.varType,isInterfaceVar:dataUnitData.isInterfaceVariable};if("uSrcGDR"===dataUnitData.type||"uSrcParserLibrary"===dataUnitData.type){var varSections=varModel.uid.split(".");varModel.tableVar=varSections.length>1&&"Single Value"!==varSections[0]?varSections[0]:null}var varKey=varModel.sourceType+"_"+("uSrcParserLibrary"===varModel.sourceType?varModel.parserPath:"")+"_"+varModel.uid;var existVar=varHash[varKey];if(!existVar){varModel.varAtIndexs=[];varHash[varKey]=existVar=varModel;vars.push(varModel)}existVar.varAtIndexs.push(varIndex);varIndex++}}return vars}return{getPageLInk:function(vendorId,searchText){return httpDefineSpogSrvc.getPageLInk({vendorId:vendorId,searchText:searchText})},getVendors:function(){return httpDefineSpogSrvc.getVendors()},getPageLinkById:function(id){return httpDefineSpogSrvc.getPageLinkById(id)},deleteVendor:function(vendor){return httpDefineSpogSrvc.deleteVendor(vendor)},enablePageLinks:function(flag,ids){return httpDefineSpogSrvc.enablePageLinks({enable:flag,ids:ids})},addVendor:function(vendor){return httpDefineSpogSrvc.addVendor(vendor)},enableVendor:function(enable,vIds){return httpDefineSpogSrvc.enableVendor({enable:enable,ids:vIds})},updateVendor:function(vendor){return httpDefineSpogSrvc.updateVendor(vendor)},addPageLink:function(data){return httpDefineSpogSrvc.addPageLink(data)},updatePageLink:function(data){return httpDefineSpogSrvc.updatePageLink(data)},deletePageLink:function(data){return httpDefineSpogSrvc.deletePageLink(data)},saveAsPageLink:function(data){return httpDefineSpogSrvc.saveAsPageLink(data)},getPageLinkParams:function(viewModel){var qualify=angular.copy(viewModel.qualify);qualify&&qualify.Conditions&&qualify.Conditions.pop();return{id:viewModel.id||utilitySrvc.getGUID(),vendorId:viewModel.vendorId,name:viewModel.name,enable:viewModel.enable,description:viewModel.description,richTextUrl:JSON.stringify(viewModel.richTextUrl),url:viewModel.url,type:viewModel.type||2,qualify:qualify,variables:_resolveVars(viewModel.richTextUrl)}},getGenericVariablesParams:function(viewModel){return{id:viewModel.id||utilitySrvc.getGUID(),name:viewModel.name,value:viewModel.value,description:viewModel.description}},addPageLinkDialog:function(_params2){return $uibModal.open({templateUrl:"modules/nbDataView/spog/views/addPageLinkDialog.html",controller:"nb.dataview.addPageLinkDialogCtrl",windowClass:"add-page-link",backdrop:"static",resolve:{params:function(){return _params2}}}).result},selectBuiltInVariable:function(argParamsObj){var modalOptions={backdrop:"static",keyboard:!1,windowClass:"selectPropertyPopup",templateUrl:"modules/nbDataView/spog/views/nbSpogSelectPropertyModal.html",controller:"nb.dataview.nbSpogSelectPropertyModalCtrl"};modalOptions.resolve={args:function(){return argParamsObj}};return $uibModal.open(modalOptions).result},selectParseVariable:function(argParamsObj){return $uibModal.open({templateUrl:"modules/nbDataViewTemplate/views/nbDataViewTemplateParserModal.html",controller:"nb.dataview.nbSpogParserLibSelectorCtrl",windowClass:"dataViewTemplateParserModal2",backdrop:"static",resolve:argParamsObj}).result},saveAsPageLinkDialog:function(_params5){return $uibModal.open({templateUrl:"modules/nbDataView/spog/views/saveAsPageLink.html",controller:"nb.dataview.saveAsPageLinkCtrl",windowClass:"save-as-link",backdrop:"static",resolve:{params:function(){return _params5}}}).result},getGenericVarable:function(searchStr){return httpDefineSpogSrvc.getGenericVarable({searchText:searchStr})},addGenericVarable:function(params){return httpDefineSpogSrvc.addGenericVarable(params)},updateGenericVarable:function(params){return httpDefineSpogSrvc.updateGenericVarable(params)},deleteGenericVariable:function(ids){return httpDefineSpogSrvc.deleteGenericVarable(ids)},checkBuiltInRight:function(action){if(permissionSrvc.isSystemAdminRole()||permissionSrvc.isTenantAdminRole())return!0;nbAlertSrvc.warning("You dont have the privilege to "+action.method+" the Built-in "+action.name+" Please contact your NetBrain administrator for details.");return!1},confirmBuiltInRight:function(action,fn){nbAlertSrvc.confirm("Changes made to built-in"+action.name+" might be overwritten when NetBrain is upgraded to a new version. Do you still want to continue?").then((function(){fn()}))},addGenericVariableDialog:function(_params3){return $uibModal.open({templateUrl:"modules/nbDataView/spog/views/addGenericVariableDialog.html",controller:"nb.dataview.addGenericVariableDialogCtrl",windowClass:"add-generic-variable",backdrop:"static",resolve:{params:function(){return _params3}}}).result},selectGenericVariableDialog:function(_params4){return $uibModal.open({templateUrl:"modules/nbDataView/spog/views/selectGenericVariableDialog.html",controller:"nb.dataview.selectGenericVariableDialog",windowClass:"select-generic-variable",backdrop:"static",resolve:{params:function(){return _params4}}}).result},insertCustomizedVariable:function(_params){return $uibModal.open({templateUrl:"modules/nbDataView/spog/views/insertCustomizedVariable.html",controller:"nb.dataview.insertCustomizedVariable",windowClass:"insert-customize-variable",backdrop:"static",resolve:{params:function(){return _params}}}).result},resolveVars:_resolveVars}}}(NetBrain);!function(NetBrain){angular.module("nb.dataview").controller("nb.dataview.pageLinkCtrl",pageLinkCtrl);pageLinkCtrl.$inject=["$scope","$rootScope","$timeout","$q","nb.dataview.defineSpogSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.nbValidationSrvc","nb.common.nbToastr"];function pageLinkCtrl($scope,$rootScope,$timeout,$q,defineSpogSrvc,nbAlertSrvc,utilitySrvc,nbValidationSrvc,nbToastr){$scope.viewModel={vendors:[],vendorEnable:!1,enableAll:!1,indeterminateAll:!1,actions:[{name:"Rename",action:rename},{name:"Delete",action:deleteVendor}],pageNameValid:{method:"blur",rules:[{ruleId:"required",errorMessage:"Please specify a Vendor Name."},{ruleId:"duplicationChecker",params:{lsExistingNames:[]},errorMessage:"The {name} already exists in the system."},{ruleId:"generalForbidWindowsAndMongoChars",params:"",errorMessage:"The following characters cannot be used: \\ / : * ?  < > | . $."}]},filterText:"",vendorFuncs:[{name:"Enable All",val:!0},{name:"Disable All",val:!1}],gridApiPageLink:null,selectedPageLink:null,selectedVendor:null,pageLinkRowActionMenu:[{template:"Edit",action:function(rows){$scope.onEdit(rows)}},{template:"Save As",permission:NetBrain.NG.Permissions.discoverTuneNetworkDevice,action:function(rows){row=rows,defineSpogSrvc.saveAsPageLinkDialog(row).then((function(data){$scope.pageLinkData.push(data)}));var row}},{template:"Delete",permission:NetBrain.NG.Permissions.discoverTuneNetworkDevice,action:function(rows){!function(row){if(1===row.type){if(!defineSpogSrvc.checkBuiltInRight({method:"delete",name:"page link"}))return;defineSpogSrvc.confirmBuiltInRight({name:"page link"},(function(){nbAlertSrvc.confirm("Are you sure you want to delete this page link?").then((function(){defineSpogSrvc.deletePageLink([row.id]).then((function(){$scope.pageLinkData.splice($scope.pageLinkData.indexOf(row),1);checkEnableAll()}),(function(err){err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))}))}))}else nbAlertSrvc.confirm("Are you sure you want to delete this page link?").then((function(){defineSpogSrvc.deletePageLink([row.id]).then((function(){$scope.pageLinkData.splice($scope.pageLinkData.indexOf(row),1);checkEnableAll()}),(function(err){err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))}))}(rows)}}]};$scope.getContextMenuActions=function(item){$scope.vendorClick(item);return[{template:"Rename",action:function(){var index=$scope.viewModel.vendors.indexOf(item);rename(item,index)}},{template:"Delete",action:function(){var index=$scope.viewModel.vendors.indexOf(item);deleteVendor(item,index)}}]};$scope.pageLinkData=[];$scope.pageLinkGridOptions={data:"pageLinkData",multiSelect:!1,enableSelection:!0,modifierKeysToMultiSelect:!1,enableFullRowSelection:!0,enableRowHeaderSelection:!1,enableColumnMenus:!1,enableColumnResize:!0,enableRowContextMenu:!0,rowContextMenuItems:function(row){return $scope.viewModel.pageLinkRowActionMenu},columnDefs:[{field:"enable",displayName:"",width:"150",headerCellTemplate:'<input id="checkAllPageLink" class={{grid.appScope.viewModel.selectedVendor.id+\'-checkbox\'}} style="margin-left: 17px; margin-top:8px;" type="checkbox" ng-disabled="grid.appScope.viewModel.disableClac" ng-model="grid.appScope.viewModel.enableAll" ng-change="grid.appScope.clickEnableAll()"/><span style=\'margin-top:-5px;vertical-align:middle;display:inline-block;line-height:14px;height:14px;padding-left: 4px;\'>Enable</span>',cellTemplate:'<div class="ui-grid-cell-contents"><input type="checkbox" ng-model="row.entity[col.field]"  ng-change="grid.appScope.clickEnable(row)" ng-disabled="grid.appScope.viewModel.disableClac""/></div>'},{field:"name",displayName:"Page Name",width:"20%",cellTemplate:'<div class="ui-grid-cell-contents" style="float: left; text-align: left;"><span ng-click="grid.appScope.onEdit(row.entity)" class="page-link-name-edit" title="{{COL_FIELD}}" ng-bind-html="COL_FIELD | nbParserTreeHighlightFilter: grid.appScope.viewModel.searchKeyword"></span></div>'},{field:"url",displayName:"Page URL",width:"20%",cellTemplate:'<div class="ui-grid-cell-contents" style="float: left; text-align: left;"><span title="{{COL_FIELD}}" ng-bind-html="COL_FIELD | nbParserTreeHighlightFilter: grid.appScope.viewModel.searchKeyword"></span></div>'},{field:"qualifyText",displayName:"Condition",width:"20%",cellTemplate:'<div class="ui-grid-cell-contents" style="position: relative;float: left; text-align: left;"><span ng-style="{\'max-width\':(grid.appScope.checkCondition(row)?\'calc(100% - 28px)\':\'100%\')}" style="display: inline-block;overflow: hidden;text-overflow: ellipsis;" title="{{COL_FIELD}}" ng-bind-html="COL_FIELD"></span><span ng-show="grid.appScope.checkCondition(row)" title="Invalid condition." class="validation-has-error icon_nb_error_16 validation-arrow-horizontal ng-scope" style="color: #ff0000;position: absolute;right:10px;display: inline-block;margin-top: 4px;">!</span></div>'},{field:"description",displayName:"Description",cellTemplate:'<div class="ui-grid-cell-contents" style="float: left; text-align: left;"><span title="{{COL_FIELD}}" ng-bind-html="COL_FIELD | nbParserTreeHighlightFilter: grid.appScope.viewModel.searchKeyword"></span></div>'}],enableRowActionMenu:!0,rowActionMenuItems:function(row){return $scope.viewModel.pageLinkRowActionMenu},onRegisterApi:function(gridApi){$scope.viewModel.gridApiPageLink=gridApi;$scope.viewModel.gridApiPageLink.selection.on.rowSelectionChanged($scope,(function(row){$scope.selectedPageLink=angular.copy(row.entity)}))}};$scope.triggerBlur=function(ev,vendor,$index){13===(ev.keyCode||ev.which)&&$scope.safeUpdateVendor(vendor,$index)};$scope.checkCondition=function(row){return!!(row&&row.entity&&row.entity.qualify&&row.entity.qualify.Conditions)&&_.some(row.entity.qualify.Conditions,(function(condition){return condition.invalid}))};$scope.onEdit=function(row){var index=$scope.pageLinkData.indexOf(row);if(1===row.type){if(!defineSpogSrvc.checkBuiltInRight({method:"edit",name:"page link"}))return;defineSpogSrvc.confirmBuiltInRight({name:"page link"},(function(){defineSpogSrvc.getPageLinkById(row.id).then((function(data){var params=_.extend({openFrom:"edit"},data);defineSpogSrvc.addPageLinkDialog(params).then((function(editData){$scope.pageLinkData.splice(index,1,editData)}))}),(function(err){err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))}))}else defineSpogSrvc.getPageLinkById(row.id).then((function(data){var params=_.extend({openFrom:"edit"},data);defineSpogSrvc.addPageLinkDialog(params).then((function(editData){$scope.pageLinkData.splice(index,1,editData)}))}),(function(err){err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))};$scope.addPageLink=function(){defineSpogSrvc.addPageLinkDialog({openFrom:"add",vendorId:$scope.viewModel.selectedVendor.id,enable:!!$scope.viewModel.enableAll}).then((function(data){$scope.pageLinkData.push(data)}))};$scope.onFilter=function(event){if(38==event.which||40==event.which||13==event.which){$scope.viewModel.searchKeyword=$scope.viewModel.filterText;event.preventDefault();$scope.showPageLink($scope.viewModel.selectedVendor.id,$scope.viewModel.searchKeyword)}};$scope.isEmpty=_.isEmpty;$scope.clearFilter=function(){$scope.viewModel.searchKeyword=$scope.viewModel.filterText;$scope.showPageLink($scope.viewModel.selectedVendor.id,$scope.viewModel.searchKeyword)};$scope.postionReCalc=function(vendor,index){$timeout((function(){var winH=window.innerHeight;var dom=$(".vendor-list").eq(index);dom.offset().top>winH-dom.height()&&dom.css("top",winH-dom.height()-2)}))};$scope.addVendor=function(){if(!$scope.viewModel.addProcess){var name="Unnamed Vendor-";$scope.viewModel.addProcess=!0;nbValidationSrvc.submit("pageLinkVendorName").then((function(){var reg=new RegExp(name+"(d+)?");var sameVar=_.filter($scope.viewModel.vendors,(function(v){return reg.test(v.name)}));if(_.isEmpty(sameVar))name+=1;else{sameVar=_.map(sameVar,(function(s){return~~s.name.replace(reg,"$1")}));var num=_.max(sameVar);name+=num+=1}var vendor={name:name,enableEdit:!0,addSafeVendor:addSafeVendor};var index=$scope.viewModel.vendors.length;vendor.id=utilitySrvc.getGUID();$scope.viewModel.vendors.push(vendor);selectAndHilight(index)})).finally((function(){$scope.viewModel.addProcess=!1}))}};$scope.clickEnableAll=function(){var val=$scope.viewModel.enableAll;$scope.viewModel.disableClac=!0;$scope.viewModel.selectedVendor.vendorEnable=!1;$scope.viewModel.indeterminateAll=!1;$("."+$scope.viewModel.selectedVendor.id+"-checkbox").get(0)?$("."+$scope.viewModel.selectedVendor.id+"-checkbox").prop("indeterminate",$scope.viewModel.indeterminateAll):$timeout((function(){$("."+$scope.viewModel.selectedVendor.id+"-checkbox").prop("indeterminate",$scope.viewModel.indeterminateAll)}));return defineSpogSrvc.enablePageLinks(val,_.pluck($scope.pageLinkData,"id")).then((function(){$scope.viewModel.disableClac=!1;!0===val?_.each($scope.pageLinkData,(function(d){d.enable=!0})):!1===val&&_.each($scope.pageLinkData,(function(d){d.enable=!1}))}),(function(){$scope.viewModel.enableAll=!val;$scope.viewModel.disableClac=!1}))};$scope.clickEnable=function(row){var val=row.entity.enable;$scope.viewModel.disableClac=!0;$scope.viewModel.selectedVendor.vendorEnable=!1;defineSpogSrvc.enablePageLinks(val,[row.entity.id]).then((function(){$scope.viewModel.disableClac=!1;checkEnableAll()}),(function(){row.entity.enable=!val;$scope.viewModel.disableClac=!1}))};function deleteVendor(vendor,index){if(1===vendor.type){if(!defineSpogSrvc.checkBuiltInRight({method:"delete",name:"vendors"}))return;defineSpogSrvc.confirmBuiltInRight({name:"vendor"},(function(){nbAlertSrvc.confirm("Are you sure you want to delete this vendor?").then((function(){defineSpogSrvc.deleteVendor([vendor.id]).then((function(){$scope.viewModel.vendors.splice(index,1);if(_.isEmpty($scope.viewModel.vendors)){$scope.pageLinkData.length=0;$scope.viewModel.selectedVendor=null}else $scope.vendorClick($scope.viewModel.vendors[0])}),(function(err){err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))}))}))}else nbAlertSrvc.confirm("Are you sure you want to delete this vendor?").then((function(){defineSpogSrvc.deleteVendor([vendor.id]).then((function(){$scope.viewModel.vendors.splice(index,1);if(_.isEmpty($scope.viewModel.vendors)){$scope.pageLinkData.length=0;$scope.viewModel.selectedVendor=null}else $scope.vendorClick($scope.viewModel.vendors[0])}),(function(err){err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))}))}function rename(vendor,index){if(1===vendor.type){if(!defineSpogSrvc.checkBuiltInRight({method:"rename",name:"vendors"}))return;defineSpogSrvc.confirmBuiltInRight({name:"vendor"},(function(){nbValidationSrvc.submit("pageLinkVendorName").then((function(){vendor.enableEdit=!0;vendor.lastName=vendor.name;return selectAndHilight(index)}))}))}else nbValidationSrvc.submit("pageLinkVendorName").then((function(){vendor.enableEdit=!0;vendor.lastName=vendor.name;selectAndHilight(index)}))}$scope.vendorEnable=function(val){$scope.viewModel.enableAll=val;$scope.clickEnableAll();defineSpogSrvc.enableVendor(val,_.pluck($scope.viewModel.vendors,"id"))};function selectAndHilight(index){$timeout((function(){$(".vendor").find("li").eq(index).children("input").trigger("focus").select()}))}function checkEnableAll(){var hasTrue=!1,hasFalse=!1;_.each($scope.pageLinkData,(function(d){!0===d.enable?hasTrue=!0:hasFalse=!0}));if(hasTrue&&hasFalse){$scope.viewModel.indeterminateAll=!0;$scope.viewModel.enableAll=!1}else if(hasTrue){$scope.viewModel.enableAll=!0;$scope.viewModel.indeterminateAll=!1}else if(hasFalse){$scope.viewModel.enableAll=!1;$scope.viewModel.indeterminateAll=!1}else{$scope.viewModel.enableAll=!1;$scope.viewModel.indeterminateAll=!1}$("."+$scope.viewModel.selectedVendor.id+"-checkbox").get(0)?$("."+$scope.viewModel.selectedVendor.id+"-checkbox").prop("indeterminate",$scope.viewModel.indeterminateAll):$timeout((function(){$("."+$scope.viewModel.selectedVendor.id+"-checkbox").prop("indeterminate",$scope.viewModel.indeterminateAll)}))}function selectVendor(vendor){_.each($scope.viewModel.vendors,(function(v){v.selected=!1}));$scope.viewModel.selectedVendor=vendor;$scope.viewModel.selectedVendor.selected=!0;$scope.viewModel.searchKeyword=$scope.viewModel.filterText;$scope.showPageLink(vendor.id,$scope.viewModel.searchKeyword)}$scope.vendorClick=function(vender){$scope.viewModel.selectedVendor.id!==vender.id&&selectVendor(vender)};$scope.showPageLink=function(venderId,searchText){return defineSpogSrvc.getPageLInk(venderId,searchText).then((function(data){Array.prototype.splice.apply($scope.pageLinkData,[0,$scope.pageLinkData.length].concat(data));checkEnableAll();return $scope.pageLinkData}))};$scope.updateVendorName=function(vendor,index){selectAndHilight(index);if(vendor.lastName===vendor.name){vendor.enableEdit=!1;return vendor.name}if(!vendor.name||!nbValidationSrvc.getValidator("generalForbidWindowsAndMongoChars")(vendor.name)){$scope.viewModel.pageNameValid.rules.params=vendor.name;return nbValidationSrvc.submit("pageLinkVendorName")}if(_.find($scope.viewModel.vendors,(function(v){return v.name===vendor.name&&v.id!==vendor.id}))){$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.length=0;$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.push(vendor.name);return nbValidationSrvc.submit("pageLinkVendorName")}return defineSpogSrvc.updateVendor(vendor).then((function(){vendor.enableEdit=!1;vendor.lastName=vendor.name}),(function(err){vendor.enableEdit=!0;vendor.lastName="";if(700001===err.ResultCode){-1===$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.indexOf(vendor.name)&&$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.push(vendor.name);nbValidationSrvc.submit("pageLinkVendorName");selectAndHilight(index)}else err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc).then((function(){selectAndHilight(index)}))}))};$scope.getLimitVal=function(len,d){d.name.length>len&&(d.name=d.name.slice(0,len))};$scope.safeUpdateVendor=function(vendor,index){return vendor.addSafeVendor?vendor.addSafeVendor(vendor,index):$scope.updateVendorName(vendor,index)};function addSafeVendor(vendor,index){selectAndHilight(index);if(vendor.lastName===vendor.name)return vendor.name;vendor.lastName=vendor.name;if(!vendor.name||!nbValidationSrvc.getValidator("generalForbidWindowsAndMongoChars")(vendor.name)){$scope.viewModel.pageNameValid.rules.params=vendor.name;return nbValidationSrvc.submit("pageLinkVendorName")}if(_.find($scope.viewModel.vendors,(function(v){return v.name===vendor.name&&v.id!==vendor.id}))){$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.length=0;$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.push(vendor.name);return nbValidationSrvc.submit("pageLinkVendorName")}vendor.enableEdit=!1;return defineSpogSrvc.addVendor(vendor).then((function(vend){vendor.enableEdit=!1;$scope.viewModel.vendors[index]=vend;selectVendor(vend)}),(function(error){vendor.enableEdit=!0;if(error.ResultDesc){-1===$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.indexOf(vendor.name)&&$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.push(vendor.name);nbValidationSrvc.submit("pageLinkVendorName");selectAndHilight(index)}else nbAlertSrvc.notification(error.ResultDesc).then((function(){selectAndHilight(index)}))}))}$rootScope.$on(systemEvent.changedTenant,(function(){$scope.init()}));$scope.init=function(){defineSpogSrvc.getVendors().then((function(vendors){$scope.viewModel.vendors=vendors;if(_.isEmpty(vendors)){$scope.viewModel.selectedVendor=null;$scope.pageLinkData.length=0}else selectVendor($scope.viewModel.vendors[0])}))}}}(NetBrain);!function(){angular.module("nb.dataview").factory("nb.dataview.httpDefineSpogSrvc",httpDefineSpogSrvc);httpDefineSpogSrvc.$inject=["$rootScope","$http","$q","$timeout","nb.ng.httpAuthSrvc","nb.ng.nbHttp","$upload","nb.ng.utilitySrvc"];function httpDefineSpogSrvc($rootScope,$http,$q,$timeout,httpAuthSrvc,nbHttp,$upload,utilitySrvc){return{getVendors:function(){return nbHttp.get("spog/vendors")},addVendor:function(data){return nbHttp.post("spog/vendors",data)},updateVendor:function(data){return nbHttp.put("spog/vendors",data)},deleteVendor:function(data){return nbHttp.delete("spog/vendors",data)},enableVendor:function(data){return nbHttp.post("spog/vendors/enable",data)},enablePageLinks:function(data){return nbHttp.post("spog/pageLinks/enable",data)},getPageLInk:function(data){return nbHttp.post("spog/getpagelinks",data)},getPageLinkById:function(id){return nbHttp.get(utilitySrvc.formatString("spog/pagelinks/{id}",{id:id}))},addPageLink:function(data){return nbHttp.post("spog/pagelinks",data)},updatePageLink:function(data){return nbHttp.put("spog/pagelinks",data)},deletePageLink:function(data){return nbHttp.delete("spog/pagelinks",data)},saveAsPageLink:function(data){return nbHttp.post("spog/pagelinks/copy",data)},getGenericVarable:function(data){return nbHttp.post("spog/getgenericvariables",data)},addGenericVarable:function(data){return nbHttp.post("spog/genericvariables",data)},updateGenericVarable:function(data){return nbHttp.put("spog/genericvariables",data)},deleteGenericVarable:function(data){return nbHttp.delete("spog/genericvariables",data)}}}}(NetBrain);!function(){angular.module("nb.dataview").controller("nb.dataview.addPageLinkDialogCtrl",addPageLinkDialogCtrl);addPageLinkDialogCtrl.$inject=["$scope","$uibModalInstance","$uibModal","$timeout","$filter","nb.ng.httpAuthSrvc","nb.ng.userSrvc","nb.ng.nbValidationSrvc","nb.dataview.defineSpogSrvc","nb.common.nbAlertSrvc","params"];function addPageLinkDialogCtrl($scope,$uibModalInstance,$uibModal,$timeout,$filter,httpAuthSrvc,userSrvc,nbValidationSrvc,defineSpogSrvc,nbAlertSrvc,params){$scope.viewModel=angular.copy(params);$scope.viewModel.pageNameValid={method:"blur",rules:[{ruleId:"required",params:$scope.viewModel.name||"",errorMessage:"Please specify a Page Name."},{ruleId:"duplicationChecker",params:{lsExistingNames:[]},errorMessage:"A duplicate page link already exists."},{ruleId:"generalForbidWindowsAndMongoChars",params:$scope.viewModel.name||"",errorMessage:"The following characters cannot be used: \\ / : * ?  < > | . $."}]};$scope.getLimitVal=function(len,d,key){var str="";(str=d[key=key||"name"]).length>len&&(d[key]=str.slice(0,len))};$scope.viewModel.pageUrlValid={method:"blur",params:$scope.viewModel.url||"",rules:[{ruleId:"required",errorMessage:"Please specify a URL."}]};$scope.viewModel.qualify||($scope.viewModel.qualify={Conditions:[],Expression:""});$scope.onCancel=function(){$uibModalInstance.dismiss()};$scope.$watch("viewModel.url",(function(value){$scope.viewModel.url=(value||"").replace(/\n/g,"")}));$scope.onOK=function(){$timeout((function(){$scope.viewModel.url=$scope.viewModel.url.replace(/^\s*$/gi,"");nbValidationSrvc.submit("addPageLinkName").then((function(){if($scope.viewModel.url){var ret=defineSpogSrvc.getPageLinkParams($scope.viewModel);("add"===$scope.viewModel.openFrom?defineSpogSrvc.addPageLink:defineSpogSrvc.updatePageLink)(ret).then((function(data){$uibModalInstance.close(data)}),(function(err){if(700001===err.ResultCode){$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.push($scope.viewModel.name);nbValidationSrvc.submit("addPageLinkName")}else err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))}}),(function(){nbValidationSrvc.submit("addPageLinkName")}))}))};$scope.qualify=$scope.viewModel.qualify}}(NetBrain);!function(){angular.module("nb.dataview").controller("nb.dataview.saveAsPageLinkCtrl",saveAsPageLinkCtrl);saveAsPageLinkCtrl.$inject=["$scope","$uibModalInstance","$uibModal","$timeout","nb.ng.utilitySrvc","nb.ng.nbValidationSrvc","nb.dataview.defineSpogSrvc","nb.common.nbAlertSrvc","params"];function saveAsPageLinkCtrl($scope,$uibModalInstance,$uibModal,$timeout,utilitySrvc,nbValidationSrvc,defineSpogSrvc,nbAlertSrvc,params){$scope.onCancel=function(){$uibModalInstance.dismiss()};$scope.viewModel=angular.copy(params);$scope.viewModel.name="";$scope.viewModel.pageNameValid={method:"blur",rules:[{ruleId:"required",errorMessage:"Please specify a Page Name."},{ruleId:"duplicationChecker",params:{lsExistingNames:[]},errorMessage:"A duplicate page link already exists."},{ruleId:"generalForbidWindowsAndMongoChars",params:"",errorMessage:"The following characters cannot be used: \\ / : * ?  < > | . $."}]};$scope.getLimitVal=function(len,d,key){var str="";(str=d[key=key||"name"]).length>len&&(d[key]=str.slice(0,len))};$scope.onOK=function(){if(!$scope.viewModel.name||!nbValidationSrvc.getValidator("generalForbidWindowsAndMongoChars")($scope.viewModel.name)){$scope.viewModel.pageNameValid.rules.params=$scope.viewModel.name;return nbValidationSrvc.submit("saveAsPageLinkName")}return defineSpogSrvc.saveAsPageLink({vendorId:$scope.viewModel.vendorId,name:$scope.viewModel.name,pageLinkId:$scope.viewModel.id}).then((function(data){$uibModalInstance.close(data)}),(function(err){if(700001===err.ResultCode){$scope.viewModel.pageNameValid.rules[1].params.lsExistingNames.push($scope.viewModel.name);nbValidationSrvc.submit("saveAsPageLinkName")}else err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))}}}(NetBrain);!function(){angular.module("nb.dataview").controller("nb.dataview.addGenericVariableDialogCtrl",addGenericVariableDialogCtrl);addGenericVariableDialogCtrl.$inject=["$scope","$uibModalInstance","$uibModal","$timeout","$filter","nb.ng.httpAuthSrvc","nb.ng.userSrvc","nb.ng.nbValidationSrvc","nb.dataview.defineSpogSrvc","nb.common.nbAlertSrvc","params"];function addGenericVariableDialogCtrl($scope,$uibModalInstance,$uibModal,$timeout,$filter,httpAuthSrvc,userSrvc,nbValidationSrvc,defineSpogSrvc,nbAlertSrvc,params){$scope.viewModel=params;$scope.viewModel.genericVariablesNameValid={method:"blur",rules:[{ruleId:"required",errorMessage:"Please specify a generic variables Name."},{ruleId:"duplicationChecker",params:{lsExistingNames:[]},errorMessage:"The {name} already exists in the system."},{ruleId:"verifiyVariable",params:$scope.viewModel.name,errorMessage:'The variable name must start with a letter or "_", and can only contain letters, numbers and "_".'}]};$scope.viewModel.genericVariablesValueValid={method:"blur",rules:[{ruleId:"required",errorMessage:"Please specify a generic variables Value."},{ruleId:"duplicationChecker",params:{lsExistingNames:[]},errorMessage:"The value already exist."}]};$scope.onCancel=function(){$uibModalInstance.dismiss()};$scope.getLimitVal=function(len,d,key){var str="";(str=d[key=key||"name"]).length>len&&(d[key]=str.slice(0,len))};$scope.onOK=function(){var ret=defineSpogSrvc.getGenericVariablesParams($scope.viewModel);nbValidationSrvc.submit("addGenericVariablesValid").then((function(){("add"===$scope.viewModel.openFrom?defineSpogSrvc.addGenericVarable:defineSpogSrvc.updateGenericVarable)(ret).then((function(data){$uibModalInstance.close(data||ret)}),(function(err){if(700001===err.ResultCode){$scope.viewModel.genericVariablesNameValid.rules[1].params.lsExistingNames.push($scope.viewModel.name);nbValidationSrvc.submit("addGenericVariablesValid")}else err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))}))}}}(NetBrain);!function(){angular.module("nb.dataview").controller("nb.dataview.genericVariableCtrl",genericVariableCtrl);genericVariableCtrl.$inject=["$scope","$rootScope","$timeout","$q","nb.dataview.defineSpogSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc"];function genericVariableCtrl($scope,$rootScope,$timeout,$q,defineSpogSrvc,nbAlertSrvc,utilitySrvc){$scope.viewModel={filterText:"",openFrom:!!$scope.openFrom,genericVariableRowActionMenu:[{template:"Edit",action:function(rows){$scope.onEdit(rows)}},{template:"Delete",permission:NetBrain.NG.Permissions.discoverTuneNetworkDevice,action:function(rows){row=rows,nbAlertSrvc.confirm("Are you sure you want to delete this generic variable?").then((function(){defineSpogSrvc.deleteGenericVariable([row.id]).then((function(){$scope.genericVariableData.splice($scope.genericVariableData.indexOf(row),1)}),(function(err){err.ResultDesc&&nbAlertSrvc.notification(err.ResultDesc)}))}));var row}}]};var nameFieldTemplate=$scope.viewModel.openFrom?"<span ":'<span ng-click="grid.appScope.onEdit(row.entity)" class="page-link-name-edit" ';$scope.genericVariableData=[];$scope.selectedGenericVariable=$scope.selectedGenericVariable||[];$scope.genericVariableGridOptions={data:"genericVariableData",multiSelect:!1,enableSelection:!0,modifierKeysToMultiSelect:!1,enableFullRowSelection:!0,enableRowHeaderSelection:!1,enableColumnMenus:!1,enableColumnResize:!0,enableRowContextMenu:!0,rowContextMenuItems:function(row){return $scope.viewModel.pageLinkRowActionMenu},columnDefs:[{field:"name",displayName:"Name",width:"20%",cellTemplate:'<div class="ui-grid-cell-contents" style="float: left; text-align: left;">'+nameFieldTemplate+'title="{{COL_FIELD}}" ng-bind-html="COL_FIELD | nbParserTreeHighlightFilter: grid.appScope.viewModel.searchKeyword"></span></div>'},{field:"value",displayName:"Value",width:"40%",cellTemplate:'<div class="ui-grid-cell-contents" style="float: left; text-align: left;"><span title="{{COL_FIELD}}" ng-bind-html="COL_FIELD | nbParserTreeHighlightFilter: grid.appScope.viewModel.searchKeyword"></span></div>'},{field:"description",displayName:"Description",width:"40%",cellTemplate:'<div class="ui-grid-cell-contents" style="float: left; text-align: left;"><span title="{{COL_FIELD}}" ng-bind-html="COL_FIELD | nbParserTreeHighlightFilter: grid.appScope.viewModel.searchKeyword"></span></div>'}],enableRowActionMenu:!0,rowActionMenuItems:function(row){return $scope.viewModel.genericVariableRowActionMenu},onRegisterApi:function(gridApi){$scope.viewModel.gridApiGenericVariable=gridApi;$scope.viewModel.gridApiGenericVariable.selection.on.rowSelectionChanged($scope,(function(row){$scope.selectedGenericVariable.splice.apply($scope.selectedGenericVariable,[0,$scope.selectedGenericVariable.length].concat(angular.copy($scope.viewModel.gridApiGenericVariable.selection.getSelectedRows())))}))}};$scope.onFilter=function(event){if(38==event.which||40==event.which||13==event.which){event.preventDefault();$scope.showGenericVariable($scope.viewModel.filterText).then((function(){$scope.viewModel.searchKeyword=$scope.viewModel.filterText}))}};$scope.clearFilter=function(){$scope.viewModel.searchKeyword=$scope.viewModel.filterText;$scope.showGenericVariable($scope.viewModel.filterText)};$scope.onEdit=function(row){var index=$scope.genericVariableData.indexOf(row);var params=_.extend({openFrom:"edit"},row);defineSpogSrvc.addGenericVariableDialog(params).then((function(editData){$scope.genericVariableData.splice(index,1,editData)}))};$scope.showGenericVariable=function(searchText){return defineSpogSrvc.getGenericVarable(searchText).then((function(data){return $scope.genericVariableData.splice.apply($scope.genericVariableData,[0,$scope.genericVariableData.length].concat(data))}))};$scope.init=function(){$scope.showGenericVariable($scope.viewModel.filterText)};$scope.addGenericVariable=function(){defineSpogSrvc.addGenericVariableDialog({openFrom:"add"}).then((function(data){$scope.genericVariableData.push(data)}),(function(error){error&&error.ResultDesc&&nbAlertSrvc.notification(error.ResultDesc)}))};$rootScope.$on(systemEvent.changedTenant,(function(){$scope.init()}))}}(NetBrain);!function(){angular.module("nb.dataview").controller("nb.dataview.nbSpogSelectPropertyModalCtrl",SpogSelectPropertyModalCtrl);SpogSelectPropertyModalCtrl.$inject=["$scope","$rootScope","$uibModal","$uibModalInstance","nb.common.nbSelectPropertyMgr","args","nb.systemmodel.httpDeviceSchemaSrvc","nb.systemmodel.deviceSchemaMgrSrvc","nb.common.nbAlertSrvc","$filter","ivhTreeviewMgr"];function SpogSelectPropertyModalCtrl($scope,$rootScope,$uibModal,$uibModalInstance,nbSelectPropertyMgr,args,httpDeviceSchemaSrvc,deviceSchemaMgrSrvc,nbAlertSrvc,$filter,ivhTreeviewMgr){$scope.isGetAllSchema=args.isGetAllSchema;$scope.isGetDeviceSchema=args.isGetDeviceSchema;$scope.isGetInterfaceSchema=args.isGetInterfaceSchema;$scope.isNoteLabel=args.isNoteLabel;$scope.canOnlySelectSimpleDataType=args.canOnlySelectSimpleDataType;$scope.isDataUnitFromQapp=args.isDataUnitFromQapp;$scope.isLegacyDeviceHasRef=args.isLegacyDeviceHasRef;$scope.lsDataUnitFromQapp=args.lsDataUnitFromQapp;$scope.isSelectedPropertyRef=!1;$scope.selectedNodeType={curNodeType:VisualSpaceConstant.legacySchemaKeyword,isLegacyDevice:!0,isLegacyDeviceHasRef:!!$scope.isLegacyDeviceHasRef};$scope.selectedNodeIncludeRefSchema=!1;$scope.currentCategoryIncludedSelected=!1;$scope.legacyRefSchemaId="legacyRefSchema";$scope.legacyRefList=[];$scope.legacyCategoryDropdownIndexStep=0;args.selectedNodeType&&($scope.selectedNodeType=args.selectedNodeType);$scope.currentSelectedProperties=[];$scope.allGenericSchemaDisplayNames=args.allDeviceGenericSchemaDisplayNames;if(args.isDataUnitFromQapp){$scope.DataUnitType=DataUnitType;if(args.preSelectedDataUnitUId&&args.preSelectedDataUnitUId.length>0)for(var i=0;i<$scope.lsDataUnitFromQapp.length;i++)args.preSelectedDataUnitUId.indexOf($scope.lsDataUnitFromQapp[i].uId)>-1&&($scope.lsDataUnitFromQapp[i].isSelected=!0);$scope.lsDataUnitFromQapp.sort((function(p1,p2){return p1.name.localeCompare(p2.name)}))}$scope.isDeviceProperty=args.isDeviceProperty;$scope.isInterfaceProperty=args.isInterfaceProperty;$scope.intfSchemaId=$scope.isGetAllSchema||$scope.isGetDeviceSchema||$scope.isGetInterfaceSchema?"all":args.intfSchemaId;$scope.deviceId=args.deviceId;$scope.deviceType=args.deviceType;$scope.currSchemaId=$scope.selectedNodeType.curNodeType.id;$scope.isGeneralProperty=!$scope.deviceId;var preSelectedPropertyId=args.preSelectedPropertyId&&args.preSelectedPropertyId!=[]?args.preSelectedPropertyId:[];$scope.lsSelectedProperty=[];$scope.filterTarget={filterText:"",searchText:""};$scope.treeOptions={enableTwoWayBinding:!0,enableAutoSelect:!1,idAttribute:"ID",childrenAttribute:"children",expandToDepth:-1,enableMultipleSelect:!1,nodeClickCallback:function(node){$scope.lsSelectedProperty=[];node.selected&&$scope.lsSelectedProperty.push(node)},labelTemplate:function(node,trvw,labelScope){return"<span>"+$filter("nbHighlight")(node.displayName,$scope.filterTarget.filterText)+"</span>"}};$scope.propertyCategories=$scope.canOnlySelectSimpleDataType?[{name:($scope.isDeviceProperty?"Device":"Interface")+" Property",id:0}]:[{name:($scope.isDeviceProperty?"Device":"Interface")+" Property",id:0},{name:"Device Data",id:1},{name:"NCT Table",id:2}];$scope.initLegacyCategoryList=function(){if($scope.isDeviceProperty&&$scope.selectedNodeType.isLegacyDeviceHasRef){$scope.propertyCategories=[{name:($scope.isDeviceProperty?"Device":"Interface")+" Property",id:0},{name:"Reference Schema",id:1}];if(!$scope.canOnlySelectSimpleDataType){$scope.propertyCategories.push({name:"Device Data",id:2});$scope.propertyCategories.push({name:"NCT Table",id:3})}}};$scope.initLegacyDeviceCategoryList=function(){$scope.propertyCategories=[{name:"Device Property",id:0}];$scope.selectedNodeType.isLegacyDeviceHasRef&&$scope.propertyCategories.push({name:"Reference Schema",id:1});if(!$scope.canOnlySelectSimpleDataType){$scope.propertyCategories.push({name:"Device Data",id:2});$scope.propertyCategories.push({name:"NCT Table",id:3})}};$scope.initLegacyInterfaceCategoryList=function(){$scope.propertyCategories=[{name:"Interface Property",id:0}];$scope.selectedNodeType.isLegacyDeviceHasRef&&$scope.propertyCategories.push({name:"Reference Schema",id:1});if(!$scope.canOnlySelectSimpleDataType){$scope.propertyCategories.push({name:"Device Data",id:3});$scope.propertyCategories.push({name:"NCT Table",id:4})}};$scope.initLegacyAllCategoryList=function(){var id=0;$scope.propertyCategories=[{name:"Device Property",id:id++},{name:"Interface Property",id:id++}];$scope.selectedNodeType.isLegacyDeviceHasRef&&$scope.propertyCategories.push({name:"Reference Schema",id:id++});if(!$scope.canOnlySelectSimpleDataType){$scope.propertyCategories.push({name:"Device Data",id:id++});$scope.propertyCategories.push({name:"NCT Table",id:id++})}};$scope.setPropertyCategories=function(){if($scope.isGetAllSchema)!function(){$scope.propertyCategories=[{name:"Device Property",id:0},{name:"Interface Property",id:1}];if($scope.selectedNodeType.isLegacyDevice&&!$scope.canOnlySelectSimpleDataType){$scope.propertyCategories.push({name:"Device Data",id:2});$scope.propertyCategories.push({name:"NCT Table",id:3})}else{var selectedNodeTypeProperpty=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId];var propertyCategoriesIndex=2;if($scope.isDeviceProperty&&Object.prototype.hasOwnProperty.call(selectedNodeTypeProperpty,"refSchemas")){$scope.propertyCategories.push({name:"Reference Schema",id:propertyCategoriesIndex++});$scope.selectedNodeIncludeRefSchema=!0}if(Object.prototype.hasOwnProperty.call(selectedNodeTypeProperpty,"children"))for(var ii=0;ii<selectedNodeTypeProperpty.children.length;ii++)$scope.propertyCategories.push({name:selectedNodeTypeProperpty.children[ii].displayName,id:propertyCategoriesIndex++})}}();else if($scope.isGetDeviceSchema)!function(){$scope.propertyCategories=[{name:"Device Property",id:0}];if($scope.selectedNodeType.isLegacyDevice&&!$scope.canOnlySelectSimpleDataType){$scope.propertyCategories.push({name:"Device Data",id:2});$scope.propertyCategories.push({name:"NCT Table",id:3})}else{var selectedNodeTypeProperpty=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId];var propertyCategoriesIndex=2;if($scope.isDeviceProperty&&Object.prototype.hasOwnProperty.call(selectedNodeTypeProperpty,"refSchemas")){$scope.propertyCategories.push({name:"Reference Schema",id:propertyCategoriesIndex++});$scope.selectedNodeIncludeRefSchema=!0}if(Object.prototype.hasOwnProperty.call(selectedNodeTypeProperpty,"children"))for(var ii=0;ii<selectedNodeTypeProperpty.children.length;ii++)$scope.propertyCategories.push({name:selectedNodeTypeProperpty.children[ii].displayName,id:propertyCategoriesIndex++})}}();else if($scope.isGetInterfaceSchema)!function(){$scope.propertyCategories=[{name:"Interface Property",id:1}];if($scope.selectedNodeType.isLegacyDevice&&!$scope.canOnlySelectSimpleDataType){$scope.propertyCategories.push({name:"Device Data",id:2});$scope.propertyCategories.push({name:"NCT Table",id:3})}else{var selectedNodeTypeProperpty=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId];var propertyCategoriesIndex=2;if($scope.isDeviceProperty&&Object.prototype.hasOwnProperty.call(selectedNodeTypeProperpty,"refSchemas")){$scope.propertyCategories.push({name:"Reference Schema",id:propertyCategoriesIndex++});$scope.selectedNodeIncludeRefSchema=!0}if(Object.prototype.hasOwnProperty.call(selectedNodeTypeProperpty,"children"))for(var ii=0;ii<selectedNodeTypeProperpty.children.length;ii++)$scope.propertyCategories.push({name:selectedNodeTypeProperpty.children[ii].displayName,id:propertyCategoriesIndex++})}}();else{$scope.propertyCategories=[{name:($scope.isDeviceProperty?"Device":"Interface")+" Property",id:0}];if($scope.selectedNodeType.isLegacyDevice&&!$scope.canOnlySelectSimpleDataType){$scope.propertyCategories.push({name:"Device Data",id:1});$scope.propertyCategories.push({name:"NCT Table",id:2})}else{var selectedNodeTypeProperpty=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId];var propertyCategoriesIndex=1;if($scope.isDeviceProperty&&Object.prototype.hasOwnProperty.call(selectedNodeTypeProperpty,"refSchemas")){$scope.propertyCategories.push({name:"Reference Schema",id:propertyCategoriesIndex++});$scope.selectedNodeIncludeRefSchema=!0}if(Object.prototype.hasOwnProperty.call(selectedNodeTypeProperpty,"children"))for(var ii=0;ii<selectedNodeTypeProperpty.children.length;ii++)$scope.propertyCategories.push({name:selectedNodeTypeProperpty.children[ii].displayName,id:propertyCategoriesIndex++})}}};$scope.dictProperties={devProp:[],intfProp:[],devData:[],nctTable:[],legacyRefList:[]};$scope.lsProperties=[];$scope.needShowsInTreeView=function(){return!!($scope.selectedNodeType&&$scope.selectedNodeType.isLegacyDevice&&($scope.isDeviceProperty&&$scope.selectedNodeType.isLegacyDeviceHasRef||$scope.isInterfaceProperty&&$scope.selectedNodeType.isLegacyDeviceHasRef)&&1==$scope.displayPropertyCategory||$scope.selectedNodeType&&!$scope.selectedNodeType.isLegacyDevice)};$scope.onSelectPropertyCategory=function(cateId){if($scope.isGetAllSchema)!function(cateId){$scope.displayPropertyCategory=cateId;$scope.isSelectedPropertyRef=!1;if(!$scope.selectedNodeType||$scope.selectedNodeType&&$scope.selectedNodeType.isLegacyDevice)if($scope.selectedNodeType.isLegacyDeviceHasRef)switch(cateId){case 0:$scope.lsProperties=$scope.dictProperties.devProp;break;case 1:$scope.lsProperties=$scope.dictProperties.intfProp;break;case 2:$scope.lsProperties=$scope.dictProperties.legacyRefList;$scope.isSelectedPropertyRef=!0;break;case 3:$scope.lsProperties=$scope.dictProperties.devData;break;case 4:$scope.lsProperties=$scope.dictProperties.nctTable;break;default:nbAlertSrvc.alert("Error in nbSpogSelectPropertyModalCtrl")}else switch(cateId){case 0:$scope.lsProperties=$scope.dictProperties.devProp;break;case 1:$scope.lsProperties=$scope.dictProperties.intfProp;break;case 2:$scope.lsProperties=$scope.dictProperties.devData;break;case 3:$scope.lsProperties=$scope.dictProperties.nctTable;break;default:nbAlertSrvc.alert("Error in nbSpogSelectPropertyModalCtrl")}else{var defaultPropertyCategory=$scope.selectedNodeIncludeRefSchema?2:1;$scope.isSelectedPropertyRef=!1;switch(cateId){case 0:$scope.lsProperties=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId].props;break;case 1:if($scope.selectedNodeIncludeRefSchema){$scope.lsProperties=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId].refSchemas;$scope.isSelectedPropertyRef=!0}else $scope.lsProperties=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId].children[cateId-defaultPropertyCategory].children;break;default:$scope.lsProperties=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId].children[cateId-defaultPropertyCategory].children}}$scope.currentSelectedProperties=angular.copy($scope.lsProperties)}(cateId);else{$scope.displayPropertyCategory=cateId;$scope.isSelectedPropertyRef=!1;if(!$scope.selectedNodeType||$scope.selectedNodeType&&$scope.selectedNodeType.isLegacyDevice)if(($scope.isDeviceProperty||$scope.isInterfaceProperty)&&$scope.selectedNodeType.isLegacyDeviceHasRef)switch(cateId){case 0:$scope.lsProperties=$scope.isDeviceProperty?$scope.dictProperties.devProp:$scope.dictProperties.intfProp;break;case 1:$scope.lsProperties=$scope.dictProperties.legacyRefList;$scope.isSelectedPropertyRef=!0;break;case 2:$scope.lsProperties=$scope.dictProperties.devData;break;case 3:$scope.lsProperties=$scope.dictProperties.nctTable;break;default:nbAlertSrvc.alert("Error in nbSpogSelectPropertyModalCtrl")}else switch(cateId){case 0:$scope.lsProperties=$scope.isDeviceProperty?$scope.dictProperties.devProp:$scope.dictProperties.intfProp;break;case 1:$scope.lsProperties=$scope.dictProperties.devData;break;case 2:$scope.lsProperties=$scope.dictProperties.nctTable;break;default:nbAlertSrvc.alert("Error in nbSpogSelectPropertyModalCtrl")}else{var defaultPropertyCategory=$scope.selectedNodeIncludeRefSchema?2:1;$scope.isSelectedPropertyRef=!1;switch(cateId){case 0:$scope.lsProperties=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId].props;break;case 1:if($scope.selectedNodeIncludeRefSchema){$scope.lsProperties=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId].refSchemas;$scope.isSelectedPropertyRef=!0}else $scope.lsProperties=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId].children[cateId-defaultPropertyCategory].children;break;default:$scope.lsProperties=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId].children[cateId-defaultPropertyCategory].children}}$scope.currentSelectedProperties=angular.copy($scope.lsProperties)}};function checkIncludingSelectedNode(treeData){if(!$scope.currentCategoryIncludedSelected&&treeData&&treeData.length>0)for(var ii=0;ii<treeData.length;ii++){if(treeData[ii].ID===preSelectedPropertyId[0]){$scope.currentCategoryIncludedSelected=!0;$scope.selectedNodeType.isLegacyDevice&&(treeData[ii].selected=!0);break}!$scope.currentCategoryIncludedSelected&&treeData[ii].children&&treeData[ii].children.length>0&&checkIncludingSelectedNode(treeData[ii].children)}}$scope.checkSelectedCategoryForSDN=function(){var currentSchema=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId];var currentSchemaProps=currentSchema.props;if(currentSchemaProps){$scope.currentCategoryIncludedSelected=!1;checkIncludingSelectedNode(currentSchemaProps);if($scope.currentCategoryIncludedSelected)return 0}if($scope.selectedNodeIncludeRefSchema){$scope.currentCategoryIncludedSelected=!1;checkIncludingSelectedNode(currentSchema.refSchemas);if($scope.currentCategoryIncludedSelected)return 1}var indexStep=$scope.selectedNodeIncludeRefSchema?2:1;var childrenProperties=currentSchema.children;if(childrenProperties&&childrenProperties.length>0)for(var j=0;j<childrenProperties.length;j++){$scope.currentCategoryIncludedSelected=!1;checkIncludingSelectedNode(currentSchema.children[j].children);if($scope.currentCategoryIncludedSelected)return j+indexStep}return 0};$scope.initData=function(){var initCategory=0;if($scope.isGetAllSchema||$scope.isGetDeviceSchema||$scope.isGetInterfaceSchema)!function(){var initCategory=0;if($scope.isGetDeviceSchema)$scope.initLegacyDeviceCategoryList();else if($scope.isGetInterfaceSchema){initCategory=0;$scope.initLegacyInterfaceCategoryList()}else $scope.initLegacyAllCategoryList();$scope.dictProperties.legacyRefList=$scope.allGenericSchemaDisplayNames[$scope.legacyRefSchemaId];httpDeviceSchemaSrvc.getAllDeviceSchemasFilter(!1).then((function(jsList){deviceSchemaMgrSrvc.initDeviceSchemaObjList(jsList);nbSelectPropertyMgr.getAll_promise(null,null,null,!0).then((function(lsProps){lsProps.push({displayName:"Hostname",type:"string",ID:"name",isDeviceSchema:!0,isSchema:!0,shortDisplayname:""});lsProps.sort((function(p1,p2){return p1.displayName.localeCompare(p2.displayName)}));$scope.isInterfaceProperty&&($scope.lsPreSelectIntfSchemaIds=preSelectedPropertyId);lsProps.forEach((function(prop){if(!$scope.canOnlySelectSimpleDataType||isSimpleDataType(prop.type)){if(prop.isSchema){if(preSelectedPropertyId.indexOf(prop.ID)>-1){$scope.lsSelectedProperty.push(prop);prop.isSelected=!0;initCategory=0}prop.isDeviceSchema&&$scope.dictProperties.devProp.push(prop)}if(prop.isTable&&!prop.isNctTable){if(preSelectedPropertyId.indexOf(prop.dataType)>-1||preSelectedPropertyId.indexOf(prop.displayName)>-1){$scope.lsSelectedProperty.push(prop);prop.isSelected=!0;initCategory=1+$scope.legacyCategoryDropdownIndexStep}prop.children&&prop.children.forEach((function(childProp){if(preSelectedPropertyId.indexOf(childProp.dataType)>-1||preSelectedPropertyId.indexOf(childProp.displayName)>-1){$scope.lsSelectedProperty.push(childProp);childProp.isSelected=!0;initCategory=1+$scope.legacyCategoryDropdownIndexStep;prop.children.forEach((function(childProp2){childProp2.expanded=!0}))}}));$scope.dictProperties.devData.push(prop)}if(prop.isNctTable){if(preSelectedPropertyId.indexOf(prop.dataName)>-1){$scope.lsSelectedProperty.push(prop);prop.isSelected=!0;initCategory=2+$scope.legacyCategoryDropdownIndexStep}$scope.dictProperties.nctTable.push(prop)}if(prop.isConfigFile){if(preSelectedPropertyId.indexOf(prop.dataType)>-1){$scope.lsSelectedProperty.push(prop);prop.isSelected=!0;initCategory=2+$scope.legacyCategoryDropdownIndexStep}$scope.dictProperties.nctTable.push(prop)}}}));if(!$scope.isGeneralProperty)for(var ii=0;ii<$scope.dictProperties.devData.length;ii++){var currProperty=$scope.dictProperties.devData[ii];if(currProperty.children&&(currProperty.dataType===DeviceDataType.RouteTable||currProperty.dataType===DeviceDataType.ArpTable)){var lsSubTables=angular.copy(currProperty.children);delete currProperty.children;currProperty.hasChildren=!0;for(var j=0;j<lsSubTables.length;j++){lsSubTables[j].isChild=!0;$scope.dictProperties.devData.splice(1+ii++,0,lsSubTables[j])}}}})).then((function(){$scope.onSelectPropertyCategory(initCategory);$scope.displayPropertyCategory=initCategory;$scope.isDataReady=!0}))}))}();else if($scope.selectedNodeType&&!$scope.selectedNodeType.isLegacyDevice){var selectedNodeTypeProperpty=$scope.allGenericSchemaDisplayNames[$scope.currSchemaId];$scope.dictProperties.devProp=selectedNodeTypeProperpty;$scope.setPropertyCategories();if(preSelectedPropertyId&&preSelectedPropertyId.length>0){var selectedCategoryIndex=$scope.checkSelectedCategoryForSDN(selectedNodeTypeProperpty,preSelectedPropertyId);initCategory=selectedCategoryIndex||0}$scope.onSelectPropertyCategory(initCategory);$scope.displayPropertyCategory=initCategory;ivhTreeviewMgr.deselectAll($scope.lsProperties,$scope.treeOptions);preSelectedPropertyId&&preSelectedPropertyId.length>0&&ivhTreeviewMgr.select($scope.lsProperties,preSelectedPropertyId[0],$scope.treeOptions);$scope.isDataReady=!0}else{$scope.legacyCategoryDropdownIndexStep=0;if($scope.isDeviceProperty&&$scope.selectedNodeType&&$scope.selectedNodeType.isLegacyDevice&&$scope.selectedNodeType.isLegacyDeviceHasRef){$scope.dictProperties.legacyRefList=$scope.allGenericSchemaDisplayNames[$scope.legacyRefSchemaId];$scope.legacyCategoryDropdownIndexStep=1;$scope.isGetAllSchema?$scope.initLegacyAllCategoryList():$scope.isGetDeviceSchema?$scope.initLegacyDeviceCategoryList():$scope.isGetInterfaceSchema?$scope.initLegacyInterfaceCategoryList():$scope.initLegacyCategoryList();$scope.currentCategoryIncludedSelected=!1;checkIncludingSelectedNode($scope.dictProperties.legacyRefList);$scope.currentCategoryIncludedSelected&&(initCategory=1)}httpDeviceSchemaSrvc.getAllDeviceSchemasFilter(!1).then((function(jsList){deviceSchemaMgrSrvc.initDeviceSchemaObjList(jsList);nbSelectPropertyMgr.getAll_promise($scope.isDeviceProperty,$scope.deviceId,$scope.deviceType).then((function(lsProps){lsProps.sort((function(p1,p2){return p1.displayName.localeCompare(p2.displayName)}));$scope.isInterfaceProperty&&($scope.lsPreSelectIntfSchemaIds=preSelectedPropertyId);lsProps.forEach((function(prop){if($scope.isDeviceProperty&&prop.isSchema){if(preSelectedPropertyId.indexOf(prop.ID)>-1){$scope.lsSelectedProperty.push(prop);prop.isSelected=!0;initCategory=0}$scope.dictProperties.devProp.push(prop)}if(prop.isTable&&!prop.isNctTable){if(preSelectedPropertyId.indexOf(prop.dataType)>-1||preSelectedPropertyId.indexOf(prop.displayName)>-1){$scope.lsSelectedProperty.push(prop);prop.isSelected=!0;initCategory=1+$scope.legacyCategoryDropdownIndexStep}prop.children&&prop.children.forEach((function(childProp){if(preSelectedPropertyId.indexOf(childProp.dataType)>-1||preSelectedPropertyId.indexOf(childProp.displayName)>-1){$scope.lsSelectedProperty.push(childProp);childProp.isSelected=!0;initCategory=1+$scope.legacyCategoryDropdownIndexStep;prop.children.forEach((function(childProp2){childProp2.expanded=!0}))}}));$scope.dictProperties.devData.push(prop)}if(prop.isNctTable){if(preSelectedPropertyId.indexOf(prop.dataName)>-1){$scope.lsSelectedProperty.push(prop);prop.isSelected=!0;initCategory=2+$scope.legacyCategoryDropdownIndexStep}$scope.dictProperties.nctTable.push(prop)}if(prop.isConfigFile){if(preSelectedPropertyId.indexOf(prop.dataType)>-1){$scope.lsSelectedProperty.push(prop);prop.isSelected=!0;initCategory=2+$scope.legacyCategoryDropdownIndexStep}$scope.dictProperties.nctTable.push(prop)}}));if(!$scope.isGeneralProperty)for(var ii=0;ii<$scope.dictProperties.devData.length;ii++){var currProperty=$scope.dictProperties.devData[ii];if(currProperty.children&&(currProperty.dataType===DeviceDataType.RouteTable||currProperty.dataType===DeviceDataType.ArpTable)){var lsSubTables=angular.copy(currProperty.children);delete currProperty.children;currProperty.hasChildren=!0;for(var j=0;j<lsSubTables.length;j++){lsSubTables[j].isChild=!0;$scope.dictProperties.devData.splice(1+ii++,0,lsSubTables[j])}}}})).then((function(){$scope.onSelectPropertyCategory(initCategory);$scope.displayPropertyCategory=initCategory;$scope.isDataReady=!0}))}))}};args.isDataUnitFromQapp||$scope.initData();$scope.toggleExpansionByTableType=function(tableType){$scope.lsProperties.forEach((function(property){property.dataType===tableType&&(property.expanded=!property.expanded)}))};function getFilterData(query){var newTreeData=angular.copy($scope.currentSelectedProperties);!function filterData(children,query){for(var ii=0;ii<children.length;ii++){var tree=children[ii];var isMatchNode=!1;-1!=tree.displayName.toLowerCase().indexOf(query.toLowerCase())&&(isMatchNode=!0);var subChildren=tree.children;if(subChildren&&0!==subChildren.length){filterData(subChildren,query);isMatchNode||0!==subChildren.length||children.splice(ii--,1)}else isMatchNode||children.splice(ii--,1)}}(newTreeData,query);return newTreeData}$scope.onFilterFired=function(){$scope.filterTarget.filterText=$scope.filterTarget.searchText;if($scope.filterTarget.filterText&&$scope.filterTarget.filterText.length>0){if($scope.isDataReady&&$scope.selectedNodeType&&$scope.needShowsInTreeView()){$scope.lsProperties=getFilterData($scope.filterTarget.filterText);ivhTreeviewMgr.validate($scope.lsProperties,$scope.treeOptions)}$scope.lsProperties.forEach((function(prop){prop.isChild&&(prop.expanded=!0)}))}else{$scope.lsProperties=$scope.currentSelectedProperties;$scope.lsProperties.forEach((function(prop){(prop.isChild||prop.hasChildren)&&(prop.expanded=!1)}))}};$scope.isSelectionNeeded=function(){return!$scope.lsSelectedProperty||0===$scope.lsSelectedProperty.length};$scope.isOkBtnDisabled=function(){if($scope.isSelectionNeeded())return!0;if($scope.lsSelectedProperty&&$scope.lsSelectedProperty.length>0){if($scope.isNoteLabel&&(!$scope.lsSelectedProperty[0].type||"list"===$scope.lsSelectedProperty[0].type||"object"===$scope.lsSelectedProperty[0].type))return!0;if($scope.canOnlySelectSimpleDataType&&!isSimpleDataType($scope.lsSelectedProperty[0].type))return!0}return!1};$scope.isTreeViewNeeded=function(){return $scope.isInterfaceProperty&&0===$scope.displayPropertyCategory||($scope.isGetAllSchema||$scope.isGetDeviceSchema||$scope.isGetInterfaceSchema)&&1===$scope.displayPropertyCategory};$scope.onOK=function(){$scope.lsSelectedProperty[0].isRefLink=$scope.isSelectedPropertyRef;$scope.lsSelectedProperty[0].isInterface="Interface Property"===$scope.propertyCategories[$scope.displayPropertyCategory].name;$uibModalInstance.close($scope.lsSelectedProperty[0])};$scope.onCancel=function(){$uibModalInstance.dismiss()};function isSimpleDataType(varType){return"string"===varType||"bool"===varType||"int"===varType||"double"===varType||"configlet"===varType||"filter"===varType||"float"===varType}}}();!function(){angular.module("nb.dataview").controller("nb.dataview.nbSpogParserLibSelectorCtrl",SpogParserLibSelectorCtrl);SpogParserLibSelectorCtrl.$inject=["$scope","$rootScope","$timeout","$uibModalInstance","nb.parserlib.parserTree2Srvc","nb.common.nbAlertSrvc","nb.dataviewtemplate.httpDataViewTemplateSrvc","nb.parserlib.parserEditSrvc","nb.dataviewtemplate.editDataViewTemplateSrvc","selectedParsers","canOnlySelectSimpleDataType","$q"];function SpogParserLibSelectorCtrl($scope,$rootScope,$timeout,$uibModalInstance,nbParserTreeSrvc,nbAlertSrvc,httpDataViewTemplateSrvc,parserEditSrvc,editDataViewTemplateSrvc,selectedParsers,canOnlySelectSimpleDataType,$q){var parserTreeMgr={};$scope.ivhTreeOptions={defaultSelectedState:!0,validate:!0,expandToDepth:1,labelAttribute:"name",idAttribute:"id",parentIdAttribute:"parentId",childrenAttribute:"child",expandedAttribute:"expended",useCheckboxes:!1,nodeTpl:'<div ng-if="node[\'$isDisplay\']" style="min-width: 100%; white-space: nowrap; display:inline-block;"><div style="white-space: nowrap; display:inline-block; position: relative;" class="ivh-tree-node ivh-node-row" ng-click="node[\'$_tree\'][\'handle\'][\'onSelectNode\'](node)" ng-class="{selected: (node[\'$selected\'])}">    <span ivh-treeview-toggle class="node-icon">        <span ng-if="::!node[\'$isFolder\']">            <span ng-style="{\'opacity\': (node[\'$hasDispChild\']) ? 1 : 0}" ng-class="node[\'$expended\']?\'icon_nb_tree_collapse\':\'icon_nb_tree_expand\'"></span>            <span style="margin: -5px 0 0 0;" ng-class="node[\'cls\']?node[\'cls\']:\'icon_nb_parser_folder_variable\'"></span>        </span>        <span ng-if="node[\'$isFolder\'] && node[\'$expended\']">            <span ng-style="{\'opacity\': (node[\'$hasDispChild\']) ? 1 : 0}" class="icon_nb_tree_collapse"></span>            <span style="margin: -5px 0 0 0;" ng-class="node[\'cls\']?node[\'cls\']:\'icon_nb_folder\'"></span>        </span>        <span ng-if="node[\'$isFolder\'] && !(node[\'$expended\'])">            <span ng-style="{\'opacity\': (node[\'$hasDispChild\']) ? 1 : 0}" class="icon_nb_tree_expand"></span>            <span style="margin: -5px 0 0 0;" ng-class="node[\'cls\']?node[\'cls\']:\'icon_nb_folder\'"></span>        </span>    </span>    <span title="{{node[\'$name\']}}" ng-if="!node[\'$edit\']" style="cursor: pointer;" id="{{\'parsertree\'+node[\'id\']}}" spellcheck="false" class="nbUiGridCellWithMenuCell" ng-bind-html="node[\'$name\'] | nbParserTreeHighlightFilter: !node[\'$edit\'] && (node[\'$_tree\'][\'_search\']||node[\'_search\'])"></span>    <span ng-if="node[\'intfKey\'] === true && node.type!==\'3\' && node.type!==\'4\'" class="icon_nb_key" style="font-size: 14px; font-weight: 600;"></span>    <span ng-if="node[\'$edit\']" style="cursor: pointer;" id="editTree{{::node[\'$id\']}}" contenteditable="true" ng-model="node[\'$name\']" nb-on-update-directive="node[\'$_tree\'][\'handle\'][\'onUpdateNodeName\'](node, nbTextChanged)" spellcheck="false" class="nbUiGridCellWithMenuCell editHighlight"></span>    <span ng-if="node[\'$_tree\'][\'_settings\'][\'enableCalcNodeNumber\'] && node[\'$child\'] && node[\'$dispNo\']"  class="nbUiGridCellWithMenuCell">        &nbsp;({{node[\'$fileNo\']}})    </span>    <div ng-if="node[\'$menu\'].length > 0" class="btn-group dropdown" style="position: absolute; top: 0px; right: 0px;">        <span style="cursor: pointer;" class="nb-pl-msdisplay" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"><i style="margin-top: 2px; background-color: white;" class="icon_nb_action_menu nb-parser-icon"></i></span>        <ul class="dropdown-menu dropdown-menu-custom" uib-dropdown-menu role="menu" style="font-size: 12px; top: 20px; right: 0;left: inherit;">'+"            <li class=\"nb-select-option\" ng-click=\"node['$_tree']['handle']['onSelectAction'](node, action);\" action-index=\"$index\" ng-repeat=\"action in node['$menu']\" ng-style=\"{'border-top':(action['split']) ? '1px solid #cccccc' : 'none'}\">                <a>{{::action.title}}</a>           </li>        </ul>    </div></div><div ng-if=\"node['$expended'] || node['defaultExpand']\" ivh-treeview-children class=\"ivh-treeview-twistie-expanded\"></div></div>"};$scope.browseTree={};$scope.disableOk=!0;$scope.showCancelButton=!0;$scope.modalClose=!0;$scope.previousParserId=selectedParsers.previousParserId;$scope.parserOps={parserId:"",activeIndex:null,selectVarFullName:""};var originalResultNoDollar="_original_result";var singleValueVar="Single Value";$scope.currentSample={};$scope.selectedVariable=null;$scope.branch=selectedParsers.branch;$scope.requestAvoidBlockUI=!0;var setOkButtonState=function(node){$scope.disableOk=!1;var parentId=null;if(node.$_parent)if((parentId=removeDollar(node.$_parent.fullName))===originalResultNoDollar){parentId=singleValueVar;3!==Number(node.type)&&4!==Number(node.type)||(parentId=null)}else parentId&&parentId.indexOf(originalResultNoDollar)>=0&&(parentId=parentId.substr(originalResultNoDollar.length+1));$scope.selectedVariable=node;if($scope.selectedVariable&&$scope.selectedVariable.name&&$scope.selectedVariable.name===singleValueVar)$scope.disableOk=!0;else{isInterface()&&parentId&&parentId!==singleValueVar&&($scope.disableOk=!1);isInterface()&&!parentId&&($scope.disableOk=!0);"device"===getVariableType()&&parentId&&parentId!==singleValueVar&&($scope.disableOk=!0);if("category"===node.type||"parser"===node.type){$scope.disableOk=!0;$scope.selectVariable=null}node.fullName&&node.fullName.replace("$","")===originalResultNoDollar&&($scope.disableOk=!0)}};var getTextViewByNode=function(node){if(!node)return[];var opt={name:node.name,fullName:node.fullName};var txtView=node.$_rule?node.$_rule.getTextViewOfVars(opt):[];if(0===Number(node.type)||1===Number(node.type)){var pNode=function(node){if("root"===node.type)return node;return parserTreeMgr.getNodeById(node.parentId)}(node);"root"!==pNode.type&&1!==Number(pNode.type)&&3!==Number(pNode.type)&&pNode.$_rule&&(txtView=txtView.concat(pNode.$_rule.getTextViewOfVars(opt)))}if(0===Number(node.type)||1===Number(node.type))for(var i=0;i<txtView.length;i++)txtView[i].fullName!==node.fullName||"mark"!==txtView[i].type&&"tmark"!==txtView[i].type||(txtView[i].isSel=!0);return txtView};function selectNode(node,local){if(local)parserTreeMgr.select(node);else{node.lazyLoad=!1;if("parser"!==node.type||node.inited)if("category"!==node.type&&"parser"!==node.type||"parser"===node.type&&node.inited){setOkButtonState(node);var arg={selectFullName:node.fullName,selectRule:node.$_rule,sample:$scope.currentSample,bFirst:!0};parserTreeMgr.select(node);$scope.parserOps.parserId=node.parserId;$scope.parserOps.activeIndex=node.sampleIndex;$scope.parserOps.selectVarFullName=node.fullName;if("category"!==node.type&&"parser"!==node.type){$scope.$broadcast("changeSampleTab",node.sampleIndex);$scope.$broadcast(nbParserLibEventModel.PARSERBROADCAST_EVENT,{op:"showVariable",arg:arg})}}else if("category"===node.type){setOkButtonState(node);nbDataViewTemplateTreeViewModel.Traverse(node,(function(nodeA){setNodeClass(nodeA)}))}else $scope.disableOk=!0;else{$scope.disableOk=!0;parserEditSrvc.getParserByPath(node.parserPath).then((function(data){node.inited=!0;var parser=new nbPLM.Parser;parser.load(data);$scope.currentSample=parser.sampleSet.samples[0];var parserId=node.id;var parserPath=node.parserPath;var treeMgr=new nbPLM.TreeManager(parser.sampleSet.mergeSimpleVars());NgUtil.getGUID(),node.id,treeMgr.tree.length;if(treeMgr.tree&&treeMgr.tree.length>0)for(var i=0;i<treeMgr.tree.length;i++)addToCurrentTree(treeMgr.tree[i],node,parserId,parserPath);$scope.disableOk=!1;nbDataViewTemplateTreeViewModel.Traverse(node,(function(node2){setAttribute(node2);setNodeClass(node2)}));var firstChild=_.find(node.child,(function(child){return!!child.$isDisplay}));if(firstChild){$scope.selectedVariable=firstChild;$scope.parserOps.parserId=firstChild.id;parserTreeMgr.select(firstChild);$timeout((function(){firstChild.$expended=!0;parserTreeMgr.expend(firstChild)}));!function(node){setOkButtonState(node);$scope.parserOps.parserId=node.parserId;$scope.parserOps.activeIndex=node.sampleIndex;$scope.parserOps.selectVarFullName=node.fullName;var textShow=getTextViewByNode(node);var arg={selectFullName:node.fullName,selectRule:node.$_rule,sample:$scope.currentSample,textShow:nbPLM.OpBaseRule.filterMarks(textShow),bFirst:!0};"parser"===node.type?$scope.$broadcast(nbParserLibEventModel.PARSERBROADCAST_EVENT,{op:"refreshSampleTab",arg:arg}):$scope.$broadcast(nbParserLibEventModel.PARSERBROADCAST_EVENT,{op:"showVariable",arg:arg})}(firstChild);setOkButtonState(firstChild)}else{parserTreeMgr.select(node);$scope.parserOps.parserId=node.id;setOkButtonState(node)}}),(function(reason){console.error(reason)}))}}}function setNodeClass(node){if(!node.classSetted){"parser"===node.type?node.cls="parser-icon-12":"$_original_result"===node.fullName?node.cls="icon_nb_parser_variable":0===Number(node.type)||1===Number(node.type)||2===Number(node.type)?node.cls="string_icon":3!==Number(node.type)&&4!==Number(node.type)||(node.cls="table_variable_icon");node.classSetted=!0}}function getVariableType(){return selectedParsers?selectedParsers.variableType:null}function removeDollar(nodeName){return nodeName&&nodeName.indexOf("$")>=0?nodeName.substr(1):nodeName}function isInterface(){return"interface"===getVariableType()||"interfaceNote"===getVariableType()}var hideNode=function(node){node.$display=!1;node.$_parent.childCount--};var setAsKey=function(node){$scope.disableOk=!1;var parentId=node.$_parent.name;var interfaceKey=node.name;isInterface()&&editDataViewTemplateSrvc.setTableKeyByNameAndIntfType($scope.branch,selectedParsers?selectedParsers.interfaceType:null,parentId,interfaceKey,node.parserPath)};function setAttribute(node){if(node){var parentNode=node.$_parent;node.name=removeDollar(node.name);"device"===getVariableType()&&parentNode&&(3===Number(parentNode.type)||Number(parentNode.type));if("deviceNote"===getVariableType()){!node||3!==Number(node.type)&&4!==Number(node.type)||hideNode(node);!parentNode||3!==Number(parentNode.type)&&4!==Number(parentNode.type)||hideNode(node)}if(isInterface()){parentNode&&"$_original_result"===parentNode.fullName&&(3===Number(node.type)||4===Number(node.type)?node.intfKey||hideNode(node):parentNode&&"$_original_result"===parentNode.fullName&&hideNode(node));!0===node.intfKey&&setAsKey(node)}if("intfCondition"===getVariableType()){parentNode&&"$_original_result"===parentNode.fullName?3===Number(node.type)||4===Number(node.type)?node.intfKey||hideNode(node):parentNode&&"$_original_result"===parentNode.fullName&&hideNode(node):!parentNode||3!==Number(parentNode.type)&&4!==Number(parentNode.type)||"string"!==node.varType&&"bool"!==node.varType&&"configlet"!==node.varType&&hideNode(node);!0===node.intfKey&&setAsKey(node)}"deviceCondition"===getVariableType()&&(parentNode&&"$_original_result"===parentNode.fullName?"string"!==node.varType&&"bool"!==node.varType&&"configlet"!==node.varType&&hideNode(node):"$_original_result"!==node.fullName&&hideNode(node))}}function addToCurrentTree(tree,node,parserId,parserPath){var childCount=tree.child?tree.child.length:0;var newNode={accessType:1,id:NgUtil.getGUID(),name:tree.data.name,parentId:node.id,type:tree.data.type,capName:tree.data.capName,childCount:childCount,fullName:tree.data.fullName,fullName2:tree.data.fullName2,oriName:tree.data.oriName,sampleIndex:tree.data.sampleIndex,varType:tree.data.varType,$_rule:tree.data.$_rule,$child:[],parserId:parserId,inited:!0,parserPath:parserPath,intfKey:tree.data.intfKey,noSort:!0};var currentNode=node;setNodeClass(newNode);if("$_original_result"===tree.data.fullName){node.capName=newNode.capName;node.fullName=newNode.fullName;node.oriName=newNode.oriName;node.sampleIndex=newNode.sampleIndex;node.varType=newNode.varType;node.$_rule=newNode.$_rule;node.parserId=newNode.parserId;node.intfKey=newNode.intfKey}else currentNode=parserTreeMgr.addNode(newNode);if(tree.child&&tree.child.length>0)for(var j=0;j<tree.child.length;j++){currentNode.inited=!0;addToCurrentTree(tree.child[j],currentNode,parserId,parserPath)}}parserTreeMgr=new nbDataViewTemplateTreeViewModel({enableCalcNodeNumber:!1,enableSearch:!1,lazyLoadingChildUrl:"ParserLib/Category/getchildnodes/",requestService:httpDataViewTemplateSrvc.getParserTreeChildNodes,enableLazyLoading:!0,isFolder:function(node){return"category"===node.type||"parser"===node.type||"variable"===node.type},onSort:function(node1,node2){if(node1.noSort&&node2.noSort){var rootNodes={"built-in files":0,"shared files in company":1,"shared files in tenant":2,"my files":3,"built-in parsers":0,"shared parsers in company":1,"shared parsers in tenant":2,"my parsers":3};return rootNodes[node1.name.toLowerCase()]-rootNodes[node2.name.toLowerCase()]}return!1},onSelectNode:function(node){selectNode(node)}},$scope.ivhTreeOptions);var generateBrowseTree=function(keyword){var varType=getVariableType();nbParserTreeSrvc.getFullParserFullTreeForDvt(varType,keyword).then((function(arg){if(arg&&_.isArray(arg)&&0!==arg.length){$scope.browseTree=parserTreeMgr.init(arg);$timeout((function(){var defaultSelectNode=null;nbDataViewTemplateTreeViewModel.Traverse($scope.browseTree[0],(function(node){setAttribute(node);node.defaultSelect&&(defaultSelectNode=node);setNodeClass(node)}));$timeout((function(){if(defaultSelectNode){defaultSelectNode.defaultExpand=!0;!function setParentDefaultExpand(node){node.$_parent&&setParentDefaultExpand(node.$_parent);node.defaultExpand=!0}(defaultSelectNode);parserTreeMgr.expend(defaultSelectNode.id);$timeout((function(){selectNode(defaultSelectNode,!1);$timeout((function(){$scope.defaultSelectTreeNode=parserTreeMgr.getNodeById(defaultSelectNode.id);var ele=document.getElementById("parsertree"+defaultSelectNode.id);var token=$scope.$watch("defaultSelectTreeNode.$expended",(function(newValue){newValue&&ele&&$timeout((function(){ele.scrollIntoView();token()}),500)}))}))}))}}))}),1)}else parserTreeMgr.clear()}),(function(msg){nbAlertSrvc.notification(msg.ResultDesc)}))};$scope.searchParser=function(){var keyword=$scope.searchKey;if(keyword&&""!==keyword.trim()){$scope.searchedKey=keyword;generateBrowseTree(encodeURIComponent(keyword))}else generateBrowseTree()};$scope.searchKeyKeyUp=function(event){13===event.keyCode&&$scope.searchParser()};$scope.clearSearchKey=function(){$scope.searchKey="";if($scope.searchedKey&&""!==$scope.searchedKey.trim()){$scope.searchedKey="";generateBrowseTree()}};$scope.setChildrenSelect=function(node,isSelected){if(node.child&&node.child.length>0)for(var i=0;i<node.child.length;i++){var child=node.child[i];child.selected=isSelected;$scope.setChildrenSelect(child,isSelected)}};var bInited=!1;$scope.$on("QappNavClickTab",(function(event,msg){if("parser"===msg&&!bInited){generateBrowseTree();bInited=!0}}));var changeDomainEvent=$rootScope.$on(systemEvent.changedDomain,(function(){generateBrowseTree()}));$scope.$on("$destroy",(function(){changeDomainEvent&&changeDomainEvent()}));$scope.onOK=function(){if($scope.selectedVariable){var parser=function getParser(selectedModel){if(selectedModel&&"parser"===selectedModel.type)return selectedModel;if(selectedModel.$_parent)return getParser(selectedModel.$_parent);return null}($scope.selectedVariable);"$_original_result"===$scope.selectedVariable.fullName?$scope.selectedVariable.name=parser.name:function(variable){variable.fullName2&&""!==variable.fullName2.trim()&&(variable.fullName=variable.fullName2);if(0===Number(variable.type)||1===Number(variable.type)||2===Number(variable.type)){variable.fullName.indexOf(originalResultNoDollar)>=0&&(variable.fullName=variable.fullName.substr(originalResultNoDollar.length+1));removeDollar(variable.fullName)===removeDollar(variable.name)&&(variable.fullName=singleValueVar+"."+variable.fullName)}if("parser"===variable.type){variable.fullName="$_original_result";return}3!==Number(variable.type)&&4!==Number(variable.type)||variable.fullName.indexOf(originalResultNoDollar)>=0&&(variable.fullName=variable.fullName.substr(originalResultNoDollar.length+1));variable.fullName=variable.capName.replace(/\$/g,"")}($scope.selectedVariable);$scope.selectedVariable.isInterface=!(!$scope.selectedVariable.$_parent.intfKey&&!_.some($scope.selectedVariable.$_parent.$child,(function(variable){return 3!==Number(variable.type)&&4!==Number(variable.type)&&variable.intfKey})));var returnObj={selectedVariable:$scope.selectedVariable};(function(variable){var defered=$q.defer();if(!(3!==Number(variable.type)&&4!==Number(variable.type)||variable.child&&0!==variable.child.length)){parserEditSrvc.getParserByPath(variable.parserPath).then((function(data){var parser=new nbPLM.Parser;parser.load(data);var treeMgr=new nbPLM.TreeManager(parser.sampleSet.mergeSimpleVars());variable.child=function getChildsByVariable(tree,variable){var name=tree.data.fullName;0===name.indexOf(originalResultNoDollar)&&(name=name.replace(originalResultNoDollar+".",""));if(name===variable.fullName){var result=[];for(var i=0;i<tree.child.length;i++){var newNode={accessType:1,name:tree.child[i].data.name,type:tree.child[i].data.type,capName:tree.child[i].data.capName,fullName:tree.child[i].data.fullName,fullName2:tree.child[i].data.fullName2,oriName:tree.child[i].data.oriName,sampleIndex:tree.child[i].data.sampleIndex,varType:tree.child[i].data.varType,$_rule:tree.child[i].data.$_rule,$child:[],parserId:variable.parserId,inited:!0,parserPath:variable.parserPath,intfKey:tree.child[i].data.intfKey,noSort:!0};result.push(newNode)}return result}if(tree.child&&tree.child.length>0)for(var j=0;j<tree.child.length;j++){var result2=getChildsByVariable(tree.child[j],variable);if(result2)return result2}return}(treeMgr.tree[0],variable);defered.resolve()}));return defered.promise}return $q.resolve()})($scope.selectedVariable).then((function(){$uibModalInstance.close(returnObj)}))}};$scope.onCancel=function(){editDataViewTemplateSrvc.recoverTableKeyAndName();$uibModalInstance.close({selectedVariable:null})};$scope.isOkBtnDisabled=function(){return!(!$scope.disableOk||"select"===getVariableType())||(!$scope.selectedVariable&&"select"!==getVariableType()||!(!canOnlySelectSimpleDataType||!$scope.selectedVariable||(varType=$scope.selectedVariable.varType,"string"===varType||"bool"===varType||"int"===varType||"double"===varType||"filter"===varType||"configlet"===varType||"float"===varType)&&!function(parserVar){if(!parserVar||!parserVar.name||!parserVar.oriName)return!1;var lowerVarName=parserVar.name.toLowerCase();return lowerVarName.indexOf("original")>=0&&lowerVarName.indexOf("result")>=0&&"$_original_result"===parserVar.oriName}($scope.selectedVariable)));var varType};generateBrowseTree()}}();angular.module("nb.dataview").directive("nbSpogInterfacePropertyTreeDirective",["$q","$log","$filter","nb.systemmodel.deviceSchemaMgrSrvc","ivhTreeviewMgr","nb.dataviewtemplate.httpDataViewTemplateSrvc",function($q,$log,$filter,deviceSchemaMgrSrvc,ivhTreeviewMgr,httpDataViewTemplateSrvc){return{replace:!0,restrict:"E",scope:{intfType:"=",targetValueTypes:"=?",isMultiSelect:"=?",isOnlyLeafSelectable:"=?",isDisplayInDataview:"=?",selectedNodes:"=",filterText:"=?",preSelectedIntfSchemaIds:"="},templateUrl:"modules/nbCommon/views/nbInterfacePropertyTreeDirective.html",link:function(scope){"all"===scope.intfType?function(){var deferred=$q.defer();httpDataViewTemplateSrvc.getDiplayIntfTypeList().then((function(data){deferred.resolve(data.displayIntfTypeList)}),(function(reason){deferred.reject(reason)}));return deferred.promise}().then((function(intfs){!function(intfTypes){scope.treeOptions={enableTwoWayBinding:!0,labelAttribute:"displayName",idAttribute:"ID",childrenAttribute:"child",expandToDepth:-1,selectedAttribute:"selected",enableMultipleSelect:!!scope.isMultiSelect&&scope.isMultiSelect,labelTemplate:function(node){return"<span>"+$filter("nbHighlight")(node.displayName,scope.filterText)+"</span>"},nodeClickCallback:onSelectNode};scope.treeData=[];for(var i=0;i<intfTypes.length;i++){var intfSchemaObj=deviceSchemaMgrSrvc.getSchemaObjByKey(intfTypes[i].intfType);var lsSchemaObjs=getIntfSchemasByType(intfTypes[i].intfType);var firstTree={ID:intfSchemaObj.getID(),displayName:intfSchemaObj.getDisplayName(),selected:!1,isSchema:!0,isParent:!0,child:[]};firstTree.child=getNodeValueForTree(lsSchemaObjs);firstTree.child&&firstTree.child.length>0&&(isAdded(scope.treeData,firstTree)||scope.treeData.push(firstTree));if(intfSchemaObj.isPhantomInterface()){var associateSchemaId=intfSchemaObj.getAssociatedSchema();if(!associateSchemaId){$log.error("Internal Error -- nbInterfacePropertyTreeDirective");return}var associateIntfType=DeviceTableProcessor.getFirstPartBeforeDot(associateSchemaId);var associateIntfSchemaObjs=getIntfSchemasByType(associateIntfType);var associateSchemaObj=deviceSchemaMgrSrvc.getSchemaObjByKey(associateIntfType);var secondTree={ID:associateSchemaObj.getID(),displayName:associateSchemaObj.getDisplayName(),selected:!1,isSchema:!0,isParent:!0,child:[]};secondTree.child=getNodeValueForTree(associateIntfSchemaObjs);isAdded(scope.treeData,secondTree)||scope.treeData.push(secondTree)}}scope.treeData_backup=angular.copy(scope.treeData);scope.isDataReady=!0}(intfs)}),(function(reason){console.warn(reason)})):function(){scope.treeOptions={enableTwoWayBinding:!0,labelAttribute:"displayName",idAttribute:"ID",childrenAttribute:"child",expandToDepth:-1,selectedAttribute:"selected",enableMultipleSelect:!!scope.isMultiSelect&&scope.isMultiSelect,labelTemplate:function(node){return"<span>"+$filter("nbHighlight")(node.displayName,scope.filterText)+"</span>"},nodeClickCallback:onSelectNode};scope.treeData=[];var intfSchemaObj=deviceSchemaMgrSrvc.getSchemaObjByKey(scope.intfType);var lsSchemaObjs=getIntfSchemasByType(scope.intfType);var firstTree={ID:intfSchemaObj.getID(),displayName:intfSchemaObj.getDisplayName(),selected:!1,isSchema:!0,isParent:!0,child:[]};firstTree.child=getNodeValueForTree(lsSchemaObjs);firstTree.child&&firstTree.child.length>0&&scope.treeData.push(firstTree);if(intfSchemaObj.isPhantomInterface()){var associateSchemaId=intfSchemaObj.getAssociatedSchema();if(!associateSchemaId){$log.error("Internal Error -- nbInterfacePropertyTreeDirective");return}var associateIntfType=DeviceTableProcessor.getFirstPartBeforeDot(associateSchemaId);var associateIntfSchemaObjs=getIntfSchemasByType(associateIntfType);var associateSchemaObj=deviceSchemaMgrSrvc.getSchemaObjByKey(associateIntfType);var secondTree={ID:associateSchemaObj.getID(),displayName:associateSchemaObj.getDisplayName(),selected:!1,isSchema:!0,isParent:!0,child:[]};secondTree.child=getNodeValueForTree(associateIntfSchemaObjs);scope.treeData.push(secondTree)}scope.treeData_backup=angular.copy(scope.treeData);scope.isDataReady=!0}();function isAdded(treeData,treeNode){return _.some(treeData,(function(m){return m.displayName===treeNode.displayName}))}function getIntfSchemasByType(strIntfType){return deviceSchemaMgrSrvc.getDisplayedIntfSchemasByIntfTypeAndValueType(strIntfType,scope.targetValueTypes,scope.isDisplayInDataview)}function getNodeValueForTree(lsSchemaObjs){lsSchemaObjs.sort((function(s1,s2){return s1.getDisplayName().localeCompare(s2.getDisplayName())}));return lsSchemaObjs.map((function(schemaObj){return{ID:schemaObj.getID(),displayName:schemaObj.getDisplayName(),type:schemaObj.getType(),isSchema:!0,selected:scope.preSelectedIntfSchemaIds&&scope.preSelectedIntfSchemaIds.indexOf(schemaObj.getID())>-1}}))}function onSelectNode(node){if(scope.isMultiSelect)!function(bExcludeFolder,refLsSelectedNodes){for(;refLsSelectedNodes.length>0;)refLsSelectedNodes.pop();for(var i in scope.treeData)if({}.hasOwnProperty.call(scope.treeData,i)){var subTree=scope.treeData[i];!bExcludeFolder&&subTree.selected&&refLsSelectedNodes.push({ID:subTree.ID,displayName:subTree.displayName});var lsChildNodes=subTree.child;for(var j in lsChildNodes)if({}.hasOwnProperty.call(lsChildNodes,j)){var childNode=lsChildNodes[j];childNode.selected&&refLsSelectedNodes.push(childNode)}}}(scope.isOnlyLeafSelectable,scope.selectedNodes);else{for(;scope.selectedNodes.length>0;)scope.selectedNodes.pop();if(scope.isOnlyLeafSelectable&&node.isParent)return;scope.selectedNodes.push(node)}}scope.$watch("filterText",(function(){scope.refreshData()}),!0);scope.refreshData=function(){if(scope.treeData_backup){scope.filterText&&0!==scope.filterText.length?scope.treeData=function(query){var newTreeData=angular.copy(scope.treeData_backup);for(var i=0;i<newTreeData.length;i++){var children=newTreeData[i].child;if(children&&0!==children.length){for(var j=0;j<children.length;j++)children[j].displayName.toLowerCase().indexOf(query.toLowerCase())<0&&children.splice(j--,1);0===children.length&&newTreeData.splice(i--,1)}}return newTreeData}(scope.filterText):scope.treeData=angular.copy(scope.treeData_backup);ivhTreeviewMgr.validate(scope.treeData,scope.treeOptions)}}}}}]);function _typeof2(obj){return(_typeof2="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}angular.module("nb.dataview").directive("spogPageLinkUrlDirective",["$q","$log","$document","$rootScope","$uibModal","$timeout","nb.qmap.mapManagerSrvc","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.qmap.httpMapSrvc","nb.admin.httpSystemAdminSrvc","nb.collaboration.collaborationGridSrvc","nb.admin.domainAdminMgr","nb.dataview.defineSpogSrvc","nb.dataviewtemplate.editDataViewTemplateSrvc",function($q,$log,$document,$rootScope,$uibModal,$timeout,mapManagerSrvc,userSrvc,nbAlertSrvc,httpMapSrvc,httpSystemAdminSrvc,collaborationGridSrvc,domainAdminMgr,defineSpogSrvc,editDataViewTemplateSrvc){return{restrict:"E",scope:{pageLinkViewModel:"="},templateUrl:"modules/nbDataView/spog/views/spogPageLinkUrlDirective.html",link:function(scope,element,attrs){scope.richcontent="";scope.quillObj={mentionCharPos:-1,currentCursorPos:0};scope.mentionPos=-1;scope.editor=null;scope.insertData=function(index,title,path,data){!function(data){var quill=scope.editor;var range=quill.selection.savedRange;if(range&&0==range.length){var position=range.index;scope.editorTouched||(position=quill.getLength()-1);quill.insertEmbed(position,"mention",data,Quill.sources.API);quill.setSelection(position+1,Quill.sources.USER);scope.quillObj.currentCursorPos=position+1}}({name:title,dataunitdata:data,path:path})};function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(obj){return _typeof2(obj)}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof2(obj)})(obj)}function _classCallCheck(instance,Constructor){if(!(left=instance,right=Constructor,null!=right&&"undefined"!=typeof Symbol&&right[Symbol.hasInstance]?right[Symbol.hasInstance](left):left instanceof right))throw new TypeError("Cannot call a class as a function");var left,right}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;"value"in descriptor&&(descriptor.writable=!0);Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){protoProps&&_defineProperties(Constructor.prototype,protoProps);staticProps&&_defineProperties(Constructor,staticProps);return Constructor}function _possibleConstructorReturn(self,call){return!call||"object"!==_typeof(call)&&"function"!=typeof call?function(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self):call}function _get(target,property,receiver){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=function(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=_getPrototypeOf(object)););return object}(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(receiver):desc.value}})(target,property,receiver||target)}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function(o,p){o.__proto__=p;return o})(o,p)}Mention=function(){function Mention(quill,options){_classCallCheck(this,Mention);this.isOpen=!1;this.itemIndex=0;this.mentionCharPos=null;this.cursorPos=null;this.values=[];this.quill=quill;this.options={source:null,renderItem:function(item,searchTerm){return"".concat(item.value)},mentionDenotationChars:["@"],allowedChars:/^[a-zA-Z0-9_]*$/,minChars:0,maxChars:31,offsetTop:2,offsetLeft:0};Object.assign(this.options,options)}_createClass(Mention,[{key:"hasValidChars",value:function(s){return!0}},{key:"onSomethingChange",value:function(){var range=this.quill.getSelection();if(null!=range){this.cursorPos=range.index;this.options.parentScope.quillObj.currentCursorPos=this.cursorPos;var startPos=Math.max(0,this.cursorPos-this.options.maxChars);var beforeCursorPos=this.quill.getText(startPos,this.cursorPos-startPos);var mentionCharIndex=-1;if(!_.isEmpty(beforeCursorPos.trim())){var index=_.findLastIndex(beforeCursorPos,(function(a){return/\s/.test(a)}));mentionCharIndex=index>=0?index+1:0}this.options.parentScope.quillObj.mentionCharPos=-1;if(mentionCharIndex>-1){var mentionCharPos=this.cursorPos-(beforeCursorPos.length-mentionCharIndex);this.mentionCharPos=mentionCharPos;this.options.parentScope.quillObj.mentionCharPos=this.mentionCharPos;var textAfter=beforeCursorPos.substring(mentionCharIndex);textAfter.length>=this.options.minChars&&this.hasValidChars(textAfter)&&beforeCursorPos[mentionCharIndex]}}}},{key:"onTextChange",value:function(delta,oldDelta,source){"user"===source&&this.onSomethingChange()}},{key:"onSelectionChange",value:function(range){range&&0===range.length&&this.onSomethingChange()}}]);return Mention}(),Quill.register("modules/mention",Mention);var Mention;!function(){var MentionBlot=function(_Base){!function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}});superClass&&_setPrototypeOf(subClass,superClass)}(MentionBlot,_Base);function MentionBlot(){_classCallCheck(this,MentionBlot);return _possibleConstructorReturn(this,_getPrototypeOf(MentionBlot).apply(this,arguments))}_createClass(MentionBlot,null,[{key:"create",value:function(data){var node=_get(_getPrototypeOf(MentionBlot),"create",this).call(this,data.name);node.setAttribute("data-dataUnitData","object"===_typeof(data.dataunitdata)?JSON.stringify(data.dataunitdata):data.dataunitdata);node.setAttribute("data-name",data.name);node.setAttribute("data-path",data.path);node.setAttribute("title",data.path);var denotationChar=document.createElement("span");denotationChar.className="spog-data-unit-variable";denotationChar.innerHTML+=data.name;denotationChar.setAttribute("contenteditable",!1);node.appendChild(denotationChar);return node}},{key:"setDataValues",value:function(element,data){var domNode=element;Object.keys(data).forEach((function(key){domNode.dataset[key]=data[key]}));return domNode}},{key:"value",value:function(domNode){return{name:domNode.dataset.name,dataunitdata:domNode.dataset.dataunitdata,path:domNode.dataset.path}}}]);return MentionBlot}(Quill.import("blots/embed"));MentionBlot.blotName="mention";MentionBlot.className="quill-mention";MentionBlot.tagName="span";Quill.register({"formats/mention":MentionBlot})}();$timeout((function(){var editorDom=element[0].getElementsByClassName("editor")[0];scope.editor=new Quill(editorDom,{theme:"snow",placeholder:"",formats:["mention"],modules:{toolbar:!1,mention:{allowedChars:/^[a-zA-Z0-9_]*$/,mentionDenotationChars:["@"],parentScope:scope},keyboard:{bindings:{custom1:{key:13,handler:function(){return!1}},custom2:{key:13,shiftKey:!0,handler:function(){return!1}}}}}});scope.editor.clipboard.addMatcher("*",(function(node,delta){return{ops:[{insert:node.innerText}]}}));scope.editor.on("text-change",(function(delta,oldDelta,source){scope.pageLinkViewModel.richTextUrl=scope.editor.getContents();scope.pageLinkViewModel.url=function(ops){if(ops&&_.isArray(ops)){var text="";for(var i=0;i<ops.length;i++)void 0!==ops[i].insert&&(ops[i].insert.mention?text+=ops[i].insert.mention.name||"":text+=ops[i].insert);return text}return""}(scope.pageLinkViewModel.richTextUrl.ops)}));scope.editor.once("selection-change",(function(range,oldRange,source){scope.editorTouched=!0}));if(scope.pageLinkViewModel.richTextUrl){scope.pageLinkViewModel.richTextUrl=JSON.parse(scope.pageLinkViewModel.richTextUrl);scope.editor.setContents(scope.pageLinkViewModel.richTextUrl)}}))},controller:function($scope){$scope.menuList=[{title:"Insert Built-in Variable",action:function(){$scope.selectBuiltInVariable()}},{title:"Insert Parser Variable",action:function(){$scope.selectParseVariable()}},{title:"Insert Generic Variable",action:function(){$scope.selectGenericVariableDialog()}},{title:"Insert Customized Variable",action:function(){$scope.insertCustomizedVariable()}}];$scope.insertCustomizedVariable=function(){defineSpogSrvc.insertCustomizedVariable({}).then((function(variable){if(variable){var title="{@"+variable.name+"}";$scope.insertData($scope.quillObj.currentCursorPos,title,"Customized Variable",variable)}}))};$scope.selectGenericVariableDialog=function(){defineSpogSrvc.selectGenericVariableDialog({openFrom:"select genericVar"}).then((function(data){if(data&&data.length>0){var variable=data[0];variable.type="uSrcGenericVariable";var title="{$$"+variable.name+"}";$scope.insertData($scope.quillObj.currentCursorPos,title,"Generic Variable",variable)}}))};$scope.selectBuiltInVariable=function(){defineSpogSrvc.selectBuiltInVariable({isGetAllSchema:!0,canOnlySelectSimpleDataType:!0,allDeviceGenericSchemaDisplayNames:editDataViewTemplateSrvc.getAllDeviceGenericSchemaDisplayNames()}).then((function(builtInData){var position=new CDVTmplPositionData;!function(property,position){property.isSchema&&position.setPosition(DataUnitSourceType.uSrcGDR,property.ID,property.displayName,position.posName,null,null,null,property.type,null,null,property.isRefLink)}(builtInData,position);var title="{$"+builtInData.displayName+"}";var path=function(builtInData){var pathArray=["Built-in Variable/Device properties","Built-in Variable/Interface properties"];return builtInData&&builtInData.ID?builtInData.ID.split(".").length>1?pathArray[1]:pathArray[0]:""}(builtInData);var unit=position.getPosInfo().getDataUnit();unit.isInterfaceVariable=builtInData.isInterface;$scope.insertData($scope.quillObj.currentCursorPos,title,path,unit)}),(function(reason){console.log(reason)}))};$scope.selectParseVariable=function(){defineSpogSrvc.selectParseVariable({selectedParsers:function(){return{variableType:"all",previousParserId:null}},canOnlySelectSimpleDataType:function(){return!0}}).then((function(returnObj){var variable=function(selectedVariable){if(selectedVariable&&selectedVariable.fullName){selectedVariable.displaySettingTableInfo={displaySettingItem:[],oriPosName:selectedVariable.name+" ("+selectedVariable.varType+")"};selectedVariable.varType=(varType=selectedVariable.varType,3===(type=selectedVariable.type)?"table":4===type?"paragraph":varType);_.each(selectedVariable.child,(function(variable){variable.name=variable.name.replace(/\$/g,"");variable.fullName=variable.fullName.replace(/\$/g,"");var APIVariable={name:variable.name};selectedVariable.displaySettingTableInfo.displaySettingItem.push({APIVariable:APIVariable,alias:variable.name,isSelected:!0})}));var displaySettingString={prefix:selectedVariable.name,unit:selectedVariable.unit};var position=new CDVTmplPositionData;position.setPosition(DataUnitSourceType.uSrcParserLibrary,selectedVariable.fullName,selectedVariable.name,position.posName,selectedVariable.parserPath,selectedVariable.thirdApiInfo,selectedVariable.intfInfo,selectedVariable.varType,selectedVariable.displaySettingTableInfo,displaySettingString);var dataunit=position.getPosInfo().getDataUnit();dataunit.isInterfaceVariable=selectedVariable.isInterface;return dataunit}var varType,type;return null}(returnObj.selectedVariable);if(variable){var title="{$"+variable.displayName+"}";var path=variable.parserPath;$scope.insertData($scope.quillObj.currentCursorPos,title,path,variable)}}),(function(reason){console.log(reason)}))}}}}]);!function(){angular.module("nb.dataview").controller("nb.dataview.selectGenericVariableDialog",selectGenericVariableDialog);selectGenericVariableDialog.$inject=["$scope","$uibModalInstance","$uibModal","$timeout","$filter","nb.ng.httpAuthSrvc","nb.ng.userSrvc","nb.ng.nbValidationSrvc","nb.dataview.defineSpogSrvc","nb.dataviewtemplate.editDataViewTemplateSrvc","params"];function selectGenericVariableDialog($scope,$uibModalInstance,$uibModal,$timeout,$filter,httpAuthSrvc,userSrvc,nbValidationSrvc,defineSpogSrvc,editDataViewTemplateSrvc,params){$scope.viewModel=params;$scope.openFrom=$scope.viewModel.openFrom;$scope.selectedGenericVariable=[];$scope.viewModel.pageNameValid={method:"blur",rules:[{ruleId:"required",errorMessage:"Please specify a Page Name."},{ruleId:"duplicationChecker",params:{lsExistingNames:[]},errorMessage:"The {name} already exists in the system."}]};$scope.onCancel=function(){$uibModalInstance.dismiss()};$scope.onOK=function(){$uibModalInstance.close($scope.selectedGenericVariable)}}}(NetBrain);function _defineProperty(obj,key,value){key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value;return obj}!function(){angular.module("nb.dataview").controller("nb.dataview.selectSpogLinkDialogCtrl",selectSpogLinkDialogCtrl);selectSpogLinkDialogCtrl.$inject=["$scope","$uibModalInstance","$uibModal","$filter","resolveData","nb.dataview.httpDefineSpogSrvc","nb.common.nbAlertSrvc"];function selectSpogLinkDialogCtrl($scope,$uibModalInstance,$uibModal,$filter,resolveData,httpDefineSpogSrvc,nbAlertSrvc){var _$scope$gridOptions;$scope.vendorsData={};$scope.pageLinkData=[];$scope.selectBtnDisabled=!0;$scope.filterOptions={filterText:""};$scope.onCancel=function(){$uibModalInstance.dismiss("cancel")};$scope.onOK=function(row){var selected=$scope.gridApi.selection.getSelectedRows();row&&(selected=[row.entity]);if(selected.length>0){selected=selected[0];resolveData.actions.some((function(eleAction){return eleAction.define.id==selected.id}))?nbAlertSrvc.alert("The selected action already exists. Please select another one."):$uibModalInstance.close(selected)}};$scope.doSearch=function(){if($scope.gridApi&&$scope.gridApi.grid){$scope.filterOptions.filterText=$scope.gridApi.grid.gridSearchStr;var tempData=angular.copy($scope.pageLinkData);$scope.gridOptions.data=$filter("selectedColumnsFilter")(tempData,["name","description"],$scope.filterOptions.filterText)}};$scope.gridCellTemplateWithFilter='<div class="ui-grid-cell-contents" ng-bind-html="COL_FIELD | nbHighlight: grid.gridSearchStr" title="{{COL_FIELD}}"></div>';$scope.gridOptions=(_defineProperty(_$scope$gridOptions={data:[],multiSelect:!0,modifierKeysToMultiSelect:!0,headerSearchIcon:'<i class="icon_nb_search"></i>',enableHeaderSearchBar:function(grid){$scope.doSearch(grid)}},"multiSelect",!1),_defineProperty(_$scope$gridOptions,"headerSearchPlaceHolder","Search..."),_defineProperty(_$scope$gridOptions,"headerSearchCloseIcon",'<i class="icon_nb_close" style="margin-right:5px;"></i>'),_defineProperty(_$scope$gridOptions,"rowTemplate",'<div ng-dblclick="grid.appScope.onOK(row)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ui-grid-cell>'),_defineProperty(_$scope$gridOptions,"stopSearch",(function(grid){$scope.gridApi.grid.gridSearchStr="";$scope.filterOptions.filterText=$scope.gridApi.grid.gridSearchStr;$scope.doSearch(grid)})),_defineProperty(_$scope$gridOptions,"enableRowHeaderSelection",!1),_defineProperty(_$scope$gridOptions,"enableHeaderBar",!0),_defineProperty(_$scope$gridOptions,"columnDefs",[{field:"vendorName",displayName:"Vendor",grouping:{groupPriority:0},sort:{priority:0,direction:"desc"},cellTemplate:'<div><div ng-if="!col.grouping || col.grouping.groupPriority === undefined || col.grouping.groupPriority === null || ( row.groupHeader && col.grouping.groupPriority === row.treeLevel )" class="ui-grid-cell-contents" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterText.text" title="{{COL_FIELD}}">{{COL_FIELD}}</div></div>'},{field:"name",displayName:"Page Name",cellTemplate:$scope.gridCellTemplateWithFilter},{field:"url",displayName:"Page URL",cellTemplate:$scope.gridCellTemplateWithFilter},{field:"qualifyText",displayName:"Condition",cellTemplate:$scope.gridCellTemplateWithFilter},{field:"description",displayName:"Description",enableSorting:!1,cellTemplate:$scope.gridCellTemplateWithFilter}]),_defineProperty(_$scope$gridOptions,"onRegisterApi",(function(gridApi){httpDefineSpogSrvc.getVendors().then((function(data){if(data&&data.length>0){$scope.vendorsData={};data.forEach((function(item){$scope.vendorsData[item.id]=item.name}));httpDefineSpogSrvc.getPageLInk({targetDataUnitVar:resolveData.targetDataUnitVar}).then((function(data){if(data&&data.length>0){data.forEach((function(item){item.path=item.name;$scope.vendorsData[item.vendorId]&&(item.vendorName=$scope.vendorsData[item.vendorId])}));$scope.pageLinkData=data;$scope.gridOptions.data=$scope.pageLinkData}}))}}));$scope.gridApi=gridApi;$scope.gridApi.grid.registerDataChangeCallback((function(data){try{$scope.gridApi.treeBase.expandAllRows()}catch(e){}}));$scope.gridApi.selection.on.rowSelectionChanged($scope,(function(row,event){var selectedModel=$scope.gridApi.selection.getSelectedRows();1===selectedModel.length?$scope.selectBtnDisabled=!1:0===selectedModel.length&&($scope.selectBtnDisabled=!0)}))})),_$scope$gridOptions)}}(NetBrain);!function(){angular.module("nb.dataview").controller("nb.dataview.insertCustomizedVariable",insertCustomizedVariable);insertCustomizedVariable.$inject=["$scope","$uibModalInstance","$uibModal","$timeout","$filter","nb.ng.httpAuthSrvc","nb.ng.userSrvc","nb.ng.nbValidationSrvc","nb.dataview.defineSpogSrvc","nb.dataviewtemplate.editDataViewTemplateSrvc","params"];function insertCustomizedVariable($scope,$uibModalInstance,$uibModal,$timeout,$filter,httpAuthSrvc,userSrvc,nbValidationSrvc,defineSpogSrvc,editDataViewTemplateSrvc,params){$scope.viewModel={insertCostomizedNameValid:{method:"blur",rules:[{ruleId:"required",errorMessage:"Please specify a Customized Variable Name."},{ruleId:"verifiyVariable",params:"",errorMessage:'The variable name must start with a letter or "_", and can only contain letters, numbers and "_".'}]},cusVar:{name:"",value:"",uId:"",type:"uSrcCustomizedVariable",varType:"string"}};$scope.getLimitVal=function(len,d,key){var str="";(str=d[key=key||"name"]).length>len&&(d[key]=str.slice(0,len))};$scope.onCancel=function(){$uibModalInstance.dismiss()};$scope.onOK=function(){$scope.viewModel.url=$scope.viewModel.cusVar.name.replace(/^\s*$/gi,"");if(!$scope.viewModel.cusVar.name)return nbValidationSrvc.submit("insertCostomizedVariablesValid");if(!nbValidationSrvc.getValidator("verifiyVariable")($scope.viewModel.cusVar.name))return nbValidationSrvc.submit("insertCostomizedVariablesValid");$scope.viewModel.cusVar.uId=$scope.viewModel.cusVar.name;$uibModalInstance.close($scope.viewModel.cusVar)}}}(NetBrain);