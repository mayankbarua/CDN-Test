var nbDataModel=angular.module("nb.datamodel",["nb.ng","nb.systemmodel","nb.common","nb.search","ui.grid","dndLists","ui.grid.grouping"]);!function(){angular.module("nb.datamodel").directive("nbDySearchConditionsDirective",DySearchConditions);DySearchConditions.$inject=["$log","$q","$interval","$document","ivhTreeviewMgr","nb.ng.callbackSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.datamodel.httpSiteSrvc","nb.systemmodel.deviceTypeMgrSrvc"];function DySearchConditions($log,$q,$interval,$document,ivhTreeviewMgr,callbackSrvc,httpDeviceGroupSrvc,httpSiteSrvc,deviceTypeMgrSrvc){return{restrict:"E",scope:{candidateSchemaObjs:"=",schemaIdAlias:"@",displayNameAlias:"@",typeAlias:"@",isAllDevicesRange:"@",isDeviceGroupRangeUnavailable:"@",isSiteRangeUnavailable:"@",conditionObj:"=",deviceActionType:"="},templateUrl:"modules/nbDataModel/common/views/nbDySearchConditionsDirective.html",link:function(scope,elem,attrs){scope.selectedDgIds=[];scope.selectedDgNames=[];scope.selectedSiteIds=[];scope.selectedSiteNames=[];scope.obj={isDeviceGroupTreeShown:!1,isSiteTreeShown:!1};$document.click((function(){if(scope.obj){if(scope.obj.isDeviceGroupTreeShown){scope.obj.isDeviceGroupTreeShown=!1;scope.setDeviceGroup()}if(scope.obj.isSiteTreeShown){scope.obj.isSiteTreeShown=!1;scope.setSite()}}}));scope.lsCandidateSchemas=[];scope.candidateSchemaObjs.forEach((function(obj){scope.lsCandidateSchemas.push({schemaId:obj[scope.schemaIdAlias],displayName:obj[scope.displayNameAlias],type:obj[scope.typeAlias]})}));scope.lsDeviceRangesObj=[{name:"All Devices",id:0}];scope.isDeviceGroupRangeUnavailable||scope.lsDeviceRangesObj.push({name:"Device Group",id:1});scope.isSiteRangeUnavailable||scope.lsDeviceRangesObj.push({name:"Site",id:2});scope.getRangeNameById=function(argId){for(var i=0;i<scope.lsDeviceRangesObj.length;i++)if(scope.lsDeviceRangesObj[i].id===argId)return scope.lsDeviceRangesObj[i].name;return""};null===scope.conditionObj&&(scope.conditionObj={});void 0!==scope.conditionObj.RangeOption&&null!==scope.conditionObj.RangeOption||(scope.conditionObj.RangeOption=0);var getSelectedDGs=function getSelectedDGs(tree,refLsSelectedDGIds,refLsSelectedDGNames){if("0"!==tree.ID&&"00"!==tree.ID&&"01"!==tree.ID&&"02"!==tree.ID&&tree.selected){refLsSelectedDGIds.push(tree.ID);refLsSelectedDGNames.push(tree.Name)}if(tree.items&&tree.items.length>0){var length=tree.items.length;for(var i=0;i<length;i++){getSelectedDGs(tree.items[i],refLsSelectedDGIds,refLsSelectedDGNames)}}};var getSelectedSites=function getSelectedSites(tree,refLsSelectedSiteIds,refLsSelectedSiteNames){if(tree.selected){refLsSelectedSiteIds.push(tree.ID);refLsSelectedSiteNames.push(tree.name)}if(tree.children&&tree.children.length>0){var length=tree.children.length;for(var i=0;i<length;i++){getSelectedSites(tree.children[i],refLsSelectedSiteIds,refLsSelectedSiteNames)}}};scope.dgTreeVal={ID:"0",Name:"Device Group",items:[{ID:"01",Name:"Private"},{ID:"00",Name:"Shared"},{ID:"02",Name:"System"}]};scope.dgTreeOptions={idAttribute:"ID",labelAttribute:"Name",childrenAttribute:"items",selectedAttribue:"selected",useCheckboxes:!0,expandToDepth:2,defaultSelectedState:!1,validate:!0};var lsDGsShared=[];var lsDGsPrivate=[];var lsDGsPublic=[];function initTreeVal(pr,sh,sy){var arr=[];pr.length>0&&arr.push({ID:"01",Name:"Private",items:lsDGsPrivate});sh.length>0&&arr.push({ID:"00",Name:"Shared",items:lsDGsShared});sy.length>0&&arr.push({ID:"02",Name:"System",items:lsDGsPublic});return arr}!0!==scope.isAllDevicesRange&&"true"!==scope.isAllDevicesRange&&!0!==scope.isDeviceGroupRangeUnavailable&&"true"!==scope.isDeviceGroupRangeUnavailable&&httpDeviceGroupSrvc.getAllDeviceGroupByTypes([0,1,2],null).then((function(lsAllDgs){lsAllDgs.forEach((function(eachDG){switch(eachDG.Type){case 0:lsDGsShared.push(eachDG);break;case 1:lsDGsPrivate.push(eachDG);break;case 2:lsDGsPublic.push(eachDG);break;default:$log.error("Internal Error: DG Type not Possible!")}}))})).then((function(){scope.dgTreeVal={ID:"0",Name:"Device Group",items:initTreeVal(lsDGsPrivate,lsDGsShared,lsDGsPublic)};if(1===scope.conditionObj.RangeOption&&scope.conditionObj.DeviceGroupRange&&scope.conditionObj.DeviceGroupRange.length>0){scope.conditionObj.DeviceGroupRange.forEach((function(dgId){ivhTreeviewMgr.select(scope.dgTreeVal,dgId,scope.dgTreeOptions,!0)}));getSelectedDGs(scope.dgTreeVal,scope.selectedDgIds,scope.selectedDgNames)}}));scope.siteTreeVal=[];scope.siteTreeOptions={idAttribute:"ID",labelAttribute:"name",childrenAttribute:"children",selectedAttribue:"selected",useCheckboxes:!0,expandToDepth:1,defaultSelectedState:!1,validate:!0};var buildSiteTreeFromSiteList=function buildSiteTreeFromSiteList(root,lsCandidateNodes,lsSelectedSiteIds){if(0!==lsCandidateNodes.length){for(var i=0;i<lsCandidateNodes.length;i++){var currSite=lsCandidateNodes[i];if(currSite.parentId===root.ID){1===currSite.siteCategory&&(currSite.children=[]);root.children.push(currSite);lsCandidateNodes.splice(i,1);i--;if(0===lsCandidateNodes.length)return}}if(root.children)for(var j=0;j<root.children.length;j++)buildSiteTreeFromSiteList(root.children[j],lsCandidateNodes,lsSelectedSiteIds)}};var initDataPartialSiteTreeByLevels=function(){var deferred=$q.defer();httpSiteSrvc.getPartialSiteTreeByLevels(1e4).then((function(lsAllSites){!function(lsAllSites,lsSelectedSiteIds){if(0===lsAllSites.length)return;var rootSiteIndex=0;var rootSite=null;for(var k=0;k<lsAllSites.length;k++)if("My Network"===lsAllSites[k].name){rootSiteIndex=k;rootSite=lsAllSites[k];break}scope.siteTreeVal={ID:rootSite.ID,name:rootSite.name,children:[]};lsAllSites.splice(rootSiteIndex,1);buildSiteTreeFromSiteList(scope.siteTreeVal,lsAllSites,lsSelectedSiteIds);scope.siteTreeVal.children.push({ID:"unassigned_devicesite",name:"Unassigned"})}(lsAllSites);deferred.resolve()}),(function(reason){deferred.reject(reason)}));return deferred.promise};!0!==scope.isAllDevicesRange&&"true"!==scope.isAllDevicesRange&&!0!==scope.isSiteRangeUnavailable&&"true"!==scope.isSiteRangeUnavailable&&function(){var deferred=$q.defer();initDataPartialSiteTreeByLevels().then((function(){deferred.resolve()}),(function(reason){deferred.reject(reason)}));return deferred.promise}().then((function(){2!==scope.conditionObj.RangeOption?scope.siteTreeOptions.expandToDepth=2:scope.conditionObj.SiteRange.forEach((function(siteId){ivhTreeviewMgr.expandTo(scope.siteTreeVal,siteId,scope.siteTreeOptions,!0);ivhTreeviewMgr.select(scope.siteTreeVal,siteId,scope.siteTreeOptions,!0)}));getSelectedSites(scope.siteTreeVal,scope.selectedSiteIds,scope.selectedSiteNames)}));scope.lsAllDeviceTypesObj=deviceTypeMgrSrvc.getAllDeviceTypes();scope.onSelectDeviceGroup=function(isTreeShown){isTreeShown&&scope.setDeviceGroup()};scope.setDeviceGroup=function(){scope.selectedDgIds=[];scope.selectedDgNames=[];getSelectedDGs(scope.dgTreeVal,scope.selectedDgIds,scope.selectedDgNames);scope.conditionObj.DeviceGroupRange=scope.selectedDgIds};scope.onSelectSite=function(isTreeShown){isTreeShown&&scope.setSite()};scope.setSite=function(){scope.selectedSiteIds=[];scope.selectedSiteNames=[];getSelectedSites(scope.siteTreeVal,scope.selectedSiteIds,scope.selectedSiteNames);scope.conditionObj.SiteRange=scope.selectedSiteIds};scope.lastSelectedSiteId=null;scope.onClickSite=function(node,trvw){var deferred=$q.defer();if(scope.lastSelectedSiteId!==node.ID||scope.justCheckSite){scope.lastSelectedSiteId=node.ID;scope.justCheckSite=!1;if(node.children&&1===node.children.length){node.children.splice(0,1);httpSiteSrvc.getSiteTree(node.ID).then((function(lsSubSites){var childrenList=lsSubSites.map((function(subSite){var subNode={ID:subSite.ID,name:subSite.name};1===subSite.siteCategory&&(subNode.children=[]);return subNode}));node.children=[];var _bunchNumber=0;var loadingPromise=$interval((function(){for(var i=20*_bunchNumber;i<20*(_bunchNumber+1);i++){if(i>=childrenList.length){callbackSrvc.getCallback("nbDySearchConditionsDirective.cancelLoadingInterval")();deferred.resolve();break}node.selected&&(childrenList[i].selected=!0);node.children.push(childrenList[i])}_bunchNumber++}),50);callbackSrvc.registerCallback("nbDySearchConditionsDirective.cancelLoadingInterval",(function(){$interval.cancel(loadingPromise)}))}))}}};scope.justCheckSite=null;scope.onCheckOneSite=function(node,newStatus){scope.justCheckSite=!0;if(scope.lastSelectedSiteId!==node.ID){scope.lastSelectedSiteId=node.ID;scope.onClickSite(node)}}}}}}(NetBrain);!function(){angular.module("nb.datamodel").directive("nbDySearchFilterDirective",DySearchFilter);DySearchFilter.$inject=["$log","$timeout","nb.systemmodel.deviceTypeMgrSrvc","nb.search.searchMgr"];function DySearchFilter($log,$timeout,deviceTypeMgrSrvc,searchMgr){return{restrict:"E",scope:{candidateSchemaObjs:"=",schemaIdAlias:"@",displayNameAlias:"@",typeAlias:"@",filterObj:"=",disabled:"=isDisabled",deviceActionType:"="},templateUrl:"modules/nbDataModel/common/views/nbDySearchFilterDirective.html",link:function(scope,elem){scope.filterObj;var sampleDevTypeTreeVal={ID:-1,typeName:"All Types",children:lsAllTypes};var initCheckStatusOfTree=function initCheckStatusOfTree(tree,lsIds,childName){lsIds.indexOf(tree.ID)>=0&&(tree.selected=!0);null!=tree[childName]&&null!=tree[childName]&&tree[childName].length>0&&tree[childName].forEach((function(subTree){initCheckStatusOfTree(subTree,lsIds,childName)}))};var initSelectedDevTypes=function(){initData();if(scope.filterObj)if(scope.filterObj.Conditions&&0!=scope.filterObj.Conditions.length)for(var i=0;i<scope.filterObj.Conditions.length;i++){scope.lsDevTypeTreeVals.push(angular.copy(sampleDevTypeTreeVal));scope.lsConditionSelectedDevTypeIds.push(new Array);scope.lsConditionSelectedDevTypeNames.push(new Array);var currCondition=scope.filterObj.Conditions[i];if("subType"==currCondition.Schema){var lsDevTypeIds=currCondition.Expression.split(";").map((function(numInStringFormat){return parseInt(numInStringFormat.trim())}));initCheckStatusOfTree(scope.lsDevTypeTreeVals[i],lsDevTypeIds,"children");scope.lsConditionSelectedDevTypeIds[i]=lsDevTypeIds;scope.lsConditionSelectedDevTypeNames[i]=deviceTypeMgrSrvc.getNamesByIds(lsDevTypeIds)}}else{scope.lsDevTypeTreeVals.push(angular.copy(sampleDevTypeTreeVal));scope.lsConditionSelectedDevTypeIds.push(new Array);scope.lsConditionSelectedDevTypeNames.push(new Array)}};scope.$watch("filterObj",(function(newVal){initSelectedDevTypes();if(newVal&&newVal.Conditions){var conditionLength=newVal.Conditions.length;conditionLength>0&&"-1"!=newVal.Conditions[conditionLength-1].Schema&&scope.onAddCondition()}scope.filterObj&&scope.filterObj.Conditions&&_.each(scope.filterObj.Conditions,(function(item,index){-1!=item.Schema&&"subType"!=item.Schema&&scope.onSelectConditionSchema(item.Schema,item,index)}))}));scope.dictTips={default:"e.g. item1; item2; item3",name:"e.g. NB_Core; NB_DistributeCore","intfs.ips.ip":"e.g. 192.168.1.0/24; 61.1.1.1",vendor:"e.g. Cisco; Checkpoint; Juniper",model:"e.g. 2610; ciscoASA5540; NetScreen-5GT",ver:"e.g. item1; item2; item3",contact:"e.g. system administrator; EXT:8842",loc:"e.g. 3rd floor; Boston",_config:"e.g. item1; item2; item3",Field1:"e.g. item1; item2; item3",Field2:"e.g. item1; item2; item3",Field3:"e.g. item1; item2; item3",assetTag:"e.g. item1; item2; item3",descr:"e.g. item1; item2; item3",layer:"e.g. item1; item2; item3",mem:"e.g. item1; item2; item3",mgmtIP:"e.g. 192.168.1.0/24; 61.1.1.1",mgmtIntf:"e.g. item1; item2; item3",sn:"e.g. item1; item2; item3"};scope.lsCandidateSchemas=[];scope.candidateSchemaObjs.forEach((function(obj){scope.lsCandidateSchemas.push({schemaId:obj[scope.schemaIdAlias],displayName:obj[scope.displayNameAlias],type:obj[scope.typeAlias]})}));var lsAllTypes=deviceTypeMgrSrvc.getAllDeviceTypesJsonByActions(scope.deviceActionType).map((function(devTypeJson){return{ID:devTypeJson.ID,typeName:devTypeJson.typeName}}));lsAllTypes.sort((function(obj1,obj2){return obj1.typeName<obj2.typeName?-1:obj1.typeName>obj2.typeName?1:0}));initData();if(null==scope.filterObj||null==scope.filterObj||null==scope.filterObj.Expression||null==scope.filterObj.Expression||null==scope.filterObj.Conditions||null==scope.filterObj.Conditions){scope.filterObj={};scope.filterObj.Expression="";scope.filterObj.Conditions=[];scope.filterObj.Conditions.push({Schema:-1,Operator:-1,Expression:""})}scope.setActiveConditionIndex=function(index){scope.activeConditionIndex=index};scope.setCurrentConditionIndex=function(index){scope.currConditionIndex=index};scope.onSelectDeviceTypes=function(isTreeShown,currConditionIndex){scope.setCurrentConditionIndex(currConditionIndex);scope.filterObj.Conditions&&_.each(scope.filterObj.Conditions,(function(item,index){if(index!=currConditionIndex&&"subType"==item.Schema){item.isDeviceTypeTreeShown=!1;scope.lsConditionSelectedDevTypeIds[index]=[];scope.lsConditionSelectedDevTypeNames[index]=[];!function getSelectedTypes(tree,refLsSelectedDGIds,refLsSelectedDGNames){if(tree){if("-1"!=tree.ID&&tree.selected){refLsSelectedDGIds.push(tree.ID);refLsSelectedDGNames.push(tree.typeName)}if(tree.children&&tree.children.length>0)for(var i in tree.children)getSelectedTypes(tree.children[i],refLsSelectedDGIds,refLsSelectedDGNames)}}(scope.lsDevTypeTreeVals[index],scope.lsConditionSelectedDevTypeIds[index],scope.lsConditionSelectedDevTypeNames[index]);var strCurrConExpression="";for(var i=0;i<scope.lsConditionSelectedDevTypeIds[index].length;i++){strCurrConExpression+=scope.lsConditionSelectedDevTypeIds[index][i];i!=scope.lsConditionSelectedDevTypeIds[index].length-1&&1!=scope.lsConditionSelectedDevTypeIds[index].length&&(strCurrConExpression+=";")}scope.filterObj.Conditions[index].Expression=strCurrConExpression}}))};var findNextLetterPosition=function(startIndex,charTargetLetter,str){var targetIndex=startIndex;var b1=targetIndex<str.length;var b2=str.charAt(targetIndex)!=charTargetLetter;var b3=str.charAt(targetIndex)==charTargetLetter;var b4=" "!=str.charAt(targetIndex-1);var b5=targetIndex!=str.length-1;var b6=" "!=str.charAt(targetIndex+1);for(;b1&&(b2||b3&&(b4||b5&&b6));){b1=++targetIndex<str.length;b2=str.charAt(targetIndex)!=charTargetLetter;b3=str.charAt(targetIndex)==charTargetLetter;b4=" "!=str.charAt(targetIndex-1);b5=targetIndex!=str.length-1;b6=" "!=str.charAt(targetIndex+1)}return targetIndex};var findPrevLetterPosition=function(startIndex,charTargetLetter,str){var targetIndex=startIndex;var b1=targetIndex>=0;var b2=str.charAt(targetIndex)!=charTargetLetter;var b3=str.charAt(targetIndex)==charTargetLetter;var b4=" "!=str.charAt(targetIndex+1);var b5=targetIndex>0;var b6=" "!=str.charAt(targetIndex-1);for(;b1&&(b2||b3&&(b4||b5&&b6));){b1=--targetIndex>=0;b2=str.charAt(targetIndex)!=charTargetLetter;b3=str.charAt(targetIndex)==charTargetLetter;b4=" "!=str.charAt(targetIndex+1);b5=targetIndex>0;b6=" "!=str.charAt(targetIndex-1)}return targetIndex};String.prototype.replaceAt=function(index,character){return this.substr(0,index)+character+this.substr(index+character.length)};scope.onRemoveCondition=function(index){var origLen=scope.filterObj.Conditions.length;scope.filterObj.Conditions.splice(index,1);scope.lsDevTypeTreeVals.splice(index,1);scope.lsConditionSelectedDevTypeIds.splice(index,1);scope.lsConditionSelectedDevTypeNames.splice(index,1);if(0==index){var nextLetterIndex=findNextLetterPosition(0,"B",scope.filterObj.Expression);var startIndex=nextLetterIndex;for(;nextLetterIndex<=scope.filterObj.Expression.length-1;){var nextChar=String.fromCharCode(scope.filterObj.Expression.charCodeAt(nextLetterIndex)+1);scope.filterObj.Expression.replaceAt(nextLetterIndex,nextChar);nextLetterIndex=findNextLetterPosition(nextLetterIndex,nextChar,scope.filterObj.Expression)}scope.filterObj.Expression=scope.filterObj.Expression.substring(startIndex)}else if(index==origLen-1){var prevLetterIndex=findPrevLetterPosition(scope.filterObj.Expression.length-1,String.fromCharCode("A".charCodeAt(0)+index-1),scope.filterObj.Expression);startIndex=prevLetterIndex;for(;prevLetterIndex>=0;){var prevChar=String.fromCharCode(scope.filterObj.Expression.charCodeAt(prevLetterIndex)-1);scope.filterObj.Expression.replaceAt(prevLetterIndex,prevChar);prevLetterIndex=findPrevLetterPosition(prevLetterIndex,prevChar,scope.filterObj.Expression)}scope.filterObj.Expression=scope.filterObj.Expression.substring(0,startIndex+1)}else{var targetChar=String.fromCharCode("A".charCodeAt(0)+index);prevChar=String.fromCharCode("A".charCodeAt(0)+index-1);startIndex=0;for(;startIndex<scope.filterObj.Expression.length&&(scope.filterObj.Expression.charAt(startIndex)!=targetChar||" "!=scope.filterObj.Expression.charAt(startIndex-1)||" "!=scope.filterObj.Expression.charAt(startIndex+1));)startIndex++;var targetCharIndex=findNextLetterPosition(startIndex,targetChar,scope.filterObj.Expression);var prevCharIndex=findPrevLetterPosition(startIndex,prevChar,scope.filterObj.Expression);var cnt=1;nextChar=String.fromCharCode("A".charCodeAt(0)+index+cnt);var nextCharIndex=findNextLetterPosition(targetCharIndex,nextChar,scope.filterObj.Expression);for(;nextCharIndex!==scope.filterObj.Expression.length;){scope.filterObj.Expression.replaceAt(nextCharIndex,nextChar);cnt++;nextChar=String.fromCharCode("A".charCodeAt(0)+index+cnt);nextCharIndex=findNextLetterPosition(nextCharIndex,nextChar,scope.filterObj.Expression)}var strPrev=scope.filterObj.Expression.substring(0,prevCharIndex+1);var strPost=scope.filterObj.Expression.substring(targetCharIndex+1);scope.filterObj.Expression=strPrev+strPost}var isConditionIndex=function(expression,index){return 0==index||index==expression.length-1||" "==expression.charAt(index-1)&&" "==expression.charAt(index+1)};var replaceCharAtIndex=function(str,index,newChar){return 1==str.length?newChar:0==index?newChar+str.substr(1):index==str.length-1?str.substr(0,str.length-1)+newChar:str.substr(0,index)+newChar+str.substring(index+1)};!function(){var startCode="A".charCodeAt(0);for(var i=0;i<scope.filterObj.Expression.length;i++)if(isConditionIndex(scope.filterObj.Expression,i)){scope.filterObj.Expression=replaceCharAtIndex(scope.filterObj.Expression,i,String.fromCharCode(startCode));startCode++}}()};scope.onAddCondition=function(){scope.filterObj.Conditions.push({Schema:-1,Operator:-1,Expression:""});scope.lsDevTypeTreeVals.push(angular.copy(sampleDevTypeTreeVal));scope.lsConditionSelectedDevTypeIds.push(new Array);scope.lsConditionSelectedDevTypeNames.push(new Array);var ele=document.querySelector(".conditions-list");var timer=$timeout((function(){$(ele).scrollTop(ele.scrollHeight);$timeout.cancel(timer)}),100)};scope.onAppendBooleanExpression=function(){if(2!=scope.filterObj.Conditions.length){var newDisplayIndex=String.fromCharCode("A".charCodeAt(0)+scope.filterObj.Conditions.length-2);scope.filterObj.Expression+=" and "+newDisplayIndex}else scope.filterObj.Expression="A"};scope.onSelectConditionSchema=function(strSchemaId,refCondition,conditionIndex){if(refCondition.Schema!=strSchemaId&&"subType"==refCondition.Schema){scope.lsDevTypeTreeVals[conditionIndex]=angular.copy(sampleDevTypeTreeVal);scope.lsConditionSelectedDevTypeIds[conditionIndex]=[];scope.lsConditionSelectedDevTypeNames[conditionIndex]=[]}var isNew=-1==refCondition.Schema||refCondition.Schema!=strSchemaId;refCondition.Schema=strSchemaId;var operator=refCondition.Operator;var expression=refCondition.Expression;refCondition.Expression="";if("subType"==strSchemaId){refCondition.Operator=0;initSelectedDevTypes()}else{refCondition.Operator=-1;if(!isNew){refCondition.Operator=operator;refCondition.Expression=expression||""}}refCondition.operators=scope.generateOperators(strSchemaId)||[];-1==refCondition.Operator&&refCondition.operators&&refCondition.operators.length>0&&(refCondition.Operator=refCondition.operators[0].id);if(conditionIndex==scope.filterObj.Conditions.length-1){scope.onAddCondition();scope.onAppendBooleanExpression()}};function initData(){scope.lsDevTypeTreeVals=[];scope.lsConditionSelectedDevTypeIds=[];scope.lsConditionSelectedDevTypeNames=[]}scope.getDisplayIndex=function(nIndex){return String.fromCharCode("A".charCodeAt(0)+nIndex)};scope.getSchemaDisplayNameBySchemaId=function(strSchemaId){if(-1==strSchemaId)return"Choose Schema";for(var i=0;i<scope.lsCandidateSchemas.length;i++)if(scope.lsCandidateSchemas[i].schemaId==strSchemaId)return scope.lsCandidateSchemas[i].displayName;return"Invalid"};scope.getOperatorNameByOperatorId=function(nOperatorId){switch(nOperatorId){case-1:return"Choose Operator";case 0:return"Matches";case 1:return"Does not match";case 2:return"Equals";case 3:return"Does not equal";case 4:return"Contains";case 5:return"Does not contain"}};scope.lsOperatorsForIp=[{name:"Matches",id:0},{name:"Does not match",id:1}];scope.lsOperatorsForConfig=[{name:"Matches",id:0},{name:"Does not match",id:1},{name:"Contains",id:4},{name:"Does not contain",id:5}];scope.lsOperatorsGeneral=[{name:"Matches",id:0},{name:"Does not match",id:1},{name:"Equals",id:2},{name:"Does not equal",id:3},{name:"Contains",id:4},{name:"Does not contain",id:5}];scope.generateOperators=function(schema){if(_.isString(schema)){var opr=searchMgr.getAdvancedSearchOperators(schema);var opers=[];_.each(opr||[],(function(item){opers.push({name:item.label,id:item.value})}));return opers}return[]};scope.onClickDropdownToggle=function(event,isRightSideButton,index){var className=event.target.className;var button=$(event.target);"icon_nb_arrow_down"===className?button=$(event.target).parent().parent():"icon-container"===className&&(button=$(event.target).parent());isRightSideButton&&(button=button.siblings(".dropdown-body"));var dropdown=button.siblings(".dropdown-menu");0===dropdown.length&&(dropdown=button.siblings(".multiSelectTree_div"))};scope.onClickDeviceTypeToggleButtonInner=function(event){var parentElem=$(event.target).parent();$timeout((function(){angular.element(parentElem).trigger("click")}))};scope.testPrint=function(arg){$log.debug(arg)};scope.toggleNode=function(node,trvw,event,isPropagation){isPropagation||event.stopPropagation();trvw.toggleExpanded(node)}}}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").directive("nbSelectDeviceDirective",SelectDevice);SelectDevice.$inject=["$uibModal","$log"];function SelectDevice($uibModal,$log){return{restrict:"E",scope:{displayName:"@",isDisabled:"=",callbackFunction:"=",initDevices:"=",selectedDevices:"="},template:'<button ng-disabled="isDisabled" class="btn btn-primary" ng-click="popSelectDeviceModal()" atag="domainAdmin:domainCreatePopup:networkServerPopup:allocateBtn">{{displayName}}</button>',link:function(scope,elem,attrs){scope.isDisabled||(scope.isDisabled=!1);null!=scope.displayName&&null!=scope.displayName||(scope.displayName="Add");null!=scope.selectedDevices&&null!=scope.selectedDevices||(scope.selectedDevices=[]);scope.selectDeviceModal=null;scope.popSelectDeviceModal=function(){var tempDevices=angular.fromJson(angular.toJson(scope.initDevices));scope.selectDeviceModal=$uibModal.open({templateUrl:"modules/nbDataModel/common/views/selectDevicePopup.html",controller:"nb.datamodel.selectDevicePopupCtrl",windowClass:"selectDevicePopup",backdrop:"static",resolve:{singleSelectionOnly:function(){return!1},initDevices:function(){return tempDevices}}}).result.then((function(lsSelectedDevices){scope.selectedDevices=lsSelectedDevices;scope.callbackFunction&&scope.callbackFunction(lsSelectedDevices)}),(function(reason){$log.debug("Select Device Modal Closed -- Reason : "+reason)}))}}}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").directive("nbSelectInterfaceDirective",SelectInterface);SelectInterface.$inject=["$uibModal","$log"];function SelectInterface($uibModal,$log){return{restrict:"E",scope:{displayName:"@",isDisabled:"=",callbackFunction:"=",selectedInterfaces:"="},template:'<button ng-disabled="isDisabled" class="btn btn-default" style="width: 60px;padding: 0" ng-click="popSelectInterfaceModal()">{{displayName}}</button>',link:function(scope,elem,attrs){scope.isDisabled||(scope.isDisabled=!1);null!=scope.displayName&&null!=scope.displayName||(scope.displayName="Add");null!=scope.selectedInterfaces&&null!=scope.selectedInterfaces||(scope.selectedInterfaces=[]);scope.selectInterfaceModal=null;scope.popSelectInterfaceModal=function(){scope.selectDeviceModal=$uibModal.open({templateUrl:"modules/nbDataModel/common/views/selectInterfacePopup.html",controller:"nb.datamodel.selectInterfacePopupCtrl",windowClass:"selectInterfacePopup",backdrop:"static",resolve:{resolveData:{}}}).result.then((function(lsSelectedInterfaces){scope.selectedInterfaces=lsSelectedInterfaces;scope.callbackFunction&&scope.callbackFunction(lsSelectedInterfaces)}),(function(reason){$log.debug("Select Interface Modal Closed -- Reason : "+reason)}))}}}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").directive("nbSiteTreeDirective",SiteTreeDirective);SiteTreeDirective.$inject=[];function SiteTreeDirective(){return{restrict:"EA",scope:{enableNodeDropdown:"=enableNodeDropdown",onRegisterApi:"=registerApi",onClickHandle:"=clickHandle",onClearFilter:"=clearFilter",contextMenuList:"=contextMenuList",filter:"=filter",querry:"=fetch",model:"=dataModel",useTemporaryStorage:"@useTemporaryStorage"},controller:["$scope","$rootScope","$q","$timeout","nb.datamodel.httpSiteManagerSrvc","ivhTreeviewMgr","nb.datamodel.nbSiteTreeSrvc","nb.ng.utilitySrvc","$interval",function($scope,$rootScope,$q,$timeout,httpSiteManagerSrvc,ivhTreeviewMgr,nbSiteTreeSrvc,utilitySrvc,$interval){void 0===$scope.useTemporaryStorage&&($scope.useTemporaryStorage=!0);$scope.onOK=function(){};$scope.getIconClass=function(){console.log("expand")};!1!==$scope.enableNodeDropdown&&($scope.enableNodeDropdown=!0);$rootScope.$on("select_site_node",(function(event,arg){$scope.onClearFilter();var siteId=arg.siteId;var parentPath=arg.parentPath;parentPath&&$scope.refresh().then((function(data){var i=1;var cursite;cursite=angular.isArray($scope.siteTree)?$scope.siteTree[0]:$scope.siteTree;var timer=setInterval((function(){if(i<parentPath.length){var parentId=parentPath[i];if((doc=_.filter(cursite.children,(function(a){return a.ID==parentId}))).length>0){cursite=doc[0];$scope.expand(cursite,!0);$scope.onNodeClick(cursite);i++}}else{var doc;if((doc=_.filter(cursite.children,(function(a){return a.ID==siteId}))).length>0){cursite=doc[0];$scope.onNodeClick(cursite);window.clearInterval(timer)}else i>10&&window.clearInterval(timer);i++}}),200)}))}));$scope.expand=function(node,bycode){var defer=$q.defer();if(bycode){if(node.expanded){defer.resolve("expanded!");return defer.promise}ivhTreeviewMgr.expand($scope.siteTree,node,$scope.treeOptions)}if(node.isLoading)defer.resolve("loading!");else if(0===node.siteCategory){defer.resolve("expanded!");ivhTreeviewMgr.expand($scope.siteTree,node,$scope.treeOptions)}else $scope.fetch(node).then((function(){ivhTreeviewMgr.expand($scope.siteTree,node,$scope.treeOptions);defer.resolve("expanded!")}));return defer.promise};var filterFn=$scope.filter||function(){return!0};$scope.fetch=function(node){var defer=$q.defer();var siteId=node.ID;$scope.querry(siteId,$scope.useTemporaryStorage).then((function(data){var items=[];angular.forEach(data,(function(item){if(filterFn&&filterFn(item)){(item=formatSite(item)).parent=node;item.id=item.ID;items.push(item)}}));node.loaded=!0;defer.resolve(items)}));return defer.promise};$scope.onNodeClick=function(node){if($scope.selected!==node){$scope.selected&&($scope.selected.selected=!1);$scope.selected=node;$scope.treeOptions.treeObj.selectNode(node.ID);angular.isFunction($scope.onClickHandle)&&$scope.onClickHandle(node)}};$scope.onSelectedChange=function(node,selected,root){console.log("onNodeClick")};function formatSite(item){item.isLeaf=item.siteCategory>=2;item.siteIcon=function(siteCategory){var icon="";switch(siteCategory){case 1:icon="container_site_icon";break;case 2:icon="leaf_site_icon";break;case 3:icon="unassigned_site_icon";break;case 4:icon="excluded_from_site_icon";break;default:icon="container_site_icon"}return icon}(item.siteCategory);item.selected=!1;1===item.siteCategory&&(item.children=[]);return item}$scope.getTreeHandle=function(treehandle){$scope.ivhTree=treehandle};$scope.refresh=function(){$scope.siteTree=null;return init()};$scope.init=init;$scope.treeOptions={defaultSelectedState:!1,expandToDepth:1,labelAttribute:"name",enableTwoWayBinding:!1,idAttribute:"ID",childrenAttribute:"children",expandedAttribute:"expanded",enableLabelExpand:!1,enableSearchBar:!1,enableMultipleSelect:!1,nodeTpl:"<nb-treeview-simple-node-tpl></nb-treeview-simple-node-tpl>",labelTemplate:function(node,trvw){return node.name+"("+node.deviceCount+")"},enableNodeDropdown:{isDisplay:function(node,trvw){return!(!$scope.enableNodeDropdown||-1==node.ID||4==node.siteCategory)},dropdownItems:$scope.contextMenuList},nodeClickCallback:function(node,trvw){$scope.selected=node;angular.isFunction($scope.onClickHandle)&&$scope.onClickHandle(node,trvw)},lazyLoadingAttribute:function(node){return 1===node.siteCategory},lazyLoadingCallback:$scope.fetch,iconTemplate:function(node){return"<span class='"+node.siteIcon+"'>"}};angular.isFunction($scope.onRegisterApi)||init();$scope.siteTree=[];function init(){var defer=$q.defer();$scope.selecteUnassignedNode=!1;var selectedNodeName=utilitySrvc.getLocalStorage(adminEvent.selectSiteManagerFromStartPage);if(selectedNodeName&&"unassigned"==selectedNodeName.toString().toLowerCase()){$scope.selecteUnassignedNode=!0;utilitySrvc.removeLocalStorage(adminEvent.selectSiteManagerFromStartPage)}if($scope.model){$scope.siteTree=$scope.model;$scope.treeOptions.treeObj.updateTree();defer.resolve("inited!")}else{$scope.loaded=!1;$scope.querry(0,$scope.useTemporaryStorage).then((function(data){var allCount=data.deviceCount;var cCount=0;data.selected=!$scope.selecteUnassignedNode;data.isLeaf=!1;data.siteIcon="container_site_icon";angular.forEach(data.children,(function(item,index){cCount+=item.deviceCount;formatSite(item);item.parent=data;filterFn(item)||data.children.splice(index,1,null)}));data.children=_.compact(data.children);$scope.unAssigned={ID:"-1",name:"Unassigned",deviceCount:allCount-cCount,siteCategory:3,siteIcon:"unassigned_site_icon",isLeaf:!0,selected:$scope.selecteUnassignedNode};if(filterFn&&filterFn($scope.unAssigned)&&data.children.length>0&&$scope.unAssigned.deviceCount>0){var lastItem=data.children[data.children.length-1];lastItem&&4===lastItem.siteCategory?data.children.splice(data.children.length-1,0,$scope.unAssigned):data.children.push($scope.unAssigned)}else 0===data.children.length&&$scope.unAssigned.deviceCount>0&&data.children.push($scope.unAssigned);$scope.siteTree=data;$scope.treeOptions.treeObj.updateTree((function(){$scope.onNodeClick($scope.selecteUnassignedNode?$scope.unAssigned:data)}));$scope.loaded=!0;defer.resolve("inited!")}))}return defer.promise}var selectUnassignedDevices=$rootScope.$on(adminEvent.selectSiteManagerFromStartPage,(function(event,arg){if(arg&&"unassigned"==arg.toString().toLowerCase()){utilitySrvc.removeLocalStorage(adminEvent.selectSiteManagerFromStartPage);$scope.onNodeClick($scope.unAssigned)}}));$scope.$on("$destroy",selectUnassignedDevices)}],link:function(scope,element,attrs){scope.onRegisterApi&&scope.onRegisterApi(scope)},template:'<div ng-show="loaded" nb-treeview="siteTree" options="treeOptions" atag="domainAdmin:domainCreatePopup:selectDevicePopup:siteTree"></div><div ng-show="!loaded" class="text-center margin"><i class="fa fa-spinner fa-spin fa-2x"></i></div>'}}}(NetBrain);!function(){angular.module("nb.datamodel").directive("nbMultiSelectTreeDropdownDirective",MultiSelectTreeDropdown);MultiSelectTreeDropdown.$inject=["$log"];function MultiSelectTreeDropdown(){return{restrict:"E",scope:{isHide:"=?",isDisabled:"=?",placeHolder:"=?",treeValue:"=",idAttribute:"=",labelAttribute:"=",childrenAttribute:"=",expandToDepth:"=?",selectedIds:"=",selectedCallback:"=",disableCallback:"=",refreshTrigger:"=?"},templateUrl:"modules/nbDataModel/common/views/nbMultiSelectTreeDropdownDirective.html",link:function(scope){var makeArray=function(arr){return!angular.isArray(arr)&&angular.isObject(arr)?[arr]:arr};var getSelectedIds=function(treeValue){scope.selectedIds=[];scope.lsSelectedItemLabels=[];!function _getSelectedIds(treeValue){for(var i in treeValue){var tree=treeValue[i];if(tree.isSelected){scope.selectedIds.push(tree[scope.idAttribute]);scope.lsSelectedItemLabels.push(tree[scope.labelAttribute])}tree[scope.childrenAttribute]&&_getSelectedIds(tree[scope.childrenAttribute])}}(treeValue);""==scope.selectedIds[0]&&(scope.lsSelectedItemLabels=[scope.lsSelectedItemLabels[0]])};scope.selectedIds=[];scope.lsSelectedItemLabels=[];getSelectedIds(makeArray(scope.treeValue));scope.expandToDepth||(scope.expandToDepth=-1);scope.placeHolder||(scope.placeHolder="Please select ...");scope.$watchCollection("treeValue[0].children",(function(){getSelectedIds(makeArray(scope.treeValue))}));scope.onToggleDropdown=function(isShown){var show=$(".menu-body");1!=show.length&&show.addClass("ng-hide");if(null!=isShown){if(!scope.isDropdownShown)return;scope.isDropdownShown=isShown}else scope.isDropdownShown=!scope.isDropdownShown;if(!scope.isDropdownShown){scope.calculateResult();scope.selectedCallback&&!scope.disableCallback&&scope.selectedCallback(scope.selectedIds,scope.lsSelectedItemLabels)}};scope.calculateResult=function(){getSelectedIds(makeArray(scope.treeValue))};scope.onNodeClicked=function(){getSelectedIds(makeArray(scope.treeValue));scope.selectedCallback&&!scope.disableCallback&&scope.selectedCallback(scope.selectedIds,scope.lsSelectedItemLabels)};scope.refreshTrigger=function(){getSelectedIds(makeArray(scope.treeValue))}}}}}(NetBrain);function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}!function(netBrain){angular.module("nb.datamodel").directive("nbSelectQappDirective",SelectQapp);SelectQapp.$inject=["$uibModal","$log","$q","$timeout","$sce","nb.qapp.httpQappCategorySrvc","nb.qapp.httpQappInfoSrvc","nb.common.nbAlertSrvc"];var builtInQappAccessType=1;function SelectQapp($uibModal,$log,$q,$timeout,$sce,httpQappCategorySrvc,httpQappInfoSrvc,nbAlertSrvc){return{restrict:"EA",scope:{isPathQapp:"@isPathQapp",isSingleSelect:"=isSingleSelect",selectedQapps:"=selectedQapp",excludeVersions:"=excludeVersions",onSubmit:"&onSubmit",onCancel:"&onCancel"},templateUrl:"modules/nbDataModel/common/views/selectQapp.html",controller:["$scope",function($scope){$scope.submit=$scope.onSubmit();$scope.cancel=$scope.onCancel();$scope.selectedQapps=$scope.selectedQapps;$scope.isPathQapp=$scope.isPathQapp;$scope.isSingleSelect=!0===$scope.isSingleSelect;var lastSelectNode=null;if($scope.isSingleSelect&&$scope.selectedQapps&&$scope.selectedQapps.length>0){lastSelectNode=$scope.selectedQapps[$scope.selectedQapps.length-1];$scope.selectedQapps=[lastSelectNode]}var cIndex=1;function getCIndex(){var i=cIndex;cIndex++;return i}$scope.selectedQapps&&$scope.selectedQapps.length&&$scope.selectedQapps.forEach((function(ele){ele.cIndex=getCIndex()}));$scope.filterOptions={filterTarget:"",searchKeyword:""};$scope.ivhTreeOptions={defaultSelectedState:!1,validate:!1,expandToDepth:1,labelAttribute:"name",idAttribute:"id",childrenAttribute:"children",expandedAttribute:"expended",useCheckboxes:!1,twistieLeafTpl:""};$scope.selectCallback=function(ivhNode,ivhIsSelected,ivhTree){};$scope.treeData=[];var temp;$scope.$on("openQappPreview",(function(e,qappId){httpQappInfoSrvc.getQappInfo(qappId).then((function(data){$scope.qappInfo=data;data.description&&($scope.qappInfo.description=$sce.trustAsHtml(data.description))}),(function(msg){console.warn(msg.ResultDesc)}))}));$scope.onClose=function(){angular.isFunction($scope.cancel)&&$scope.cancel($scope.selectedQapps)};$scope.onOK=function(){var results=[];temp&&temp.forEach((function(item){!function checkAll(node,results){node.children.forEach((function(item){if(item.children.length>0)item.children.forEach((function(item1){if(item1.checked&&item1.isQapp){var obj=new Object;obj.qappName=item1.name;obj.qappId=item1.id;obj.cIndex=item1.cIndex||999999999;obj.parentPath=item1.nodePathName.split(">").join("/");obj.qappPath=item1.qappPath;obj.parentId=item1.parentId;results.push(obj)}checkAll(item1,results)}));else if(item.checked&&item.isQapp){var obj1=new Object;obj1.qappName=item.name;obj1.qappId=item.id;obj1.cIndex=item.cIndex||999999999;obj1.parentPath=item.nodePathName.split(">").join("/");obj1.qappPath=item.qappPath;obj1.parentId=item.parentId;results.push(obj1)}}))}(item,results)}));var strFilter=$scope.filterOptions.searchKeyword&&$scope.filterOptions.searchKeyword.trim().toLowerCase()||null;$scope.selectedQapps=strFilter?results.filter((function(ele){return ele.qappName.toLowerCase().indexOf(strFilter)>=0})):results;$scope.$parent.selectedQapps=$scope.selectedQapps;$scope.selectedQapps.sort((function(ele1,ele2){return ele1.cIndex-ele2.cIndex}));angular.isFunction($scope.submit)&&$scope.submit($scope.selectedQapps)};$scope.filter=function(){treeAction.filter($scope.filterOptions.filterTarget);$scope.filterOptions.searchKeyword=""};$scope.onSearch=function(e){if(13==e.keyCode){$scope.filter();$scope.filterOptions.searchKeyword=$scope.filterOptions.filterTarget}};var bingSelectedQappsLevel=function(treeData,selectedQapps){treeData.forEach((function(item){!function bingSelectedQapps(node,selectedQapps){node.children.forEach((function(item){item.children&&item.children.length>0?item.children.forEach((function(item1){selectedQapps.forEach((function(itemQapp){if(item1.id==itemQapp.qappId||item1.qappPath&&item1.qappPath==itemQapp.qappPath){item1.checked=!0;$scope.isSingleSelect&&(lastSelectNode=item1);item1.cIndex=itemQapp.cIndex||null;selectUp(item1,item1.checked)}}));bingSelectedQapps(item1,selectedQapps)})):item.isQapp&&selectedQapps.forEach((function(itemQapp){if(item.id==itemQapp.qappId||item.qappPath&&item.qappPath==itemQapp.qappPath){item.checked=!0;$scope.isSingleSelect&&(lastSelectNode=item);item.cIndex=itemQapp.cIndex||null;selectUp(item,item.checked)}}))}))}(item,selectedQapps)}))};var selectUp=function selectUp(node,isChecked){var valid=0;var parentNode=treeMgr.getParentNode(node);if(parentNode)if(null===isChecked){parentNode.checked=isChecked;selectUp(parentNode,isChecked)}else{var parentChildrenCount=parentNode.children.length;parentNode.children.forEach((function(item){item.checked&&valid++}));if(parentChildrenCount==valid){parentNode.checked=isChecked;selectUp(parentNode,isChecked)}else if(0==valid){parentNode.checked=!1;selectUp(parentNode,!1)}else{parentNode.checked=null;selectUp(parentNode,null)}}};var treeMgr=new QappCategoryTreeMgr($scope.ivhTreeOptions,{nodeScopeHandler:function(node){treeMgr.isRootNode(node)?node.actionMenu=qappCenter.rootNodeActionMenu:node.isQapp?node.actionMenu=qappCenter.qappNodeActionMenu:node.actionMenu=qappCenter.subNodeActionMenu;node.menuActionClick=treeAction.nodeMenuActionClick;node.nodeClick=treeAction.nodeClick;node.nodeDbClick=treeAction.nodeDbClick;node.isSingleSelect=treeAction.isSingleSelect;node.checkClick=treeAction.checkClick},filter:!0});var treeAction={confirm:function(title){return nbAlertSrvc.confirm({message:title})},alert:function(msg){msg=msg&&"object"==_typeof(msg)?msg.ResultDesc:msg;return nbAlertSrvc.alert({message:msg})},loadTree:function(isPathQapp,excludeVersions){httpQappCategorySrvc.getQappCenterRootTree(isPathQapp,excludeVersions).then((function(data){treeMgr.setData(data);$scope.treeData=treeMgr.getTreeData();$scope.selectedQapps&&$scope.selectedQapps.length>0&&bingSelectedQappsLevel($scope.treeData,$scope.selectedQapps);temp=$scope.treeData;!function(data){$timeout((function(){_.find(data[0].children,(function(item){return item.accessType==builtInQappAccessType})).expended=!0}))}($scope.treeData)}),(function(msg){console.warn(msg.ResultDesc)}))},nodeClick:function(node){treeMgr.selectNode(node);if(node.isQapp&&$scope.isSingleSelect&&node!=lastSelectNode){node.checked=!0;lastSelectNode&&(lastSelectNode.checked=!1);lastSelectNode=node}},nodeDbClick:function(node){node.isQapp&&$scope.isSingleSelect&&$scope.onOK()},checkClick:function(node,$event){$event.stopPropagation();node.cIndex=getCIndex();!function selectAll(node,isChecked,_cIndex){node.children.forEach((function(item){item.children&&item.children.forEach((function(item1){item1.checked=isChecked;item1.cIndex=_cIndex||null;selectAll(item1,isChecked,_cIndex)}));item.checked=isChecked;item.cIndex=_cIndex||null}))}(node,node.checked,node.cIndex);selectUp(node,node.checked)},doAction:function(msg,action,node){if(node.accessType==qappCenter.BuiltInFiles){qappCenter.builtInFilesMsg=msg;treeAction.confirm(qappCenter.builtInFilesMsg).then((function(){action(node)}))}else action(node)},filter:function(keyword){treeMgr.filter(keyword||"")},isSingleSelect:function(){return $scope.isSingleSelect}};treeAction.loadTree($scope.isPathQapp,$scope.excludeVersions||[])}]}}}(NetBrain);!function(NetBrain){angular.module("nb.datamodel").controller("nb.datamodel.selectDevicePopupCtrl",SelectDevicePopupCtrl);SelectDevicePopupCtrl.$inject=["$scope","$rootScope","$uibModalInstance","$log","$q","$timeout","ivhTreeviewMgr","nb.ng.userSrvc","nb.common.nbAlertSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.netbrain.httpDeviceSrvc","nb.systemmodel.deviceTypeMgrSrvc","singleSelectionOnly","initDevices","nb.datamodel.httpSiteSrvc","nb.ansible.ansibleExecutionSrvc","nb.ng.utilitySrvc"];function SelectDevicePopupCtrl($scope,$rootScope,$uibModalInstance,$log,$q,$timeout,ivhTreeviewMgr,userSrvc,nbAlertSrvc,httpDeviceGroupSrvc,httpDeviceSrvc,deviceTypeMgrSrvc,singleSelectionOnly,initDevices,httpSiteSrvc,AnsibleExecutionSrvc,utilitySrvc){$scope.singleSelectionOnly=singleSelectionOnly;$scope.deviceSrcRange="deviceTypeRadio";$scope.initDevices=initDevices;$scope.selectedCount=0;$scope.objSelectedDeviceType=null;$scope.siteTreeVal={};$scope.deviceActionType=-1;$scope.arrSrcDevices=[];$scope.itemCount=0;$scope.pageNumber=0;$scope.pageSize=100;$scope.selectedItems_Src=[];$scope.selectedItems_Dest=[];$scope.loginUserId=userSrvc.getUserID();var curAnsibleAgentGUIDs;$scope.sortField="name";$scope.sortOrder="asc";function getGroupsByType(groupType){return _.filter($scope.lsDGs_all,(function(group){return(1!==groupType||group.UserGuid&&group.UserGuid===$scope.loginUserId)&&group.Type==groupType}))}$scope.dgTreeVal={ID:"0",Name:"All",items:[{ID:"00",Name:"Public"},{ID:"01",Name:"My Device Groups"},{ID:"02",Name:"System"}]};$scope.lsDGs_shared=[];$scope.lsDGs_private=[];$scope.lsDGs_public=[];$scope.lsDGs_policy=[];$scope.lsDGs_all=[];$scope.arrDestDevices=[];$scope.arrSrcDevices_Backup=[];$scope.srcDeviceFilterOptions={filterText:"",searchKey:""};$scope.gridNameCellTemplate='<div class="ui-grid-cell-contents ng-scope" style="cursor: pointer;"  title="{{COL_FIELD}}"><span ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.srcDeviceFilterOptions.filterText">{{COL_FIELD}}</span></div>';$scope.gridOptions_addDevices_Src={data:"arrSrcDevices",enableColumnResizing:!0,multiSelect:!$scope.singleSelectionOnly,modifierKeysToMultiSelect:!0,enableFullRowSelection:!0,enableRowSelection:!0,enableGridMenu:!1,enableColumnMenus:!1,enableRowHeaderSelection:!1,showHeader:!0,enableHorizontalScrollbar:0,columnDefs:[{field:"name",displayName:"Hostname",width:214,cellTemplate:$scope.gridNameCellTemplate},{field:"mgmtIP",displayName:"Mgmt IP",width:89,cellTemplate:$scope.gridNameCellTemplate},{field:"vendor",displayName:"Vendor",width:74,cellTemplate:$scope.gridNameCellTemplate},{field:"model",displayName:"Model",width:106,cellTemplate:$scope.gridNameCellTemplate}],rowTemplate:'<div ng-dblclick="grid.appScope.onAddToDestGrid(row)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell></div>',enableFiltering:!1,onRegisterApi:function(gridApi){$scope.gridApi=gridApi},enableGridInfiniteScroll:{offset:3,isNeedMore:function(){return $scope.arrSrcDevices.length<$scope.itemCount},loadCallback:function(){$scope.pageNumber++;var defer=$q.defer();if($scope.arrSrcDevices.length>=$scope.itemCount){defer.resolve();return defer.promise}switch($scope.deviceSrcRange){case"deviceGroupRadio":var reqObj={guids:$scope.lsDgIds,pageNumber:$scope.pageNumber,pageSize:$scope.pageSize,filterField:["name","mgmtIP","model","vendor"],filterContent:$scope.srcDeviceFilterOptions.filterText,sortField:$scope.sortField,sortOrder:$scope.sortOrder,includeIntfDev:!0};httpDeviceGroupSrvc.getDevicesOfDeviceGroupIdsByPaging(reqObj).then((function(resObj){$scope.itemCount=resObj.count;var dictDevIdToName=resObj.dictIdDevice;for(var devId in dictDevIdToName){var objDevice=dictDevIdToName[devId];$scope.arrSrcDevices.push({name:objDevice.name,ID:objDevice.ID,mgmtIP:objDevice.mgmtIP,type:objDevice.subType,oid:objDevice.oid,vendor:objDevice.vendor,model:objDevice.model})}defer.resolve()}),(function(status){defer.reject(status)}));return defer.promise;case"ansibleAgentRadio":AnsibleExecutionSrvc.getAnsibleAgentDevices([],$scope.pageNumber,$scope.pageSize,$scope.sortField,$scope.sortOrder).then((function(res){parseAnsibleAgentDevicesData(res,!1);defer.resolve()}),(function(status){defer.reject(status)}));return defer.promise;case"siteRadio":var selectedSiteId=$scope.selectedSite.ID;httpSiteSrvc.getSiteDevicesBySiteIDByPagingWithType(selectedSiteId,4,$scope.pageNumber,$scope.pageSize,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,$scope.sortField,$scope.sortOrder).then((function(resObj){var lsDevices=resObj.memberList;$scope.itemCount=resObj.count;lsDevices.forEach((function(siteObj){var devObj=siteObj.siteMember;$scope.arrSrcDevices.push({name:devObj.deviceName,ID:devObj.deviceId,type:siteObj.deviceType,oid:devObj.oid,mgmtIP:devObj.mgmtIP,vendor:devObj.vendor,model:devObj.model})}));defer.resolve()}),(function(reason){defer.reject(reason)}));return defer.promise;case"deviceTypeRadio":var devTypeId=$scope.objSelectedDeviceType.ID;(-1===devTypeId?httpDeviceSrvc.getAllDevicesByPaging($scope.pageSize,$scope.pageNumber,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,!0,$scope.sortField,$scope.sortOrder):httpDeviceSrvc.getDevicesByTypesByPaging(devTypeId,$scope.pageSize,$scope.pageNumber,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,!0,$scope.sortField,$scope.sortOrder)).then((function(resObj){var lsDevices=resObj.deviceList;$scope.itemCount=resObj.count;$scope.gridOptions_addDevices_Src.data=null;lsDevices.forEach((function(objDevice){$scope.arrSrcDevices.push({name:objDevice.name,ID:objDevice.ID,mgmtIP:objDevice.mgmtIP,type:objDevice.subType,oid:objDevice.oid,vendor:objDevice.vendor,model:objDevice.model})}));$scope.gridOptions_addDevices_Src.data=$scope.arrSrcDevices;defer.resolve()}),(function(reason){$log.info(reason)}));return defer.promise;default:return defer.promise}}}};$scope.loadDeviceData=function(){switch($scope.deviceSrcRange){case"deviceGroupRadio":var reqObj={guids:$scope.lsDgIds,pageNumber:$scope.pageNumber,pageSize:$scope.pageSize,filterField:["name","mgmtIP","model","vendor"],filterContent:$scope.srcDeviceFilterOptions.filterText,sortField:$scope.sortField,sortOrder:$scope.sortOrder,includeIntfDev:!0};httpDeviceGroupSrvc.getDevicesOfDeviceGroupIdsByPaging(reqObj).then((function(resObj){$scope.itemCount=resObj.count;$scope.arrSrcDevices=[];var dictDevIdToName=resObj.dictIdDevice;for(var devId in dictDevIdToName){var objDevice=dictDevIdToName[devId];$scope.arrSrcDevices.push({name:objDevice.name,ID:objDevice.ID,mgmtIP:objDevice.mgmtIP,type:objDevice.subType,oid:objDevice.oid,vendor:objDevice.vendor,model:objDevice.model})}$scope.gridOptions_addDevices_Src.data=$scope.arrSrcDevices}),(function(){nbAlertSrvc.error("An error occurred while attempting to retrieve the selected device group.")}));break;case"ansibleAgentRadio":AnsibleExecutionSrvc.getAnsibleAgentDevices(curAnsibleAgentGUIDs,$scope.pageNumber,$scope.pageSize,$scope.sortField,$scope.sortOrder,$scope.srcDeviceFilterOptions.filterText).then((function(res){parseAnsibleAgentDevicesData(res,!0)}),(function(){nbAlertSrvc.error("An error occurred while attempting to retrieve the selected device group.")}));break;case"siteRadio":var selectedSiteId=$scope.selectedSite.ID;httpSiteSrvc.getSiteDevicesBySiteIDByPagingWithType(selectedSiteId,4,$scope.pageNumber,$scope.pageSize,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,$scope.sortField,$scope.sortOrder).then((function(resObj){var lsDevices=resObj.memberList;$scope.itemCount=resObj.count;$scope.arrSrcDevices=[];lsDevices.forEach((function(siteObj){var devObj=siteObj.siteMember;$scope.arrSrcDevices.push({name:devObj.deviceName,ID:devObj.deviceId,type:siteObj.deviceType,oid:devObj.oid,mgmtIP:devObj.mgmtIP,vendor:devObj.vendor,model:devObj.model})}));$scope.gridOptions_addDevices_Src.data=$scope.arrSrcDevices}),(function(){nbAlertSrvc.error("An error occurred while attempting to retrieve the devices for the selected site: "+selectedSiteId)}));break;case"deviceTypeRadio":var devTypeId=$scope.objSelectedDeviceType.ID;(-1===devTypeId?httpDeviceSrvc.getAllDevicesByPaging($scope.pageSize,$scope.pageNumber,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,!0,$scope.sortField,$scope.sortOrder):httpDeviceSrvc.getDevicesByTypesByPaging(devTypeId,$scope.pageSize,$scope.pageNumber,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,!0,$scope.sortField,$scope.sortOrder)).then((function(resObj){var lsDevices=resObj.deviceList;$scope.itemCount=resObj.count;$scope.gridOptions_addDevices_Src.data=null;$scope.arrSrcDevices=[];lsDevices.forEach((function(objDevice){$scope.arrSrcDevices.push({name:objDevice.name,ID:objDevice.ID,mgmtIP:objDevice.mgmtIP,type:objDevice.subType,oid:objDevice.oid,vendor:objDevice.vendor,model:objDevice.model})}));$scope.gridOptions_addDevices_Src.data=$scope.arrSrcDevices}),(function(reason){$log.info(reason)}))}$scope.gridApiFromGrid.infiniteScroll.resetScroll(!1,!0)};$scope.gridOptions_addDevices_Src.onRegisterApi=function(gridApi){$scope.gridApiFromGrid=gridApi;gridApi.core.on.sortChanged($scope,sortChanged)};$scope.gridOptions_addDevice_Dest={enableColumnResizing:!0,flatEntityAccess:!0,fastWatch:!0,multiSelect:!0,modifierKeysToMultiSelect:!0,enableFullRowSelection:!0,enableRowSelection:!0,enableGridMenu:!1,enableColumnMenus:!1,enableRowHeaderSelection:!1,showHeader:!1,columnDefs:[{field:"name",displayName:"Device Name"}],rowTemplate:'<div ng-dblclick="grid.appScope.onRemoveFromDestGrid(row)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell></div>',enableFiltering:!1};$scope.gridOptions_addDevice_Dest.onRegisterApi=function(gridApi){$scope.gridApiToGrid=gridApi};if($scope.initDevices){$scope.arrDestDevices=$scope.initDevices;$timeout((function(){$scope.gridOptions_addDevice_Dest.data=$scope.arrDestDevices;$scope.selectedCount=$scope.arrDestDevices.length}),500)}$scope.clearDevices=function(){for(;$scope.arrSrcDevices.length>0;)$scope.arrSrcDevices.pop();$scope.pageNumber=0};$scope.onAddToDestGrid=function(row){if(row){var selectedRow=[];selectedRow.push(row.entity);$scope.selectedItems_Src=selectedRow}else $scope.selectedItems_Src=$scope.gridApiFromGrid.selection.getSelectedRows();$scope.selectedItems_Src.forEach((function(item){_.find($scope.arrDestDevices,(function(srcDev){return item.ID===srcDev.ID}))||$scope.arrDestDevices.push(item)}));$scope.selectedItems_Src.length=0;$scope.selectedCount=$scope.arrDestDevices.length;$scope.gridOptions_addDevice_Dest.data=$scope.arrDestDevices};$scope.onRemoveFromDestGrid=function(row){if(row){var selectedRow=[];selectedRow.push(row.entity);$scope.selectedItems_Dest=selectedRow}else $scope.selectedItems_Dest=$scope.gridApiToGrid.selection.getSelectedRows();var nextDev={};$scope.selectedItems_Dest.forEach((function(item){_.find($scope.arrSrcDevices,(function(srcDev){return item.ID===srcDev.ID}))||$scope.arrSrcDevices.push(item);for(var i=0;i<$scope.arrDestDevices.length;i++)if($scope.arrDestDevices[i].ID===item.ID){$scope.arrDestDevices.splice(i,1);nextDev=$scope.arrDestDevices[i];break}$scope.selectedCount=$scope.arrDestDevices.length}));$scope.selectedItems_Dest.length=0;nextDev&&$scope.selectedItems_Dest.push(nextDev);$scope.gridOptions_addDevice_Dest.data=$scope.arrDestDevices};$scope.onAddAllToDestGrid=function(){(function(){var defer=$q.defer(),devicesArray=[];switch($scope.deviceSrcRange){case"deviceGroupRadio":var reqObj={guids:$scope.lsDgIds,pageNumber:$scope.pageNumber,pageSize:-1,filterField:["name","mgmtIP","model","vendor"],filterContent:$scope.srcDeviceFilterOptions.filterText,sortField:$scope.sortField,sortOrder:$scope.sortOrder,includeIntfDev:!0};httpDeviceGroupSrvc.getDevicesOfDeviceGroupIdsByPaging(reqObj).then((function(resObj){var dictDevIdToName=resObj.dictIdDevice;for(var devId in dictDevIdToName)if(Object.prototype.hasOwnProperty.call(dictDevIdToName,devId)){var objDevice=dictDevIdToName[devId];devicesArray.push({name:objDevice.name,ID:objDevice.ID,mgmtIP:objDevice.mgmtIP,type:objDevice.subType,oid:objDevice.oid,vendor:objDevice.vendor,model:objDevice.model})}defer.resolve(devicesArray)}),(function(reason){defer.reject(reason)}));break;case"ansibleAgentRadio":AnsibleExecutionSrvc.getAnsibleAgentDevices([],$scope.pageNumber,-1,$scope.sortField,$scope.sortOrder).then((function(res){devicesArray=_.values(res.dictIdDevice);defer.resolve(devicesArray)}),(function(reason){defer.reject(reason)}));break;case"siteRadio":httpSiteSrvc.getSiteDevicesBySiteIDByPagingWithType($scope.selectedSite.ID,4,$scope.pageNumber,-1,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,$scope.sortField,$scope.sortOrder).then((function(resObj){resObj.memberList.forEach((function(siteObj){var devObj=siteObj.siteMember;devicesArray.push({name:devObj.deviceName,ID:devObj.deviceId,type:siteObj.deviceType,oid:devObj.oid,mgmtIP:devObj.mgmtIP,vendor:devObj.vendor,model:devObj.model})}));defer.resolve(devicesArray)}),(function(reason){defer.reject(reason)}));break;case"deviceTypeRadio":var devTypeId=$scope.objSelectedDeviceType.ID;(-1===devTypeId?httpDeviceSrvc.getAllDevicesByPaging(-1,$scope.pageNumber,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,!0,$scope.sortField,$scope.sortOrder):httpDeviceSrvc.getDevicesByTypesByPaging(devTypeId,-1,$scope.pageNumber,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,!0,$scope.sortField,$scope.sortOrder)).then((function(resObj){resObj.deviceList.forEach((function(objDevice){devicesArray.push({name:objDevice.name,ID:objDevice.ID,mgmtIP:objDevice.mgmtIP,type:objDevice.subType,oid:objDevice.oid,vendor:objDevice.vendor,model:objDevice.model})}));defer.resolve(devicesArray)}),(function(reason){defer.reject(reason)}));break;default:defer.reject()}return defer.promise})().then((function(devices){if($scope.arrDestDevices&&0!=$scope.arrDestDevices.length)for(var i=0,len=devices.length;i<len;i++){var item=devices[i];_.find($scope.arrDestDevices,(function(srcDev){return item.ID===srcDev.ID}))||$scope.arrDestDevices.push(item)}else $scope.arrDestDevices=devices;$scope.selectedCount=$scope.arrDestDevices.length;$scope.gridOptions_addDevice_Dest.data=$scope.arrDestDevices}),(function(reason){}))};$scope.onRemoveAllFromDestGrid=function(){$scope.arrDestDevices=[];$scope.gridOptions_addDevice_Dest.data=$scope.arrDestDevices;$scope.selectedItems_Dest.length=0;$scope.selectedCount=$scope.arrDestDevices.length};$scope.lastSelectedDGId=null;$scope.onSelectDeviceGroup=function(node,trvw,isForceApply){if($scope.lastSelectedDGId!==node.ID||isForceApply){$scope.lastSelectedDGId=node.ID;$scope.selectedDeviceGroup=node;$scope.isDeviceGroupTreeShown=!1;$log.debug("selected device group : "+node.ID);$scope.clearDevices();$scope.lsDgIds=null;"0"===node.ID?$scope.lsDgIds=$scope.lsDGs_all.map((function(obj){return obj.ID})):"00"===node.ID?$scope.lsDgIds=$scope.lsDGs_shared.map((function(obj){return obj.ID})):"01"===node.ID?$scope.lsDgIds=$scope.lsDGs_private.map((function(obj){return obj.ID})):"02"===node.ID?$scope.lsDgIds=$scope.lsDGs_public.map((function(obj){return obj.ID})):"04"===node.ID?$scope.lsDgIds=$scope.lsDGs_policy.map((function(obj){return obj.ID})):$scope.lsDgIds=[node.ID];$scope.pageNumber=0;if($scope.lsDgIds&&!($scope.lsDgIds.length<=0)){var reqObj={guids:$scope.lsDgIds,pageNumber:$scope.pageNumber,pageSize:$scope.pageSize,filterField:["name","mgmtIP","model","vendor"],filterContent:$scope.srcDeviceFilterOptions.filterText,sortField:$scope.sortField,sortOrder:$scope.sortOrder,includeIntfDev:!0};httpDeviceGroupSrvc.getDevicesOfDeviceGroupIdsByPaging(reqObj).then((function(resObj){$scope.itemCount=resObj.count;var dictDevIdToName=resObj.dictIdDevice;for(var devId in dictDevIdToName){var objDevice=dictDevIdToName[devId];$scope.arrSrcDevices.push({name:objDevice.name,ID:objDevice.ID,mgmtIP:objDevice.mgmtIP,type:objDevice.subType,oid:objDevice.oid,vendor:objDevice.vendor,model:objDevice.model})}$scope.gridApiFromGrid.infiniteScroll.resetScroll(!1,!0)}),(function(){nbAlertSrvc.error("An error occurred while attempting to retrieve the devices for the selected device group.")}))}}else $scope.isDeviceGroupTreeShown=!1};$scope.ivhTreeOptionsGroup={defaultSelectedState:!1,validate:!1,expandToDepth:1,labelAttribute:"Name",idAttribute:"ID",childrenAttribute:"items",expandedAttribute:"expanded",selectedAttribute:"selected",enableMultipleSelect:!1,nodeClickCallback:$scope.onSelectDeviceGroup,labelTemplate:function(node){var deviceCnt=node.CntDevices?" ("+node.CntDevices+")":" (0)";return null!=node.HasInterface?node.Name+deviceCnt:node.Name},iconTemplate:function(node){return null!=node.HasInterface?node.HasInterface?'<div class="icon_nb_tree_linkgroup"></div>':'<div class="icon_nb_tree_devicegroup"></div>':'<div class="icon_nb_folder"></div>'}};$scope.fetch=httpSiteSrvc.getFullSiteTree;$scope.lastSelectedSiteId=null;$scope.onClickSite=function(node,trvw,isForceApply){if(void 0!==node.ID&&$scope.lastSelectedSiteId!==node.ID||isForceApply){$scope.lastSelectedSiteId=node.ID;$scope.selectedSite=node;node.selected=!0;node.isClicked=!0;$scope.isSiteTreeShown=!1;$scope.clearDevices();httpSiteSrvc.getSiteDevicesBySiteIDByPagingWithType(node.ID,4,$scope.pageNumber,$scope.pageSize,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,$scope.sortField,$scope.sortOrder).then((function(ret){var lsDevices=ret.memberList;$scope.itemCount=ret.count;lsDevices.forEach((function(siteObj){var devObj=siteObj.siteMember;$scope.arrSrcDevices.push({name:devObj.deviceName,ID:devObj.deviceId,type:siteObj.deviceType,oid:devObj.oid,mgmtIP:devObj.mgmtIP,vendor:devObj.vendor,model:devObj.model})}));$scope.gridApiFromGrid.infiniteScroll.resetScroll(!1,!0)}),(function(){nbAlertSrvc.error("An error occurred while attempting to retrieve the devices for the selected site: "+node.ID)}));!function setChildrenSelectStateInTree(node,childAlias){if(node[childAlias]&&node[childAlias].length>0)for(var i=0;i<node[childAlias].length;i++){var child=node[childAlias][i];child.isClicked=!1;setChildrenSelectStateInTree(child,childAlias)}}(node,"children")}else $scope.isSiteTreeShown=!1};self.ivhTreeOptions={defaultSelectedState:!1,validate:!1,expandToDepth:2,labelAttribute:"name",idAttribute:"ID",childrenAttribute:"children",expandedAttribute:"expanded",useCheckboxes:!1,twistieLeafTpl:""};$scope.lastSelectedDeviceSubtype=null;$scope.onSelectDeviceType=function(objDeviceID,objDeviceType,isForceApply){if($scope.lastSelectedDeviceSubtype!==objDeviceType.ID||isForceApply){$scope.lastSelectedDeviceSubtype=objDeviceType.ID;$scope.clearDevices();$scope.objSelectedDeviceType=objDeviceType;var devTypeId=$scope.objSelectedDeviceType.ID;(-1===devTypeId?httpDeviceSrvc.getAllDevicesByPaging($scope.pageSize,$scope.pageNumber,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,!0,$scope.sortField,$scope.sortOrder):httpDeviceSrvc.getDevicesByTypesByPaging(devTypeId,$scope.pageSize,$scope.pageNumber,["name","mgmtIP","model","vendor"],$scope.srcDeviceFilterOptions.filterText,!0,$scope.sortField,$scope.sortOrder)).then((function(resObj){var lsDevices=resObj.deviceList;$scope.itemCount=resObj.count;$scope.arrSrcDevices=[];lsDevices.forEach((function(objDevice){$scope.arrSrcDevices.push({name:objDevice.name,ID:objDevice.ID,mgmtIP:objDevice.mgmtIP,type:objDevice.subType,oid:objDevice.oid,vendor:objDevice.vendor,model:objDevice.model})}));$timeout((function(){$scope.gridOptions_addDevices_Src.data=$scope.arrSrcDevices;$scope.gridApiFromGrid.infiniteScroll.resetScroll(!1,!0)}))}),(function(){}))}};$scope.onOK=function(){var lsSelectedDevices=[].concat($scope.arrDestDevices);$scope.singleSelectionOnly&&(lsSelectedDevices=$scope.gridApiFromGrid.selection.getSelectedRows());$uibModalInstance.close(_.sortBy(lsSelectedDevices,"name"));$rootScope.$emit("onSelectDevicePopupClose")};$scope.onCancel=function(argStrReason){$uibModalInstance.dismiss(argStrReason);$rootScope.$emit("onSelectDevicePopupClose")};$scope.isDeviceGroupTreeShown=!1;$scope.onClickOutside_dgTree=function(){$scope.isDeviceGroupTreeShown&&($scope.isDeviceGroupTreeShown=!1)};$scope.isSiteTreeShown=!1;$scope.$watch("deviceSrcRange",(function(){if($scope.bInitDGComplete){$scope.clearDevices();$scope.pageNumber=0;$scope.sortOrder="asc";$scope.sortField="name";switch($scope.deviceSrcRange){case"deviceGroupRadio":$scope.dgTreeVal.items[0];$scope.onSelectDeviceGroup($scope.dgTreeVal,$scope.dgTreeVal,!0);break;case"siteRadio":$scope.selectedSite?$scope.onClickSite($scope.selectedSite,$scope.siteTreeVal,!0):$scope.onClickSite($scope.siteTreeVal,$scope.siteTreeVal,!1);break;case"deviceTypeRadio":if($scope.objSelectedDeviceType){$scope.objSelectedDeviceType.selected=!0;$scope.onSelectDeviceType($scope.objSelectedDeviceType.ID,$scope.objSelectedDeviceType,!0)}else{$scope.lsDeviceTypes[0].selected=!0;$scope.onSelectDeviceType($scope.lsDeviceTypes[0].ID,$scope.lsDeviceTypes[0],!0)}break;case"ansibleAgentRadio":$q.all([AnsibleExecutionSrvc.getAllAnsibleNode(),AnsibleExecutionSrvc.getAnsibleAgentDevices(curAnsibleAgentGUIDs,$scope.pageNumber,$scope.pageSize,$scope.sortField,$scope.sortOrder)]).then((function(result){$scope.ansibleAgentTreeData.ansibleNodes=result[0];parseAnsibleAgentDevicesData(result[1],!0)}),(function(){nbAlertSrvc.error("Error getting Ansible Agent info.")}))}}}));function sortChanged(grid,sortColumns){if(sortColumns.length>0){$scope.sortField=sortColumns[0].field;$scope.sortOrder=sortColumns[0].sort.direction;$scope.pageNumber=0;switch($scope.deviceSrcRange){case"deviceGroupRadio":$scope.onSelectDeviceGroup($scope.dgTreeVal,$scope.dgTreeVal,!0);break;case"siteRadio":"name"===$scope.sortField&&($scope.sortField="deviceName");$scope.selectedSite?$scope.onClickSite($scope.selectedSite,$scope.siteTreeVal,!0):$scope.onClickSite($scope.siteTreeVal,$scope.siteTreeVal,!1);break;case"deviceTypeRadio":if($scope.objSelectedDeviceType){$scope.objSelectedDeviceType.selected=!0;$scope.onSelectDeviceType($scope.objSelectedDeviceType.ID,$scope.objSelectedDeviceType,!0)}else{$scope.lsDeviceTypes[0].selected=!0;$scope.onSelectDeviceType($scope.lsDeviceTypes[0].ID,$scope.lsDeviceTypes[0],!0)}break;case"ansibleAgentRadio":AnsibleExecutionSrvc.getAnsibleAgentDevices(curAnsibleAgentGUIDs,$scope.pageNumber,$scope.pageSize,$scope.sortField,$scope.sortOrder).then((function(data){parseAnsibleAgentDevicesData(data,!0)}),(function(){nbAlertSrvc.error("Error getting Ansible Agent info.")}))}}}httpDeviceGroupSrvc.getDeviceGroupInfo().then((function(allGroups){$scope.lsDGs_all=allGroups;$scope.lsDGs_shared=getGroupsByType(0);$scope.lsDGs_private=getGroupsByType(1);$scope.lsDGs_public=getGroupsByType(2);$scope.lsDGs_policy=getGroupsByType(4);$scope.dgTreeVal={ID:"0",Name:"All",selected:!0,items:[{ID:"01",Name:"My Device Groups",items:$scope.lsDGs_private},{ID:"00",Name:"Public",items:$scope.lsDGs_shared},{ID:"04",Name:"Policy Device Group",items:$scope.lsDGs_policy},{ID:"02",Name:"System",items:$scope.lsDGs_public}]};void 0!==$scope.dgTreeVal.items[0].items&&null!==$scope.dgTreeVal.items[0].items&&0!==$scope.dgTreeVal.items[0].items.length||($scope.dgTreeVal.items[0].items=[]);void 0!==$scope.dgTreeVal.items[1].items&&null!==$scope.dgTreeVal.items[1].items&&0!==$scope.dgTreeVal.items[1].items.length||($scope.dgTreeVal.items[1].items=[]);void 0!==$scope.dgTreeVal.items[2].items&&null!==$scope.dgTreeVal.items[2].items&&0!==$scope.dgTreeVal.items[2].items.length||($scope.dgTreeVal.items[2].items=[]);void 0!==$scope.dgTreeVal.items[3].items&&null!==$scope.dgTreeVal.items[3].items&&0!==$scope.dgTreeVal.items[3].items.length||($scope.dgTreeVal.items[3].items=[]);$scope.dgTreeVal.items[0];$scope.selectedDeviceGroup=$scope.dgTreeVal;$scope.bInitDGComplete=!0}),(function(){nbAlertSrvc.error("Error getting device groups.")}));!function(){$scope.lsDeviceTypes=deviceTypeMgrSrvc.getAllDeviceTypesJsonByActions([$scope.deviceActionType]);$scope.lsDeviceTypes.sort((function(obj1,obj2){return obj1.typeName<obj2.typeName?-1:obj1.typeName>obj2.typeName?1:0}));$scope.lsDeviceTypes.unshift({ID:-1,typeName:"All Device Types"});$scope.objSelectedDeviceType=$scope.lsDeviceTypes[0];$scope.objSelectedDeviceType.selected=!0;$scope.onSelectDeviceType($scope.objSelectedDeviceType.ID,$scope.lsDeviceTypes[0],!0)}();$scope.testPrint=function(){$log.debug($scope.dgTreeVal)};$scope.onFilterData=function(event){if(38===event.which||40===event.which||13===event.which){event.preventDefault();$scope.srcDeviceFilterOptions.filterText=$scope.srcDeviceFilterOptions.searchKey;if($scope.srcDeviceFilterOptions.filterText||$scope.srcDeviceFilterOptions.filterText.length>0){$scope.initPaging();$scope.loadDeviceData();$scope.gridOptions_addDevices_Src.data=$scope.arrSrcDevices}}};$scope.clearFilter=function(){if(0===$scope.srcDeviceFilterOptions.searchKey.length){$scope.srcDeviceFilterOptions.searchKey="";$scope.srcDeviceFilterOptions.filterText="";$scope.initPaging();$scope.loadDeviceData();$scope.gridOptions_addDevices_Src.data=$scope.arrSrcDevices}};$scope.initPaging=function(){$scope.pageNumber=0;$scope.arrSrcDevices=[];$scope.gridOptions_addDevices_Src.data=$scope.arrSrcDevices};!function(){$scope.includeAnsibleAgent=NetBrain.includeAnsibleAgentInMoreDevices;if($scope.includeAnsibleAgent){$scope.ansibleAgentTreeOptions={labelAttribute:"name",childrenAttribute:"ansibleNodes",expandedAttribute:"expanded",nodeClickCallback:ansibleAgentNodeClickCallback,labelTemplate:ansibleAgentLabelTpl,iconTemplate:ansibleAgentIconTpl};$scope.ansibleAgentTreeData={ID:"_all_",name:"All",selected:!0}}}();function parseAnsibleAgentDevicesData(data,forceReset){$scope.itemCount=data.count;var devices=_.values(data.dictIdDevice);$scope.arrSrcDevices=forceReset?devices:$scope.arrSrcDevices.concat(devices);$scope.gridOptions_addDevices_Src.data=$scope.arrSrcDevices;forceReset&&$scope.gridApiFromGrid.infiniteScroll.resetScroll(!1,!0)}function ansibleAgentLabelTpl(node){return node.name}function ansibleAgentIconTpl(){return'<div class="icon_nb_folder"></div>'}function ansibleAgentNodeClickCallback(node){$scope.pageNumber=0;curAnsibleAgentGUIDs=node.id?[node.id]:[];AnsibleExecutionSrvc.getAnsibleAgentDevices(curAnsibleAgentGUIDs,$scope.pageNumber,$scope.pageSize).then((function(data){parseAnsibleAgentDevicesData(data,!0)}),(function(){nbAlertSrvc.error("Error getting devices from Ansible Agent")}))}}angular.module("nb.datamodel").filter("nbDeviceTypeFilter",["nb.systemmodel.deviceTypeMgrSrvc",function(deviceTypeMgrSrvc){return function(typeId){return deviceTypeMgrSrvc.getTypeNameByDevType(typeId)}}])}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.selectInterfacePopupCtrl",SelectInterfacePopupCtrl);SelectInterfacePopupCtrl.$inject=["$scope","$interval","$uibModalInstance","$sce","$log","ivhTreeviewMgr","nb.ng.callbackSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.netbrain.httpDeviceSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.systemmodel.deviceTypeMainMgrSrvc","nb.topo.httpTopoSrvc","nb.datamodel.httpSiteSrvc","nb.admin.internetCloudHttpSrvc","nb.common.nbAlertSrvc","nb.datamodel.linkGroupSrvc","nb.systemmodel.httpDeviceIconSrvc","resolveData"];function SelectInterfacePopupCtrl($scope,$interval,$uibModalInstance,$sce,$log,ivhTreeviewMgr,callbackSrvc,httpDeviceGroupSrvc,httpDeviceSrvc,deviceTypeMgrSrvc,deviceTypeMainMgrSrvc,httpTopoSrvc,httpSiteSrvc,internetCloudHttpSrvc,nbAlertSrvc,linkGroupSrvc,httpDeviceIconSrvc,resolveData){$scope.deviceSrcRange="deviceGroupRadio";$scope.multiSelect=!1;$scope.deviceInterfaceTree=[];$scope.filterDeviceInterfaceTree=[];$scope.nodeNumPerLoad=20;$scope.pageNumber=0;$scope.pageSize=20;$scope.deviceCount=Math.pow(2,53)-1;$scope.treeviewOptions={labelAttribute:"name",idAttribute:"ID",childrenAttribute:"children",selectedAttribute:"selected",expandedAttribute:"expended",expandToDepth:1,iconTemplate:function(node){return node.devId?'<img src="img/Interface.png"/>':'<img src="'+$scope.getDevTypeImg(node.subType,node.oid)+'" style="width:16px; height: 16px"/>'},nodeClickCallback:function(node,trvw){$scope.onSelectedInterface(node,trvw)}};$scope.objSelectedDeviceType=null;$scope.siteTreeVal={};$scope.lsDeviceTypes=deviceTypeMgrSrvc.getAllDeviceTypesJsonByActions([-1]);$scope.lsDeviceTypes.sort((function(obj1,obj2){return obj1.typeName<obj2.typeName?-1:obj1.typeName>obj2.typeName?1:0}));$scope.lsDeviceTypes.unshift({ID:-1,typeName:"All Device Types"});$scope.devTypeImgs={};$scope.getDevTypeImg=function(devType,oid){return httpDeviceIconSrvc.getIconStreamURIBy2Id(devType,oid)};$scope.selectedItems_Src=[];$scope.selectedItems_Dest=[];$scope.dgTreeVal={ID:"0",Name:"All",items:[{ID:"00",Name:"Public"},{ID:"01",Name:"My Device Groups"},{ID:"04",Name:"Policy Device Group"},{ID:"02",Name:"System"}]};$scope.lsDGs_shared=[];$scope.lsDGs_private=[];$scope.lsDGs_public=[];$scope.lsDGs_policy=[];$scope.lsDGs_all=[];$scope.fetch=httpSiteSrvc.getSiteTree;$scope.arrSrcDevices=[];$scope.arrDestDevices=[];$scope.arrSrcDevices_Backup=[];$scope.srcDeviceFilterOptions={filterText:""};$scope.gridHighlightCellContent=function(text,search){return search?text.replace(new RegExp(search,"gi"),'<span style="background-color: yellow;">$&</span>'):$sce.trustAsHtml(text)};$scope.gridOptions_addDevices_Src={data:"arrSrcDevices",enableRowSelection:!0,multiSelect:!0,selectedItems:$scope.selectedItems_Src,columnDefs:[{field:"name",displayName:"Device Name",cellTemplate:'<div class="ngCellText"><span ng-cell-text ng-bind-html="gridHighlightCellContent(row.getProperty(col.field), srcDeviceFilterOptions.filterText)"></span></div>'}],filterOptions:$scope.srcDeviceFilterOptions};$scope.gridOptions_addDevice_Dest={data:"arrDestDevices",enableRowSelection:!0,multiSelect:!0,selectedItems:$scope.selectedItems_Dest,columnDefs:[{field:"name",displayName:"Device Name"}]};$scope.clearDevices=function(){$scope.treeviewOptions.treeObj.scrollTop(0);$scope.deviceInterfaceTree=[];$scope.treeviewOptions.treeObj.removeAllNodes();$scope.filterDeviceInterfaceTree=[];$scope.selectedInterface=null;$scope.lastSelectedInterface=null;$scope.arrSrcDevices=[];$scope.deviceInterfaceTree=[];$scope.pageNumber=0;$scope.treeviewOptions.treeObj.clear();$scope.deviceCount=Math.pow(2,53)-1};$scope.onAddToDestGrid=function(){$scope.selectedItems_Src.forEach((function(item){$scope.arrDestDevices.push(item);for(var i=0;i<$scope.arrSrcDevices.length;i++)if($scope.arrSrcDevices[i].ID==item.ID){$scope.arrSrcDevices.splice(i,1);break}}));$scope.gridOptions_addDevices_Src.selectAll(!1);$scope.selectedItems_Src.length=0};$scope.onRemoveFromDestGrid=function(){$scope.selectedItems_Dest.forEach((function(item){$scope.arrSrcDevices.push(item);for(var i=0;i<$scope.arrDestDevices.length;i++)if($scope.arrDestDevices[i].ID==item.ID){$scope.arrDestDevices.splice(i,1);break}}));$scope.gridOptions_addDevice_Dest.selectAll(!1);$scope.selectedItems_Dest.length=0};$scope.onAddAllToDestGrid=function(){for(;$scope.arrSrcDevices.length>0;)$scope.arrDestDevices.push($scope.arrSrcDevices.pop());$scope.gridOptions_addDevices_Src.selectAll(!1);$scope.selectedItems_Src.length=0};$scope.onRemoveAllFromDestGrid=function(){for(;$scope.arrDestDevices.length>0;)$scope.arrSrcDevices.push($scope.arrDestDevices.pop());$scope.gridOptions_addDevice_Dest.selectAll(!1);$scope.selectedItems_Dest.length=0};$scope.lastSelectedDGId=null;$scope.onShowDeviceGroup=function(bVisible){$scope.isDeviceGroupTreeShown=bVisible;$scope.isDeviceGroupTreeShown&&setTimeout((function(){$scope.ivhTreeOptionsGroup.treeObj.selectNode($scope.selectedDeviceGroup.ID)}),0)};$scope.onSelectDeviceGroup=function(node,trvw){$scope.lastSelectedDGId=node.ID;$scope.selectedDeviceGroup=node;node.isClicked=!0;$log.debug("selected device group : "+node.ID);$scope.clearDevices();var lsDgIds=null;lsDgIds="0"==node.ID?$scope.lsDGs_all.map((function(obj){return obj.ID})):"00"==node.ID?$scope.lsDGs_shared.map((function(obj){return obj.ID})):"01"==node.ID?$scope.lsDGs_private.map((function(obj){return obj.ID})):"02"==node.ID?$scope.lsDGs_public.map((function(obj){return obj.ID})):"04"==node.ID?$scope.lsDGs_policy.map((function(obj){return obj.ID})):[node.ID];$scope.lsDgIds=lsDgIds;$scope.getDevicesForGroupWithPaging();!function setChildrenSelectStateInTree(node,childAlias){if(node[childAlias]&&node[childAlias].length>0)for(var i=0;i<node[childAlias].length;i++){var child=node[childAlias][i];child.isClicked=!1;setChildrenSelectStateInTree(child,childAlias)}}(node,"items");$scope.isDeviceGroupTreeShown=!1};$scope.getDevicesForGroupWithPaging=function(){if(!($scope.arrSrcDevices&&$scope.arrSrcDevices.length>=$scope.deviceCount)&&$scope.lsDgIds&&0!==$scope.lsDgIds.length){var req={guids:$scope.lsDgIds,sortField:"name",sortOrder:"asc",pageSize:$scope.pageSize,pageNumber:$scope.pageNumber,filterField:"name",filterContent:$scope.srcDeviceFilterOptions.filterText};httpDeviceGroupSrvc.getDeviceIdToNamesOfDeviceGroupIdsByPaging(req).then((function(result){$scope.pageNumber+=1;var dictDevIdToName=result.dictIdName;$scope.deviceCount=result.count;var arrDevIds=[];var destDevIds=[];destDevIds=_.pluck($scope.arrDestDevices,"ID");for(var devId in dictDevIdToName){arrDevIds.push(devId);-1==destDevIds.indexOf(devId)&&$scope.arrSrcDevices.push({name:dictDevIdToName[devId],ID:devId})}$scope.fillDeviceInterfaces(arrDevIds)}),(function(reason){$scope.fillDeviceInterfaces([]);$log.error(reason)}))}};$scope.ivhTreeOptionsGroup={defaultSelectedState:!1,validate:!0,expandToDepth:2,labelAttribute:"Name",idAttribute:"ID",childrenAttribute:"items",expandedAttribute:"expanded",selectedAttribute:"selected",enableMultipleSelect:!1,nodeClickCallback:$scope.onSelectDeviceGroup,iconTemplate:function(node){var nodeTemplate='<div class="icon_nb_folder"></div>';void 0===node.HasInterface||node.isMPLSCloud||node.isWAN||node.isDMVPN||(nodeTemplate=node.HasInterface?'<div class="icon_nb_tree_linkgroup"></div>':'<div class="icon_nb_tree_devicegroup"></div>');node.isWAN&&(nodeTemplate='<div class="icon_nb_tree_wan"></div>');node.isDMVPN&&(nodeTemplate='<div class="icon_nb_tree_dmvpn"></div>');node.isMPLSCloud&&(nodeTemplate='<div class="icon_nb_tree_mplscloud"></div>');return nodeTemplate}};$scope.lastSelectedSiteId=null;var timeout=null;$scope.onClickSite=function(node){timeout&&clearTimeout(timeout);$scope.isSiteTreeShown=!1;$scope.lastSelectedSiteId=node.ID;$scope.selectedSite=node;$scope.clearDevices();timeout=setTimeout((function(){$scope.getDevicesBySiteWithPaging()}),200)};$scope.getDevicesBySiteWithPaging=function(){if(!($scope.arrSrcDevices.length>0&&$scope.arrSrcDevices.length>=$scope.deviceCount)){httpSiteSrvc.getSiteDevicesBySiteIDByPaging($scope.selectedSite.ID,4,$scope.pageNumber,$scope.pageSize,["name"],$scope.srcDeviceFilterOptions.filterText).then((function(ret){$scope.pageNumber+=1;$scope.deviceCount=ret.count;if(!($scope.arrSrcDevices.length>=$scope.deviceCount)){var arrDevIds=[];var destDevIds=[];destDevIds=_.pluck($scope.arrDestDevices,"ID");var lsDevices=ret.memberList;if(!(ret.memberList&&ret.memberList.length<=0)){lsDevices.forEach((function(devObj){arrDevIds.push(devObj.deviceId);-1==destDevIds.indexOf(devObj.deviceId)&&$scope.arrSrcDevices.push({name:devObj.deviceName,ID:devObj.deviceId})}));$scope.fillDeviceInterfaces(arrDevIds)}}}),(function(reason){$log.debug(reason)}))}};$scope.lastSelectedDeviceSubtype=null;$scope.onSelectDeviceType=function(objDeviceType){$scope.lastSelectedDeviceSubtype=objDeviceType.ID;$scope.clearDevices();$scope.objSelectedDeviceType=objDeviceType;$scope.getDevicesByTypeWithPaging()};$scope.getDevicesByTypeWithPaging=function(){if(!($scope.arrSrcDevices&&$scope.arrSrcDevices.length>=$scope.deviceCount)){var devTypeId=$scope.objSelectedDeviceType.ID;("-1"==devTypeId?httpDeviceSrvc.getAllDevicesByPaging($scope.pageSize,$scope.pageNumber,"name",$scope.srcDeviceFilterOptions.filterText,!1):httpDeviceSrvc.getDevicesByTypesByPaging(devTypeId,$scope.pageSize,$scope.pageNumber,"name",$scope.srcDeviceFilterOptions.filterText,!1)).then((function(result){var arrDevIds=[];var destDevIds=[];var lsDevices=result.deviceList;if(lsDevices&&!(lsDevices.length<=0)){$scope.pageNumber+=1;$scope.deviceCount=result.count;destDevIds=_.pluck($scope.arrDestDevices,"ID");lsDevices.forEach((function(objDevice){arrDevIds.push(objDevice.ID);-1==destDevIds.indexOf(objDevice.ID)&&$scope.arrSrcDevices.push({name:objDevice.name,ID:objDevice.ID})}));$scope.fillDeviceInterfaces(arrDevIds)}}),(function(reason){$log.debug(reason);$scope.fillDeviceInterfaces([])}))}};$scope.fillDeviceInterfaces=function(arrDevIds){$scope.deviceIds=arrDevIds;$scope.loadMore()};$scope.loadInterface=function(node){httpTopoSrvc.getIPInterfacesByDeviceGuid(null,node.ID).then((function(lsSubInterfaces){var childrenList=lsSubInterfaces.map((function(subInterface){return{ID:subInterface.id,name:subInterface.name}}));node.children=childrenList;node.loaded=!0;$scope.deviceInterfaceTree.forEach((function(item){item.ID==node.ID&&(item.children=childrenList)}))}))};$scope.lastSelectedInterface=null;$scope.onSelectedInterface=function(node){if($scope.lastSelectedInterface!=node.ID){$scope.lastSelectedInterface=node.ID;$scope.selectedInterface=node}};$scope.clearFilter=function(){$scope.srcDeviceFilterOptions.filterText="";$scope.clearDevices();$scope.filterTreeData()};$scope.onFilter=function(){$scope.clearDevices();$scope.filterTreeData()};$scope.filterTreeData=function(){switch($scope.deviceSrcRange){case"deviceGroupRadio":$scope.getDevicesForGroupWithPaging();break;case"siteRadio":$scope.getDevicesBySiteWithPaging();break;case"deviceTypeRadio":$scope.getDevicesByTypeWithPaging()}$scope.filterDeviceInterfaceTree=$scope.deviceInterfaceTree;$scope.treeviewOptions.treeObj.updateTree()};$scope.onOKInner=function(){var lsSelectedInterfaces=[$scope.selectedInterface];var index=lsSelectedInterfaces[0].name.lastIndexOf(" ");if(-1!=index){var ifIp=lsSelectedInterfaces[0].name.substr(index+1).trim();if(-1!=(index=ifIp.indexOf("/"))){if(32==parseInt(ifIp.substr(index+1))){nbAlertSrvc.warning({message:"You cannot select a CE interface of which subnet mask is 32 bit. Please select another interface again."}).then((function(){}));return}}}$uibModalInstance.close(lsSelectedInterfaces)};$scope.onOK=function(){if(resolveData&&(resolveData.bUsedForInternetCloud||resolveData.bUsedForLinkGroup)){(!resolveData.fnCallback||resolveData.fnCallback($scope.selectedInterface))&&$uibModalInstance.close([$scope.selectedInterface])}else $scope.onOKInner()};$scope.onCancel=function(argStrReason){$uibModalInstance.dismiss(argStrReason)};$scope.isDeviceGroupTreeShown=!1;$scope.onClickOutside_dgTree=function(){$scope.isDeviceGroupTreeShown&&($scope.isDeviceGroupTreeShown=!1)};$scope.isSiteTreeShown=!1;$scope.onClickOutside_siteTree=function(){$scope.isSiteTreeShown&&($scope.isSiteTreeShown=!1)};$scope.$watch("deviceSrcRange",(function(){if($scope.bInitDGComplete){$scope.clearDevices();switch($scope.deviceSrcRange){case"deviceGroupRadio":var refSharedDeviceGroups=$scope.dgTreeVal.items[0];$scope.selectedDeviceGroup?$scope.onSelectDeviceGroup($scope.selectedDeviceGroup,$scope.dgTreeVal):$scope.onSelectDeviceGroup(refSharedDeviceGroups,$scope.dgTreeVal);break;case"siteRadio":$scope.selectedSite;break;case"deviceTypeRadio":$scope.objSelectedDeviceType?$scope.onSelectDeviceType($scope.objSelectedDeviceType):$scope.onSelectDeviceType($scope.lsDeviceTypes[0])}}}));httpDeviceGroupSrvc.getAllDeviceGroupByTypes([0],null).then((function(arrAllDGs_shared){$scope.lsDGs_shared=arrAllDGs_shared})).then((function(){httpDeviceGroupSrvc.getAllDeviceGroupByTypes([1],null).then((function(arrAllDGs_private){$scope.lsDGs_private=arrAllDGs_private})).then((function(){httpDeviceGroupSrvc.getAllDeviceGroupByTypes([2],null).then((function(arrAllDGs_public){$scope.lsDGs_public=arrAllDGs_public})).then((function(){httpDeviceGroupSrvc.getAllDeviceGroupByTypes([4],null).then((function(arrAllDGs_policy){$scope.lsDGs_policy=arrAllDGs_policy})).then((function(){$scope.lsDGs_all=$scope.lsDGs_shared.concat($scope.lsDGs_private.concat($scope.lsDGs_public));$scope.dgTreeVal={ID:"0",Name:"All",items:[{ID:"00",Name:"Public",items:$scope.lsDGs_shared},{ID:"01",Name:"My Device Groups",items:$scope.lsDGs_private},{ID:"04",Name:"Policy Device Group",items:$scope.lsDGs_policy},{ID:"02",Name:"System",items:$scope.lsDGs_public}]};null!=$scope.dgTreeVal.items[0].items&&null!=$scope.dgTreeVal.items[0].items&&0!=$scope.dgTreeVal.items[0].items.length||delete $scope.dgTreeVal.items[0].items;null!=$scope.dgTreeVal.items[1].items&&null!=$scope.dgTreeVal.items[1].items&&0!=$scope.dgTreeVal.items[1].items.length||delete $scope.dgTreeVal.items[1].items;null!=$scope.dgTreeVal.items[2].items&&null!=$scope.dgTreeVal.items[2].items&&0!=$scope.dgTreeVal.items[2].items.length||delete $scope.dgTreeVal.items[2].items;null!=$scope.dgTreeVal.items[3].items&&null!=$scope.dgTreeVal.items[3].items&&0!=$scope.dgTreeVal.items[3].items.length||delete $scope.dgTreeVal.items[3].items;$scope.onSelectDeviceGroup({ID:"0",Name:"All"},$scope.dgTreeVal);$scope.bInitDGComplete=!0;$scope.ivhTreeOptionsGroup.treeObj.updateTree()}))}))}))}));httpSiteSrvc.getPartialSiteTreeByLevels(3).then((function(lsAllSites){$scope.siteTreeVal={ID:lsAllSites[0].ID,name:lsAllSites[0].name,children:[{isDummyNode:!0}]};lsAllSites.splice(0,1);!function buildSiteTreeFromSiteList(refSiteTree){if(0!=lsAllSites.length){for(var i=0;i<lsAllSites.length;i++){var currSite=lsAllSites[i];if(currSite.parentId==refSiteTree.ID){refSiteTree.children&&1==refSiteTree.children.length&&refSiteTree.children[0].isDummyNode&&refSiteTree.children.splice(0,1);1==currSite.siteCategory&&(currSite.children=[{isDummyNode:!0}]);refSiteTree.children.push(currSite);lsAllSites.splice(i,1);i--;if(0==lsAllSites.length)return}}if(refSiteTree.children)for(var j=0;j<refSiteTree.children.length;j++)buildSiteTreeFromSiteList(refSiteTree.children[j])}}($scope.siteTreeVal)}));$scope.testPrint=function(){$log.debug($scope.dgTreeVal)};$scope.loadMore=function(){var loadDevIds=$scope.deviceIds;resolveData&&resolveData.bUsedForInternetCloud?loadDevIds.length&&internetCloudHttpSrvc.getInterfacesByDeviceIds(loadDevIds).then((function(data){if(null!=data&&data.length>0){data.forEach((function(eleDev){eleDev.children&&eleDev.children.forEach((function(eleIntf){eleIntf.devName=eleDev.name;eleIntf.ID||(eleIntf.ID=eleIntf.id)}))}));$scope.deviceInterfaceTree=$scope.deviceInterfaceTree.concat(data)}$scope.filterDeviceInterfaceTree=$scope.deviceInterfaceTree;$scope.treeviewOptions.treeObj.updateTree()})):resolveData&&resolveData.bUsedForLinkGroup?loadDevIds.length&&linkGroupSrvc.getInterfacesByDeviceIds(loadDevIds).then((function(data){if(null!=data&&data.length>0){data.forEach((function(eleDev){eleDev.children&&eleDev.children.forEach((function(eleIntf){eleIntf.ID||(eleIntf.ID=eleIntf.id);eleIntf.device=eleDev}))}));$scope.deviceInterfaceTree=$scope.deviceInterfaceTree.concat(data)}$scope.filterDeviceInterfaceTree=$scope.deviceInterfaceTree;$scope.treeviewOptions.treeObj.updateTree()})):httpTopoSrvc.getDeviceWithIPInterfaces(null,loadDevIds).then((function(data){null!=data&&data.length>0&&($scope.deviceInterfaceTree=$scope.deviceInterfaceTree.concat(data));$scope.filterDeviceInterfaceTree=$scope.deviceInterfaceTree;$scope.treeviewOptions.treeObj.updateTree()}))}}angular.module("nb.datamodel").directive("nbSelectInterfaceTreeScroller",(function(){return{restrict:"A",link:function(scope,elem){$(elem).find(".infinite-tree-scroll").on("scroll",(function(){var thisElem=$(elem).find(".infinite-tree-scroll")[0];var scrollHeight=thisElem.scrollHeight;var clientHeight=thisElem.clientHeight;var scrollTop=thisElem.scrollTop;Math.round(scrollHeight-scrollTop)===clientHeight&&0!=scrollTop&&scope.$parent.filterTreeData()}))}}}))}(NetBrain);!function(netBrain){angular.module("nb.datamodel").factory("nb.datamodel.httpDynamicSearchSrvc",HttpDynamicSearchSrvc);HttpDynamicSearchSrvc.$inject=["$http","$q","$timeout","$log","$location","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.ng.nbHttp"];function HttpDynamicSearchSrvc($http,$q,$timeout,$log,$location,utilitySrvc,httpAuthSrvc,nbHttp){return{calcDySearchDevice:function(dataSrc,dySearchObj){return function(dySearchObj,dataSrc){var defer=$q.defer();nbHttp.post("DataModel/calcDySearchDevice",dySearchObj).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(dySearchObj)}}}}(NetBrain);!function(NetBrain){angular.module("nb.datamodel").controller("nb.datamodel.deviceGroupPopupCtrl",DeviceGroupPopupCtrl);DeviceGroupPopupCtrl.$inject=["$scope","$rootScope","$uibModal","$uibModalInstance","$interval","$log","nb.datamodel.httpDeviceGroupSrvc","nb.netbrain.httpDeviceSrvc","nb.ng.callbackSrvc","nb.ng.userSrvc","args","nb.common.nbAlertSrvc"];function DeviceGroupPopupCtrl($scope,$rootScope,$uibModal,$uibModalInstance,$interval,$log,httpDeviceGroupSrvc,httpDeviceSrvc,callbackSrvc,userSrvc,args,nbAlertSrvc){$scope.isReadOnly=args.isReadOnly;$scope.isSharedDeviceGroup=!(!args.deviceGroup||0!=args.deviceGroup.Type);$scope.type=args.deviceGroup&&args.deviceGroup.Type?args.deviceGroup.Type:$scope.isSharedDeviceGroup?0:1;$scope.deviceGroupJsWrapper=new CDeviceGroupJsWrapper;var lsStaticDevicesInfo=args.lsStaticDevicesInfo&&args.lsStaticDevicesInfo.length>0?args.lsStaticDevicesInfo:null;$scope.isCreateNew=args.isCreateNew;$scope.isCreateNew&&($scope.userGuid=userSrvc.getUserID());$scope.ID=args.deviceGroup&&args.deviceGroup.ID?args.deviceGroup.ID:null;$scope.name=args.deviceGroup&&args.deviceGroup.Name?args.deviceGroup.Name:"";$scope.description="";$scope.deviceList=[];$scope.nameValidationOption={method:"watch",rules:[{ruleId:"required",errorMessage:"Device group name can not be empty."},{ruleId:"maxLength",params:{length:128},errorMessage:"Input should be less than 128 characters."}]};$scope.alertMsg={specialCharacter:"A device group name can't contain any of the following characters:</br>                         "+NetBrain.NG.Const.valiteFileNameRegTip};$scope.jsonDynamicSearch={RangeOption:0};callbackSrvc.registerCallback("nb.datamodel.deviceGroupPopupCtrl.jsonDynamicSearch",$scope.jsonDynamicSearch);$scope.$on("$destroy",(function(){callbackSrvc.unRegisterCallback("nb.datamodel.dgDevGridCtrl.jsonDynamicSearch")}));callbackSrvc.registerCallback("nb.datamodel.deviceGroupPopupCtrl.deviceGroupJsWrapper",$scope.deviceGroupJsWrapper);$scope.$on("$destroy",(function(){callbackSrvc.unRegisterCallback("nb.datamodel.deviceGroupPopupCtrl.deviceGroupJsWrapper")}));$scope.onChangeToSharedDeviceGroup=function(){$scope.type=$scope.isSharedDeviceGroup?0:1};$scope.initCurrentDG=function(argDeviceGroupJs,lsStaticDevicesInfo){var initUI=function(){$scope.userGuid=$scope.deviceGroupJsWrapper.getUserGuid();$scope.description=$scope.deviceGroupJsWrapper.getDescription();null!=$scope.deviceGroupJsWrapper.getRangeOption()&&($scope.jsonDynamicSearch.RangeOption=$scope.deviceGroupJsWrapper.getRangeOption());null!=$scope.deviceGroupJsWrapper.getDeviceGroupRange()&&($scope.jsonDynamicSearch.DeviceGroupRange=$scope.deviceGroupJsWrapper.getDeviceGroupRange());null!=$scope.deviceGroupJsWrapper.getSiteRange()&&($scope.jsonDynamicSearch.SiteRange=$scope.deviceGroupJsWrapper.getSiteRange());null!=$scope.deviceGroupJsWrapper.getFilter()&&($scope.jsonDynamicSearch.Filter=$scope.deviceGroupJsWrapper.getFilter());callbackSrvc.getCallback("nb.datamodel.dgDevGridCtrl.initGrid")($scope.ID)};var addStaticDevicesInterval=null;var stopInterval=function(){if(addStaticDevicesInterval){$interval.cancel(addStaticDevicesInterval);addStaticDevicesInterval=void 0}};if(argDeviceGroupJs||lsStaticDevicesInfo)if(argDeviceGroupJs&&!lsStaticDevicesInfo){$scope.deviceGroupJsWrapper.fromJson(argDeviceGroupJs);httpDeviceSrvc.getSimpleDevicesByGuids(null,$scope.deviceGroupJsWrapper.getStaticDevices()).then((function(data){if(null!=data&&data.length>0){data.forEach((function(item){item.hostName=item.name;item.guid=item.ID}));addStaticDevicesInterval=$interval((function(){var callback_onAddStaticDevices=callbackSrvc.getCallback("nb.datamodel.dgDevGridCtrl.onAddStaticDevices");if(callback_onAddStaticDevices){callback_onAddStaticDevices(data);stopInterval();initUI()}}),10)}}))}else{var lsStaticDevIds=lsStaticDevicesInfo.map((function(devInfo){return devInfo.guid}));$scope.deviceGroupJsWrapper.setStaticDevices(lsStaticDevIds);addStaticDevicesInterval=$interval((function(){var callback_onAddStaticDevices=callbackSrvc.getCallback("nb.datamodel.dgDevGridCtrl.onAddStaticDevices");if(callback_onAddStaticDevices){callback_onAddStaticDevices(lsStaticDevicesInfo);stopInterval();initUI()}}),10)}else httpDeviceGroupSrvc.getDeviceGroupByGuid_no_devices($scope.ID,null).then((function(jsDeviceGroup){$scope.deviceGroupJsWrapper.fromJson(jsDeviceGroup)})).then((function(){initUI()}))};$scope.isCreateNew?(args.deviceGroup||lsStaticDevicesInfo)&&(lsStaticDevicesInfo?$scope.initCurrentDG(null,lsStaticDevicesInfo,!0):$scope.initCurrentDG(args.deviceGroup)):$scope.initCurrentDG();$scope.addStaticDevices=function(){$scope.selectDeviceModal=$uibModal.open({templateUrl:"modules/nbDataModel/common/views/selectDevicePopup.html",controller:"nb.datamodel.selectDevicePopupCtrl",windowClass:"selectDevicePopup",backdrop:"static",resolve:{singleSelectionOnly:function(){return!1},initDevices:function(){return[]}}}).result.then((function(lsSelectedDevices){$scope.initDevices=lsSelectedDevices;var devices=_.map(lsSelectedDevices,(function(item){return{hostName:item.name,guid:item.ID,vendor:item.vendor,model:item.model,mgmtIP:item.mgmtIP}}));var callback_onAddStaticDevices=callbackSrvc.getCallback("nb.datamodel.dgDevGridCtrl.onAddStaticDevices");callback_onAddStaticDevices&&callback_onAddStaticDevices(devices)}))};$scope.onOK=function(){if($scope.isReadOnly)$scope.onCloseDeviceGroupPopup();else{if(NetBrain.NG.Const.valiteFileNameReg.test($scope.name))return nbAlertSrvc.warnning($scope.alertMsg.specialCharacter);$scope.deviceGroupJsWrapper.setName($scope.name);$scope.deviceGroupJsWrapper.setDescription($scope.description);$scope.deviceGroupJsWrapper.setUserGuid($scope.userGuid);$scope.deviceGroupJsWrapper.setType($scope.type);$scope.deviceGroupJsWrapper.setRangeOption($scope.jsonDynamicSearch.RangeOption);1==$scope.jsonDynamicSearch.RangeOption&&$scope.deviceGroupJsWrapper.setDeviceGroupRange($scope.jsonDynamicSearch.DeviceGroupRange);2==$scope.jsonDynamicSearch.RangeOption&&$scope.deviceGroupJsWrapper.setSiteRange($scope.jsonDynamicSearch.SiteRange);$scope.deviceGroupJsWrapper.setFilter($scope.jsonDynamicSearch.Filter);var addedDevices=callbackSrvc.getCallback("nb.datamodel.dgDevGridCtrl.addedDevices");var removedDevices=callbackSrvc.getCallback("nb.datamodel.dgDevGridCtrl.removedDevices");var lsAddedStaticDevIds=addedDevices.static.map((function(devObj){return devObj.ID}));var lsDeletedStaticDevIds=removedDevices.static.map((function(devObj){return devObj.ID}));var lsAddedDynamicDevIds=addedDevices.dynamic.map((function(devObj){return devObj.ID}));var lsDeletedDynamicDevIds=removedDevices.dynamic.map((function(devObj){return devObj.ID}));httpDeviceGroupSrvc.upInsertDeviceGroup($scope.isCreateNew||null==$scope.deviceGroupJsWrapper.getGuid()||null==$scope.deviceGroupJsWrapper.getGuid(),$scope.deviceGroupJsWrapper.toJson(),lsAddedStaticDevIds,lsDeletedStaticDevIds,lsAddedDynamicDevIds,lsDeletedDynamicDevIds).then((function(re){if(re.result){var ID=re.deviceGroupGuid;$scope.onCloseDeviceGroupPopup("Device Group Update Succeed.");var resultArg={ID:ID,isCreateNew:$scope.isCreateNew};$rootScope.$emit(deviceBrowserEvent.deviceGroupUpdated,resultArg)}else{var dialogOptions_error={message:re.errorMsg};nbAlertSrvc.error(dialogOptions_error)}}),(function(reason){var dialogOptions_error={message:"Error occurs when updating device group.<br>"+reason.ResultDesc.split("{",1)};nbAlertSrvc.error(dialogOptions_error)}))}};$scope.onCloseDeviceGroupPopup=function(argCloseReason){$uibModalInstance.close(null!==argCloseReason?argCloseReason:"Cancel Button Clicked!")}}}(NetBrain);!function(NetBrain){angular.module("nb.datamodel").controller("nb.datamodel.dgDevGridCtrl",DgDevGridCtrl);DgDevGridCtrl.$inject=["$scope","$q","$rootScope","$log","$uibModal","$upload","uiGridConstants","nb.ng.callbackSrvc","nb.netbrain.httpDeviceSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.common.nbAlertSrvc"];function DgDevGridCtrl($scope,$q,$rootScope,$log,$uibModal,$upload,uiGridConstants,callbackSrvc,httpDeviceSrvc,httpDeviceGroupSrvc,nbAlertSrvc){$scope.selectedItems=[];$scope.myData=[];$scope.isReadOnly=$scope.$parent.isReadOnly;var _isLoading=!1;var _isAllLoaded=!1;var _pageNumber=0;$scope.ID="";$scope.addedDevices={static:[],dynamic:[]};$scope.removedDevices={static:[],dynamic:[]};callbackSrvc.registerCallback("nb.datamodel.dgDevGridCtrl.addedDevices",$scope.addedDevices);$scope.$on("$destroy",(function(){callbackSrvc.unRegisterCallback("nb.datamodel.dgDevGridCtrl.addedDevices")}));callbackSrvc.registerCallback("nb.datamodel.dgDevGridCtrl.removedDevices",$scope.removedDevices);$scope.$on("$destroy",(function(){callbackSrvc.unRegisterCallback("nb.datamodel.dgDevGridCtrl.removedDevices");callbackSrvc.unRegisterCallback("nb.datamodel.dgDevGridCtrl.lsDevObjs_dySearch",$scope.lsDevObjs_dySearch)}));$scope.deviceFilterText="";$scope.filterDevices=function(){$scope.gridApi.grid.refresh()};$scope.encodefilterText=function(filterText){filterText=filterText.replace("\\","\\\\");["$","(",")","*","+",".","[","]","?","^","{","}","|"].forEach((function(item){filterText=filterText.replace(item,"\\"+item)}));return filterText};$scope.deviceFilter=function(renderableRows){var encodeFilterText=$scope.encodefilterText($scope.deviceFilterText);var matcher=new RegExp(encodeFilterText,"i");$scope.filter(renderableRows,["name","vendor","model","mgmtIP","type"],matcher);return renderableRows};$scope.filter=function(renderableRows,columns,matcher){renderableRows.forEach((function(row){var match=!1;columns.forEach((function(field){var content=row.entity[field];content&&content.match(matcher)&&(match=!0)}));match||(row.visible=!1)}))};var deviceGridCellTemplateWithFilter='<div class="ui-grid-cell-contents" title="TOOLTIP" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.deviceFilterText"></div>';$scope.gridOptions_devices={data:$scope.myData,enableRowSelection:!0,enableRowHeaderSelection:!1,multiSelect:!0,modifierKeysToMultiSelect:!0,enableSorting:!1,enableColumnMenus:!1,infiniteScrollRowsFromEnd:3,infiniteScrollDown:!0,enableVerticalScrollbar:uiGridConstants.scrollbars.ALWAYS,columnDefs:[{field:"name",displayName:"Hostname",cellTemplate:deviceGridCellTemplateWithFilter},{field:"vendor",displayName:"Vendor",cellTemplate:deviceGridCellTemplateWithFilter},{field:"model",displayName:"Model",cellTemplate:deviceGridCellTemplateWithFilter},{field:"mgmtIP",displayName:"Management IP",cellTemplate:deviceGridCellTemplateWithFilter},{field:"type",displayName:"Type",cellTemplate:deviceGridCellTemplateWithFilter}]};$scope.$watch((function(){return $scope.myData?$scope.myData.length:0}),(function(newVal,oldVal){$scope.showDeleteButton=newVal>0}));$scope.gridOptions_devices.onRegisterApi=function(gridApi){gridApi.infiniteScroll.on.needLoadMoreData($scope,$scope.scrollToBottom);gridApi.grid.registerRowsProcessor($scope.deviceFilter,200);$scope.gridApi=gridApi};$scope.initGrid=function(argDGId){if(!_isAllLoaded){$scope.ID=argDGId;$scope.ID&&$scope.getMoreData()}};callbackSrvc.registerCallback("nb.datamodel.dgDevGridCtrl.initGrid",$scope.initGrid);$scope.$on("$destroy",(function(){callbackSrvc.unRegisterCallback("nb.datamodel.dgDevGridCtrl.initGrid")}));$scope.scrollToBottom=function(){_isLoading||_isAllLoaded||$scope.getMoreData()};$scope.createDevsObj=function(arr){var oldDevsObj={};arr.forEach((function(item){oldDevsObj[item.type+item.name]=item.type+item.name}));return oldDevsObj};$scope.createObj=function(arr){var oldDevsObj={};arr.forEach((function(item){oldDevsObj[item]=item}));return oldDevsObj};$scope.getMoreData=function(){var deferred=$q.defer();_isLoading=!0;httpDeviceGroupSrvc.getDevicesOfDeviceGroupByCondition(null,$scope.ID,100,_pageNumber,"name","ASC",null,null).then((function(lsDevs){0==lsDevs.length&&(_isAllLoaded=!0);var staticDevObj=$scope.createDevsObj($scope.addedDevices.static);var dyDevObj=$scope.createDevsObj($scope.addedDevices.dynamic);lsDevs.forEach((function(devObj){var key=devObj.type+devObj.name;if("static"==devObj.type&&staticDevObj[key]||"dynamic"==devObj.type&&dyDevObj[key]){removeDevFromList(devObj,$scope.myData);$scope.myData.push(devObj)}else{if(staticDevObj[key]||dyDevObj[key])return;$scope.myData.push(devObj)}}));$scope.gridOptions_devices.data=$scope.myData;$scope.gridApi.infiniteScroll.dataLoaded().then((function(){deferred.resolve()}))}),(function(reason){$scope.gridApi.infiniteScroll.dataLoaded();deferred.reject(reason);$log.error("API Rejected")})).then((function(){_isLoading=!1;_pageNumber++}));return deferred.promise};var addDySearchDeviceToGrid=$scope.$on(dySearchEvent.addDyDevsToDG,(function(event,lsDevs,refDySearchJson){callbackSrvc.registerCallback("nb.datamodel.dgDevGridCtrl.lsDevObjs_dySearch",lsDevs);$scope.jsonDynamicSearch={RangeOption:0};callbackSrvc.registerCallback("nb.datamodel.deviceGroupPopupCtrl.jsonDynamicSearch",refDySearchJson);var dyDevsObj=$scope.createDevsObj($scope.addedDevices.dynamic);var removeDyDevsObj=$scope.createDevsObj($scope.removedDevices.dynamic);var totalCount=$scope.myData.length;for(var i=0;i<totalCount;i++)if("dynamic"==$scope.myData[i].type){$scope.recordDeviceChange($scope.myData[i],"remove",dyDevsObj,removeDyDevsObj);$scope.myData.splice(i,1);totalCount--;i--}var lsOldDevs=angular.copy($scope.myData);var lsNewDevs=[];var newOldDevsObj=$scope.createDevsObj($scope.myData);var newDyDevsObj=$scope.createDevsObj($scope.addedDevices.dynamic);var newRemoveDyDevsObj=$scope.createDevsObj($scope.removedDevices.dynamic);lsDevs&&lsDevs.forEach((function(devObj){var currDev={name:devObj.name,ID:devObj.ID,type:"dynamic",mgmtIP:null==devObj.mgmtIP?"":devObj.mgmtIP,model:null==devObj.model?"":devObj.model,vendor:null==devObj.vendor?"":devObj.vendor};if(!newOldDevsObj[currDev.type+currDev.name]){lsNewDevs.push(currDev);$scope.recordDeviceChange(currDev,"add",newDyDevsObj,newRemoveDyDevsObj)}}));$scope.myData=lsNewDevs.concat(lsOldDevs);$scope.gridOptions_devices.data=$scope.myData;var refJsonDynamicSearch=callbackSrvc.getCallback("nb.datamodel.deviceGroupPopupCtrl.jsonDynamicSearch");if(refJsonDynamicSearch){var nRangeId=refDySearchJson.RangeOption;refJsonDynamicSearch.RangeOption=nRangeId;refJsonDynamicSearch.Filter=refDySearchJson.Filter;switch(nRangeId){case 0:break;case 1:var lsDGRange=refDySearchJson.DeviceGroupRange;refJsonDynamicSearch.DeviceGroupRange=lsDGRange;break;case 2:var lsSiteRange=refDySearchJson.SiteRange;refJsonDynamicSearch.SiteRange=lsSiteRange}}}));$rootScope.$on("destroy",addDySearchDeviceToGrid);$scope.selectDeviceTitle="Select Device";$scope.onAddStaticDevices=function(devices){var lsOldDevs=angular.copy($scope.myData);var lsNewDevs=[];var oldDevsObj=$scope.createDevsObj($scope.myData);var staticDevsObj=$scope.createDevsObj($scope.addedDevices.static);var staticRemoveDevsObj=$scope.createDevsObj($scope.removedDevices.static);devices.forEach((function(devObj){var currDev={name:devObj.hostName,ID:devObj.guid,type:"static",vendor:devObj.vendor,model:devObj.model,mgmtIP:devObj.mgmtIP};var key=currDev.type+currDev.name;if(!oldDevsObj[key]&&!staticDevsObj[key]){lsNewDevs.push(currDev);$scope.recordDeviceChange(currDev,"add",staticDevsObj,staticRemoveDevsObj)}}));$scope.myData=lsNewDevs.concat(lsOldDevs);$scope.gridOptions_devices.data=$scope.myData};callbackSrvc.registerCallback("nb.datamodel.dgDevGridCtrl.onAddStaticDevices",$scope.onAddStaticDevices);$scope.$on("$destroy",(function(){callbackSrvc.unRegisterCallback("nb.datamodel.dgDevGridCtrl.onAddStaticDevices")}));$scope.onAddStaticDevices_cancel=function(reason){};$scope.onDeleteSelectedDevice=function(){var staticDevsObj=$scope.createDevsObj($scope.addedDevices.static);var staticRemoveDevsObj=$scope.createDevsObj($scope.removedDevices.static);var lsSelectedItems=$scope.gridApi.selection.getSelectedRows();var bHasDySearchDevices=!1;for(var i=0;i<lsSelectedItems.length;i++)if("dynamic"!=lsSelectedItems[i].type){$scope.recordDeviceChange(lsSelectedItems[i],"remove",staticDevsObj,staticRemoveDevsObj);for(var j=$scope.myData.length-1;j>=0;j--)if($scope.myData[j].ID===lsSelectedItems[i].ID&&$scope.myData[j].type===lsSelectedItems[i].type){$scope.myData.splice(j,1);break}}else bHasDySearchDevices=!0;$scope.myData.length<20&&2*lsSelectedItems.length>=100&&$scope.getMoreData();if(bHasDySearchDevices){nbAlertSrvc.warning({message:"Devices from dynamic search can not be deleted. Only static devices can be deleted."})}lsSelectedItems.length=0};$scope.onExportToCsv=function(){var fileName=$scope.name&&$scope.name.length>0?$scope.name:"Unnamed Device Group";httpDeviceGroupSrvc.exportDevicesOfDeviceGroupByCondition($scope.ID,9999999,0,"type","DESC","","",fileName).then((function(){}))};$scope.onImportCsv=function(){document.getElementById("csvFileUpload").value=null;document.getElementById("csvFileUpload").click()};String.prototype.startWith=function(str){return!(null==str||""==str||0==this.length||str.length>this.length)&&this.substr(0,str.length)==str};$scope.onUpload=function(files){if(function(){var isCompatible=!1;window.File&&window.FileReader&&window.FileList&&window.Blob&&(isCompatible=!0);return isCompatible}()){!function(file,callBack){var _dataSrc={TenantGuid:$rootScope.selectedTenantId,DomainGuid:$rootScope.selectedDomainIds};$scope.upload=$upload.upload({url:NetBrain.NG.ConfigSettings.API_ROOT+"api/Common/readExcel",method:"POST",file:file,headers:{TenantGuid:_dataSrc.TenantGuid,DomainGuid:_dataSrc.DomainGuid},data:{fileName:file.name}}).success((function(data,status,headers,config){callBack(data)})).error((function(data,status,headers,config){nbAlertSrvc.alert("Excel failure analysis.")}))}(files[0],callback)}else nbAlertSrvc.alert("The File APIs are not fully supported in this browser!")};function callback(data){var unqFileData=function(arr){var r=[],obj={};var temp=[];var l=arr.length;for(var i=0;i<l;i++){var key=arr[i].col0;if(obj[key])r.splice(temp[key],1,arr[i]);else{obj[key]=key;temp[key]=i;r.push(arr[i])}}return r}(data.heads);var fileData=[];var V7title=["Device","IP","Dynamic String","Vendor","Model"].toString();var V6title=["Device","IP","Dynamic String"].toString();unqFileData.forEach((function(item){var value=_.values(item);value.toString()!==V7title&&value.toString()!==V6title&&""!==item.col0&&fileData.push(item)}));$scope.refDySearchJsonFromDB=callbackSrvc.getCallback("nb.datamodel.deviceGroupPopupCtrl.jsonDynamicSearch");var dyString=unqFileData[1].col2;if(dyString){dyString.startWith("<?xml")?httpDeviceGroupSrvc.parserDySearchFromXMLToJson(dyString).then((function(dyJson){void 0!==dyJson.filter&&($scope.refDySearchJsonFromDB.Filter=dyJson.filter);void 0!==dyJson.rangeOption&&($scope.refDySearchJsonFromDB.RangeOption=dyJson.rangeOption);void 0!==dyJson.deviceGroupRange&&($scope.refDySearchJsonFromDB.DeviceGroupRange=dyJson.deviceGroupRange)})):$scope.refDySearchJsonFromDB.Filter=JSON.parse(dyString)}var notification=function(tempDevs){var messageObj={message:tempDevs.length+" devices have been imported."};nbAlertSrvc.notification(messageObj)};var succeeedCallBack=function(devicesInCurrentDomian,oldDevsObj,tempDevs,staticDevsObj,staticRemoveDevsObj,lsOldDevs,isEdit){devicesInCurrentDomian.forEach((function(item){var currDev={name:item.name,ID:item.ID,type:"static",vendor:item.vendor,model:item.model,mgmtIP:item.mgmtIP};var key=currDev.type+currDev.name;isEdit&&(key=currDev.ID);if(!oldDevsObj[key]){tempDevs.push(currDev);$scope.recordDeviceChange(currDev,"add",staticDevsObj,staticRemoveDevsObj)}}));$scope.myData=tempDevs.concat(lsOldDevs);$scope.gridOptions_devices.data=$scope.myData;notification(tempDevs)};if(fileData.length>0){var lsOldDevs=angular.copy($scope.myData);var staticDevsObj=$scope.createDevsObj($scope.addedDevices.static);var staticRemoveDevsObj=$scope.createDevsObj($scope.removedDevices.static);var lsNewDevs=[];fileData.forEach((function(devObj){var currDev={name:devObj.col0,ID:"",mgmtIP:devObj.col1,vendor:devObj.col3,model:devObj.col4,type:"static"};lsNewDevs.push(currDev)}));httpDeviceSrvc.getSimpleDevicesByDeviceNames(null,lsNewDevs.map((function(devObj){return devObj.name}))).then((function(devicesInCurrentDomian){var tempDevs=[];if(devicesInCurrentDomian&&devicesInCurrentDomian.length>0)if(""===$scope.ID){var oldDevsObj=$scope.createDevsObj(lsOldDevs);succeeedCallBack(devicesInCurrentDomian,oldDevsObj,tempDevs,staticDevsObj,staticRemoveDevsObj,lsOldDevs)}else(argDeviceGroupGuid=$scope.ID,httpDeviceGroupSrvc.getDeviceGroupByGuid(null,argDeviceGroupGuid)).then((function(oldData){var lsServerOldDevs=oldData.StaticDevices;var oldDevsObj=$scope.createObj(lsServerOldDevs);succeeedCallBack(devicesInCurrentDomian,oldDevsObj,tempDevs,staticDevsObj,staticRemoveDevsObj,lsOldDevs,!0)}));else notification(tempDevs);var argDeviceGroupGuid}))}else nbAlertSrvc.notification("Please select data to import.")}$scope.addTypesList=[{name:"Dynamic Search"},{name:"Add Devices"}];$scope.firstLoad=!0;$scope.addType={name:"Choose Add Devices Type"};$scope.addTypeClick=function(arg){if("Dynamic Search"==arg.name){$scope.addType={name:"Dynamic Search"};$scope.popDynamicSearch()}else{$scope.addType={name:"Add Devices"};$scope.addStaticDevices()}};$scope.popDynamicSearch=function(){$uibModal.open({templateUrl:"modules/nbDataModel/deviceGroup/editor/views/dynamicSearchPopup.html",controller:"nb.datamodel.dynamicSearchPopupCtrl",windowClass:"dynamicSearchPopup",backdrop:"static",resolve:{args:function(){return{parentScope:$scope}}}})};$scope.$on(dySearchEvent.closeDySearch,(function(){$scope.addType={name:"Choose Add Devices Type"}}));$rootScope.$on("onSelectDevicePopupClose",(function(){$scope.addType={name:"Choose Add Devices Type"}}));$scope.recordDeviceChange=function(devObj,argOperator,dyDevsObj,removeDyDevsObj){var key=devObj.type+devObj.name;if(argOperator.toLowerCase().indexOf("add")>=0){removeDyDevsObj&&removeDyDevsObj[key]&&removeDevFromList(devObj,$scope.removedDevices[devObj.type]);if(dyDevsObj[key])return;$scope.addedDevices[devObj.type].push(devObj)}else if(argOperator.toLowerCase().indexOf("remove")>=0||argOperator.toLowerCase().indexOf("delete")>=0){dyDevsObj[key]&&removeDevFromList(devObj,$scope.addedDevices[devObj.type]);if(removeDyDevsObj&&removeDyDevsObj[key])return;$scope.removedDevices[devObj.type].push(devObj)}else $log.error("Error param!")};var removeDevFromList=function(devObj,lsDevObjs){for(var i=0;i<lsDevObjs.length;i++)if(devObj.name==lsDevObjs[i].name&&devObj.type.toLowerCase()==lsDevObjs[i].type.toLowerCase()){lsDevObjs.splice(i,1);return}}}}(NetBrain);!function(NetBrain){angular.module("nb.datamodel").controller("nb.datamodel.dynamicSearchPopupCtrl",DynamicSearchPopupCtrl);DynamicSearchPopupCtrl.$inject=["$scope","$rootScope","$uibModalInstance","$log","uiGridConstants","nb.datamodel.httpDynamicSearchSrvc","nb.ng.errorHandleSrvc","nb.systemmodel.deviceSchemaMgrSrvc","nb.ng.callbackSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.common.nbAlertSrvc","args"];function DynamicSearchPopupCtrl($scope,$rootScope,$uibModalInstance,$log,uiGridConstants,httpDynamicSearchSrvc,errorHandleSrvc,deviceSchemaMgrSrvc,callbackSrvc,httpDeviceGroupSrvc,nbAlertSrvc,args){var separator="-----=====-----=====";$scope.preCriteria={Count:1e4,criteriaList:[],expr:"",searchScope:0,searchScopeArgs:[],searchScopeVals:[],getCurrentCriteria:function(){}};$scope.triggerSearchRequestKey="nb.deviceGroup.advancedSearch.triggerSearchRequestDeviceGroup1Key";$scope.triggerSearchResultKey="nb.deviceGroup.advancedSearch.triggerSearchResultDeviceGroup1Key";$scope.lsCandidateSchemas=[];$scope.deviceActionType=[-2];$scope.initConditionCriterias=function(){var lsSchemaObjs=deviceSchemaMgrSrvc.getDevPropObjs_dySearch();lsSchemaObjs.sort((function(o1,o2){return null==o1.getDisplayOrder()?1:null==o2.getDisplayOrder()?-1:o1.getDisplayOrder()-o2.getDisplayOrder()}));var lsDevProps_dySearch=[];lsSchemaObjs.forEach((function(obj){lsDevProps_dySearch.push({schemaId:obj.getID(),displayName:obj.getDisplayName(),type:obj.getType()})}));for(var i=0;i<lsDevProps_dySearch.length;i++)if("subType"==lsDevProps_dySearch[i].schemaId){lsDevProps_dySearch.splice(i,1);break}$scope.lsCandidateSchemas.push({schemaId:"subType",displayName:"Device Type",type:"int"});$scope.lsCandidateSchemas.push({schemaId:"intfs.ips.ip",displayName:"Interface IP",type:"int"});$scope.lsCandidateSchemas.push({schemaId:"_config",displayName:"Config File",type:"string"});$scope.lsCandidateSchemas=$scope.lsCandidateSchemas.concat(lsDevProps_dySearch)};$scope.initConditionCriterias();$scope.refDySearchJsonFromDB=callbackSrvc.getCallback("nb.datamodel.deviceGroupPopupCtrl.jsonDynamicSearch");$scope.refDySearchJsonFromDB_backup=angular.copy($scope.refDySearchJsonFromDB);!function(filter,preCriteria){preCriteria.criteriaList=[];preCriteria.searchScopeArgs=[];preCriteria.searchScopeVals=[];preCriteria.selectedScopeArgs=[];preCriteria.selectedScopeVals=[];preCriteria.allLevelSelectedScopeArgs=[];preCriteria.allLevelSelectedScopeVals=[];if(filter&&filter.Filter){preCriteria.expr=filter.Filter.Expression;preCriteria.searchScope=filter.RangeOption;if(filter.Filter.Conditions)for(var i=0;i<filter.Filter.Conditions.length;i++){var item=filter.Filter.Conditions[i];if(""!=item.Expression||-1!=item.Operator||-1!=item.Schema){var obj={$$hashKey:item.$$hashKey,Expression:item.Expression,Operator:item.Operator,Schema:item.Schema};preCriteria.criteriaList.push(obj)}}if(1==filter.RangeOption)for(var j=0;j<filter.DeviceGroupRange.length;j++)preCriteria.searchScopeArgs.push(filter.DeviceGroupRange[j]);if(2==filter.RangeOption){var length=_.indexOf(filter.SiteRange,separator);-1===length&&(length=filter.SiteRange.length);for(var k=0;k<length;k++){filter.SiteRange[k]&&preCriteria.searchScopeArgs.push(filter.SiteRange[k]);var valIndex=k+length+1;if(filter.SiteRange[valIndex]){var siteTreeNodeVal=filter.SiteRange[valIndex];preCriteria.searchScopeVals.push(siteTreeNodeVal);preCriteria.selectedScopeVals.push(siteTreeNodeVal)}}}}}($scope.refDySearchJsonFromDB,$scope.preCriteria);$scope.onSearch=function(){preCriteriaToFilter($scope.preCriteria,$scope.refDySearchJsonFromDB);var cloneDySearchJson=angular.copy($scope.refDySearchJsonFromDB);var conditions=cloneDySearchJson.Filter.Conditions;var error={message:"",catalog:-1};if(1!=cloneDySearchJson.RangeOption||cloneDySearchJson.DeviceGroupRange&&0!=cloneDySearchJson.DeviceGroupRange.length)if(2!=cloneDySearchJson.RangeOption||cloneDySearchJson.SiteRange&&0!=cloneDySearchJson.SiteRange.length)if(!conditions||0==conditions.length||1==conditions.length&&-1==conditions[0].Schema){error.message="Please define search criteria first.";error.catalog=1}else{var l=conditions.length;for(var i=0;i<l;i++)if((""!=conditions[i].Expression||-1!=conditions[i].Operator||-1!=conditions[i].Schema)&&(""==conditions[i].Expression&&"proxyServer"!=conditions[i].Schema||conditions[i].Operator<0||""==conditions[i].Schema)){error.message="Invalid search criteria.";error.catalog=2;break}}else{error.message="Please select sites.";error.catalog=0}else{error.message="Please select device groups.";error.catalog=0}if(""==error.message){var dySearchJsonObj=angular.fromJson(angular.toJson(cloneDySearchJson));httpDynamicSearchSrvc.calcDySearchDevice(null,dySearchJsonObj).then((function(result){$scope.gridOptions_devices.data=[];var tmpLsDevs=[];if(void 0===result||_.isArray(result)&&0===result.length)nbAlertSrvc.alert("No device found!");else for(var item in result){var obj=result[item];var currObj={name:obj.name,ID:obj.ID,vendor:obj.vendor,model:obj.model,mgmtIP:obj.mgmtIP};tmpLsDevs.push(currObj)}$scope.lsDevObjs_dySearch=tmpLsDevs;$scope.gridOptions_devices.data=$scope.lsDevObjs_dySearch}),(function(reason){$log.info("Dynamic Search -- No Results",reason)}))}else 2==error.catalog?nbAlertSrvc.notification({message:error.message}):nbAlertSrvc.warnning({message:error.message})};$scope.lsDevObjs_dySearch=[];$scope.gridOptions_devices={data:$scope.lsDevObjs_dySearch,columnDefs:[{field:"name",displayName:"Device Name"}],enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableHorizontalScrollbar:uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:uiGridConstants.scrollbars.NEVER};$scope.initSearchResult=function(){var lsDevObjs=callbackSrvc.getCallback("nb.datamodel.dgDevGridCtrl.lsDevObjs_dySearch");if(lsDevObjs){$scope.lsDevObjs_dySearch=$scope.lsDevObjs_dySearch.concat(lsDevObjs);$scope.gridOptions_devices.data=$scope.lsDevObjs_dySearch}else{var deviceGroupJsWrapper=callbackSrvc.getCallback("nb.datamodel.deviceGroupPopupCtrl.deviceGroupJsWrapper");if(deviceGroupJsWrapper&&!_.isEmpty(deviceGroupJsWrapper.data)&&deviceGroupJsWrapper.data.ID)httpDeviceGroupSrvc.getDevicesOfDeviceGroupByCondition(null,deviceGroupJsWrapper.data.ID,9999999,0,"type","DESC",null,null).then((function(devicesOfGroup){for(var i=0;i<devicesOfGroup.length;i++)if("dynamic"===devicesOfGroup[i].type){var currObj={name:devicesOfGroup[i].name,ID:devicesOfGroup[i].ID,mgmtIP:devicesOfGroup[i].mgmtIP,model:devicesOfGroup[i].model,vendor:devicesOfGroup[i].vendor,subType:devicesOfGroup[i].subType,type:devicesOfGroup[i].type};$scope.lsDevObjs_dySearch.push(currObj)}}));else{$scope.lsDevObjs_dySearch=[];$scope.gridOptions_devices.data=$scope.lsDevObjs_dySearch}}};$scope.initSearchResult();$scope.onOK=function(){if(2===$scope.preCriteria.searchScope){var criteriaString=$scope.preCriteria.getCurrentCriteria();var siteTree=JSON.parse(criteriaString).availableSites;!function(preCriteria,siteTree){var selectedScopeArgs=[];var selectedScopeVals=[];for(var i=0;i<preCriteria.searchScopeArgs.length;i++){var nodeId=preCriteria.searchScopeArgs[i];var nodePathId=getParentPathId(siteTree,nodeId,siteTree[0].ID)+","+nodeId;var nodePathIdArr=nodePathId.split(",");var nodePathName="";for(var j=0;j<nodePathIdArr.length;j++){var nodeName=getNodeName(siteTree,nodePathIdArr[j]);nodePathName=""==nodePathName?nodeName:nodePathName+","+nodeName}selectedScopeArgs.push(nodePathId);selectedScopeVals.push(nodePathName)}preCriteria.searchScopePathArgs=selectedScopeArgs;preCriteria.searchScopePathVals=selectedScopeVals}($scope.preCriteria,siteTree)}preCriteriaToFilter($scope.preCriteria,$scope.refDySearchJsonFromDB);args.parentScope.$emit(dySearchEvent.addDyDevsToDG,$scope.lsDevObjs_dySearch,$scope.refDySearchJsonFromDB);args.parentScope.$emit(dySearchEvent.closeDySearch);triggerSearchResultDeviceGroup1Key();$uibModalInstance.dismiss()};$scope.getCurrentCriteria=function(){console.log("")};function getParentPathId(siteTreeNodes,nodeId,parentId){var parentPathId="";for(var i=0;i<siteTreeNodes.length;i++){var node=siteTreeNodes[i];if(nodeId===node.ID){parentPathId=node.parentPath?node.parentPath.join(","):parentId;break}node.children&&node.children.length>0&&(parentPathId=getParentPathId(node.children,nodeId,node.ID));if(""!=parentPathId)break}return parentPathId}function getNodeName(siteTreeNodes,nodeId){var nodeName="";for(var i=0;i<siteTreeNodes.length;i++){var node=siteTreeNodes[i];if(nodeId===node.ID){nodeName=node.name?node.name:"";break}node.children&&node.children.length>0&&(nodeName=getNodeName(node.children,nodeId));if(""!=nodeName)break}return nodeName}function preCriteriaToFilter(preCriteria,filter){filter.Filter||(filter.Filter={});filter.Filter.Conditions=[];filter.Filter.Expression=preCriteria.expr;filter.RangeOption=preCriteria.searchScope;filter.DeviceGroupRange=[];filter.SiteRange=[];for(var i=0;i<preCriteria.criteriaList.length;i++){var item=preCriteria.criteriaList[i];if(""!==item.Expression||""!==item.Operator||""!==item.Schema){var obj={$$hashKey:item.$$hashKey,Expression:item.Expression,Operator:item.Operator,Schema:item.Schema};filter.Filter.Conditions.push(obj)}}if(1===preCriteria.searchScope)for(var j=0;j<preCriteria.searchScopeArgs.length;j++)filter.DeviceGroupRange.push(preCriteria.searchScopeArgs[j]);else if(2===preCriteria.searchScope)for(var k=0;k<preCriteria.searchScopeArgs.length;k++)filter.SiteRange.push(preCriteria.searchScopeArgs[k])}$scope.onCancel=function(argCloseReason){$scope.refDySearchJsonFromDB.RangeOption=$scope.refDySearchJsonFromDB_backup.RangeOption;$scope.refDySearchJsonFromDB.Filter=$scope.refDySearchJsonFromDB_backup.Filter;$uibModalInstance.dismiss(null!==argCloseReason?argCloseReason:"Cancel Button Clicked!");triggerSearchResultDeviceGroup1Key();args.parentScope.$emit(dySearchEvent.closeDySearch)};$scope.onSearchDeviceGroup=function(){$rootScope.$emit($scope.triggerSearchRequestKey)};var triggerSearchResultDeviceGroup1Key=$rootScope.$on($scope.triggerSearchResultKey,(function(event,type,searchObj){$scope.gridOptions_devices.data=[];var tmpLsDevs=[];if(searchObj&&searchObj.searchResultList&&searchObj.searchResultList.DevResults&&searchObj.searchResultList.DevResults.DevResultList)if(0===searchObj.searchResultList.DevResults.DevResultList.length)nbAlertSrvc.alert("No device found!");else{for(var i=0;i<searchObj.searchResultList.DevResults.DevResultList.length;i++){var vendor="";var model="";var item=searchObj.searchResultList.DevResults.DevResultList[i];for(var j=0;j<item.MatchPropertys.length;j++){var prop=item.MatchPropertys[j];"vendor"===prop.PropKey&&(vendor=prop.SearchValues[0].Value);"model"===prop.PropKey&&(model=prop.SearchValues[0].Value)}var obj={name:item.DevName,ID:item.DevGuid,vendor:vendor,model:model,mgmtIP:item.ManagementIP};tmpLsDevs.push(obj)}$scope.lsDevObjs_dySearch=tmpLsDevs;$scope.gridOptions_devices.data=$scope.lsDevObjs_dySearch}else nbAlertSrvc.alert(" No device found! ")}));$scope.$on("destroy",(function(){triggerSearchResultDeviceGroup1Key()}))}}(NetBrain);function CDeviceGroupJsWrapper(jsData){this.data={};jsData&&(this.data=jsData)}CDeviceGroupJsWrapper.prototype={constructor:CDeviceGroupJsWrapper,toJson:function(){return this.data},fromJson:function(jsDeviceGroup){this.data=jsDeviceGroup},getGuid:function(){return this.data.ID},setGuid:function(argGuid){this.data.ID=argGuid},getName:function(){return this.data.Name},setName:function(argName){this.data.Name=argName},getType:function(){return this.data.Type},setType:function(argNType){this.data.Type=argNType},getDescription:function(){return this.data.Description},setDescription:function(argDescription){this.data.Description=argDescription},getUserGuid:function(){return this.data.UserGuid},setUserGuid:function(argUserGuid){this.data.UserGuid=argUserGuid},getRangeOption:function(){return this.data.RangeOption},setRangeOption:function(argNRangeOption){this.data.RangeOption=argNRangeOption},getDeviceGroupRange:function(){return this.data.DeviceGroupRange},setDeviceGroupRange:function(argDeviceGroupRange){this.data.DeviceGroupRange=argDeviceGroupRange},getSiteRange:function(){return this.data.SiteRange},setSiteRange:function(argSiteRange){this.data.SiteRange=argSiteRange},getFilter:function(){return this.data.Filter},setFilter:function(argFilter){this.data.Filter=argFilter},getStaticDevices:function(){return this.data.StaticDevices},setStaticDevices:function(argArrStaticDevices){this.data.StaticDevices=argArrStaticDevices},getDynamicDevices:function(){return this.data.DynamicDevices},setDynamicDevices:function(argArrDynamicDevices){this.data.DynamicDevices=argArrDynamicDevices}};!function(){angular.module("nb.datamodel").factory("nb.datamodel.httpDeviceGroupSrvc",HttpDeviceGroupSrvc);HttpDeviceGroupSrvc.$inject=["$http","$q","$timeout","$log","$location","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.ng.nbHttp"];function HttpDeviceGroupSrvc($http,$q,$timeout,$log,$location,utilitySrvc,httpAuthSrvc,nbHttp){var _exportDevicesOfDeviceGroupByCondition=function(strDgId,nPageSize,nPageNumber,strSortField,strSortOrder,strFilterField,strFilterContent,fileName){var _deferred=$q.defer();!function(url,requestData,csvFileName){var _deferred=$q.defer();url=NetBrain.NG.ConfigSettings.API_ROOT+url;var dataSrc=httpAuthSrvc.getDataSrc();$http({url:url,method:"POST",responseType:"arraybuffer",data:requestData,headers:{TenantGuid:dataSrc.TenantGuid,DomainGuid:dataSrc.DomainGuid,"Content-type":"application/json",Accept:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}}).success((function(data,status){if(200==status){var blob=new Blob([data],{type:"text/csv;"});saveAs(blob,csvFileName);_deferred.resolve("OK")}})).error((function(){_deferred.reject("there is an error")}));_deferred.promise}("DeviceGroup/exportDevicesOfDGByCondition",{guid:strDgId,sortField:strSortField,sortOrder:strSortOrder,pageSize:nPageSize,pageNumber:nPageNumber,filterField:strFilterField,filterContent:strFilterContent,fileName:fileName},fileName+".csv");_deferred.resolve("OK");return _deferred.promise};return{getDeviceGroupsByGuids:function(deviceGroupIds){return function(devicegroupIds){var defer=$q.defer();nbHttp.post("DeviceGroup",devicegroupIds).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(deviceGroupIds)},getDeviceGroupByGuid:function(dataSrc,deviceGroupId){return function(dataSrc,devicegroupId){var defer=$q.defer();nbHttp.get("DeviceGroup/"+devicegroupId).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,deviceGroupId)},getDeviceGroupByGuid_with_devices_it_to_name:function(argDeviceGroupGuid,dataSrc){return function(guid){var defer=$q.defer();nbHttp.get("DeviceGroup/GetDeviceGroupWithDeviceNames/"+guid).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(void 0!==argDeviceGroupGuid&&null!=argDeviceGroupGuid?argDeviceGroupGuid:"a3d90600-5c82-499a-9e1a-24cdcc904768")},getDeviceGroupByGuid_no_devices:function(argDeviceGroupGuid,dataSrc){return function(argDeviceGroupGuid){var defer=$q.defer();var devGroupGuid=void 0!==argDeviceGroupGuid&&null!=argDeviceGroupGuid?argDeviceGroupGuid:"a3d90600-5c82-499a-9e1a-24cdcc904768";nbHttp.get("DeviceGroup/noDevices/"+devGroupGuid).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(void 0!==argDeviceGroupGuid&&null!=argDeviceGroupGuid?argDeviceGroupGuid:"a3d90600-5c82-499a-9e1a-24cdcc904768")},getAllDeviceGroupByTypes:function(arrTypes,dataSrc,includeLinkGroup){return function(arrTypes,includeLinkGroup){var defer=$q.defer();var url="DeviceGroup/getAllDeviceGroupByType2";!1===includeLinkGroup&&(url+="/false");nbHttp.post(url,arrTypes).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(arrTypes,includeLinkGroup)},getAllDeviceGroupByAllTypes:function(arrTypes,dataSrc){return function(arrTypes){var defer=$q.defer();nbHttp.post("DeviceGroup/getAllDeviceGroupByType",arrTypes).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(arrTypes)},upInsertDeviceGroup:function(bIsCreateNew,jsonDeviceGroup,addedStaticDevices,deletedStaticDevices,addedDynamicDevices,deletedDynamicDevices,dataSrc){return function(bIsCreateNew,jsonDeviceGroup,addedStaticDevices,deletedStaticDevices,addedDynamicDevices,deletedDynamicDevices){var requestInfo={dg:jsonDeviceGroup,isCreateNew:bIsCreateNew,addedStaticDevices:addedStaticDevices,deletedStaticDevices:deletedStaticDevices,addedDynamicDevices:addedDynamicDevices,deletedDynamicDevices:deletedDynamicDevices};var defer=$q.defer();nbHttp.post("DeviceGroup/UpInsertDeviceGroup",requestInfo).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(bIsCreateNew,jsonDeviceGroup,addedStaticDevices,deletedStaticDevices,addedDynamicDevices,deletedDynamicDevices)},getDeviceIdToNamesOfDeviceGroupIds:function(dataSrc,lsDgIds){return function(dataSrc,lsDgIds){var defer=$q.defer();nbHttp.post("DeviceGroup/getDeviceIdToNamesOfDeviceGroupIds",lsDgIds).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,lsDgIds)},getDevicesOfDeviceGroupByCondition:function(dataSrc,strDgId,nPageSize,nPageNumber,strSortField,strSortOrder,strFilterField,strFilterContent){return function(dataSrc,strDgId,nPageSize,nPageNumber,strSortField,strSortOrder,strFilterField,strFilterContent){var requestInfo={guid:strDgId,pageSize:nPageSize,pageNumber:nPageNumber+1,sortField:strSortField,sortOrder:strSortOrder,filterField:strFilterField,filterContent:strFilterContent};var defer=$q.defer();nbHttp.post("DeviceGroup/DevicesAndInterfacesByCondition",requestInfo).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,strDgId,nPageSize,nPageNumber,strSortField,strSortOrder,strFilterField,strFilterContent)},getLinkedGroupDevicesAndInterfaceByCondition:function(reqInfo){return function(reqInfo){var requestInfo={guid:reqInfo.guid,pageSize:reqInfo.pageSize,pageNumber:reqInfo.pageNumber,sortField:reqInfo.sortField,sortOrder:reqInfo.sortOrder,filterField:reqInfo.filterField,filterContent:reqInfo.filterContent};var defer=$q.defer();nbHttp.post("DeviceGroup/LinkedGroupDevicesAndInterfaceByCondition",requestInfo).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(reqInfo)},getDeviceAllIntfAndIntfs:function(reqInfo){return function(reqInfo){var requestInfo={idList:reqInfo.idList,pageSize:reqInfo.pageSize,pageNumber:reqInfo.pageNumber,filterContent:reqInfo.filterContent};var defer=$q.defer();nbHttp.post("DeviceGroup/DeviceAllIntfAndIntfs",requestInfo).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(reqInfo)},exportDevicesOfDeviceGroupByCondition:function(strDgId,nPageSize,nPageNumber,strSortField,strSortOrder,strFilterField,strFilterContent,fileName){return _exportDevicesOfDeviceGroupByCondition(strDgId,nPageSize,nPageNumber,strSortField,strSortOrder,strFilterField,strFilterContent,fileName)},getDevicesBasicInfoByDeviceGroup:function(dataSrc,argDeviceGroupGuid){return function(dataSrc,argDeviceGroupGuid){var defer=$q.defer();nbHttp.get("DeviceGroup/getDevicesBasicInfoByDeviceGroup/"+argDeviceGroupGuid).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,argDeviceGroupGuid)},getAllDeviceGroupInfo:function(includeLinkGroup){return function(includeLinkGroup){var defer=$q.defer();var url="DeviceGroup/getAllDeviceGroupInfo";includeLinkGroup&&(url+="/true");nbHttp.get(url).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(includeLinkGroup)},getDeviceGroupInfo:function(ids){return function(ids){var defer=$q.defer();nbHttp.post("DeviceGroup/DeviceGroupInfo",ids).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(ids)},getAllDeviceGroups:function(){return function(){var defer=$q.defer();nbHttp.get("DeviceGroup/getAllDeviceGroups").then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}()},getAllDeviceGroupNames:function(dataSrc,isPrivateDGExcluded){return function(dataSrc,isPrivateDGExcluded){var defer=$q.defer();nbHttp.post("DeviceGroup/getAllDeviceGroupNames",isPrivateDGExcluded).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,isPrivateDGExcluded)},getDeviceGroupInfoByGuid:function(dataSrc,argDGID){return function(dataSrc,argDGID){var defer=$q.defer();nbHttp.get("DeviceGroup/getDeviceGroupInfoByGuid/"+argDGID).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,argDGID)},getDeviceGroupDevices:function(dataSrc,argDeviceGroupId){return function(dataSrc,argDeviceGroupGuid){var defer=$q.defer();nbHttp.get("DeviceGroup/getDeviceGroupDevices/"+argDeviceGroupGuid).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,argDeviceGroupId)},deleteDeviceGroupByGuid:function(dataSrc,argDeviceGroupGuid,bIsDeleteAllDevicesFromDomain){return function(dataSrc,argDeviceGroupGuid,bIsDeleteAllDevicesFromDomain){var requestInfo={deviceGroupGuid:argDeviceGroupGuid,deleteAllDevicesFromDomain:bIsDeleteAllDevicesFromDomain};var defer=$q.defer();nbHttp.post("DeviceGroup/deleteDeviceGroupByGuid",requestInfo).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,argDeviceGroupGuid,bIsDeleteAllDevicesFromDomain)},addToDeviceGroup:function(dataSrc,dgId,ids){return function(dataSrc,dgId,ids){var requestInfo={deviceGroupId:dgId,devIds:ids};var defer=$q.defer();nbHttp.post("DeviceGroup/addToDeviceGroup",requestInfo).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,dgId,ids)},removeFromDeviceGroup:function(dataSrc,dgId,ids){return function(dataSrc,dgId,ids){var requestInfo={deviceGroupId:dgId,devIds:ids};var defer=$q.defer();nbHttp.post("DeviceGroup/removeFromDeviceGroup",requestInfo).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,dgId,ids)},getDeviceIdToNamesOfDeviceGroupIdsByPaging:function(reqObj){var defer=$q.defer();nbHttp.post("DeviceGroup/getDeviceIdToNamesOfDeviceGroupIdsByPaging",reqObj).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise},getDevicesOfDeviceGroupIdsByPaging:function(reqObj){var defer=$q.defer();Array.isArray(reqObj.filterField)||(reqObj.filterField=[reqObj.filterField]);nbHttp.post("DeviceGroup/getDevicesOfDeviceGroupIdsByPaging",reqObj).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise},upTypeOfDeviceGroup:function(dataSrc,dgIds,type){return function(dataSrc,dgIds,type){var requestInfo={guids:dgIds,type:type};var defer=$q.defer();nbHttp.post("DeviceGroup/UpTypeOfDeviceGroup",requestInfo).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(0,dgIds,type)},isExistsInPublic:function(deviceGroupName){var defer=$q.defer();nbHttp.post("DeviceGroup/isExistsInPublic/"+encodeURIComponent(deviceGroupName)).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise},parserDySearchFromXMLToJson:function(dySearchXml){var defer=$q.defer();nbHttp.post("DeviceGroup/parserDySearchFromXMLToJson",dySearchXml).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise},filterDeviceGroupByName:function(deviceGroupName){return function(deviceGroupName){var defer=$q.defer();var data=[deviceGroupName];nbHttp.post("DeviceGroup/filterDeviceGroupByName",data).then((function(results){defer.resolve(results)}),(function(err){defer.reject(err)}));return defer.promise}(deviceGroupName)}}}}(NetBrain);!function(NetBrain){angular.module("nb.ng").factory("nb.ng.deviceGroupPermissionSrvc",deviceGroupPermissionSrvc);deviceGroupPermissionSrvc.$inject=["$rootScope","$log","nb.ng.sessionSrvc","nb.ng.userSrvc","nb.ng.permissionSrvc"];function deviceGroupPermissionSrvc($rootScope,$log,sessionSrvc,userSrvc,permissionSrvc){return{canEdit:function(deviceGroupOwnerID,deviceGroupTypeID){var isEdit=!1;(permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.sharedResourceManagement)||deviceGroupOwnerID==userSrvc.getUserID())&&(isEdit=!0);deviceGroupTypeID==deviceGroupType.System&&(isEdit=!1);return isEdit}}}}(NetBrain);!function(){angular.module("nb.datamodel").factory("nb.datamodel.httpSiteManagerSrvc",HttpSiteManagerSrvc);HttpSiteManagerSrvc.$inject=["$q","nb.ng.nbHttp"];function HttpSiteManagerSrvc($q,nbHttp){var INT_MAX=Math.pow(2,31)-1;var SITE_MANAGER_API_ROUTE_PREFIX="site-manager";var siteMemberTypeFilterArgs_all=0,siteMemberTypeFilterArgs_validMembers=4;function getDeviceId(device){return device.deviceId}function ajax(url,method,requestData,options){return nbHttp[method.toLowerCase()](url,requestData,options)}function post(url,requestData,options){return ajax(url,"POST",requestData,options)}function _getSiteTree(parentid,useTemporaryStorage,returnSpecialSite){parentid||(parentid=0);void 0===useTemporaryStorage&&(useTemporaryStorage=!0);var reqData={siteId:parentid,useTemporaryStorage:useTemporaryStorage,returnSpecialSite:returnSpecialSite||!1};var deferred=$q.defer();post(SITE_MANAGER_API_ROUTE_PREFIX+"/getChildrenSiteByParentSiteID",reqData).then((function(data){var result={children:[]};angular.forEach(data,(function(item){if(0===item.siteCategory){item.show=!0;item.name||(item.name="My Network");item.isShowMenu=!0;result=angular.extend(result,item)}else{item.show=!1;item.children=[];item.isShowMenu=!0;result.children.push(item)}}));0===parentid?deferred.resolve(result):deferred.resolve(result.children)}));return deferred.promise}return{getSiteTree:function(parentId,useTemporaryStorage){return _getSiteTree(parentId,useTemporaryStorage,!1)},getSiteManagerTree:function(parentId,useTemporaryStorage){return _getSiteTree(parentId,useTemporaryStorage,!0)},getSiteDeviceBySiteID:function(argSiteId,pageNumber,siteType,useTempStorage){var deferred=$q.defer();angular.isUndefined(pageNumber)&&(pageNumber=1);angular.isUndefined(siteType)&&(siteType=siteMemberTypeFilterArgs_all);var reqData={siteId:argSiteId,pageSize:INT_MAX,pageNumber:pageNumber,type:siteType,useTemporaryStorage:!angular.isDefined(useTempStorage)||useTempStorage,isExtendData:!0};post(SITE_MANAGER_API_ROUTE_PREFIX+"/getSiteDeviceBySiteID",reqData).then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},getSiteDefinition:function(siteId){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/getSiteDefinitionBySiteID",{siteId:siteId,useTemporaryStorage:!0})},getSitePropertiesBySiteID:function(siteId,useTemporaryStorage){var useTemp=!0;null!=useTemporaryStorage&&(useTemp=useTemporaryStorage);var reqData={siteId:siteId,useTemporaryStorage:useTemp};return nbHttp.get(SITE_MANAGER_API_ROUTE_PREFIX+"/getSitePropertiesBySiteID",reqData,{cache:!1})},saveSiteProperties:function(siteProperties){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/modifySite",{site:siteProperties,useTemporaryStorage:!0})},getDynamicSearchWithAction:function(siteId,fobj){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/dynamicSearchWithAction",{siteId:siteId,dysearch:{RangeOption:0,Filter:fobj}})},dynamicSearchAndAutoAdd:function(siteId,fobj,deviceIds){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/dynamicSearchAndAutoAdd",{siteId:siteId,dysearch:{RangeOption:0,Filter:fobj},deviceIds:deviceIds})},rebuildSite:function(){var deferred=$q.defer();post(SITE_MANAGER_API_ROUTE_PREFIX+"/rebuildSite",{useTemporaryStorage:!0}).then((function(res){deferred.resolve(res)}),(function(error){deferred.reject(error)}));return deferred.promise},commit:function(isRebuild){var deferred=$q.defer();post(SITE_MANAGER_API_ROUTE_PREFIX+"/commitSite",{useTemporaryStorage:!0,needToRebuild:isRebuild}).then((function(res){deferred.resolve(res)}),(function(error){deferred.reject(error)}));return deferred.promise},clearAllSite:function(){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/clearAllSite",{useTemporaryStorage:!0})},removeContainerSiteWithoutLeafSite:function(){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/removeContainerSiteWithoutLeafSite",{useTemporaryStorage:!0})},addNewSite:function(site){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/addNewSite",{site:site,useTemporaryStorage:!0})},environmentInit:function(){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/environment-init")},closeSiteManger:function(){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/unlock-site")},keepAliveSiteManger:function(){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/keep-alive",{},{avoidBlockUI:!0})},removeSite:function(siteID){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/removeSite",{siteId:siteID,useTemporaryStorage:!0})},moveSite:function(site){var reqData={siteId:site.ID,parentId:site.parentId,useTemporaryStorage:!0};return post(SITE_MANAGER_API_ROUTE_PREFIX+"/moveSite",reqData)},modifySite:function(site){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/modifySite",{site:site,useTemporaryStorage:!0})},getValidMembersOfSite:function(params){var useTemporaryStorage=!params.useTemporaryStorage||params.useTemporaryStorage;var reqData={siteId:params.site.ID,pageNumber:params.pageIndex+1,pageSize:params.pageSize,type:siteMemberTypeFilterArgs_validMembers,useTemporaryStorage:useTemporaryStorage,isExtendData:!0};return post(SITE_MANAGER_API_ROUTE_PREFIX+"/getSiteDeviceBySiteID",reqData)},addToSite:function(params){var reqData={deviceIds:params.devices.map(getDeviceId),fromSite:params.sourceSite.ID,toSite:params.targetSite.ID,useTemporaryStorage:!0};return post(SITE_MANAGER_API_ROUTE_PREFIX+"/addToSite",reqData)},deleteSiteMembers:function(site,devices){var deviceIds=devices.map(getDeviceId);var reqData={siteId:site.ID,deviceIds:deviceIds,useTemporaryStorage:!0};return post(SITE_MANAGER_API_ROUTE_PREFIX+"/removeSiteMember",reqData)},excludeSiteMembers:function(site,devices){var reqData={siteId:site.ID,devices:devices,useTemporaryStorage:!0};return post(SITE_MANAGER_API_ROUTE_PREFIX+"/excludeSiteMembers",reqData)},getBackupSiteDefinitionUrl:function(){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/backup-site-definition",{useTemporaryStorage:!1})},addSiteMember:function(siteId,deviceIds){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/addManuallyAddedMember",{siteId:siteId,deviceIds:deviceIds,useTemporaryStorage:!0})},addExcludedMember:function(siteId,deviceIds){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/addExcludedMember",{siteId:siteId,deviceIds:deviceIds,useTemporaryStorage:!0})},getDeviceSiteInfo:function(deviceIds){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/getDeviceSiteInfo",{deviceIds:deviceIds,useTemporaryStorage:!0})},loadSiteFromFile:function(directoryPath){var deferred=$q.defer();post(SITE_MANAGER_API_ROUTE_PREFIX+"/loadSiteFromFile",{directoryPath:encodeURIComponent(directoryPath)}).then((function(res){deferred.resolve(res)}),(function(error){deferred.reject(error)}));return deferred.promise},getSiteDeviceCount:function(siteIds){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/getSiteDeviceCount",{siteIds:siteIds,useTemporaryStorage:!0})},importSiteFromFileProcess:function(data){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/importSiteFromFileProcess",data)},updateLockdownMember:function(siteId,isLockdownMember){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/updateLockdownMember",{siteId:siteId,isLockdownMember:isLockdownMember,useTemporaryStorage:!0})},getBranchMaxLevels:function(siteId){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/branch-max-levels/"+siteId)},getSiteExcluded:function(){return ajax(SITE_MANAGER_API_ROUTE_PREFIX+"/site-settings","GET",requestData,options);var requestData,options},setSiteExcluded:function(data){return post(SITE_MANAGER_API_ROUTE_PREFIX+"/site-settings",data)}}}}(NetBrain);!function(){angular.module("nb.datamodel").factory("nb.datamodel.httpSiteSrvc",HttpSiteSrvc);HttpSiteSrvc.$inject=["$q","nb.ng.nbHttp"];function HttpSiteSrvc($q,nbHttp){var INT_MAX=Math.pow(2,31)-1;var SITE_API_ROUTE_PREFIX="site";var siteMemberTypeFilterArgs_all=0,siteMemberTypeFilterArgs_validMembers=4;function ajax(url,method,requestData){return nbHttp[method.toLowerCase()](url,requestData)}function post(url,requestData){return ajax(url,"POST",requestData)}function get(url,requestData){return ajax(url,"GET",requestData)}function _getSiteTree(parentId,returnSpecialSite){parentId||(parentId=0);var reqData={siteId:parentId,returnSpecialSite:returnSpecialSite||!1};var deferred=$q.defer();post(SITE_API_ROUTE_PREFIX+"/getChildrenSiteByParentSiteID",reqData).then((function(data){var result={children:[]};angular.forEach(data,(function(item){if(0===item.siteCategory){item.show=!0;item.name||(item.name="My Network");item.isShowMenu=!0;result=angular.extend(result,item)}else{item.show=!1;item.children=[];item.isShowMenu=!0;result.children.push(item)}}));0===parentId?deferred.resolve(result):deferred.resolve(result.children)}));return deferred.promise}return{getSiteTree:function(parentId){return _getSiteTree(parentId,!1)},getFullSiteTree:function(parentId){return _getSiteTree(parentId,!0)},getSiteTreeIncludeAllSelectedSites:function(parentId,selectedSiteIds){parentId||(parentId=0);var reqData={parentSiteId:parentId,selectedSiteIds:selectedSiteIds};var deferred=$q.defer();post(SITE_API_ROUTE_PREFIX+"/getChildrenSitesByParentAndSelected",reqData).then((function(data){var result={children:[]};angular.forEach(data,(function(item){if(0===item.siteCategory){item.show=!0;item.name||(item.name="My Network");item.isShowMenu=!0;result=angular.extend(result,item)}else{item.show=!1;item.children=item.children?item.children:[];item.isShowMenu=!0;var parent=result;for(var index=0;index<data.length;index++){var site=data[index];if(item.parentId==site.ID){if(site.ID!=result.ID){(parent=site).loaded=!0;parent.children||(parent.children=[])}break}}parent.children.push(item)}}));0===parentId?deferred.resolve(result):deferred.resolve(result.children)}));return deferred.promise},getSiteDeviceBySiteID:function(argSiteId,pageNumber,siteType){var deferred=$q.defer();angular.isUndefined(pageNumber)&&(pageNumber=1);angular.isUndefined(siteType)&&(siteType=siteMemberTypeFilterArgs_all);post(SITE_API_ROUTE_PREFIX+"/getSiteDeviceBySiteID",{siteId:argSiteId,pageSize:INT_MAX,pageNumber:pageNumber,type:siteType,isExtendData:!0}).then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},getSiteDevicesBySiteIDByPaging:function(argSiteId,siteType,pageNumber,pageSize,filterFields,filterValue){var deferred=$q.defer();var pn=pageNumber+1;angular.isUndefined(pageNumber)&&(pn=1);angular.isUndefined(siteType)&&(siteType=siteMemberTypeFilterArgs_all);post(SITE_API_ROUTE_PREFIX+"/getSiteDevicesBySiteIDByPaging",{siteId:argSiteId,type:siteType,pageNumber:pn,pageSize:pageSize,filterFields:filterFields,filterValue:filterValue,isExtendData:!0}).then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},getSiteDevicesBySiteIDByPagingWithType:function(argSiteId,siteType,pageNumber,pageSize,filterFields,filterValue,sortField,sortOrder){var deferred=$q.defer();var pn=pageNumber+1;angular.isUndefined(pageNumber)&&(pn=1);angular.isUndefined(siteType)&&(siteType=siteMemberTypeFilterArgs_all);var reqData={siteId:argSiteId,type:siteType,pageNumber:pn,sortField:"deviceName",pageSize:pageSize,filterFields:filterFields,filterValue:filterValue,isExtendData:!0};if(sortField&&sortOrder){reqData.sortField=sortField;reqData.sortOrder=sortOrder}post(SITE_API_ROUTE_PREFIX+"/getSiteDevicesBySiteIDByPagingWithType",reqData).then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},getPartialSiteTreeByLevels:function(argNLevels){var deferred=$q.defer();post(SITE_API_ROUTE_PREFIX+"/getPartialSiteTreeByLevels",argNLevels).then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},getPartialSiteTreeBySelectedSites:function(lsSiteIds){var deferred=$q.defer();post(SITE_API_ROUTE_PREFIX+"/getPartialSiteTreeBySelectedSites",{siteIds:lsSiteIds}).then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},getSiteDefinition:function(siteId){return post(SITE_API_ROUTE_PREFIX+"/getSiteDefinitionBySiteID",{siteId:siteId})},getSitesByIds:function(siteIds){var reqData={siteIds:siteIds};var deferred=$q.defer();post(SITE_API_ROUTE_PREFIX+"/GetSitesByIds",reqData).then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},getSitePropertiesBySiteID:function(siteId){var reqData={siteId:siteId};return nbHttp.get(SITE_API_ROUTE_PREFIX+"/getSitePropertiesBySiteID",reqData,{cache:!1})},getSitePropertiesBySiteIDList:function(siteIds){return post(SITE_API_ROUTE_PREFIX+"/getSitePropertiesBySiteIDList",{siteIds:siteIds})},getSiteDevicesBySiteIDWithFilter:function(params){var reqData={siteId:params.siteId,filterFields:params.filterFields,filterValue:params.filterValue,sortField:params.sortField,sortOrder:params.sortOrder,pageNumber:params.pageNumber,pageSize:params.pageSize,type:siteMemberTypeFilterArgs_validMembers};return post(SITE_API_ROUTE_PREFIX+"/getSiteDevicesBySiteIDWithFilter",reqData)},getDeviceSitePath:function(deviceId){return post(SITE_API_ROUTE_PREFIX+"/getSitePathByDeviceId",deviceId)},getSiteByDeviceId:function(deviceId){return post(SITE_API_ROUTE_PREFIX+"/getSiteByDeviceId",deviceId)},getSiteDeviceCount:function(siteIds){return post(SITE_API_ROUTE_PREFIX+"/getSiteDeviceCount",{siteIds:siteIds})},getAllSites:function(){var deferred=$q.defer();get(SITE_API_ROUTE_PREFIX+"/getAllSites").then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},getAllLeafSites:function(){return get(SITE_API_ROUTE_PREFIX+"/getAllLeafSites")},getBranchMaxLevels:function(siteId){return post(SITE_API_ROUTE_PREFIX+"/branch-max-levels/"+siteId)},getSiteParentPathName:function(siteId){return get(SITE_API_ROUTE_PREFIX+"/parentPathName/"+siteId)},getSitesByNameFilter:function(siteName){return post(SITE_API_ROUTE_PREFIX+"/getSitesByNameFilter",siteName)},getSitesLastUpdateTime:function(siteIds){return post(SITE_API_ROUTE_PREFIX+"/getSitesLastUpdateTime",siteIds)},getChildrenSiteByParentSiteID:function(siteId){return ajax(SITE_API_ROUTE_PREFIX+"/getChildrenSiteByParentSiteID","POST",{siteId:siteId})},getRootSite:function(){var deferred=$q.defer();get(SITE_API_ROUTE_PREFIX+"/root-site").then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},getSitePath:function(){var deferred=$q.defer();get(SITE_API_ROUTE_PREFIX+"/sitePath").then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise},checkSiteIsInLockedState:function(){var deferred=$q.defer();get(SITE_API_ROUTE_PREFIX+"/site-in-locked-state").then((function(data){deferred.resolve(data)}),(function(reason){deferred.reject(reason)}));return deferred.promise}}}}(NetBrain);!function(){angular.module("nb.datamodel").factory("nb.datamodel.nbSiteTreeSrvc",NbSiteTreeSrvc);NbSiteTreeSrvc.$inject=["$rootScope","$q","$timeout","$uibModal","$upload","$log","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.datamodel.httpSiteManagerSrvc","nb.ng.httpAuthSrvc","nb.ng.httpDownloadingSrvc"];function NbSiteTreeSrvc($rootScope,$q,$timeout,$uibModal,$upload,$log,nbAlertSrvc,utilitySrvc,httpSiteManagerSrvc,httpAuthSrvc,httpDownloadingSrvc){var serv={};var definitionHandle=null;var _treeList=[];var treeHandle=null;var _nameCount=0;var UNASSIGNED_SITE_NAME="Unassigned";var clearAllSite=function(){nbAlertSrvc.confirm({message:"Do you want to clear all sites?"}).then((function(){httpSiteManagerSrvc.clearAllSite().then((function(){treeHandle.refresh();serv.isSiteChanged=!0}),(function(error){nbAlertSrvc.error(error.ResultDesc)}))}))};var addSite=function(site,type,siteSitting){var deferred=$q.defer();siteSitting||(siteSitting={});if(20!==_getSiteLevel(site)||1!==type){if(!(_getSiteLevel(site)>21)){treeHandle.expand(site,!0).then((function(){var sitename=function(prefix,children){var name;for(;;){name=prefix+ ++_nameCount;if(!_findItemByName(children,name))break}return name}("Unnamed-site",site.children);!function(newsite){httpSiteManagerSrvc.addNewSite(newsite).then((function(data){newsite.ID=data;newsite=function(item){item.isLeaf=item.siteCategory>=2;item.siteIcon=2===item.siteCategory?"leaf_site_icon":"container_site_icon";item.selected=!1;1===item.siteCategory&&(item.children=[]);return item}(newsite);!function(siteObj,child){if(0===siteObj.siteCategory){var unassingn={ID:-1,name:UNASSIGNED_SITE_NAME,deviceCount:site.deviceCount,siteCategory:3,siteIcon:"unassigned_site_icon",isLeaf:!0,selected:!1};if(siteObj.children.length>=2&&3===siteObj.children[siteObj.children.length-2].siteCategory)treeHandle.treeOptions.treeObj.addNodes([child],siteObj.ID,siteObj.children.length-2);else if(siteObj.deviceCount>0||unassingn.name!==UNASSIGNED_SITE_NAME){treeHandle.treeOptions.treeObj.addNodes([unassingn],siteObj.ID,siteObj.children.length-1);treeHandle.treeOptions.treeObj.addNodes([child],siteObj.ID,siteObj.children.length-2)}}else treeHandle.treeOptions.treeObj.addNodes(child,siteObj.ID);treeHandle.onNodeClick(child)}(site,newsite);_.defer((function(){deferred.resolve(newsite)}));serv.isSiteChanged=!0}),(function(error){nbAlertSrvc.error(error.ResultDesc)}))}(angular.extend({ID:_.uniqueId("i_"),name:sitename,siteCategory:type,deviceCount:0,parentId:site.ID},siteSitting))}));return deferred.promise}nbAlertSrvc.warnning({message:"The maximum site hierarchy is 20-level and the site in Level 20 can only be a leaf site."})}else nbAlertSrvc.warnning({message:"The maximum site hierarchy is 20-level and the site in Level 20 can only be a leaf site."});function _findItemByName(children,name){return _.find(children,(function(item){return item.name==name}))}function _getSiteLevel(siteObj){var level=0;for(;++level<21&&siteObj&&siteObj.parent;)siteObj=siteObj.parent;return level}};var addContainerSite=function(site,siteSitting){return addSite(site,1,siteSitting)};var addLeafSite=function(site,siteSitting){return addSite(site,2,siteSitting)};function modifyCount(site,count){0!==site.siteCategory&&(site.deviceCount+=count);var psite=site.parent;psite&&1===psite.siteCategory&&modifyCount(psite,count)}function isShowMenu(site,action){var sc=site.siteCategory+"";return action.mType.indexOf(sc)>-1}var importFn;serv.setImprotFile=function(fn){importFn=fn};serv.onImprotFile=function(){importFn.apply(null,[])};var actionMenu=[{template:"Add Container Site",action:addContainerSite,isShow:isShowMenu,mType:"01"},{template:"Add Leaf Site",action:addLeafSite,isShow:isShowMenu,mType:"01"},{template:"Import from File",action:serv.onImprotFile,isShow:isShowMenu,mType:"0"},{template:"Export to Spreadsheet",action:function(){treeHandle.siteTree&&treeHandle.siteTree.children.length>0?$uibModal.open({templateUrl:"modules/nbDataModel/site/manager/views/exportToSpreadsheet.html",controller:"nb.datamodel.exportToSpreadsheetCtrl",windowClass:"exportToSpreadsheet",backdrop:"static",resolve:{siteSelected:function(){return treeHandle.selected}}}):nbAlertSrvc.warning("Export failed: your current network doesn't contain any sites.")},isShow:isShowMenu,mType:"0"},{template:"Clear All Sites",action:clearAllSite,isShow:isShowMenu,mType:"0"},{template:"Remove Site without Leaf Site",action:function(){nbAlertSrvc.confirm({message:"Do you want to remove all parent sites that do not contain leaf sites?"}).then((function(){httpSiteManagerSrvc.removeContainerSiteWithoutLeafSite().then((function(){treeHandle.refresh();serv.isSiteChanged=!0}),(function(error){nbAlertSrvc.error(error.ResultDesc)}))}))},isShow:isShowMenu,mType:"0"},{template:"Backup Site Definition",action:function(){httpDownloadingSrvc.getTicket().then((function(ticket){var url=NetBrain.NG.ConfigSettings.API_ROOT+"site-manager/backup-site-definition";url+="?dl_ticket="+ticket+"&TenantGuid="+httpAuthSrvc.getSelectedTenantId()+"&DomainGuid="+httpAuthSrvc.getSelectedDomainIds()[0];httpDownloadingSrvc.downloadFileByPost(url,{useTemporaryStorage:!0})}),(function(){nbAlertSrvc.alert("failed to get downloading ticket...")}))},isShow:isShowMenu,mType:"0"},{template:"Load Site Definition",action:function(){var fileElem=angular.element('<input type="file" id="selectonesitefile" accept=".zip,.site"  >');fileElem.hide();angular.element("body").find("#selectonesitefile").length>0?fileElem=angular.element("body").find("#selectonesitefile"):angular.element("body").append(fileElem);fileElem.one("change",(function(){!function(file){var _dataSrc={TenantGuid:$rootScope.selectedTenantId,DomainGuid:$rootScope.selectedDomainIds};$upload.upload({url:NetBrain.NG.ConfigSettings.API_ROOT+"ngloadsite/uploadAndLoadSite?access_token=",method:"POST",file:file,headers:{TenantGuid:_dataSrc.TenantGuid,DomainGuid:_dataSrc.DomainGuid},data:{fileName:file.name}}).success((function(data){httpSiteManagerSrvc.loadSiteFromFile(data.directoryPath).then((function(){treeHandle.refresh();serv.isSiteChanged=!0}),(function(){nbAlertSrvc.error({message:"Failed to load site definition."})}))})).error((function(){alert("Load site failure.")}));angular.element("#selectonesitefile").remove()}(fileElem[0].files[0])}));fileElem.click()},isShow:isShowMenu,mType:"0"},{template:"Move to",action:function(site){var _filter,_validate;(_filter=function(data){return 2!==data.siteCategory&&3!==data.siteCategory&&data.ID!==site.ID},$uibModal.open({templateUrl:"modules/nbDataModel/site/manager/views/siteTree.html",controller:"nb.datamodel.siteTreePopupCtrl",windowClass:"siteTreePopup",backdrop:"static",resolve:{filter:function(){return _filter},validate:function(){return _validate}}})).result.then((function(selected){var path=selected.path;path[0]||path.splice(0,1);selected.ID!==site.parent.ID&&httpSiteManagerSrvc.getBranchMaxLevels(site.ID).then((function(branchMaxLevelRes){var newLevelCountAtferMove=branchMaxLevelRes.levelCount-serv.getPath(site).length+path.length;newLevelCountAtferMove>20||20===newLevelCountAtferMove&&!0===branchMaxLevelRes.hasContainerSiteAtLastLevel?nbAlertSrvc.warnning({message:"The maximum site hierarchy is 20-level and the site in Level 20 can only be a leaf site."}):function openNodes(path,callback){if(path.length>0){var id=path[0];var interval=setInterval((function(){if(treeHandle.treeOptions.treeObj.getNodeById(id)){clearInterval(interval);treeHandle.treeOptions.treeObj.openNodeById(id);path.splice(0,1);openNodes(path,callback)}0;0}),50)}else callback()}(path,(function(){httpSiteManagerSrvc.moveSite({ID:site.ID,parentId:selected.ID}).then((function(){treeHandle.treeOptions.treeObj.moveNodeToById(site.ID,selected.ID);treeHandle.onNodeClick(site);site.deviceCount>0&&serv.refreshCount();serv.isSiteChanged=!0}),(function(reason){nbAlertSrvc.error({message:"An error occurred on the server."});$log.error("nbSiteTreeSrvc.js - An error occurred on the server: "+utilitySrvc.getErrorMessage(reason))}))}))}))}))},isShow:isShowMenu,mType:"12"},{template:"Delete",action:function(site){var mes='Are your sure you want to delete the site "'+site.name+'"?';1===site.siteCategory&&(mes='Deleting a container site will delete all its sub sites. Are your sure you want to delete the site "'+site.name+'"?');nbAlertSrvc.confirm({message:mes}).then((function(){treeHandle.treeOptions.treeObj.removeNodeById(site.ID);modifyCount(site.parent,-site.deviceCount);var treeRoot=treeHandle.siteTree;treeRoot.children>1&&modifyCount(treeRoot.children[treeRoot.children.length-1],site.deviceCount);httpSiteManagerSrvc.removeSite(site.ID).then((function(){var rootSite=treeHandle.siteTree;treeHandle.onNodeClick(rootSite)}));serv.isSiteChanged=!0}))},isShow:isShowMenu,mType:"12"}];serv.setDH=function(handle){definitionHandle=handle};serv.setSiteChange=function(isSiteChanged){serv.isSiteChanged=isSiteChanged};serv.setTreeHandle=function(tree){_treeList.push(tree);treeHandle=tree};serv.isSiteChanged=!1;serv.refreshCount=function(){var siteIds=[];var sites={};var root=treeHandle.siteTree;siteIds.push(root.ID);sites[root.ID]=root;!function getAllSite(site){if(site.children&&site.children.length>0){Array.prototype.push.apply(siteIds,_.map(site.children,(function(item){return item.ID})));site.children.forEach((function(item){sites[item.ID]=item;item.isLeaf||getAllSite(item)}))}}(root);httpSiteManagerSrvc.getSiteDeviceCount(siteIds).then((function(data){angular.forEach(data,(function(item){sites[item.ID].deviceCount=item.deviceCount;treeHandle.treeOptions.treeObj.updateNode(item.ID,{deviceCount:item.deviceCount})}));var allCount=root.deviceCount;var siteCount=0;var unAssigined;angular.forEach(root.children,(function(item){3!==item.siteCategory?siteCount+=item.deviceCount:unAssigined=item}));unAssigined&&treeHandle.treeOptions.treeObj.updateNode(unAssigined.ID,{deviceCount:allCount-siteCount})}))};serv.addContainerSite=addContainerSite;serv.addLeafSite=addLeafSite;serv.treeMenu=function(site){serv.saveSite();return _.filter(actionMenu,(function(item){return isShowMenu(site,item)}))};serv.saveSite=function(){var changed=definitionHandle.getChanged();if(_.keys(changed).length<=1){var deferred=$q.defer();deferred.resolve();return deferred.promise}serv.isSitePopertiesChanged=!0;return httpSiteManagerSrvc.modifySite(changed).then((function(){definitionHandle.resetOrgData()}))};serv.refresh=function(){return treeHandle.refresh()};serv.init=function(){return treeHandle.init()};serv.getPath=function(site){var path=[];var temp=site;for(;temp;){path.push(temp.ID);temp=temp.parent}return path.reverse()};serv.expandTo=function(arrPath,objSite){var deferred=$q.defer();$timeout((function(){!function _expandTo(path,site){if(!site){site=treeHandle.siteTree;path.shift()}if(0===path.length){treeHandle.onNodeClick(site);deferred.resolve(site)}else treeHandle.expand(site,!0).then((function(){var siteId=path.shift();var temp=_.find(site.children,(function(item){return siteId===item.ID}));temp?_expandTo(path,temp):_expandTo([],site)}))}(arrPath,objSite)}),10);return deferred.promise};serv.clearAllSite=clearAllSite;return serv}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.importFromFilePopupCtrl",ImportFromFilePopupCtrl);ImportFromFilePopupCtrl.$inject=["$scope","$rootScope","$uibModalInstance","$uibModal","$timeout","nb.common.nbAlertSrvc","msg","managerScope","nb.datamodel.nbSiteTreeSrvc"];function ImportFromFilePopupCtrl($scope,$rootScope,$uibModalInstance,$uibModal,$timeout,nbAlertSrvc,_msg,_managerScope,nsts){var header=_msg.heads;var headerArray=[];$scope.siteProperties=[];$scope.definesitehierarchy=[{selectedkey:""},{selectedkey:""},{selectedkey:""},{selectedkey:""},{selectedkey:""}];$scope.addlevelItem={selectedkey:""};$scope.siteIdentification={selectedDevHostName:"",selectedDevIpAddress:""};for(var key=0;key<=header.length-1;key++)if(header[key]){var value=header[key];headerArray.push(value);$scope.siteProperties.push({title:value,selected:!1})}$scope.onOK=function(){nsts.isSiteChanged=!0;$uibModal.open({templateUrl:"modules/nbDataModel/site/manager/views/importFromFileLoaderPopup.html",controller:"nb.datamodel.importFromFileLoaderPopupCtrl",windowClass:"importFromFileLoaderPopup",backdrop:"static",resolve:{msg:function(){var siteProperties=$scope.siteProperties.filter((function(a){return a.selected}));return{definesitehierarchy:$scope.definesitehierarchy,isRecreated:$scope.isRecreated,siteProperties:siteProperties,siteIdentification:$scope.siteIdentification,filePath:_msg.filePath}},managerScope:function(){return _managerScope}}}).result.then((function(){}),(function(){$uibModalInstance.dismiss()}))};$scope.onCancel=function(argCloseReason){$uibModalInstance.dismiss(null!==argCloseReason?argCloseReason:"Cancel Button Clicked!")};$scope.isRecreated=!1;$scope.options=headerArray;$scope.levelchange=function(item){var isHaveItem=$scope.definesitehierarchy.filter((function(e){return e.selectedkey===item&&""!==item}));if(isHaveItem.length>=2){$timeout((function(){isHaveItem[1].selectedkey=""}),0);nbAlertSrvc.notification({message:"This table column is selected in another Level field."})}};$scope.removelevel=function(item){var newdefinesitehierarchy=[];$scope.definesitehierarchy.forEach((function(e){e!=item&&newdefinesitehierarchy.push(e)}));$scope.definesitehierarchy=newdefinesitehierarchy};$scope.addlevel=function(item){if($scope.definesitehierarchy.length>=20){nbAlertSrvc.warnning({message:"The maximum site hierarchy is 20-level and the site in Level 20 can only be a leaf site.",detail:""})}else{if($scope.definesitehierarchy.filter((function(e){return e.selectedkey===item&&""!==item})).length>=1){nbAlertSrvc.notification({message:"This table column is selected in another Level field.",detail:""})}else $scope.definesitehierarchy.push({selectedkey:item});$scope.addlevelItem.selectedkey=""}};$("body").on("shown.bs.dropdown",(function(){!function(){var menu=angular.element(".open>.dropdown-menu");var dropdown=menu.offsetParent();var bottom=dropdown.position().top+dropdown.height()+menu.height()-31;var tabContent=angular.element(".importFromFilePopup .tab-content")[0];if(!tabContent)return;var height=tabContent.clientHeight;bottom>height&&(tabContent.scrollTop+=bottom-height)}()}))}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.importFromFileLoaderPopupCtrl",ImportFromFileLoaderPopupCtrl);ImportFromFileLoaderPopupCtrl.$inject=["$scope","$uibModalInstance","$timeout","nb.datamodel.httpSiteManagerSrvc","nb.datamodel.nbSiteTreeSrvc","nb.common.nbAlertSrvc","msg"];function ImportFromFileLoaderPopupCtrl($scope,$uibModalInstance,$timeout,httpSiteManagerSrvc,nsts,nbAlertSrvc,msg){httpSiteManagerSrvc.importSiteFromFileProcess(msg).then((function(res){$uibModalInstance.dismiss();nsts.refresh();0==res&&nbAlertSrvc.warnning({message:"The following characters in site names have been replaced:</br> "+NetBrain.NG.Const.valiteFileNameRegTip})}),(function(errorMsg){nbAlertSrvc.error({message:"Failed to import site.</br>"+errorMsg.ResultDesc})}));$scope.$on("importSiteProcess",(function(event,data){angular.element("#ImportSiteProcessMsg").html(data.message)}))}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.siteTreePopupCtrl",SiteTreePopupCtrl);SiteTreePopupCtrl.$inject=["$scope","$uibModalInstance","nb.datamodel.httpSiteManagerSrvc","nb.datamodel.nbSiteTreeSrvc","filter","validate","nb.common.nbAlertSrvc"];function SiteTreePopupCtrl($scope,$uibModalInstance,httpSiteManagerSrvc,nsts,filter,validate,nbAlertSrvc){$scope.onOK=function(){var selected=$scope.selected;if(selected.isLockdownMember){nbAlertSrvc.notification({message:"This site has been locked down so that it cannot be modified.",detail:""})}else{var path=nsts.getPath(selected);selected.path=path;if(validate){var strValidate=validate(selected);if(!0===strValidate)$uibModalInstance.close(selected);else{var option={message:strValidate};nbAlertSrvc.warnning(option)}}else $uibModalInstance.close(selected)}};$scope.onCancel=function(){$uibModalInstance.dismiss("cancel")};$scope.fetch=httpSiteManagerSrvc.getSiteTree;$scope.filter=filter;$scope.treeNodeSelect=function(site){$scope.selected=site}}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.siteProperiesCtrl",SiteProperiesCtrl);SiteProperiesCtrl.$inject=["$scope","$uibModalInstance","$http","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.datamodel.httpSiteManagerSrvc","nb.common.nbAlertSrvc","siteSelected"];function SiteProperiesCtrl($scope,$uibModalInstance,$http,utilitySrvc,httpAuthSrvc,httpSiteManagerSrvc,nbAlertSrvc,siteSelected){$scope.onOK=function(){$scope.SaveSiteProperties()};$scope.onCancel=function(){$uibModalInstance.dismiss()};$scope.SaveSiteProperties=function(){var properties={};properties.ID=siteSelected.ID;properties.Name=$scope.Name;properties.Region=$scope.Region;properties.Location=$scope.Location;properties.EmployeeNumber=$scope.EmployeeNumber;properties.DeviceCount=$scope.DeviceCount;properties.ContactName=$scope.ContactName;properties.PhoneNumber=$scope.PhoneNumber;properties.Email=$scope.Email;properties.Type=$scope.Type;properties.Description=$scope.Description;properties.CustomerAttr=$scope.CustomerAttr;httpSiteManagerSrvc.saveSiteProperties(properties).then((function(){$scope.isExist=!1;$uibModalInstance.close($scope)}),(function(reason){$scope.isExist=!0;nbAlertSrvc.alert(reason);$uibModalInstance.close($scope)}))};$scope.Getdata=function(){httpSiteManagerSrvc.getSitePropertiesBySiteID(siteSelected.ID).then((function(data){if(angular.isDefined(data)){$scope.oldName=data.name;$scope.Name=siteSelected.name;$scope.Region=data.region;$scope.Location=data.location;data.employeeNumber&&($scope.EmployeeNumber=data.employeeNumber);$scope.DeviceCount=data.deviceCount;$scope.ContactName=data.contactName;$scope.PhoneNumber=data.phoneNumber;$scope.Email=data.email;data.type&&($scope.Type=data.type);$scope.Description=data.description;$scope.CustomerAttr=data.customerAttr;0===$scope.CustomerAttr.length&&($scope.CustomerAttr=[{name:"Field1",value:""},{name:"Field2",value:""},{name:"Field3",value:""}])}}))};$scope.continerHeightMax="620px";$scope.onSiteInformationDisplay=function(){$scope.siteInformationShow=!$scope.siteInformationShow;if($scope.siteInformationShow){$scope.imgSiteInformation="img/Assets/Zoom_Out_Button_16x16.png";$scope.continerHeightMax="620px";document.querySelector('[ng-init="Getdata()"]').style.height=$scope.continerHeightMax}else{$scope.imgSiteInformation="img/Assets/Zoom_In_Button_16x16.png";$scope.continerHeightMax="260px";document.querySelector('[ng-init="Getdata()"]').style.height=$scope.continerHeightMax}};$scope.onCusInformationsDisplay=function(){$scope.cusInformationsShow=!$scope.cusInformationsShow;$scope.cusInformationsShow?$scope.imgCusInformations="img/Assets/Zoom_Out_Button_16x16.png":$scope.imgCusInformations="img/Assets/Zoom_In_Button_16x16.png"};$scope.imgSiteInformation="img/Assets/Zoom_Out_Button_16x16.png";$scope.imgCusInformations="img/Assets/Zoom_In_Button_16x16.png";$scope.siteInformationShow=!0;$scope.cusInformationsShow=!1;$scope.Name="";$scope.Region="";$scope.Location="";$scope.EmployeeNumber=0;$scope.DeviceCount="";$scope.PhoneNumber="";$scope.Email="";$scope.Type="";$scope.TypeSelect=["Headerquarter","Data Center","Regional Office","Disaster Recovery"];$scope.Description="";$scope.CustomerAttr=[];$scope.NameDisabled=!0;$scope.DeviceCountDisabled=!0}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.exportToSpreadsheetCtrl",ExportToSpreadsheetCtrl);ExportToSpreadsheetCtrl.$inject=["$scope","$uibModalInstance","$http","nb.ng.utilitySrvc","nb.common.nbAlertSrvc","nb.ng.httpAuthSrvc","nb.datamodel.httpSiteManagerSrvc","nb.ng.httpDownloadingSrvc"];function ExportToSpreadsheetCtrl($scope,$uibModalInstance,$http,utilitySrvc,nbAlertSrvc,httpAuthSrvc,httpSiteManagerSrvc,httpDownloadingSrvc){var EXPORT_FILE_TYPE_Excel=1,EXPORT_FILE_TYPE_Csv=2;$scope.SpreadsheetFormatClick=function(val){$scope.SpreadsheetFormat=val};$scope.exportQuantityClick=function(val){$scope.exportQuantity=val};$scope.onOK=function(){$scope.downloadFileDisplay=!1;$scope.downloadFilePath="";var fileType="Excel"===$scope.SpreadsheetFormat?EXPORT_FILE_TYPE_Excel:EXPORT_FILE_TYPE_Csv;httpDownloadingSrvc.getTicket().then((function(ticket){var url=NetBrain.NG.ConfigSettings.API_ROOT+"site-manager/export-to-spreadsheet";url+="?dl_ticket="+ticket+"&TenantGuid="+httpAuthSrvc.getSelectedTenantId()+"&DomainGuid="+httpAuthSrvc.getSelectedDomainIds()[0];var expParams={useTemporaryStorage:!0,exportQuantity:$scope.exportQuantity,exportFileType:fileType};httpDownloadingSrvc.downloadFileByPost(url,expParams)}),(function(){nbAlertSrvc.alert("failed to get downloading ticket...")}))};$scope.onCancel=function(){$uibModalInstance.dismiss()};$scope.downloadFileDisplay=!1;$scope.downloadFilePath="";$scope.SpreadsheetFormat="Excel";$scope.exportQuantity="1"}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.siteDefinitionCtrl",SiteDefinitionCtrl);SiteDefinitionCtrl.$inject=["$scope","$log","$uibModal","$timeout","nb.datamodel.httpSiteManagerSrvc","nb.systemmodel.deviceSchemaMgrSrvc","nb.common.nbAlertSrvc","nb.ng.nbValidationSrvc"];function SiteDefinitionCtrl($scope,$log,$uibModal,$timeout,httpSiteManagerSrvc,deviceSchemaMgrSrvc,nbAlertSrvc,nbValidationSrvc){var SITE_MEMBERS_CHANGED_EVENT_NAME="siteMembersChanged";var deviceTypeDefined={add:{code:1,description:"Manually Added"},search:{code:2,description:"Searched"},exclude:{code:3,description:"Excluded"},getTypeDescription:function(typeCode){return this[typeCode]&&this[typeCode].description||"unknown"},isSearched:function(device){return device.type===this.search.code},init:function(){var code;Object.getOwnPropertyNames(this).forEach((function(key){(code=this[key].code)&&(this[code]=this[key])}),this)}};deviceTypeDefined.init();var siteCategory={root:0,container:1,leaf:2,unassign:3,isLeafSite:function(site){return site.siteCategory===this.leaf}};var dataTpl={ID:"",name:"",description:"",isLockdownMember:!1,filter:null};var filterTpl={Conditions:[{Schema:"",Operator:"",Expression:""}],Expression:""};var orgData=null;!function(){$scope.isDsdisabled=!0;$scope.dsIsShow=!0;$scope.lsCandidateSchemas=[];$scope.dyFilter=null}();!function(){$scope.dsIsShow&&($scope.gridOptions={enableSorting:!1,enableColumnMenus:!1,enableColumnResizing:!0,enableRowSelection:!0,enableRowHeaderSelection:!1,enableFullRowSelection:!0,enableRowActionMenu:!0,rowActionMenuItems:updateMenuItems,enableRowContextMenu:!0,rowContextMenuItems:updateMenuItems,columnDefs:[{name:"typeStr",displayName:"Device",grouping:{groupPriority:0},enableSorting:!0,width:"40%",cellTemplate:'<div><div ng-if="!col.grouping  || ( row.groupHeader && col.grouping.groupPriority === row.treeLevel )" class="ui-grid-cell-contents" title="TOOLTIP">{{COL_FIELD CUSTOM_FILTERS}}</div> <div ng-if="col.grouping" class="ui-grid-cell-contents" title="TOOLTIP">{{row.entity.deviceName}}</div></div>'},{name:"model",displayName:"Model"},{name:"mgmtIP",displayName:"Management IP"},{name:"location",displayName:"Location"}],rowTemplate:'<div nb-context-menu-directive="grid.appScope.setGridContextMenu(row)" context-menu-disabled="grid.appScope.isDisableGridContextMenu(row)" data-target="gridContextMenu" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns" class="ui-grid-cell"  ui-grid-cell></div>',onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$(window).resize((function(){$scope.gridApi.core.handleWindowResize()}))}});$scope.setGridContextMenu=function(currentRow){(function(currentRow){return-1===getSelectedRows().indexOf(currentRow)})(currentRow)&&function(currentRow){$scope.gridApi.selection.clearSelectedRows();$scope.gridApi.selection.selectRow(currentRow.entity)}(currentRow);updateMenuItems()};$scope.isDisableGridContextMenu=function(currentRow){return $scope.val.isLockdownMember||!0===currentRow.groupHeader};function updateMenuItems(){var hasSearched=getSelectedRows().some((function(row){return deviceTypeDefined.isSearched(row.entity)}));$scope.menuOptions=[];hasSearched?$scope.menuOptions.push({name:"Exclude",action:function(){!function(){$scope.$parent.setSiteChange(!0);doAction(httpSiteManagerSrvc.excludeSiteMembers)}()},template:"Exclude"}):$scope.menuOptions.push({name:"Delete",action:function(){!function(){$scope.$parent.setSiteChange(!0);doAction(httpSiteManagerSrvc.deleteSiteMembers)}()},template:"Delete"});return $scope.menuOptions}function getSelectedRows(){return $scope.gridApi.selection.getSelectedGridRows()}function doAction(action){action($scope.val,getSelectedRows().map((function(row){return row.entity}))).then((function(response){response?function(){doRefreshGridData();siteMembersChanged()}():logError(response)}),logError)}}();$scope.preCriteria={criteriaList:[],expr:""};$scope.$parent.setDefinitionHandle($scope);$scope.$on("showDefinition",(function(nbEvent,site){$scope.val=site;$scope.val.description||($scope.val.description="");$scope.val.isLockdownMember=site.isLockdownMember||!1;$scope.isDsdisabled=site.isLockdownMember||!1;$scope.val.filter&&$scope.val.filter.Conditions&&$scope.val.filter.Conditions.length>0||($scope.val.filter=angular.copy(filterTpl));$scope.dyFilter=$scope.val.filter;_setPreCriteria();orgData=angular.copy(_.extend(dataTpl,_.pick(site,"name","properties","description","isLockdownMember","filter")));refreshGridData();-1===$scope.val.ID?$scope.siteName=$scope.val.name:httpSiteManagerSrvc.getSiteDefinition($scope.val.ID).then((function(data){if(angular.isDefined(data)){var result=data;$scope.val.description=result.description;result.filter&&result.filter.Conditions&&result.filter.Conditions.length>0?$scope.dyFilter=result.filter:$scope.dyFilter=angular.copy(filterTpl);_setPreCriteria();orgData.description=result.description;orgData.filter=angular.copy($scope.dyFilter)}}))}));$scope.getChanged=function(){var changed={};if(null===orgData)return changed;var curData=$scope.val;$scope.dyFilter={Conditions:angular.copy($scope.preCriteria.criteriaList),Expression:$scope.preCriteria.expr};curData.filter=$scope.dyFilter;angular.forEach(orgData,(function(orgValue,key){if(angular.isObject(orgValue)){var realOrgValueFilter=angular.copy(orgValue);for(var i=0;i<realOrgValueFilter.Conditions.length;i++){delete realOrgValueFilter.Conditions[i].operators;""===realOrgValueFilter.Conditions[i].Schema&&realOrgValueFilter.Conditions.splice(i,1)}var realFilter=angular.copy(curData[key]);for(var j=0;j<realFilter.Conditions.length;j++){delete realFilter.Conditions[j].operators;delete realFilter.Conditions[j].isDeviceTypeTreeShown;""===realFilter.Conditions[j].Schema&&realFilter.Conditions.splice(j,1)}realOrgValueFilter&&!_.isEqual(realOrgValueFilter,realFilter)&&(changed[key]=realFilter)}else{if(!0==!orgValue&&!0==!curData[key])return;orgValue!=curData[key]&&(changed[key]=curData[key])}}));return changed};$scope.resetOrgData=function(){(orgData=angular.copy(_.pick($scope.val,"name","properties","description","isLockdownMember","filter"))).ID=""};$scope.onVerifyName=function(){var node=$scope.val;var list=node.parent.children;var count=0;angular.forEach(list,(function(item){if(item.name===node.name&&item.siteCategory===node.siteCategory&&++count>1){node.name=orgData.name;nbAlertSrvc.warnning({message:"This destination already contains a site with the same name.",detail:""})}}));nbValidationSrvc.getValidator("generalForbidChars");if(NetBrain.NG.Const.valiteFileNameReg.test(node.name)){node.name=orgData.name;nbAlertSrvc.warnning({message:"A site name can't contain any of the following characters: "+NetBrain.NG.Const.valiteFileNameRegTip})}var name=node.name.replace(/^\s+|\s+$/g,"");if("my network"===name.toLocaleLowerCase()||"unassigned"===name.toLocaleLowerCase()){node.name=orgData.name;nbAlertSrvc.warnning({message:"The following words and phrases (case-insensitive) cannot be used in naming a new site.<ul style='list-style:disc;padding-left: 27px;width: 150px;'><li style='list-style:disc'>My Network</li><li style='list-style:disc'>Unassigned</li></ul>",detail:""})}else if(""===$scope.val.name){$scope.val.name=orgData.name;nbAlertSrvc.warnning({message:"Please enter a site name.",detail:""})}};$scope.onLockNumberCheck=function(){httpSiteManagerSrvc.updateLockdownMember($scope.val.ID,$scope.val.isLockdownMember)};$scope.setLockNumber=function(){$scope.$parent.setSiteChange(!0)};$scope.onProperties=function(){if(-1!=$scope.siteTree.selected.ID&&"My Network"!==$scope.siteTree.selected.name){$uibModal.open({templateUrl:"modules/nbDataModel/site/manager/views/siteProperties.html",controller:"nb.datamodel.siteProperiesCtrl",windowClass:"siteProperties",backdrop:"static",resolve:{siteSelected:function(){return $scope.siteTree.selected}}}).result.then((function(scope){$scope.val.description=scope.Description;scope.isExist&&($scope.val.name=orgData.name);$scope.$emit("sitePropertiesChanged","true")}))}};function _setPreCriteria(){$scope.preCriteria.criteriaList.splice(0,$scope.preCriteria.criteriaList.length);_.each($scope.dyFilter.Conditions,(function(item){$scope.preCriteria.criteriaList.push(item)}));($scope.preCriteria.criteriaList instanceof Array&&$scope.preCriteria.criteriaList.length<=0||""!=$scope.preCriteria.criteriaList[$scope.preCriteria.criteriaList.length-1].Schema)&&$scope.preCriteria.criteriaList.push({Schema:"",Operator:"",Expression:""});$scope.preCriteria.expr=$scope.dyFilter.Expression}$scope.popSelectDeviceModal=function(type){$scope.selectDeviceModal=$uibModal.open({templateUrl:"modules/nbDataModel/common/views/selectDevicePopup.html",controller:"nb.datamodel.selectDevicePopupCtrl",windowClass:"selectDevicePopup",backdrop:"static",resolve:{singleSelectionOnly:function(){return!1},initDevices:function(){return[]}}}).result.then((function(lsSelectedDevices){var devices=_.map(lsSelectedDevices,(function(item){return item.ID}));$scope.$parent.setSiteChange(!0);"add"===type?httpSiteManagerSrvc.getDeviceSiteInfo(devices).then((function(data){var result=data;var addList=[];var conflictList=[];angular.forEach(result,(function(item){"-1"===item.siteId?addList.push(item):$scope.val.ID===item.siteId?addList.push(item):conflictList.push(item)}));conflictList.length>0?showConflict(conflictList,addList):addDevice(addList,[])})):httpSiteManagerSrvc.addExcludedMember($scope.val.ID,devices).then((function(){doRefreshGridData()}),(function(){}))}),(function(){}))};function siteMembersChanged(){$scope.$emit(SITE_MEMBERS_CHANGED_EVENT_NAME);$scope.$parent.refreshCount()}function refreshGridData(){clearGridData();doRefreshGridData()}function clearGridData(){$scope.gridOptions.data=[]}function doRefreshGridData(){var site=$scope.val;siteCategory.isLeafSite(site)?httpSiteManagerSrvc.getSiteDeviceBySiteID(site.ID,1).then((function(result){if(result){!function(data){!function(data){_.each(data,(function(item){item.typeStr=deviceTypeDefined.getTypeDescription(item.type)}))}(data);data=_.sortBy(data,(function(item){return item.type}));$scope.gridOptions.data=data;data&&data.length>0&&$timeout((function(){$scope.gridApi.treeBase.expandAllRows()}),500)}(result.memberList);$scope.$parent.refreshCount()}}),(function(reason){clearGridData();logError(reason)})):$scope.isDsdisabled=!0}function logError(reason){$log.debug(reason)}$scope.onSearch=function(){siteMembersChanged();$scope.dyFilter={Conditions:angular.copy($scope.preCriteria.criteriaList),Expression:$scope.preCriteria.expr};if(function(conditions){var searchCriteriaHasEmptyValue=!1;var condition=null;for(var i=0;i<conditions.length;i++)if((condition=conditions[i])&&condition.Schema.length>0&&0==condition.Expression.length){if("proxyServer"===condition.Schema)continue;searchCriteriaHasEmptyValue=!0;break}return searchCriteriaHasEmptyValue}($scope.dyFilter.Conditions))nbAlertSrvc.error({message:"Search criteria is required."});else{var cloneDyFilter=angular.copy($scope.dyFilter);var conditions=cloneDyFilter.Conditions;var len=conditions.length;""===conditions[len-1].Schema&&1!==len&&conditions.pop();httpSiteManagerSrvc.getDynamicSearchWithAction($scope.val.ID,cloneDyFilter).then((function(result){if(result.length>0){var conflict=_.filter(result,(function(item){return($scope.val.ID!==item.siteId||1!==item.type&&2!==item.type)&&(3!==item.type&&"-1"!==item.siteId)}));if(conflict.length>0)showConflict(conflict,[],cloneDyFilter);else{refreshGridData();$scope.$parent.refreshCount()}}else{refreshGridData();nbAlertSrvc.notification({message:"No items match your search.",detail:""})}}),(function(){}))}};function showConflict(devices,arrConcat,DyFilter){$scope.selectDeviceModal=$uibModal.open({templateUrl:"modules/nbDataModel/site/manager/views/deviceConflict.html",controller:"nb.datamodel.deviceConflictCtrl",windowClass:"siteConflict",backdrop:"static",resolve:{deviceData:function(){return devices}}}).result.then((function(lsSelectedDevices){DyFilter?function(devices,arrConcat,DyFilter){var addDevices=_.map(devices,(function(item){return item.deviceId}));(arrConcat=_.map(arrConcat,(function(item){return item.deviceId})))&&(addDevices=addDevices.concat(arrConcat));httpSiteManagerSrvc.dynamicSearchAndAutoAdd($scope.val.ID,DyFilter,addDevices).then((function(){refreshGridData();$scope.$parent.refreshCount()}),(function(){refreshGridData();$scope.$parent.refreshCount()}))}(lsSelectedDevices,arrConcat,DyFilter):addDevice(lsSelectedDevices,arrConcat)}),(function(){refreshGridData();$scope.$parent.refreshCount()}))}function addDevice(devices,arrConcat){var addDevices=_.map(devices,(function(item){return item.deviceId}));(arrConcat=_.map(arrConcat,(function(item){return item.deviceId})))&&(addDevices=addDevices.concat(arrConcat));0!==addDevices.length?httpSiteManagerSrvc.addSiteMember($scope.val.ID,addDevices).then((function(){refreshGridData();$scope.$parent.refreshCount()}),(function(){refreshGridData();$scope.$parent.refreshCount()})):refreshGridData()}$scope.$watch("val.isLockdownMember",(function(val){$scope.val&&($scope.isDsdisabled=2!==$scope.val.siteCategory||val)}))}}(NetBrain);!function(netbrain){angular.module("nb.datamodel").controller("nb.datamodel.deviceConflictCtrl",DeviceConflictCtrl);DeviceConflictCtrl.$inject=["$scope","$uibModalInstance","deviceData"];function DeviceConflictCtrl($scope,$uibModalInstance,deviceData){$scope.onOK=function(){$uibModalInstance.close(_.filter($scope.data,(function(item){return item.isMove})))};$scope.onCancel=function(){$uibModalInstance.dismiss("cancel")};!function(){$scope.data=_.filter(deviceData,(function(item){item.isMove=!0;item.isKeep=!1;if(1===item.type)item.typeStr="Static Add";else{if(2!==item.type)return!1;item.typeStr="Dynamic Search"}return!0}));$scope.gridOptions={enableSorting:!1,data:$scope.data,columnDefs:[{name:"deviceName",width:"20%",displayName:"Device"},{name:"siteName",width:"20%",displayName:"Already in Site"},{name:"typeStr",width:"20%",displayName:"Type"},{name:"isMove",width:"20%",displayName:"Move to Current Site",cellTemplate:'<div class="ui-grid-cell-contents" ><input type="checkbox" ng-click="row.entity.isKeep = !row.entity.isKeep" ng-model="row.entity.isMove" /></div>'},{name:"isKeep",width:"20%",displayName:"Keep in Original Site",cellTemplate:'<div class="ui-grid-cell-contents" ><input type="checkbox" ng-click="row.entity.isMove = !row.entity.isMove" ng-model="row.entity.isKeep" /></div>'}],onRegisterApi:function(gridApi){$scope.gridApi=gridApi}}}()}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.siteMembersCtrl",SiteMembersCtrl);SiteMembersCtrl.$inject=["$scope","$uibModal","$timeout","$log","nb.datamodel.httpSiteManagerSrvc","nb.common.nbAddToDeviceGroupModalSrvc"];function SiteMembersCtrl(){new SiteMembersLogical(arguments).init()}function SiteMembersLogical(args){var siteCategory={root:0,container:1,leaf:2,unassign:3,isLeafSite:function(site){return site.siteCategory===this.leaf},isUnassignSite:function(site){return site.siteCategory===this.unassign}};var SHOW_SITE_MEMBERS_EVENT_NAME="showMemberDevices";var SITE_MEMBERS_CHANGED_EVENT_NAME="siteMembersChanged";var model;var scope,modal,logger,siteMembersService;var nbAddToDeviceGroupModal;(function($scope,$uibModal,$timeout,$log,httpSiteManagerSrvc,nbAddToDeviceGroupModalSrvc){scope=$scope;modal=$uibModal;logger=$log;siteMembersService=httpSiteManagerSrvc;nbAddToDeviceGroupModal=nbAddToDeviceGroupModalSrvc}).apply(null,args);this.init=function(){model=scope.lmSiteMembers=function(){return{options:{useTestData:!1,gridOptions:{onRegisterApi:function(gridApi){model.siteMembersGridApi=gridApi;!function(){var events=model.siteMembersGridApi.infiniteScroll.on;events.needLoadMoreData(scope,(function(){logger.debug("scroll to bottom")}));events.needLoadMoreDataTop(scope,(function(){logger.debug("scroll to top")}))}()},data:"lmSiteMembers.dataSources.members",rowTemplate:'<div ng-repeat="col in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ui-grid-cell data-target="contextMenu" nb-context-menu-directive="grid.appScope.lmSiteMembers.handlers.onShowContextMenu(row)" context-menu-disabled="grid.appScope.lmSiteMembers.handlers.disableContextMenu()" /><div>',columnDefs:[{field:"deviceName",displayName:"Device",enableSorting:!1},{field:"mgmtIP",displayName:"ManagementIP",enableSorting:!1},{field:"location",displayName:"Location",enableSorting:!1},{field:"staticSiteJoined",displayName:"Static Site",enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents ng-scope" style="cursor: pointer;"  title="{{COL_FIELD}}"><img ng-src="{{row.entity.imgIcon}}" width="16px"> <span ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget">{{COL_FIELD}}</span></div>'}],enableRowSelection:!0,enableRowHeaderSelection:!1,enableFullRowSelection:!0,enableColumnResizing:!0,enableColumnMenus:!1},contextMenuItems:function(){return[{name:"Add to Site",action:function(){(function(){var popOption={templateUrl:"modules/nbDataModel/site/manager/views/siteTree.html",controller:"nb.datamodel.siteTreePopupCtrl",windowClass:"siteTreePopup",backdrop:"static",keyboard:!0,resolve:createSiteSelectorResolve()};return modal.open(popOption);function createSiteSelectorResolve(){return{filter:function(){return isNotUnassignSite},validate:function(){return isLeafSiteValidator}};function isNotUnassignSite(site){return!siteCategory.isUnassignSite(site)}function isLeafSiteValidator(site){return siteCategory.isLeafSite(site)||"Cannot add device into a Container Site or an Unssigned Site. Please select a Leaf Site to add device."}}})().result.then((function(targetSite){!function(targetSite){var params={sourceSite:model.currentSite,targetSite:targetSite,devices:getSelectedMembers()};handleInvokResult(siteMembersService.addToSite(params))}(targetSite)}),logError)},enableSiteCategories:[!1,!1,!0,!0,!0],enableDeviceType:[!0,!0,!0]},{name:"Add to Group",action:function(){devIds=getSelectedMembers().map((function(e){return e.deviceId})),nbAddToDeviceGroupModal.showModal(devIds);var devIds},enableSiteCategories:[!1,!1,!0,!0,!0],enableDeviceType:[!0,!0,!0]},{name:"Delete",action:excludeOrDeleteHandler,enableSiteCategories:[!1,!1,!0,!1,!1],enableDeviceType:[!0,!1,!0]},{name:"Exclude",action:excludeOrDeleteHandler,enableSiteCategories:[!1,!1,!0,!1,!1],enableDeviceType:[!1,!0,!1]}];function handleInvokResult(promise){promise.then((function(){!function(){resetData();!function(){scope.$emit(SITE_MEMBERS_CHANGED_EVENT_NAME);scope.$parent.refreshCount()}()}()}),logError)}function excludeOrDeleteHandler(){var site=model.currentSite;var members=getSelectedMembers();var deleteMembers=_.reject(members,(function(item){return 2===item.type}));var excludeMembers=members.filter((function(item){return 2===item.type}));var promise;deleteMembers.length>0&&(promise=siteMembersService.deleteSiteMembers(site,deleteMembers));excludeMembers.length>0&&(promise=siteMembersService.excludeSiteMembers(site,excludeMembers));handleInvokResult(promise)}function getSelectedMembers(){return getSelectedRows().map((function(row){return row.entity}))}}()},dataSources:{members:[]},handlers:{onShowContextMenu:function(currentRow){(function(currentRow){var selectedRows=getSelectedRows();return item=currentRow,-1!==selectedRows.indexOf(item);var item})(currentRow)||function(currentRow){model.siteMembersGridApi.selection.clearSelectedRows();model.siteMembersGridApi.selection.selectRow(currentRow.entity)}(currentRow);!function(currentRow){var category=model.currentSite.siteCategory;var devType=currentRow.entity.type;var selectRows=model.siteMembersGridApi.selection.getSelectedRows();if(selectRows.length>1){var excludeRow=_.find(selectRows,(function(item){return 2===item.type}));excludeRow&&(devType=excludeRow.type)}model.currentContextMenuItems=model.options.contextMenuItems.filter((function(item){return item.enableSiteCategories[category]})).filter((function(item){return item.enableDeviceType[devType-1]}))}(currentRow)},disableContextMenu:function(){var site=model.currentSite;return site.siteCategory<2||site.isLockDown}},status:{isScrollHandlerBinded:!1,isProcessingScrolling:!1}};function getSelectedRows(){return model.siteMembersGridApi.selection.getSelectedGridRows()}}();eventName=SHOW_SITE_MEMBERS_EVENT_NAME,handler=function(event,site){model.currentSite=site;scope.lockDownMember=site.isLockdownMember;resetData()},scope.$on(eventName,handler);var eventName,handler};function resetData(){clearData();loadNextPage()}function clearData(){model.dataSources.members=[];model.pageInfo={pageIndex:0,pageSize:60,records:null}}function loadNextPage(){if(void 0!==model.currentSite&&!((pageInfo=model.pageInfo).records&&pageInfo.pageSize*pageInfo.pageIndex>=pageInfo.records)){var pageInfo;model.status.isProcessingScrolling=!0;var paramsObj={site:model.currentSite,pageIndex:model.pageInfo.pageIndex,pageSize:model.pageInfo.pageSize,useTestData:model.options.useTestData};siteMembersService.getValidMembersOfSite(paramsObj).then((function(response){!function(response,params){if(model.currentSite.ID!==params.site.ID)return;var result=function(res){if(res){res.memberList.forEach((function(member){member.staticSite?member.staticSiteJoined=member.staticSite.join("\\"):member.staticSiteJoined=""}));return res}return{memberList:[],totalCount:0}}(response);if(model.currentSite.ID===params.site.ID&&model.dataSources.members.length>0&&model.dataSources.members[0].deviceId===result.memberList[0].deviceId)return;devices=result.memberList,dataSources=model.dataSources,dataSources.members=dataSources.members.concat(devices);var devices,dataSources;!function(records){model.pageInfo.records=records;model.pageInfo.pageIndex++}(result.totalCount);!function(){if(!model.status.isScrollHandlerBinded){(gridBody=angular.element("#siteMembersGrid .ui-grid-viewport")).bind("scroll",(function(){if(!model.status.isProcessingScrolling){((el=gridBody.get(0)).scrollTop+el.offsetHeight)/(el.scrollHeight+.1)-.001>=.9&&loadNextPage();var el}}));model.status.isScrollHandlerBinded=!0}var gridBody}();model.status.isProcessingScrolling=!1}(response,paramsObj)}),(function(reason){clearData();logError(reason)}))}}function logError(reason){logger.debug(reason)}}}(NetBrain);function SitePropertie(){}SitePropertie.prototype.getSitePropertieById=function(siteId){if(null==siteId)return null;if(null==this.sitePropertieList)return null;for(var i=0;i<this.sitePropertieList.length;i++){var sitePropertie=this.sitePropertieList[i];if(sitePropertie.ID===siteId)return sitePropertie}return null};!function(netBrain){angular.module("nb.datamodel").factory("nb.datamodel.httpNetworkDefinitionSrvc",HttpNetworkDefinitionSrvc);HttpNetworkDefinitionSrvc.$inject=["nb.ng.nbHttp"];function HttpNetworkDefinitionSrvc(nbHttp){function ajax(url,method,requestData){return nbHttp[method.toLowerCase()](url,requestData)}function post(url,requestData){return ajax(url,"POST",requestData)}function get(url,requestData){return ajax(url,"GET",requestData)}return{listNetworkDefinition:function(){return get("Admin/Domain/getAllNetworkDef",null)},listDeviceType:function(data){},saveNetworkDefinition:function(saveDatas){return post("Admin/Domain/upInsertNetworkDef",saveDatas)},removeNetworkDefinition:function(data){return post("Admin/Domain/removeNetworkDef",data)},getChangeDevices:function(data){return post("Admin/Domain/getChangeDevicesByNetworkDef",data)},applyNetworkDefToDevices:function(data){return post("Admin/Domain/applyNetworkDefToDevices",data)},getAllDevTypes:function(data){return get("Device/DeviceType",data)}}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.networkDefinitionCtrl",NetworkDefinitionCtrl);NetworkDefinitionCtrl.$inject=["$scope","$uibModal","$uibModalInstance","$log","nb.datamodel.httpNetworkDefinitionSrvc","nb.systemmodel.systemVendorModelMgr","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.httpDownloadingSrvc","nb.ng.inputFileSrvc"];function NetworkDefinitionCtrl($scope,$uibModal,$uibModalInstance,$log,httpNetworkDefinitionSrvc,systemVendorModelMgr,nbAlertSrvc,utilitySrvc,httpDownloadingSrvc,inputFileSrvc){$scope.onClose=function(){$uibModalInstance.dismiss()};$scope.onAdd=function(){$scope.openNetworkDefinitionForm(!0)};$scope.onEdit=function(){$scope.openNetworkDefinitionForm(!1)};$scope.value=!0;$scope.onDelete=function(){if($scope.getSelectedRowsCount()){if(confirm("Are you sure to delete?")){var ids=_.map(grid.getSelectedRows(),(function(item){return item.ID}));httpNetworkDefinitionSrvc.removeNetworkDefinition(ids).then((function(jsonData){"0"==jsonData.results.opCode?ids.forEach((function(val){grid.removeRow({ID:val})})):nbAlertSrvc.error({message:jsonData.results.msg})}),(function(reason){nbAlertSrvc.error({message:"An erroroccurred on the server."});$log.error("networkDefinitionCtrl.js - Error from server: "+utilitySrvc.getErrorMessage(reason))}))}}else nbAlertSrvc.error({message:"Please select at least one item."})};$scope.onExportToCsv=function(){var data=[];data.push(["Hostname","Is Regular Match","IP Address","Device Type","Driver"]);for(var i=0;i<grid.getGridRows().length;i++){var tempArr=[];tempArr.push(grid.getGridRows()[i].devNameExp);tempArr.push(grid.getGridRows()[i].isRegx?"Yes":"No");tempArr.push(grid.getGridRows()[i].ipAddrRange);tempArr.push(grid.getGridRows()[i].devSubTypeName);tempArr.push(grid.getGridRows()[i].devDriverName.replace(/\{[\w\-]+\}/,""));data.push(tempArr)}httpDownloadingSrvc.exportToCsv(data,"ND table")};$scope.onApplyToWorkspace=function(){httpNetworkDefinitionSrvc.getChangeDevices(grid.getSelectedRows()).then((function(jsonData){jsonData.results.length&&$scope.openApplyToWorkspaceDialog(jsonData.results)}),(function(reason){nbAlertSrvc.error({message:"An erroroccurred on the server."});$log.error("networkDefinitionCtrl.js - Error from server: "+utilitySrvc.getErrorMessage(reason))}))};$scope.onImportCsv=function(){inputFileSrvc.createInputFile({scope:$scope,fileAccept:".csv",fileChange:"importNetworkDefinitionCsv"})};$scope.importNetworkDefinitionCsv=function(files){var reader=new FileReader;reader.onload=function(){var fileData=$.csv.toArrays(reader.result);if(!(fileData.length<=0)){var msg="",saveDatas=[];systemVendorModelMgr.getDeviceTypeTree().then((function(list){if(list&&list.length){for(var i=1,len=fileData.length;i<len;i++){var data=buildSaveData(fileData,i,list);data.msg&&(msg+=data.msg);msg||saveDatas.push(data.saveData)}msg?nbAlertSrvc.error({message:"Some items are invalid:\n"+msg}):httpNetworkDefinitionSrvc.saveNetworkDefinition(saveDatas).then((function(jsonData){"0"==jsonData.results.opCode?grid.addRows(saveDatas):nbAlertSrvc.error({message:jsonData.results.msg})}),(function(reason){nbAlertSrvc.error({message:"An erroroccurred on the server."});$log.error("networkDefinitionCtrl.js - Error from server: "+utilitySrvc.getErrorMessage(reason))}))}else nbAlertSrvc.error({message:"An error occurred on the server."})}))}};reader.readAsText(files[0])};function buildSaveData(fileData,index,list){var data=fileData[index],saveData={},msg="";data[0].trim()||data[2].trim()||(msg+="Hostname and IP can not be all empty.Line:"+(index+1)+"\n");if(data[2].trim()){var m=function(ipAddress){var ips=ipAddress.split(/[,-]/);for(var i=0,len=ips.length;i<len;i++){var ip=ips[i];if(!utilitySrvc.isIpOrIpMask(ip))return"IP range is invalid."}}(data[2].trim());m&&(msg+=m+"Line:"+(index+1)+"\n")}if(!data[3].trim()||!data[4].trim())return{msg:msg+="Device type or driver doesn't exist.Line:"+(index+1)+"\n",saveData:saveData};var deviceType=_.find(list,(function(item){return item.deviceType==data[3].trim()}));if(!deviceType)return{msg:msg+="Device type or driver doesn't exist.Line:"+(index+1)+"\n",saveData:saveData};saveData.devSubType=deviceType.deviceTypeID;var driver=_.find(deviceType.drivers,(function(item){return item.driver==data[4].trim()}));if(!driver)return{msg:msg+="Device type or driver doesn't exist.Line:"+(index+1)+"\n",saveData:saveData};saveData.driverId=driver.driverID;saveData.ID=utilitySrvc.getGUID();saveData.devNameExp=data[0].trim();saveData.isRegx="yes"==data[1].trim().toLocaleLowerCase();saveData.ipAddrRange=data[2].trim();saveData.devSubTypeName=data[3].trim();saveData.devDriverName=data[4].trim();return{msg:msg,saveData:saveData}}$scope.openNetworkDefinitionForm=function(flag){$scope.networkDefinitionForm=$uibModal.open({templateUrl:"modules/nbDataModel/networkDefinition/views/networkDefinitionForm.html",controller:"nb.datamodel.networkDefinitionFormCtrl",backdrop:!1,size:"sm",resolve:{resolveData:function(){return{context:$scope,selectedRow:flag?null:grid.getSelectedRows()[0]}}}});$scope.networkDefinitionForm.result.then((function(scope){if("ok"==scope.formAction){var newData=scope.saveData;var data=_.find(grid.getGridRows(),(function(item){return item.ID==newData.ID}));data?function(source,target){for(var key in target)source[key]=target[key]}(data,newData):grid.addRow(newData)}}))};$scope.openApplyToWorkspaceDialog=function(data){$scope.networkDefinitionApply=$uibModal.open({templateUrl:"modules/nbDataModel/networkDefinition/views/networkDefinitionApply.html",controller:"nb.datamodel.networkDefinitionApplyCtrl",backdrop:!1,size:"sm",resolve:{resolveData:function(){return{context:$scope,data:data}}}})};var grid={setting:function(){$scope.gridOptions_networkDefinition={data:[],columnDefs:[{field:"devNameExp",displayName:"Hostname",width:"20%"},{field:"ipAddrRange",displayName:"IP Address",width:"30%"},{field:"devSubTypeName",displayName:"Device Type",width:"20%"},{field:"devDriverName",displayName:"Driver",width:"30%"}],enableFullRowSelection:!0,enableRowHeaderSelection:!1,multiSelect:!0,autoHeight:!0,enableColumnResize:!0};$scope.gridOptions_networkDefinition.onRegisterApi=function(gridApi){$scope.gridApi=gridApi};$scope.getSelectedRowsCount=function(){return $scope.gridApi.selection.getSelectedRows().length};$scope.getGridRowsCount=function(){return $scope.gridOptions_networkDefinition.data.length}},addRow:function(row){$scope.gridOptions_networkDefinition.data.push(row)},addRows:function(rows){$scope.gridOptions_networkDefinition.data.push.apply($scope.gridOptions_networkDefinition.data,rows)},removeRow:function(params){var index=_.findIndex($scope.gridOptions_networkDefinition.data,params);index>-1&&$scope.gridOptions_networkDefinition.data.splice(index,1)},getGridRows:function(){return $scope.gridOptions_networkDefinition.data},getSelectedRows:function(){return $scope.gridApi.selection.getSelectedRows()},load:function(){httpNetworkDefinitionSrvc.listNetworkDefinition().then((function(jsonData){$scope.gridOptions_networkDefinition.data=jsonData.results||[]}),(function(reason){nbAlertSrvc.error({message:"An erroroccurred on the server."});$log.error("networkDefinitionCtrl.js - Error from server: "+utilitySrvc.getErrorMessage(reason))}))}};grid.setting();grid.load()}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.networkDefinitionFormCtrl",NetworkDefinitionFormCtrl);NetworkDefinitionFormCtrl.$inject=["$scope","$uibModal","$uibModalInstance","$log","$timeout","nb.datamodel.httpNetworkDefinitionSrvc","nb.systemmodel.systemVendorModelMgr","nb.ng.utilitySrvc","nb.common.nbAlertSrvc","resolveData"];function NetworkDefinitionFormCtrl($scope,$uibModal,$uibModalInstance,$log,$timeout,httpNetworkDefinitionSrvc,systemVendorModelMgr,utilitySrvc,nbAlertSrvc,resolveData){$scope.onFindDevice=function(){};$scope.getDrivers=function(deviceTypeId){var deviceType=_.find(deviceTypes,{deviceTypeID:deviceTypeId});return deviceType?deviceType.drivers:[]};$scope.selectedDeviceTypeValue={};$scope.selectedDeviceDriverValue={};$scope.updateDeviceType=function(selected){$scope.selectedDeviceTypeValue=selected;$scope.deviceDriverList=$scope.getDrivers(selected.deviceTypeID);$scope.selectedDeviceDriver=$scope.deviceDriverList[0]};$scope.selectDeviceTypes=[];$scope.selectDeviceCallback=function(devId,device){if(devId&&device){$scope.deviceId=devId;$scope.devNameExp=device.devName;$scope.isRegx=0}};$scope.updateDeviceDriver=function(selected){$scope.selectedDeviceDriverValue=selected};$scope.onOK=function(){if($scope.devNameExp||$scope.ipAddrRange)if($scope.devNameExp&&$scope.devNameExp.length>64)nbAlertSrvc.error({message:"Exceeds limitation of 64 characters."});else if(1!=$scope.isRegx||utilitySrvc.isValidRegular($scope.devNameExp)){if($scope.ipAddrRange){var ips=$scope.ipAddrRange.split(/[;-]/);for(var i=0,len=ips.length;i<len;i++){var ip=ips[i];if(!utilitySrvc.isIpOrIpMask(ip)){nbAlertSrvc.error("IP Address Range is invalid.");return}}}if($scope.selectedDeviceType&&$scope.selectedDeviceTypeValue&&$scope.selectedDeviceTypeValue.deviceTypeID)if($scope.selectedDeviceDriver&&$scope.selectedDeviceDriverValue&&$scope.selectedDeviceDriverValue.driverID){var saveData={ID:$scope.ID||utilitySrvc.getGUID(),devNameExp:$scope.devNameExp&&""!=$scope.devNameExp?$scope.devNameExp:null,devSubType:$scope.selectedDeviceTypeValue.deviceTypeID,devSubTypeName:$scope.selectedDeviceTypeValue.deviceType,devDriverName:$scope.selectedDeviceDriverValue.driver,driverId:$scope.selectedDeviceDriverValue.driverID,ipAddrRange:$scope.ipAddrRange&&""!=$scope.ipAddrRange?$scope.ipAddrRange:null,isRegx:parseInt($scope.isRegx)};httpNetworkDefinitionSrvc.saveNetworkDefinition([saveData]).then((function(jsonData){if(1==jsonData){$scope.formAction="ok";saveData.devSubTypeName=$scope.selectedDeviceTypeValue.deviceType;saveData.devDriverName=$scope.selectedDeviceDriverValue.driver;$scope.saveData=saveData;$uibModalInstance.close($scope)}else nbAlertSrvc.error({message:jsonData.results.msg})}),(function(reason){nbAlertSrvc.error({message:"An error occurred on the server."});$log.error("networkDefinitionFormCtrl.js - Error from server: "+utilitySrvc.getErrorMessage(reason))}))}else nbAlertSrvc.error({message:"Please select a device driver."});else nbAlertSrvc.error({message:"Please select a device type."})}else nbAlertSrvc.error({message:"Please specify a valid hostname."});else nbAlertSrvc.error({message:"Please enter a value for the following field: IP address."})};$scope.onClose=function(){$scope.formAction="close";$uibModalInstance.dismiss()};var deviceTypes=[];function loadDeviceTypes(rowData){systemVendorModelMgr.getDeviceTypeTree().then((function(list){if(list&&list.length){deviceTypes=list;$scope.deviceTypeList=systemVendorModelMgr.mapDeviceTypeList(list);$scope.deviceTypeList.sort((function(a,b){return a.deviceType>b.deviceType?1:-1}));rowData?$scope.deviceDriverList=$scope.getDrivers($scope.selectedDeviceType.deviceTypeID):$timeout((function(){$scope.selectedDeviceType=$scope.deviceTypeList[0];$scope.selectedDeviceTypeValue=$scope.selectedDeviceType;$scope.deviceDriverList=$scope.getDrivers($scope.selectedDeviceType.deviceTypeID);$scope.selectedDeviceDriver=$scope.deviceDriverList[0];$scope.selectedDeviceDriverValue=$scope.selectedDeviceDriver}));$scope.$watch("selectedDeviceTypeValue",(function(newValue,oldValue){if(newValue&&(!oldValue||newValue.deviceTypeID!==oldValue.deviceTypeID)){$scope.deviceDriverList="";$scope.deviceDriverList=$scope.getDrivers(newValue.deviceTypeID);$timeout((function(){$scope.selectedDeviceDriverValue=$scope.deviceDriverList[0]}))}}))}}))}$scope.initDeviceType=function(rowData){if(rowData){$scope.deviceTypeList=[{deviceTypeID:rowData.devSubType,deviceType:rowData.devSubTypeName}];$timeout((function(){$scope.selectedDeviceType={deviceTypeID:rowData.devSubType,deviceType:rowData.devSubTypeName}}))}$timeout((function(){loadDeviceTypes(rowData);$scope.selectedDeviceTypeValue=$scope.selectedDeviceType}),50)};$scope.initDeviceDriver=function(rowData){if(rowData){$scope.deviceDriverList=[{driverID:rowData.driverId,driver:rowData.devDriverName.replace("{"+rowData.driverId+"}","")}];$timeout((function(){$scope.selectedDeviceDriver={driverID:rowData.driverId,driver:rowData.devDriverName.replace("{"+rowData.driverId+"}","")};$scope.selectedDeviceDriverValue=$scope.selectedDeviceDriver}))}};$scope.init=function(){var rowData=resolveData.selectedRow;$scope.isRegx=1;if(rowData){$scope.isRegx=rowData.isRegx?1:0;$scope.devNameExp=rowData.devNameExp;$scope.ipAddrRange=rowData.ipAddrRange;$scope.ID=rowData.ID}$scope.initDeviceType(rowData);$scope.initDeviceDriver(rowData);httpNetworkDefinitionSrvc.getAllDevTypes().then((function(data){var list=_.map(data,(function(item){return{ID:item.ID,typeName:item.typeName,selected:!0}}));list.sort((function(a,b){return a.typeName>b.typeName?1:-1}));$scope.selectDeviceTypes=list}))};$scope.init()}}(NetBrain);!function(NetBrain){angular.module("nb.datamodel").controller("nb.datamodel.networkDefinitionApplyCtrl",NetworkDefinitionApplyCtrl);NetworkDefinitionApplyCtrl.$inject=["$scope","$uibModal","$uibModalInstance","$log","nb.datamodel.httpNetworkDefinitionSrvc","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","resolveData"];function NetworkDefinitionApplyCtrl($scope,$uibModal,$uibModalInstance,$log,httpNetworkDefinitionSrvc,nbAlertSrvc,utilitySrvc,resolveData){$scope.onClose=function(){$uibModalInstance.dismiss()};$scope.onOK=function(){var msg="";var data=_.groupBy($scope.mySelections,"devName");for(var key in data)data[key].length>1&&(msg+=key+" can only select one\n");msg?nbAlertSrvc.error({message:msg}):$scope.mySelections.length?httpNetworkDefinitionSrvc.applyNetworkDefToDevices($scope.mySelections).then((function(jsonData){"0"==jsonData.results.opCode?$uibModalInstance.dismiss():nbAlertSrvc.error({message:jsonData.results.msg})}),(function(reason){nbAlertSrvc.error({message:"An error occurred on the server."});$log.error("networkDefinitionApplyCtrl.js - Error from server: "+utilitySrvc.getErrorMessage(reason))})):nbAlertSrvc.error({message:"please device"})};var grid_load=function(){$scope.myData.push.apply($scope.myData,resolveData.data)};(function(){$scope.myData=[];$scope.mySelections=[];$scope.gridOptions_networkDefinitionApply={data:"myData",columnDefs:[{field:"devName",displayName:"Hostname",width:"140px"},{field:"devSubTypeName",displayName:"Current Type",width:"120px"},{field:"devNewSubTypeName",displayName:"New Type",width:"120px"},{field:"devDriverName",displayName:"Current Driver",width:"120px"},{field:"devNewDriverName",displayName:"New Driver",width:"120px"}],enableSelectAll:!0,multiSelect:!0,autoHeight:!0,enableColumnResize:!0};$scope.gridOptions_networkDefinitionApply.onRegisterApi=function(gridApi){$scope.gridApi=gridApi}})();grid_load()}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").factory("nb.datamodel.httpDotScanSrvc",HttpDotScanSrvc);HttpDotScanSrvc.$inject=["nb.ng.nbHttp","$q","nb.ng.utilitySrvc","nb.systemmodel.deviceTypeMgrSrvc"];function HttpDotScanSrvc(nbHttp,$q,utilitySrvc,deviceTypeMgrSrvc){function ajax(url,method,requestData){return nbHttp[method.toLowerCase()](url,requestData)}function post(url,requestData){return ajax(url,"POST",requestData)}return{listSubnet:function(){},addSubnet:function(data){return post("Admin/Domain/addSubnet",data)},getDisPlayDotScan:function(data){var _deferred=$q.defer();(url="Admin/Domain/getDisPlayDotScan",requestData=data,ajax(url,"GET",requestData)).then((function(jsonData){var displayDevSubTypeItems=deviceTypeMgrSrvc.getAllDeviceTypesJsonByActions([-1]).map((function(obj){return{Id:obj.ID,DevSubTypeName:obj.typeName}}));jsonData.DisplayDevSubTypeItems=utilitySrvc.innerJoin(jsonData.DisplayDevSubTypeItems,"Id",displayDevSubTypeItems,"Id");jsonData.DisplayDevSubTypeItems.sort((function(a,b){return a.DevSubTypeName>b.DevSubTypeName?1:a.DevSubTypeName<b.DevSubTypeName?-1:0}));_deferred.resolve(jsonData)}),(function(error){_deferred.reject(error)}));var url,requestData;return _deferred.promise},getSubnetByIPAndSubMask:function(data){return post("Admin/Domain/getSubnetFromIPAndSubmask",data)},removeSubnet:function(data){return post("Admin/Domain/removeSubnet",data)},editSubnet:function(data){return post("Admin/Domain/editSubnet",data)},ImportSubnet:function(data){return post("Admin/Domain/saveDotScan",data)},updateDevSubTypes:function(data){return post("Admin/Domain/setDevSubTypes",data)},saveDotScan:function(data){return post("Admin/Domain/saveDotScan",data)}}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.dotScanFormCtrl",DotScanFormCtrl);DotScanFormCtrl.$inject=["$scope","$uibModal","$uibModalInstance","$log","$timeout","nb.datamodel.httpDotScanSrvc","nb.systemmodel.systemVendorModelMgr","nb.ng.utilitySrvc","nb.ng.userSrvc","resolveData","nb.common.nbAlertSrvc"];function DotScanFormCtrl($scope,$uibModal,$uibModalInstance,$log,$timeout,httpDotScanSrvc,systemVendorModelMgr,utilitySrvc,userSrvc,resolveData,nbAlertSrvc){var actionValue=resolveData.action?"Add":"Edit";$scope.actionType=actionValue;$scope.onOK=function(){if($scope.Ip&&$scope.mask){if($scope.Ip){var ips=$scope.Ip.split(/[,-]/);for(var i=0,len=ips.length;i<len;i++){var ip=ips[i];if(!utilitySrvc.isIpOrIpMask(ip)){nbAlertSrvc.error({message:"Invalid IP address."});return}}}if($scope.mask){var subnetMask=Number($scope.mask);if(!(subnetMask<=32&&subnetMask>=8)){nbAlertSrvc.error({message:"Subnet mask can only be a positive integer between 8 and 32."});return}}$scope.saveData={ID:$scope.ID||utilitySrvc.getGUID(),Ip:$scope.Ip,oldSubnet:resolveData.selectedRow&&resolveData.selectedRow.subnet?resolveData.selectedRow.subnet:null,subMask:$scope.mask,description:$scope.description};var displayData={subnet:$scope.Ip+"/"+$scope.subMask,description:$scope.description};"Add"==actionValue?httpDotScanSrvc.addSubnet($scope.saveData).then((function(jsonData){0==jsonData.opCode?httpDotScanSrvc.getSubnetByIPAndSubMask($scope.saveData).then((function(data){displayData.subnet=data;$scope.formAction="ok";$scope.displayData=displayData;$uibModalInstance.close($scope)}),(function(data){nbAlertSrvc.error({message:"Failed to obtain the IP address or subnet mask."})})):nbAlertSrvc.error({message:"Failed to add the IP address or subnet mask."})}),(function(xhr){nbAlertSrvc.error({message:"Failed to add the IP address or subnet mask."})})):httpDotScanSrvc.editSubnet($scope.saveData).then((function(jsonData){0==jsonData.opCode?httpDotScanSrvc.getSubnetByIPAndSubMask($scope.saveData).then((function(data){displayData.subnet=data;$scope.formAction="ok";$scope.displayData=displayData;$uibModalInstance.close($scope)}),(function(xhr){nbAlertSrvc.error({message:"Failed to obtain the IP address or subnet mask."})})):nbAlertSrvc.error({message:"Failed to update the IP address or subnet mask."})}),(function(xhr){nbAlertSrvc.error({message:"Failed to update the IP address or subnet mask."})}))}else nbAlertSrvc.error({message:"Please enter a value for the following fields: IP address, subnet mask."})};$scope.onClose=function(){$scope.formAction="close";$uibModalInstance.dismiss()};$scope.init=function(){var rowData=resolveData.selectedRow;if(rowData){var ipOrsubMask=rowData.subnet.split("/");$scope.Ip=ipOrsubMask[0];$scope.mask=parseInt(ipOrsubMask[1]);$scope.description=rowData.description;$scope.Id=rowData.Id}};$scope.init()}}(NetBrain);!function(NetBrain){angular.module("nb.datamodel").factory("nb.datamodel.httpDeviceDriverSrvc",HttpDeviceDriverSrvcc);HttpDeviceDriverSrvcc.$inject=["nb.ng.nbHttp"];function HttpDeviceDriverSrvcc(nbHttp){function ajax(url,method,requestData){return nbHttp[method.toLowerCase()](url,requestData)}return{getAllDriverDisplayInfo:function(){return ajax("DeviceDriver/getAllDriverDisplayInfo","GET")},editDriverDatabyID:function(data){return ajax("DeviceDriver/editDriverDatabyID","POST",data)},removeDeviceDriver:function(data){return ajax("DeviceDriver/deleteDriverDatabyID","POST",{devDriverId:data.ID})},getDeviceDriverContent:function(id,saveAs){return ajax("DeviceDriver/getDriverDatabyID","POST",{devDriverId:id,saveAs:1==saveAs})},importDriverData:function(data){return ajax("DeviceDriver/importDriverData","POST",data)},testScript:function(data){return ajax("DeviceDriver/testScript","POST",data)},getAllNetworkServer:function(domainId){return ajax("networksetting/getAllNetworkServer","GET",{DomainGuid:domainId})},getAllSnmpRoInfo:function(domainId){return ajax("networksetting/getAllSnmpRoInfo","GET",{DomainGuid:domainId})},setDriverEnable:function(id,enable){return ajax("DeviceDriver/setEnable","POST",{devDriverId:id,enable:enable})}}}}(NetBrain);!function(NetBrain){angular.module("nb.datamodel").controller("nb.datamodel.deviceDriverCtrl",DeviceDriverCtrl);DeviceDriverCtrl.$inject=["$scope","$uibModal","$log","$uibModalInstance","nb.datamodel.httpDeviceDriverSrvc","nb.systemmodel.systemVendorModelMgr","nb.ng.inputFileSrvc"];function DeviceDriverCtrl($scope,$uibModal,$log,$uibModalInstance,httpDeviceDriverSrvc,systemVendorModelMgr,inputFileSrvc){$scope.nUniqueID=0;$scope.onClose=function(){$uibModalInstance.dismiss()};$scope.onAdd=function(){$scope._arrData=$scope._arrData.concat({localID:$scope.nUniqueID++,driver:"b",deviceType:"b",status:"b",author:"b",id:"b",isModified:!0})};$scope.onEdit=function(){};$scope.onSaveAs=function(){};$scope._delete=function(nLocalID){if($scope._arrData.length>0){var iLeft=0;var iRight=$scope._arrData.length-1;for(;iLeft<=iRight;){var iMiddle=Math.floor((iLeft+iRight)/2);var midData=$scope._arrData[iMiddle];if(midData.localID==nLocalID){$scope._arrData.splice(iMiddle,1);return!0}midData.localID<nLocalID?iLeft=iMiddle+1:iRight=iMiddle-1}}return!1};$scope.onDelete=function(){if(0!=$scope.getSelectRowsCount()){if(confirm("Are you sure to delete?")){var arrRows=$scope.getSelectRows();for(var idx in arrRows){var row=arrRows[idx];httpDeviceDriverSrvc.removeDeviceDriver(row).then((function(data){$scope._delete(data.results.localID)}),(function(xhr){alert(xhr.xhr)}))}}}else alert("Please select one item at least.")};$scope._download=function(data){if(data.content){var link=document.createElement("a");var content=atob(data.content);var buf=new ArrayBuffer(content.length);var bufView=new Uint8Array(buf);for(var i=0;i<content.length;++i)bufView[i]=content.charCodeAt(i);var blob=new Blob([buf]);var url=window.URL.createObjectURL(blob);var strXHexStringGUID="X"+data.ID.substr(1,data.ID.length-2).replace(/-/g,"").toUpperCase();link.setAttribute("href",url);link.setAttribute("download",data.name+"_"+strXHexStringGUID+".nbdriver");link.click()}else alert("There is no driver content!")};$scope._export=function(data){if(data){data.content?$scope._download(data):httpDeviceDriverSrvc.getDeviceDriverContent(data).then((function(jsonData){$scope._download(jsonData.results)}),(function(error){alert(error)}))}};$scope.onExport=function(){var arrRows=$scope.getSelectRows();for(var idx in arrRows)$scope._export(arrRows[idx])};$scope.onImport=function(){inputFileSrvc.createInputFile({scope:$scope,fileAccept:".nbdriver",fileChange:"onFileSelect"})};$scope.onFileSelect=function(files){var reader=new FileReader;reader.onload=function(){httpDeviceDriverSrvc.importDriverData({content:btoa(String.fromCharCode.apply(null,new Uint8Array(reader.result)))}).then((function(data){for(var i=0;i<$scope._arrData.length&&$scope._arrData[i].ID!=data.results.ID;++i);if(i==$scope._arrData.length){data.results.localID=$scope.nUniqueID++;$scope._arrData=$scope._arrData.concat(data.results);$scope.$digest()}else alert("Ther Driver has been exist!")}),(function(error){alert(error)}))};reader.readAsArrayBuffer(files[0])};$scope.onViewModelList=function(){var rows=$scope.getSelectRows();systemVendorModelMgr.openSystemVendorModel(rows.length>0?rows[0].subType:null)};$scope.onSubmitToNetBrain=function(){};$scope.getSelectRowsCount=function(){return $scope._gridApi.selection.getSelectedRows().length};$scope.getSelectRows=function(){return $scope._gridApi.selection.getSelectedRows()};var grid_load=function(){httpDeviceDriverSrvc.getAllDriverDisplayInfo().then((function(jsonData){if(jsonData.results){for(var idx in jsonData.results)jsonData.results[idx].localID=$scope.nUniqueID++;$scope._arrData=[];$scope._arrData=$scope._arrData.concat(jsonData.results)}}),(function(error){alert(error)}))};(function(){$scope._arrData=[];$scope.arrSelections=[];$scope.gridOptions={data:"_arrData",columnDefs:[{field:"ID",displayName:"No.",width:"5%",cellTemplate:"<div class='ui-grid-cell-contents' title='TOOLTIP'>{{rowRenderIndex + row.grid.renderContainers.body.currentTopRow + 1}}</div>"},{field:"name",displayName:"Driver",width:"20%"},{field:"subTypeName",displayName:"Device Type",width:"20%"},{field:"isEnable",displayName:"Status",width:"8%",cellTemplate:"<div class='ui-grid-cell-contents' title='TOOLTIP'>{{COL_FIELD == true ? 'Enable' : 'Disable'}}</div>"},{field:"author",displayName:"Author",width:"8%"},{field:"ID",displayName:"ID",width:"*"}],selectedItems:$scope.arrSelections,autoHeight:!0,enableColumnResize:!0,enableColumnResizing:!0,multiSelect:!0,enableFullRowSelection:!0,enableRowSelection:!0,onRegisterApi:function(gridApi){$scope._gridApi=gridApi}}})();grid_load()}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").directive("nbSelectDevicesDirective",SelectDevices);SelectDevices.$inject=["$uibModal"];function SelectDevices($uibModal){return{restrict:"A",scope:{selectedDevices:"=",modalTitle:"&",successCallBack:"=",failCallBack:"=",singleSelection:"&"},link:function(scope,element,attr){element.bind("click",(function(event){event.preventDefault();$uibModal.open({templateUrl:"modules/nbDataModel/common/views/nbSelectDevicesModalView.html",controller:"nb.datamodel.nbSelectDevicesModalCtrl",windowClass:"nb-select-devices-modal",backdrop:"static",keyboard:!1,animation:!1,resolve:{selectedDevices:function(){return scope.selectedDevices},modalTitle:function(){return scope.modalTitle()},singleSelection:function(){return scope.singleSelection()}}}).result.then((function(result){scope.successCallBack(result)}),(function(err){scope.failCallBack(err)}))}))}}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.nbSelectDevicesModalCtrl",SelectDevicesModalCtrl);SelectDevicesModalCtrl.$inject=["$scope","$timeout","$uibModalInstance","selectedDevices","modalTitle","singleSelection","nb.search.searchMgr","nb.search.httpGlobalSearchSrvc","uiGridConstants","nb.systemmodel.httpDeviceTypeSrvc"];function SelectDevicesModalCtrl($scope,$timeout,$uibModalInstance,selectedDevices,modalTitle,singleSelection,searchMgr,httpGlobalSearchSrvc,uiGridConstants,httpDeviceTypeSrvc){$scope.selectedDevices=[];$scope.selectedDevices=JSON.parse(JSON.stringify(angular.copy($scope.selectedDevices)));$scope.title=""===modalTitle||null==modalTitle?"Search Devices...":modalTitle;$scope.isSingleMode=!0===singleSelection||"true"===singleSelection;$scope.filterStr="";$scope.strMinLength=3;$scope.beginIndex=0;$scope.loadCount=30;$scope.maxCount=1e3;$scope.totalCount=31;$scope.autoCompleteDelay=100;$scope.autoCompleteList=[];$scope.hideAutoComplete=!1;$scope.initGridShow=!1;$scope.searchResultData=[];$scope.deviceTypeList={};$scope.selectDevicesGridOptions={data:"searchResultData",enableColumnMenus:!1,enableSelection:!0,modifierKeysToMultiSelect:!0,multiSelect:!$scope.isSingleMode,enableFullRowSelection:!0,enableRowHeaderSelection:!$scope.isSingleMode,enableFiltering:!1,enableColumnResize:!0,flatEntityAccess:!0,infiniteScrollRowsFromEnd:15,infiniteScrollDown:!0,enableSelectionBatchEvent:!1,columnDefs:[{field:"index",width:"10%",displayName:"No."},{field:"hostName",width:"20%",displayName:"Hostname"},{field:"mgmtIP",width:"20%",displayName:"Management IP"},{field:"deviceType",width:"15%",displayName:"Device Type"},{field:"vendor",width:"15%",displayName:"Vendor"},{field:"model",width:"18%",displayName:"Model"}],onRegisterApi:function(gridAPI){$scope.gridAPI=gridAPI;$scope.gridAPI.infiniteScroll.on.needLoadMoreData($scope,$scope.lazyLoadingDevice);$scope.gridAPI.selection.on.rowSelectionChanged($scope,(function(row){_updateSelectedDevices(row)}))}};httpDeviceTypeSrvc.getAllDeviceTypes(null).then((function(typeList){angular.forEach(typeList,(function(type){$scope.deviceTypeList[type.ID]={typeName:type.typeName,mainType:type.mainType,ID:type.ID}}))}));var _updateSelectedDevices=function(row){var index=$scope.selectedDevices.map((function(v){return v.guid})).indexOf(row.entity.guid);row.isSelected&&-1===index?$scope.selectedDevices.push(angular.copy(row.entity)):!row.isSelected&&index>-1&&$scope.selectedDevices.splice(index,1)};var _timerDelay=null;$scope.lazyLoadingDevice=function(){$scope.gridAPI.infiniteScroll.saveScrollPercentage();$scope.searchResultData.length>0&&$scope.searchResultData.length<$scope.totalCount&&$scope.searchDevices(!1)};$scope.confirm=function(){var selectedDevices=JSON.parse(JSON.stringify(angular.copy($scope.selectedDevices)));$uibModalInstance.close(selectedDevices)};$scope.closeDialog=function(){$uibModalInstance.dismiss()};$scope.searchDevices=function(isInitial){var preDevices=[];if(isInitial){$scope.beginIndex=0;$scope.searchResultData=[];$scope.gridAPI&&$scope.gridAPI.selection.clearSelectedRows()}else preDevices=_.map($scope.searchResultData,(function(device){return{ID:device.guid,hostName:device.hostName}}));if(!($scope.searchResultData.length>=$scope.totalCount)){$scope.initGridShow||($scope.initGridShow=!0);var searchConditions=searchMgr.genSearchQuery({title:$scope.filterStr},null,null,$scope.beginIndex,$scope.loadCount,$scope.maxCount,preDevices);httpGlobalSearchSrvc.doFullSearch(searchConditions).then((function(data){$scope.searchResultData=$scope.searchResultData.concat(function(data){var tempList=[];for(var i=0;i<data.length;i++){var origDataItem=data[i];var tempDataItem={};tempDataItem.index=$scope.beginIndex+i+1;tempDataItem.hostName=origDataItem.DevName;tempDataItem.guid=origDataItem.DevGuid;tempDataItem.subType=origDataItem.SubType;tempDataItem.deviceType=$scope.deviceTypeList[origDataItem.SubType].typeName;for(var j=0;j<origDataItem.MatchPropertys.length;j++){var propertyItem=origDataItem.MatchPropertys[j];"name"!==propertyItem.PropKey&&(tempDataItem[propertyItem.PropKey]=propertyItem.SearchValues[0].Value)}tempList.push(tempDataItem)}return tempList}(data.DevResults.DevResultList));$scope.beginIndex=$scope.searchResultData.length;$scope.totalCount=data.DevResults.TotalCount;$scope.hideAutoComplete=!0;$scope.gridAPI.infiniteScroll.dataLoaded().then((function(){!0===isInitial&&$scope.gridAPI.infiniteScroll.resetScroll(!1,!0)}))}),(function(err){$scope.gridAPI.infiniteScroll.dataLoaded()}))}};$scope.refreshAutocomplete=function(event){if(13!==event.keyCode){if(null!==_timerDelay){$timeout.cancel(_timerDelay);_timerDelay=null}_timerDelay=$timeout((function(){!function(str){if(str.length>=$scope.strMinLength){httpGlobalSearchSrvc.getSearchPromptByPrefix(null,str,4,[0]).then((function(data){$scope.$evalAsync((function(){$scope.autoCompleteList=data;$scope.hideAutoComplete=!1}))}))}}(event.target.value)}),$scope.autoCompleteDelay)}else{$scope.hideAutoComplete=!0;$scope.searchDevices(!0)}};$scope.selectAutoItem=function(item){$scope.filterStr=item;$scope.hideAutoComplete=!0};$scope.closeAutoComplete=function(){$scope.hideAutoComplete=!0}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").factory("nb.datamodel.httpBoundInterfaceTableSrvc",HttpBoundInterfaceTableSrvc);HttpBoundInterfaceTableSrvc.$inject=["nb.ng.nbHttp"];function HttpBoundInterfaceTableSrvc(nbHttp){var api_listBoundInterfaceTable=function(){return nbHttp.get("datamodel/boundinterfacetable")},api_addBoundInterfaceTable=function(data){return nbHttp.post("datamodel/boundinterfacetable",data)},api_removeBoundInterfaceTable=function(ids){return nbHttp.delete("datamodel/boundinterfacetable",ids)};return{listBoundInterfaceTable:function(){return api_listBoundInterfaceTable()},addBoundInterfaceTable:function(data){return api_addBoundInterfaceTable(data)},removeBoundInterfaceTable:function(ids){return api_removeBoundInterfaceTable(ids)}}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.boundInterfaceTableCtrl",BoundInterfaceTableCtrl);BoundInterfaceTableCtrl.$inject=["$scope","$uibModal","$uibModalInstance","$log","nb.datamodel.httpBoundInterfaceTableSrvc"];function BoundInterfaceTableCtrl($scope,$uibModal,$uibModalInstance,$log,httpBoundInterfaceTableSrvc){$scope.onClose=function(){$uibModalInstance.dismiss()};$scope.onAdd=function(){$scope.networkDefinitionForm=$uibModal.open({templateUrl:"modules/nbDataModel/boundInterfaceTable/views/boundInterfaceTableForm.html",controller:"nb.datamodel.boundInterfaceTableFormCtrl",windowClass:"boundinterfacetableform",backdrop:!1,size:"sm",resolve:{resolveData:function(){return{context:$scope}}}});$scope.networkDefinitionForm.result.then((function(scope){"ok"==scope.formAction&&grid.addRow(scope.newData)}))};$scope.onDelete=function(){if($scope.getSelectedRowsCount()){if(confirm("Are you sure to delete?")){var ids=_.map(grid.getSelectedRows(),(function(item){return item.ID}));httpBoundInterfaceTableSrvc.removeBoundInterfaceTable(ids).then((function(jsonData){ids.forEach((function(val){grid.removeRow({ID:val})}))}),(function(xhr){alert(xhr)}))}}else alert("Please select one item at least.")};var grid={setting:function(){$scope.gridOptions_boundinterfacetable={data:[],columnDefs:[{field:"DevName",displayName:"Device",width:"20%"},{field:"InterfaceName",displayName:"Interface",width:"30%"},{field:"IpAddress",displayName:"IP",width:"20%",cellTemplate:'<div class="ui-grid-cell-contents"><span>{{COL_FIELD?COL_FIELD:"No IP Address"}}</span></div>'},{field:"Description",displayName:"Description",width:"30%"}],enableFullRowSelection:!0,enableRowHeaderSelection:!1,multiSelect:!0,autoHeight:!0,enableColumnResize:!0};$scope.gridOptions_boundinterfacetable.onRegisterApi=function(gridApi){$scope.gridApi=gridApi};$scope.getSelectedRowsCount=function(){return $scope.gridApi.selection.getSelectedRows().length};$scope.getGridRowsCount=function(){return $scope.gridOptions_boundinterfacetable.data.length}},addRow:function(row){$scope.gridOptions_boundinterfacetable.data.push(row)},addRows:function(rows){$scope.gridOptions_boundinterfacetable.data.apply($scope.gridOptions_boundinterfacetable.data,rows)},removeRow:function(params){var index=_.findIndex($scope.gridOptions_boundinterfacetable.data,params);index>-1&&$scope.gridOptions_boundinterfacetable.data.splice(index,1)},getGridRows:function(){return $scope.gridOptions_boundinterfacetable.data},getSelectedRows:function(){return $scope.gridApi.selection.getSelectedRows()},load:function(){httpBoundInterfaceTableSrvc.listBoundInterfaceTable().then((function(list){$scope.gridOptions_boundinterfacetable.data=list||[]}),(function(error){}))}};grid.setting()}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.boundInterfaceTableFormCtrl",BoundInterfaceTableFormCtrl);BoundInterfaceTableFormCtrl.$inject=["$scope","$uibModal","$uibModalInstance","nb.datamodel.httpBoundInterfaceTableSrvc","nb.ng.utilitySrvc","resolveData"];function BoundInterfaceTableFormCtrl($scope,$uibModal,$uibModalInstance,httpBoundInterfaceTableSrvc,utilitySrvc,resolveData){$scope.row={};$scope.onOK=function(){if($scope.row.DevName)if($scope.row.InterfaceName)if($scope.row.DevSubType||!parseInt($scope.row.DevSubType))if($scope.row.IpAddress){var row=angular.copy($scope.row);if(_.find(resolveData.context.gridOptions_boundinterfacetable.data,{DevName:row.DevName,InterfaceName:row.InterfaceName,IpAddress:row.IpAddress}))alert(row.DevName+" "+row.InterfaceName+" "+row.IpAddress+" already exists");else{row.ID=utilitySrvc.getGUID();httpBoundInterfaceTableSrvc.addBoundInterfaceTable([row]).then((function(jsonData){$scope.formAction="ok";$scope.newData=row;$uibModalInstance.close($scope)}),(function(xhr){alert(xhr)}))}}else alert("Please enter  IP");else alert("Please enter  Device SubType");else alert("Please enter  Interface");else alert("Please enter  Device")};$scope.onClose=function(){$scope.formAction="close";$uibModalInstance.dismiss()}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.deviceBrowserSiteTreeCtrl",DeviceBrowserSiteTreeCtrl);DeviceBrowserSiteTreeCtrl.$inject=["$scope","$rootScope","$filter","$timeout","ivhTreeviewMgr","nb.datamodel.httpSiteSrvc","nb.datamodel.nbSiteTreeSrvc","nb.topo.httpExternNbrSrvc","nb.qmap.mapManagerSrvc","nb.uiframework.urlStateMgr","nb.common.nbDragDropSrvc","nb.ng.httpAuthSrvc","nb.networkos.desktopSrvc","nb.common.nbAlertSrvc","nb.qmap.updateMapSrvc","nb.networkos.myFilesSrvc"];function DeviceBrowserSiteTreeCtrl($scope,$rootScope,$filter,$timeout,ivhTreeviewMgr,httpSiteSrvc,nbSiteTreeSrvc,httpExternNbrSrvc,mapManagerSrvc,urlStateMgr,nbDragDropSrvc,httpAuthSrvc,desktopSrvc,nbAlertSrvc,updateMapSrvc,myFilesSrvc){var _queryIndex=0;var self=$scope;self.sites=null;self.isFilterShow=!1;self.filterOptions={filterTarget:"",searchKey:""};self.siteCache=[];self.selectedRows=[];self.siteData=[{}],self.gridNameCellTemplate1='<div class="ui-grid-cell-contents ng-scope" style="cursor: pointer;"  title="{{COL_FIELD}}"><span class="{{row.entity.siteIcon}}" width="16px" height="16px"></span></div>';self.gridNameCellTemplate='<div class="ui-grid-cell-contents ng-scope" style="cursor: pointer;"  title="TOOLTIP"><a ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget" ng-click="grid.appScope.locateInSitePane(row)"></a></div>';self.filterGridOptions={onRegisterApi:function(gridApi){self.deviceGridApi=gridApi;gridApi.selection.on.rowSelectionChanged(self,(function(row){self.selectedRows=self.deviceGridApi.selection.getSelectedRows();self.$evalAsync(self.getDeviceData,++_queryIndex)}))},data:"siteData",showHeader:!1,enableColumnResize:!0,enableColumnMenus:!1,enableRowActionMenu:!1,noUnselect:!0,enableRowContextMenu:!0,columnDefs:[{field:"iconTemplate",displayName:"icon",cellTemplate:self.gridNameCellTemplate1,width:"35"},{field:"name",displayName:"siteName",width:"*",cellTooltip:function(row,col){var sitePath="";if(row.entity&&row.entity.parentPath){row.entity.parentPath.forEach((function(parentSiteId){var site=_.find(self.siteCache,(function(item){return item.ID===parentSiteId}));site&&(sitePath+=site.name+"\\")}))}if((sitePath=sitePath.substr(0,sitePath.length-1)).length>40){var firstChild=sitePath.substr(0,sitePath.indexOf("\\"));var lastChild=sitePath.substr(sitePath.lastIndexOf("\\"),sitePath.length-1);sitePath=firstChild+"\\..."+lastChild}return sitePath},cellTemplate:self.gridNameCellTemplate}],rowTemplate:'<div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell"  ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell> </div>'};self.siteData=[{}],self.startFilter=function(event){if(13===event.keyCode)if(""==self.filterOptions.searchKey){self.isFilterShow=!1;self.$emit(viewFrameEvent.refreshDeviceBrowser)}else{self.isFilterShow=!0;!function(){self.filterOptions.filterTarget=self.filterOptions.searchKey;var siteName=self.filterOptions.filterTarget;httpSiteSrvc.getSitesByNameFilter(siteName).then((function(data){self.siteData=[];self.siteCache=[];self.siteCache=data.parentSites;angular.forEach(data.sites,(function(item,index){self.siteCache.push(item);!function(item){item.isLeaf=item.siteCategory>=2;item.siteIcon=2===item.siteCategory?"leaf_site_icon":"container_site_icon";item.selected=!1}(item)}));self.siteData=data.sites;self.$applyAsync((function(){self.deviceGridApi.selection.selectRow&&self.deviceGridApi.selection.selectRow(self.siteData[0])}))}),(function(){}))}()}};self.clearFilter=function(needRefrechBrowser){self.filterOptions.filterTarget="";self.filterOptions.searchKey="";self.isFilterShow=!1;needRefrechBrowser&&self.$emit(viewFrameEvent.refreshDeviceBrowser)};self.locateInSitePane=function(row){self.clearFilter();var selectedDev=row.entity;if(selectedDev){$rootScope.$emit(viewFrameEvent.toggleTopPanel,"site",{alwaysShow:!0});$timeout((function(){selectedDev.parentPath&&selectedDev.parentPath.length>0?$rootScope.$emit("select_site_node",{siteId:selectedDev.ID,parentPath:selectedDev.parentPath}):httpSiteSrvc.getSitePropertiesBySiteID(selectedDev.ID,!1).then((function(data){selectedDev.parentPath=data.parentPath;$rootScope.$emit("select_site_node",{siteId:selectedDev.ID,parentPath:selectedDev.parentPath})}))}),500)}};self.getDeviceData=function(index){var node=self.selectedRows[0];node&&$rootScope.$emit(deviceBrowserEvent.siteNodeSelected,{selectedNode:node})};self.siteData=[];self.currentDomains=httpAuthSrvc.getSelectedDomainIds();self.ivhTreeOptions={defaultSelectedState:!1,validate:!1,expandToDepth:1,labelAttribute:"name",idAttribute:"ID",childrenAttribute:"child",expandedAttribute:"expanded",useCheckboxes:!1,twistieLeafTpl:""};$scope.browseTreeSiteOptions={labelAttribute:"name",idAttribute:"ID",childrenAttribute:"child",expandedAttribute:"expended",iconTemplate:function(node,trvw){return trvw.isLeaf(node)?2===node.docType?'<img src="img/Assets/Map_Icon_16x16.png">':1===node.docType?'<img src="img/Assets/Task_Icon_16x16.png">':'<i class="fa fa-folder-o fa-lg"></i>':'<i class="fa fa-folder-o fa-lg"></i>'},labelTemplate:function(node){return node.name},nodeClickCallback:function(node,trvw){$scope.treeNodeSelect(node,trvw)},enableLabelExpand:!1,checkTreeNodeVisible:function(node,trvw){return 1!=node.docType&&2!=node.docType},enableNodeDropdown:{isDisplay:function(node){return null!=node.treeActionMenu},dropdownItems:function(node){var menus=[];angular.forEach(node.treeActionMenu,(function(menuItem){menus.push({template:menuItem.title,action:function(node,trvw){node.selectAction(node,menuItem)}})}));return menus}}};self.$on(viewFrameEvent.refreshDeviceBrowser,(function(event){self.init()}));var openSiteMap=function(mapId){var options={mapType:netBrain.Map.Const.MapType.siteMap,id:mapId};return urlStateMgr.openMap(options)};var showInDesktop=function(app){desktopSrvc.addShortcut(app).then((function(){$rootScope.$broadcast(NetBrain.NetworkOS.Events.MY_FILES_REFRESH_FILE_LIST,{folder:myFilesSrvc.getDesktopFolderInCache()})}),(function(error){nbAlertSrvc.alert(error.ResultDesc)}))};$rootScope.$on("refreshOverviewMap",(function(){}));self.actionMenu=[{template:"Open Overview Map",action:function(node){if(node&&node.ID){var options={mapType:netBrain.Map.Const.MapType.overViewMap,id:httpAuthSrvc.getSelectedDomainIds()[0]};return urlStateMgr.openMap(options)}},isShow:!0,mType:"0"},{template:"Open Site Map",action:function(node){node&&node.ID&&openSiteMap(node.ID)},isShow:!0,mType:"2"},{template:"Open Site Map",action:function(node){node&&node.ID&&openSiteMap(node.ID)},isShow:!0,mType:"1"},{template:"Draw Devices on Map",action:function(node){if(node.siteCategory===siteCategory.LeafSite){var queryParam={siteId:node.ID,filterFields:["deviceName"],filterValue:"",sortField:"deviceName",sortOrder:"asc",useTemporaryStorage:!1,pageNumber:1,pageSize:node.deviceCount};httpSiteSrvc.getSiteDevicesBySiteIDWithFilter(queryParam).then((function(devices){var deviceList=devices.memberList;var deviceIds=[];angular.forEach(deviceList,(function(device){var devObj={id:device.deviceId};deviceIds.push(devObj)}));var drawData={actionData:deviceIds,actionType:NetBrain.Common.Const.ActionType.DrawDevice};nbDragDropSrvc.drawDevice(drawData)}),(function(reason){alert("Draw devices on map failed!")}))}},isShow:!0,mType:"2"},{template:"Draw Site on Map",action:function(node){var drawData={actionData:[{id:node.ID,isSite:!0,topoType:"L3_Topo_Type"}],actionType:NetBrain.Common.Const.ActionType.DrawSite};nbDragDropSrvc.drawSite(drawData)},isShow:!0,mType:"12"},{template:"",class:"divider",action:angular.noop,mType:"012"},{template:"View Detail",action:function(node){var key="site:"+node.name;$rootScope.$emit("searchKeyword",{keyword:key,extendKeyword:"?key="+node.ID})},isShow:!0,mType:"12"},{template:"",class:"divider",action:angular.noop,mType:"12"},{template:"Send Site Map to Desktop",action:function(node){if(node&&node.ID){var app={id:node.ID,name:node.name,type:netBrain.Map.Const.FileTypes.SiteMap};showInDesktop(app)}},isShow:!0,mType:"12"},{template:"Send Overview Map to Desktop",action:function(node){if(node&&node.ID){var app={id:httpAuthSrvc.getSelectedDomains()[0].guid,name:"Overview Map",type:netBrain.Map.Const.FileTypes.OverviewMap};showInDesktop(app)}},isShow:!0,mType:"0"}];self.init=function(){self.sites=null;self.clearFilter();$timeout((function(){self.sites=[];$rootScope.$emit(deviceBrowserEvent.deviceManagementPermissionChanged)}))};self.treeNodeSelect=function(node){self.selectedNode=node;node&&$rootScope.$emit(deviceBrowserEvent.siteNodeSelected,{selectedNode:node})};self.dragSite=function(dragScope,event){var draObj={isBrowseSite:!0,dragNode:{id:dragScope.node.ID,name:dragScope.node.name,siteCategory:dragScope.node.siteCategory}};var dragDeviceString=JSON.stringify(draObj);event.dataTransfer.setData("text",dragDeviceString)};self.init();self.refreshTree=nbSiteTreeSrvc.refresh;self.fetch=httpSiteSrvc.getFullSiteTree;self.refreshCount=nbSiteTreeSrvc.refreshCount;self.treeMenu=function(site){return _.filter(self.actionMenu,(function(item){return function(site,action){var retVal=!0;var sc=site.siteCategory+"";retVal=action.mType.indexOf(sc)>-1;"Open Site Map"!==action.title&&"Draw Devices on Map"!==action.title||(!site.deviceCount||site.deviceCount<=0)&&(retVal=!1);return retVal}(site,item)}))};$rootScope.$on("searchSite",(function(event,args){httpSiteSrvc.getSitePropertiesBySiteID(args.id,!1).then((function(data){$scope.parentPath=data.parentPath;$rootScope.$emit("select_site_node",{siteId:data.ID,parentPath:data.parentPath})}))}))}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.deviceBrowserSiteContentCtrl",DeviceBrowserSiteContentCtrl);DeviceBrowserSiteContentCtrl.$inject=["$scope","$uibModal","$rootScope","$timeout","nb.datamodel.httpSiteSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.netbrain.httpDeviceSrvc","nb.ng.utilitySrvc","nb.ng.httpAuthSrvc","nb.netbrain.httpDeviceSettingSrvc","nb.systemmodel.httpDeviceIconSrvc","nb.common.nbDragDropSrvc","nb.common.nbAlertSrvc","nb.ng.permissionSrvc","nb.admin.httpPrivateDeviceSettingSrvc","nb.admin.httpDomainAdminNewSrvc","nb.ng.userSrvc"];function DeviceBrowserSiteContentCtrl($scope,$uibModal,$rootScope,$timeout,httpSiteSrvc,deviceTypeMgrSrvc,httpDeviceSrvc,utilitySrvc,httpAuthSrvc,httpDeviceSettingSrvc,httpDeviceIconSrvc,nbDragDropSrvc,nbAlertSrvc,permissionSrvc,httpPrivateDeviceSettingSrvc,httpDomainAdminNewSrvc,userSrvc){var self=$scope;self.canRemoveDeviceFromDomain=!1;self.hasDevSettingsMgmtPermission=!1;self.isSiteDevice=!0;self.filterOptions={filterTarget:"",searchKey:""};self.deviceData=[];self.containerData=[];self.sortField="deviceName";self.sortOrder="asc";self.selectedRows=[];self.selectedDeviceIds=[];self.selectedSideIds=[];var _pageNumber=1;var _isLoading=!1;var _isAllLoaded=!1;var selectedNodeId="";var updatePermissionOnDeviceManagement=$rootScope.$on(deviceBrowserEvent.deviceManagementPermissionChanged,(function(){self.canRemoveDeviceFromDomain=permissionSrvc.hasSystemRole("systemAdmin")||permissionSrvc.hasTenantRole("tenantAdmin")||permissionSrvc.hasDomainRole("domainAdmin")||permissionSrvc.hasDomainRole("powerUser")||permissionSrvc.anyPermission("deviceManagement");self.hasDevSettingsMgmtPermission=permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.manageDeviceSettings)}));self.$on("$destroy",updatePermissionOnDeviceManagement);var onSelectNode=$rootScope.$on(deviceBrowserEvent.siteNodeSelected,(function(event,siteNode){self.selectedRows=[];self.selectedDeviceIds=[];self.selectedSideIds=[];var node=siteNode.selectedNode;selectedNodeId=node.ID;if(node){self.isSiteDevice=!0;if(_isLoading)return;$timeout((function(){self.initDevicePage()}),100)}}));self.$on("$destroy",onSelectNode);self.gridNameCellTemplate='<div class="ui-grid-cell-contents ng-scope" style="cursor: pointer;"  title="{{COL_FIELD}}"><img ng-src="{{row.entity.imgIcon}}" width="16px"> <span ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget">{{COL_FIELD}}</span></div>';self.stopPropagation=function(event){event.preventDefault();event.stopPropagation()};self.gridCellTemplateWithMenu='<div class="ui-grid-cell-contents ng-scope" style="cursor: pointer;" title="{{COL_FIELD}}"><span ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget">{{COL_FIELD}}</span></div>';function getRowMenus(rows){$scope.menuOptions=[{name:"Map",action:function(){$scope.onMapDevices(rows)},template:"Map"}];1===self.selectedRows.length&&$scope.menuOptions.push({name:"Configuration File",action:function(){$scope.getConfig(rows)},template:"Configuration File"});1===self.selectedRows.length&&$scope.hasDevSettingsMgmtPermission&&$scope.menuOptions.push({name:"Shared Device Settings",action:function(){$scope.getDeviceSetting(rows)},template:"Shared Device Settings"});1===self.selectedRows.length&&$scope.menuOptions.push({name:"Private CLI Settings",action:function(){$scope.getPrivateCliSetting(rows)},template:"Private CLI Settings"});$scope.canRemoveDeviceFromDomain&&$scope.isSiteDevice&&$scope.menuOptions.push({name:"Remove from Domain",action:function(){$scope.removeDevice(rows)},template:"Remove from Domain"});return $scope.menuOptions}self.getDeviceSetting=function(row){var device=row.entity.deviceId;httpDeviceSettingSrvc.openSharedDeviceSettingsModal(device,$scope)};self.getPrivateCliSetting=function(row){var device=row.entity;httpDomainAdminNewSrvc.getAccessCredentialSetting().then((function(cmSetting){cmSetting.accessCredentialOption===CMLiveAccessOptions.SharedOnly?nbAlertSrvc.warning({message:"Private CLI Settings have been disabled by the administrator. Please contact your administrator to change the access credential Settings."}):httpPrivateDeviceSettingSrvc.openPrivateDeviceSettingsModal(userSrvc.getUserID(),device.deviceId,$scope)}),(function(error){100017===error.ResultCode?nbAlertSrvc.warning("You don't have the privilege to manage private CLI settings. Contact your administrator for details."):nbAlertSrvc.warning(error.ResultDesc)}))};self.getConfig=function(row){var device=row.entity.deviceId;var deviceType=row.entity.type;self.openConfigFilePopout(device,deviceType)};self.openConfigFilePopout=function(deviceId,deviceType){httpDeviceSrvc.getDomainListByDevIdList([deviceId]).then((function(arrResults){var currObj=arrResults[0];self.deviceTenantDomain={TenantGuid:httpAuthSrvc.getDataSrc(utilitySrvc).TenantGuid,DomainGuid:[]};self.deviceTenantDomain.DomainGuid.push(currObj.domainId);self.action_popout_config(deviceId,deviceType)}))};self.action_popout_config=function(deviceId,deviceType){$uibModal.open({templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",backdrop:"static",resolve:{args:function(){var args={};args.currTenantDomain=self.deviceTenantDomain;args.isConfigFile=!0;args.deviceId=deviceId;args.deviceType=deviceType;args.dataType=DeviceDataType.Config;return args}}})};self.onMapDevices=function(rows){var deviceObjs=[];self.isSiteDevice?angular.isArray(rows)?angular.forEach(rows,(function(row){var devObj={id:row.deviceId,isSite:!1};deviceObjs.push(devObj)})):deviceObjs.push({id:rows.entity.deviceId,isSite:!1}):angular.isArray(rows)?angular.forEach(rows,(function(row){var devObj={id:row.ID,isSite:!0};deviceObjs.push(devObj)})):deviceObjs.push({id:rows.entity.ID,isSite:!0});var data={actionType:NetBrain.Common.Const.ActionType.DrawDevice,actionData:deviceObjs};nbDragDropSrvc.drawDevice(data)};self.deleteDeviceDoneListener=ngHub.getInstance().registerEvent("DeleteDeviceDone",(function(data){self.$apply((function(){var selectedIds=[];if(null!==data){var devices=data.devices.split(";");angular.forEach(devices,(function(r){selectedIds.push(r)}))}$rootScope.$emit(deviceBrowserEvent.deviceDeleted,selectedIds)}))}));self.removeDevice=function(rows){nbAlertSrvc.confirm({message:"Are you sure you want to remove the selected devices from current domain?"}).then((function(){var selectedIds=[];selectedIds=angular.isArray(rows)?rows.map((function(row){return row.deviceId})):[rows.entity.deviceId];$scope.deleteDeviceTaskId=Guid();httpDeviceSettingSrvc.deleteDevice($scope.deleteDeviceTaskId,selectedIds).then((function(){}))}))};self.siteDeviceGridOptions={onRegisterApi:function(gridApi){self.deviceGridApi=gridApi;gridApi.infiniteScroll.on.needLoadMoreData(self,self.scrollToBottom);gridApi.infiniteScroll.on.needLoadMoreDataTop(self,self.scrollToTop);gridApi.core.on.sortChanged(self,self.sortChanged);gridApi.selection.on.rowSelectionChanged(self,(function(){self.selectedRows=self.deviceGridApi.selection.getSelectedRows()}));gridApi.selection.on.rowSelectionChangedBatch(self,(function(){self.selectedRows=self.deviceGridApi.selection.getSelectedRows()}))},data:"deviceData",enableColumnResize:!0,multiSelect:!0,enableFullRowSelection:!0,enableRowHeaderSelection:!1,modifierKeysToMultiSelect:!0,enableColumnMenus:!1,enableRowActionMenu:!0,rowActionMenuItems:getRowMenus,enableRowContextMenu:!0,rowContextMenuItems:getRowMenus,columnDefs:[{field:"deviceName",displayName:"Hostname",cellTemplate:self.gridNameCellTemplate,width:"30%"},{field:"vendor",displayName:"Vendor",width:"20%",cellTemplate:self.gridCellTemplateWithMenu},{field:"model",displayName:"Model",width:"20%",cellTemplate:self.gridCellTemplateWithMenu},{field:"mgmtIP",displayName:"Management IP",cellTemplate:self.gridCellTemplateWithMenu}],rowTemplate:'<div nb-draggable="dragDeviceStart" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell"  ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell> </div>'};self.sortChanged=function(grid,sortColumns){if(sortColumns.length>0){self.sortField=sortColumns[0].field;self.sortOrder=sortColumns[0].sort.direction;self.initDevicePage()}};self.dragDeviceStart=function(dragScope,event){var deviceIds=function(){var deviceIds=[];angular.forEach(self.selectedRows,(function(row){deviceIds.push(row.deviceId)}));return deviceIds}();if(dragScope.row.entity){var devId=dragScope.row.entity.deviceId;-1===deviceIds.indexOf(devId)&&deviceIds.push(devId)}if(deviceIds&&0!==deviceIds.length){var dragDeviceObjs=[];angular.forEach(deviceIds,(function(deviceId){var dragDeviceObj={id:deviceId};dragDeviceObjs.push(dragDeviceObj)}));var dragData={isSiteDevices:!0,actionData:dragDeviceObjs,actionType:NetBrain.Common.Const.ActionType.DrawDevice};var dragDeviceString=JSON.stringify(dragData);event.dataTransfer.setData("text",dragDeviceString)}};self.initDevicePage=function(){self.deviceData=[];_pageNumber=1;_isLoading=!1;_isAllLoaded=!1;self.loadDeviceData()};self.scrollToBottom=function(){_isLoading?self.deviceGridApi.infiniteScroll.dataLoaded(!1,!_isAllLoaded):self.loadDeviceData()};self.scrollToTop=function(){self.deviceGridApi.infiniteScroll.dataLoaded(!1,!_isAllLoaded)};self.loadDeviceData=function(){if(!_isLoading){_isLoading=!0;self.filterOptions.filterTarget=self.filterOptions.searchKey;var queryParam={siteId:selectedNodeId,filterFields:["name","model","mgmtIP","vendor"],filterValue:self.filterOptions.filterTarget,sortField:self.sortField,sortOrder:self.sortOrder,pageNumber:_pageNumber,pageSize:100,useTemporaryStorage:!1};httpSiteSrvc.getSiteDevicesBySiteIDWithFilter(queryParam).then((function(devices){var deviceList=devices.memberList;1===queryParam.pageNumber&&(self.deviceData=[]);deviceList.length<99&&(_isAllLoaded=!0);if(deviceList.length>0){var devIds=[];angular.forEach(deviceList,(function(device){devIds.push(device.deviceId)}));httpDeviceSrvc.getSimpleDevicesByGuids(null,devIds).then((function(devicesInfos){angular.forEach(devicesInfos,(function(devInfo){_.findWhere(deviceList,{deviceId:devInfo.ID}).imgIcon=httpDeviceIconSrvc.getIconStreamURIBy2Id(devInfo.subType,devInfo.oid)}))}));self.deviceData=self.deviceData.concat(deviceList);self.deviceGridApi&&self.deviceGridApi.infiniteScroll.dataLoaded(!1,!_isAllLoaded)}}),(function(){_isLoading=!1;self.deviceGridApi.infiniteScroll.dataLoaded()})).then((function(){_isLoading=!1;_pageNumber++}))}};self.startFilter=function(event){13===event.keyCode&&self.isSiteDevice&&self.initDevicePage()};self.clearFilter=function(){self.filterOptions.filterTarget="";self.filterOptions.searchKey="";0===$scope.filterOptions.filterTarget.length&&($scope.isSiteDevice?$scope.initDevicePage():$scope.containerData=angular.copy($scope.orgContainerData))}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.deviceGroupTreeCtrl",DeviceGroupTreeCtrl);DeviceGroupTreeCtrl.$inject=["$scope","$rootScope","$uibModal","$log","$filter","$timeout","ivhTreeviewMgr","nb.datamodel.httpDeviceGroupSrvc","nb.netbrain.httpDeviceSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.netbrain.httpMediaSrvc","nb.common.nbDragDropSrvc","nb.ng.userSrvc","nb.uiframework.urlStateMgr","nb.ng.permissionSrvc","nb.common.nbAlertSrvc","nb.datamodel.linkGroupSrvc"];function DeviceGroupTreeCtrl($scope,$rootScope,$uibModal,$log,$filter,$timeout,ivhTreeviewMgr,httpDeviceGroupSrvc,httpDeviceSrvc,deviceTypeMgrSrvc,httpMediaSrvc,nbDragDropSrvc,userSrvc,urlStateMgr,permissionSrvc,nbAlertSrvc,linkGroupSrvc){var mplsSubtype=deviceTypeMgrSrvc.getSubtypeByTypeName("MPLS Cloud");var groupType_deviceGroup=1,groupType_linkGroup=2;$scope.createBy="";$scope.rootGroupMenu=[{template:"New Device Group",action:function(node){$scope.onCreateLinkGroup(node)}}];$scope.rootGroupDeviceOnlyMenu=[{template:"New Device Group",action:function(node){$scope.onCreateLinkGroup(node,!0)}}];$scope.allGroupMenu=[{template:"Move to Public",action:function(node,trvw){$scope.onPublic(node,trvw)}},{template:"Open Group Map",action:function(node,trvw){$scope.onOpenDeviceGroupMap(node,trvw)}},{template:"Draw Devices on Map",action:function(node,trvw){$scope.onDrawDevicesOnMap(node,trvw)},onlyShowForType:[groupType_deviceGroup]},{template:"Draw Devices and Interfaces on Map",action:function(node,trvw){$scope.onDrawDevicesAndIntfsOnMap(node,trvw)},onlyShowForType:[groupType_linkGroup]},{template:"Draw Group on Map",action:function(node,trvw){$scope.onDrawGroupOnMap(node,trvw)}},{template:"Edit",action:function(node){$scope.onEditLinkGroup(node,4===node.Type)}},{template:"Delete",action:function(node,trvw){$scope.onDelete(node,trvw)}}];$scope.sharedGroupMenu=[{template:"Open Group Map",action:function(node,trvw){$scope.onOpenDeviceGroupMap(node,trvw)}},{template:"Draw Devices on Map",action:function(node,trvw){$scope.onDrawDevicesOnMap(node,trvw)},onlyShowForType:[groupType_deviceGroup]},{template:"Draw Devices and Interfaces on Map",action:function(node,trvw){$scope.onDrawDevicesAndIntfsOnMap(node,trvw)},onlyShowForType:[groupType_linkGroup]},{template:"Draw Group on Map",action:function(node,trvw){$scope.onDrawGroupOnMap(node,trvw)}},{template:"Edit",action:function(node){$scope.onEditLinkGroup(node,4===node.Type)}},{template:"Delete",action:function(node,trvw){$scope.onDelete(node,trvw)}}];$scope.publicGroupMenu=[{template:"Open Group Map",action:function(node,trvw){$scope.onOpenDeviceGroupMap(node,trvw)}},{template:"Draw Devices on Map",action:function(node,trvw){$scope.onDrawDevicesOnMap(node,trvw)},onlyShowForType:[groupType_deviceGroup]},{template:"Draw Devices and Interfaces on Map",action:function(node,trvw){$scope.onDrawDevicesAndIntfsOnMap(node,trvw)},onlyShowForType:[groupType_linkGroup]},{template:"Draw Group on Map",action:function(node,trvw){$scope.onDrawGroupOnMap(node,trvw)}},{template:"View Detail",action:function(node,trvw){$scope.onViewDetail(node,trvw)}}];function InitPermission(){permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.sharedResourceManagement)?$scope.hasDeviceGroupPermission=!0:$scope.hasDeviceGroupPermission=!1}InitPermission();$scope.onClickTreeNode=function(node){if(!node.isParentNode){$rootScope.$emit(deviceBrowserEvent.deviceGroupNodeSelected,{ID:node.ID,isMPLSCloud:node.isMPLSCloud,isWAN:node.isWAN,isDMVPN:node.isDMVPN,groupType:node.Type,HasInterface:node.HasInterface});$scope.setChildrenSelect(node,!1)}};$scope.ivhTreeOptions={defaultSelectedState:!1,useCheckboxes:!1,validate:!0,expandToDepth:0,labelAttribute:"Name",idAttribute:"ID",childrenAttribute:"children",expandedAttribute:"expanded",selectedAttribute:"selected",enableMultipleSelect:!1,enableTwoWayBinding:!0,enableLabelExpand:!1,labelTemplate:function(node){var title=node.Name;node.isParentNode||node.HasInterface||(title+=" ("+node.CntDevices+")");return title=title.replace("<","&#60")},iconTemplate:function(node){var nodeTemplate='<div class="icon_nb_folder"></div>';void 0===node.HasInterface||node.isMPLSCloud||node.isWAN||node.isDMVPN||(nodeTemplate=node.HasInterface?'<div class="icon_nb_tree_linkgroup"></div>':'<div class="icon_nb_tree_devicegroup"></div>');node.isWAN&&(nodeTemplate='<div class="icon_nb_tree_wan"></div>');node.isDMVPN&&(nodeTemplate='<div class="icon_nb_tree_dmvpn"></div>');node.isMPLSCloud&&(nodeTemplate='<div class="icon_nb_tree_mplscloud"></div>');return nodeTemplate},nodeClickCallback:$scope.onClickTreeNode,enableNodeDropdown:{isDisplay:function(node){if(node.Type===deviceGroupType.Private&&"1"!==node.ID&&node.UserGuid!==userSrvc.getUserID())return!1;if("0"===node.ID){if(!1===$scope.hasDeviceGroupPermission)return!1}else{if("2"===node.ID)return!1;if(node.Type===deviceGroupType.Media)return!1;if("4"===node.ID&&!permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.sharePolicyMgmt))return!1;if(void 0===node.UserGuid&&void 0===node.isParentNode)return!1}return!0},dropdownItems:function(node){var menus;if(node.Type===deviceGroupType.Shared)if("0"===node.ID&&$scope.hasDeviceGroupPermission){$scope.createBy=deviceGroupType.Shared;menus=$scope.rootGroupMenu}else menus=$scope.hasDeviceGroupPermission?$scope.sharedGroupMenu:$scope.publicGroupMenu;else if(node.Type===deviceGroupType.Private)if("1"===node.ID){$scope.createBy=deviceGroupType.Private;menus=$scope.rootGroupMenu}else menus=$scope.hasDeviceGroupPermission?$scope.allGroupMenu:$scope.sharedGroupMenu;else if(node.Type===deviceGroupType.Policy)if("4"===node.ID){if(permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.sharePolicyMgmt)){$scope.createBy=deviceGroupType.Policy;menus=$scope.rootGroupDeviceOnlyMenu}}else menus=permissionSrvc.hasDomainPermission(NetBrain.NG.Permissions.sharePolicyMgmt)?$scope.sharedGroupMenu:$scope.publicGroupMenu;else node.Type===deviceGroupType.System&&(menus=$scope.publicGroupMenu);return _.filter(menus,(function(item){return void 0===item.onlyShowForType||void 0!==item.onlyShowForType&&item.onlyShowForType.indexOf(1==node.HasInterface?groupType_linkGroup:groupType_deviceGroup)>-1}))}}};$scope.onCreateLinkGroup=function(folder,onlyDevice){linkGroupSrvc.linkGroupDialog({isCreateNew:!0,onlyDevice:onlyDevice,deviceGroup:{Type:folder.Type}})};$scope.onEditLinkGroup=function(dg,onlyDevice){linkGroupSrvc.linkGroupDialog({deviceGroup:dg,isCreateNew:!1,onlyDevice:onlyDevice})};$scope.onDrawDevicesAndIntfsOnMap=function(dg){var dgID=dg.ID;httpDeviceGroupSrvc.getDevicesOfDeviceGroupByCondition(null,dgID,1e3,0).then((function(listDevicesAndIntfs){var drawData={actionData:listDevicesAndIntfs,actionType:NetBrain.Common.Const.ActionType.DrawDeviceAndIntfs};nbDragDropSrvc.drawDeviceAndIntfs(drawData)}))};$scope.onDrawDevicesOnMap=function(dg){var dgID=dg.ID;httpDeviceGroupSrvc.getDeviceGroupDevices(null,dgID).then((function(lsDevIds){var drawData={actionData:lsDevIds.map((function(guid){return{id:guid}})),actionType:NetBrain.Common.Const.ActionType.DrawDevice};nbDragDropSrvc.drawDevice(drawData)}))};$scope.onDrawGroupOnMap=function(dg){var drawData={actionData:[{id:dg.ID,name:dg.Name,hasInterface:dg.HasInterface}],actionType:NetBrain.Common.Const.ActionType.DrawDeviceGroup};nbDragDropSrvc.drawDeviceGroup(drawData)};$scope.dragDeviceGroup=function(scope,event){var dg=scope.node;var dgInfo=netBrain.Map.CompDeviceGroup.getDefaultJsonData();dgInfo.key=dg.ID;dgInfo.hostName=dg.Name;var draObj={isDeviceGroup:!0,dragNode:dgInfo};var dragDeviceString=JSON.stringify(draObj);event.dataTransfer.setData("text",dragDeviceString)};$scope.onOpenDeviceGroupMap=function(dg){var options={mapType:netBrain.Map.Const.MapType.deviceGroupMap,id:dg.ID};return urlStateMgr.openMap(options)};$scope.onViewDetail=function(dg){linkGroupSrvc.linkGroupDialog({deviceGroup:dg,isCreateNew:!1,isReadOnly:!0})};$scope.onPublic=function(node){httpDeviceGroupSrvc.isExistsInPublic(node.Name).then((function(isExist){if(isExist){nbAlertSrvc.error({message:"This category already contains a device group with the same name."})}else{node.Type=0;var dgIds=[node.ID];httpDeviceGroupSrvc.upTypeOfDeviceGroup(null,dgIds,node.Type).then((function(data){data&&$scope.initData()}))}}))};$scope.onDelete=function(dg){var error={message:"Error occurs when deleting Device Group!"};$uibModal.open({templateUrl:"modules/nbDataModel/deviceBrowser/views/deviceGroupDeletionConfirmationPopup.html",controller:"nb.datamodel.deviceGroupDeletionConfirmationPopupCtrl",windowClass:"deviceGroupDeletionConfirmationPopup",backdrop:"static",resolve:{args:function(){return{canRemoveDeviceFromDomain:function(){return permissionSrvc.hasSystemRole("systemAdmin")||permissionSrvc.hasTenantRole("tenantAdmin")||permissionSrvc.hasDomainRole("domainAdmin")||permissionSrvc.hasDomainRole("powerUser")||permissionSrvc.anyPermission("deviceManagement")}}}}}).result.then((function(re){!0===re.result&&httpDeviceGroupSrvc.deleteDeviceGroupByGuid(null,dg.ID,re.isDeleteDevices).then((function(res){if(res.result){var args={ID:dg.ID,groupType:dg.Type,isDeleted:!0,CntDevices:dg.CntDevices};$rootScope.$emit(deviceBrowserEvent.deviceGroupUpdated,args)}else nbAlertSrvc.error(error)}),(function(){nbAlertSrvc.error(error)}))}))};$scope.setChildrenSelect=function(node,isSelected){if(node.child&&node.child.length>0)for(var i=0;i<node.child.length;i++){var child=node.child[i];child.selected=isSelected;$scope.setChildrenSelect(child,isSelected)}};$scope.initData=function(dataSrc){$scope.treeData=[{ID:"1",Name:"My Device Groups",CntDevices:0,children:[],isParentNode:!0,Type:deviceGroupType.Private},{ID:"0",Name:"Public",CntDevices:0,children:[],isParentNode:!0,Type:deviceGroupType.Shared},{ID:"4",Name:"Policy Device Group",CntDevices:0,children:[],isParentNode:!0,Type:deviceGroupType.Policy},{ID:"2",Name:"System",CntDevices:0,children:[],isParentNode:!0,Type:deviceGroupType.System},{ID:"3",Name:"Media",CntDevices:0,children:[],isParentNode:!0,Type:deviceGroupType.Media}];httpDeviceGroupSrvc.getAllDeviceGroupInfo(!0).then((function(lsDeviceGroupInfo){lsDeviceGroupInfo.forEach((function(dgInfo){var dgType=dgInfo.Type;var targetIndex=-1;switch(dgType){case 0:targetIndex=1;break;case 1:targetIndex=0;break;case 2:targetIndex=3;break;case 3:targetIndex=4;break;case 4:targetIndex=2;break;default:targetIndex=dgType}var dgUserGuid=dgInfo.UserGuid;var dgCntDevices=dgInfo.CntDevices;if(1!==dgType||dgUserGuid===userSrvc.getUserID()){dgInfo.isParentNode=!1;$scope.treeData[targetIndex].children.push(dgInfo);$scope.treeData[targetIndex].CntDevices+=dgCntDevices}}));var length=$scope.treeData.length;var firstSelectIndex=0,secondSelectIndex=0;for(var i=0;i<length;i++)if($scope.treeData[i].children.length>0){$rootScope.$emit(deviceBrowserEvent.deviceGroupNodeSelected,{ID:$scope.treeData[i].children[0].ID,groupType:$scope.treeData[i].children[0].Type,HasInterface:$scope.treeData[i].children[0].HasInterface});firstSelectIndex=i;secondSelectIndex=$scope.treeData[i].children[0].ID;break}$timeout((function(){var firstSelectNode=$scope.treeData[firstSelectIndex];firstSelectNode.expanded=!0;var firstChildren=$scope.treeData[firstSelectIndex].children;var secondSelectNode=_.filter(firstChildren,(function(item){return secondSelectIndex===item.ID}))[0];secondSelectNode.selected=!0;$scope.setDeviceGroupTreeData({ID:secondSelectNode.ID,groupType:firstSelectNode.Type});$scope.ivhTreeOptions.treeObj.updateTree((function(){$scope.ivhTreeOptions.treeObj.openNodeById(firstSelectNode.ID)}))}),200)}),(function(reason){$log.error(reason)}));var mediaRoot=$scope.treeData[4];mediaRoot.children.push({ID:"Dmvpn",Name:"DMVPN",CntDevices:0,type:"Dmvpn",isDMVPN:!0});var lsTypes=["Wan","Dmvpn"];httpMediaSrvc.getMediaCntByTypes(dataSrc,lsTypes).then((function(dict){mediaRoot.children[2].CntDevices=dict.Wan;mediaRoot.CntDevices+=dict.Wan;mediaRoot.children[0].CntDevices=dict.Dmvpn;mediaRoot.CntDevices+=dict.Dmvpn;$scope.refreshing=!1}));mediaRoot.children.push({ID:mplsSubtype,Name:"MPLS Cloud",CntDevices:0,type:mplsSubtype,isMPLSCloud:!0});mplsSubtype||(mplsSubtype=1024);httpDeviceSrvc.getDeviceCntByType(mplsSubtype,dataSrc).then((function(re){var cntMPLS=re.result;mediaRoot.children[1].CntDevices=cntMPLS;mediaRoot.CntDevices+=cntMPLS}));mediaRoot.children.push({ID:"Wan",Name:"WAN Cloud",CntDevices:0,type:"Wan",isWAN:!0})};$scope.treeData&&0!==$scope.treeData.length||$scope.initData();$scope.$on(viewFrameEvent.refreshDeviceBrowser,(function(event,selectedTenant,lsSelectedDomains){if(!$scope.refreshing){$scope.refreshing=!0;InitPermission();var newDataSrc=null;selectedTenant&&lsSelectedDomains&&(newDataSrc={TenantGuid:selectedTenant.ID,DomainGuid:lsSelectedDomains.map((function(domainObj){return domainObj.guid}))});$scope.initData(newDataSrc)}}));$scope.updateTree=function(args){var ID=args.ID;var dgType=args.groupType;var isCreateNew=args.isCreateNew;var isDeleted=args.isDeleted;var targetIndex=-1;switch(dgType){case 0:targetIndex=1;break;case 1:targetIndex=0;break;case 2:targetIndex=3;break;case 3:targetIndex=4;break;case 4:targetIndex=2;break;default:targetIndex=dgType}if(isDeleted){$scope.ivhTreeOptions.treeObj.removeNodeById(ID);$scope.treeData[targetIndex].CntDevices-=args.CntDevices}else httpDeviceGroupSrvc.getDeviceGroupInfoByGuid(null,ID).then((function(dgInfo){args.HasInterface=dgInfo.HasInterface;var cntDevices=dgInfo.CntDevices;var dgName=dgInfo.Name;var targetIndex1=-1;switch(dgInfo.Type){case 0:targetIndex1=1;break;case 1:targetIndex1=0;break;case 2:targetIndex1=3;break;case 3:targetIndex1=4;break;case 4:targetIndex1=2;break;default:targetIndex1=dgType}if(isCreateNew){dgInfo.clickHandler=$scope.onClickTreeNode;$scope.ivhTreeOptions.treeObj.addNodes(dgInfo,$scope.treeData[targetIndex1].ID);$scope.ivhTreeOptions.treeObj.openNodeById($scope.treeData[targetIndex1].ID);$scope.ivhTreeOptions.treeObj.selectNode(dgInfo.ID);$scope.treeData[targetIndex1].CntDevices+=dgInfo.CntDevices}else{$scope.ivhTreeOptions.treeObj.updateNode(ID,{CntDevices:cntDevices,Name:dgName,HasInterface:dgInfo.HasInterface});var folderDevicesCnt=0;var lsDgs=$scope.treeData[targetIndex1].children;for(var j=0;j<lsDgs.length;j++){var dgNode=lsDgs[j];if(dgNode.ID===ID){dgNode.CntDevices=cntDevices;dgNode.Name=dgName;dgNode.HasInterface=dgInfo.HasInterface}folderDevicesCnt+=dgNode.CntDevices}$scope.treeData[targetIndex1].CntDevices=folderDevicesCnt}})).then((function(){$rootScope.$emit(deviceBrowserEvent.deviceGroupNodeSelected,args)}))};$rootScope.$on(deviceBrowserEvent.deviceGroupUpdated,(function(event,args){$scope.updateTree(args)}));$rootScope.$on(deviceBrowserEvent.mediaDeleted,(function(event,args){var cntDeleted=args.lsIds.length;var mediaRoot=$scope.treeData[4];mediaRoot.CntDevices-=cntDeleted;args.isWAN&&(mediaRoot.children[2].CntDevices-=cntDeleted);args.isDMVPN&&(mediaRoot.children[0].CntDevices-=cntDeleted)}));$rootScope.$on("searchDeviceGroup",(function(event,data){$timeout((function(){if($scope.searchData){var length=$scope.treeData.length;var args={ID:data.id};args.groupType=3;if(data.type){"Dmvpn"===data.type&&(args.isDMVPN=!0);"Wan"===data.type&&(args.isWAN=!0)}for(var i=0;i<length;i++)if($scope.treeData[i].children.length>0){var childLength=$scope.treeData[i].children.length;for(var j=0;j<childLength;j++){$scope.treeData[i].expanded&&($scope.treeData[i].expanded=!1);$scope.treeData[i].children[j].selected&&($scope.treeData[i].children[j].selected=!1)}}for(var k=0;k<length;k++)if($scope.treeData[k].children.length>0){var childLength1=$scope.treeData[k].children.length;for(var h=0;h<childLength1;h++){data.type||$scope.treeData[k].children[h].ID!==data.id||(args.groupType=$scope.treeData[k].Type);if($scope.treeData[k].children[h].ID===data.id||data.type&&$scope.treeData[k].children[h].ID===data.type){$scope.treeData[k].expanded||($scope.treeData[k].expanded=!0);if(!$scope.treeData[k].children[h].selected){$scope.treeData[k].children[h].selected=!0;args.HasInterface=$scope.treeData[k].children[h].HasInterface}}}}$rootScope.$emit(deviceBrowserEvent.deviceGroupNodeSelected,args)}}),500)}))}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.deviceGroupContentCtrl",deviceGroupContentCtrl);deviceGroupContentCtrl.$inject=["$scope","$rootScope","$log","$q","$filter","$timeout","$uibModal","uiGridConstants","nb.systemmodel.deviceTypeMgrSrvc","nb.systemmodel.deviceSchemaMgrSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.netbrain.httpDeviceSrvc","nb.netbrain.httpMediaSrvc","nb.qmap.mapManagerSrvc","nb.topo.httpExternNbrSrvc","nb.netbrain.httpDeviceSettingSrvc","nb.common.nbAlertSrvc","nb.ng.httpAuthSrvc","nb.ng.utilitySrvc","nb.common.nbDragDropSrvc","nb.ng.permissionSrvc","nb.dataview.applyDataViewSrvc","nb.systemmodel.httpDeviceIconSrvc"];function deviceGroupContentCtrl($scope,$rootScope,$log,$q,$filter,$timeout,$uibModal,uiGridConstants,deviceTypeMgrSrvc,deviceSchemaMgrSrvc,httpDeviceGroupSrvc,httpDeviceSrvc,httpMediaSrvc,mapManagerSrvc,httpExternNbrSrvc,httpDeviceSettingSrvc,nbAlertSrvc,httpAuthSrvc,utilitySrvc,nbDragDropSrvc,permissionSrvc,applyDataViewSrvc,httpDeviceIconSrvc){$scope.canRemoveDeviceFromDomain=permissionSrvc.hasSystemRole("systemAdmin")||permissionSrvc.hasTenantRole("tenantAdmin")||permissionSrvc.hasDomainRole("domainAdmin")||permissionSrvc.hasDomainRole("powerUser")||permissionSrvc.anyPermission("deviceManagement");$scope.isGridExist=!0;$scope.ID=null;var _isLoading=!1;var _isAllLoaded=!1;var _pageNumber=0;var _sortField="name";var _sortOrder="ASC";$scope.stopPropagation=function(event){event.preventDefault();event.stopPropagation()};$scope.colDefs=[];$scope.rowData=[];$scope.groupType;$scope.filterOptions={filterTarget:"",searchKey:""};function getSelectedDeviceIDs(){var deviceIds=[];var selectedRows=$scope.gridApi.selection.getSelectedRows();angular.forEach(selectedRows,(function(row){deviceIds.push(row.ID)}));return deviceIds}$scope.gridOptions={columnDefs:$scope.colDefs,data:"rowData",enableRowActionMenu:!0,rowActionMenuItems:getRowMenus,enableRowContextMenu:!0,rowContextMenuItems:getRowMenus,modifierKeysToMultiSelect:!0,enableSorting:!0,enableColumnMenus:!1,enableRowSelection:!0,enableRowHeaderSelection:!1,enableFullRowSelection:!0,multiSelect:!0,rowTemplate:'<div nb-draggable=\'dragDeviceStart\' ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell></div>'};$scope.gridScrollTop=0;$scope.gridScrollLeft=0;$scope.gridOptions.onRegisterApi=function(gridApi){gridApi.infiniteScroll.on.needLoadMoreData($scope,$scope.scrollToBottom);$scope.gridApi=gridApi;if($scope.gridApi){$scope.gridApi.core.on.scrollEnd($scope,(function(evt){try{$scope.gridScrollTop=evt.getNewScrollTop()}catch(exception){$scope.gridScrollTop=0}try{$scope.gridScrollLeft=evt.getNewScrollLeft()}catch(exception){$scope.gridScrollLeft=0}}));$scope.gridApi.selection.on.rowSelectionChanged($scope,(function(){$scope.selectedRows=$scope.gridApi.selection.getSelectedRows()}));$scope.gridApi.selection.on.rowSelectionChangedBatch($scope,(function(){$scope.selectedRows=$scope.gridApi.selection.getSelectedRows()}));gridApi.core.on.sortChanged($scope,$scope.sortChanged)}};$scope.sortChanged=function(grid,sortColumns){if(!($scope.isMPLSCloud||$scope.isWAN||$scope.isDMVPN)&&sortColumns.length>0){_isLoading=!1;_sortField=sortColumns[0].field;_sortOrder=sortColumns[0].sort.direction;_isAllLoaded=!1;_pageNumber=0;$scope.rowData=[];$scope.gridOptions.data=$scope.rowData;$scope.gridApi.grid.refresh();$scope.getMoreData()}};$scope.scrollToBottom=function(){_isLoading||_isAllLoaded||$scope.getMoreData()};$scope.getMoreData=function(){if(!($scope.isMPLSCloud||$scope.isWAN||$scope.isDMVPN)){var deferred=$q.defer();_isLoading=!0;$scope.filterOptions.filterTarget=$scope.filterOptions.searchKey;httpDeviceGroupSrvc.getDevicesOfDeviceGroupByCondition(null,$scope.ID,50,_pageNumber,_sortField,_sortOrder,"name",$scope.filterOptions.filterTarget).then((function(lsDevs){0===lsDevs.length&&(_isAllLoaded=!0);_pageNumber++;lsDevs.forEach((function(devObj){devObj.iconPath=httpDeviceIconSrvc.getIconStreamURIBy2Id(devObj.subType,devObj.oid);devObj.isBrowseDevice=!0;if(!devObj.intfId){devObj.intfName="-";devObj.intfIp="-"}$scope.gridOptions.data.push(devObj)}));$scope.rowData=$scope.gridOptions.data;$scope.gridApi&&$scope.gridApi.infiniteScroll.dataLoaded().then((function(){deferred.resolve()}))}),(function(reason){$scope.gridApi.infiniteScroll.dataLoaded();deferred.reject(reason);$log.error("API Rejected")})).then((function(){_isLoading=!1}));return deferred.promise}};$scope.onClickMenuItem=function(rowObj,menuItem){if("Map"===menuItem)if(rowObj.isMedia){var drawMediaData={actionData:[{id:rowObj.ID,isMedia:!0,topoType:rowObj.topoType}],actionType:NetBrain.Common.Const.ActionType.DrawMedia};nbDragDropSrvc.drawMedia(drawMediaData)}else{var drawData={actionData:[{id:rowObj.ID}],actionType:NetBrain.Common.Const.ActionType.DrawDevice};nbDragDropSrvc.drawDevice(drawData)}"Remove from Domain"===menuItem&&$scope.onDeleteDevices([rowObj.ID])};$scope.dragDeviceIds=null;$scope.dragDeviceStart=function(dragScope,event){if(!$scope.HasInterface){var dragDeviceObjs=[];var dragData;if($scope.isWAN||$scope.isDMVPN){var selectedRows=$scope.gridApi.selection.getSelectedRows();angular.forEach(selectedRows,(function(row){var dragDeviceObj1={id:row.ID,topoType:row.topoType,isMedia:!0,isWAN:$scope.isWAN,isDMVPN:$scope.isDMVPN};dragDeviceObjs.push(dragDeviceObj1)}));if(dragScope.row.entity){var dragDeviceObj={id:dragScope.row.entity.ID,topoType:dragScope.row.entity.topoType,isMedia:!0,isWAN:$scope.isWAN,isDMVPN:$scope.isDMVPN};_.find(dragDeviceObjs,(function(item){return item.id===dragDeviceObj.id}))||dragDeviceObjs.push(dragDeviceObj)}dragData={actionData:dragDeviceObjs,actionType:NetBrain.Common.Const.ActionType.DrawMedia}}else{var deviceIds=getSelectedDeviceIDs();if(dragScope.row.entity){var devId=dragScope.row.entity.ID;-1===deviceIds.indexOf(devId)&&deviceIds.push(devId)}if(!deviceIds||0===deviceIds.length)return;$scope.dragDeviceIds=deviceIds;angular.forEach(deviceIds,(function(deviceId){var dragDeviceObj2={id:deviceId,isMPLSCloud:!0};dragDeviceObjs.push(dragDeviceObj2)}));dragData={actionData:dragDeviceObjs,actionType:NetBrain.Common.Const.ActionType.DrawDevice}}var dragDeviceString=JSON.stringify(dragData);event.dataTransfer.setData("text",dragDeviceString)}};function getRowMenus(rows){$scope.menuOptions=[];if($scope.HasInterface){1!==$scope.selectedRows.length||$scope.isWAN||$scope.isDMVPN||($scope.menuOptions=[{name:"Device Configuration File",action:function(){$scope.getConfig(rows)},template:"Device Configuration File"}]);$scope.menuOptions.push({name:"Map",action:function(){$scope.onMapDevices(rows)},template:"Map"})}else{$scope.menuOptions=[{name:"Map",action:function(){$scope.onMapDevices(rows)},template:"Map"}];1!==$scope.selectedRows.length||$scope.isWAN||$scope.isDMVPN||$scope.menuOptions.push({name:"Configuration File",action:function(){$scope.getConfig(rows)},template:"Configuration File"});!$scope.canRemoveDeviceFromDomain||$scope.groupType===deviceGroupType.System||$scope.isMPLSCloud||$scope.isWAN||$scope.isDMVPN||$scope.menuOptions.push({name:"Remove from Domain",action:function(){$scope.onDeleteDevices(rows)},template:"Remove from Domain"})}return $scope.menuOptions}$scope.getConfig=function(row){var device=row.entity.ID;var deviceType=row.entity.subType;$scope.openConfigFilePopout(device,deviceType)};$scope.openConfigFilePopout=function(deviceId,deviceType){httpDeviceSrvc.getDomainListByDevIdList([deviceId]).then((function(arrResults){var currObj=arrResults[0];$scope.deviceTenantDomain={TenantGuid:httpAuthSrvc.getDataSrc(utilitySrvc).TenantGuid,DomainGuid:[]};$scope.deviceTenantDomain.DomainGuid.push(currObj.domainId);$scope.action_popout_config(deviceId,deviceType)}))};$scope.action_popout_config=function(deviceId,deviceType){$uibModal.open({templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",backdrop:"static",resolve:{args:function(){var args={};args.currTenantDomain=$scope.deviceTenantDomain;args.isConfigFile=!0;args.deviceId=deviceId;args.deviceType=deviceType;args.dataType=DeviceDataType.Config;return args}}})};$rootScope.$on(deviceBrowserEvent.deviceGroupNodeSelected,(function(event,args){$scope.isGridExist=!1;$scope.gridOptions.columnDefs=null;$scope.gridOptions.data=[];if($scope.ID!=args.Id){_sortField="name";_sortOrder="ASC"}$timeout((function(){$scope.isGridExist=!0;$scope.filterOptions.filterTarget="";$scope.filterOptions.searchKey="";$scope.selectedRows=[];$scope.ID=args.ID;$scope.HasInterface=args.HasInterface;$scope.isMPLSCloud=args.isMPLSCloud;$scope.isWAN=args.isWAN;$scope.isDMVPN=args.isDMVPN;$scope.groupType=args.groupType;if($scope.isMPLSCloud||$scope.isWAN||$scope.isDMVPN){!function(){$scope.colDefs=[];$scope.gridOptions.columnDefs=null;$scope.gridCellTemplateWithMenu_media='<div class="ui-grid-cell-contents ng-scope" style="cursor: pointer;" title="{{COL_FIELD}}"><div><img ng-src="{{row.entity.iconPath}}" width="16px" /><span ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget">{{COL_FIELD}}</span></div>';var colName={field:"name",cellTemplate:$scope.gridCellTemplateWithMenu_media};$scope.colDefs.push(colName);$scope.gridOptions.columnDefs=$scope.colDefs;$scope.gridApi.grid.refresh()}();if($scope.isMPLSCloud)httpDeviceSrvc.getDevicesByTypes([$scope.ID],null).then((function(lsMedias){$scope.rowData=lsMedias.map((function(mediaObj){mediaObj.iconPath=httpDeviceIconSrvc.getIconStreamURIBy2Id($scope.ID);mediaObj.isMedia=!1;return mediaObj}));$scope.gridOptions.data=$scope.rowData;$scope.gridApi.grid.refresh();$timeout((function(){var selectedRow=_.find($scope.gridApi.grid.rows,(function(row){return 1024===row.entity.subType?row.entity.subType===args.groupType:row.entity.type===args.groupType}));selectedRow&&$scope.gridApi.grid.api.selection.selectRow(selectedRow.entity)}),500)}));else{var typeName=null;$scope.isWAN?typeName="Wan":$scope.isDMVPN?typeName="Dmvpn":$log.error("Internal Error -- impossible typeName");httpMediaSrvc.getMediasByType(null,typeName).then((function(lsMedias){_.each(lsMedias,(function(media){media.name=media.uniName;media.isMedia=!0;$scope.isWAN?media.iconPath=NetBrain.NG.Const.iconImagePath+"WAN.png":$scope.isDMVPN?media.iconPath=NetBrain.NG.Const.iconImagePath+"DMVPN.png":$log.error("Internal Error -- Impossible Media Type")}));$scope.rowData=lsMedias;$scope.gridOptions.data=$scope.rowData;$scope.gridApi.core.refresh();$timeout((function(){var selectedRow=_.find($scope.gridApi.grid.rows,(function(row){return 1024===row.entity.subType?row.entity.subType===args.groupType:row.entity.type===args.groupType}));selectedRow&&$scope.gridApi.grid.api.selection.selectRow(selectedRow.entity)}),500)}))}}else{!function(){$scope.colDefs=[];$scope.gridCellTemplateWithFilter='<div class="ui-grid-cell-contents" style="cursor: pointer;" title="{{COL_FIELD}}"><span ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget">{{COL_FIELD}}</span></div>';$scope.gridCellTemplateWithFilterAndIcon='<div class="ui-grid-cell-contents" style="cursor: pointer;" title="{{COL_FIELD}}"><img ng-src="{{row.entity.iconPath}}" width="16px" /> <span ng-bind-html="COL_FIELD | nbHighlight : grid.appScope.filterOptions.filterTarget">{{COL_FIELD}}</span></div>';$scope.gridCellTemplateWithMenu_device='<div class="ui-grid-cell-contents ng-scope" style="cursor: pointer;" title="{{COL_FIELD}}" ng-bind-html="COL_FIELD"></div>';var colName={field:"name",displayName:deviceSchemaMgrSrvc.getSchemaObjByKey("name").getDisplayName(),cellTemplate:$scope.gridCellTemplateWithFilterAndIcon,width:"30%"};$scope.colDefs.push(colName);if(!$scope.HasInterface){var colVendor={field:"vendor",displayName:deviceSchemaMgrSrvc.getSchemaObjByKey("vendor").getDisplayName(),cellTemplate:$scope.gridCellTemplateWithMenu_device,width:"20%"};$scope.colDefs.push(colVendor);var colModel={field:"model",displayName:deviceSchemaMgrSrvc.getSchemaObjByKey("model").getDisplayName(),cellTemplate:$scope.gridCellTemplateWithMenu_device,width:"20%"};$scope.colDefs.push(colModel)}var colMip={field:"mgmtIP",displayName:deviceSchemaMgrSrvc.getSchemaObjByKey("mgmtIP").getDisplayName(),cellTemplate:$scope.gridCellTemplateWithMenu_device};$scope.colDefs.push(colMip);if($scope.HasInterface){var colInterfaceName={field:"intfName",displayName:"Interface",cellTemplate:$scope.gridCellTemplateWithMenu_device,width:"20%"};$scope.colDefs.push(colInterfaceName);var colInterfaceIP={field:"intfIp",displayName:"Interface IP",cellTemplate:$scope.gridCellTemplateWithMenu_device,width:"20%"};$scope.colDefs.push(colInterfaceIP)}$scope.gridOptions.columnDefs=$scope.colDefs}();_isLoading=!1;_isAllLoaded=!1;_pageNumber=0;$scope.rowData=[];$scope.gridOptions.data=$scope.rowData;$scope.gridApi&&$scope.gridApi.core.refresh();$scope.getMoreData()}}))}));$scope.clearFilter=function(){$scope.filterOptions.filterTarget="";$scope.filterOptions.searchKey="";if(""===$scope.filterOptions.filterTarget)if($scope.isMPLSCloud||$scope.isWAN||$scope.isDMVPN)$scope.gridOptions.data=$filter("visibleColumnsFilter")($scope.rowData,$scope.gridOptions,$scope.filterOptions.filterTarget);else{$scope.initPaging();$scope.getMoreData()}};$scope.startFilter=function(event){if(13===event.keyCode){$scope.filterOptions.filterTarget=$scope.filterOptions.searchKey;if($scope.isMPLSCloud||$scope.isWAN||$scope.isDMVPN)$scope.gridOptions.data=$filter("visibleColumnsFilter")($scope.rowData,$scope.gridOptions,$scope.filterOptions.filterTarget);else{$scope.initPaging();$scope.getMoreData()}}};$scope.stopFilter=function(){};$scope.initPaging=function(){_pageNumber=0;_isLoading=!1;_isAllLoaded=!1;$scope.gridOptions.data=[];$scope.gridApi&&$scope.gridApi.core.refresh()};$scope.onMapDevices=function(rows){var mediaObjs=[];var deviceObjs=[];angular.isArray(rows)?rows.forEach((function(row){row.isMedia?mediaObjs.push({id:row.ID,isMedia:!0,topoType:row.topoType}):deviceObjs.push(row)})):rows.entity.isMedia?mediaObjs.push({id:rows.entity.ID,isMedia:!0,topoType:rows.entity.topoType}):deviceObjs.push(rows.entity);if(0!==mediaObjs.length){var drawMediaData={actionData:mediaObjs,actionType:NetBrain.Common.Const.ActionType.DrawMedia};nbDragDropSrvc.drawMedia(drawMediaData)}if(0!==deviceObjs.length){var drawData={actionData:deviceObjs,actionType:NetBrain.Common.Const.ActionType.DrawDeviceAndIntfs};nbDragDropSrvc.drawDeviceAndIntfs(drawData)}};$scope.deleteDeviceDoneListener=ngHub.getInstance().registerEvent("DeleteDeviceDone",(function(data){$scope.$apply((function(){var selectedIds=[];if(null!=data){var devices=data.devices.split(";");angular.forEach(devices,(function(r){selectedIds.push(r)}))}$rootScope.$emit(deviceBrowserEvent.deviceDeleted,selectedIds)}))}));$scope.onDeleteDevices=function(rows){var argDevIds=[];angular.isArray(rows)?argDevIds=rows.map((function(row){return row.ID})):argDevIds.push(rows.entity.ID);var dialogOptionsConfirmation={message:"Are you sure you want to remove the selected devices from current domain?"};var dialogOptionsError={message:"Error occurs during updating device group!"};$scope.isWAN||$scope.isDMVPN?nbAlertSrvc.confirm(dialogOptionsConfirmation).then((function(){var lsMediaIds=argDevIds||getSelectedDeviceIDs();for(var i=0;i<$scope.rowData.length;i++)if(lsMediaIds.indexOf($scope.rowData[i].ID)>=0){$scope.rowData.splice(i,1);i--}var args={isWAN:$scope.isWAN,isDMVPN:$scope.isDMVPN,lsIds:lsMediaIds};$rootScope.$emit(deviceBrowserEvent.mediaDeleted,args)})):nbAlertSrvc.confirm(dialogOptionsConfirmation).then((function(){var lsDevIds=argDevIds||getSelectedDeviceIDs();$scope.deleteDeviceTaskId=Guid();httpDeviceSettingSrvc.deleteDevice($scope.deleteDeviceTaskId,lsDevIds).then((function(){}),(function(reason){dialogOptionsError.detail=reason;nbAlertSrvc.error(dialogOptionsError)}))}))};$scope.$on(viewFrameEvent.refreshDeviceBrowser,(function(){$scope.filterOptions.filterTarget="";$scope.filterOptions.searchKey="";$scope.rowData=[];$scope.selectedRows=[];$scope.gridOptions.data=$scope.rowData;$scope.gridApi.core.refresh()}));$rootScope.$on(deviceBrowserEvent.deviceGroupUpdated,(function(event,args){if(args.isDeleted&&$scope.ID===args.ID){$scope.filterOptions.filterTarget="";$scope.filterOptions.searchKey="";$scope.rowData=[];$scope.selectedRows=[];$scope.gridOptions.data=$scope.rowData;$scope.gridApi.core.refresh()}}))}}();!function(){angular.module("nb.datamodel").controller("nb.datamodel.deviceGroupDeletionConfirmationPopupCtrl",DeviceGroupDeletionConfirmationPopupCtrl);DeviceGroupDeletionConfirmationPopupCtrl.$inject=["$scope","$rootScope","$log","$uibModalInstance","args"];function DeviceGroupDeletionConfirmationPopupCtrl($scope,$rootScope,$log,$uibModalInstance,args){$scope.canRemoveDeviceFromDomain=args.canRemoveDeviceFromDomain;$scope.isDeleteDevices={bOption:!1};$scope.onOK=function(){$uibModalInstance.close({result:!0,isDeleteDevices:$scope.isDeleteDevices.bOption})};$scope.onCancel=function(){$uibModalInstance.close({result:!1,isDeleteDevices:$scope.isDeleteDevices.bOption})}}}(NetBrain);var siteCategory={RootSite:0,ContainerSite:1,LeafSite:2};var deviceGroupType={Shared:0,Private:1,System:2,Media:3,Policy:4};!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.externalAPIServerManagerCtrl",externalAPIServerManagerCtrl);externalAPIServerManagerCtrl.$inject=["$scope","$uibModal","$log","nb.ng.utilitySrvc","nb.common.nbAlertSrvc","nb.ng.httpAuthSrvc","nb.common.nbToastr","nb.datamodel.httpExternalAPIServerSrvc","$q","nb.ng.httpDownloadingSrvc","nb.ng.inputFileSrvc"];function externalAPIServerManagerCtrl($scope,$uibModal,$log,utilitySrvc,nbAlertSrvc,httpAuthSrvc,nbToastr,httpExternalAPIServerSrvc,$q,httpDownloadingSrvc,inputFileSrvc){$scope.onClose=function(){};$scope.onAdd=function(){$scope.openExternalAPIServerEditor(null)};$scope.onEdit=function(rowData){$scope.openExternalAPIServerEditor(rowData)};$scope.onClick=function(row){var serverId=row.id;httpExternalAPIServerSrvc.getDeviceCount(serverId).then((function(jsonData){jsonData>0&&(row.deviceCounts=jsonData)}),(function(error){nbAlertSrvc.error({message:"Failed to check the device count."})}))};$scope.onRefresh=function(){grid.load()};$scope.value=!0;$scope.onDelete=function(){$scope.getSelectedRowsCount()?nbAlertSrvc.confirm({message:"Do you want to delete this external API server?"}).then((function(){var ids=_.map(grid.getSelectedRows(),(function(item){return item.id}));httpExternalAPIServerSrvc.deleteExternalServerById(ids).then((function(jsonData){1==jsonData?ids.forEach((function(val){grid.removeRow({id:val})})):nbAlertSrvc.error({message:"Failed to delete the external API server."})}),(function(error){nbAlertSrvc.error({message:error.ResultDesc})}))})):nbAlertSrvc.error({message:"Please select at least one external API server."})};$scope.checkAllDeviceCounts=function(serverIds){httpExternalAPIServerSrvc.checkDeviceCounts(serverIds).then((function(jsonData){var jsonResult=JSON.stringify(jsonData);null!=jsonResult&&void 0!==jsonResult&&JSON.parse(jsonResult,(function(k,v){!function(serverId,count){var rows=grid.getGridRows();if(null!=rows&&void 0!==rows)for(var i=0;i<rows.length;i++)if(rows[i].id===serverId){rows[i].deviceCounts=count;break}}(k,v)}))}),(function(error){nbAlertSrvc.error({message:"Failed to check the device count."})}))};$scope.onExportToZip=function(){openExternalAPIServerPwdDialog(!1).then((function(pwd){var tenandId=httpAuthSrvc.getSelectedTenantId();var domainId=httpAuthSrvc.getSelectedDomainIds()[0];var sdnDefinitionUrl=NetBrain.NG.ConfigSettings.API_ROOT+"/externalAPIServer/exportAllAPIServersV2/";httpDownloadingSrvc.getTicket().then((function(ticketData){sdnDefinitionUrl+="?password="+pwd+"&dl_ticket="+ticketData+"&TenantGuid="+tenandId+"&DomainGuid="+domainId;httpDownloadingSrvc.downloadFile(sdnDefinitionUrl)}),(function(){nbAlertSrvc.error("Failed to get downloading ticket...")}))}))};$scope.onImportCSV=function(){inputFileSrvc.createInputFile({scope:$scope,fileAccept:".csv, .zip",fileChange:"onFileSelect"})};$scope.onFileSelect=function(files){if(files&&files[0]){switch((filename=files[0].name,(parts=filename.split("."))[parts.length-1]).toLowerCase()){case"csv":$scope.onFileSelectImportCSV(files);break;case"zip":$scope.onFileSelectImportZip(files);break;default:nbAlertSrvc.error("Failed to import the selected file. The file format is invalid or not supported.")}}var filename,parts};$scope.onFileSelectImportCSV=function(files){var defered=$q.defer();var reader=new FileReader;reader.onload=function(){var dataContent=$scope.CSVConvertToJson(reader.result,{"API Source Type":"apiSourceType","Server Name":"serverName",Description:"desc",Endpoint:"endpoint",Username:"username",Password:"password",Parameters:"parameters",FrontServerAndGroupId:"frontServerAndGroupId",ServerType:"serverType",ServerTypeId:"serverTypeId"});var serverArray=function(importServers){$scope.existSeverList=[];var serverArray=[];var rows=grid.getGridRows();if(null!=rows&&null!=rows)for(var j=0;j<importServers.length;j++){var isExist=!1;for(var i=0;i<rows.length;i++)if(rows[i].serverName==importServers[j].serverName){isExist=!0;$scope.existSeverList.push(importServers[j].serverName);break}isExist||serverArray.push(importServers[j])}return serverArray}(JSON.parse(dataContent));serverArray.length>0&&httpExternalAPIServerSrvc.upsertAPIServerClientModel(serverArray,!1).then((function(jsonData){grid.load();defered.resolve()}),(function(err){defered.reject(err);nbAlertSrvc.warning({message:"Failed to import the external API server in the CSV file."}).then((function(result){}))}));$scope.existSeverList.length>0&&nbAlertSrvc.notification({message:$scope.existSeverList.join()+" already exist."})};reader.readAsText(files[0]);return defered.promise};$scope.onFileSelectImportZip=function(files){var zipfile=files[0];if(null!=zipfile){var reader=new FileReader;reader.onload=function(){reader.result&&(reader.content=reader.result);var base64Content=btoa(reader.content);openExternalAPIServerPwdDialog(!0).then((function(pwd){httpExternalAPIServerSrvc.importAPIServers(base64Content,pwd).then((function(res){if(res.result){nbToastr.success(res.errorMsg,{positionClass:"toast-top-right"},{width:"380px"});grid.load()}else nbAlertSrvc.error(res.errorMsg)}),(function(err){nbAlertSrvc.error(err.ResultDesc)}))}))};reader.readAsBinaryString(zipfile)}};$scope.CSVConvertToJson=function(csv,headerMapping){var array=utilitySrvc.csvConvertToArray(csv);var objArray=[];for(var i=1;i<array.length;i++){objArray[i-1]={};for(var k=0;k<array[0].length&&k<array[i].length;k++){var key=array[0][k];if(!key)break;objArray[i-1].id=utilitySrvc.getGUID();key=headerMapping[key.trim()];if(null!=array[i][k])if("parameters"==key){null==objArray[i-1].extraParams&&(objArray[i-1].extraParams=[]);objArray[i-1].extraParams=JSON.parse(array[i][k])}else objArray[i-1][key]=array[i][k]}}var json=JSON.stringify(objArray);json.replace(/},/g,"},\r\n");return json};$scope.openExternalAPIServerEditor=function(currRowData){$scope.sdnDefinitionForm=$uibModal.open({templateUrl:"modules/nbDataModel/externalAPIServer/views/externalAPIServerModal.html",controller:"nb.datamodel.nbExternalAPIServerModalCtrl",backdrop:!1,windowClass:"externalAPIServerModal",size:"sm",resolve:{args:function(){var lsAllServerNames=$scope.gridOptions_sdnDefinition.data?$scope.gridOptions_sdnDefinition.data.map((function(row){return row.serverName})):[];if(currRowData&&currRowData.serverName){var targetIndex=lsAllServerNames.indexOf(currRowData.serverName);lsAllServerNames.splice(targetIndex,1)}var args={isEditing:currRowData&&null!=currRowData.id,allServerNames:lsAllServerNames};currRowData&&(args.currServerId=currRowData.id);return args}}});$scope.sdnDefinitionForm.result.then((function(scope){grid.load()}))};function getProxyAddress(row){if(!row||!row.proxyInfo||!row.proxyInfo.isEnabled)return"";var proxyAddress=row.proxyInfo.ip?row.proxyInfo.ip:"";proxyAddress&&proxyAddress.length>0&&(proxyAddress=!0===row.proxyInfo.isHttps?"https://"+proxyAddress:"http://"+proxyAddress);return proxyAddress}function getProxyPort(row){return row&&row.proxyInfo&&row.proxyInfo.isEnabled&&row.proxyInfo.port?row.proxyInfo.port:""}function openExternalAPIServerPwdDialog(_isImport){return $uibModal.open({templateUrl:"modules/nbDataModel/externalAPIServer/views/externalAPIServerPwdDialog.html",controller:"nb.datamodel.externalAPIServerPwdCtrl",windowClass:"externalAPIServerPwdPopup",backdrop:"static",resolve:{isImport:function(){return _isImport}}}).result}var cellTemplateTip='<div class="ui-grid-cell-contents" title="{{COL_FIELD}}"> {{COL_FIELD}} </div>';var grid={setting:function(){$scope.gridOptions_sdnDefinition={data:[],columnDefs:[{field:"id",displayName:"id",width:"3%",visible:!1},{field:"apiSourceType",displayName:"API Source Type",width:"8%",cellTemplate:cellTemplateTip},{field:"serverName",displayName:"Server Name",width:"12%",cellTemplate:'<div class="ui-grid-cell-contents" ng-click="grid.appScope.onEdit(row.entity)" title="{{grid.getCellValue(row, col)}}"><a href="javascript:;">{{grid.getCellValue(row, col)}}</a></div>'},{field:"desc",displayName:"Description",width:"20%",cellTemplate:cellTemplateTip},{field:"endpoint",displayName:"EndPoints",width:"20%",cellTemplate:cellTemplateTip},{field:"username",displayName:"Username",width:"20%",cellTemplate:cellTemplateTip},{field:"fsInfo",displayName:"Front Server / Front Server Group",width:"14%",cellTemplate:cellTemplateTip},{field:"deviceCounts",displayName:"Device Counts",width:"6%",cellTemplate:'<div class="ui-grid-cell-contents" ng-click="grid.appScope.onClick(row.entity)" title="{{grid.getCellValue(row, col)}}"><a href="javascript:;">{{grid.getCellValue(row, col)}}</a></div>'}],enableFullRowSelection:!0,multiSelect:!0,autoHeight:!0,enableColumnResize:!0,enableHeaderSearchBar:!1,enableHeaderBar:!0,enableHeaderDropdown:!1,enableRowActionMenu:!0,enableRowContextMenu:!0,modifierKeysToMultiSelect:!0,enableSelectAll:!1,enableRowHeaderSelection:!1,enableColumnMenus:!0,rowContextMenuItems:function(rows,grid,event){return rows.length>1?[{template:"<label>Delete</label>",action:function(rows,grid,event){$scope.onDelete()}}]:[{template:"<label>Edit</label>",action:function(rowData,grid,event){$scope.onEdit(rowData)}},{template:"<label>Delete</label>",action:function(rows,grid,event){$scope.onDelete()}}]},rowActionMenuItems:function(row,grid,event){return[{template:"<label>Edit</label>",action:function(rowData,grid,event){$scope.onEdit(rowData)}},{template:"<label>Delete</label>",action:function(row,grid,event){$scope.onDelete()}}]},headerBarBtnsOnLeft:[{template:'<i class="icon_nb_add icon-font-button"></i><label>Add</label>',isDisplay:!0,action:function(rows,grid,event){$scope.onAdd(null)}},{template:'<i class="icon_nb_import icon-font-button"></i><label>Import</label>',isDisplay:!0,action:function(rows,grid,event){$scope.onImportCSV()}},{template:'<i class="icon_nb_export"></i><label>Export</label>',action:function(rows,grid,event){$scope.onExportToZip()}}],headerBarBtnsOnRight:[{template:"<label>Check Device Counts</label>",isDisplay:!0,action:function(rows,grid,event){var serverIds=function(rows){var serverIds=[];if(null!=rows&&null!=rows)for(var i=0;i<rows.length;i++)serverIds.push(rows[i].entity.id);return serverIds}(grid.rows);$scope.checkAllDeviceCounts(serverIds)}},{template:'<i class="icon_nb_refresh_color icon-sm"></i> Refresh',isDisplay:!0,action:function(rows,grid,event){$scope.onRefresh()}}]};$scope.gridOptions_sdnDefinition.onRegisterApi=function(gridApi){$scope.gridApi=gridApi};$scope.getSelectedRowsCount=function(){return!!$scope.gridApi&&$scope.gridApi.selection.getSelectedRows().length};$scope.getGridRowsCount=function(){return $scope.gridOptions_sdnDefinition.data.length}},addRow:function(row){row.proxyAddress=getProxyAddress(row);row.proxyPort=getProxyPort(row);$scope.gridOptions_sdnDefinition.data.push(row)},addRows:function(rows){rows.forEach((function(row){row.proxyAddress=getProxyAddress(row);row.proxyPort=getProxyPort(row)}));$scope.gridOptions_sdnDefinition.data.push.apply($scope.gridOptions_sdnDefinition.data,rows)},removeRow:function(params){var index=_.findIndex($scope.gridOptions_sdnDefinition.data,params);index>-1&&$scope.gridOptions_sdnDefinition.data.splice(index,1)},getGridRows:function(){return $scope.gridOptions_sdnDefinition.data},getSelectedRows:function(){return $scope.gridApi.selection.getSelectedRows()},load:function(){httpExternalAPIServerSrvc.getAllExternalAPIServers().then((function(res){$scope.gridOptions_sdnDefinition.data=res||[]}),(function(error){nbToastr.error(error.ResultDesc)}))}};grid.setting();grid.load()}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.nbExternalAPIServerModalCtrl",ExternalAPIServerModalCtrl);ExternalAPIServerModalCtrl.$inject=["$scope","$rootScope","$uibModal","$uibModalInstance","$q","nb.ng.nbHttp","$timeout","$log","args","nb.datamodel.httpExternalAPIServerSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.systemmodel.deviceTypeMainMgrSrvc","nb.common.nbAlertSrvc","nb.ng.nbValidationSrvc","nb.discover.networkSettingSrvc"];function ExternalAPIServerModalCtrl($scope,$rootScope,$uibModal,$uibModalInstance,$q,nbHttp,$timeout,$log,args,httpExternalAPIServerSrvc,deviceTypeMgrSrvc,deviceTypeMainMgrSrvc,nbAlertSrvc,nbValidationSrvc,networkSettingSrvc){$scope.isEdit=args.isEditing;$scope.server={};$scope.isEdit||($scope.server.isPasswordNew=!0);$scope.lsAllServerNames=args.allServerNames?args.allServerNames:[];$scope.isShowParamList=!1;$scope.managedDevices=[];var lsOriginalDevIds=[];$scope.lsAddedDevs=[];$scope.lsDeletedDevs=[];$scope.selectedApiSourceId=null;$scope.lsApiSourceTypes=[];$scope.onSelectApiSourceType=function(argSelectedId){$scope.selectedApiSourceId=argSelectedId;$scope.server.serverTypeId=argSelectedId;var lsTarget=_.filter($scope.lsApiSourceTypes,(function(srcType){return srcType.id===argSelectedId}));lsTarget&&lsTarget.length>0&&($scope.server.serverType=lsTarget[0].type)};$scope.frontServersTreeData=[];$scope.frontServerOptions={expandToDepth:1,labelAttribute:"viewName",idAttribute:"id",childrenAttribute:"children",enableMultipleSelect:!1,nodeClickCallback:function(node,trvw){(fsOrFsgObj=node)&&($scope.server.frontServerAndGroupId=fsOrFsgObj.id);var fsOrFsgObj}};$scope.apiServerNameValidation={method:"blur",rules:[{ruleId:"required",errorMessage:"Please enter a server name."},{ruleId:"duplicationChecker",params:{lsExistingNames:$scope.lsAllServerNames},errorMessage:"The server name already exists."},{ruleId:"maxLength",params:{length:128},errorMessage:"A server name cannot exceed 128 characters"}]};$scope.descrValidation={method:"blur",rules:[{ruleId:"maxLength",params:{length:128},errorMessage:"Description cannot exceed 128 characters"}]};$scope.endpointsValidation={method:"blur",rules:[{ruleId:"required",errorMessage:"Endpoint is required!"},{ruleId:"validUrl",dynamicErrorMsgFunc:function(url){if(!url||0===url.length)return"Endpoint is required.";var urlSchema=null;var urlHost=null;var urlPort=null;if(-1===url.indexOf(":")){urlSchema=null;urlHost=url;urlPort=null}else{var i1=url.indexOf("://");-1!==i1&&(urlSchema=url.substring(0,i1+3));var i2=url.lastIndexOf(":");if(url.indexOf(":")===i2)if(-1!==i1){urlHost=url.substring(i1+3);urlPort=null}else{urlSchema=null;urlHost=url.substring(0,i2);urlPort=url.substring(i2)}else{urlSchema=-1===i1?null:url.substring(0,i1+3);urlHost=url.substring(-1===i1?0:i1+3,i2);urlPort=url.substring(i2)}}var errorMsg="";var funcIsValidUrlSchema=nbValidationSrvc.getValidator("validUrlSchema");var funcIsValidUrlHost=nbValidationSrvc.getValidator("validUrlHost");var funcIsValidUrlPort=nbValidationSrvc.getValidator("validUrlPort");urlSchema&&funcIsValidUrlSchema&&!funcIsValidUrlSchema(urlSchema)&&(errorMsg="Wrong url schema!");if(funcIsValidUrlHost&&!funcIsValidUrlHost(urlHost)){errorMsg&&0!==errorMsg.length&&(errorMsg+="  \r\n");errorMsg+="Wrong url host!"}if(urlPort&&funcIsValidUrlPort&&!funcIsValidUrlPort(urlPort)){errorMsg&&0!==errorMsg.length&&(errorMsg+="  \r\n");errorMsg+="Wrong url port!"}return errorMsg}}]};$scope.usernameValidation={method:"blur",rules:[{ruleId:"required",errorMessage:"Please enter a username."},{ruleId:"maxLength",params:{length:128},errorMessage:"Username cannot exceed 128 characters"}]};$scope.passwordValidation={method:"blur",rules:[{ruleId:"required",errorMessage:"Please enter a password."},{ruleId:"maxLength",params:{length:128},errorMessage:"Password cannot exceed 128 characters"}]};for(var i=0;i<$scope.managedDevices.length;i++){var devInfo=$scope.managedDevices[i];if(devInfo.ID&&devInfo.HostName)devInfo.name=devInfo.HostName;else{$scope.managedDevices.splice(i,1);i--}}$scope.onAllocateDevices=function(){$uibModal.open({templateUrl:"modules/nbDataModel/externalAPIServer/views/externalAPIServerAllocateDeviceDialog.html",controller:"nb.datamodel.nbExternalAPIServerAllocateDeviceDialogCtrl",windowClass:"allocate-device-dialog-ctrl",backdrop:"static",size:"sm",resolve:{args:{allDevices:$scope.managedDevices.filter((function(dev){return!(!dev.ID||!dev.HostName&&!dev.name)})),serverName:$scope.server.name,serverType:$scope.server.serverType,lsAddedDevs:$scope.lsAddedDevs,lsDeletedDevs:$scope.lsDeletedDevs}}}).result.then((function(resolve){if(resolve.hasEdit){$scope.managedDevices=resolve.lsDevs;var lsManagedDeviceIds=$scope.managedDevices.map((function(dev){return dev.ID}));$scope.lsAddedDevs=$scope.managedDevices.filter((function(dev){return!lsOriginalDevIds.includes(dev.ID)}));$scope.lsDeletedDevs=$scope.managedDevices.filter((function(dev){return!lsManagedDeviceIds.includes(dev.ID)}))}}),(function(reject){reject.hasEdit}))};$scope.onTestServer=function(){if(validateInput()){var currentFrontServerOrGroup=null;$scope.server.frontServerAndGroupId&&$scope.lsFrontServerOrGroups&&(currentFrontServerOrGroup=$scope.lsFrontServerOrGroups.find((function(fs){return fs.id===$scope.server.frontServerAndGroupId})));currentFrontServerOrGroup?$scope.testModal=$uibModal.open({templateUrl:"modules/nbDataModel/externalAPIServer/views/externalAPIServerTestModal.html",controller:"nb.datamodel.nbExternalAPIServerTestModalCtrl",backdrop:!1,windowClass:"externalAPIServerTestModal",size:"sm",resolve:{args:function(){return{server:$scope.server,frontServerAndGroup:currentFrontServerOrGroup}}}}):nbAlertSrvc.warning({message:"Please select a Front Server."})}else nbAlertSrvc.warning({message:"The action cannot be completed. Please make sure you have configured the server settings."})};$scope.triggerShowHideExtraParams=function(){$scope.isShowParamList=!$scope.isShowParamList};$scope.onClose=function(){$uibModalInstance.dismiss()};function upsertAPIServer(){var deferred=$q.defer();var clientModel={id:$scope.server.id,serverName:$scope.server.name,desc:$scope.server.description,apiSourceType:null,endpoint:$scope.server.endPointsString,username:$scope.server.username,password:$scope.server.isPasswordNew?$scope.server.password:"",extraParams:$scope.server.extraParams,frontServerAndGroupId:$scope.server.frontServerAndGroupId,serverType:$scope.server.serverType,serverTypeId:$scope.server.serverTypeId};(function(pwd){var defer=$q.defer();nbHttp.post("admin/getPublicKey",{},{}).then((function(data){var key,pwdRtn;if(!data||data.length<2)pwdRtn=pwd;else{setMaxDigits(129);key=new RSAKeyPair(data[0],"",data[1]);pwdRtn=encryptedString(key,pwd)}defer.resolve(pwdRtn)}),(function(reason){defer.reject(reason)}));return defer.promise})(clientModel.password).then((function(pwd){clientModel.password=pwd;httpExternalAPIServerSrvc.isServerExixted(clientModel).then((function(isExisted){isExisted?nbAlertSrvc.error({message:"The server name already exists. Please enter a different server name."}):httpExternalAPIServerSrvc.upsertAPIServerClientModel([clientModel],$scope.server.isPasswordNew).then((function(lsServerIds){if(lsServerIds&&0!==lsServerIds.length)deferred.resolve(lsServerIds[0]);else{$log.error("Failed on update external api server: "+$scope.server.name);deferred.reject()}}),(function(){deferred.reject()}))}))}),(function(error){deferred.reject(error)}));return deferred.promise}function updateManagedDevices(serverId){var deferred=$q.defer();var lsManagedDeviceIds=$scope.managedDevices.map((function(dev){return dev.ID}));var lsAddedDevs=lsManagedDeviceIds.filter((function(id){return!lsOriginalDevIds.includes(id)}));var lsDeletedDevs=lsOriginalDevIds.filter((function(id){return!lsManagedDeviceIds.includes(id)}));httpExternalAPIServerSrvc.updateManagedDevices(serverId||$scope.server.id,$scope.server.serverTypeId,lsAddedDevs,lsDeletedDevs).then((function(ret){if(ret)deferred.resolve();else{$log.error("Failed on update managed devices of external api server: "+$scope.server.name);deferred.reject()}}),(function(){deferred.reject()}));return deferred.promise}function validateInput(){var error=$(".externalAPIServerModal .validation-has-error");if(null!=error&&void 0!==error&&error.length>0){nbAlertSrvc.error({message:error.attr("uib-tooltip")});return!1}var bHasParamError=!1;$scope.server.extraParams&&$scope.server.extraParams.forEach((function(obj){if(obj&&obj.value&&" "!==obj.value&&(!obj.key||0===obj.key.length)){nbAlertSrvc.error({message:"Key is required."});bHasParamError=!0}}));return!bHasParamError}$scope.onOK=function(){if(validateInput())if($scope.server.endPointsString&&$scope.server.username&&$scope.server.name&&$scope.server.password)if($scope.server.serverTypeId)if($scope.isEdit){var lsPromises=[upsertAPIServer(),updateManagedDevices()];$q.all(lsPromises).then((function(){$uibModalInstance.close($scope)}))}else upsertAPIServer().then((function(serverId){updateManagedDevices(serverId).then((function(){$uibModalInstance.close($scope)}))}));else nbAlertSrvc.error({message:"Please select a technology type."});else nbAlertSrvc.error({message:"Please enter a value in the following fields: Server Name, Endpoint URL, Username, Password."})};lsInitServerId=args.currServerId?[args.currServerId]:null,lsPromises=[httpExternalAPIServerSrvc.getByIds(lsInitServerId),httpExternalAPIServerSrvc.getAPISourceTypesAndFrontServerOrGroups(),httpExternalAPIServerSrvc.getManagedDevicesByServerId(args.currServerId?args.currServerId:null)],$q.all(lsPromises).then((function(responseList){if(responseList){if(responseList[0]&&responseList[0].length>0){$scope.server=responseList[0][0];$rootScope.$emit(adminEvent.externalAPIServerLoaded);if($scope.server.endpoints&&$scope.server.endpoints.length>0){var lsEndPoints=$scope.server.endpoints.map((function(ep){return ep.endpoint}));$scope.server.endPointsString=lsEndPoints.join(";")}$timeout((function(){$scope.server.isPasswordNew=!1;$scope.server.password="******"}))}if(responseList[2]){$scope.managedDevices=responseList[2];$scope.managedDevices.forEach((function(devInfo){devInfo.name=devInfo.HostName}));lsOriginalDevIds=$scope.managedDevices.map((function(devInfo){return devInfo.ID}))}var prepData=responseList[1];if(prepData){if(prepData.apiSourceTypes&&prepData.apiSourceTypes.length>0){$scope.lsApiSourceTypes=prepData.apiSourceTypes;$scope.selectedApiSourceId=null;$scope.isEdit||($scope.selectedApiSourceId=$scope.lsApiSourceTypes[0].id);if($scope.server&&$scope.server.serverTypeId)for(var ii=0;ii<$scope.lsApiSourceTypes.length;ii++)if($scope.server.serverTypeId===$scope.lsApiSourceTypes[ii].id){$scope.selectedApiSourceId=$scope.lsApiSourceTypes[ii].id;break}}var frontServerAndGroups=[];var fsIdList=[];prepData.frontServerAndGroups&&prepData.frontServerAndGroups.length>0&&prepData.frontServerAndGroups.forEach((function(item){if(!1===item.isFSG&&!0===item.registered){frontServerAndGroups.push(item);fsIdList.push(item.id)}}));prepData.frontServerAndGroups&&prepData.frontServerAndGroups.length>0&&prepData.frontServerAndGroups.forEach((function(item){if(!0===item.isFSG&&item.fsIds&&item.fsIds.length>0)for(var ii=0;ii<item.fsIds.length;ii++)if(-1!==$.inArray(item.fsIds[ii],fsIdList)){frontServerAndGroups.push(item);break}}));if(frontServerAndGroups.length>0){$scope.lsFrontServerOrGroups=frontServerAndGroups;$scope.frontServersTreeData=networkSettingSrvc.formatFrontServerToTreeView($scope.lsFrontServerOrGroups,!1);$scope.server&&$scope.server.frontServerAndGroupId&&$scope.frontServersTreeData&&(function setSelectedFrontServer(frontServersTreeData,serverId){var setSuccess=!1;_.each(frontServersTreeData,(function(item){item.selected=item.id===serverId;setSuccess=setSuccess||item.selected;if(item.children){var setChildSuccess=setSelectedFrontServer(item.children,serverId);setSuccess=setSuccess||setChildSuccess}}));return setSuccess}($scope.frontServersTreeData,$scope.server.frontServerAndGroupId)||($scope.server.frontServerAndGroupId=""))}}}}));var lsInitServerId,lsPromises}}();!function(){angular.module("nb.datamodel").controller("nb.datamodel.nbExternalAPIServerTestModalCtrl",ExternalAPIServerTestModalCtrl);ExternalAPIServerTestModalCtrl.$inject=["$scope","$rootScope","$uibModal","$uibModalInstance","$q","$log","$interval","args","nb.admin.fscMgrSrvc","nb.ng.httpAuthSrvc","nb.admin.http3rdPartyApiIntegrationSrvc","nb.datamodel.httpExternalAPIServerSrvc"];function ExternalAPIServerTestModalCtrl($scope,$rootScope,$uibModal,$uibModalInstance,$q,$log,$interval,args,fscMgrSrvc,httpAuthSrvc,http3rdPartyApiIntegrationSrvc,httpExternalAPIServerSrvc){var server=args.server;if(args&&server){var frontServerAndGroup=args.frontServerAndGroup;$scope.currentTime=getCurrentDateTime();$scope.isTestFinished=!1;$scope.lsMsgs=[];$scope.onClose=function(){$scope.lsMsgs=[];$uibModalInstance.close($scope)};!function(){if(frontServerAndGroup){$scope.lsMsgs.push({msg:"Connecting to Front Server("+(frontServerAndGroup.isFSG?frontServerAndGroup.viewName:frontServerAndGroup.id)+") ...",isFailed:!1});fscMgrSrvc.getFsStatusList(httpAuthSrvc.getSelectedTenantId(),frontServerAndGroup.isFSG?"":frontServerAndGroup.id).then((function(lsFsStats){var bSucceed=!1;var lsTargetFsIds=frontServerAndGroup.fsIds;if(frontServerAndGroup.isFSG){var lsConnectedFsIds=[];lsFsStats.forEach((function(fsStatus){!fsStatus.connected&&fsStatus.fsID||-1!=lsTargetFsIds.indexOf(fsStatus.fsID)&&lsConnectedFsIds.push(fsStatus.fsID)}));lsConnectedFsIds.length>0&&(bSucceed=!0)}else if(lsFsStats){var currFsStatus=lsFsStats.find((function(fsStatus){return fsStatus.fsID===frontServerAndGroup.id}));currFsStatus&&currFsStatus.connected&&(bSucceed=!0)}if(bSucceed)$scope.lsMsgs.push({msg:"Successful",isSuccessful:!0});else{$scope.lsMsgs.push({msg:"Failed",isFailed:!0});$scope.isTestFinished=!0}}),(function(reason){$log.error(reason);$scope.lsMsgs.push({msg:"Failed",isFailed:!0});$scope.isTestFinished=!0})).then((function(){if($scope.isTestFinished)$scope.lsMsgs.push({msg:"End Time:"+getCurrentDateTime()});else{$scope.lsMsgs.push({msg:"Connecting to end points ("+server.endPointsString+") via Front Server("+(frontServerAndGroup.isFSG?frontServerAndGroup.viewName:frontServerAndGroup.id)+") ...",isFailed:!1});server.endpoint=server.endPointsString;httpExternalAPIServerSrvc.testExternalAPIServer(server,server.isPasswordNew).then((function(ret){if(ret){if(ret.isFailed){$scope.lsMsgs.push({msg:"Failed",isFailed:!0});$scope.lsMsgs.push({msg:ret.msg})}else{$scope.lsMsgs.push({msg:ret.msg});$scope.lsMsgs.push({msg:"Successful",isSuccessful:!0})}$scope.isTestFinished=!0}else{$scope.lsMsgs.push({msg:"Failed",isFailed:!0});$scope.isTestFinished=!0}}),(function(reason){$log.error(reason);$scope.lsMsgs.push({msg:"Failed",isFailed:!0});$scope.isTestFinished=!0})).then((function(){$scope.lsMsgs.push({msg:"End Time:"+getCurrentDateTime()})}))}}))}}()}else $log.error("No Server Info");function getCurrentDateTime(){var date=new Date;var yyyy=date.getFullYear().toString();var mm=(date.getMonth()+1).toString();var dd=date.getDate().toString();var mmChars=mm.split("");var ddChars=dd.split("");return yyyy+"-"+(mmChars[1]?mm:"0"+mmChars[0])+"-"+(ddChars[1]?dd:"0"+ddChars[0])+"  "+date.toTimeString().split(" ")[0]}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").controller("nb.datamodel.nbExternalAPIServerExtraParamCtrl",ExternalAPIServerExtraParamCtrl);ExternalAPIServerExtraParamCtrl.$inject=["$q","$scope","$rootScope"];function ExternalAPIServerExtraParamCtrl($q,$scope,$rootScope){$scope.keywords=[];function initDisplay(extraparam){$scope.keywords=[];extraparam&&0!==extraparam.length?$scope.keywords=extraparam:$scope.keywords.push({key:"",value:""},{key:"",value:""})}function updateKeywords(){var extraParams=[];for(var i in $scope.keywords)($scope.keywords[i].key&&$scope.keywords[i].key.length>0||$scope.keywords[i].value&&$scope.keywords[i].value.length>0)&&extraParams.push($scope.keywords[i]);$scope.$parent.server.extraParams=extraParams}$scope.dmManualDefPop&&$scope.$addEvent("beforeSave",(function(){return asyncSave()}));$scope.onUpdateKeywords=updateKeywords;$scope.onKeyup=function(event){updateKeywords()};$scope.onAddPatternInputElement=function(){var id=$scope.keywords.length;$scope.keywords.push({id:id,key:"",value:""})};$scope.onRemovePatternInputElement=function($index){$scope.keywords.splice($index,1);updateKeywords()};$rootScope.$on(adminEvent.externalAPIServerLoaded,(function(){initDisplay($scope.$parent.server.extraParams)}));$scope.$parent.server&&$scope.$parent.server.id||initDisplay($scope.$parent.server.extraParams);function getExistingKeys(currKey){var lsExistingKeys=[];$scope.keywords.forEach((function(obj){obj&&obj.key&&""!==obj.key&&lsExistingKeys.push(obj.key)}));if(currKey&&currKey.length>0){var targetIndex=lsExistingKeys.indexOf(currKey);targetIndex>-1&&lsExistingKeys.splice(targetIndex,1)}return lsExistingKeys}$scope.updateKeyInputValidator=function(currKey){$scope.keyInputValidator={method:"blur",rules:[{ruleId:"required",errorMessage:"Please enter a key."},{ruleId:"duplicationChecker",params:{lsExistingNames:getExistingKeys(currKey)},errorMessage:"This key already exists!"}]}};$scope.updateKeyInputValidator(null)}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.nbExternalAPIServerAllocateDeviceDialogCtrl",ExternalAPIServerAllocateDeviceDialogCtrl);ExternalAPIServerAllocateDeviceDialogCtrl.$inject=["$scope","$uibModalInstance","$q","args","$document","nb.ng.callbackSrvc","$uibModal","nb.netbrain.httpDeviceSrvc","nb.discover.httpNetworkSettingSrvc","nb.netbrain.httpDeviceSettingSrvc","$timeout"];function ExternalAPIServerAllocateDeviceDialogCtrl($scope,$uibModalInstance,$q,args,$document,callbackSrvc,$uibModal,httpDeviceSrvc,httpNetworkSettingSrvc,httpDeviceSettingSrvc,$timeout){var _pageNumber=0;var _pageSize=25;var _isAllLoaded=!1;var scrollTimerout=null;$scope.deviceData=[];$scope.filterObj={filterValue:""};$scope.lsAddedDevs=args.lsAddedDevs;$scope.lsDeletedDevs=args.lsDeletedDevs;$scope.lsAllDevs=[];if(args&&args.allDevices){$scope.lsAllDevs=args.allDevices;$scope.lsAllDevs.sort(devSorter)}$scope.serverName="";args&&args.serverName&&($scope.serverName=args.serverName);$scope.serverType=-1;args&&args.serverType&&($scope.serverType=args.serverType);var lsColumnFields=["name","vendor","model","mgmtIP"];var removeMenuItem={name:"Remove",template:"<label>Remove</label>",action:function(row,grid,event){!function(){if($scope.allocateDeviceGridSearchApi.selection.getSelectAllState()&&0===$scope.filterObj.filterValue.length){$scope.lsAllDevs=[];$scope.deviceData=[]}else{var lsDevsToRemove=$scope.allocateDeviceGridSearchApi.selection.getSelectedRows();var deviceIds=_.map(lsDevsToRemove,(function(item){return item.ID}));$scope.lsAllDevs=$scope.lsAllDevs.filter((function(devInfo){return!deviceIds.includes(devInfo.ID)}));$scope.lsAddedDevs=$scope.lsAddedDevs.filter((function(devInfo){return!deviceIds.includes(devInfo.ID)}));var lsCurrDeletedDevIds=$scope.lsDeletedDevs.map((function(devInfo){return devInfo.ID}));var lsNewDeletedDevs=lsDevsToRemove.filter((function(devInfo){return!lsCurrDeletedDevIds.includes(devInfo.ID)}));$scope.lsDeletedDevs=$scope.lsDeletedDevs.concat(lsNewDeletedDevs);refreshDeviceData($scope.filterObj.filterValue)}hasEdit=!0}()}};$scope.loading=!1;var hasEdit=!1;function loadDeviceData(keyword,isInit){var defer=$q.defer();if(isInit){_isAllLoaded=!1;_pageNumber=0}if(($scope.loading||_isAllLoaded)&&!isInit)return $q.resolve();$scope.loading=!0;var loadDataPromise=null;if(keyword&&0!==keyword.length){var allDevIds=$scope.lsAllDevs.map((function(dev){return dev.ID}));loadDataPromise=httpDeviceSrvc.getSimpleDevicesByIdsAndFilter(_pageSize,_pageNumber,allDevIds,keyword,lsColumnFields)}else{var lsCurrDevIds=$scope.lsAllDevs.slice(_pageNumber*_pageSize,(_pageNumber+1)*_pageSize,isInit).map((function(dev){return dev.ID}));loadDataPromise=httpDeviceSrvc.getSimpleDevicesByGuids(null,lsCurrDevIds)}loadDataPromise.then((function(data){if(data){data.length<_pageSize&&(_isAllLoaded=!0);var lsDeletedDevIds=$scope.lsDeletedDevs.map((function(devInfo){return devInfo.ID}));data=data.filter((function(devInfo){return!lsDeletedDevIds.includes(devInfo.ID)}));isInit&&($scope.deviceData=[]);$scope.deviceData=$scope.deviceData.concat(data);$scope.allocateDeviceGridSearchApi&&$scope.allocateDeviceGridSearchApi.infiniteScroll.dataLoaded(!1,!_isAllLoaded);$scope.loading=!1;defer.resolve()}else{_isAllLoaded=!0;$scope.loading=!1;defer.resolve()}}),(function(){$scope.loading=!1;$scope.allocateDeviceGridSearchApi&&$scope.allocateDeviceGridSearchApi.infiniteScroll.dataLoaded();defer.resolve()})).then((function(){$scope.loading=!1;_pageNumber++;defer.resolve()}));return defer.promise}$scope.scrollToBottom=function(){$scope.loading?$scope.allocateDeviceGridSearchApi.infiniteScroll.dataLoaded(!1,!_isAllLoaded):loadDeviceData($scope.filterObj.filterValue,!1)};$scope.scrollToTop=function(){$scope.allocateDeviceGridSearchApi.infiniteScroll.dataLoaded(!1,!_isAllLoaded)};function refreshDeviceData(keyword){_pageNumber=0;loadDeviceData(keyword,!0).then((function(){!function(){scrollTimerout&&$timeout.cancel(scrollTimerout);scrollTimerout=$timeout((function(){$scope.allocateDeviceGridSearchApi&&$scope.allocateDeviceGridSearchApi.infiniteScroll.resetScroll()}))}();$scope.allocateDeviceGridSearchApi.selection.clearSelectedRows()}),200)}$scope.deviceGridOptions={enableFullRowSelection:!0,enableRowHeaderSelection:!0,data:"deviceData",columnDefs:[{field:lsColumnFields[0],displayName:"Host Name",width:"200",cellTemplate:'<div class="ui-grid-cell-contents"><span class="dev-param-in-grid" title="{{row.entity.name}}" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.filterValue">{{row.entity.name}}</span></div>'},{field:lsColumnFields[1],displayName:"Vendor",width:"150",cellTemplate:('<div class="ui-grid-cell-contents"><span class="dev-param-in-grid" title="{{row.entity.vendor}}"  ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.filterValue">{{row.entity.vendor}}</span></div>','<div class="ui-grid-cell-contents"><span class="dev-param-in-grid" title="{{row.entity.vendor}}"  ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.filterValue">{{row.entity.vendor}}</span></div>')},{field:lsColumnFields[2],displayName:"Model",width:"150",cellTemplate:getModelCellTemplate()},{field:lsColumnFields[3],displayName:"Management IP",width:"*",cellTemplate:getManagementIPCellTemplate()}],enableColumnResizing:!1,enableRowActionMenu:!1,multiSelect:!0,modifierKeysToMultiSelect:!1,onRegisterApi:function(gridApi){$scope.allocateDeviceGridSearchApi=gridApi;$scope.allocateDeviceGridSearchApi.grid.registerRowsProcessor(deviceSingleFilter,200);$scope.allocateDeviceGridSearchApi.infiniteScroll.on.needLoadMoreData($scope,$scope.scrollToBottom);$scope.allocateDeviceGridSearchApi.infiniteScroll.on.needLoadMoreDataTop($scope,$scope.scrollToTop)}};if(1!==$scope.serverType){$scope.deviceGridOptions.enableRowActionMenu=!0;$scope.deviceGridOptions.rowActionMenuItems=function(){var actions=[];actions.push(removeMenuItem);return actions}}function getModelCellTemplate(){return'<div class="ui-grid-cell-contents"><span class="dev-param-in-grid" title="{{row.entity.model}}"  ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.filterValue">{{row.entity.model}}</span></div>'}function getManagementIPCellTemplate(){return'<div class="ui-grid-cell-contents"><span class="dev-param-in-grid" title="{{row.entity.managementIp}}"  ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.filterObj.filterValue">{{row.entity.mgmtIP}}</span></div>'}function deviceSingleFilter(renderableRows){var filter=$scope.filterObj.filterValue.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var matcher=new RegExp(filter,"i");renderableRows.forEach((function(row){var match=!1;lsColumnFields.forEach((function(field){row.entity[field]&&row.entity[field].match(matcher)&&(match=!0)}));match||(row.visible=!1)}));return renderableRows}$scope.doDeviceDataFilter=function(event,clear){if("clear"===clear||13===event.keyCode||27===event.keyCode||8===event.keyCode||46===event.keyCode){27===event.keyCode&&($scope.filterObj.filterValue="");"clear"===clear&&($scope.filterObj.filterValue="");""===$scope.filterObj.filterValue&&$scope.clearFilter();if(13===event.keyCode){var _keyWord=$scope.filterObj.filterValue;refreshDeviceData(_keyWord=_keyWord.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"));$scope.allocateDeviceGridSearchApi.grid.refresh()}$scope.allocateDeviceGridSearchApi.grid.selection.selectAll=!1}};$scope.clearFilter=function(){$timeout((function(){refreshDeviceData($scope.filterObj.filterValue)}));$scope.allocateDeviceGridSearchApi.grid.refresh()};$scope.onClickAddDevice=function(){$scope.selectDeviceModal=$uibModal.open({templateUrl:"modules/nbDataModel/common/views/selectDevicePopup.html",controller:"nb.datamodel.selectDevicePopupCtrl",windowClass:"selectDevicePopup",backdrop:"static",resolve:{singleSelectionOnly:function(){return!1},initDevices:function(){return $scope.lsAllDevs}}}).result.then((function(lsSelectedDevices){$scope.loading=!0;$scope.deviceData=lsSelectedDevices;$scope.lsAllDevs=_.map(lsSelectedDevices,(function(item){return{ID:item.ID,name:item.name}})).sort(devSorter);$scope.filterObj.filterValue="";refreshDeviceData("");hasEdit=!0}))};$scope.onOK=function(){var opts={lsDevs:$scope.lsAllDevs,hasEdit:hasEdit};$uibModalInstance.close(opts)};$scope.onClose=function(){var opts={lsDevs:$scope.lsAllDevs,hasEdit:hasEdit};$uibModalInstance.dismiss(opts)};$scope.onCancel=function(){var opts={lsDevs:$scope.lsAllDevs,hasEdit:hasEdit};$uibModalInstance.dismiss(opts)};function devSorter(a,b){return a.name.localeCompare(b.name)}!function(){$scope.loading=!0;$scope.deviceData=[];refreshDeviceData("")}()}}(NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.externalAPIServerPwdCtrl",ExternalAPIServerPwdCtrl);ExternalAPIServerPwdCtrl.$inject=["$scope","$uibModalInstance","isImport","nb.common.nbAlertSrvc","nb.ng.nbValidationSrvc"];function ExternalAPIServerPwdCtrl($scope,$uibModalInstance,isImport,nbAlertSrvc,nbValidationSrvc){$scope.isImport=isImport;$scope.APIServerPwdForm={importPwd:"",exportPwd:"",confirmPwd:""};$scope.validations={importPwd:{method:"blur",rules:[{ruleId:"required",errorMessage:"Import password is required."}]},exportPwd:{method:"blur",rules:[{ruleId:"required",errorMessage:"Export password is required."},{ruleId:"normalPassword",errorMessage:"Password should contains more than 6 characters, and have at least one letter, and one number."}]},confirmPwd:{method:"blur",rules:[{ruleId:"required",errorMessage:"Confirm password is required."},{ruleId:"matchField",params:{matchValue:$scope.APIServerPwdForm.exportPwd},errorMessage:"The password you entered doesn't match."}]}};$scope.onCancel=function(){$uibModalInstance.dismiss()};$scope.onOk=function(){nbValidationSrvc.submit("externalAPIServerPwdForm").then((function(){var res;$scope.APIServerPwdForm&&($scope.APIServerPwdForm.importPwd||$scope.APIServerPwdForm.exportPwd)&&(res=$scope.APIServerPwdForm.importPwd?$scope.APIServerPwdForm.importPwd:$scope.APIServerPwdForm.exportPwd);$uibModalInstance.close(res)}))}}}(NetBrain);!function(netBrain){angular.module("nb.datamodel").factory("nb.datamodel.httpExternalAPIServerSrvc",httpExternalAPIServerSrvc);httpExternalAPIServerSrvc.$inject=["nb.ng.nbHttp","$q"];function httpExternalAPIServerSrvc(nbHttp,$q){var service={getAllExternalAPIServers:function(){return nbHttp.get(path+"getAllAPIServers")},getByIds:function(lsServerIds){return nbHttp.post(path+"getByIds",lsServerIds)},getExternalServerInfosByIds:function(lsServerIds){return nbHttp.post(path+"getExternalServerInfosByIds",lsServerIds)},getAPISourceTypesAndFrontServerOrGroups:function(){return nbHttp.get(path+"getAPISourceTypesAndFrontServerOrGroups")},getExternalServerInfosByTechId:function(techId){return nbHttp.get("externalAPIServer/getExternalServerInfosByTechId/"+techId)},getAPISourceTypes:function(){return nbHttp.get(path+"getAPISourceTypes")},getManagedDevicesByServerId:function(strServerId){return nbHttp.get(path+"getDevicesByServerId/"+strServerId)},deleteExternalServerById:function(serverId){return nbHttp.post(path+"deleteAPIServer",serverId)},exportAllAPIServers:function(){return nbHttp.post(path+"exportAllAPIServersV2",null)},importAPIServers:function(file,pwd){var defer=$q.defer();(function(pwd){var defer=$q.defer();pwd||defer.resolve("");nbHttp.post("admin/getPublicKey",{},{}).then((function(data){var key,pwdRtn;if(!data||data.length<2)pwdRtn=pwd;else{setMaxDigits(129);key=new RSAKeyPair(data[0],"",data[1]);pwdRtn=encryptedString(key,pwd)}defer.resolve(pwdRtn)}),(function(reason){defer.reject(reason)}));return defer.promise})(pwd).then((function(res){nbHttp.post(path+"importAPIServersV2",{info:file,password:res}).then((function(data){defer.resolve(data)}),(function(err){defer.reject(err)}))}));return defer.promise},upsertAPIServerClientModel:function(lsExternalServerClientModal,bNeedEncryptPassword){return nbHttp.post(path+"upsertAPIServerClientModel/"+(bNeedEncryptPassword?"1":"0"),lsExternalServerClientModal)},isServerExixted:function(externalServerClientModal){return nbHttp.post(path+"isExisted",externalServerClientModal)},updateManagedDevices:function(externalApiServerId,externalApiServerTechId,addedDeviceIds,deletedDeviceIds){var requestInfo={externalAPIServerId:externalApiServerId,externalAPIServerTechId:externalApiServerTechId,addedDevices:addedDeviceIds,deletedDevices:deletedDeviceIds};return nbHttp.post(path+"updateManagedDevices",requestInfo)},testExternalAPIServer:function(server,isNewPassword){return nbHttp.post(path+"testExternalAPIServer/"+(isNewPassword?"1":"0"),server)},saveExternalServer:function(externalServerDatas,bEncryptPassword){return nbHttp.post(path+"upSertAPIServer/"+(bEncryptPassword?"1":"0"),externalServerDatas)},getAllSdnControllerDefs:function(iCheckInstance){return nbHttp.get(path+"getAllSdnControllerDefs/"+iCheckInstance)},getDeviceCount:function(serverId){return nbHttp.get(path+"getDeviceCount/"+serverId)},checkDeviceCounts:function(servers){return nbHttp.post(path+"checkDeviceCounts",servers)}};var path="externalAPIServer/";return service}}(NetBrain);!function(root,factory){"function"==typeof define&&define.amd?define("LinkGroup",["jquery","underscore"],factory):root.LinkGroup=factory($||jQuery,_)}(NetBrain,(function($,_){function LinkGroup(data,options){this.options=_.extend({},options);this.data=_.extend({Name:"",Description:"",AutoLink:!1},data);this.init()}var fn=LinkGroup.prototype;fn.init=function(){};fn.setName=function(name){this.data.Name=name};fn.setDesc=function(desc){this.data.Description=desc};fn.setType=function(type){this.data.Type=type};fn.setDevices=function(devices){this.data.AllItems=devices};fn.getData=function(){return this.data};fn.setDescription=function(description){return this.data.Description=description};return LinkGroup}));!function(NetBrain){angular.module("nb.datamodel").controller("nb.datamodel.linkGroupPopupCtrl",linkGroupPopupCtrl);linkGroupPopupCtrl.$inject=["$scope","$rootScope","$q","$timeout","$uibModal","$uibModalInstance","$interval","nb.datamodel.httpDeviceGroupSrvc","nb.datamodel.linkGroupSrvc","nb.netbrain.httpDeviceSrvc","nb.ng.callbackSrvc","nb.ng.userSrvc","nb.ng.utilitySrvc","nb.common.nbAlertSrvc","uiGridTreeBaseService","nb.ng.nbValidationSrvc","nb.ng.inputFileSrvc","args"];function linkGroupPopupCtrl($scope,$rootScope,$q,$timeout,$uibModal,$uibModalInstance,$interval,httpDeviceGroupSrvc,linkGroupSrvc,httpDeviceSrvc,callbackSrvc,userSrvc,utilitySrvc,nbAlertSrvc,uiGridTreeBaseService,nbValidationSrvc,inputFileSrvc,args){$scope.isReadOnly=!!args.isReadOnly;$scope.isCreateNew=!!args.isCreateNew;$scope.onlyDevice=!!args.onlyDevice;$scope.recaculate=!1;$scope.isSharedDeviceGroup=!(!args.deviceGroup||0!==args.deviceGroup.Type);$scope.type=args.deviceGroup&&args.deviceGroup.Type?args.deviceGroup.Type:$scope.isSharedDeviceGroup?0:1;$scope.search={filterContent:""};$scope.pageOptions={type:0,needMore:!1,pageIndex:1};$scope.allData=[];$scope.staticAndExclude=[];$scope.init=function(){if($scope.isCreateNew){args.deviceGroup&&void 0===args.deviceGroup.Type&&(args.deviceGroup.Type=$scope.type);$scope.baseInfo=linkGroupSrvc.getDefaultStructure(args.deviceGroup||{Type:$scope.type});$scope.dynamicSearchDeviceRules=linkGroupSrvc.formatDynamicSearchDeviceRules($scope.baseInfo);$scope.dynamicSearchInterfaceRules=linkGroupSrvc.formatDynamicSearchInterfaceRules($scope.baseInfo);if($scope.baseInfo.AllItems&&$scope.baseInfo.AllItems.length>0){$scope.staticAndExclude=_.map($scope.baseInfo.AllItems,(function(item){item.type=linkGroupSrvc.dataType[1];return item}));$scope.allData=$scope.staticAndExclude.concat([]);delete $scope.baseInfo.AllItems}return $q.resolve()}return linkGroupSrvc.getLinkDeviceBaseInfo(args.deviceGroup.ID).then((function(baseInfo){$scope.baseInfo=baseInfo;$scope.dynamicSearchDeviceRules=linkGroupSrvc.formatDynamicSearchDeviceRules(baseInfo);$scope.dynamicSearchInterfaceRules=linkGroupSrvc.formatDynamicSearchInterfaceRules(baseInfo);return linkGroupSrvc.getStaticAndExcludeList($scope.baseInfo.ID).then((function(staticAndExclude){$scope.staticAndExclude=staticAndExclude;return $scope.getDynamicList()}),(function(reason){nbAlertSrvc.error({message:utilitySrvc.getErrorMessage(reason)})}))}),(function(reason){nbAlertSrvc.error({message:utilitySrvc.getErrorMessage(reason)})}))};$scope.init();$scope.selectDevice=function(type){linkGroupSrvc.commonSelectDevice().then((function(res){var deviceData=linkGroupSrvc.formatStaticAndExcludeDevice(res,linkGroupSrvc.dataType[type]);linkGroupSrvc.commonAdd($scope.allData,$scope.staticAndExclude,deviceData)}))};$scope.selectInterface=function(type){linkGroupSrvc.commonSelectInterface().then((function(res){var interfaceData=linkGroupSrvc.formatStaticAndExcludeInterface(res,linkGroupSrvc.dataType[type]);linkGroupSrvc.commonAdd($scope.allData,$scope.staticAndExclude,interfaceData)}))};$scope.initSelectDynamic=function(res){$scope.search.filterContent="";$scope.dynamicSearchDeviceRules=res.deviceRules;$scope.dynamicSearchInterfaceRules=res.interfaceRules;$scope.allData=$scope.staticAndExclude.concat(res.data);$scope.pageOptions.type=1;$scope.pageOptions.needMore=res.data.length>=linkGroupSrvc.pageSize||!1;$scope.pageOptions.pageIndex=1;!1===res.useCache&&($scope.recaculate=!0);$timeout((function(){$scope.gridApi&&$scope.gridApi.infiniteScroll.resetScroll(!1,!0)}))};$scope.dynamicSearchDevice=function(){linkGroupSrvc.dynamicSearch({id:$scope.baseInfo.ID,type:"device",deviceRules:$scope.dynamicSearchDeviceRules,interfaceRules:$scope.dynamicSearchInterfaceRules}).then((function(res){$scope.initSelectDynamic(res)}))};$scope.dynamicSearchInterface=function(){linkGroupSrvc.dynamicSearch({id:$scope.baseInfo.ID,type:"interface",deviceRules:$scope.dynamicSearchDeviceRules,interfaceRules:$scope.dynamicSearchInterfaceRules}).then((function(res){$scope.initSelectDynamic(res)}))};$scope.openConfigFilePopup=function(deviceId,deviceType){return linkGroupSrvc.openConfigFilePopup(deviceId,deviceType)};$scope.onFilter=function(){$scope.pageOptions.pageIndex=1;var searchStaticAndExclude=linkGroupSrvc.dataFilter($scope.staticAndExclude,$scope.search.filterContent);$scope.switchPromis().then((function(dynamicData){$scope.allData=searchStaticAndExclude.concat(dynamicData)}),(function(reason){nbAlertSrvc.error({message:utilitySrvc.getErrorMessage(reason)})}))};$scope.clearFilter=function(){$scope.search.filterContent="";$scope.onFilter()};$scope.onOK=function(){$scope.isReadOnly?$scope.onClose():nbValidationSrvc.submit("linkGroupForm").then((function(){var saveData=linkGroupSrvc.formatSaveData({baseInfo:angular.copy($scope.baseInfo),allItems:$scope.staticAndExclude,deviceRules:$scope.dynamicSearchDeviceRules,interfaceRules:$scope.dynamicSearchInterfaceRules});linkGroupSrvc.saveLinkGroupInfo(saveData,$scope.recaculate).then((function(){$rootScope.$emit(deviceBrowserEvent.deviceGroupUpdated,{ID:$scope.baseInfo.ID,isCreateNew:$scope.isCreateNew});$scope.onClose("Device Group Update Succeed.")}),(function(reason){nbAlertSrvc.error({message:utilitySrvc.getErrorMessage(reason)})}))}))};$scope.onClose=function(argCloseReason){$uibModalInstance.close(argCloseReason||"")};var deviceGridCellTemplateWithFilter='<div class="ui-grid-cell-contents" title="TOOLTIP" ng-bind-html="COL_FIELD | nbHighlight: grid.appScope.search.filterContent"></div>',deviceGridCellTemplateWithFilterBlankCompletion='<div class="ui-grid-cell-contents" title="TOOLTIP" ng-bind-html="COL_FIELD | blankCompletion: row.entity | nbHighlight: grid.appScope.search.filterContent"></div>';$scope.toggleRow=function(row,evt){uiGridTreeBaseService.toggleRowTreeState($scope.gridApi.grid,row,evt)};$scope.getSingleMenu=function(row){var rowData=row.entity,menu=[];if(!rowData||!rowData.type)return menu;menu.push({template:"Device Configuration File",action:function(){$scope.openConfigFilePopup(rowData.ID,rowData.subType)}});if($scope.isReadOnly)return menu;rowData.type===linkGroupSrvc.dataType[1]||rowData.type===linkGroupSrvc.dataType[2]?menu.push({template:"Delete",action:function(){linkGroupSrvc.commonDel($scope.allData,$scope.staticAndExclude,[rowData])}}):rowData.type===linkGroupSrvc.dataType[3]&&menu.push({template:"Exclude",action:function(){var addData=_.map(angular.copy([rowData]),(function(item){item.type=linkGroupSrvc.dataType[2];return item}));linkGroupSrvc.commonAdd($scope.allData,$scope.staticAndExclude,addData)}});return menu};$scope.getMultiMenu=function(rows){if($scope.isReadOnly)return[];var menu=[],notOnlystaticAndExclude=_.find(rows,(function(item){return item.type!==linkGroupSrvc.dataType[1]&&item.type!==linkGroupSrvc.dataType[2]})),notOnlyDynamic=_.find(rows,(function(item){return item.type!==linkGroupSrvc.dataType[3]}));notOnlystaticAndExclude||menu.push({template:"Delete",action:function(){linkGroupSrvc.commonDel($scope.allData,$scope.staticAndExclude,rows)}});notOnlyDynamic||menu.push({template:"Exclude",action:function(){var addData=_.map(angular.copy(rows),(function(item){item.type=linkGroupSrvc.dataType[2];return item}));linkGroupSrvc.commonAdd($scope.allData,$scope.staticAndExclude,addData)}});return menu};$scope.linkGroupGridOptions={data:"allData",enableRowSelection:!0,enableRowHeaderSelection:!1,multiSelect:!0,modifierKeysToMultiSelect:!0,enableSorting:!1,enableColumnMenus:!1,groupingShowCounts:!1,showTreeRowHeader:!1,columnDefs:[{field:"type",displayName:"Hostname",grouping:{groupPriority:0},sort:{priority:0,direction:"desc"},cellTemplate:'<div ng-if="!col.grouping || col.grouping.groupPriority === undefined || col.grouping.groupPriority === null || ( row.groupHeader && col.grouping.groupPriority === row.treeLevel )" class="ui-grid-cell-contents" title="TOOLTIP"><div style="float:left;" class="ui-grid-tree-base-row-header-buttons" ng-class="{\'ui-grid-tree-base-header\': row.treeLevel > -1 }" ng-click="grid.appScope.toggleRow(row,evt)">'+"<i ng-class=\"{'ui-grid-icon-minus-squared': ( ( grid.options.showTreeExpandNoChildren && row.treeLevel > -1 ) || ( row.treeNode.children && row.treeNode.children.length > 0 ) ) && row.treeNode.state === 'expanded', 'ui-grid-icon-plus-squared': ( ( grid.options.showTreeExpandNoChildren && row.treeLevel > -1 ) || ( row.treeNode.children && row.treeNode.children.length > 0 ) ) && row.treeNode.state === 'collapsed'}\" ng-style=\"{'padding-left': grid.options.treeIndent * row.treeLevel + 'px'}\"></i> &nbsp;</div><div style=\"text-overflow: ellipsis;overflow: hidden; white-space: nowrap;\" ng-bind-html=\" COL_FIELD | nbHighlight: grid.appScope.filterOptions.filterTarget\" title='{{COL_FIELD}}'></div></div><div style=\"margin-left:11px;\" class='ui-grid-cell-contents' ng-bind-html=\"row.entity.name | nbHighlight: grid.appScope.search.filterContent\"></div>"},{field:"vendor",displayName:"Vendor",cellTemplate:deviceGridCellTemplateWithFilter},{field:"model",displayName:"Model",cellTemplate:deviceGridCellTemplateWithFilter},{field:"mgmtIP",displayName:"Management IP",cellTemplate:deviceGridCellTemplateWithFilter},{field:"intfName",displayName:"Interface",cellTemplate:deviceGridCellTemplateWithFilterBlankCompletion},{field:"intfIp",displayName:"Interface IP",cellTemplate:deviceGridCellTemplateWithFilterBlankCompletion}],enableRowActionMenu:!0,rowActionMenuItems:function(row){return $scope.getSingleMenu(row)},enableRowContextMenu:!0,rowContextMenuItems:function(row,grid){return grid.selection.selectedCount>1?$scope.getMultiMenu(row):$scope.getSingleMenu(row)},onRegisterApi:function(gridApi){$scope.gridApi=gridApi;$scope.gridApi.grid.registerDataChangeCallback((function(){try{$scope.gridApi.treeBase.expandAllRows()}catch(e){}}))},enableGridInfiniteScroll:{offset:5,isNeedMore:function(){return $scope.pageOptions.needMore},loadCallback:function(){if(!$scope.pageOptions.needMore)return $q.resolve();$scope.pageOptions.pageIndex++;return $scope.getMoreDynamicList()}}};$scope.getDynamicList=function(){$scope.pageOptions.pageIndex=1;return linkGroupSrvc.getDynamicList({filterContent:$scope.search.filterContent,guid:$scope.baseInfo.ID,pageNumber:$scope.pageOptions.pageIndex,pageSize:linkGroupSrvc.pageSize}).then((function(dynamicData){if(dynamicData&&_.isArray(dynamicData)){$scope.pageOptions.needMore=dynamicData.length>=linkGroupSrvc.pageSize||!1;$scope.allData=$scope.staticAndExclude.concat(dynamicData);$timeout((function(){$scope.gridApi&&$scope.gridApi.infiniteScroll.resetScroll(!1,!0)}))}}),(function(reason){nbAlertSrvc.error({message:utilitySrvc.getErrorMessage(reason)})}))};$scope.switchPromis=function(){var allRules={DeviceCondition:{Scope:{RangeOption:$scope.dynamicSearchDeviceRules.RangeOption,DeviceGroupRange:$scope.dynamicSearchDeviceRules.DeviceGroupRange,SiteRange:$scope.dynamicSearchDeviceRules.SiteRange},Filter:$scope.dynamicSearchDeviceRules.Filter},InterfaceCondition:$scope.dynamicSearchInterfaceRules,filterContent:$scope.search.filterContent,pageNumber:$scope.pageOptions.pageIndex,pageSize:linkGroupSrvc.pageSize};return 0===$scope.pageOptions.type?linkGroupSrvc.getDynamicList({filterContent:$scope.search.filterContent,guid:$scope.baseInfo.ID,pageNumber:$scope.pageOptions.pageIndex,pageSize:linkGroupSrvc.pageSize}):linkGroupSrvc.getDynamicCalcList($scope.baseInfo.ID,allRules)};$scope.getMoreDynamicList=function(){return $scope.switchPromis().then((function(dynamicData){if(dynamicData&&_.isArray(dynamicData)){$scope.pageOptions.needMore=dynamicData.length>=linkGroupSrvc.pageSize||!1;$scope.allData=$scope.allData.concat(dynamicData)}}),(function(reason){nbAlertSrvc.error({message:utilitySrvc.getErrorMessage(reason)})}))};$scope.onExportToCsv=function(){linkGroupSrvc.exportCsv($scope.baseInfo.ID)};$scope.onImportCsv=function(){inputFileSrvc.createInputFile({scope:$scope,fileAccept:".csv",fileChange:"onFileSelectImportCSV"})};$scope.onFileSelectImportCSV=function(files){linkGroupSrvc.importCsv(files,(function(data){$scope.dynamicSearchDeviceRules=_.extend($scope.dynamicSearchDeviceRules,data.data.DynamicDeviceCondition||{});$scope.dynamicSearchDeviceRules=_.extend($scope.dynamicSearchDeviceRules,data.data.DynamicDeviceCondition.Scope||{});$scope.dynamicSearchInterfaceRules=_.extend($scope.dynamicSearchInterfaceRules,data.data.DynamicInterfaceCondition);$scope.allData=$scope.staticAndExclude.concat([]);linkGroupSrvc.commonAdd($scope.allData,$scope.staticAndExclude,data.data.Items||[]);$scope.pageOptions.type=1;$scope.pageOptions.pageIndex=1;$scope.getMoreDynamicList()}))};$scope.nameValidationOption={method:"watch",rules:[{ruleId:"required",errorMessage:"Device group name can not be empty."},{ruleId:"maxLength",params:{length:128},errorMessage:"Input should be less than 128 characters."},{ruleId:"specialChars",params:{specialChars:NetBrain.NG.Const.valiteFileNameRegTip.split(" ")},errorMessage:"A device group name can't contain any of the following characters: "+NetBrain.NG.Const.valiteFileNameRegTip+"."}]}}angular.module("nb.datamodel").filter("blankCompletion",blankCompletion);blankCompletion.$inject=[];function blankCompletion(){return function(value,rowData){return rowData.ID&&!rowData.intfId?"--":value}}}(NetBrain);!function(){angular.module("nb.datamodel").directive("dynamicSearchDirective",dynamicSearchDirective);dynamicSearchDirective.$inject=["$timeout","nb.search.httpAdvancedSearchSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.systemmodel.deviceTypeMgrSrvc","nb.datamodel.httpSiteSrvc","nb.ng.userSrvc","nb.search.searchMgr","nb.common.nbAlertSrvc","ivhTreeviewMgr","nb.systemmodel.deviceTypeMainMgrSrvc","$q"];function dynamicSearchDirective($timeout,httpAdvancedSearchSrvc,httpDeviceGroupSrvc,deviceTypeMgrSrvc,httpSiteSrvc,userSrvc,searchMgr,nbAlertSrvc,ivhTreeviewMgr,deviceTypeMainMgrSrvc,$q){return{restrict:"E",scope:{searchType:"=",defaultSearchScope:"=",preCriteria:"="},replace:!0,templateUrl:"modules/nbDataModel/linkGroup/views/dynamicSearchDirective.html",controller:function($scope){var self=$scope;self.defaultSearchScope=self.defaultSearchScope||0;self.preCriteria||(self.preCriteria={expr:"",searchScope:self.defaultSearchScope});self.schemaList=[];self.deviceTypes=[];self.mainDeviceTypes=[];self.selectedScopeArgs=[];self.selectedScopeVals=[];self.criteriaList=self.criteriaList||[];self.criteriaListInterface=self.criteriaListInterface||[];self.availableSites=[];self.availableDevGroups=[];self.searchScopeOptions=[{label:"All Devices",value:0},{label:"Device Group",value:1},{label:"Site",value:2}];self.siteTreeOptions={expandToDepth:1,enableMultipleSelect:!0,labelAttribute:"name",idAttribute:"ID",useCheckboxes:!0,className:"advance-search-site-tree",lazyLoadingAttribute:function(node){return 1===node.siteCategory},lazyLoadingCallback:function(node,trvw){var defer=$q.defer();httpSiteSrvc.getSiteTree(node.ID).then((function(subSites){defer.resolve(subSites)}));return defer.promise},checkedCallBack:function(node,checkedNodes,ids,labels){self.selectedScopeArgs=ids;self.selectedScopeVals=labels;if(self.preCriteria){self.preCriteria.selectedScopeVals=self.selectedScopeVals;self.preCriteria.searchScopeArgs=ids}}};self.devGroupTreeOptions={expandToDepth:2,enableMultipleSelect:!0,labelAttribute:"label",idAttribute:"ID",useCheckboxes:!0,enableCheckedAllNode:!0,checkedCallBack:function(node,checkedNodes,ids,labels){self.selectedScopeArgs=ids;self.selectedScopeVals=labels;if(self.preCriteria){self.preCriteria.selectedScopeVals=self.selectedScopeVals;self.preCriteria.searchScopeArgs=ids}}};var bInit=!0;self.initSearchScope=function(){if(bInit)bInit=!1;else{!function(){if(self.selectedScopeArgs.length>0){self.selectedScopeArgs.splice(0,self.selectedScopeArgs.length);self.selectedScopeVals.splice(0,self.selectedScopeVals.length)}}();1===self.preCriteria.searchScope?self.availableDevGroups&&self.availableDevGroups.length>0&&_.each(self.availableDevGroups,(function(item){getSelectedNodes(item)})):2===self.preCriteria.searchScope&&self.availableSites&&self.availableSites.length>0&&_.each(self.availableSites,(function(item){getSelectedNodes(item)}))}};function getSelectedNodes(node,includeChildNode){if(node.selected){self.selectedScopeArgs.push(node.ID);self.selectedScopeVals.push(node.label);if(includeChildNode&&includeChildNode.length>0&&-1===includeChildNode.indexOf(node.ID))return}node.children&&node.children.length>0&&_.each(node.children,(function(child){getSelectedNodes(child,includeChildNode)}))}self.getIndexLabel=function(index){return"ABCDEFGHIJKLMNOPQRSTUVWXYZ"[index]||"Z"};self.getDeviceTypeList=function(){return angular.copy(self.deviceTypes)};self.getMainDeviceTypeList=function(){return angular.copy(self.mainDeviceTypes)};var keywords=httpAdvancedSearchSrvc.getCriteriaKeywordsWithSync();self.getSchemaList=function(){var schemaKeys=[];var copyKeywords=angular.copy(keywords);"interface"===self.searchType&&delete copyKeywords.intProperties;angular.forEach(copyKeywords,(function(value){schemaKeys.push(value)}));return angular.copy(schemaKeys)};self.preCriteria.getSchemaList=self.getSchemaList;self.getSchemaListInterface=function(){var schemaKeys=[];var copyKeywords=keywords;"interface"===self.searchType&&(copyKeywords={intProperties:keywords.intProperties});angular.forEach(copyKeywords,(function(value){schemaKeys.push(value)}));return angular.copy(schemaKeys)};self.preCriteria.getSchemaListInterface=self.getSchemaListInterface;var proxyServers=httpAdvancedSearchSrvc.getProxyServers();self.getProxyServerList=function(){var servers=[];angular.forEach(proxyServers,(function(server){var newChildren=_.map(server.children,(function(item){return{ID:item.id,label:item.viewName}}));servers.push({ID:server.id,label:server.viewName,children:newChildren})}));return servers};function watchChange(list,expr,newVal,oldVal){if(newVal===oldVal)return expr;if(newVal>oldVal)if(newVal>2){var exprs=expr.split(" ");var letters=[];exprs.forEach((function(currentExpr){var lowerExpr=currentExpr.toLowerCase();if("and"!==lowerExpr&&"or"!==lowerExpr){var firstLetter=lowerExpr[0];"("===firstLetter&&(firstLetter=lowerExpr[1]);-1===letters.indexOf(firstLetter)&&letters.push(firstLetter)}}));letters.length!==list.length-1&&(expr=expr+" and "+self.getIndexLabel(list.length-2))}else expr=2===newVal?self.getIndexLabel(list.length-2):"";if(newVal<oldVal&&!self.hasEditExpression)if(newVal>2){var o=expr.split(" ");expr=o.slice(0,2*(list.length-1)-1).join(" ")}else expr=2===newVal?self.getIndexLabel(0):"";$timeout((function(){var contentBody=$(".search-criteria-area");contentBody.scrollTop(contentBody[0].scrollHeight)}));return expr}!function(){if(self.preCriteria){self.preCriteria.criteriaList&&(self.criteriaList=self.preCriteria.criteriaList);self.preCriteria.criteriaListInterface&&(self.criteriaListInterface=self.preCriteria.criteriaListInterface);self.preCriteria.searchType&&(self.searchType=self.preCriteria.searchType);if(self.preCriteria.searchScopeArgs){self.selectedScopeArgs=self.preCriteria.searchScopeArgs;self.initSelectedScopeArgs=angular.copy(self.selectedScopeArgs)}self.preCriteria.searchScopeVals&&(self.selectedScopeVals=self.preCriteria.searchScopeVals);self.preCriteria.availableSites&&(self.availableSites=self.preCriteria.availableSites);self.preCriteria.mainDeviceTypes&&(self.mainDeviceTypes=self.preCriteria.mainDeviceTypes);self.preCriteria.deviceTypes&&(self.deviceTypes=self.preCriteria.deviceTypes);self.preCriteria.availableDevGroups&&(self.availableDevGroups=self.preCriteria.availableDevGroups)}var selectedSiteIds=[];2===self.preCriteria.searchScope&&self.selectedScopeArgs&&self.selectedScopeArgs.length>0&&(selectedSiteIds=self.selectedScopeArgs);var availableSites=[];httpSiteSrvc.getSiteTreeIncludeAllSelectedSites(null,selectedSiteIds).then((function(siteTree){siteTree.children.push({ID:"unassigned_devicesite",name:"Unassigned"});availableSites.push(siteTree);2===self.preCriteria.searchScope&&self.selectedScopeArgs&&self.selectedScopeArgs.length>0&&$timeout((function(){self.siteTreeOptions.checkedNodesById(self.selectedScopeArgs)}));self.availableSites=availableSites}));self.mainDeviceTypes instanceof Array&&self.mainDeviceTypes.length<=0&&(self.mainDeviceTypes=httpAdvancedSearchSrvc.buildMainDeviceTypeTree());self.deviceTypes instanceof Array&&self.deviceTypes.length<=0&&(self.deviceTypes=httpAdvancedSearchSrvc.buildDeviceTypeTree());httpDeviceGroupSrvc.getAllDeviceGroupInfo().then((function(devGroups){self.availableDevGroups=function(devGroups){var root=[{ID:"allDevGroups",label:"All Device Groups",children:[{ID:"localDevGroups",label:"My Device Groups",children:[]},{ID:"sharedDevGroups",label:"Public",children:[]},{ID:"policyDevGroups",label:"Policy Device Group",children:[]},{ID:"systemDevGroups",label:"System",children:[]}]}];var userId=userSrvc.getUserID();_.forEach(devGroups,(function(group){var groupItem={ID:group.ID,label:group.Name};1===group.Type&&group.UserGuid===userId?root[0].children[0].children.push(groupItem):0===group.Type?root[0].children[1].children.push(groupItem):4===group.Type?root[0].children[2].children.push(groupItem):2===group.Type&&root[0].children[3].children.push(groupItem)}));root[0].children=_.filter(root[0].children,(function(child){return child.children&&child.children.length>0}));return root}(devGroups);1===self.preCriteria.searchScope&&$timeout((function(){self.devGroupTreeOptions.checkedNodesById(self.selectedScopeArgs)}))}));(self.criteriaList instanceof Array&&self.criteriaList.length<=0||""!==self.criteriaList[self.criteriaList.length-1].Schema)&&self.criteriaList.push({Schema:"",Operator:"",Expression:""});"interface"===self.searchType&&(self.criteriaListInterface instanceof Array&&self.criteriaListInterface.length<=0||""!==self.criteriaListInterface[self.criteriaListInterface.length-1].Schema)&&self.criteriaListInterface.push({Schema:"",Operator:"",Expression:""});$timeout((function(){self.$watch((function(){return self.criteriaList.length}),(function(newVal,oldVal){self.preCriteria.expr=watchChange(self.criteriaList,self.preCriteria.expr,newVal,oldVal)}));"interface"===self.searchType&&self.$watch((function(){return self.criteriaListInterface.length}),(function(newVal,oldVal){self.preCriteria.exprInterface=watchChange(self.criteriaListInterface,self.preCriteria.exprInterface,newVal,oldVal)}))}))}();self.expressionBlur=function(){self.hasEditExpression||self.focusExprssionValue===self.preCriteria.expr||(self.hasEditExpression=!0)};self.exprssionFocus=function(){self.focusExprssionValue||(self.focusExprssionValue=self.preCriteria.expr)};self.expressionKeyUp=checkExpressionValidation;function checkExpressionValidation(error){error=error||{message:"",catalog:1};var criteriaCount=self.criteriaList.length-1;if(0===criteriaCount)return!0;var expressionWords=self.preCriteria.expr.split(" ").filter((function(item){return""!==item}));var reallExpressionWords=[];var pre=null;for(var wordIndex=0;wordIndex<expressionWords.length;wordIndex++){var tempWord=expressionWords[wordIndex];"("===tempWord&&(pre=tempWord);if(")"!==tempWord&&"("!==tempWord){"("===pre&&(tempWord=pre+tempWord);")"===expressionWords[wordIndex+1]&&(tempWord+=")");reallExpressionWords.push(tempWord);pre=expressionWords[wordIndex]}}if((expressionWords=reallExpressionWords).length%2==0){self.expressionError=!0;error.message="The Boolean expression does not match the selected criteria.";self.expressionValidation.rules[0].errorMessage=error.message;return!1}var criteriaLabels=[];var boolLabels=["and","or"];for(var i=0;i<criteriaCount;i++)criteriaLabels.push(self.getIndexLabel(i).toLowerCase());var hasError=!1;var leftBrackets=[];var rightBrackets=[];for(var m=0;m<expressionWords.length;m++){var word=expressionWords[m].toLowerCase();if(m%2==0)if(1===word.length){if(-1===criteriaLabels.indexOf(word)){hasError=!0;break}}else if("("===word[0]){var leftBracketIndex=0;for(;leftBracketIndex<word.length;){if("("===word[leftBracketIndex])leftBrackets.push({left:m});else if(")"===word[leftBracketIndex])rightBrackets.push({right:m});else if(-1===criteriaLabels.indexOf(word[leftBracketIndex])){hasError=!0;break}leftBracketIndex++}}else{if(-1===criteriaLabels.indexOf(word[0])){hasError=!0;break}var rightBracketIndex=1;for(;rightBracketIndex<word.length;){")"===word[rightBracketIndex]&&rightBrackets.push({right:m});rightBracketIndex++}}else if(-1===boolLabels.indexOf(word)){hasError=!0;break}}hasError||leftBrackets.length===rightBrackets.length||(hasError=!0);hasError&&(error.message="The Boolean expression does not match the selected criteria.");self.expressionError=hasError;self.expressionValidation.rules[0].errorMessage=error.message;return!hasError}self.expressionValidation={method:"watch",rules:[{ruleId:"customized",params:{func:checkExpressionValidation},errorMessage:""}]}}}}}(window.NetBrain);!function(){angular.module("nb.datamodel").controller("nb.datamodel.dynamicSearchCtrl",dynamicSearchCtrl);dynamicSearchCtrl.$inject=["$scope","$rootScope","$q","$uibModalInstance","nb.ng.utilitySrvc","nb.datamodel.linkGroupSrvc","uiGridConstants","nb.datamodel.httpDynamicSearchSrvc","nb.ng.errorHandleSrvc","nb.systemmodel.deviceSchemaMgrSrvc","nb.ng.callbackSrvc","nb.datamodel.httpDeviceGroupSrvc","nb.common.nbAlertSrvc","args"];function dynamicSearchCtrl($scope,$rootScope,$q,$uibModalInstance,utilitySrvc,linkGroupSrvc,uiGridConstants,httpDynamicSearchSrvc,errorHandleSrvc,deviceSchemaMgrSrvc,callbackSrvc,httpDeviceGroupSrvc,nbAlertSrvc,args){var separator="-----=====-----=====";$scope.preCriteria={Count:1e4,mainDeviceTypes:[],criteriaList:[],criteriaListInterface:[],expr:"",exprInterface:"",searchScope:0,searchScopeArgs:[],searchScopeVals:[]};$scope.useCache=!0;$scope.searchType=args.type||"device";$scope.title="Dynamic Search "+("device"===$scope.searchType?"Device":"Interface");$scope.refDySearchJsonFromDB=angular.copy("device"===$scope.searchType?args.deviceRules:args.interfaceRules);!function(filter,preCriteria){if("interface"===$scope.searchType){filter.Filter=filter.DeviceCondition.Filter;filter.RangeOption=filter.DeviceCondition.Scope.RangeOption;filter.DeviceGroupRange=filter.DeviceCondition.Scope.DeviceGroupRange;filter.SiteRange=filter.DeviceCondition.Scope.SiteRange;delete filter.DeviceCondition}if(filter&&filter.Filter){preCriteria.expr=filter.Filter.Expression;preCriteria.searchScope=filter.RangeOption;_.each(filter.Filter.Conditions,(function(item){""===item.Expression&&-1===item.Operator&&-1===item.Schema||preCriteria.criteriaList.push({$$hashKey:item.$$hashKey,Expression:item.Expression,Operator:item.Operator,Schema:item.Schema})}));if(1===filter.RangeOption)for(var j=0;j<filter.DeviceGroupRange.length;j++)preCriteria.searchScopeArgs.push(filter.DeviceGroupRange[j]);if(2===filter.RangeOption){var length=_.indexOf(filter.SiteRange,separator);-1===length&&(length=filter.SiteRange.length);for(var k=0;k<length;k++){filter.SiteRange[k]&&preCriteria.searchScopeArgs.push(filter.SiteRange[k]);var valIndex=k+length+1;if(filter.SiteRange[valIndex]){var siteTreeNodeVal=filter.SiteRange[valIndex];preCriteria.searchScopeVals.push(siteTreeNodeVal);preCriteria.selectedScopeVals.push(siteTreeNodeVal)}}}}if("interface"===$scope.searchType&&filter&&filter.InterfaceFilter){preCriteria.exprInterface=filter.InterfaceFilter.Expression;_.each(filter.InterfaceFilter.Conditions,(function(item){""===item.Expression&&-1===item.Operator&&-1===item.Schema||preCriteria.criteriaListInterface.push({$$hashKey:item.$$hashKey,Expression:item.Expression,Operator:item.Operator,Schema:item.Schema})}))}}($scope.refDySearchJsonFromDB,$scope.preCriteria);$scope.gridData=[];$scope.gridOptions_devices={data:"gridData",columnDefs:[{field:"name",displayName:"Hostname"},{field:"vendor",displayName:"Vendor"},{field:"model",displayName:"Model"},{field:"mgmtIP",displayName:"Management IP"}],enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableHorizontalScrollbar:uiGridConstants.scrollbars.NEVER,enableVerticalScrollbar:uiGridConstants.scrollbars.NEVER};$scope.pageOptions={pageIndex:1,needMore:!1};$scope.gridOptions_interface={data:"gridData",columnDefs:[{field:"name",displayName:"Device Name"},{field:"vendor",displayName:"Vendor"},{field:"model",displayName:"Model"},{field:"mgmtIP",displayName:"Management IP"},{field:"intfName",displayName:"Interface"},{field:"intfIp",displayName:"Interface IP"}],enableFullRowSelection:!1,enableRowHeaderSelection:!1,enableGridMenu:!1,enableColumnMenus:!1,enableGridInfiniteScroll:{offset:5,isNeedMore:function(){return $scope.pageOptions.needMore},loadCallback:function(){if(!$scope.pageOptions.needMore)return $q.resolve();$scope.pageOptions.pageIndex++;return $scope.getMoreInterfaceList()}}};$scope.getMoreInterfaceList=function(){return linkGroupSrvc.getInterfaceList(args.id,{Condition:{DeviceCondition:{Scope:{RangeOption:$scope.refDySearchJsonFromDB.RangeOption,DeviceGroupRange:$scope.refDySearchJsonFromDB.DeviceGroupRange,SiteRange:$scope.refDySearchJsonFromDB.SiteRange},Filter:$scope.refDySearchJsonFromDB.Filter},InterfaceFilter:$scope.refDySearchJsonFromDB.InterfaceFilter},pageNumber:$scope.pageOptions.pageIndex,pageSize:linkGroupSrvc.pageSize},1!==$scope.pageOptions.pageIndex).then((function(result){if(result&&_.isArray(result)&&result.length>0){$scope.pageOptions.needMore=result.length>=linkGroupSrvc.pageSize||!1;$scope.gridData=$scope.gridData.concat(result)}else if(1===$scope.pageOptions.pageIndex){$scope.pageOptions.needMore=!1;nbAlertSrvc.alert("No interfaces found!")}else $scope.pageOptions.needMore=!1}),(function(reason){500===reason.ResultCode?nbAlertSrvc.error({message:"Sorry, search service is currently not available. Please try again later."}):nbAlertSrvc.error({message:utilitySrvc.getErrorMessage(reason)})}))};$scope.validatorRules=function(){!function(preCriteria,filter){filter.Filter=filter.Filter||{};filter.Filter.Conditions=[];filter.Filter.Expression=preCriteria.expr;filter.RangeOption=preCriteria.searchScope;filter.DeviceGroupRange=[];filter.SiteRange=[];_.each(preCriteria.criteriaList,(function(item){""===item.Expression&&""===item.Operator&&""===item.Schema||filter.Filter.Conditions.push({$$hashKey:item.$$hashKey,Expression:item.Expression,Operator:item.Operator,Schema:item.Schema})}));if(1===preCriteria.searchScope)for(var j=0;j<preCriteria.searchScopeArgs.length;j++)filter.DeviceGroupRange.push(preCriteria.searchScopeArgs[j]);else if(2===preCriteria.searchScope)for(var k=0;k<preCriteria.searchScopeArgs.length;k++)filter.SiteRange.push(preCriteria.searchScopeArgs[k]);if("interface"===$scope.searchType){filter.InterfaceFilter=filter.InterfaceFilter||{};filter.InterfaceFilter.Conditions=[];filter.InterfaceFilter.Expression=preCriteria.exprInterface;_.each(preCriteria.criteriaListInterface,(function(item){""===item.Expression&&""===item.Operator&&""===item.Schema||filter.InterfaceFilter.Conditions.push({$$hashKey:item.$$hashKey,Expression:item.Expression,Operator:item.Operator,Schema:item.Schema})}))}}($scope.preCriteria,$scope.refDySearchJsonFromDB);var conditions=("device"===$scope.searchType?$scope.refDySearchJsonFromDB.Filter:$scope.refDySearchJsonFromDB.InterfaceFilter).Conditions,error={message:"",catalog:-1};if(1!==$scope.refDySearchJsonFromDB.RangeOption||$scope.refDySearchJsonFromDB.DeviceGroupRange&&0!==$scope.refDySearchJsonFromDB.DeviceGroupRange.length)if(2!==$scope.refDySearchJsonFromDB.RangeOption||$scope.refDySearchJsonFromDB.SiteRange&&0!==$scope.refDySearchJsonFromDB.SiteRange.length)if(!conditions||0===conditions.length||1===conditions.length&&-1===conditions[0].Schema){error.message="Please define "+("device"===$scope.searchType?"device":"interface")+" search criteria first.";error.catalog=1}else{var l=conditions.length;for(var i=0;i<l;i++)if(""===conditions[i].Expression&&"proxyServer"!==conditions[i].Schema||conditions[i].Operator<0||""===conditions[i].Schema){error.message="Invalid "+("device"===$scope.searchType?"device":"interface")+" search criteria.";error.catalog=2;break}}else{error.message="Please select sites.";error.catalog=0}else{error.message="Please select device groups.";error.catalog=0}if(""!==error.message){2===error.catalog?nbAlertSrvc.notification({message:error.message}):nbAlertSrvc.warnning({message:error.message});return!1}return!0};$scope.onSearch=function(){if($scope.validatorRules()){$scope.useCache=!1;if("device"===$scope.searchType)httpDynamicSearchSrvc.calcDySearchDevice(null,angular.fromJson(angular.toJson($scope.refDySearchJsonFromDB))).then((function(result){$scope.gridData=[];result&&_.isArray(result)&&result.length>0?$scope.gridData=result:nbAlertSrvc.alert("No devices found!")}),(function(reason){500===reason.ResultCode?nbAlertSrvc.error({message:"Sorry, search service is currently not available. Please try again later."}):nbAlertSrvc.error({message:utilitySrvc.getErrorMessage(reason)})}));else{$scope.pageOptions.pageIndex=1;$scope.gridData=[];$scope.getMoreInterfaceList()}}};$scope.onOK=function(){if($scope.validatorRules()){var allRules={DeviceCondition:{},InterfaceCondition:{},pageSize:linkGroupSrvc.pageSize,pageNumber:1};if("device"===$scope.searchType){allRules.DeviceCondition={Scope:{RangeOption:$scope.refDySearchJsonFromDB.RangeOption,DeviceGroupRange:$scope.refDySearchJsonFromDB.DeviceGroupRange,SiteRange:$scope.refDySearchJsonFromDB.SiteRange},Filter:$scope.refDySearchJsonFromDB.Filter};allRules.InterfaceCondition=args.interfaceRules}else if("interface"===$scope.searchType){allRules.DeviceCondition={Scope:{RangeOption:args.deviceRules.RangeOption,DeviceGroupRange:args.deviceRules.DeviceGroupRange,SiteRange:args.deviceRules.SiteRange},Filter:args.deviceRules.Filter};allRules.InterfaceCondition={DeviceCondition:{Scope:{RangeOption:$scope.refDySearchJsonFromDB.RangeOption,DeviceGroupRange:$scope.refDySearchJsonFromDB.DeviceGroupRange,SiteRange:$scope.refDySearchJsonFromDB.SiteRange},Filter:$scope.refDySearchJsonFromDB.Filter},InterfaceFilter:$scope.refDySearchJsonFromDB.InterfaceFilter}}linkGroupSrvc.getDynamicCalcList(args.id,allRules,$scope.useCache).then((function(res){var deviceRules="device"===$scope.searchType?$scope.refDySearchJsonFromDB:args.deviceRules,interfaceRules="device"===$scope.searchType?args.interfaceRules:{DeviceCondition:{Scope:{RangeOption:$scope.refDySearchJsonFromDB.RangeOption,DeviceGroupRange:$scope.refDySearchJsonFromDB.DeviceGroupRange,SiteRange:$scope.refDySearchJsonFromDB.SiteRange},Filter:$scope.refDySearchJsonFromDB.Filter},InterfaceFilter:$scope.refDySearchJsonFromDB.InterfaceFilter};$uibModalInstance.close({data:res,deviceRules:deviceRules,interfaceRules:interfaceRules,useCache:$scope.useCache})}),(function(reason){var msg="";msg="NotConnection"===reason.ResultDesc?"Sorry, search service is currently not available. Please try again later.":utilitySrvc.getErrorMessage(reason);nbAlertSrvc.error({message:msg})}))}};$scope.onCancel=function(argCloseReason){$uibModalInstance.dismiss(argCloseReason||"")}}}(NetBrain);!function(){angular.module("nb.datamodel").service("nb.datamodel.linkGroupSrvc",linkGroupSrvc);linkGroupSrvc.$inject=["nb.ng.nbHttp","$q","$upload","$filter","$uibModal","nb.common.nbAlertSrvc","nb.ng.utilitySrvc","nb.ng.userSrvc","nb.netbrain.httpDeviceSrvc","nb.ng.httpAuthSrvc","nb.ng.httpDownloadingSrvc"];function linkGroupSrvc(nbHttp,$q,$upload,$filter,$uibModal,nbAlertSrvc,utilitySrvc,userSrvc,httpDeviceSrvc,httpAuthSrvc,httpDownloadingSrvc){return{pageSize:100,dataType:{1:"Static",2:"Excluded",3:"Dynamic"},linkGroupDialog:function(_args){return $uibModal.open({templateUrl:"modules/nbDataModel/linkGroup/views/linkGroup.html",controller:"nb.datamodel.linkGroupPopupCtrl",windowClass:"linkGroupDialog",backdrop:"static",resolve:{args:function(){return _args}}}).result},commonSelectDevice:function(){return $uibModal.open({templateUrl:"modules/nbDataModel/common/views/selectDevicePopup.html",controller:"nb.datamodel.selectDevicePopupCtrl",windowClass:"selectDevicePopup",backdrop:"static",resolve:{singleSelectionOnly:function(){return!1},initDevices:function(){return[]}}}).result},getInterfacesByDeviceIds:function(ids){return _ajax({method:"POST",url:"DeviceGroup/PhysicalInterfaces",data:ids})},commonSelectInterface:function(data){return $uibModal.open({templateUrl:"modules/nbGoldenBaseline/views/nbGoldenBaselineSelectInterfaces.html",controller:"nb.goldenbaseline.nbGBSelectInterfacePopupCtrl",windowClass:"gbSelectInterfacePopup",backdrop:"static",resolve:{resolveData:function(){return data}}}).result},dynamicSearch:function(data){return $uibModal.open({templateUrl:"modules/nbDataModel/linkGroup/views/dynamicSearch.html",controller:"nb.datamodel.dynamicSearchCtrl",windowClass:"dynamicSearchPopup dynamicSearchDialog",backdrop:"static",resolve:{args:function(){return data}}}).result},openConfigFilePopup:function(deviceId,deviceType){return httpDeviceSrvc.getDomainListByDevIdList([deviceId]).then((function(arrResults){var currObj=arrResults[0];var deviceTenantDomain={TenantGuid:httpAuthSrvc.getDataSrc(utilitySrvc).TenantGuid,DomainGuid:[]};deviceTenantDomain.DomainGuid.push(currObj.domainId);return $uibModal.open({templateUrl:"modules/nbDeviceDetail/views/deviceDataPopout.html",controller:"nb.deviceDetail.deviceDataPopoutCtrl",windowClass:"device-data-viewer-popout",backdrop:"static",resolve:{args:function(){var args={};args.currTenantDomain=deviceTenantDomain;args.isConfigFile=!0;args.deviceId=deviceId;args.deviceType=deviceType;args.dataType=window.DeviceDataType.Config;args.isOpenFromMap=!1;return args}}}).result}))},getDefaultStructure:function(linkGroup){return _.extend({ID:Utility.getGUID(),Name:"",Description:"",UserGuid:userSrvc.getUserID(),HasInterface:!0,AutoLink:!1,Type:1},linkGroup)},getLinkDeviceBaseInfo:function(id){return _ajax({url:"DeviceGroup/noDevices/"+id})},getStaticAndExcludeList:function(id){return _ajax({url:"DeviceGroup/StaticAndExclude/"+id})},getDynamicList:function(data){return _ajax({method:"POST",url:"DeviceGroup/DynamicByCondition",data:data})},getDynamicCalcList:function(id,data,useCache){return _ajax({method:"POST",url:"DeviceGroup/SearchAll/"+id+"/"+(!1!==useCache),data:data})},getInterfaceList:function(id,data,useCache){return _ajax({method:"POST",url:"DeviceGroup/SearchInterface/"+id+"/"+(!1!==useCache),data:data})},formatDynamicSearchDeviceRules:function(baseInfo){return{RangeOption:baseInfo.RangeOption||0,DeviceGroupRange:baseInfo.DeviceGroupRange||[],SiteRange:baseInfo.SiteRange||[],Filter:baseInfo.Filter||{Expression:"",Conditions:[]}}},unFormatDynamicSearchDeviceRules:function(baseInfo,deviceRules){if(baseInfo&&deviceRules){baseInfo.RangeOption=deviceRules.RangeOption;baseInfo.DeviceGroupRange=deviceRules.DeviceGroupRange;baseInfo.SiteRange=deviceRules.SiteRange;baseInfo.Filter=deviceRules.Filter}return baseInfo},formatDynamicSearchInterfaceRules:function(baseInfo){return _.extend({DeviceCondition:{Scope:{RangeOption:0,DeviceGroupRange:[],SiteRange:[]},Filter:{Expression:"",Conditions:[]}},InterfaceFilter:{Expression:"",Conditions:[]}},baseInfo.DynamicInterfaceCondition)},formatStaticAndExcludeDevice:function(data,type){return _.map(data,(function(item){item.subType=item.type;item.type=type;return item}))},formatStaticAndExcludeInterface:function(data,type){var formatData=[];_.each(data.selectedInerfacesData,(function(device){_.each(device.children,(function(intf){formatData.push({ID:device.ID,intfId:intf.ID,intfIp:intf.ip,intfName:intf.name,mgmtIP:device.mgmtIP,model:device.model,name:device.name,subType:device.subType,type:type,vendor:device.vendor})}))}));return formatData},commonAdd:function(allData,staticAndExcludeData,addData){var that=this;_.each(addData,(function(item){var sameItemInstaticAndExcludeData=_.find(staticAndExcludeData,(function(currentItem){return item.intfId?currentItem.intfId===item.intfId:!currentItem.intfId&&currentItem.ID===item.ID}));if(sameItemInstaticAndExcludeData){sameItemInstaticAndExcludeData.type=item.type;_.each(allData,(function(currentItem,i){if(currentItem.type!==that.dataType[3]&&(item.intfId?currentItem.intfId===item.intfId:!currentItem.intfId&&currentItem.ID===item.ID)){allData.splice(i,1);allData.unshift(item)}}))}else{staticAndExcludeData.unshift(item);allData.unshift(item)}}))},commonDel:function(allData,staticAndExcludeData,delData){var that=this;_.each(delData,(function(item){for(var i=0;i<staticAndExcludeData.length;i++)if(item.intfId?staticAndExcludeData[i].intfId===item.intfId:!staticAndExcludeData[i].intfId&&staticAndExcludeData[i].ID===item.ID){staticAndExcludeData.splice(i,1);break}for(var j=0;j<allData.length;j++)if(allData[j].type!==that.dataType[3]&&(item.intfId?allData[j].intfId===item.intfId:!allData[j].intfId&&allData[j].ID===item.ID)){allData.splice(j,1);break}}))},sampleDataItem:function(data){var sampleData=[];_.each(data,(function(item){sampleData.push({ID:item.ID,intfId:item.intfId,type:item.type})}));return sampleData},dataFilter:function(data,keyword){return $filter("selectedColumnsFilter")(data,["name","vendor","model","mgmtIP","intfName","intfIp"],keyword)},formatSaveData:function(data){var saveData=data.baseInfo;(saveData=this.unFormatDynamicSearchDeviceRules(saveData,data.deviceRules)).DynamicInterfaceCondition=data.interfaceRules;saveData.AllItems=this.sampleDataItem(data.allItems);return saveData},saveLinkGroupInfo:function(data,recaculate){return _ajax({method:"post",url:"DeviceGroup/SaveDeviceGroup/"+(!0===recaculate),data:data})},exportCsv:function(id){httpDownloadingSrvc.getTicket().then((function(ticketData){var tenandId=httpAuthSrvc.getSelectedTenantId(),domainId=httpAuthSrvc.getSelectedDomainIds()[0],exportUrl=NetBrain.NG.ConfigSettings.API_ROOT+"/DeviceGroup/export/"+id;exportUrl+="?dl_ticket="+ticketData+"&TenantGuid="+tenandId+"&DomainGuid="+domainId;httpDownloadingSrvc.downloadFile(exportUrl)}),(function(){nbAlertSrvc.error({message:"Failed to get downloading ticket..."})}))},importCsv:function(files,callBack){var tenandId=httpAuthSrvc.getSelectedTenantId(),domainId=httpAuthSrvc.getSelectedDomainIds()[0];return $upload.upload({url:NetBrain.NG.ConfigSettings.API_ROOT+"DeviceGroup/import",method:"POST",file:files[0],headers:{TenantGuid:tenandId,DomainGuid:domainId},data:{}}).success((function(data){callBack(data)})).error((function(){nbAlertSrvc.error("CSV failure analysis.")}))}};function _ajax(opt,canceler){var defaultRequest=$.extend(!0,{method:"GET",url:"",data:{}},opt);return nbHttp[defaultRequest.method.toLowerCase()](defaultRequest.url,defaultRequest.data,{timeout:canceler,avoidBlockUI:!1})}}}(NetBrain);